<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی متنی - صفحه اصلی</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&family=Share+Tech+Mono&family=Orbitron:wght@400..900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- ========================================================================= -->
    <!-- === بخش CSS: تمام استایل‌های مورد نیاز برای این صفحه و مودال‌ها === -->
    <!-- ========================================================================= -->
    <style>
        /* استایل‌های عمومی */
        html, body, #app {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: background-color 0.8s ease-in-out, color 0.8s ease-in-out;
        }

        /* تم کلاسیک (پیش‌فرض) */
        body.theme-classic {
            font-family: 'Merriweather', serif;
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%);
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
        }
        body.theme-classic h1, body.theme-classic h2, body.theme-classic h3 {
            font-family: 'Playfair Display', serif;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* استایل هدر و فوتر */
        .app-header, .app-footer {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            flex-shrink: 0;
            z-index: 10;
        }
        .app-header { border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); }
        .app-footer { border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); }
        
        #header-user-coins-container {
            background-color: rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: #FFD700;
            border-radius: 10px;
        }
        .coin-icon { fill: #FFD700; }
        
        /* استایل دکمه‌ها */
        .classic-btn {
            border: 2px solid #DAA520;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
            color: #FFFFFF;
            border-radius: 15px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 0.875rem 1.5rem;
            font-size: 1.125rem;
        }
        .classic-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2);
        }
        .classic-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }

        /* استایل محتوای اصلی */
        .main-content-area {
            flex-grow: 1;
            overflow-y: auto;
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* استایل مودال‌ها (پاپ‌آپ) */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 50;
            background-color: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease-in-out;
        }
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%);
            border: 4px solid #DAA520;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
            border-radius: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* استایل فیلدهای ورودی (input) و select */
        input, select {
            background-color: #202020;
            border: 2px solid #5A5A5A;
            color: #E0E0E0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            padding: 0.875rem;
            border-radius: 0.75rem;
        }
        input::placeholder { color: #A0A0A0; }
        input:focus, select:focus {
            border-color: #DAA520 !important;
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
            outline: none;
        }
        
        /* استایل اسکرول بار سفارشی برای مودال */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #202020; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        
    </style>
</head>
<body class="theme-classic">

    <!-- ========================================================================= -->
    <!-- === بخش HTML: ساختار بصری صفحه اصلی و مودال‌ها === -->
    <!-- ========================================================================= -->
    <div id="app" class="w-full h-full">

        <!-- هدر اصلی -->
        <header class="app-header p-3 flex items-center justify-between">
            <div id="profile-summary" class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-700/50">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
                <div class="text-right">
                    <span id="header-display-name" class="font-bold text-lg">...</span>
                    <span id="header-user-id" class="text-xs break-all">...</span>
                </div>
            </div>
            <div class="flex-grow"></div> 
            <div id="header-user-coins-container" class="flex items-center text-xl font-bold p-2">
                <svg class="coin-icon w-6 h-6 ml-2" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                <span id="header-user-coins">---</span>
            </div>
            <button id="menu-btn" class="p-2 ml-2 rounded-full hover:bg-gray-700/50">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
        </header>

        <!-- محتوای اصلی -->
        <main class="main-content-area">
            <h1 class="text-4xl font-bold mb-8">به بازی متنی خوش آمدید!</h1>
            <p class="text-lg">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
        </main>

        <!-- فوتر با دکمه‌های اصلی -->
        <footer class="app-footer p-4 flex justify-center items-center gap-4">
            <button id="friendly-game-btn" class="classic-btn btn-purple-classic flex items-center justify-center">
                <span>بازی دوستانه (هزینه: <span id="friendly-game-cost">...</span> سکه)</span>
            </button>
            <button id="rated-game-btn" class="classic-btn btn-brown-classic">بازی امتیازی</button>
        </footer>
        
        <!-- مودال منوی اصلی (شامل پروفایل، تم و خروج) -->
        <div id="main-menu-modal" class="modal-overlay hidden">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center relative custom-scrollbar">
                <!-- دکمه بستن -->
                <button id="close-main-menu-modal-btn" class="absolute top-4 left-4 text-gray-400 hover:text-white">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                
                <!-- منوی اصلی -->
                <div id="main-menu-nav">
                    <h2 class="text-2xl font-bold mb-6">منوی اصلی</h2>
                    <div class="space-y-4">
                        <button id="show-profile-btn" class="w-full classic-btn btn-blue-classic">پروفایل کاربری</button>
                        <button id="create-lobby-menu-btn" class="w-full classic-btn btn-green-classic">ساخت / مدیریت لابی</button>
                        <button id="main-menu-logout-btn" class="w-full classic-btn btn-red-classic">خروج از حساب</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- مودال ساخت/مدیریت لابی -->
        <div id="create-lobby-modal" class="modal-overlay hidden">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center relative custom-scrollbar">
                <h2 class="text-2xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-gray-400 hover:text-white">
                     <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <form id="create-lobby-form" class="space-y-4 text-right">
                    <!-- انتخاب نام لابی تایید شده -->
                    <div>
                        <label for="approved-lobby-names-select">نام لابی:</label>
                        <select id="approved-lobby-names-select" class="w-full mt-1">
                            <option value="">یک نام تایید شده انتخاب کنید</option>
                        </select>
                    </div>
                    <!-- پیشنهاد نام جدید -->
                    <div>
                        <label for="proposed-lobby-name-input">یا نام جدید پیشنهاد دهید:</label>
                        <input type="text" id="proposed-lobby-name-input" placeholder="مثال: [#FFD700]لابی طلایی" class="w-full mt-1">
                        <button type="button" id="submit-lobby-name-btn" class="w-full mt-2 classic-btn btn-blue-classic text-base">ارسال برای تایید</button>
                    </div>
                    <hr class="border-yellow-600 my-4">
                    <!-- نوع لابی و رمز عبور -->
                    <div>
                        <label>نوع لابی:</label>
                        <div class="flex justify-around mt-2">
                           <label><input type="radio" name="lobby-type" value="public" checked> عمومی</label>
                           <label><input type="radio" name="lobby-type" value="private"> خصوصی</label>
                        </div>
                    </div>
                    <div id="new-lobby-password-field" class="hidden">
                        <label for="new-lobby-password-input">رمز عبور:</label>
                        <input type="password" id="new-lobby-password-input" class="w-full mt-1">
                    </div>
                    
                    <button type="submit" id="submit-create-lobby-btn" class="w-full mt-4 classic-btn btn-green-classic">ساخت لابی</button>
                </form>
                <div id="create-lobby-message-box" class="mt-4 p-3 rounded-lg text-center hidden"></div>
            </div>
        </div>

    </div>

    <!-- ========================================================================= -->
    <!-- === بخش JavaScript: منطق این صفحه و مودال‌ها === -->
    <!-- ========================================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, setDoc, addDoc, collection, serverTimestamp, updateDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // --- پیکربندی فایربیس ---
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4", 
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- دسترسی به عناصر HTML ---
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const headerUserCoins = document.getElementById('header-user-coins');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const friendlyGameCostSpan = document.getElementById('friendly-game-cost');
        const ratedGameBtn = document.getElementById('rated-game-btn');
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        // مودال منو
        const mainMenuModal = document.getElementById('main-menu-modal');
        const closeMainMenuModalBtn = document.getElementById('close-main-menu-modal-btn');
        const createLobbyMenuBtn = document.getElementById('create-lobby-menu-btn');
        const mainMenuLogoutBtn = document.getElementById('main-menu-logout-btn');
        // مودال ساخت لابی
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn');
        const createLobbyForm = document.getElementById('create-lobby-form');
        const approvedLobbyNamesSelect = document.getElementById('approved-lobby-names-select');
        const passwordField = document.getElementById('new-lobby-password-field');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');


        // --- متغیرهای وضعیت ---
        let currentUser = null;
        let currentUserData = null;
        let unsubscribeUserProfile = null;
        let gameEntryCost = 100; // مقدار پیش‌فرض

        // --- توابع ---
        function showAlert(message, type = "info") {
            // در یک پروژه واقعی، مودال بهتری استفاده می‌شود
            alert(message);
        }

        function showLobbyMessage(message, type = "error") {
            createLobbyMessageBox.textContent = message;
            createLobbyMessageBox.className = 'mt-4 p-3 rounded-lg text-center'; // Reset
            if (type === 'error') createLobbyMessageBox.classList.add('bg-red-700', 'text-white');
            else createLobbyMessageBox.classList.add('bg-green-700', 'text-white');
            createLobbyMessageBox.classList.remove('hidden');
        }
        
        // باز کردن و بستن مودال‌ها
        function openModal(modalElement) { modalElement.classList.remove('hidden'); }
        function closeModal(modalElement) { modalElement.classList.add('hidden'); }

        // --- منطق اصلی صفحه ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // اگر کاربر لاگین بود، به اطلاعات پروفایل و سکه‌ها گوش بده
                const userProfileRef = doc(db, `artifacts/default-app-id/users/${user.uid}/profile/data`);
                if (unsubscribeUserProfile) unsubscribeUserProfile(); // قطع لیسنر قبلی
                unsubscribeUserProfile = onSnapshot(userProfileRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                        headerDisplayName.textContent = currentUserData.displayName || 'کاربر';
                        headerUserId.textContent = `ID: ${user.uid.substring(0, 8)}...`;
                        headerUserCoins.textContent = (currentUserData.coins || 0).toLocaleString('fa');
                        
                        // به‌روزرسانی لیست نام‌های تایید شده در مودال ساخت لابی
                        approvedLobbyNamesSelect.innerHTML = '<option value="">یک نام تایید شده انتخاب کنید</option>';
                        (currentUserData.approvedLobbyNames || []).forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name.replace(/\[#[0-9A-Fa-f]{6}\]/, ''); // نمایش نام بدون کد رنگ
                            approvedLobbyNamesSelect.appendChild(option);
                        });

                    } else {
                        // این حالت بعید است چون در ثبت‌نام پروفایل ساخته می‌شود
                        signOut(auth); // خروج کاربر چون پروفایل ندارد
                    }
                });

                // دریافت هزینه بازی از تنظیمات کلی (اگر وجود داشته باشد)
                const configRef = doc(db, `artifacts/default-app-id/config/game_settings`);
                getDoc(configRef).then(docSnap => {
                    if (docSnap.exists() && docSnap.data().gameEntryCost) {
                        gameEntryCost = docSnap.data().gameEntryCost;
                        friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa');
                    } else {
                        friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa');
                    }
                });
                
            } else {
                // اگر کاربر لاگین نبود، به صفحه ورود برگردان
                window.location.href = 'sabt_name.html';
            }
        });
        
        // --- رویدادهای کلیک ---
        friendlyGameBtn.addEventListener('click', () => {
            if (!currentUserData) {
                showAlert("در حال بارگذاری اطلاعات. لطفاً کمی صبر کنید.");
                return;
            }
            if ((currentUserData.coins || 0) < gameEntryCost) {
                showAlert(`برای ورود به بازی به ${gameEntryCost} سکه نیاز دارید. سکه شما کافی نیست.`);
                return;
            }
            // انتقال به صفحه لیست لابی‌ها
            window.location.href = 'safe_list_libey.html';
        });

        ratedGameBtn.addEventListener('click', () => {
            showAlert("بخش بازی امتیازی به زودی فعال خواهد شد!");
        });
        
        // باز کردن مودال منوی اصلی
        menuBtn.addEventListener('click', () => openModal(mainMenuModal));
        profileSummary.addEventListener('click', () => openModal(mainMenuModal));
        closeMainMenuModalBtn.addEventListener('click', () => closeModal(mainMenuModal));

        // خروج از حساب
        mainMenuLogoutBtn.addEventListener('click', async () => {
            if (confirm("آیا برای خروج از حساب کاربری خود مطمئن هستید؟")) {
                await signOut(auth);
                // onAuthStateChanged بقیه کار را انجام می‌دهد (هدایت به صفحه لاگین)
            }
        });
        
        // باز کردن مودال ساخت لابی
        createLobbyMenuBtn.addEventListener('click', () => {
            closeModal(mainMenuModal);
            openModal(createLobbyModal);
        });
        closeCreateLobbyModalBtn.addEventListener('click', () => closeModal(createLobbyModal));
        
        // نمایش/عدم نمایش فیلد رمز عبور بر اساس نوع لابی
        createLobbyForm.elements['lobby-type'].forEach(radio => {
            radio.addEventListener('change', (e) => {
                if(e.target.value === 'private') {
                    passwordField.classList.remove('hidden');
                } else {
                    passwordField.classList.add('hidden');
                }
            });
        });
        
        // منطق فرم ساخت لابی
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitCreateLobbyBtn.disabled = true;
            
            const lobbyName = approvedLobbyNamesSelect.value;
            if (!lobbyName) {
                showLobbyMessage("لطفاً یک نام لابی تایید شده را انتخاب کنید.", 'error');
                submitCreateLobbyBtn.disabled = false;
                return;
            }

            const lobbyType = createLobbyForm.elements['lobby-type'].value;
            const password = createLobbyForm.elements['new-lobby-password-input'].value;

            if (lobbyType === 'private' && password.length < 4) {
                showLobbyMessage("رمز عبور برای لابی خصوصی باید حداقل ۴ کاراکتر باشد.", 'error');
                submitCreateLobbyBtn.disabled = false;
                return;
            }

            try {
                // ساخت لابی در فایربیس
                const lobbiesRef = collection(db, 'global_lobbies');
                const newLobbyRef = await addDoc(lobbiesRef, {
                    name: lobbyName,
                    hostId: currentUser.uid,
                    status: "waiting",
                    type: lobbyType,
                    password: lobbyType === 'private' ? password : null,
                    players: {
                        [currentUser.uid]: currentUserData.displayName
                    },
                    kickedPlayers: [],
                    createdAt: serverTimestamp(),
                    gameSettings: { maxPlayers: 4 }
                });
                
                // حذف نام استفاده شده از لیست نام‌های تایید شده کاربر
                const userProfileRef = doc(db, `artifacts/default-app-id/users/${currentUser.uid}/profile/data`);
                await updateDoc(userProfileRef, {
                    approvedLobbyNames: arrayRemove(lobbyName)
                });
                
                showLobbyMessage("لابی با موفقیت ساخته شد! در حال انتقال...", 'success');
                setTimeout(() => {
                    closeModal(createLobbyModal);
                    // انتقال به صفحه لابی با ID لابی جدید
                    window.location.href = `safe_dackel_labe.html?lobbyId=${newLobbyRef.id}`;
                }, 2000);

            } catch(error) {
                console.error("Error creating lobby:", error);
                showLobbyMessage("خطا در ساخت لابی. لطفاً دوباره تلاش کنید.", 'error');
                submitCreateLobbyBtn.disabled = false;
            }
        });


    </script>
</body>
</html>