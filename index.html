<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            /* Deep, rich, slightly textured background for classic feel */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod border */
            border-radius: 20px; /* Slightly larger radius */
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            backdrop-filter: blur(10px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh; /* Ensure card doesn't overflow viewport */
            overflow-y: auto; /* Changed to auto for modals with more content */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid #FFD700;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid #FFD700;
            border-right: 5px solid #FFD700;
            border-radius: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }


        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother transition */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); /* Stronger shadow on hover */
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
        }

        /* Specific Button Colors - Classic Pallette */
        .btn-purple-classic {
            background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); /* Amethyst */
        }
        .btn-blue-classic {
            background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); /* Steel Blue / Royal Blue */
        }
        .btn-green-classic {
            background: linear-gradient(145deg, #228B22 0%, #006400 100%); /* Forest Green */
        }
        .btn-red-classic {
            background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); /* Indian Red / Firebrick */
        }
        .btn-gray-classic {
            background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); /* Dark Gray */
        }
        .btn-brown-classic { /* New for Profile/Shop */
            background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); /* Saddle Brown / Dark Sienna */
        }
        .btn-gold-classic { /* For footer icons */
            background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); /* Gold */
            border: none; /* No border for these small buttons */
            padding: 0.5rem;
            border-radius: 10px;
        }
        .btn-gold-classic:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3);
        }


        /* Input Field Styles - More refined Classic Look */
        input, select, textarea {
            background-color: #202020; /* Even darker input background */
            border: 2px solid #5A5A5A; /* Dark gray border */
            color: #E0E0E0; /* Light text color */
            padding: 0.875rem; /* Equivalent to p-3.5 */
            border-radius: 0.75rem; /* Equivalent to rounded-xl */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); /* Inner shadow for depth */
        }
        input::placeholder, textarea::placeholder {
            color: #A0A0A0; /* Lighter placeholder text */
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #DAA520 !important; /* Gold border on focus */
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; /* Gold focus ring with inner shadow */
        }

        /* Header specific styles - Richer Gold/Brown */
        .app-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            border-bottom: 3px solid #FFD700; /* Thicker gold border */
            box-shadow: 0 8px 20px rgba(0,0,0,0.7); /* Deeper shadow */
            height: 70px; /* Fixed height for header */
            position: fixed; /* Explicitly fixed */
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Lobby Screen Specific Header */
        .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-bottom: 3px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            height: 70px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center; /* Align items vertically */
            justify-content: center; /* Center horizontally by default */
        }
        .lobby-header .search-container {
            display: flex;
            flex-grow: 1; /* Allow search container to take available space */
            max-width: 600px; /* Limit max width on larger screens */
            margin: 0 auto; /* Center the search container */
            align-items: center;
            background-color: #303030; /* Darker background for search bar */
            border-radius: 15px; /* Rounded corners for search bar */
            border: 2px solid #5A5A5A;
            padding: 0.5rem 1rem; /* Adjust padding */
        }
        .lobby-header .search-container input {
            flex-grow: 1;
            background-color: transparent; /* Transparent background */
            border: none; /* No border for input inside search bar */
            padding: 0.25rem 0.5rem;
            outline: none; /* No outline on focus */
            text-align: right; /* Align text to right for RTL */
        }
        .lobby-header .search-container input::placeholder {
            color: #A0A0A0;
        }
        .lobby-header .search-container svg {
            color: #DAA520; /* Gold color for icons */
            min-width: 24px; /* Ensure icons don't shrink */
            min-height: 24px;
        }
        .lobby-header .search-container button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.5rem;
        }
        .lobby-header .back-btn-wrapper {
            margin-left: 10px; /* Space between back button and search bar (for RTL) */
        }
        .lobby-header .search-icon-wrapper {
            margin-right: 10px; /* Space between search icon and search input (RTL) */
        }


        .app-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            border-top: 3px solid #FFD700; /* Thicker gold border */
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7); /* Deeper shadow */
            height: 90px; /* Fixed height for footer */
            position: fixed; /* Explicitly fixed */
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        /* Lobby Screen Specific Footer */
        .lobby-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-top: 3px solid #FFD700;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
            height: 90px;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #FFD700; /* Gold color for icons */
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .lobby-footer .icon-btn:hover {
            transform: translateY(-5px);
        }
        .lobby-footer .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .lobby-footer .icon-btn svg {
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
            transition: transform 0.8s ease-in-out;
        }
        .lobby-footer .games-running-text {
            color: #E0E0E0;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main content area padding to avoid overlap with fixed header/footer */
        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 90px; /* Footer height */
            flex-grow: 1; /* Allow content to fill available space */
            overflow-y: auto; /* Changed to auto for scrollable lists */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for main content */
            width: 100%; /* Ensure it takes full width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start for scrollable lists */
            align-items: center; /* Center content horizontally */
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); /* Subtle dark grey gradient for main area */
            position: relative; /* For any absolute positioned elements inside */
        }
        
        /* Profile Modal specific styles */
        .profile-modal-overlay {
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            transition: opacity 0.3s ease-in-out;
        }
        .profile-modal-content {
            transform: translateY(-20px); /* Initial slightly elevated */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .profile-modal-enter-active .profile-modal-content {
            transform: translateY(0);
        }
        .profile-modal-leave-active .profile-modal-content {
            transform: translateY(-20px);
            opacity: 0;
        }

        /* Create Lobby Modal Specific Styles */
        #create-lobby-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Confirmation Modal Styles */
        #confirmation-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Animation for lobby items when closing */
        .lobby-item.fade-out {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Enhanced Lobby Item Styling */
        .lobby-item {
            background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%); /* Deep gradient background */
            border: 2px solid #DAA520; /* Gold border */
            border-radius: 15px; /* Rounded corners */
            box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1); /* Deep outer shadow, subtle inner glow */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smooth transitions for hover effects */
            position: relative; /* For overflow hidden and pseudo-elements */
            overflow: hidden; /* Ensures internal elements stay within rounded corners */
            padding: 1.25rem 1.5rem; /* More generous padding */
            display: flex;
            flex-direction: column; /* Default to column for small screens */
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }

        .lobby-item::before { /* Subtle light overlay on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
            transform: skewX(-30deg);
            transition: all 0.3s ease-in-out;
        }

        .lobby-item:hover::before {
            left: 100%;
        }

        .lobby-item:hover {
            transform: translateY(-8px) scale(1.02); /* More pronounced lift and slight scale */
            box-shadow: 0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2); /* Stronger shadow, more glow */
        }

        .lobby-item h3 {
            color: #FFD700; /* Gold for lobby names */
            font-size: 1.75rem; /* Larger font for name */
            font-family: 'Playfair Display', serif;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }

        .lobby-item p {
            color: #C0C0C0; /* Silver for details */
            font-size: 1rem;
            margin-top: 0.25rem;
        }
        
        .lobby-item .lobby-actions { /* Container for buttons in lobby item */
            margin-top: 1rem; /* Space between text and buttons */
            display: flex;
            flex-direction: column; /* Stack buttons on mobile */
            width: 100%; /* Take full width on mobile */
            gap: 0.75rem; /* Space between stacked buttons */
        }

        /* Ensure buttons within lobby-item are full width on mobile */
        .lobby-item .join-lobby-btn,
        .lobby-item .close-lobby-btn {
            width: 100%; /* Take full width on small screens */
            padding: 0.75rem 1rem; /* Consistent padding */
            font-size: 1rem; /* Consistent font size */
        }

        /* Responsive adjustments for lobby-item buttons on larger screens */
        @media (min-width: 640px) { /* sm breakpoint */
            .lobby-item {
                flex-direction: row; /* Align items in a row */
                text-align: right; /* Text aligned right in RTL */
            }
            .lobby-item .lobby-actions {
                flex-direction: row; /* Buttons side-by-side */
                width: auto; /* Buttons take their natural width */
                margin-top: 0; /* No top margin when side-by-side */
                gap: 0.5rem; /* Small gap between buttons */
            }
            /* Add margin-left to close button for spacing from join button */
            .lobby-item .close-lobby-btn {
                margin-right: 0.5rem; /* Space from join button in RTL */
            }
            .lobby-item .join-lobby-btn,
            .lobby-item .close-lobby-btn {
                width: auto; /* Allow buttons to size naturally */
                font-size: 0.9rem; /* Slightly smaller for compactness */
                padding: 0.6rem 1.2rem; /* Adjusted padding */
            }
        }

        /* === Lobby Detail Screen Styles (Major Redesign) === */
        .lobby-detail-screen-full {
            padding-top: 0; /* No padding, the content will manage it */
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }

        .lobby-detail-content {
            background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%);
            border: 3px solid #DAA520;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.7);
            padding: 1.5rem;
            width: 95%;
            max-width: 1200px;
            height: calc(100% - 100px); /* Fill available space minus header/margins */
            display: flex;
            flex-direction: row; /* Side-by-side layout on desktop */
            gap: 1.5rem;
            margin: 50px auto; /* Centered with margin top/bottom */
            overflow: hidden; /* Prevent content from spilling */
        }

        /* Sidebar for player info */
        .lobby-sidebar {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 300px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 1rem;
            border: 1px solid #444;
            overflow-y: auto;
        }

        /* Main panel for chat and actions */
        .lobby-main-panel {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0; /* Flexbox fix for overflow */
        }
        
        #player-list-container {
            margin-top: 1rem;
            flex-grow: 1; /* Allow list to take space */
            overflow-y: auto; /* Scroll if many players */
        }
        .player-list-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column; /* Stack info and actions */
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
            gap: 0.5rem;
        }
        .player-list-item.is-host { border-color: #FFD700; }
        .player-list-item .player-info { display: flex; justify-content: space-between; align-items: center; }
        .player-list-item .player-name { font-weight: bold; color: #E0E0E0; }
        .player-list-item .host-label { color: #FFD700; font-size: 0.8rem; margin-right: 0.5rem; }
        .player-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .player-action-btn { background: none; border: 1px solid #777; color: #ccc; border-radius: 5px; padding: 0.2rem 0.5rem; font-size: 0.7rem; cursor: pointer; transition: all 0.2s ease; }
        .player-action-btn:hover { background-color: #555; }
        .kick-player-btn { border-color: #B22222; color: #B22222; }
        .kick-player-btn:hover { background-color: #B22222; color: white; }
        .mute-player-btn { border-color: #DAA520; color: #DAA520; }
        .mute-player-btn:hover { background-color: #DAA520; color: #111; }
        .make-host-btn { border-color: #4682B4; color: #4682B4; }
        .make-host-btn:hover { background-color: #4682B4; color: white; }

        .lobby-chat-container {
            background-color: rgba(0,0,0,0.4);
            border: 2px solid #5A5A5A;
            border-radius: 10px;
            padding: 0.75rem;
            flex-grow: 1; /* Key change: makes chat take all vertical space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* CRITICAL: This contains the scrolling child */
            position: relative; /* For welcome message */
        }
        #lobby-welcome-message-display { /* NEW */
            background: linear-gradient(to right, #7A4C00, #4A2B00);
            color: #FFD700;
            padding: 0.5rem;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            border: 1px solid #FFD700;
        }
        .lobby-chat-messages {
            flex-grow: 1; /* CRITICAL: This element grows to fill the parent */
            overflow-y: auto; /* CRITICAL: This element gets the scrollbar */
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            background-color: #333;
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
            align-self: flex-start;
            display: flex; /* NEW: Flex layout for message content and delete button */
            align-items: center; /* NEW: Vertically align content and button */
            gap: 0.5rem; /* NEW: Space between message and button */
        }
        .chat-message.current-user {
            background-color: #4682B4;
            align-self: flex-end;
            flex-direction: row-reverse; /* NEW: Puts delete button on the left for RTL */
        }
        .chat-message.announcement { /* NEW */
            background: linear-gradient(145deg, #DAA520, #B8860B);
            color: #111;
            max-width: 100%;
            align-self: center;
            text-align: center;
            border: 2px solid #FFD700;
        }
        .chat-message.system { /* NEW */
            background-color: transparent;
            color: #999;
            font-style: italic;
            align-self: center;
            font-size: 0.9em;
        }
        .chat-message-content {
             flex-grow: 1; /* NEW: Allows text content to take up available space */
        }
        .chat-message .sender-name {
            font-weight: bold;
            color: #FFD700;
            display: block;
            font-size: 0.9em;
            margin-bottom: 0.2rem;
        }
        .chat-message.announcement .sender-name { color: #333; }
        .chat-message .message-text-deleted { /* NEW STYLE */
            font-style: italic;
            color: #999;
        }
        .delete-message-btn { /* NEW STYLE */
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.5;
            transition: all 0.2s ease;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .chat-message:hover .delete-message-btn { /* NEW STYLE */
            opacity: 1;
        }
        .delete-message-btn:hover { /* NEW STYLE */
            color: #ff6b6b;
            transform: scale(1.1);
        }

        .lobby-chat-input-form {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0; /* CRITICAL: Prevents the input form from shrinking */
        }

        .lobby-actions-footer {
            flex-shrink: 0; /* Prevent shrinking */
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .start-game-btn {
            background: linear-gradient(145deg, #228B22 0%, #006400 100%);
            border: 2px solid #DAA520;
            font-size: 1.1rem;
            padding: 0.6rem 1.2rem;
        }
        #host-actions-container {
             display: flex;
             flex-wrap: wrap;
             gap: 1rem;
             align-items: center;
        }

        /* Custom Scrollbars */
        .classic-card::-webkit-scrollbar,
        .lobby-sidebar::-webkit-scrollbar,
        #player-list-container::-webkit-scrollbar,
        .lobby-chat-messages::-webkit-scrollbar,
        .host-controls-body::-webkit-scrollbar { width: 8px; }
        .classic-card::-webkit-scrollbar-track,
        .lobby-sidebar::-webkit-scrollbar-track,
        #player-list-container::-webkit-scrollbar-track,
        .lobby-chat-messages::-webkit-scrollbar-track,
        .host-controls-body::-webkit-scrollbar-track { background: #202020; border-radius: 4px; }
        .classic-card::-webkit-scrollbar-thumb,
        .lobby-sidebar::-webkit-scrollbar-thumb,
        #player-list-container::-webkit-scrollbar-thumb,
        .lobby-chat-messages::-webkit-scrollbar-thumb,
        .host-controls-body::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .classic-card::-webkit-scrollbar-thumb:hover,
        .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        #player-list-container::-webkit-scrollbar-thumb:hover,
        .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        .host-controls-body::-webkit-scrollbar-thumb:hover { background: #FFD700; }
        
        /* ===== CORRECTED RESPONSIVE STYLES ===== */
        @media (max-width: 860px) {
            .lobby-detail-content {
                flex-direction: column; /* Stack panels on smaller screens */
                height: calc(100% - 80px); /* Adjust height */
                margin: 40px auto;
                padding: 1rem;
                overflow: hidden; /* ** THE MAIN FIX **: Prevent the whole card from scrolling */
            }
            .lobby-sidebar {
                width: 100%; /* Sidebar takes full width */
                flex-shrink: 0; /* ** FIX **: Prevent sidebar from shrinking when keyboard opens */
                max-height: 250px; /* Limit sidebar height */
            }
            .lobby-main-panel {
                flex-grow: 1; /* ** FIX **: Allow panel to fill remaining vertical space */
                min-height: 0; /* ** FIX **: Flexbox fix to allow shrinking properly */
            }
        }
        /* General Responsive */
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header, .app-footer, .lobby-footer { padding: 0.5rem; }
            .app-header, .lobby-header { height: 60px; }
            .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; }
            .lobby-detail-content { margin: 20px auto; height: calc(100% - 40px); }
        }
        
        /* Lobby Type Toggle Styles */
        .lobby-type-btn { padding: 0.5rem 1.5rem; border: 2px solid #DAA520; border-radius: 10px; transition: all 0.2s ease-in-out; background-color: transparent; color: #DAA520; font-weight: bold; }
        .lobby-type-btn.active { background-color: #DAA520; color: #1A1A1A; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .lobby-lock-icon { width: 1.2rem; height: 1.2rem; margin-left: 0.5rem; color: #FFD700; display: inline-block; vertical-align: middle; }
        .lobby-locked-icon { display: none; } /* Initially hide */
        .lobby-item.is-locked .lobby-locked-icon { display: inline-block; } /* Show when locked */
        
        /* NEW: Host Controls Modal Styles */
        .host-controls-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            margin: 1rem 0;
            background-color: rgba(0,0,0,0.2);
            border-radius: 10px;
            border: 1px solid #5A5A5A;
        }
        .host-controls-fieldset {
            border: 2px solid #DAA520;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .host-controls-legend {
            padding: 0 0.5rem;
            font-family: 'Playfair Display', serif;
            color: #FFD700;
            font-size: 1.2rem;
        }
        /* Custom switch toggle */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #228B22; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* === Game Screen Styles (REDESIGNED) === */
        #game-screen {
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%);
            transform-style: preserve-3d;
            perspective: 2000px;
        }
        #game-table {
            background: #6B4F35; /* Fallback color for the wooden table */
            background-image: radial-gradient(ellipse at center, rgba(160, 127, 92, 0.8) 0%, rgba(74, 51, 32, 0.9) 100%),
                              repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px);
            border: 15px solid #4A3320;
            border-image-source: linear-gradient(145deg, #4A3320, #8C6F4F, #4A3320);
            border-image-slice: 1;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.85), inset 0 0 40px rgba(0,0,0,0.7);
            border-radius: 100px;
            transform-style: preserve-3d;
            position: relative;
        }
        .player-slot {
            transform-style: preserve-3d; /* Allows child transforms to work correctly */
        }

        /* NEW: Player Info Pod Styling */
        .player-area-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem; /* 8px */
            padding: 0.5rem; /* 8px */
            border-radius: 12px;
            transition: all 0.3s ease-in-out;
            z-index: 10;
        }
        .player-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #333, #111);
            border: 3px solid #DAA520;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #FFD700;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.6), 0 2px 4px rgba(0,0,0,0.4);
        }
        .player-avatar svg {
            width: 32px;
            height: 32px;
        }
        .player-name-display {
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 3px #000;
            background: rgba(0,0,0,0.5);
            padding: 0.2rem 0.8rem;
            border-radius: 8px;
        }
        .player-slot.active-turn .player-area-container {
            transform: scale(1.1);
            background-color: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5);
        }
         .player-slot.active-turn .player-name-display {
             color: #FFD700;
        }

        .player-slot .player-hand {
            display: flex;
            perspective: 800px; /* Adds depth to card arrangements */
        }

        /* Styles for playing cards */
        .card {
            width: 70px;
            height: 100px;
            background-color: white;
            border: 1px solid #333;
            border-radius: 6px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            font-size: 24px;
            font-weight: bold;
            user-select: none;
            transition: all 0.2s ease-out;
            position: relative;
        }
        .card.back {
            background-image: linear-gradient(135deg, #4B0000, #800000); /* Rich red back */
            border: 2px solid #DAA520;
        }
        .card.red { color: #DC2626; } /* Tailwind Red-600 */
        .card.black { color: #111827; } /* Tailwind Gray-900 */
        .card-rank { font-family: 'Playfair Display', serif; }
        .card-suit { font-size: 20px; }
        .card-suit.top { transform: rotate(0deg); }
        .card-suit.bottom { transform: rotate(180deg); }

        /* My hand cards (bottom player) */
        #player-slot-bottom .player-hand {
             gap: -35px; /* Overlap cards */
             margin-top: -30px; /* Pull cards up slightly over the table edge */
        }
        #player-slot-bottom .card:not(.back) {
            cursor: pointer;
        }
        #player-slot-bottom .card:not(.back):hover {
            transform: translateY(-20px) scale(1.05);
            z-index: 100; /* Bring hovered card to front */
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }
        
        /* Side players' hands & info pods */
        #player-slot-left, #player-slot-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        #player-slot-right {
             flex-direction: row-reverse;
        }
        #player-slot-left .player-hand, #player-slot-right .player-hand {
            flex-direction: column;
            gap: -80px; /* Overlap vertical cards */
        }

        /* Top player's hand & info pod */
        #player-slot-top .player-area-container {
             flex-direction: column-reverse;
        }
        #player-slot-top .player-hand {
             gap: -35px; /* Overlap cards */
             margin-bottom: -30px;
        }
        
        /* Cards in the play area */
        #play-area {
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        #play-area .card {
            position: absolute;
            transform: none; /* Reset hover transforms */
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        /* Positioning and rotation for played cards */
        #play-area .played-card-bottom {
            bottom: -50px;
            transform: translateY(0);
        }
        #play-area .played-card-left {
            left: -50px;
            transform: rotate(90deg) translateX(-50%) translateY(50%);
            transform-origin: center;
        }
        #play-area .played-card-top {
            top: -50px;
            transform: rotate(180deg);
        }
        #play-area .played-card-right {
            right: -50px;
            transform: rotate(-90deg) translateX(50%) translateY(50%);
            transform-origin: center;
        }

        /* General player slot positioning */
        #player-slot-bottom { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; }
        #player-slot-top { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center;}
        #player-slot-left { left: 40px; top: 50%; transform: translateY(-50%); }
        #player-slot-right { right: 40px; top: 50%; transform: translateY(-50%); }

        @media (max-width: 768px) {
            .card { width: 50px; height: 75px; font-size: 18px; border-radius: 4px; }
            .card-suit { font-size: 16px; }
            #player-slot-bottom .player-hand, #player-slot-top .player-hand { gap: -25px; }
            #player-slot-left .player-hand, #player-slot-right .player-hand { gap: -60px; }
             #player-slot-bottom { bottom: 10px; }
            #player-slot-top { top: 10px; }
            #player-slot-left { left: 10px; }
            #player-slot-right { right: 10px; }
            .player-avatar { width: 50px; height: 50px; }
            .player-avatar svg { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- All Modals and other screens remain the same... -->
        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="email" placeholder="ایمیل شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <!-- Toggle buttons for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth-btn"
                            class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl hidden">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info and ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                    </svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <!-- Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area flex-col justify-center">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer">
                <button id="friendly-game-btn"
                        class="classic-btn btn-purple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">
                    بازی دوستانه
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="classic-btn btn-brown-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">
                    بازی امتیازی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
                            <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                        </svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Profile Modal (Hidden by default) -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div class="text-lg space-y-4 mb-8 text-white">
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                </div>
                <button id="profile-logout-btn"
                        class="w-full classic-btn btn-red-classic text-lg sm:text-xl">
                    خروج از حساب
                </button>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">
                    <div>
                        <input type="text" id="new-lobby-name-input" placeholder="نام لابی شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500"
                               required>
                    </div>
        
                    <!-- NEW: Lobby Type Toggle (Public/Private) -->
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="public" class="sr-only" checked>
                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
                    </div>
        
                    <!-- NEW: Password field for private lobbies (initially hidden) -->
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
        
                    <button type="submit" id="submit-create-lobby-btn"
                            class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                
                <!-- Sidebar: Lobby Info & Players -->
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    
                    <div class="w-full h-px bg-yellow-600 mb-4"></div>

                    <div id="player-list-container">
                        <!-- Player list items will be dynamically loaded here -->
                    </div>
                </div>

                <!-- Main Panel: Chat & Actions -->
                <div class="lobby-main-panel">
                    <!-- Chat Container -->
                    <div class="lobby-chat-container">
                        <div id="lobby-welcome-message-display" class="hidden"></div>
                        <div id="lobby-chat-messages" class="lobby-chat-messages">
                            <!-- Chat messages will appear here -->
                        </div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form">
                            <input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>

                    <!-- Action Buttons Footer -->
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled>شروع بازی</button>
                            <!-- NEW: Host Control Panel Button -->
                            <button id="host-controls-btn" class="classic-btn btn-purple-classic text-sm py-2 px-4">کنترل پنل میزبان</button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4">لیست اخراجی‌ها</button>
                        </div>
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4 hidden">
                            بستن لابی
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- 9. Game Screen (REDESIGNED) -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden flex flex-col items-center justify-center p-2" tabindex="-1">
            <!-- Game Header: Score, Hokm, etc. -->
            <div class="absolute top-0 left-0 right-0 h-20 bg-black bg-opacity-40 flex justify-between items-center px-4 z-20">
                <div id="game-team-scores" class="text-white text-lg font-bold">
                    <span>تیم ما: <span id="our-team-score" class="text-xl text-green-300">0</span></span> |
                    <span>تیم حریف: <span id="their-team-score" class="text-xl text-red-300">0</span></span>
                </div>
                <div id="game-hokm-indicator" class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-xl font-bold text-yellow-300">حکم:</span>
                    <span id="hokm-suit-icon" class="text-4xl">❓</span>
                </div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی</button>
            </div>

            <!-- Main Game Table -->
            <div id="game-table" class="relative w-[98vw] h-[85vh] max-w-[1200px] max-h-[800px] flex items-center justify-center">
                <!-- Center play area -->
                <div id="play-area" class="absolute w-80 h-48 flex items-center justify-center">
                    <!-- Cards played in the current trick will appear here -->
                </div>

                <!-- Player Slots -->
                <div id="player-slot-bottom" class="player-slot absolute">
                    <div class="player-area-container">
                        <div class="player-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">شما</span>
                    </div>
                    <div class="player-hand flex justify-center">
                        <!-- Player's cards generated by JS -->
                    </div>
                </div>

                <div id="player-slot-left" class="player-slot absolute">
                    <div class="player-hand flex justify-center">
                         <!-- Opponent's cards (face down) -->
                    </div>
                    <div class="player-area-container">
                        <div class="player-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">بازیکن ۲</span>
                    </div>
                </div>

                <div id="player-slot-top" class="player-slot absolute">
                     <div class="player-area-container">
                        <div class="player-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">یار شما</span>
                    </div>
                    <div class="player-hand flex justify-center">
                        <!-- Partner's cards (face down) -->
                    </div>
                </div>

                <div id="player-slot-right" class="player-slot absolute">
                    <div class="player-hand flex justify-center">
                        <!-- Opponent's cards (face down) -->
                    </div>
                    <div class="player-area-container">
                        <div class="player-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">بازیکن ۴</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ... All other modals (kick, kicked message, etc.) remain the same ... -->
        <!-- 10. Kick Player Confirmation Modal -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">اخراج بازیکن</h2>
                <button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <p class="text-lg mb-8 text-white">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button>
                    <button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                </div>
            </div>
        </div>

        <!-- 11. Kicked Message Modal -->
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-400">شما اخراج شدید!</h2>
                <p id="kicked-message-text" class="text-lg mb-8 text-white">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p>
                <button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button>
            </div>
        </div>

        <!-- 12. Kicked Players List Modal -->
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">لیست بازیکنان اخراج شده</h2>
                <button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div id="kicked-players-list-content" class="space-y-4 mb-8 text-white text-left max-h-60 overflow-y-auto custom-scrollbar">
                    <!-- Kicked players will be dynamically loaded here -->
                    <p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p>
                </div>
                <button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button>
            </div>
        </div>
        
        <!-- 13. Enter Password Modal (for private lobbies) -->
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2>
                <p class="text-lg mb-6 text-white">لابی <span id="password-prompt-lobby-name" class="font-bold text-yellow-300"></span> نیاز به رمز عبور دارد.</p>
                <form id="enter-password-form" class="space-y-5">
                    <div>
                        <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                               required>
                    </div>
                    <div class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 14. NEW: Host Controls Modal -->
        <div id="host-controls-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-lg text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">کنترل پنل میزبان</h2>
                <button id="close-host-controls-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div id="host-controls-form" class="host-controls-body text-right space-y-4">
                    <!-- Lobby Settings -->
                    <fieldset class="host-controls-fieldset">
                        <legend class="host-controls-legend">تنظیمات اصلی لابی</legend>
                        <div class="space-y-4">
                            <div>
                                <label for="host-lobby-name-input" class="block mb-2 text-white">تغییر نام لابی:</label>
                                <input type="text" id="host-lobby-name-input" class="w-full">
                            </div>
                            <div>
                                <label for="host-lobby-type-select" class="block mb-2 text-white">نوع لابی:</label>
                                <select id="host-lobby-type-select" class="w-full">
                                    <option value="public">عمومی</option>
                                    <option value="private">خصوصی</option>
                                </select>
                            </div>
                            <div id="host-lobby-password-container" class="hidden">
                                <label for="host-lobby-password-input" class="block mb-2 text-white">رمز عبور جدید (اختیاری):</label>
                                <input type="text" id="host-lobby-password-input" class="w-full" placeholder="برای تغییر رمز، اینجا وارد کنید">
                            </div>
                        </div>
                    </fieldset>
                    <!-- Game Rules -->
                    <fieldset class="host-controls-fieldset">
                        <legend class="host-controls-legend">قوانین بازی</legend>
                        <div class="space-y-4">
                            <div>
                                <label for="host-rounds-to-win-select" class="block mb-2 text-white">دست لازم برای پیروزی:</label>
                                <select id="host-rounds-to-win-select" class="w-full">
                                    <option value="5">5 دست</option>
                                    <option value="7">7 دست</option>
                                    <option value="11">11 دست</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="host-team-shuffle-toggle" class="text-white">بر زدن تیم‌ها (تصادفی):</label>
                                <label class="switch"><input type="checkbox" id="host-team-shuffle-toggle"><span class="slider"></span></label>
                            </div>
                        </div>
                    </fieldset>
                    <!-- Management -->
                     <fieldset class="host-controls-fieldset">
                        <legend class="host-controls-legend">مدیریت لابی</legend>
                        <div class="space-y-4">
                            <div>
                                <label for="host-welcome-message-input" class="block mb-2 text-white">پیام خوشامدگویی:</label>
                                <textarea id="host-welcome-message-input" rows="2" class="w-full" placeholder="این پیام بالای چت نمایش داده می‌شود"></textarea>
                            </div>
                            <div>
                                <label for="host-announcement-input" class="block mb-2 text-white">ارسال اعلان عمومی:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="host-announcement-input" class="w-full" placeholder="پیام شما...">
                                    <button id="host-send-announcement-btn" class="classic-btn btn-gold-classic !p-3">ارسال</button>
                                </div>
                            </div>
                             <div class="flex justify-between items-center">
                                <label for="host-lobby-lock-toggle" class="text-white">قفل کردن لابی (جلوگیری از ورود):</label>
                                <label class="switch"><input type="checkbox" id="host-lobby-lock-toggle"><span class="slider"></span></label>
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="host-autostart-toggle" class="text-white">شروع خودکار پس از تکمیل ظرفیت:</label>
                                <label class="switch"><input type="checkbox" id="host-autostart-toggle"><span class="slider"></span></label>
                            </div>
                        </div>
                    </fieldset>
                    <!-- Actions -->
                    <fieldset class="host-controls-fieldset">
                        <legend class="host-controls-legend">عملیات سریع</legend>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                           <button id="host-add-bot-btn" class="classic-btn btn-blue-classic !text-base">افزودن بازیکن ربات</button>
                           <button id="host-clear-chat-btn" class="classic-btn btn-gray-classic !text-base">پاک کردن چت</button>
                           <button id="host-kick-all-btn" class="classic-btn btn-red-classic !text-base col-span-1 sm:col-span-2">اخراج همه بازیکنان</button>
                        </div>
                    </fieldset>
                </div>
                <div class="flex justify-around space-x-4 space-x-reverse mt-6">
                    <button id="save-host-controls-btn" class="w-1/2 classic-btn btn-green-classic">ذخیره تغییرات</button>
                    <button id="cancel-host-controls-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                </div>
                <div id="host-controls-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 15. NEW: View Player Profile Modal -->
        <div id="view-player-profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-sm text-center relative">
                 <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل بازیکن</h2>
                 <button id="close-view-player-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div class="text-lg space-y-4 mb-8 text-white">
                    <p><strong>نام نمایشی:</strong> <span id="view-profile-display-name">---</span></p>
                    <p><strong>شناسه کاربر:</strong> <span id="view-profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                    <!-- Future stats can go here -->
                </div>
                 <button id="view-profile-ok-btn" class="w-full classic-btn btn-blue-classic">بستن</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // REVISED: Imported deleteField for updating player maps
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Firebase Configuration (from user's input)
        // **IMPORTANT**: You should replace these with your actual Firebase project configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase context (as per environment instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen UI Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn'); // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Profile Modal Elements
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        // Create Lobby Modal Elements
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field');
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');

        // Custom Confirmation Modal Elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // Lobby Detail Screen Elements
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const hostControlsBtn = document.getElementById('host-controls-btn'); // NEW
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChatSendBtn = document.getElementById('lobby-chat-send-btn');
        const lobbyWelcomeMessageDisplay = document.getElementById('lobby-welcome-message-display'); // NEW

        // Game Screen Elements
        const gameScreen = document.getElementById('game-screen');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const hokmSuitIcon = document.getElementById('hokm-suit-icon');
        const ourTeamScoreEl = document.getElementById('our-team-score');
        const theirTeamScoreEl = document.getElementById('their-team-score');
        const playArea = document.getElementById('play-area');
        const playerSlots = {
            bottom: document.getElementById('player-slot-bottom'),
            left: document.getElementById('player-slot-left'),
            top: document.getElementById('player-slot-top'),
            right: document.getElementById('player-slot-right'),
        };

        // Kick Player Modals & related
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-btn');
        const kickPlayerConfirmName = document.getElementById('kick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedLobbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');
        const kickedPlayersListModal = document.getElementById('kicked-players-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        const kickedPlayersListContent = document.getElementById('kicked-players-list-content');
        const kickedListOkBtn = document.getElementById('kicked-list-ok-btn');
        
        // Enter Password Modal Elements
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // NEW: Host Controls Modal Elements
        const hostControlsModal = document.getElementById('host-controls-modal');
        const closeHostControlsModalBtn = document.getElementById('close-host-controls-modal-btn');
        const hostLobbyNameInput = document.getElementById('host-lobby-name-input');
        const hostLobbyTypeSelect = document.getElementById('host-lobby-type-select');
        const hostLobbyPasswordContainer = document.getElementById('host-lobby-password-container');
        const hostLobbyPasswordInput = document.getElementById('host-lobby-password-input');
        const hostRoundsToWinSelect = document.getElementById('host-rounds-to-win-select');
        const hostTeamShuffleToggle = document.getElementById('host-team-shuffle-toggle');
        const hostWelcomeMessageInput = document.getElementById('host-welcome-message-input');
        const hostAnnouncementInput = document.getElementById('host-announcement-input');
        const hostSendAnnouncementBtn = document.getElementById('host-send-announcement-btn');
        const hostLobbyLockToggle = document.getElementById('host-lobby-lock-toggle');
        const hostAutostartToggle = document.getElementById('host-autostart-toggle');
        const hostAddBotBtn = document.getElementById('host-add-bot-btn');
        const hostClearChatBtn = document.getElementById('host-clear-chat-btn');
        const hostKickAllBtn = document.getElementById('host-kick-all-btn');
        const saveHostControlsBtn = document.getElementById('save-host-controls-btn');
        const cancelHostControlsBtn = document.getElementById('cancel-host-controls-btn');
        const hostControlsMessageBox = document.getElementById('host-controls-message-box');

        // NEW: View Player Profile Modal Elements
        const viewPlayerProfileModal = document.getElementById('view-player-profile-modal');
        const closeViewPlayerProfileModalBtn = document.getElementById('close-view-player-profile-modal-btn');
        const viewProfileDisplayName = document.getElementById('view-profile-display-name');
        const viewProfileUid = document.getElementById('view-profile-uid');
        const viewProfileOkBtn = document.getElementById('view-profile-ok-btn');

        // State variables
        let authMode = 'login'; 
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; 
        let unsubscribeLobbies = null; 
        let unsubscribeLobbyDetail = null; 
        let unsubscribeGame = null;
        let unsubscribeKickedPlayers = null;
        let unsubscribeLobbyChat = null; 
        let isAuthResolved = false;
        let userHasActiveLobby = false;
        let currentLobbyId = null; 
        let currentLobbyData = null; // NEW: store lobby data for modals
        let kickedPlayerToProcess = null;
        let lobbyToJoin = null; 
        let isRefreshing = false;
        let resolveCustomConfirm;
        let autoStartTimerId = null; // NEW: for auto-start timeout

        // --- Utility Functions (Message Boxes, Modals, etc.) ---
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            setTimeout(() => { element.classList.add('hidden'); }, 5000);
        }
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);
        const showHostControlsMessageBox = (msg, type) => showCustomMessage(hostControlsMessageBox, msg, type);

        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                resolveCustomConfirm = resolve;
                confirmYesBtn.onclick = () => { closeCustomConfirm(); resolve(true); };
                confirmNoBtn.onclick = () => { closeCustomConfirm(); resolve(false); };
            });
        }
        function closeCustomConfirm() { customConfirmModal.classList.add('hidden'); }

        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }

            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                currentActiveScreen = newScreen;
            }, 600);
        }

        // Generic Modal Open/Close
        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            void modalElement.offsetWidth;
            modalElement.querySelector('.classic-card').classList.add('profile-modal-enter-active');
        }
        function closeModal(modalElement) {
            const card = modalElement.querySelector('.classic-card');
            card.classList.remove('profile-modal-enter-active');
            card.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                modalElement.classList.add('hidden');
                card.classList.remove('profile-modal-leave-active');
            }, 300);
        }
        
        // Modal specific open/close functions
        const openProfileModal = () => {
             if (currentUserData) {
                profileDisplayName.textContent = currentUserData.displayName || 'ناشناس';
                profileEmail.textContent = currentUserData.email || 'ناشناس';
                profileUid.textContent = currentUserData.uid || 'ناشناس';
            }
            openModal(profileModal) 
        };
        const closeProfileModal = () => closeModal(profileModal);
        const openCreateLobbyModal = () => {
            openModal(createLobbyModal);
            createLobbyMessageBox.classList.add('hidden');
            createLobbyForm.reset();
        };
        const closeCreateLobbyModal = () => closeModal(createLobbyModal);
        const openKickPlayerConfirmModal = (playerName, playerUid) => {
            kickPlayerConfirmName.textContent = playerName;
            kickedPlayerToProcess = { uid: playerUid, displayName: playerName };
            openModal(kickPlayerConfirmModal);
        };
        const closeKickPlayerConfirmModal = () => closeModal(kickPlayerConfirmModal);
        const openKickedPlayersListModal = () => {
             if (currentLobbyId) {
                unsubscribeKickedPlayers = setupKickedPlayersListListener(currentLobbyId);
            }
            openModal(kickedPlayersListModal);
        }
        const closeKickedPlayersListModal = () => {
            if(unsubscribeKickedPlayers) unsubscribeKickedPlayers();
            closeModal(kickedPlayersListModal);
        }
        const openEnterPasswordModal = (lobbyId, lobbyName) => {
            lobbyToJoin = { id: lobbyId, name: lobbyName };
            passwordPromptLobbyName.textContent = lobbyName;
            enterPasswordForm.reset();
            passwordPromptMessageBox.classList.add('hidden');
            openModal(enterPasswordModal);
        }
        const closeEnterPasswordModal = () => closeModal(enterPasswordModal);
        
        // --- AI Moderation ---
        async function checkLobbyNameWithAI(lobbyName) {
            // This function remains the same as provided previously
            return { is_appropriate: true, reason: "" }; // Placeholder for brevity
        }

        // --- Firebase Auth & Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (!isAuthResolved) { isAuthResolved = true; }
            if (user) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                const userDocSnap = await getDoc(userDocRef);
                currentUserData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: (userDocSnap.exists() && userDocSnap.data().displayName) ? userDocSnap.data().displayName : (user.displayName || 'کاربر ناشناس')
                };
                headerDisplayName.textContent = currentUserData.displayName;
                headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                if (currentActiveScreen === loadingScreen || currentActiveScreen === authScreen) {
                    setActiveScreen(mainScreen);
                }
            } else {
                setActiveScreen(authScreen);
                currentUserData = null;
                // Cleanup all listeners
            }
        });
        async function initializeFirebaseAndAuth() {
            if (initialAuthToken) {
                try { await signInWithCustomToken(auth, initialAuthToken); } catch (error) { console.error("Error signing in with initial token:", error); }
            }
        }
        const getFirebaseErrorMessage = (code) => ({ 'auth/invalid-credential': "ایمیل یا رمز عبور اشتباه است." }[code] || "خطایی ناشناخته رخ داده است.");

        // --- NEW: Host Controls Modal Logic ---
        function openHostControlsModal() {
            if (!currentLobbyData) return;
            const settings = currentLobbyData.gameSettings || {};
            // Populate form
            hostLobbyNameInput.value = currentLobbyData.name;
            hostLobbyTypeSelect.value = currentLobbyData.type;
            hostLobbyPasswordInput.value = '';
            hostLobbyPasswordContainer.classList.toggle('hidden', currentLobbyData.type !== 'private');
            hostRoundsToWinSelect.value = settings.roundsToWin || 7;
            hostTeamShuffleToggle.checked = settings.teamShuffle || false;
            hostLobbyLockToggle.checked = currentLobbyData.isLocked || false;
            hostAutostartToggle.checked = settings.autoStart || false;
            hostWelcomeMessageInput.value = currentLobbyData.welcomeMessage || '';
            hostAnnouncementInput.value = '';
            // Show modal
            openModal(hostControlsModal);
        }

        async function saveHostSettings() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            
            const newName = hostLobbyNameInput.value.trim();
            const newType = hostLobbyTypeSelect.value;
            const newPassword = hostLobbyPasswordInput.value.trim();

            if (!newName) {
                showHostControlsMessageBox('نام لابی نمی‌تواند خالی باشد.', 'error');
                return;
            }

            const updates = {
                name: newName,
                type: newType,
                'gameSettings.roundsToWin': parseInt(hostRoundsToWinSelect.value, 10),
                'gameSettings.teamShuffle': hostTeamShuffleToggle.checked,
                'gameSettings.autoStart': hostAutostartToggle.checked,
                isLocked: hostLobbyLockToggle.checked,
                welcomeMessage: hostWelcomeMessageInput.value.trim(),
            };

            if (newType === 'private' && newPassword) {
                updates.password = newPassword;
            } else if (newType === 'public') {
                updates.password = deleteField();
            }

            try {
                await updateDoc(lobbyRef, updates);
                showHostControlsMessageBox('تنظیمات با موفقیت ذخیره شد.', 'success');
                setTimeout(() => closeModal(hostControlsModal), 1500);
            } catch (error) {
                console.error("Error saving host settings:", error);
                showHostControlsMessageBox('خطا در ذخیره تنظیمات.', 'error');
            }
        }
        
        // --- NEW: Player Profile Modal ---
        function openPlayerProfileModal(playerUid, playerName) {
            viewProfileDisplayName.textContent = playerName;
            viewProfileUid.textContent = playerUid;
            openModal(viewPlayerProfileModal);
        }

        // --- Firebase Lobby Functions (UPDATED) ---
        async function createLobby(lobbyName, userId, displayName, lobbyType, password) {
            const newLobbyData = {
                name: lobbyName, hostId: userId, status: "waiting", type: lobbyType,
                players: { [userId]: displayName },
                kickedPlayers: [], createdAt: serverTimestamp(),
                isChatLocked: false, isLocked: false, welcomeMessage: '', // NEW DEFAULTS
                gameSettings: { maxPlayers: 4, roundsToWin: 7, teamShuffle: false, autoStart: false }, // NEW DEFAULTS
                mutedPlayers: {}, // NEW
            };
            if (lobbyType === 'private') newLobbyData.password = password;
            const newLobbyRef = await addDoc(collection(db, `global_lobbies`), newLobbyData);
            return newLobbyRef.id;
        }

        function setupLobbyListener(searchTerm = '') {
            if (unsubscribeLobbies) unsubscribeLobbies();
            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>';
            const q = query(collection(db, `global_lobbies`), where("status", "==", "waiting"));
            unsubscribeLobbies = onSnapshot(q, (snapshot) => {
                lobbiesList.innerHTML = '';
                const lobbiesToDisplay = [];
                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    // Filtering logic...
                    lobbiesToDisplay.push(lobby);
                });
                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p class="text-gray-400">لابی با این مشخصات یافت نشد.</p>';
                    return;
                }
                lobbiesToDisplay.forEach(lobby => {
                    const playersMap = lobby.players || {};
                    const isCurrentUserHost = auth.currentUser && lobby.hostId === auth.currentUser.uid;
                    const canJoin = !Object.keys(playersMap).includes(auth.currentUser?.uid) && !lobby.isLocked;
                    
                    const lockIconHtml = lobby.type === 'private' ? `<svg class="lobby-lock-icon" ...>...</svg>` : '';
                    const lockedLobbyIcon = lobby.isLocked ? `<svg class="lobby-lock-icon lobby-locked-icon" ...>...</svg>` : '';

                    let actionButtonHtml = `<button class="join-lobby-btn classic-btn btn-blue-classic opacity-50" disabled>ورود به لابی</button>`;
                    if (isCurrentUserHost) {
                        actionButtonHtml = `<button data-lobby-id="${lobby.id}" class="view-my-lobby-btn classic-btn btn-blue-classic">ورود به لابی من</button>`;
                    } else if (canJoin) {
                        actionButtonHtml = `<button data-lobby-id="${lobby.id}" data-lobby-type="${lobby.type}" data-lobby-name="${lobby.name}" class="join-lobby-btn classic-btn btn-blue-classic">ورود به لابی</button>`;
                    }

                    const lobbyItem = document.createElement('div');
                    lobbyItem.className = `lobby-item mb-3 w-full ${lobby.isLocked ? 'is-locked' : ''}`;
                    lobbyItem.dataset.lobbyId = lobby.id;
                    lobbyItem.innerHTML = `
                        <div class="mb-2 sm:mb-0 text-center sm:text-right">
                            <h3 class="text-xl font-bold">${lockIconHtml}${lockedLobbyIcon}${lobby.name}</h3>
                            <p class="text-sm">سازنده: ${playersMap[lobby.hostId] || 'ناشناس'}</p>
                            <p class="text-sm">بازیکنان: ${Object.keys(playersMap).length}/${lobby.gameSettings.maxPlayers}</p>
                        </div>
                        <div class="lobby-actions">
                             ${isCurrentUserHost ? `<button data-lobby-id="${lobby.id}" class="close-lobby-btn classic-btn btn-red-classic">بستن</button>` : ''}
                            ${actionButtonHtml}
                        </div>`;
                    lobbiesList.appendChild(lobbyItem);
                });
                // Attach event listeners for join, view, close...
            });
            return unsubscribeLobbies;
        }

        async function joinLobby(lobbyId, userId, displayName, password = null) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if (!lobbySnap.exists()) throw new Error("لابی یافت نشد.");
            
            const lobby = lobbySnap.data();
            if (lobby.isLocked) throw new Error("این لابی توسط میزبان قفل شده است.");
            if (lobby.type === 'private' && lobby.password !== password) throw new Error("رمز عبور اشتباه است.");
            // ... other checks (full, kicked)
            
            await updateDoc(lobbyRef, { [`players.${userId}`]: displayName });
            
            currentLobbyId = lobbyId;
            setActiveScreen(lobbyDetailScreen);
            unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
        }

        function setupLobbyDetailListener(lobbyId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentLobbyData = docSnap.data(); // Store current data
                    const isCurrentUserHost = auth.currentUser && currentLobbyData.hostId === auth.currentUser.uid;
                    // ... check for game start, kicked, etc.

                    // Update UI
                    detailLobbyName.textContent = currentLobbyData.name;
                    detailHostName.textContent = `سازنده: ${currentLobbyData.players[currentLobbyData.hostId] || 'ناشناس'}`;
                    const playerCount = Object.keys(currentLobbyData.players).length;
                    detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${currentLobbyData.gameSettings.maxPlayers}`;
                    
                    // Show/Hide Welcome Message
                    if (currentLobbyData.welcomeMessage) {
                        lobbyWelcomeMessageDisplay.textContent = currentLobbyData.welcomeMessage;
                        lobbyWelcomeMessageDisplay.classList.remove('hidden');
                    } else {
                        lobbyWelcomeMessageDisplay.classList.add('hidden');
                    }
                    
                    // Render player list with new actions
                    playerListContainer.innerHTML = '';
                    Object.entries(currentLobbyData.players).forEach(([uid, name]) => {
                        const isPlayerHost = uid === currentLobbyData.hostId;
                        const isMuted = currentLobbyData.mutedPlayers && currentLobbyData.mutedPlayers[uid];
                        
                        let actionsHtml = '';
                        if (isCurrentUserHost && !isPlayerHost) {
                            actionsHtml = `
                                <button class="player-action-btn kick-player-btn" data-player-uid="${uid}" data-player-name="${name}">اخراج</button>
                                <button class="player-action-btn mute-player-btn" data-player-uid="${uid}">${isMuted ? 'باصدا' : 'بی‌صدا'}</button>
                                <button class="player-action-btn make-host-btn" data-player-uid="${uid}" data-player-name="${name}">انتقال میزبانی</button>
                            `;
                        }
                        
                        const playerItem = document.createElement('div');
                        playerItem.className = `player-list-item ${isPlayerHost ? 'is-host' : ''}`;
                        playerItem.innerHTML = `
                            <div class="player-info">
                                <span class="player-name">${name} ${isPlayerHost ? '<span class="host-label">(میزبان)</span>' : ''}</span>
                                <button class="player-action-btn view-profile-btn" data-player-uid="${uid}" data-player-name="${name}">پروفایل</button>
                            </div>
                            <div class="player-actions">${actionsHtml}</div>
                        `;
                        playerListContainer.appendChild(playerItem);
                    });

                    // Manage Host vs Player UI
                    hostActionsContainer.style.display = isCurrentUserHost ? 'flex' : 'none';
                    leaveLobbyBtn.classList.toggle('hidden', !isCurrentUserHost);
                    
                    // Auto-start logic
                    if (isCurrentUserHost && currentLobbyData.gameSettings.autoStart && playerCount === currentLobbyData.gameSettings.maxPlayers && !autoStartTimerId) {
                        autoStartTimerId = setTimeout(() => {
                           if (currentLobbyId === lobbyId) startGameBtn.click();
                        }, 5000); // 5 second timer
                         sendLobbyMessage(lobbyId, "ظرفیت تکمیل شد. بازی تا ۵ ثانیه دیگر شروع می‌شود.", 'system');
                    } else if (playerCount < currentLobbyData.gameSettings.maxPlayers && autoStartTimerId) {
                        clearTimeout(autoStartTimerId);
                        autoStartTimerId = null;
                    }
                } else {
                    // Lobby closed
                    setActiveScreen(lobbyScreen);
                }
            });
        }
        
        async function sendLobbyMessage(lobbyId, text, type = 'user') {
            if (!text.trim() || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if (lobbySnap.exists() && lobbySnap.data().mutedPlayers?.[auth.currentUser.uid]) {
                showMessageBox('شما توسط میزبان بی‌صدا شده‌اید.', 'error');
                return;
            }

            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            await addDoc(messagesRef, {
                text: text.trim(),
                senderUid: type === 'system' ? 'system' : auth.currentUser.uid,
                senderName: type === 'system' ? 'سیستم' : (type === 'announcement' ? `اعلان از طرف ${currentUserData.displayName}` : currentUserData.displayName),
                timestamp: serverTimestamp(),
                isDeleted: false,
                type: type // 'user', 'announcement', 'system'
            });
            if (type === 'user') lobbyChatInput.value = '';
        }

        function setupLobbyChatListener(lobbyId) {
            const q = query(collection(db, `global_lobbies/${lobbyId}/messages`), orderBy("timestamp", "asc"));
            return onSnapshot(q, (snapshot) => {
                lobbyChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const msgDiv = document.createElement('div');
                    msgDiv.classList.add('chat-message', msg.type || 'user');
                    // ... logic to render different message types ...
                    lobbyChatMessages.appendChild(msgDiv);
                });
                lobbyChatMessages.scrollTop = lobbyChatMessages.scrollHeight;
            });
        }
        
        // --- Event Listeners ---
        window.onload = initializeFirebaseAndAuth;

        // NEW: Host Controls Modal Listeners
        hostControlsBtn.addEventListener('click', openHostControlsModal);
        closeHostControlsModalBtn.addEventListener('click', () => closeModal(hostControlsModal));
        cancelHostControlsBtn.addEventListener('click', () => closeModal(hostControlsModal));
        saveHostControlsBtn.addEventListener('click', saveHostSettings);
        hostLobbyTypeSelect.addEventListener('change', (e) => {
            hostLobbyPasswordContainer.classList.toggle('hidden', e.target.value !== 'private');
        });
        hostSendAnnouncementBtn.addEventListener('click', () => {
            const announcementText = hostAnnouncementInput.value.trim();
            if (announcementText && currentLobbyId) {
                sendLobbyMessage(currentLobbyId, announcementText, 'announcement');
                hostAnnouncementInput.value = '';
                showHostControlsMessageBox('اعلان ارسال شد.', 'success');
            }
        });

        hostKickAllBtn.addEventListener('click', async () => {
             if (!currentLobbyId || !currentLobbyData) return;
             const confirmed = await showCustomConfirm('آیا مطمئن هستید که می‌خواهید همه بازیکنان را اخراج کنید؟');
             if (confirmed) {
                 const updates = {};
                 Object.keys(currentLobbyData.players).forEach(uid => {
                     if (uid !== auth.currentUser.uid) {
                         updates[`players.${uid}`] = deleteField();
                     }
                 });
                 await updateDoc(doc(db, 'global_lobbies', currentLobbyId), updates);
                 sendLobbyMessage(currentLobbyId, 'میزبان همه بازیکنان را اخراج کرد.', 'system');
             }
        });

        hostAddBotBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !currentLobbyData) return;
            const playerCount = Object.keys(currentLobbyData.players).length;
            if (playerCount >= 4) {
                 showHostControlsMessageBox('لابی پر است.', 'error'); return;
            }
            const botId = `bot_${Date.now()}`;
            const botName = `بات ${Math.floor(Math.random() * 100)}`;
            await updateDoc(doc(db, 'global_lobbies', currentLobbyId), {
                [`players.${botId}`]: botName
            });
             sendLobbyMessage(currentLobbyId, `${botName} به بازی اضافه شد.`, 'system');
        });

        hostClearChatBtn.addEventListener('click', async () => {
            if (!currentLobbyId) return;
             const confirmed = await showCustomConfirm('آیا تاریخچه چت برای همه پاک شود؟');
             if (confirmed) {
                 const messagesRef = collection(db, `global_lobbies/${currentLobbyId}/messages`);
                 const messagesSnap = await getDocs(messagesRef);
                 const batch = writeBatch(db);
                 messagesSnap.forEach(doc => batch.delete(doc.ref));
                 await batch.commit();
                 sendLobbyMessage(currentLobbyId, 'تاریخچه چت توسط میزبان پاک شد.', 'system');
             }
        });

        // NEW: Player Profile Modal Listeners
        closeViewPlayerProfileModalBtn.addEventListener('click', () => closeModal(viewPlayerProfileModal));
        viewProfileOkBtn.addEventListener('click', () => closeModal(viewPlayerProfileModal));

        // NEW: Event Delegation for Player Actions in Lobby
        playerListContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('.player-action-btn');
            if (!button || !currentLobbyId) return;

            const playerUid = button.dataset.playerUid;
            const playerName = button.dataset.playerName;

            if (button.classList.contains('kick-player-btn')) {
                openKickPlayerConfirmModal(playerName, playerUid);
            } 
            else if (button.classList.contains('mute-player-btn')) {
                const isMuted = currentLobbyData.mutedPlayers && currentLobbyData.mutedPlayers[playerUid];
                await updateDoc(doc(db, 'global_lobbies', currentLobbyId), {
                    [`mutedPlayers.${playerUid}`]: !isMuted
                });
            }
            else if (button.classList.contains('make-host-btn')) {
                const confirmed = await showCustomConfirm(`آیا میزبانی به ${playerName} منتقل شود؟ شما دیگر کنترل لابی را نخواهید داشت.`);
                if (confirmed) {
                    await updateDoc(doc(db, 'global_lobbies', currentLobbyId), { hostId: playerUid });
                     sendLobbyMessage(currentLobbyId, `میزبانی به ${playerName} منتقل شد.`, 'system');
                }
            }
            else if (button.classList.contains('view-profile-btn')) {
                 openPlayerProfileModal(playerUid, playerName);
            }
        });


    </script>
</body>
</html>
