<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی تشخیص هوش مصنوعی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* استایل‌های قبلی را حفظ کنید */
        /* اضافه کردن استایل‌های جدید */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            font-family: 'Playfair Display', serif;
        }
        
        .countdown-number {
            font-size: 15rem;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .role-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 5px 10px;
            color: white;
            font-weight: bold;
        }
        
        .ai-role {
            background: linear-gradient(145deg, #4B0000, #800000);
        }
        
        .human-role {
            background: linear-gradient(145deg, #004B00, #008000);
        }
        
        .game-timer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            font-size: 1.5rem;
            z-index: 50;
            display: flex;
            align-items: center;
        }
        
        .timer-icon {
            margin-left: 10px;
        }
        
        .voting-section {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #1A1A1A, #2A2A2A);
            border: 3px solid #DAA520;
            border-radius: 15px;
            padding: 20px;
            z-index: 60;
            width: 80%;
            max-width: 500px;
        }
        
        .player-vote-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- تمام المان‌های قبلی را حفظ کنید -->
    
    <!-- اضافه کردن المان‌های جدید برای بازی تشخیص هوش مصنوعی -->
    <div id="countdown-overlay" class="countdown-overlay hidden">
        <div id="countdown-number" class="countdown-number">5</div>
    </div>
    
    <div id="game-timer" class="game-timer hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="timer-icon lucide lucide-clock">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
        </svg>
        <span id="timer-display">05:00</span>
    </div>
    
    <div id="voting-section" class="voting-section">
        <h3 class="text-xl font-bold text-yellow-300 mb-4">رای‌گیری برای تشخیص هوش مصنوعی</h3>
        <div id="players-to-vote"></div>
        <button id="submit-votes-btn" class="classic-btn btn-green-classic mt-4 w-full">ثبت رای‌ها</button>
    </div>

    <script type="module">
        // تمام ایمپورت‌ها و کانفیگ‌های قبلی را حفظ کنید
        
        // اضافه کردن متغیرهای جدید
        let gameTimer;
        let gameDuration = 300; // 5 دقیقه به ثانیه
        let currentGameTimer;
        let aiPlayerId = null;
        let votes = {};
        
        // تابع شروع بازی جدید
        async function startAIGame(lobbyId, lobbyData) {
            // انتخاب تصادفی یک بازیکن به عنوان هوش مصنوعی
            const playerUIDs = Object.keys(lobbyData.players);
            aiPlayerId = playerUIDs[Math.floor(Math.random() * playerUIDs.length)];
            
            // نمایش شمارش معکوس
            showCountdown();
            
            // تنظیم نقش‌ها برای بازیکنان
            const gameState = {
                players: playerUIDs,
                playerNames: lobbyData.players,
                aiPlayer: aiPlayerId,
                gameDuration: lobbyData.gameSettings?.gameDuration || 300,
                phase: 'playing',
                startTime: serverTimestamp(),
                votes: {}
            };
            
            // ذخیره وضعیت بازی در Firestore
            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            await updateDoc(lobbyRef, {
                gameState: gameState,
                status: "playing"
            });
            
            // شروع تایمر بازی
            startGameTimer(gameState.gameDuration);
        }
        
        // نمایش شمارش معکوس
        function showCountdown() {
            const countdownOverlay = document.getElementById('countdown-overlay');
            const countdownNumber = document.getElementById('countdown-number');
            
            countdownOverlay.classList.remove('hidden');
            let count = 5;
            
            const countdownInterval = setInterval(() => {
                countdownNumber.textContent = count;
                count--;
                
                if (count < 0) {
                    clearInterval(countdownInterval);
                    countdownOverlay.classList.add('hidden');
                    document.getElementById('game-timer').classList.remove('hidden');
                }
            }, 1000);
        }
        
        // شروع تایمر بازی
        function startGameTimer(duration) {
            gameDuration = duration;
            clearInterval(currentGameTimer);
            
            const timerDisplay = document.getElementById('timer-display');
            updateTimerDisplay(timerDisplay, gameDuration);
            
            currentGameTimer = setInterval(() => {
                gameDuration--;
                updateTimerDisplay(timerDisplay, gameDuration);
                
                if (gameDuration <= 0) {
                    clearInterval(currentGameTimer);
                    endGame();
                }
            }, 1000);
        }
        
        // آپدیت نمایش تایمر
        function updateTimerDisplay(element, seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            element.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            // تغییر رنگ هنگام نزدیک شدن به پایان زمان
            if (seconds <= 30) {
                element.classList.add('text-red-400');
            } else {
                element.classList.remove('text-red-400');
            }
        }
        
        // پایان بازی و شروع رای‌گیری
        function endGame() {
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            updateDoc(lobbyRef, {
                'gameState.phase': 'voting'
            });
            
            // نمایش بخش رای‌گیری
            showVotingSection();
        }
        
        // نمایش بخش رای‌گیری
        function showVotingSection() {
            const votingSection = document.getElementById('voting-section');
            const playersContainer = document.getElementById('players-to-vote');
            
            votingSection.style.display = 'block';
            playersContainer.innerHTML = '';
            
            // دریافت لیست بازیکنان از وضعیت بازی
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            getDoc(lobbyRef).then(docSnap => {
                if (docSnap.exists()) {
                    const gameState = docSnap.data().gameState;
                    
                    Object.keys(gameState.playerNames).forEach(playerId => {
                        if (playerId !== auth.currentUser.uid) {
                            const playerDiv = document.createElement('div');
                            playerDiv.className = 'player-vote-item';
                            playerDiv.innerHTML = `
                                <span>${gameState.playerNames[playerId]}</span>
                                <select class="vote-select classic-btn btn-gray-classic" data-player-id="${playerId}">
                                    <option value="human">انسان</option>
                                    <option value="ai">هوش مصنوعی</option>
                                </select>
                            `;
                            playersContainer.appendChild(playerDiv);
                        }
                    });
                }
            });
        }
        
        // تایید رای‌ها
        document.getElementById('submit-votes-btn').addEventListener('click', async () => {
            const voteSelects = document.querySelectorAll('.vote-select');
            const myVotes = {};
            
            voteSelects.forEach(select => {
                myVotes[select.dataset.playerId] = select.value;
            });
            
            // ذخیره رای‌ها در Firestore
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            await updateDoc(lobbyRef, {
                [`gameState.votes.${auth.currentUser.uid}`]: myVotes
            });
            
            // بررسی آیا همه رای دادند
            checkVotingComplete();
        });
        
        // بررسی تکمیل رای‌گیری
        async function checkVotingComplete() {
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            const docSnap = await getDoc(lobbyRef);
            
            if (docSnap.exists()) {
                const gameState = docSnap.data().gameState;
                const playerCount = Object.keys(gameState.playerNames).length;
                const votesCount = Object.keys(gameState.votes || {}).length;
                
                if (votesCount === playerCount) {
                    calculateResults(gameState);
                }
            }
        }
        
        // محاسبه نتایج
        function calculateResults(gameState) {
            let aiVotes = {};
            const aiPlayerId = gameState.aiPlayer;
            
            // جمع‌آوری رای‌ها
            Object.values(gameState.votes).forEach(vote => {
                Object.entries(vote).forEach(([playerId, voteValue]) => {
                    if (voteValue === 'ai') {
                        aiVotes[playerId] = (aiVotes[playerId] || 0) + 1;
                    }
                });
            });
            
            // پیدا کردن بازیکنی که بیشترین رای به عنوان AI را دارد
            let suspectedAI = null;
            let maxVotes = 0;
            
            Object.entries(aiVotes).forEach(([playerId, voteCount]) => {
                if (voteCount > maxVotes) {
                    maxVotes = voteCount;
                    suspectedAI = playerId;
                }
            });
            
            // بررسی نتیجه
            const isAICorrectlyIdentified = (suspectedAI === aiPlayerId);
            const humanTeamWins = isAICorrectlyIdentified;
            
            // نمایش نتیجه
            showGameResult(humanTeamWins, gameState.playerNames[aiPlayerId]);
        }
        
        // نمایش نتیجه نهایی
        function showGameResult(humanTeamWins, aiPlayerName) {
            const resultMessage = humanTeamWins 
                ? `تیم انسان برنده شد! هوش مصنوعی (${aiPlayerName}) به درستی شناسایی شد.` 
                : `هوش مصنوعی برنده شد! بازیکنان نتوانستند هوش مصنوعی را شناسایی کنند.`;
            
            showCustomConfirm(resultMessage, "نتیجه بازی").then(() => {
                // بازگشت به صفحه لابی
                const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
                deleteDoc(lobbyRef);
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            });
        }
        
        // تغییر در تابع initializeGameInFirestore
        async function initializeGameInFirestore(lobbyId, lobbyData) {
            // اضافه کردن gameDuration به تنظیمات بازی
            if (!lobbyData.gameSettings) {
                lobbyData.gameSettings = {};
            }
            lobbyData.gameSettings.gameDuration = lobbyData.gameSettings.gameDuration || 300;
            
            await startAIGame(lobbyId, lobbyData);
        }
        
        // تغییر در تابع setupGameListener برای پشتیبانی از بازی جدید
        function setupGameListener(lobbyId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().gameState) {
                    const lobbyData = docSnap.data();
                    const gameState = lobbyData.gameState;
                    
                    // نمایش نقش بازیکن
                    showPlayerRole(gameState);
                    
                    // مدیریت مراحل مختلف بازی
                    if (gameState.phase === 'playing') {
                        // بازی در حال انجام است
                    } else if (gameState.phase === 'voting') {
                        // مرحله رای‌گیری
                        if (!document.getElementById('voting-section').style.display === 'block') {
                            showVotingSection();
                        }
                    }
                }
            });
        }
        
        // نمایش نقش بازیکن
        function showPlayerRole(gameState) {
            const isAI = (gameState.aiPlayer === auth.currentUser.uid);
            const roleIndicator = document.createElement('div');
            roleIndicator.className = `role-indicator ${isAI ? 'ai-role' : 'human-role'}`;
            roleIndicator.textContent = isAI ? 'شما هوش مصنوعی هستید' : 'شما انسان هستید';
            
            // اضافه کردن به صفحه بازی
            const gameScreen = document.getElementById('game-screen');
            gameScreen.appendChild(roleIndicator);
            
            // تنظیم دستورالعمل‌های چت بر اساس نقش
            setupChatRules(isAI);
        }
        
        // تنظیم قوانین چت بر اساس نقش
        function setupChatRules(isAI) {
            const chatInput = document.getElementById('lobby-chat-input');
            const chatSendBtn = document.getElementById('lobby-chat-send-btn');
            
            if (isAI) {
                // هوش مصنوعی باید طبیعی صحبت کند
                chatInput.placeholder = "به عنوان هوش مصنوعی طبیعی صحبت کنید...";
            } else {
                // انسان‌ها باید مصنوعی صحبت کنند
                chatInput.placeholder = "به زبان مصنوعی/رسمی صحبت کنید...";
            }
            
            // تغییر در ارسال پیام برای بررسی محتوا
            const originalSendHandler = chatSendBtn.onclick;
            
            chatSendBtn.onclick = async (e) => {
                e.preventDefault();
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                // بررسی محتوای پیام با API
                const isAppropriate = await checkMessageWithAI(message, isAI);
                
                if (isAppropriate) {
                    originalSendHandler(e);
                } else {
                    showMessageBox(
                        isAI ? "پیام شما طبیعی به نظر نمی‌رسد! به عنوان هوش مصنوعی طبیعی صحبت کنید." 
                             : "پیام شما بسیار طبیعی است! به زبان مصنوعی/رسمی صحبت کنید.",
                        "error"
                    );
                }
            };
        }
        
        // بررسی پیام با API
        async function checkMessageWithAI(message, isAI) {
            const prompt = isAI
                ? `آیا این پیام به اندازه کافی طبیعی به نظر می‌رسد که توسط یک انسان نوشته شده باشد؟ پاسخ باید به صورت JSON باشد: {"natural": boolean}`
                : `آیا این پیام به اندازه کافی مصنوعی/رسمی به نظر می‌رسد که توسط یک هوش مصنوعی نوشته شده باشد؟ پاسخ باید به صورت JSON باشد: {"artificial": boolean}`;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer YOUR_OPENAI_API_KEY'
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {"role": "system", "content": prompt},
                            {"role": "user", "content": message}
                        ],
                        response_format: { type: "json_object" }
                    })
                });
                
                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                
                return isAI ? result.natural : result.artificial;
            } catch (error) {
                console.error("Error checking message with AI:", error);
                return true; // در صورت خطا اجازه ارسال داده می‌شود
            }
        }
        
        // تغییر در تابع createLobbyModal برای اضافه کردن تنظیم زمان بازی
        function openCreateLobbyModal() {
            // کد قبلی
            
            // اضافه کردن فیلد تنظیم زمان بازی
            createLobbyForm.innerHTML += `
                <div class="mt-4">
                    <label class="block text-white mb-2">زمان بازی (دقیقه)</label>
                    <input type="number" id="game-duration-input" min="1" max="30" value="5" 
                           class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
            `;
        }
        
        // تغییر در تابع createLobby برای ذخیره زمان بازی
        async function createLobby(lobbyName, userId, displayName, lobbyType, password) {
            // کد قبلی
            
            // اضافه کردن زمان بازی به تنظیمات
            const gameDuration = parseInt(document.getElementById('game-duration-input').value) * 60;
            newLobbyData.gameSettings = {
                maxPlayers: 4,
                gameDuration: gameDuration
            };
            
            // بقیه کدها
        }
        
        // تغییر در تابع renderGameScreen برای پشتیبانی از بازی جدید
        function renderGameScreen(lobbyData) {
            const gameState = lobbyData.gameState;
            
            // مخفی کردن المان‌های مربوط به بازی حکم
            document.getElementById('game-team-scores').style.display = 'none';
            document.getElementById('game-hokm-indicator').style.display = 'none';
            document.getElementById('play-area').style.display = 'none';
            
            // نمایش اطلاعات بازی تشخیص هوش مصنوعی
            showPlayerRole(gameState);
            
            // اگر مرحله رای‌گیری است، بخش رای‌گیری را نمایش دهید
            if (gameState.phase === 'voting') {
                showVotingSection();
            }
        }
    </script>
</body>
</html>