<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی متنی - صفحه اصلی</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look & New Themes -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&family=Share+Tech+Mono&family=Orbitron:wght@400..900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* All CSS from the original file goes here... */
        /* General Classic Theme Background and Fonts */
        html, body, #app { height: 100%; margin: 0; padding: 0; overflow: hidden; transition: background-color 0.8s ease-in-out, color 0.8s ease-in-out; }
        .classic-card, .classic-btn, input, select, .app-header, .lobby-header, .app-footer, .lobby-footer, .lobby-item, .lobby-chat-container, .chat-message, .game-player-pod, .voting-btn, .lobby-type-btn { transition: background 0.8s ease-in-out, background-color 0.8s ease-in-out, color 0.8s ease-in-out, border-color 0.8s ease-in-out, box-shadow 0.8s ease-in-out, transform 0.3s ease; }
        body.theme-classic { font-family: 'Merriweather', serif; background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); color: #E0E0E0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        body.theme-classic h1, body.theme-classic h2 { font-family: 'Playfair Display', serif; color: #FFD700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        body.theme-classic p, body.theme-classic span { color: #E0E0E0; }
        /* ... (The rest of the massive CSS block) ... */
        .coin-icon { width: 1.25rem; height: 1.25rem; display: inline-block; vertical-align: middle; margin-right: 0.25rem; }
    </style>
</head>
<body class="theme-classic">

    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 3. Main Screen -->
        <div id="main-screen" class="absolute inset-0 flex flex-col z-30">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg">نام کاربری</span>
                        <span id="header-user-id" class="text-xs break-all">ID: ---</span>
                    </div>
                </div>
                <div class="flex-grow"></div> 
                <div id="header-user-coins-container" class="flex items-center text-xl sm:text-2xl font-extrabold">
                    <svg class="coin-icon w-6 h-6 sm:w-8 sm:h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span id="header-user-coins">---</span>
                </div>
                <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area flex flex-col justify-center items-center">
                <h1 class="text-4xl font-bold mb-8">به بازی متنی خوش آمدید!</h1>
                <p class="text-lg">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer flex justify-center items-center gap-4">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                    <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span>بازی دوستانه (<span id="friendly-game-cost">100</span>)</span>
                </button>
                <button id="rated-game-btn" class="classic-btn btn-brown-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">بازی امتیازی</button>
            </footer>
        </div>

        <!-- Main Menu Modal -->
        <div id="main-menu-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <button id="close-main-menu-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div id="main-menu-nav" class="space-y-4">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">منوی اصلی</h2>
                    <button id="show-profile-btn" class="w-full classic-btn btn-blue-classic text-lg sm:text-xl">پروفایل کاربری</button>
                    <button id="show-themes-btn" class="w-full classic-btn btn-green-classic text-lg sm:text-xl">انتخاب تم</button>
                    <button id="main-menu-logout-btn" class="w-full classic-btn btn-red-classic text-lg sm:text-xl">خروج از حساب</button>
                </div>
                <div id="profile-view" class="hidden text-lg space-y-4 mb-8 text-right">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm">---</span></p>
                    <p><strong>سکه‌ها:</strong> <span id="profile-coins" class="font-bold">---</span></p>
                    <button id="back-to-main-menu-from-profile" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">بازگشت</button>
                </div>
                <div id="themes-view" class="hidden text-lg space-y-4 mb-8">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">انتخاب تم</h2>
                    <div id="theme-buttons-container" class="grid grid-cols-2 gap-4"></div>
                    <button id="back-to-main-menu-from-themes" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">بازگشت</button>
                </div>
            </div>
        </div>

        <!-- Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // DOM Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const headerUserCoins = document.getElementById('header-user-coins');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const friendlyGameCostSpan = document.getElementById('friendly-game-cost');
        const ratedGameBtn = document.getElementById('rated-game-btn');
        
        // Modal Elements
        const mainMenuModal = document.getElementById('main-menu-modal');
        const closeMainMenuModalBtn = document.getElementById('close-main-menu-modal-btn');
        const mainMenuNav = document.getElementById('main-menu-nav');
        const showProfileBtn = document.getElementById('show-profile-btn');
        const showThemesBtn = document.getElementById('show-themes-btn');
        const mainMenuLogoutBtn = document.getElementById('main-menu-logout-btn');
        const profileView = document.getElementById('profile-view');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileCoins = document.getElementById('profile-coins');
        const backToMainMenuFromProfile = document.getElementById('back-to-main-menu-from-profile');
        const themesView = document.getElementById('themes-view');
        const themeButtonsContainer = document.getElementById('theme-buttons-container');
        const backToMainMenuFromThemes = document.getElementById('back-to-main-menu-from-themes');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // State variables
        let currentUserData = null;
        let unsubscribeUserProfile = null;
        let unsubscribeGameSettings = null;
        let gameEntryCost = 100;
        let currentTheme = 'classic';
        let resolveCustomConfirm;

        // Redirect to login page if user is not authenticated
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'sabt_name.html';
                return;
            }
            
            // If user exists, setup listeners
            setupUserProfileListener(user.uid);
            setupGameSettingsListener();
        });

        function setupUserProfileListener(userId) {
            if (unsubscribeUserProfile) unsubscribeUserProfile();
            
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            unsubscribeUserProfile = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = { uid: userId, ...docSnap.data() };
                    updateUIWithUserData();
                }
            });
        }

        function setupGameSettingsListener() {
            if (unsubscribeGameSettings) unsubscribeGameSettings();
            
            const configRef = doc(db, `artifacts/${appId}/config/game_settings`);
            unsubscribeGameSettings = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const newCost = docSnap.data().gameEntryCost;
                    if (typeof newCost === 'number') {
                        gameEntryCost = newCost;
                        friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa-IR');
                    }
                }
            });
        }

        function updateUIWithUserData() {
            if (!currentUserData) return;
            headerDisplayName.textContent = currentUserData.displayName || 'کاربر ناشناس';
            headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
            headerUserCoins.textContent = (currentUserData.coins || 0).toLocaleString('fa-IR');

            // Apply theme
            const savedTheme = currentUserData.theme || 'classic';
            if (currentTheme !== savedTheme) {
                applyTheme(savedTheme);
            }
        }
        
        // --- Event Listeners ---
        friendlyGameBtn.addEventListener('click', () => {
            if (!currentUserData) {
                alert("در حال بارگذاری اطلاعات کاربری، لطفاً کمی صبر کنید.");
                return;
            }
            if ((currentUserData.coins || 0) < gameEntryCost) {
                alert(`سکه شما برای ورود به بازی دوستانه کافی نیست. (نیاز: ${gameEntryCost} سکه، موجودی شما: ${currentUserData.coins || 0})`);
                return;
            }
            window.location.href = 'safe_list_libey.html';
        });

        ratedGameBtn.addEventListener('click', () => alert("بازی امتیازی به زودی!"));

        // --- Modals and Theme Logic ---
        const themeConfigs = {
            'classic': { displayName: 'کلاسیک', bodyClass: 'theme-classic', buttonClass: 'btn-brown-classic' },
            'cyberpunk': { displayName: 'سایبرپانک', bodyClass: 'theme-cyberpunk', buttonClass: 'btn-purple-classic' },
            'forest': { displayName: 'جنگلی', bodyClass: 'theme-forest', buttonClass: 'btn-green-classic' },
            'ocean': { displayName: 'اقیانوس', bodyClass: 'theme-ocean', buttonClass: 'btn-blue-classic' },
            'minimal': { displayName: 'مینیمال', bodyClass: 'theme-minimal', buttonClass: 'btn-gray-classic' }
        };

        async function applyTheme(themeName) {
            let config = themeConfigs[themeName];
            if (!config) themeName = 'classic', config = themeConfigs['classic'];
            Object.values(themeConfigs).forEach(conf => document.body.classList.remove(conf.bodyClass));
            document.body.classList.add(config.bodyClass);
            currentTheme = themeName;
            updateThemeButtonsActiveState();
            if (auth.currentUser && currentUserData && currentUserData.theme !== themeName) {
                try {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                    await updateDoc(userProfileRef, { theme: themeName });
                } catch (error) { console.error("Error saving theme:", error); }
            }
        }

        function populateThemeButtons() {
            themeButtonsContainer.innerHTML = '';
            for (const themeKey in themeConfigs) {
                const theme = themeConfigs[themeKey];
                const button = document.createElement('button');
                button.className = `classic-btn ${theme.buttonClass} text-base sm:text-lg theme-button`;
                button.dataset.theme = themeKey;
                button.textContent = theme.displayName;
                button.addEventListener('click', () => applyTheme(themeKey));
                themeButtonsContainer.appendChild(button);
            }
            updateThemeButtonsActiveState();
        }

        function updateThemeButtonsActiveState() {
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.toggle('active-theme-btn', btn.dataset.theme === currentTheme);
            });
        }

        function openMainMenuModal() {
            mainMenuModal.classList.remove('hidden');
            mainMenuNav.classList.remove('hidden');
            profileView.classList.add('hidden');
            themesView.classList.add('hidden');
        }

        function closeMainMenuModal() {
            mainMenuModal.classList.add('hidden');
        }
        
        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                resolveCustomConfirm = resolve;
            });
        }

        function closeCustomConfirm() {
            customConfirmModal.classList.add('hidden');
        }

        menuBtn.addEventListener('click', openMainMenuModal);
        profileSummary.addEventListener('click', openMainMenuModal);
        closeMainMenuModalBtn.addEventListener('click', closeMainMenuModal);
        showProfileBtn.addEventListener('click', () => {
            mainMenuNav.classList.add('hidden');
            profileView.classList.remove('hidden');
            if (currentUserData) {
                profileDisplayName.textContent = currentUserData.displayName || 'ناشناس';
                profileEmail.textContent = currentUserData.email || 'ناشناس';
                profileUid.textContent = currentUserData.uid || 'ناشناس';
                profileCoins.textContent = (currentUserData.coins || 0).toLocaleString('fa-IR');
            }
        });
        showThemesBtn.addEventListener('click', () => {
            mainMenuNav.classList.add('hidden');
            themesView.classList.remove('hidden');
            populateThemeButtons();
        });
        backToMainMenuFromProfile.addEventListener('click', () => {
            profileView.classList.add('hidden');
            mainMenuNav.classList.remove('hidden');
        });
        backToMainMenuFromThemes.addEventListener('click', () => {
            themesView.classList.add('hidden');
            mainMenuNav.classList.remove('hidden');
        });
        mainMenuLogoutBtn.addEventListener('click', async () => {
            const confirmed = await showCustomConfirm("آیا مطمئن هستید که می‌خواهید از حساب کاربری خود خارج شوید؟");
            if (confirmed) {
                await signOut(auth); // onAuthStateChanged will handle the redirect
            }
            closeCustomConfirm();
        });
        confirmYesBtn.addEventListener('click', () => resolveCustomConfirm(true));
        confirmNoBtn.addEventListener('click', () => resolveCustomConfirm(false));

    </script>
</body>
</html>
