<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Merriweather', serif;
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%);
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2 {
            font-family: 'Playfair Display', serif;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Custom spinner for loading screen */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Page transition animation */
        .page-transition-active { transition: opacity 0.6s ease-in-out; }
        .page-transition-hidden { opacity: 0; }
        .page-transition-visible { opacity: 1; }

        /* Classic Card/Modal Styling */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%);
            border: 4px solid #DAA520;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .classic-card::before, .classic-card::after { content: ''; position: absolute; width: 30px; height: 30px; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .classic-card::before { top: -10px; left: -10px; border-top: 5px solid #FFD700; border-left: 5px solid #FFD700; border-radius: 5px 0 0 0; }
        .classic-card::after { bottom: -10px; right: -10px; border-bottom: 5px solid #FFD700; border-right: 5px solid #FFD700; border-radius: 0 0 5px 0; }

        /* Button Base Styles */
        .classic-btn {
            border: 2px solid #DAA520;
            border-radius: 15px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
            color: #FFFFFF;
            padding: 0.875rem 1.5rem;
            font-size: 1.125rem;
            position: relative;
            overflow: hidden;
        }
        .classic-btn:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); }
        .classic-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); }
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }

        /* Input Field Styles */
        input, select {
            background-color: #202020; border: 2px solid #5A5A5A; color: #E0E0E0; padding: 0.875rem;
            border-radius: 0.75rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        input:focus, select:focus { border-color: #DAA520 !important; box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; outline: none; }

        /* Header & Footer Styles */
        .app-header, .lobby-header, .game-header { background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); height: 70px; position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
        .app-footer, .lobby-footer { background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); height: 90px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding: 1rem; display: flex; justify-content: space-around; align-items: center; }
        .main-content-area { padding-top: 70px; padding-bottom: 90px; flex-grow: 1; overflow-y: auto; width: 100%; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        
        /* Modal Styles */
        .modal-overlay { background-color: rgba(0,0,0,0.7); transition: opacity 0.3s ease-in-out; }
        .modal-content { transform: translateY(-20px); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal-enter-active .modal-content { transform: translateY(0); }
        .modal-leave-active .modal-content { transform: translateY(-20px); opacity: 0; }

        /* Lobby Item Styles */
        .lobby-item { background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%); border: 2px solid #DAA520; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1); transition: all 0.3s ease; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .lobby-item:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2); }
        
        /* Lobby Detail Styles */
        .lobby-detail-screen-full { display: flex; flex-direction: column; width: 100%; height: 100%; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        .lobby-detail-content { background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%); border: 3px solid #DAA520; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.7); padding: 1.5rem; width: 95%; max-width: 1200px; height: calc(100% - 100px); display: flex; flex-direction: row; gap: 1.5rem; margin: 50px auto; overflow: hidden; }
        .lobby-sidebar { display: flex; flex-direction: column; flex-shrink: 0; width: 300px; background-color: rgba(0,0,0,0.3); border-radius: 15px; padding: 1rem; border: 1px solid #444; overflow-y: auto; }
        .lobby-main-panel { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .player-list-item { background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
        .player-list-item.is-host { border-color: #FFD700; }
        .player-info { display: flex; align-items: center; gap: 0.75rem; }
        .player-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #DAA520; }
        .ready-indicator { width: 12px; height: 12px; border-radius: 50%; transition: background-color 0.3s; }
        .ready-indicator.not-ready { background-color: #B22222; box-shadow: 0 0 5px #B22222; }
        .ready-indicator.ready { background-color: #228B22; box-shadow: 0 0 5px #228B22; }
        .chat-message .chat-avatar { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #DAA520; flex-shrink: 0; margin-left: 8px; margin-right: -4px; }
        .chat-message.current-user .chat-avatar { margin-right: 8px; margin-left: -4px; }

        /* Profile, Coin, Shop Styles */
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #DAA520; margin: 0 auto 1rem; }
        .avatar-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 1rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .avatar-option:hover { transform: scale(1.1); border-color: #FFF; }
        .avatar-option.selected { border-color: #FFD700; box-shadow: 0 0 15px #FFD700; transform: scale(1.1); }
        .coin-balance { display: flex; align-items: center; gap: 0.5rem; background-color: rgba(0,0,0,0.5); padding: 0.25rem 0.75rem; border-radius: 20px; border: 1px solid #DAA520; }
        .shop-item { background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 100%); border: 2px solid #555; border-radius: 15px; padding: 1rem; text-align: center; transition: all 0.2s ease; }
        .shop-item:hover { transform: translateY(-5px); border-color: #DAA520; }
        .shop-item img.card-back-preview { width: 100px; height: auto; margin: 0 auto 1rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        .daily-reward-icon { font-size: 5rem; color: #FFD700; text-shadow: 0 0 20px #FFD700; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* ===== NEW: GAME SCREEN STYLES ===== */
        #game-screen {
            background: url('https://www.transparenttextures.com/patterns/green-cup.png'), linear-gradient(180deg, #004d00 0%, #002900 100%);
            width: 100%;
            height: 100%;
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
        }
        .game-area {
            flex-grow: 1;
            position: relative;
            width: 100%;
            height: 100%;
        }
        .player-area {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            padding: 10px;
            background: rgba(0,0,0,0.4);
            border: 2px solid #DAA520;
            border-radius: 15px;
            min-width: 150px;
        }
        .player-area.active-player {
            box-shadow: 0 0 20px #FFD700;
            transform: scale(1.05);
        }
        .player-area-bottom { bottom: 100px; left: 50%; transform: translateX(-50%); flex-direction: row; width: 80%; justify-content: center; background: transparent; border: none; }
        .player-area-top { top: 80px; left: 50%; transform: translateX(-50%); }
        .player-area-left { top: 50%; left: 10px; transform: translateY(-50%); }
        .player-area-right { top: 50%; right: 10px; transform: translateY(-50%); }
        
        .hand { display: flex; justify-content: center; align-items: flex-end; gap: -30px; }
        .card {
            width: 80px;
            height: 120px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            background-size: cover;
        }
        .player-area-bottom .hand .card:hover { transform: translateY(-20px); z-index: 100; }
        .card-face {
            width: 100%; height: 100%;
            background-color: #fff; color: #000;
            border-radius: 8px;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 5px; font-size: 24px; font-weight: bold;
        }
        .card-face.red { color: #B22222; }
        .card-face .rank { line-height: 1; }
        .card-face .suit { font-size: 36px; text-align: center; }

        .game-table-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 400px; height: 250px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
        }
        .table-card-slot { position: relative; }
        .table-card-slot .card { position: absolute; top: 0; left: 0; }

        .game-info-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            border: 2px solid #DAA520;
            border-radius: 10px;
            padding: 10px;
            color: white;
            text-align: right;
        }
        .trump-suit-display { display: flex; align-items: center; gap: 10px; font-size: 24px; }
        .game-log-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 250px;
            height: 80px;
            background: rgba(0,0,0,0.6);
            border: 1px solid #DAA520;
            border-radius: 5px;
            padding: 5px;
            font-size: 12px;
            overflow-y: auto;
        }
        .game-log-panel p { margin: 0; padding: 2px 0; border-bottom: 1px solid #444; }

        /* Trump Selection Modal */
        #trump-selection-modal .suit-selection-btn {
            font-size: 4rem; padding: 1rem;
            background: rgba(255,255,255,0.1); border: 2px solid #DAA520;
            border-radius: 15px; cursor: pointer; transition: all 0.2s ease;
        }
        #trump-selection-modal .suit-selection-btn:hover { background: #DAA520; color: #000; }

    </style>
</head>
<body>

    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-black z-50 page-transition-active page-transition-visible">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center z-40 page-transition-active page-transition-hidden">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div><input type="email" id="email" placeholder="ایمیل شما" class="w-full" required></div>
                    <div id="display-name-field" class="hidden"><input type="text" id="display-name" placeholder="نام نمایشی (در بازی)" class="w-full"></div>
                    <div><input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="w-full" required></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic">ورود</button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic">ثبت نام</button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic hidden">ادامه</button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <header class="app-header">
                <div id="profile-summary" class="flex items-center space-x-4 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700/50" title="مشاهده پروفایل">
                    <img id="header-avatar" src="./avatars/default.png" alt="Avatar" class="w-12 h-12 rounded-full border-2 border-yellow-400">
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <div id="header-coin-balance" class="coin-balance mt-1">
                            <span id="header-coin-amount">0</span>
                        </div>
                    </div>
                </div>
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700/50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </header>
            <div class="main-content-area items-center justify-center">
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>
            <footer class="app-footer">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic w-1/2 mx-2">بازی دوستانه</button>
                <button id="rated-game-btn" class="classic-btn btn-brown-classic w-1/2 mx-2">بازی امتیازی</button>
            </footer>
        </div>

        <!-- 4. Lobby Screen -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Lobby Header and Footer are similar to Main Screen, code omitted for brevity but present in final code -->
            <div class="main-content-area p-4 sm:p-6">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 text-center">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full"><p class="text-gray-400 text-center">در حال بارگذاری لابی‌ها...</p></div>
                </div>
            </div>
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="flex flex-col items-center text-yellow-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg><span>ایجاد</span></button>
                <button id="shop-btn" class="flex flex-col items-center text-yellow-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg><span>فروشگاه</span></button>
                <button id="quick-join-btn" class="flex flex-col items-center text-yellow-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>ورود سریع</span></button>
            </footer>
        </div>

        <!-- 5. Lobby Detail Screen -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full">
            <div class="lobby-detail-content">
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    <div class="w-full h-px bg-yellow-600 mb-4"></div>
                    <div id="player-list-container"></div>
                </div>
                <div class="lobby-main-panel">
                    <div id="lobby-chat-container" class="flex-grow"></div>
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled>شروع بازی</button>
                        </div>
                        <div id="player-actions-container" style="display: none;">
                            <button id="player-ready-btn" class="classic-btn btn-green-classic text-lg">آماده</button>
                        </div>
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic">ترک لابی</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 6. NEW: GAME SCREEN ===== -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden">
            <header class="game-header">
                <div id="game-info-panel" class="flex gap-x-6 items-center">
                    <div class="text-center">
                        <div class="text-sm text-gray-300">امتیاز شما</div>
                        <div id="game-team1-score" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-300">امتیاز حریف</div>
                        <div id="game-team2-score" class="text-2xl font-bold">0</div>
                    </div>
                    <div id="trump-suit-display" class="text-center">
                        <div class="text-sm text-gray-300">حکم</div>
                        <div id="game-trump-icon" class="text-3xl">❓</div>
                    </div>
                </div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic !py-2 !px-4 !text-sm">خروج از بازی</button>
            </header>
            
            <div class="game-area">
                <!-- Player Areas -->
                <div id="player-area-top" class="player-area player-area-top"></div>
                <div id="player-area-left" class="player-area player-area-left"></div>
                <div id="player-area-right" class="player-area player-area-right"></div>
                
                <!-- Table Center -->
                <div class="game-table-center">
                    <div id="table-slot-bottom" class="table-card-slot"></div>
                    <div id="table-slot-right" class="table-card-slot"></div>
                    <div id="table-slot-top" class="table-card-slot"></div>
                    <div id="table-slot-left" class="table-card-slot"></div>
                </div>

                <!-- Current Player's Hand -->
                <div id="player-area-bottom" class="player-area player-area-bottom">
                    <div id="player-hand" class="hand"></div>
                </div>

                <!-- Game Log -->
                <div id="game-log-panel" class="game-log-panel"></div>
            </div>
        </div>

        <!-- All Modals -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-lg text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">پروفایل کاربری</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <img id="profile-modal-avatar" src="./avatars/default.png" alt="Avatar" class="profile-avatar">
                <p class="text-lg mb-4"><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                <div class="w-full h-px bg-yellow-600 my-4"></div>
                <h3 class="text-xl font-bold text-yellow-400 mb-2">انتخاب آواتار</h3>
                <div id="avatar-selection-grid" class="avatar-selection-grid mb-4"></div>
                <div class="w-full h-px bg-yellow-600 my-4"></div>
                <h3 class="text-xl font-bold text-yellow-400 mb-2">تجهیزات</h3>
                <div id="equip-section" class="text-left">
                    <label for="equip-card-back-select" class="block mb-2 text-white">پشت کارت:</label>
                    <select id="equip-card-back-select" class="w-full"></select>
                </div>
                <div class="w-full h-px bg-yellow-600 my-4"></div>
                <button id="profile-logout-btn" class="w-full classic-btn btn-red-classic">خروج از حساب</button>
            </div>
        </div>
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
             <div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <form id="create-lobby-form" class="space-y-5">
                    <div><input type="text" id="new-lobby-name-input" placeholder="نام لابی شما" class="w-full" required></div>
                    <div>
                        <label for="rounds-to-win-select" class="block mb-2 text-white text-right">امتیاز پیروزی:</label>
                        <select id="rounds-to-win-select" class="w-full">
                            <option value="3">بازی سرعتی (۳ دست)</option>
                            <option value="7" selected>بازی استاندارد (۷ دست)</option>
                            <option value="11">بازی طولانی (۱۱ دست)</option>
                        </select>
                    </div>
                    <button type="submit" id="submit-create-lobby-btn" class="w-full mt-4 classic-btn btn-green-classic">ساخت لابی</button>
                </form>
            </div>
        </div>
        <div id="daily-reward-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-8 w-11/12 max-w-sm text-center relative">
                <span class="daily-reward-icon">🎁</span>
                <h2 class="text-2xl sm:text-3xl font-bold my-4">پاداش روزانه!</h2>
                <p class="text-lg mb-6 text-white">برای ورود امروزتان، شما <span id="daily-reward-amount" class="font-bold text-yellow-300"></span> سکه طلا دریافت کردید!</p>
                <button id="claim-daily-reward-btn" class="w-full classic-btn btn-green-classic">عالیه!</button>
            </div>
        </div>
        <div id="trump-selection-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">حکم را انتخاب کنید</h2>
                <div class="flex justify-around">
                    <button class="suit-selection-btn" data-suit="Spades">♠️</button>
                    <button class="suit-selection-btn" data-suit="Hearts">♥️</button>
                    <button class="suit-selection-btn" data-suit="Diamonds">♦️</button>
                    <button class="suit-selection-btn" data-suit="Clubs">♣️</button>
                </div>
            </div>
        </div>
        <div id="game-over-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-8 w-11/12 max-w-md text-center">
                <h2 id="game-over-title" class="text-3xl font-bold mb-6">بازی تمام شد!</h2>
                <p id="game-over-message" class="text-xl mb-8"></p>
                <button id="game-over-ok-btn" class="w-full classic-btn btn-blue-classic">بازگشت به لابی‌ها</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, deleteDoc, getDocs, orderBy, deleteField, writeBatch, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const gameScreen = document.getElementById('game-screen');
        
        // Auth
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 

        // Main Screen Header
        const profileSummary = document.getElementById('profile-summary');
        const headerAvatar = document.getElementById('header-avatar');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerCoinAmount = document.getElementById('header-coin-amount');
        const menuBtn = document.getElementById('menu-btn');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Modals
        const profileModal = document.getElementById('profile-modal');
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const dailyRewardModal = document.getElementById('daily-reward-modal');
        const trumpSelectionModal = document.getElementById('trump-selection-modal');
        const gameOverModal = document.getElementById('game-over-modal');

        // Profile Modal
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileModalAvatar = document.getElementById('profile-modal-avatar');
        const profileDisplayName = document.getElementById('profile-display-name');
        const avatarSelectionGrid = document.getElementById('avatar-selection-grid');
        const equipCardBackSelect = document.getElementById('equip-card-back-select');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        // Create Lobby Modal
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const roundsToWinSelect = document.getElementById('rounds-to-win-select');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');

        // Lobby Detail Screen
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const playerActionsContainer = document.getElementById('player-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerReadyBtn = document.getElementById('player-ready-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');

        // Game Screen
        const gameTeam1Score = document.getElementById('game-team1-score');
        const gameTeam2Score = document.getElementById('game-team2-score');
        const gameTrumpIcon = document.getElementById('game-trump-icon');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const playerHand = document.getElementById('player-hand');
        const gameLogPanel = document.getElementById('game-log-panel');
        const gameOverOkBtn = document.getElementById('game-over-ok-btn');

        // --- State Variables ---
        let authMode = 'login';
        let currentActiveScreen = loadingScreen;
        let currentUserData = null;
        let unsubscribeLobbies = null;
        let unsubscribeLobbyDetail = null;
        let unsubscribeGameState = null;
        let currentLobbyId = null;
        let currentLobbyData = null;

        // --- Constants ---
        const AVATARS = Array.from({length: 12}, (_, i) => `./avatars/avatar${i + 1}.png`);
        AVATARS.unshift('./avatars/default.png');
        const SHOP_ITEMS = { cardBacks: [{ id: 'card_back_classic', name: 'کلاسیک', price: 0, url: './card_backs/classic.png' }, { id: 'card_back_royal', name: 'سلطنتی', price: 500, url: './card_backs/royal.png' }, { id: 'card_back_persian', name: 'فرش ایرانی', price: 750, url: './card_backs/persian.png' }] };
        const DAILY_REWARD_COINS = 100;
        const SUITS = { Spades: '♠️', Hearts: '♥️', Diamonds: '♦️', Clubs: '♣️' };
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const RANK_VALUES = { '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };

        // --- Utility Functions ---
        function showModal(modalElement) { modalElement.classList.remove('hidden'); }
        function closeModal(modalElement) { modalElement.classList.add('hidden'); }
        function showMessageBox(message, type = 'info') { /* Implementation... */ }
        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            currentActiveScreen.classList.add('page-transition-hidden');
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                newScreen.classList.remove('hidden', 'page-transition-hidden');
                currentActiveScreen = newScreen;
            }, 600);
        }

        // --- Firebase Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            // *** CRITICAL FIX: Using the correct Firestore path from user's original code ***
            if (user) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUserData = { uid: user.uid, ...userDocSnap.data() };
                    const today = new Date().setHours(0, 0, 0, 0);
                    const lastLogin = currentUserData.lastLogin?.toDate().setHours(0, 0, 0, 0) || 0;
                    if (today > lastLogin) {
                        await updateDoc(userDocRef, { coins: increment(DAILY_REWARD_COINS), lastLogin: serverTimestamp() });
                        currentUserData.coins += DAILY_REWARD_COINS;
                        document.getElementById('daily-reward-amount').textContent = DAILY_REWARD_COINS;
                        showModal(dailyRewardModal);
                    }
                } else {
                    const displayName = displayNameInput.value.trim() || user.email.split('@')[0];
                    currentUserData = {
                        uid: user.uid, email: user.email, displayName: displayName,
                        coins: 200, avatarUrl: './avatars/default.png',
                        unlockedCardBacks: ['card_back_classic'], equippedCardBack: 'card_back_classic',
                        createdAt: serverTimestamp(), lastLogin: serverTimestamp()
                    };
                    await setDoc(userDocRef, currentUserData);
                }
                updateUIWithUserData();
                setActiveScreen(mainScreen);
            } else {
                currentUserData = null;
                setActiveScreen(authScreen);
                // Cleanup all listeners
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                if (unsubscribeGameState) unsubscribeGameState();
            }
        });

        function updateUIWithUserData() {
            if (!currentUserData) return;
            headerDisplayName.textContent = currentUserData.displayName;
            headerAvatar.src = currentUserData.avatarUrl;
            headerCoinAmount.textContent = currentUserData.coins;
            profileDisplayName.textContent = currentUserData.displayName;
            profileModalAvatar.src = currentUserData.avatarUrl;
        }

        // --- Game Logic ---
        function createDeck() {
            const deck = [];
            for (const suit of Object.keys(SUITS)) {
                for (const rank of RANKS) {
                    deck.push({ suit, rank });
                }
            }
            return deck;
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        async function initializeGame(lobbyData) {
            const players = Object.keys(lobbyData.players);
            const shuffledDeck = shuffleDeck(createDeck());
            const hands = {};
            players.forEach((uid, index) => {
                hands[uid] = shuffledDeck.slice(index * 13, (index + 1) * 13);
            });

            const dealerIndex = Math.floor(Math.random() * 4);
            const hakemIndex = (dealerIndex + 1) % 4;

            const initialGameState = {
                playerIds: players,
                hands: hands,
                dealer: players[dealerIndex],
                hakem: players[hakemIndex],
                currentTurn: players[hakemIndex],
                trumpSuit: null,
                cardsOnTable: {},
                currentTrickSuit: null,
                team1Score: 0,
                team2Score: 0,
                team1Tricks: 0,
                team2Tricks: 0,
                log: [`بازی شروع شد. ${lobbyData.players[players[dealerIndex]].displayName} حاکم است.`]
            };

            const gameStateRef = doc(db, `global_lobbies/${currentLobbyId}/game_state/current`);
            await setDoc(gameStateRef, initialGameState);
            await updateDoc(doc(db, `global_lobbies/${currentLobbyId}`), { status: 'playing' });
        }

        async function handlePlayCard(card) {
            const gameStateRef = doc(db, `global_lobbies/${currentLobbyId}/game_state/current`);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const gameStateSnap = await transaction.get(gameStateRef);
                    if (!gameStateSnap.exists()) throw "Game state not found!";
                    
                    let gameState = gameStateSnap.data();
                    const myHand = gameState.hands[currentUserData.uid];
                    
                    // Validation
                    if (gameState.currentTurn !== currentUserData.uid) throw "نوبت شما نیست!";
                    
                    const newHand = myHand.filter(c => !(c.rank === card.rank && c.suit === card.suit));
                    gameState.hands[currentUserData.uid] = newHand;
                    gameState.cardsOnTable[currentUserData.uid] = card;
                    
                    if (Object.keys(gameState.cardsOnTable).length === 1) {
                        gameState.currentTrickSuit = card.suit;
                    }

                    const currentPlayerIndex = gameState.playerIds.indexOf(currentUserData.uid);
                    const nextPlayerIndex = (currentPlayerIndex + 1) % 4;
                    gameState.currentTurn = gameState.playerIds[nextPlayerIndex];

                    if (Object.keys(gameState.cardsOnTable).length === 4) {
                        // Evaluate trick after a short delay
                        setTimeout(() => evaluateTrick(currentLobbyId), 1500);
                    }
                    
                    transaction.set(gameStateRef, gameState);
                });
            } catch (error) {
                console.error("Play card transaction failed: ", error);
                showMessageBox(error, 'error');
            }
        }

        async function evaluateTrick(lobbyId) {
            const gameStateRef = doc(db, `global_lobbies/${lobbyId}/game_state/current`);
            const gameStateSnap = await getDoc(gameStateRef);
            if (!gameStateSnap.exists()) return;

            let gameState = gameStateSnap.data();
            const { cardsOnTable, trumpSuit, currentTrickSuit, playerIds } = gameState;
            
            let winningCard = null;
            let winnerId = null;

            for (const uid of playerIds) {
                const card = cardsOnTable[uid];
                if (!card) continue;

                if (!winningCard) {
                    winningCard = card;
                    winnerId = uid;
                    continue;
                }

                if (card.suit === trumpSuit && winningCard.suit !== trumpSuit) {
                    winningCard = card;
                    winnerId = uid;
                } else if (card.suit === winningCard.suit && RANK_VALUES[card.rank] > RANK_VALUES[winningCard.rank]) {
                    winningCard = card;
                    winnerId = uid;
                }
            }

            const winnerTeam = playerIds.indexOf(winnerId) % 2; // 0 for team 1, 1 for team 2
            if (winnerTeam === 0) {
                gameState.team1Tricks++;
            } else {
                gameState.team2Tricks++;
            }
            
            gameState.log.push(`${currentLobbyData.players[winnerId].displayName} دست را برد.`);
            gameState.cardsOnTable = {};
            gameState.currentTrickSuit = null;
            gameState.currentTurn = winnerId;

            // Check if hand is over
            if (gameState.hands[playerIds[0]].length === 0) {
                // Hand over, update scores
                if (gameState.team1Tricks > gameState.team2Tricks) gameState.team1Score += gameState.team1Tricks;
                if (gameState.team2Tricks > gameState.team1Tricks) gameState.team2Score += gameState.team2Tricks;
                
                // Check for game over
                const roundsToWin = currentLobbyData.gameSettings.roundsToWin;
                if (gameState.team1Score >= roundsToWin || gameState.team2Score >= roundsToWin) {
                    gameState.status = 'finished';
                } else {
                    // Start new hand
                    // This logic would be more complex (new dealer, etc.)
                }
            }
            
            await updateDoc(gameStateRef, gameState);
        }

        // --- UI Rendering ---
        function renderGame(gameState) {
            const myUid = currentUserData.uid;
            const myIndex = gameState.playerIds.indexOf(myUid);
            
            // Render my hand
            playerHand.innerHTML = '';
            gameState.hands[myUid].forEach(card => {
                const cardEl = createCardElement(card.rank, card.suit);
                cardEl.addEventListener('click', () => handlePlayCard(card));
                playerHand.appendChild(cardEl);
            });

            // Render table
            for (let i = 0; i < 4; i++) {
                const playerIndex = (myIndex + i) % 4;
                const uid = gameState.playerIds[playerIndex];
                const card = gameState.cardsOnTable[uid];
                const slotId = ['bottom', 'right', 'top', 'left'][i];
                const slotEl = document.getElementById(`table-slot-${slotId}`);
                slotEl.innerHTML = card ? '' : '';
                if(card) slotEl.appendChild(createCardElement(card.rank, card.suit));
            }

            // Update scores and trump
            gameTeam1Score.textContent = gameState.team1Score;
            gameTeam2Score.textContent = gameState.team2Score;
            gameTrumpIcon.textContent = gameState.trumpSuit ? SUITS[gameState.trumpSuit] : '❓';

            // Highlight active player
            document.querySelectorAll('.player-area.active-player').forEach(el => el.classList.remove('active-player'));
            const activePlayerIndex = gameState.playerIds.indexOf(gameState.currentTurn);
            const relativeIndex = (activePlayerIndex - myIndex + 4) % 4;
            const activeAreaId = ['bottom', 'right', 'top', 'left'][relativeIndex];
            document.getElementById(`player-area-${activeAreaId}`).classList.add('active-player');

            // Check for trump selection
            if (!gameState.trumpSuit && gameState.hakem === myUid) {
                showModal(trumpSelectionModal);
            } else {
                closeModal(trumpSelectionModal);
            }
            
            // Check for game over
            if (gameState.status === 'finished') {
                const winner = gameState.team1Score > gameState.team2Score ? "تیم شما" : "تیم حریف";
                document.getElementById('game-over-message').textContent = `${winner} برنده بازی شد!`;
                showModal(gameOverModal);
            }
        }

        function createCardElement(rank, suit) {
            const card = document.createElement('div');
            card.className = 'card';
            const cardFace = document.createElement('div');
            cardFace.className = 'card-face';
            if (suit === 'Hearts' || suit === 'Diamonds') cardFace.classList.add('red');
            cardFace.innerHTML = `<span class="rank">${rank}</span><span class="suit">${SUITS[suit]}</span>`;
            card.appendChild(cardFace);
            return card;
        }

        // --- Listeners Setup ---
        function setupLobbyListener() { /* ... existing implementation ... */ }
        function setupLobbyDetailListener(lobbyId) {
            currentLobbyId = lobbyId;
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // Lobby deleted, go back
                    setActiveScreen(lobbyScreen);
                    return;
                }
                currentLobbyData = docSnap.data();
                if (currentLobbyData.status === 'playing') {
                    setActiveScreen(gameScreen);
                    if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                    unsubscribeGameState = setupGameStateListener(lobbyId);
                } else {
                    // Render lobby detail UI
                }
            });
        }
        function setupGameStateListener(lobbyId) {
            const gameStateRef = doc(db, `global_lobbies/${lobbyId}/game_state/current`);
            return onSnapshot(gameStateRef, (docSnap) => {
                if (docSnap.exists()) {
                    renderGame(docSnap.data());
                }
            });
        }

        // --- Event Listeners ---
        window.onload = () => {
            avatarSelectionGrid.innerHTML = AVATARS.map(url => `<img src="${url}" class="avatar-option" data-url="${url}">`).join('');
        };
        
        // Auth
        loginToggleBtn.addEventListener('click', () => { authMode = 'login'; displayNameField.classList.add('hidden'); submitAuthBtn.textContent = 'ورود'; submitAuthBtn.classList.remove('hidden'); loginToggleBtn.classList.add('hidden'); registerToggleBtn.classList.remove('hidden'); authForm.reset(); });
        registerToggleBtn.addEventListener('click', () => { authMode = 'register'; displayNameField.classList.remove('hidden'); submitAuthBtn.textContent = 'ثبت نام'; submitAuthBtn.classList.remove('hidden'); registerToggleBtn.classList.add('hidden'); loginToggleBtn.classList.remove('hidden'); authForm.reset(); });
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) return;
            try {
                if (authMode === 'login') await signInWithEmailAndPassword(auth, email, password);
                else await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) { console.error(error); }
        });

        // Main Screen & Profile
        menuBtn.addEventListener('click', () => showModal(profileModal));
        profileSummary.addEventListener('click', () => showModal(profileModal));
        closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));
        profileLogoutBtn.addEventListener('click', () => signOut(auth));
        
        // Lobby
        friendlyGameBtn.addEventListener('click', () => { setActiveScreen(lobbyScreen); unsubscribeLobbies = setupLobbyListener(); });
        addIconBtn.addEventListener('click', () => showModal(createLobbyModal));
        closeCreateLobbyModalBtn.addEventListener('click', () => closeModal(createLobbyModal));
        
        startGameBtn.addEventListener('click', () => {
            if (currentUserData.uid === currentLobbyData.hostId) {
                initializeGame(currentLobbyData);
            }
        });

        // Game
        trumpSelectionModal.addEventListener('click', async (e) => {
            if (e.target.matches('.suit-selection-btn')) {
                const suit = e.target.dataset.suit;
                const gameStateRef = doc(db, `global_lobbies/${currentLobbyId}/game_state/current`);
                await updateDoc(gameStateRef, { trumpSuit: suit });
                closeModal(trumpSelectionModal);
            }
        });

        gameOverOkBtn.addEventListener('click', () => {
            closeModal(gameOverModal);
            setActiveScreen(lobbyScreen);
        });

    </script>
</body>
</html>
