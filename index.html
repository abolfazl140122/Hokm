<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lalezar&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%);
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3 {
            font-family: 'Lalezar', cursive;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out;
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%);
            border: 4px solid #DAA520;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            max-height: 90vh;
            overflow-y: hidden;
            overflow-x: hidden;
        }
        .classic-card::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid #FFD700;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .classic-card::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid #FFD700;
            border-right: 5px solid #FFD700;
            border-radius: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        /* Button Base Styles */
        .classic-btn {
            border: 2px solid #DAA520;
            border-radius: 15px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
            color: #FFFFFF;
            padding: 0.875rem 1.5rem;
            font-size: 1.125rem;
            position: relative;
            overflow: hidden;
        }
        .classic-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2);
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
        }

        /* Specific Button Colors */
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }

        /* Input Field Styles */
        input {
            background-color: #202020;
            border: 2px solid #5A5A5A;
            color: #E0E0E0;
            padding: 0.875rem;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        input::placeholder { color: #A0A0A0; }
        input:focus {
            border-color: #DAA520 !important;
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }

        /* Header/Footer specific styles */
        .app-header, .lobby-header, .app-footer, .lobby-footer {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            position: fixed; left: 0; right: 0; z-index: 40;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
        }
        .app-header, .lobby-header { top: 0; border-bottom: 3px solid #FFD700; height: 70px; justify-content: space-between; }
        .app-footer, .lobby-footer { bottom: 0; border-top: 3px solid #FFD700; height: 90px; justify-content: space-around; }

        .lobby-header { justify-content: center; }
        .lobby-header .search-container { display: flex; flex-grow: 1; max-width: 600px; margin: 0 auto; align-items: center; background-color: #303030; border-radius: 15px; border: 2px solid #5A5A5A; padding: 0.5rem 1rem; }
        .lobby-header .search-container input { flex-grow: 1; background-color: transparent; border: none; padding: 0.25rem 0.5rem; outline: none; text-align: right; }

        /* Main content area padding */
        .main-content-area {
            padding-top: 70px;
            padding-bottom: 90px;
            flex-grow: 1;
            overflow-y: auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }

        /* === GAME SCREEN STYLES (COMPLETELY REDESIGNED) === */
        #game-screen {
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        #game-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, rgba(20, 20, 20, 0.8), rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.8));
            border-bottom: 3px solid #DAA520;
            box-shadow: 0 6px 15px rgba(0,0,0,0.5);
            padding: 0.5rem 1.5rem;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        #game-team-scores {
            font-family: 'Lalezar', cursive;
            font-size: 1.25rem;
        }

        #game-hokm-indicator {
            font-family: 'Lalezar', cursive;
            font-size: 1.5rem;
        }

        #hokm-suit-icon {
            font-size: 2.5rem;
            text-shadow: 0 0 10px #FFF, 0 0 20px #FFD700;
        }

        #game-table {
            width: 95vw;
            height: 85vh;
            max-width: 1400px;
            max-height: 900px;
            background: 
                radial-gradient(ellipse at center, rgba(0, 77, 0, 0.9) 0%, rgba(0, 41, 0, 0.95) 100%),
                url('https://www.transparenttextures.com/patterns/felt.png');
            border: 20px solid transparent;
            border-image: linear-gradient(145deg, #8B4513, #4A2B00) 1;
            box-shadow: 
                inset 0 0 25px rgba(0,0,0,0.7),
                0 20px 50px rgba(0,0,0,0.6);
            border-radius: 120px;
            display: grid;
            grid-template-areas:
                ".  top     ."
                "left  play-area  right"
                ".  bottom  .";
            grid-template-rows: auto 1fr auto;
            grid-template-columns: auto 1fr auto;
            padding: 2rem;
            gap: 1.5rem;
        }

        #play-area {
            grid-area: play-area;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .player-slot {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(218, 165, 32, 0.3);
            border-radius: 1rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4);
            transition: all 0.4s ease-in-out;
            min-width: 150px;
            min-height: 120px;
        }
        
        #player-slot-top { grid-area: top; }
        #player-slot-bottom { grid-area: bottom; }
        #player-slot-left { grid-area: left; }
        #player-slot-right { grid-area: right; }

        .game-player-avatar {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.5rem;
            border: 2px solid rgba(218, 165, 32, 0.5);
        }
        .game-player-avatar svg {
            width: 30px;
            height: 30px;
            color: #DAA520;
        }
        .game-player-name {
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #FFFFFF;
            text-shadow: 1px 1px 2px #000;
        }
        .game-player-status {
            font-size: 0.9rem;
            font-weight: bold;
            color: #FFD700;
            background-color: rgba(0,0,0,0.7);
            padding: 2px 8px;
            border-radius: 8px;
            margin-top: 4px;
        }

        .player-slot.active-turn {
            transform: scale(1.08);
            background: rgba(40, 30, 0, 0.7);
            border-color: #FFD700;
            box-shadow: 
                inset 0 0 15px rgba(0,0,0,0.5),
                0 0 25px #FFD700,
                0 0 10px #FFF;
        }

        @media (max-width: 768px) {
            #game-table {
                border-radius: 60px;
                border-width: 10px;
                padding: 1rem;
                gap: 0.5rem;
            }
            .player-slot {
                min-width: 100px;
                min-height: 90px;
                padding: 0.5rem;
            }
            .game-player-avatar { width: 35px; height: 35px; }
            .game-player-name { font-size: 0.9rem; }
            .game-player-status { font-size: 0.7rem; }
            #game-header { height: 60px; padding: 0.5rem 1rem; }
            #game-team-scores, #game-hokm-indicator { font-size: 1rem; }
            #hokm-suit-icon { font-size: 2rem; }
        }

    </style>
</head>
<body>

    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <h2 class="text-2xl">در حال بارگذاری...</h2>
        </div>

        <!-- 2. Authentication Screen -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
             <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div><input type="email" id="email" placeholder="ایمیل شما" class="w-full" required></div>
                    <div id="display-name-field" class="hidden"><input type="text" id="display-name" placeholder="نام نمایشی (در بازی)" class="w-full"></div>
                    <div><input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="w-full" required></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl">ورود</button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl">ثبت نام</button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic text-xl hidden">ادامه</button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="app-header">
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                    </div>
                </div>
                <button id="menu-btn" class="text-white text-3xl p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </header>
            <div class="main-content-area justify-center">
                <h1 class="text-4xl mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>
            <footer class="app-footer">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic text-lg w-1/2 mx-2">بازی دوستانه</button>
                <button id="rated-game-btn" class="classic-btn btn-brown-classic text-lg w-1/2 mx-2">بازی امتیازی</button>
            </footer>
        </div>

        <!-- 4. Lobby Screen -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></button>
                    <input type="text" id="lobby-search-input" placeholder="جستجوی لابی..." class="flex-grow">
                </div>
            </header>
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="w-full max-w-2xl mx-auto">
                    <h2 class="text-2xl mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full"><p class="text-gray-400">در حال بارگذاری لابی‌ها...</p></div>
                </div>
            </div>
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="classic-btn btn-green-classic">ایجاد لابی</button>
                <button id="refresh-lobbies-btn" class="classic-btn btn-blue-classic">بروزرسانی</button>
            </footer>
        </div>

        <!-- 5. Lobby Detail Screen (placeholder, functionality moved to Game Screen) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
             <div class="main-content-area justify-center items-center">
                 <h2 class="text-3xl" id="detail-lobby-name">...</h2>
                 <p class="text-lg" id="detail-player-count">بازیکنان: ...</p>
                 <div id="player-list-container" class="my-4"></div>
                 <button id="start-game-btn" class="classic-btn btn-green-classic" disabled>شروع بازی</button>
                 <button id="leave-lobby-btn" class="classic-btn btn-red-classic mt-4">ترک لابی</button>
             </div>
        </div>

        <!-- 9. Game Screen (REDESIGNED HTML STRUCTURE) -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <div id="game-header">
                <div id="game-team-scores" class="text-white">
                    <span>تیم ما: <span id="our-team-score" class="text-xl text-green-300">0</span></span> |
                    <span>تیم حریف: <span id="their-team-score" class="text-xl text-red-300">0</span></span>
                </div>
                <div id="game-hokm-indicator" class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-white">حکم:</span>
                    <span id="hokm-suit-icon">❓</span>
                </div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی</button>
            </div>
            <div id="game-table">
                <div id="play-area"></div>
                <div id="player-slot-top" class="player-slot">
                    <div class="game-player-avatar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <span class="game-player-name">یار شما</span>
                    <span class="game-player-status hidden"></span>
                </div>
                <div id="player-slot-left" class="player-slot">
                    <div class="game-player-avatar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <span class="game-player-name">حریف ۱</span>
                    <span class="game-player-status hidden"></span>
                </div>
                <div id="player-slot-right" class="player-slot">
                    <div class="game-player-avatar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <span class="game-player-name">حریف ۲</span>
                    <span class="game-player-status hidden"></span>
                </div>
                <div id="player-slot-bottom" class="player-slot">
                    <div class="game-player-avatar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <span class="game-player-name">شما</span>
                    <span class="game-player-status hidden"></span>
                </div>
            </div>
        </div>

        <!-- All Modals (Profile, Create Lobby, etc.) -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50">
            <div class="classic-card p-8 w-11/12 max-w-md text-center">
                 <h2 class="text-3xl mb-6">پروفایل کاربری</h2>
                 <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                 <button id="profile-logout-btn" class="w-full classic-btn btn-red-classic mt-6">خروج از حساب</button>
                 <button id="close-profile-modal-btn" class="classic-btn btn-gray-classic mt-2">بستن</button>
            </div>
        </div>
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50">
            <div class="classic-card p-8 w-11/12 max-w-md text-center">
                 <h2 class="text-3xl mb-6">ساخت لابی جدید</h2>
                 <form id="create-lobby-form" class="space-y-5">
                    <input type="text" id="new-lobby-name-input" placeholder="نام لابی شما" class="w-full" required>
                    <button type="submit" class="w-full classic-btn btn-green-classic">ساخت لابی</button>
                 </form>
                 <button id="close-create-lobby-modal-btn" class="classic-btn btn-gray-classic mt-2">انصراف</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, onSnapshot, updateDoc, deleteDoc, where, getDocs, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const gameScreen = document.getElementById('game-screen');

        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box');

        const headerDisplayName = document.getElementById('header-display-name');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn');

        const menuBtn = document.getElementById('menu-btn');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        const addIconBtn = document.getElementById('add-icon-btn');
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn');
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const playerListContainer = document.getElementById('player-list-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        
        // Game Screen Elements
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const hokmSuitIcon = document.getElementById('hokm-suit-icon');
        const ourTeamScoreEl = document.getElementById('our-team-score');
        const theirTeamScoreEl = document.getElementById('their-team-score');
        const playerSlots = {
            bottom: document.getElementById('player-slot-bottom'),
            left: document.getElementById('player-slot-left'),
            top: document.getElementById('player-slot-top'),
            right: document.getElementById('player-slot-right'),
        };

        // State variables
        let currentActiveScreen = loadingScreen;
        let currentUserData = null;
        let unsubscribeLobbies = null;
        let unsubscribeLobbyDetail = null;
        let unsubscribeGame = null;
        let currentLobbyId = null;

        // --- Utility Functions ---
        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }

            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                newScreen.classList.remove('hidden');
                newScreen.classList.add('page-transition-visible');
                currentActiveScreen = newScreen;
            }, 600);
        }

        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            messageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500', 'text-white');
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        // --- Auth Functions ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, `users/${user.uid}`);
                const userDocSnap = await getDoc(userDocRef);
                currentUserData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: userDocSnap.exists() ? userDocSnap.data().displayName : 'کاربر ناشناس'
                };
                headerDisplayName.textContent = currentUserData.displayName;
                profileDisplayName.textContent = currentUserData.displayName;
                setActiveScreen(mainScreen);
            } else {
                currentUserData = null;
                setActiveScreen(authScreen);
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const displayName = displayNameInput.value;
            const isRegister = !displayNameField.classList.contains('hidden');

            try {
                if (isRegister) {
                    if (!displayName) { showMessage("لطفا نام نمایشی را وارد کنید."); return; }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { displayName: displayName, email: email });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                showMessage(error.message);
            }
        });
        
        loginToggleBtn.addEventListener('click', () => {
            displayNameField.classList.add('hidden');
            submitAuthBtn.textContent = 'ورود';
            submitAuthBtn.classList.remove('hidden');
            loginToggleBtn.classList.add('hidden');
            registerToggleBtn.classList.remove('hidden');
        });

        registerToggleBtn.addEventListener('click', () => {
            displayNameField.classList.remove('hidden');
            submitAuthBtn.textContent = 'ثبت نام';
            submitAuthBtn.classList.remove('hidden');
            registerToggleBtn.classList.add('hidden');
            loginToggleBtn.classList.remove('hidden');
        });

        profileLogoutBtn.addEventListener('click', () => signOut(auth));

        // --- Navigation and Modal Listeners ---
        friendlyGameBtn.addEventListener('click', () => {
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener();
        });
        backToMainBtn.addEventListener('click', () => {
            setActiveScreen(mainScreen);
            if (unsubscribeLobbies) unsubscribeLobbies();
        });
        menuBtn.addEventListener('click', () => profileModal.classList.remove('hidden'));
        closeProfileModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));
        addIconBtn.addEventListener('click', () => createLobbyModal.classList.remove('hidden'));
        closeCreateLobbyModalBtn.addEventListener('click', () => createLobbyModal.classList.add('hidden'));

        // --- Lobby Functions ---
        function setupLobbyListener() {
            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بارگذاری...</p>';
            const q = query(collection(db, `lobbies`), where("status", "==", "waiting"));
            return onSnapshot(q, (snapshot) => {
                lobbiesList.innerHTML = '';
                if (snapshot.empty) {
                    lobbiesList.innerHTML = '<p class="text-gray-400">هیچ لابی فعالی وجود ندارد.</p>';
                }
                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    const playerCount = Object.keys(lobby.players || {}).length;
                    const lobbyItem = document.createElement('div');
                    lobbyItem.className = 'p-4 bg-gray-800 rounded-lg flex justify-between items-center';
                    lobbyItem.innerHTML = `
                        <div>
                            <h3 class="text-xl">${lobby.name}</h3>
                            <p>${playerCount}/4 بازیکن</p>
                        </div>
                        <button data-lobby-id="${lobby.id}" class="join-lobby-btn classic-btn btn-blue-classic">ورود</button>
                    `;
                    lobbiesList.appendChild(lobbyItem);
                });
                document.querySelectorAll('.join-lobby-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => joinLobby(e.target.dataset.lobbyId));
                });
            });
        }
        
        refreshLobbiesBtn.addEventListener('click', () => {
             if (unsubscribeLobbies) unsubscribeLobbies();
             unsubscribeLobbies = setupLobbyListener();
        });

        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lobbyName = newLobbyNameInput.value.trim();
            if (!lobbyName || !currentUserData) return;
            try {
                const newLobbyRef = await addDoc(collection(db, 'lobbies'), {
                    name: lobbyName,
                    hostId: currentUserData.uid,
                    status: "waiting",
                    players: { [currentUserData.uid]: currentUserData.displayName },
                    createdAt: serverTimestamp()
                });
                closeCreateLobbyModal();
                joinLobby(newLobbyRef.id);
            } catch (error) { showMessage("خطا در ساخت لابی."); }
        });
        
        async function joinLobby(lobbyId) {
            if (!currentUserData) return;
            currentLobbyId = lobbyId;
            const lobbyRef = doc(db, 'lobbies', lobbyId);
            await updateDoc(lobbyRef, {
                [`players.${currentUserData.uid}`]: currentUserData.displayName
            });
            setActiveScreen(lobbyDetailScreen);
            unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
        }

        function setupLobbyDetailListener(lobbyId) {
            const lobbyRef = doc(db, 'lobbies', lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showMessage("این لابی بسته شد.", "info");
                    setActiveScreen(lobbyScreen);
                    return;
                }
                const lobbyData = docSnap.data();
                if(lobbyData.status === 'playing' && lobbyData.gameState){
                     setActiveScreen(gameScreen);
                     unsubscribeGame = setupGameListener(lobbyId);
                     return;
                }
                
                detailLobbyName.textContent = lobbyData.name;
                const players = lobbyData.players || {};
                const playerCount = Object.keys(players).length;
                detailPlayerCount.textContent = `بازیکنان: ${playerCount}/4`;
                playerListContainer.innerHTML = Object.values(players).map(name => `<p>${name}</p>`).join('');
                startGameBtn.disabled = playerCount !== 4;
            });
        }

        leaveLobbyBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !currentUserData) return;
            const lobbyRef = doc(db, 'lobbies', currentLobbyId);
            await updateDoc(lobbyRef, {
                [`players.${currentUserData.uid}`]: deleteField()
            });
            setActiveScreen(lobbyScreen);
        });

        // --- Game Functions ---
        startGameBtn.addEventListener('click', async () => {
            if (!currentLobbyId) return;
            const lobbyRef = doc(db, 'lobbies', currentLobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if(lobbySnap.exists()){
                await initializeGameInFirestore(currentLobbyId, lobbySnap.data());
            }
        });
        
        async function initializeGameInFirestore(lobbyId, lobbyData) {
            const playerUIDs = Object.keys(lobbyData.players);
            const hakem = lobbyData.hostId;
            const initialGameState = {
                players: playerUIDs,
                playerNames: lobbyData.players,
                hakem: hakem,
                currentTurn: hakem,
                hokmSuit: null,
                scores: { team1: 0, team2: 0 },
            };
            await updateDoc(doc(db, 'lobbies', lobbyId), {
                status: "playing",
                gameState: initialGameState
            });
        }

        function setupGameListener(lobbyId) {
            return onSnapshot(doc(db, 'lobbies', lobbyId), (docSnap) => {
                if (docSnap.exists() && docSnap.data().gameState) {
                    renderGameScreen(docSnap.data());
                } else {
                    showMessage("بازی پایان یافت.", "info");
                    setActiveScreen(lobbyScreen);
                }
            });
        }
        
        function renderGameScreen(lobbyData) {
            const gameState = lobbyData.gameState;
            const myUid = currentUserData.uid;
            
            const myIndex = gameState.players.indexOf(myUid);
            if (myIndex === -1) {
                leaveGameBtn.click();
                return;
            }

            const positions = ['bottom', 'left', 'top', 'right'];
            const slotMap = {};
            gameState.players.forEach((uid, index) => {
                const relativeIndex = (index - myIndex + 4) % 4;
                slotMap[uid] = positions[relativeIndex];
            });

            Object.values(playerSlots).forEach(slot => slot.classList.remove('active-turn'));

            for (const uid in slotMap) {
                const slotName = slotMap[uid];
                const slotElement = playerSlots[slotName];
                
                const nameEl = slotElement.querySelector('.game-player-name');
                nameEl.textContent = gameState.playerNames[uid];

                const statusEl = slotElement.querySelector('.game-player-status');
                if (uid === gameState.hakem) {
                    statusEl.textContent = 'حاکم';
                    statusEl.classList.remove('hidden');
                } else {
                    statusEl.classList.add('hidden');
                }

                if (uid === gameState.currentTurn) {
                    slotElement.classList.add('active-turn');
                }
            }

            ourTeamScoreEl.textContent = gameState.scores.team1;
            theirTeamScoreEl.textContent = gameState.scores.team2;

            const suitMap = { 'S': '♠', 'H': '♥', 'D': '♦', 'C': '♣' };
            hokmSuitIcon.textContent = gameState.hokmSuit ? suitMap[gameState.hokmSuit] : '❓';
        }

        leaveGameBtn.addEventListener('click', async () => {
             if (!currentLobbyId) return;
             await deleteDoc(doc(db, 'lobbies', currentLobbyId));
             setActiveScreen(lobbyScreen);
        });

    </script>
</body>
</html>