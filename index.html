<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی متنی هوش مصنوعی و انسان</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look & New Themes -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&family=Share+Tech+Mono&family=Orbitron:wght@400..900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
            transition: background-color 0.8s ease-in-out, color 0.8s ease-in-out; /* Smooth overall transition */
        }

        /* Base transitions for elements that change color/background */
        .classic-card,
        .classic-btn,
        input, select,
        .app-header, .lobby-header,
        .app-footer, .lobby-footer,
        .lobby-item,
        .lobby-chat-container,
        .chat-message,
        .game-player-pod,
        .voting-btn,
        .lobby-type-btn {
            transition: background 0.8s ease-in-out, background-color 0.8s ease-in-out,
                        color 0.8s ease-in-out, border-color 0.8s ease-in-out,
                        box-shadow 0.8s ease-in-out, transform 0.3s ease; /* Keep transform faster */
        }

        /* ================================================= */
        /* === START: NEW ANIMATED LOADING SCREEN STYLES === */
        /* ================================================= */

        #loading-screen {
            background-color: #050510; /* A very dark blue, almost black */
            overflow: hidden; /* Important for animations */
        }

        .loading-screen-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #binary-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: 'Share Tech Mono', monospace;
            color: rgba(0, 255, 13, 0.2); /* Faint green */
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            z-index: 1;
            user-select: none;
        }

        .magnifying-glass {
            position: absolute;
            z-index: 3;
            animation: magnify-roam 15s infinite alternate ease-in-out;
        }

        .glass-lens {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 15px solid #888;
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5), inset 0 0 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        .glass-lens .icon-human,
        .glass-lens .icon-ai {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            color: #00FF85; /* Bright green scan color */
            animation-duration: 6s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            opacity: 0;
        }

        .glass-lens .icon-human {
            animation-name: fade-icons-A;
        }

        .glass-lens .icon-ai {
            animation-name: fade-icons-B;
        }
        
        .glass-handle {
            width: 30px;
            height: 100px;
            background: linear-gradient(#666, #333);
            position: absolute;
            bottom: -60px;
            right: -60px;
            transform: rotate(-45deg);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
        }

        .loading-text-container {
            z-index: 2;
            text-align: center;
        }

        #loading-main-text {
            font-family: 'Share Tech Mono', monospace;
            font-size: 2.5rem;
            color: #DAA520; /* Gold to match classic theme */
            text-shadow: 0 0 10px #FFD700;
            border-right: .15em solid #FFD700; /* Blinking cursor */
            white-space: nowrap;
            overflow: hidden;
            animation:
                typing 3s steps(30, end) infinite alternate,
                blink-caret .75s step-end infinite;
            margin: 0 auto;
            letter-spacing: .15em;
        }

        #loading-sub-text {
            font-family: 'Merriweather', serif;
            color: #E0E0E0;
            font-size: 1.2rem;
            margin-top: 1rem;
            opacity: 0;
            animation: fade-in-slow 4s forwards;
            animation-delay: 1s;
        }
        
        /* Typing animation */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        /* Cursor blink animation */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #FFD700; }
        }

        /* Magnifying glass movement */
        @keyframes magnify-roam {
            0% { top: 20%; left: 15%; transform: rotate(0deg); }
            25% { top: 50%; left: 70%; transform: rotate(20deg); }
            50% { top: 60%; left: 25%; transform: rotate(-10deg); }
            75% { top: 30%; left: 80%; transform: rotate(5deg); }
            100% { top: 20%; left: 15%; transform: rotate(0deg); }
        }

        /* Icon cross-fade animations */
        @keyframes fade-icons-A {
            0%, 45% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
        @keyframes fade-icons-B {
            0%, 50% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            55%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* Subtext fade-in */
        @keyframes fade-in-slow {
            to { opacity: 0.8; }
        }

        /* Hide the old spinner and text as they are no longer used */
        body .spinner, 
        body .loading-text {
            display: none;
        }

        /* =============================================== */
        /* === END: NEW ANIMATED LOADING SCREEN STYLES === */
        /* =============================================== */


        /* === THEME: CLASSIC (Existing styles moved under this class) === */
        body.theme-classic {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        body.theme-classic h1,
        body.theme-classic h2 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        body.theme-classic p, 
        body.theme-classic span {
            color: #E0E0E0; /* Default text color */
        }
        
        body.theme-classic .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod border */
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
        }
        body.theme-classic .classic-card::before,
        body.theme-classic .classic-card::after {
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        body.theme-classic .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
            color: #FFFFFF;
        }
        body.theme-classic .classic-btn:hover {
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2);
        }

        body.theme-classic .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        body.theme-classic .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        body.theme-classic .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        body.theme-classic .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        body.theme-classic .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        body.theme-classic .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        body.theme-classic .btn-gold-classic { background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); border: none; }
        body.theme-classic .btn-gold-classic:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3); }


        body.theme-classic input,
        body.theme-classic select {
            background-color: #202020;
            border: 2px solid #5A5A5A;
            color: #E0E0E0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        body.theme-classic input::placeholder { color: #A0A0A0; }
        body.theme-classic input:focus,
        body.theme-classic select:focus {
            border-color: #DAA520 !important;
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }

        body.theme-classic .app-header,
        body.theme-classic .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-bottom: 3px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
        }
        body.theme-classic #header-user-coins-container {
            background-color: rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: #FFD700; /* Coin text color */
        }
        body.theme-classic .lobby-header .search-container {
            background-color: #303030;
            border: 2px solid #5A5A5A;
        }
        body.theme-classic .lobby-header .search-container svg { color: #DAA520; }


        body.theme-classic .app-footer,
        body.theme-classic .lobby-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-top: 3px solid #FFD700;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
        }
        body.theme-classic .lobby-footer .icon-btn { color: #FFD700; }
        body.theme-classic .lobby-footer .games-running-text { color: #E0E0E0; }

        body.theme-classic .main-content-area {
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }
        body.theme-classic .main-content-area h1 { color: #FFD700; }
        body.theme-classic .main-content-area p { color: #C0C0C0; }

        body.theme-classic .lobby-item {
            background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%);
            border: 2px solid #DAA520;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1);
        }
        body.theme-classic .lobby-item:hover {
            box-shadow: 0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2);
        }
        body.theme-classic .lobby-item h3 { color: #FFD700; }
        body.theme-classic .lobby-item p { color: #C0C0C0; }

        body.theme-classic .lobby-detail-screen-full {
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }
        body.theme-classic .lobby-detail-content {
            background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%);
            border: 3px solid #DAA520;
            box-shadow: 0 10px 20px rgba(0,0,0,0.7);
        }

        body.theme-classic .profile-modal-content h2,
        body.theme-classic .custom-confirm-modal h2,
        body.theme-classic .create-lobby-modal h2,
        body.theme-classic .kick-player-confirm-modal h2,
        body.theme-classic .kicked-players-list-modal h2,
        body.theme-classic .enter-password-modal h2 {
            color: #FFD700;
        }

        body.theme-classic .profile-modal-content p,
        body.theme-classic .create-lobby-modal label,
        body.theme-classic .create-lobby-modal h3,
        body.theme-classic .pending-lobby-names-list p,
        body.theme-classic .approved-lobby-names-management-list p,
        body.theme-classic .custom-confirm-modal p,
        body.theme-classic .kick-player-confirm-modal p,
        body.theme-classic .kicked-message-modal p,
        body.theme-classic .kicked-players-list-modal p,
        body.theme-classic .enter-password-modal p {
            color: #E0E0E0;
        }
        body.theme-classic .lobby-proposal-message.text-red-400 {
            color: #FF6347; /* Ensure good visibility for error messages too */
        }
        body.theme-classic .profile-modal-content #profile-uid,
        body.theme-classic .pending-lobby-names-list .text-sm,
        body.theme-classic .approved-lobby-names-management-list .text-sm {
            color: #A0A0A0; /* Darker gray for UID and secondary info */
        }
        body.theme-classic .kicked-message-modal h2 {
            color: #CD5C5C; /* Red for kicked message */
        }

        body.theme-classic .lobby-sidebar {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid #444;
        }
        body.theme-classic .player-list-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
        }
        body.theme-classic .player-list-item.is-host { border-color: #FFD700; }
        body.theme-classic .player-list-item .player-name { color: #E0E0E0; }
        body.theme-classic .player-list-item .host-label { color: #FFD700; }
        body.theme-classic .kick-player-btn { border: 1px solid #B22222; color: #B22222; }
        body.theme-classic .kick-player-btn:hover { background: #B22222; color: white; }

        body.theme-classic .lobby-chat-container {
            background-color: rgba(0,0,0,0.4);
            border: 2px solid #5A5A5A;
        }
        body.theme-classic .chat-message { background-color: #333; }
        body.theme-classic .chat-message.current-user { background-color: #4682B4; }
        body.theme-classic .chat-message .sender-name { color: #FFD700; }
        body.theme-classic .chat-message .message-text-deleted { color: #999; }
        body.theme-classic .delete-message-btn { color: #aaa; }
        body.theme-classic .delete-message-btn:hover { color: #ff6b6b; }

        body.theme-classic .start-game-btn { background: linear-gradient(145deg, #228B22 0%, #006400 100%); border: 2px solid #DAA520; }

        body.theme-classic .lobby-sidebar::-webkit-scrollbar-track,
        body.theme-classic #player-list-container::-webkit-scrollbar-track,
        body.theme-classic .lobby-chat-messages::-webkit-scrollbar-track,
        body.theme-classic .custom-scrollbar::-webkit-scrollbar-track { background: #202020; }
        body.theme-classic .lobby-sidebar::-webkit-scrollbar-thumb,
        body.theme-classic #player-list-container::-webkit-scrollbar-thumb,
        body.theme-classic .lobby-chat-messages::-webkit-scrollbar-thumb,
        body.theme-classic .custom-scrollbar::-webkit-scrollbar-thumb { background: #DAA520; }
        body.theme-classic .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        body.theme-classic #player-list-container::-webkit-scrollbar-thumb:hover,
        body.theme-classic .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        body.theme-classic .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #FFD700; }

        body.theme-classic .lobby-type-btn { border: 2px solid #DAA520; background-color: transparent; color: #DAA520; }
        body.theme-classic .lobby-type-btn.active { background-color: #DAA520; color: #1A1A1A; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        body.theme-classic .lobby-lock-icon { color: #FFD700; }

        body.theme-classic .game-player-pod {
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        body.theme-classic .game-player-pod.is-ai { background-color: rgba(255, 99, 71, 0.1); border-color: #FF6347; }
        body.theme-classic .game-player-pod.is-human { background-color: rgba(100, 149, 237, 0.1); border-color: #6495ED; }
        body.theme-classic .game-player-pod.current-active-player { border-color: #FFD700; box-shadow: 0 0 15px rgba(255,215,0,0.7); }
        body.theme-classic .game-player-pod .player-name { color: #E0E0E0; }
        body.theme-classic .game-player-pod .player-role { color: #DAA520; }
        body.theme-classic .game-player-pod .player-status { color: #C0C0C0; }

        body.theme-classic .voting-btn { border: 3px solid #FFD700; }
        body.theme-classic .voting-btn.ai-vote { background: linear-gradient(145deg, #E24B4B 0%, #B22222 100%); color: white; }
        body.theme-classic .voting-btn.human-vote { background: linear-gradient(145deg, #4BBEE2 0%, #2A52BE 100%); color: white; }

        body.theme-classic .coin-icon { fill: #FFD700; }

        /* === NEW THEME: CYBERPUNK === */
        body.theme-cyberpunk {
            background: linear-gradient(to bottom right, #0F0F1A, #1A0F1A);
            color: #00FFFF; /* Cyan */
            font-family: 'Share Tech Mono', monospace; /* More techy font */
        }
        body.theme-cyberpunk h1,
        body.theme-cyberpunk h2 {
            font-family: 'Orbitron', sans-serif; /* Futuristic heading */
            color: #FF00FF; /* Magenta */
            text-shadow: 0 0 5px #00FFFF, 0 0 10px #FF00FF;
        }
        body.theme-cyberpunk p,
        body.theme-cyberpunk span {
            color: #00FFFF; /* Default text color */
        }
        
        /* Cyberpunk loading screen adjustments */
        body.theme-cyberpunk #loading-screen { background-color: #0F0F1A; }
        body.theme-cyberpunk #binary-background { color: rgba(255, 0, 255, 0.2); }
        body.theme-cyberpunk #loading-main-text { color: #00FFFF; text-shadow: 0 0 10px #00FFFF; border-color: #00FFFF; }
        body.theme-cyberpunk #loading-sub-text { color: #FF00FF; }
        body.theme-cyberpunk .glass-lens { border-color: #FF00FF; box-shadow: 0 0 30px rgba(0, 255, 255, 0.5), inset 0 0 15px rgba(0, 0, 0, 0.5); }
        body.theme-cyberpunk .glass-handle { background: linear-gradient(#3A003A, #1A001A); }
        body.theme-cyberpunk .glass-lens .icon-human, body.theme-cyberpunk .glass-lens .icon-ai { color: #FF00FF; }


        body.theme-cyberpunk .classic-card {
            background: linear-gradient(145deg, #2A002A 0%, #4B004B 100%);
            border: 3px solid #FF00FF;
            box-shadow: 0 0 20px rgba(255,0,255,0.7), inset 0 0 10px rgba(0,255,255,0.5);
        }
        body.theme-cyberpunk .classic-card::before,
        body.theme-cyberpunk .classic-card::after {
            border-color: #00FFFF;
            box-shadow: 0 0 10px rgba(0,255,255,0.7);
        }
        body.theme-cyberpunk .classic-btn {
            border: 2px solid #00FFFF;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 0 5px #FF00FF;
            color: #FFF;
        }
        body.theme-cyberpunk .classic-btn:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.7), inset 0 0 8px #FF00FF;
        }
        body.theme-cyberpunk .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); } /* Keep same or adjust */
        body.theme-cyberpunk .btn-blue-classic { background: linear-gradient(145deg, #00BFFF 0%, #008080 100%); } /* Deep Sky Blue to Teal */
        body.theme-cyberpunk .btn-green-classic { background: linear-gradient(145deg, #39FF14 0%, #228B22 100%); } /* Neon Green */
        body.theme-cyberpunk .btn-red-classic { background: linear-gradient(145deg, #FF0077 0%, #CC0055 100%); } /* Hot Pink */
        body.theme-cyberpunk .btn-gray-classic { background: linear-gradient(145deg, #3A3A3A 0%, #202020 100%); }
        body.theme-cyberpunk .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        body.theme-cyberpunk .btn-gold-classic { background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); } /* Can still be gold */

        body.theme-cyberpunk input,
        body.theme-cyberpunk select {
            background-color: #05050A;
            border: 2px solid #00FFFF;
            color: #00FFFF;
            box-shadow: inset 0 0 5px #FF00FF;
        }
        body.theme-cyberpunk input::placeholder { color: #808080; }
        body.theme-cyberpunk input:focus,
        body.theme-cyberpunk select:focus {
            border-color: #FF00FF !important;
            box-shadow: 0 0 0 4px rgba(0,255,255,0.5) !important, inset 0 0 5px #FF00FF !important;
        }

        body.theme-cyberpunk .app-header,
        body.theme-cyberpunk .lobby-header {
            background: linear-gradient(to right, #001A1A, #003333);
            border-bottom: 3px solid #00FFFF;
            box-shadow: 0 5px 15px rgba(0,255,255,0.5);
        }
        body.theme-cyberpunk #header-user-coins-container {
            background-color: rgba(0,255,255,0.1);
            box-shadow: 0 2px 5px rgba(0,255,255,0.3);
            color: #FF00FF; /* Coin text color */
        }
        body.theme-cyberpunk .lobby-header .search-container {
            background-color: #10101A;
            border: 2px solid #00FFFF;
        }
        body.theme-cyberpunk .lobby-header .search-container svg { color: #FF00FF; }

        body.theme-cyberpunk .app-footer,
        body.theme-cyberpunk .lobby-footer {
            background: linear-gradient(to left, #001A1A, #003333);
            border-top: 3px solid #00FFFF;
            box-shadow: 0 -5px 15px rgba(0,255,255,0.5);
        }
        body.theme-cyberpunk .lobby-footer .icon-btn { color: #00FFFF; }
        body.theme-cyberpunk .lobby-footer .games-running-text { color: #FF00FF; }

        body.theme-cyberpunk .main-content-area {
            background: linear-gradient(180deg, #100510 0%, #050005 100%);
        }
        body.theme-cyberpunk .main-content-area h1 { color: #FF00FF; }
        body.theme-cyberpunk .main-content-area p { color: #00FFFF; }

        body.theme-cyberpunk .lobby-item {
            background: linear-gradient(145deg, #1A001A 0%, #2A002A 100%);
            border: 2px solid #FF00FF;
            box-shadow: 0 5px 10px rgba(0,255,255,0.3), inset 0 0 8px rgba(255,0,255,0.3);
        }
        body.theme-cyberpunk .lobby-item:hover {
            box-shadow: 0 8px 15px rgba(0,255,255,0.5), inset 0 0 10px rgba(255,0,255,0.5);
        }
        body.theme-cyberpunk .lobby-item h3 { color: #00FFFF; }
        body.theme-cyberpunk .lobby-item p { color: #C0C0C0; }

        body.theme-cyberpunk .lobby-detail-screen-full {
            background: linear-gradient(180deg, #100510 0%, #050005 100%);
        }
        body.theme-cyberpunk .lobby-detail-content {
            background: linear-gradient(145deg, #1A001A 0%, #0D000D 100%);
            border: 3px solid #00FFFF;
            box-shadow: 0 8px 16px rgba(0,255,255,0.7);
        }

        body.theme-cyberpunk .profile-modal-content h2,
        body.theme-cyberpunk .custom-confirm-modal h2,
        body.theme-cyberpunk .create-lobby-modal h2,
        body.theme-cyberpunk .kick-player-confirm-modal h2,
        body.theme-cyberpunk .kicked-players-list-modal h2,
        body.theme-cyberpunk .enter-password-modal h2 {
            color: #FF00FF;
        }
        body.theme-cyberpunk .profile-modal-content p,
        body.theme-cyberpunk .create-lobby-modal label,
        body.theme-cyberpunk .create-lobby-modal h3,
        body.theme-cyberpunk .pending-lobby-names-list p,
        body.theme-cyberpunk .approved-lobby-names-management-list p,
        body.theme-cyberpunk .custom-confirm-modal p,
        body.theme-cyberpunk .kick-player-confirm-modal p,
        body.theme-cyberpunk .kicked-message-modal p,
        body.theme-cyberpunk .kicked-players-list-modal p,
        body.theme-cyberpunk .enter-password-modal p {
            color: #00FFFF;
        }
        body.theme-cyberpunk .lobby-proposal-message.text-red-400 {
            color: #FF0077;
        }
        body.theme-cyberpunk .profile-modal-content #profile-uid,
        body.theme-cyberpunk .pending-lobby-names-list .text-sm,
        body.theme-cyberpunk .approved-lobby-names-management-list .text-sm {
            color: #808080; /* Gray for UID and secondary info */
        }
        body.theme-cyberpunk .kicked-message-modal h2 {
            color: #FF0077; /* Hot Pink for kicked message */
        }

        body.theme-cyberpunk .lobby-sidebar {
            background-color: rgba(0,0,0,0.5);
            border: 1px solid #FF00FF;
        }
        body.theme-cyberpunk .player-list-item {
            background-color: rgba(0,255,255,0.1);
            border: 1px solid rgba(0,255,255,0.2);
        }
        body.theme-cyberpunk .player-list-item.is-host { border-color: #FF00FF; }
        body.theme-cyberpunk .player-list-item .player-name { color: #00FFFF; }
        body.theme-cyberpunk .player-list-item .host-label { color: #FF00FF; }
        body.theme-cyberpunk .kick-player-btn { border: 1px solid #FF0077; color: #FF0077; }
        body.theme-cyberpunk .kick-player-btn:hover { background: #FF0077; color: white; }

        body.theme-cyberpunk .lobby-chat-container {
            background-color: rgba(0,0,0,0.6);
            border: 2px solid #FF00FF;
        }
        body.theme-cyberpunk .chat-message { background-color: #1A001A; }
        body.theme-cyberpunk .chat-message.current-user { background-color: #004444; }
        body.theme-cyberpunk .chat-message .sender-name { color: #00FFFF; }
        body.theme-cyberpunk .chat-message .message-text-deleted { color: #777; }
        body.theme-cyberpunk .delete-message-btn { color: #777; }
        body.theme-cyberpunk .delete-message-btn:hover { color: #FF0077; }

        body.theme-cyberpunk .start-game-btn { background: linear-gradient(145deg, #39FF14 0%, #228B22 100%); border: 2px solid #FF00FF; }

        body.theme-cyberpunk .lobby-sidebar::-webkit-scrollbar-track,
        body.theme-cyberpunk #player-list-container::-webkit-scrollbar-track,
        body.theme-cyberpunk .lobby-chat-messages::-webkit-scrollbar-track,
        body.theme-cyberpunk .custom-scrollbar::-webkit-scrollbar-track { background: #0A0A0A; }
        body.theme-cyberpunk .lobby-sidebar::-webkit-scrollbar-thumb,
        body.theme-cyberpunk #player-list-container::-webkit-scrollbar-thumb,
        body.theme-cyberpunk .lobby-chat-messages::-webkit-scrollbar-thumb,
        body.theme-cyberpunk .custom-scrollbar::-webkit-scrollbar-thumb { background: #00FFFF; }
        body.theme-cyberpunk .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        body.theme-cyberpunk #player-list-container::-webkit-scrollbar-thumb:hover,
        body.theme-cyberpunk .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        body.theme-cyberpunk .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #FF00FF; }

        body.theme-cyberpunk .lobby-type-btn { border: 2px solid #FF00FF; background-color: transparent; color: #FF00FF; }
        body.theme-cyberpunk .lobby-type-btn.active { background-color: #FF00FF; color: #1A001A; box-shadow: 0 0 10px rgba(0,255,255,0.5); }
        body.theme-cyberpunk .lobby-lock-icon { color: #FF00FF; }

        body.theme-cyberpunk .game-player-pod {
            background-color: rgba(0,255,255,0.1);
            border: 1px solid rgba(0,255,255,0.3);
        }
        body.theme-cyberpunk .game-player-pod.is-ai { background-color: rgba(255, 0, 119, 0.1); border-color: #FF0077; }
        body.theme-cyberpunk .game-player-pod.is-human { background-color: rgba(0, 191, 255, 0.1); border-color: #00BFFF; }
        body.theme-cyberpunk .game-player-pod.current-active-player { border-color: #FF00FF; box-shadow: 0 0 15px rgba(255,0,255,0.7); }
        body.theme-cyberpunk .game-player-pod .player-name { color: #00FFFF; }
        body.theme-cyberpunk .game-player-pod .player-role { color: #FF00FF; }
        body.theme-cyberpunk .game-player-pod .player-status { color: #AAA; }

        body.theme-cyberpunk .voting-btn { border: 3px solid #00FFFF; }
        body.theme-cyberpunk .voting-btn.ai-vote { background: linear-gradient(145deg, #FF0077 0%, #CC0055 100%); color: white; }
        body.theme-cyberpunk .voting-btn.human-vote { background: linear-gradient(145deg, #00BFFF 0%, #008080 100%); color: white; }

        body.theme-cyberpunk .coin-icon { fill: #00FFFF; } /* Cyan coin */

        /* === NEW THEME: FOREST === */
        body.theme-forest {
            background: linear-gradient(to bottom, #1E3A24, #0A1C12); /* Dark forest greens */
            color: #D4EDDA; /* Light green-white */
            font-family: 'Merriweather', serif;
        }
        body.theme-forest h1,
        body.theme-forest h2 {
            color: #92B4A1; /* Muted teal-green */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        body.theme-forest p,
        body.theme-forest span {
            color: #D4EDDA; /* Default text color */
        }
        
        body.theme-forest .classic-card {
            background: linear-gradient(145deg, #2D4034 0%, #4D6454 100%);
            border: 4px solid #79A3B1; /* Muted blue-green */
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 10px rgba(212,237,218,0.2);
        }
        body.theme-forest .classic-card::before,
        body.theme-forest .classic-card::after {
            border-color: #92B4A1;
            box-shadow: 0 0 10px rgba(146,180,161,0.5);
        }
        body.theme-forest .classic-btn {
            border: 2px solid #79A3B1;
            color: #FFF;
        }
        body.theme-forest .btn-purple-classic { background: linear-gradient(145deg, #6A5ACD 0%, #483D8B 100%); } /* Slate Blue */
        body.theme-forest .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); } /* Steel Blue */
        body.theme-forest .btn-green-classic { background: linear-gradient(145deg, #2E8B57 0%, #3CB371 100%); } /* Sea Green */
        body.theme-forest .btn-red-classic { background: linear-gradient(145deg, #B22222 0%, #8B0000 100%); } /* Firebrick */
        body.theme-forest .btn-gray-classic { background: linear-gradient(145deg, #6C7A89 0%, #515B67 100%); } /* Cadet Gray */
        body.theme-forest .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        body.theme-forest .btn-gold-classic { background: linear-gradient(145deg, #DDA0DD 0%, #BA55D3 100%); } /* Plum-Purple */

        body.theme-forest input,
        body.theme-forest select {
            background-color: #2F4F4F; /* Dark Slate Gray */
            border: 2px solid #79A3B1;
            color: #D4EDDA;
        }
        body.theme-forest input::placeholder { color: #A0B2A3; }
        body.theme-forest input:focus,
        body.theme-forest select:focus {
            border-color: #92B4A1 !important;
            box-shadow: 0 0 0 4px rgba(121,163,177,0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }
        body.theme-forest .app-header,
        body.theme-forest .lobby-header {
            background: linear-gradient(to right, #1E3A24, #2A5230);
            border-bottom: 3px solid #92B4A1;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        body.theme-forest #header-user-coins-container {
            background-color: rgba(46,139,87,0.3); /* Sea Green tint */
            box-shadow: 0 2px 5px rgba(46,139,87,0.3);
            color: #92B4A1;
        }
        body.theme-forest .lobby-header .search-container {
            background-color: #2F4F4F;
            border: 2px solid #79A3B1;
        }
        body.theme-forest .lobby-header .search-container svg { color: #92B4A1; }

        body.theme-forest .app-footer,
        body.theme-forest .lobby-footer {
            background: linear-gradient(to left, #1E3A24, #2A5230);
            border-top: 3px solid #92B4A1;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }
        body.theme-forest .lobby-footer .icon-btn { color: #D4EDDA; }
        body.theme-forest .lobby-footer .games-running-text { color: #D4EDDA; }

        body.theme-forest .main-content-area {
            background: linear-gradient(180deg, #3A5F45 0%, #2D4C34 100%);
        }
        body.theme-forest .main-content-area h1 { color: #92B4A1; }
        body.theme-forest .main-content-area p { color: #D4EDDA; }

        body.theme-forest .lobby-item {
            background: linear-gradient(145deg, #3A5F45 0%, #2D4C34 100%);
            border: 2px solid #79A3B1;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3), inset 0 0 8px rgba(146,180,161,0.3);
        }
        body.theme-forest .lobby-item h3 { color: #92B4A1; }
        body.theme-forest .lobby-item p { color: #D4EDDA; }

        body.theme-forest .lobby-detail-screen-full {
            background: linear-gradient(180deg, #3A5F45 0%, #2D4C34 100%);
        }
        body.theme-forest .lobby-detail-content {
            background: linear-gradient(145deg, #2D4C34 0%, #1E3A24 100%);
            border: 3px solid #79A3B1;
            box-shadow: 0 8px 16px rgba(0,0,0,0.7);
        }

        body.theme-forest .profile-modal-content h2,
        body.theme-forest .custom-confirm-modal h2,
        body.theme-forest .create-lobby-modal h2,
        body.theme-forest .kick-player-confirm-modal h2,
        body.theme-forest .kicked-players-list-modal h2,
        body.theme-forest .enter-password-modal h2 {
            color: #92B4A1;
        }
        body.theme-forest .profile-modal-content p,
        body.theme-forest .create-lobby-modal label,
        body.theme-forest .create-lobby-modal h3,
        body.theme-forest .pending-lobby-names-list p,
        body.theme-forest .approved-lobby-names-management-list p,
        body.theme-forest .custom-confirm-modal p,
        body.theme-forest .kick-player-confirm-modal p,
        body.theme-forest .kicked-message-modal p,
        body.theme-forest .kicked-players-list-modal p,
        body.theme-forest .enter-password-modal p {
            color: #D4EDDA;
        }
        body.theme-forest .lobby-proposal-message.text-red-400 {
            color: #B22222;
        }
        body.theme-forest .profile-modal-content #profile-uid,
        body.theme-forest .pending-lobby-names-list .text-sm,
        body.theme-forest .approved-lobby-names-management-list .text-sm {
            color: #A0B2A3; /* Darker green-gray for UID and secondary info */
        }
        body.theme-forest .kicked-message-modal h2 {
            color: #B22222; /* Firebrick for kicked message */
        }

        body.theme-forest .lobby-sidebar {
            background-color: rgba(46,139,87,0.2);
            border: 1px solid #92B4A1;
        }
        body.theme-forest .player-list-item {
            background-color: rgba(212,237,218,0.1);
            border: 1px solid rgba(212,237,218,0.2);
        }
        body.theme-forest .player-list-item.is-host { border-color: #92B4A1; }
        body.theme-forest .player-list-item .player-name { color: #D4EDDA; }
        body.theme-forest .player-list-item .host-label { color: #92B4A1; }
        body.theme-forest .kick-player-btn { border: 1px solid #B22222; color: #B22222; }
        body.theme-forest .kick-player-btn:hover { background: #B22222; color: white; }

        body.theme-forest .lobby-chat-container {
            background-color: rgba(46,139,87,0.4);
            border: 2px solid #79A3B1;
        }
        body.theme-forest .chat-message { background-color: #3A5F45; }
        body.theme-forest .chat-message.current-user { background-color: #2F4F4F; }
        body.theme-forest .chat-message .sender-name { color: #D4EDDA; }
        body.theme-forest .chat-message .message-text-deleted { color: #A0B2A3; }
        body.theme-forest .delete-message-btn { color: #A0B2A3; }
        body.theme-forest .delete-message-btn:hover { color: #B22222; }

        body.theme-forest .start-game-btn { background: linear-gradient(145deg, #2E8B57 0%, #3CB371 100%); border: 2px solid #79A3B1; }

        body.theme-forest .lobby-sidebar::-webkit-scrollbar-track,
        body.theme-forest #player-list-container::-webkit-scrollbar-track,
        body.theme-forest .lobby-chat-messages::-webkit-scrollbar-track,
        body.theme-forest .custom-scrollbar::-webkit-scrollbar-track { background: #2F4F4F; }
        body.theme-forest .lobby-sidebar::-webkit-scrollbar-thumb,
        body.theme-forest #player-list-container::-webkit-scrollbar-thumb,
        body.theme-forest .lobby-chat-messages::-webkit-scrollbar-thumb,
        body.theme-forest .custom-scrollbar::-webkit-scrollbar-thumb { background: #79A3B1; }
        body.theme-forest .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        body.theme-forest #player-list-container::-webkit-scrollbar-thumb:hover,
        body.theme-forest .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        body.theme-forest .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #92B4A1; }

        body.theme-forest .lobby-type-btn { border: 2px solid #79A3B1; background-color: transparent; color: #79A3B1; }
        body.theme-forest .lobby-type-btn.active { background-color: #79A3B1; color: #2D4C34; box-shadow: 0 0 10px rgba(121,163,177,0.5); }
        body.theme-forest .lobby-lock-icon { color: #92B4A1; }

        body.theme-forest .game-player-pod {
            background-color: rgba(212,237,218,0.1);
            border: 1px solid rgba(212,237,218,0.2);
        }
        body.theme-forest .game-player-pod.is-ai { background-color: rgba(178, 34, 34, 0.1); border-color: #B22222; }
        body.theme-forest .game-player-pod.is-human { background-color: rgba(70, 130, 180, 0.1); border-color: #4682B4; }
        body.theme-forest .game-player-pod.current-active-player { border-color: #92B4A1; box-shadow: 0 0 15px rgba(146,180,161,0.7); }
        body.theme-forest .game-player-pod .player-name { color: #D4EDDA; }
        body.theme-forest .game-player-pod .player-role { color: #92B4A1; }
        body.theme-forest .game-player-pod .player-status { color: #A0B2A3; }

        body.theme-forest .voting-btn { border: 3px solid #92B4A1; }
        body.theme-forest .voting-btn.ai-vote { background: linear-gradient(145deg, #B22222 0%, #8B0000 100%); color: white; }
        body.theme-forest .voting-btn.human-vote { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); color: white; }

        body.theme-forest .coin-icon { fill: #D4EDDA; }


        /* === NEW THEME: OCEAN === */
        body.theme-ocean {
            background: linear-gradient(to bottom, #0A192F, #001F3F); /* Dark deep blue */
            color: #BBDEFB; /* Light sky blue */
            font-family: 'Merriweather', serif;
        }
        body.theme-ocean h1,
        body.theme-ocean h2 {
            color: #64B5F6; /* Medium blue */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        body.theme-ocean p,
        body.theme-ocean span {
            color: #BBDEFB; /* Default text color */
        }
        
        body.theme-ocean .classic-card {
            background: linear-gradient(145deg, #0A192F 0%, #1A2E4F 100%);
            border: 4px solid #42A5F5; /* Blue */
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 10px rgba(187,222,251,0.2);
        }
        body.theme-ocean .classic-card::before,
        body.theme-ocean .classic-card::after {
            border-color: #64B5F6;
            box-shadow: 0 0 10px rgba(100,181,246,0.5);
        }
        body.theme-ocean .classic-btn {
            border: 2px solid #42A5F5;
            color: #FFF;
        }
        body.theme-ocean .btn-purple-classic { background: linear-gradient(145deg, #81D4FA 0%, #4FC3F7 100%); } /* Light Blue */
        body.theme-ocean .btn-blue-classic { background: linear-gradient(145deg, #2196F3 0%, #1976D2 100%); } /* Regular Blue */
        body.theme-ocean .btn-green-classic { background: linear-gradient(145deg, #4CAF50 0%, #388E3C 100%); } /* Green */
        body.theme-ocean .btn-red-classic { background: linear-gradient(145deg, #FF5252 0%, #D32F2F 100%); } /* Red */
        body.theme-ocean .btn-gray-classic { background: linear-gradient(145deg, #9E9E9E 0%, #757575 100%); }
        body.theme-ocean .btn-brown-classic { background: linear-gradient(145deg, #A1887F 0%, #795548 100%); } /* Brown */
        body.theme-ocean .btn-gold-classic { background: linear-gradient(145deg, #FFC107 0%, #FFA000 100%); } /* Amber */

        body.theme-ocean input,
        body.theme-ocean select {
            background-color: #0E2947;
            border: 2px solid #42A5F5;
            color: #BBDEFB;
        }
        body.theme-ocean input::placeholder { color: #90CAF9; }
        body.theme-ocean input:focus,
        body.theme-ocean select:focus {
            border-color: #64B5F6 !important;
            box-shadow: 0 0 0 4px rgba(66,165,245,0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }

        body.theme-ocean .app-header,
        body.theme-ocean .lobby-header {
            background: linear-gradient(to right, #0A192F, #0E2947);
            border-bottom: 3px solid #64B5F6;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        body.theme-ocean #header-user-coins-container {
            background-color: rgba(66,165,245,0.3); /* Blue tint */
            box-shadow: 0 2px 5px rgba(66,165,245,0.3);
            color: #BBDEFB;
        }
        body.theme-ocean .lobby-header .search-container {
            background-color: #0E2947;
            border: 2px solid #42A5F5;
        }
        body.theme-ocean .lobby-header .search-container svg { color: #64B5F6; }

        body.theme-ocean .app-footer,
        body.theme-ocean .lobby-footer {
            background: linear-gradient(to left, #0A192F, #0E2947);
            border-top: 3px solid #64B5F6;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }
        body.theme-ocean .lobby-footer .icon-btn { color: #BBDEFB; }
        body.theme-ocean .lobby-footer .games-running-text { color: #BBDEFB; }

        body.theme-ocean .main-content-area {
            background: linear-gradient(180deg, #1A2E4F 0%, #0E2947 100%);
        }
        body.theme-ocean .main-content-area h1 { color: #64B5F6; }
        body.theme-ocean .main-content-area p { color: #BBDEFB; }

        body.theme-ocean .lobby-item {
            background: linear-gradient(145deg, #1A2E4F 0%, #0E2947 100%);
            border: 2px solid #42A5F5;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3), inset 0 0 8px rgba(100,181,246,0.3);
        }
        body.theme-ocean .lobby-item h3 { color: #64B5F6; }
        body.theme-ocean .lobby-item p { color: #BBDEFB; }

        body.theme-ocean .lobby-detail-screen-full {
            background: linear-gradient(180deg, #1A2E4F 0%, #0E2947 100%);
        }
        body.theme-ocean .lobby-detail-content {
            background: linear-gradient(145deg, #0E2947 0%, #0A192F 100%);
            border: 3px solid #42A5F5;
            box-shadow: 0 8px 16px rgba(0,0,0,0.7);
        }

        body.theme-ocean .profile-modal-content h2,
        body.theme-ocean .custom-confirm-modal h2,
        body.theme-ocean .create-lobby-modal h2,
        body.theme-ocean .kick-player-confirm-modal h2,
        body.theme-ocean .kicked-players-list-modal h2,
        body.theme-ocean .enter-password-modal h2 {
            color: #64B5F6;
        }
        body.theme-ocean .profile-modal-content p,
        body.theme-ocean .create-lobby-modal label,
        body.theme-ocean .create-lobby-modal h3,
        body.theme-ocean .pending-lobby-names-list p,
        body.theme-ocean .approved-lobby-names-management-list p,
        body.theme-ocean .custom-confirm-modal p,
        body.theme-ocean .kick-player-confirm-modal p,
        body.theme-ocean .kicked-message-modal p,
        body.theme-ocean .kicked-players-list-modal p,
        body.theme-ocean .enter-password-modal p {
            color: #BBDEFB;
        }
        body.theme-ocean .lobby-proposal-message.text-red-400 {
            color: #FF5252;
        }
        body.theme-ocean .profile-modal-content #profile-uid,
        body.theme-ocean .pending-lobby-names-list .text-sm,
        body.theme-ocean .approved-lobby-names-management-list .text-sm {
            color: #90CAF9; /* Lighter blue for UID and secondary info */
        }
        body.theme-ocean .kicked-message-modal h2 {
            color: #FF5252; /* Red for kicked message */
        }

        body.theme-ocean .lobby-sidebar {
            background-color: rgba(66,165,245,0.2);
            border: 1px solid #64B5F6;
        }
        body.theme-ocean .player-list-item {
            background-color: rgba(187,222,251,0.1);
            border: 1px solid rgba(187,222,251,0.2);
        }
        body.theme-ocean .player-list-item.is-host { border-color: #64B5F6; }
        body.theme-ocean .player-list-item .player-name { color: #BBDEFB; }
        body.theme-ocean .player-list-item .host-label { color: #64B5F6; }
        body.theme-ocean .kick-player-btn { border: 1px solid #D32F2F; color: #D32F2F; }
        body.theme-ocean .kick-player-btn:hover { background: #D32F2F; color: white; }

        body.theme-ocean .lobby-chat-container {
            background-color: rgba(66,165,245,0.4);
            border: 2px solid #42A5F5;
        }
        body.theme-ocean .chat-message { background-color: #1A2E4F; }
        body.theme-ocean .chat-message.current-user { background-color: #0E2947; }
        body.theme-ocean .chat-message .sender-name { color: #BBDEFB; }
        body.theme-ocean .chat-message .message-text-deleted { color: #90CAF9; }
        body.theme-ocean .delete-message-btn { color: #90CAF9; }
        body.theme-ocean .delete-message-btn:hover { color: #D32F2F; }

        body.theme-ocean .start-game-btn { background: linear-gradient(145deg, #4CAF50 0%, #388E3C 100%); border: 2px solid #42A5F5; }

        body.theme-ocean .lobby-sidebar::-webkit-scrollbar-track,
        body.theme-ocean #player-list-container::-webkit-scrollbar-track,
        body.theme-ocean .lobby-chat-messages::-webkit-scrollbar-track,
        body.theme-ocean .custom-scrollbar::-webkit-scrollbar-track { background: #0E2947; }
        body.theme-ocean .lobby-sidebar::-webkit-scrollbar-thumb,
        body.theme-ocean #player-list-container::-webkit-scrollbar-thumb,
        body.theme-ocean .lobby-chat-messages::-webkit-scrollbar-thumb,
        body.theme-ocean .custom-scrollbar::-webkit-scrollbar-thumb { background: #42A5F5; }
        body.theme-ocean .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        body.theme-ocean #player-list-container::-webkit-scrollbar-thumb:hover,
        body.theme-ocean .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        body.theme-ocean .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64B5F6; }

        body.theme-ocean .lobby-type-btn { border: 2px solid #42A5F5; background-color: transparent; color: #42A5F5; }
        body.theme-ocean .lobby-type-btn.active { background-color: #42A5F5; color: #0A192F; box-shadow: 0 0 10px rgba(100,181,246,0.5); }
        body.theme-ocean .lobby-lock-icon { color: #64B5F6; }

        body.theme-ocean .game-player-pod {
            background-color: rgba(187,222,251,0.1);
            border: 1px solid rgba(187,222,251,0.2);
        }
        body.theme-ocean .game-player-pod.is-ai { background-color: rgba(255, 82, 82, 0.1); border-color: #FF5252; }
        body.theme-ocean .game-player-pod.is-human { background-color: rgba(33, 150, 243, 0.1); border-color: #2196F3; }
        body.theme-ocean .game-player-pod.current-active-player { border-color: #64B5F6; box-shadow: 0 0 15px rgba(100,181,246,0.7); }
        body.theme-ocean .game-player-pod .player-name { color: #BBDEFB; }
        body.theme-ocean .game-player-pod .player-role { color: #64B5F6; }
        body.theme-ocean .game-player-pod .player-status { color: #90CAF9; }

        body.theme-ocean .voting-btn { border: 3px solid #64B5F6; }
        body.theme-ocean .voting-btn.ai-vote { background: linear-gradient(145deg, #FF5252 0%, #D32F2F 100%); color: white; }
        body.theme-ocean .voting-btn.human-vote { background: linear-gradient(145deg, #2196F3 0%, #1976D2 100%); color: white; }

        body.theme-ocean .coin-icon { fill: #FFC107; }


        /* === NEW THEME: MINIMAL === */
        body.theme-minimal {
            background-color: #F8F8F8; /* Light gray */
            color: #333; /* Dark text */
            font-family: 'Inter', sans-serif; /* Modern, clean font */
        }
        body.theme-minimal h1,
        body.theme-minimal h2 {
            font-family: 'Inter', sans-serif;
            color: #007BFF; /* Blue */
            text-shadow: none;
        }
        body.theme-minimal p,
        body.theme-minimal span {
            color: #333; /* Default text color, adjusted to be dark */
        }

        body.theme-minimal .classic-card {
            background-color: #FFF;
            border: 1px solid #E0E0E0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        body.theme-minimal .classic-card::before,
        body.theme-minimal .classic-card::after { display: none; } /* No ornaments */
        body.theme-minimal .classic-btn {
            border: 1px solid #007BFF;
            color: #FFF;
            border-radius: 8px;
            font-weight: normal;
            text-shadow: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.theme-minimal .classic-btn:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(-2px) scale(1.01);
        }
        body.theme-minimal .btn-purple-classic { background: #6F42C1; } /* Darker Purple */
        body.theme-minimal .btn-blue-classic { background: #007BFF; } /* Standard Blue */
        body.theme-minimal .btn-green-classic { background: #28A745; } /* Standard Green */
        body.theme-minimal .btn-red-classic { background: #DC3545; } /* Standard Red */
        body.theme-minimal .btn-gray-classic { background: #6C757D; } /* Standard Gray */
        body.theme-minimal .btn-brown-classic { background: #A0522D; } /* Sienna */
        body.theme-minimal .btn-gold-classic { background: #FFC107; border: none; padding: 0.4rem; border-radius: 6px; }
        body.theme-minimal .btn-gold-classic:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.2); transform: translateY(-1px) scale(1.02); }


        body.theme-minimal input,
        body.theme-minimal select {
            background-color: #F0F0F0;
            border: 1px solid #CCC;
            color: #333;
            border-radius: 6px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        body.theme-minimal input::placeholder { color: #999; }
        body.theme-minimal input:focus,
        body.theme-minimal select:focus {
            border-color: #007BFF !important;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25) !important, inset 0 1px 2px rgba(0,0,0,0.1) !important;
        }

        body.theme-minimal .app-header,
        body.theme-minimal .lobby-header {
            background-color: #FFF;
            border-bottom: 1px solid #E0E0E0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.theme-minimal #header-user-coins-container {
            background-color: rgba(0,123,255,0.1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            color: #007BFF;
        }
        body.theme-minimal .lobby-header .search-container {
            background-color: #F0F0F0;
            border: 1px solid #CCC;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
        }
        body.theme-minimal .lobby-header .search-container input { /* Removed padding override */ }
        body.theme-minimal .lobby-header .search-container svg { color: #007BFF; }

        body.theme-minimal .app-footer,
        body.theme-minimal .lobby-footer {
            background-color: #FFF;
            border-top: 1px solid #E0E0E0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        body.theme-minimal .lobby-footer .icon-btn { color: #007BFF; font-size: 0.75rem;}
        body.theme-minimal .lobby-footer .icon-btn svg { width: 28px; height: 28px; }
        body.theme-minimal .lobby-footer .games-running-text { color: #6C757D; font-size: 1rem; }

        body.theme-minimal .main-content-area {
            background-color: #F8F8F8;
        }
        body.theme-minimal .main-content-area h1 { color: #007BFF; }
        body.theme-minimal .main-content-area p { color: #333; }

        body.theme-minimal .lobby-item {
            background-color: #FFF;
            border: 1px solid #E0E0E0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }
        body.theme-minimal .lobby-item:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        body.theme-minimal .lobby-item h3 { color: #007BFF; font-family: 'Inter', sans-serif; font-size: 1.5rem;}
        body.theme-minimal .lobby-item p { color: #6C757D; font-size: 0.9rem;}

        body.theme-minimal .lobby-detail-screen-full { background-color: #F8F8F8; }
        body.theme-minimal .lobby-detail-content {
            background-color: #FFF;
            border: 1px solid #E0E0E0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        body.theme-minimal .lobby-sidebar {
            background-color: #F8F8F8;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 0.75rem;
        }
        body.theme-minimal .player-list-item {
            background-color: #E9ECEF;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.4rem;
        }
        body.theme-minimal .player-list-item.is-host { border-color: #007BFF; }
        body.theme-minimal .player-list-item .player-name { color: #333; }
        body.theme-minimal .player-list-item .host-label { color: #007BFF; font-size: 0.7rem;}
        body.theme-minimal .kick-player-btn { border: 1px solid #DC3545; color: #DC3545; padding: 0.15rem 0.4rem; font-size: 0.7rem;}
        body.theme-minimal .kick-player-btn:hover { background: #DC3545; color: white; }

        body.theme-minimal .profile-modal-content h2,
        body.theme-minimal .custom-confirm-modal h2,
        body.theme-minimal .create-lobby-modal h2,
        body.theme-minimal .kick-player-confirm-modal h2,
        body.theme-minimal .kicked-players-list-modal h2,
        body.theme-minimal .enter-password-modal h2 {
            color: #007BFF;
        }
        body.theme-minimal .profile-modal-content p,
        body.theme-minimal .create-lobby-modal label,
        body.theme-minimal .create-lobby-modal h3,
        body.theme-minimal .pending-lobby-names-list p,
        body.theme-minimal .approved-lobby-names-management-list p,
        body.theme-minimal .custom-confirm-modal p,
        body.theme-minimal .kick-player-confirm-modal p,
        body.theme-minimal .kicked-message-modal p,
        body.theme-minimal .kicked-players-list-modal p,
        body.theme-minimal .enter-password-modal p {
            color: #333; /* Default text on light modals */
        }
        body.theme-minimal .lobby-proposal-message.text-red-400 {
            color: #DC3545;
        }
        body.theme-minimal .profile-modal-content #profile-uid,
        body.theme-minimal .pending-lobby-names-list .text-sm,
        body.theme-minimal .approved-lobby-names-management-list .text-sm {
            color: #888; /* Lighter gray for UID and secondary info */
        }
        body.theme-minimal .kicked-message-modal h2 {
            color: #DC3545; /* Red for kicked message */
        }
        body.theme-minimal #header-display-name,
        body.theme-minimal #header-user-id { /* Ensure header text is dark */
            color: #333;
        }
        body.theme-minimal #profile-summary svg { /* User icon color */
            color: #007BFF;
        }
        body.theme-minimal #menu-btn svg { /* Hamburger icon color */
            color: #007BFF;
        }
        body.theme-minimal .lobby-header .search-container svg {
             color: #007BFF;
        }
        body.theme-minimal #back-to-main-btn svg {
             color: #007BFF;
        }
        body.theme-minimal .close-main-menu-modal-btn svg,
        body.theme-minimal .close-create-lobby-modal-btn svg,
        body.theme-minimal .close-kick-player-confirm-modal-btn svg,
        body.theme-minimal .close-kicked-players-list-modal-btn svg {
            color: #6C757D; /* Darker close icons */
        }


        body.theme-minimal .lobby-chat-container {
            background-color: #F0F0F0;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 0.5rem;
        }
        body.theme-minimal .chat-message {
            background-color: #E9ECEF;
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
        }
        body.theme-minimal .chat-message.current-user { background-color: #D6E8FA; }
        body.theme-minimal .chat-message .sender-name { color: #007BFF; font-size: 0.8em; margin-bottom: 0.1rem;}
        body.theme-minimal .chat-message .message-text-deleted { color: #AAA; }
        body.theme-minimal .delete-message-btn { color: #AAA; padding: 0.2rem;}
        body.theme-minimal .delete-message-btn:hover { color: #DC3545; }

        body.theme-minimal .lobby-chat-input-form input { padding: 0.5rem; }
        body.theme-minimal .lobby-chat-input-form button { padding: 0.5rem 1rem; font-size: 0.9rem; }

        body.theme-minimal .start-game-btn { background: #28A745; border: 1px solid #28A745; }

        body.theme-minimal .lobby-sidebar::-webkit-scrollbar-track,
        body.theme-minimal #player-list-container::-webkit-scrollbar-track,
        body.theme-minimal .lobby-chat-messages::-webkit-scrollbar-track,
        body.theme-minimal .custom-scrollbar::-webkit-scrollbar-track { background: #E9ECEF; }
        body.theme-minimal .lobby-sidebar::-webkit-scrollbar-thumb,
        body.theme-minimal #player-list-container::-webkit-scrollbar-thumb,
        body.theme-minimal .lobby-chat-messages::-webkit-scrollbar-thumb,
        body.theme-minimal .custom-scrollbar::-webkit-scrollbar-thumb { background: #007BFF; }
        body.theme-minimal .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        body.theme-minimal #player-list-container::-webkit-scrollbar-thumb:hover,
        body.theme-minimal .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        body.theme-minimal .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0056b3; }

        body.theme-minimal .lobby-type-btn { border: 1px solid #007BFF; background-color: transparent; color: #007BFF; border-radius: 6px; padding: 0.4rem 1.2rem; }
        body.theme-minimal .lobby-type-btn.active { background-color: #007BFF; color: white; box-shadow: 0 0 8px rgba(0,123,255,0.3); }
        body.theme-minimal .lobby-lock-icon { color: #007BFF; }

        body.theme-minimal .game-player-pod {
            background-color: #F0F8FF;
            border: 1px solid #D6E8FA;
            border-radius: 8px;
        }
        body.theme-minimal .game-player-pod.is-ai { background-color: #FCEAEA; border-color: #FACDCD; }
        body.theme-minimal .game-player-pod.is-human { background-color: #E0EEFF; border-color: #C0DAF7; }
        body.theme-minimal .game-player-pod.current-active-player { border-color: #007BFF; box-shadow: 0 0 10px rgba(0,123,255,0.5); }
        body.theme-minimal .game-player-pod .player-name { color: #333; font-size: 1rem;}
        body.theme-minimal .game-player-pod .player-role { color: #007BFF; font-size: 0.85rem;}
        body.theme-minimal .game-player-pod .player-status { color: #6C757D; font-size: 0.75rem;}

        body.theme-minimal .voting-btn { border: 1px solid #007BFF; border-radius: 8px; padding: 0.8rem 1.5rem; font-size: 1.2rem;}
        body.theme-minimal .voting-btn.ai-vote { background: #DC3545; color: white; }
        body.theme-minimal .voting-btn.human-vote { background: #007BFF; color: white; }

        body.theme-minimal .coin-icon { fill: #007BFF; }

        /* Styles for active theme button */
        .theme-button.active-theme-btn {
            background-color: #DAA520; /* Default gold for classic */
            color: #1A1A1A; /* Dark text for classic */
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
            border-color: #FFD700;
        }
        body.theme-cyberpunk .theme-button.active-theme-btn {
            background-color: #FF00FF; /* Magenta for cyberpunk */
            color: #1A001A;
            box-shadow: 0 0 10px rgba(0,255,255,0.5);
            border-color: #00FFFF;
        }
        body.theme-forest .theme-button.active-theme-btn {
            background-color: #2E8B57; /* Sea Green for forest */
            color: #D4EDDA;
            box-shadow: 0 0 10px rgba(146,180,161,0.5);
            border-color: #92B4A1;
        }
        body.theme-ocean .theme-button.active-theme-btn {
            background-color: #2196F3; /* Blue for ocean */
            color: #0A192F;
            box-shadow: 0 0 10px rgba(100,181,246,0.5);
            border-color: #42A5F5;
        }
        body.theme-minimal .theme-button.active-theme-btn {
            background-color: #007BFF; /* Blue for minimal */
            color: white;
            box-shadow: 0 0 8px rgba(0,123,255,0.3);
            border-color: #007BFF;
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            border-radius: 20px; /* Slightly larger radius */
            backdrop-filter: blur(10px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh; /* Ensure card doesn't overflow viewport */
            overflow-y: hidden; /* Removed vertical scrollbars */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid;
            border-left: 5px solid;
            border-radius: 5px 0 0 0;
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid;
            border-right: 5px solid;
            border-radius: 0 0 5px 0;
        }


        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother transition */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and scale */
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Input Field Styles - More refined Classic Look */
        input, select { /* Added select for lobby names dropdown */
            padding: 0.875rem; /* Equivalent to p-3.5 */
            border-radius: 0.75rem; /* Equivalent to rounded-xl */
        }
        /* Header specific styles - Richer Gold/Brown */
        .app-header {
            height: 70px; /* Fixed height for header */
            position: fixed; /* Explicitly fixed */
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-between; /* Spreads items */
            align-items: center;
        }

        /* NEW: Coin display container in header (positioned on the left for RTL) */
        #header-user-coins-container {
            /* flex-grow added directly in HTML to push it rightwards */
            border-radius: 10px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            margin-left: 1rem; /* Space between coins and menu button */
        }
        #header-user-coins-container:hover {
            transform: translateY(-2px);
        }

        /* Lobby Screen Specific Header */
        .lobby-header {
            height: 70px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center; /* Align items vertically */
            justify-content: center; /* Center horizontally by default */
        }
        .lobby-header .search-container {
            display: flex;
            flex-grow: 1; /* Allow search container to take available space */
            max-width: 600px; /* Limit max width on larger screens */
            margin: 0 auto; /* Center the search container */
            align-items: center;
            border-radius: 15px; /* Rounded corners for search bar */
            padding: 0.5rem 1rem; /* Adjust padding */
        }
        .lobby-header .search-container input {
            flex-grow: 1;
            background-color: transparent; /* Transparent background */
            border: none; /* No border for input inside search bar */
            padding: 0.25rem 0.5rem;
            outline: none; /* No outline on focus */
            text-align: right; /* Align text to right for RTL */
        }
        .lobby-header .search-container input::placeholder {
        }
        .lobby-header .search-container svg {
            min-width: 24px; /* Ensure icons don't shrink */
            min-height: 24px;
        }
        .lobby-header .search-container button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.5rem;
        }
        .lobby-header .back-btn-wrapper {
            margin-left: 10px; /* Space between back button and search bar (for RTL) */
        }
        .lobby-header .search-icon-wrapper {
            margin-right: 10px; /* Space between search icon and search input (RTL) */
        }


        .app-footer {
            height: 90px; /* Fixed height for footer */
            position: fixed; /* Explicitly fixed */
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1rem; /* Added gap here for spacing buttons */
        }
        /* Lobby Screen Specific Footer */
        .lobby-footer {
            height: 90px;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .lobby-footer .icon-btn:hover {
            transform: translateY(-5px);
        }
        .lobby-footer .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .lobby-footer .icon-btn svg {
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
            transition: transform 0.8s ease-in-out;
        }
        .lobby-footer .games-running-text {
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main content area padding to avoid overlap with fixed header/footer */
        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 90px; /* Footer height */
            flex-grow: 1; /* Allow content to fill available space */
            overflow-y: auto; /* Re-enabled for scrollable lists */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for main content */
            width: 100%; /* Ensure it takes full width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start for scrollable lists */
            align-items: center; /* Center content horizontally */
            position: relative; /* For any absolute positioned elements inside */
        }
        
        /* Profile Modal specific styles (now main-menu-modal) */
        .profile-modal-overlay {
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            transition: opacity 0.3s ease-in-out;
        }
        .profile-modal-content {
            transform: translateY(-20px); /* Initial slightly elevated */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .profile-modal-enter-active .profile-modal-content {
            transform: translateY(0);
        }
        .profile-modal-leave-active .profile-modal-content {
            transform: translateY(-20px);
            opacity: 0;
        }

        /* Create Lobby Modal Styles */
        #create-lobby-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Confirmation Modal Styles */
        #confirmation-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Animation for lobby items when closing */
        .lobby-item.fade-out {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Enhanced Lobby Item Styling */
        .lobby-item {
            border-radius: 15px; /* Rounded corners */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smooth transitions for hover effects */
            position: relative; /* For overflow hidden and pseudo-elements */
            overflow: hidden; /* Ensures internal elements stay within rounded corners */
            padding: 1.25rem 1.5rem; /* More generous padding */
            display: flex;
            flex-direction: column; /* Default to column for small screens */
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }

        .lobby-item::before { /* Subtle light overlay on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
            transform: skewX(-30deg);
            transition: all 0.3s ease-in-out;
        }

        .lobby-item:hover::before {
            left: 100%;
        }

        .lobby-item:hover {
            transform: translateY(-8px) scale(1.02); /* More pronounced lift and slight scale */
        }

        .lobby-item h3 {
            font-size: 1.75rem; /* Larger font for name */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }

        .lobby-item p {
            font-size: 1rem;
            margin-top: 0.25rem;
        }
        
        .lobby-item .lobby-actions { /* Container for buttons in lobby item */
            margin-top: 1rem; /* Space between text and buttons */
            display: flex;
            flex-direction: column; /* Stack buttons on mobile */
            width: 100%; /* Take full width on mobile */
            gap: 0.75rem; /* Space between stacked buttons */
        }

        /* Ensure buttons within lobby-item are full width on mobile */
        .lobby-item .join-lobby-btn,
        .lobby-item .close-lobby-btn {
            width: 100%; /* Take full width on small screens */
            padding: 0.75rem 1rem; /* Consistent padding */
            font-size: 1rem; /* Consistent font size */
        }

        /* === Lobby Detail Screen Styles (Major Redesign for Game) === */
        .lobby-detail-screen-full {
            padding-top: 0; /* No padding, the content will manage it */
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .lobby-detail-content {
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.7);
            padding: 1.5rem;
            width: 95%;
            max-width: 1200px;
            height: calc(100% - 100px); /* Fill available space minus header/margins */
            display: flex;
            flex-direction: row; /* Side-by-side layout on desktop */
            gap: 1.5rem;
            margin: 50px auto; /* Centered with margin top/bottom */
            overflow: hidden; /* Prevent content from spilling */
        }

        /* Sidebar for player info */
        .lobby-sidebar {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 300px;
            border-radius: 15px;
            padding: 1rem;
            overflow-y: auto;
        }

        /* Main panel for chat and actions (Crucial for overlays) */
        .lobby-main-panel {
            position: relative; /* Crucial for absolute positioned overlays */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
            overflow: hidden; /* To contain overlays without affecting scrollbars for chat */
        }
        /* Ensure overlay z-index is higher than chat but lower than other modals */
        #game-countdown-overlay, #game-voting-overlay {
            z-index: 40; /* Higher than chat (which is inside lobby-main-panel) but lower than global modals (z-50) */
        }
        
        #player-list-container {
            margin-top: 1rem;
            flex-grow: 1; /* Allow list to take space */
            overflow-y: auto; /* Scroll if many players */
        }
        .player-list-item {
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease-in-out;
        }
        .player-list-item .player-name {
            font-weight: bold;
        }
        .player-list-item .host-label {
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        .kick-player-btn {
            background: none;
            border-radius: 5px;
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kick-player-btn:hover {
            color: white;
        }

        .lobby-chat-container {
            border-radius: 10px;
            padding: 0.75rem;
            flex-grow: 1; /* Key change: makes chat take all vertical space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* CRITICAL: This contains the scrolling child */
        }
        .lobby-chat-messages {
            flex-grow: 1; /* CRITICAL: This element grows to fill the parent */
            overflow-y: auto; /* CRITICAL: This element gets the scrollbar */
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
            align-self: flex-start;
            display: flex; /* NEW: Flex layout for message content and delete button */
            align-items: center; /* NEW: Vertically align content and button */
            gap: 0.5rem; /* NEW: Space between message and button */
        }
        .chat-message.current-user {
            align-self: flex-end;
            flex-direction: row-reverse; /* NEW: Puts delete button on the left for RTL */
        }
        .chat-message-content {
             flex-grow: 1; /* NEW: Allows text content to take up available space */
        }
        .chat-message .sender-name {
            font-weight: bold;
            display: block;
            font-size: 0.9em;
            margin-bottom: 0.2rem;
        }
        .chat-message .message-text-deleted { /* NEW STYLE */
            font-style: italic;
        }
        .delete-message-btn { /* NEW STYLE */
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.5;
            transition: all 0.2s ease;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .chat-message:hover .delete-message-btn { /* NEW STYLE */
            opacity: 1;
        }

        .lobby-chat-input-form {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0; /* CRITICAL: Prevents the input form from shrinking */
        }

        .lobby-actions-footer {
            flex-shrink: 0; /* Prevent shrinking */
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .start-game-btn {
            font-size: 1.1rem;
            padding: 0.6rem 1.2rem;
        }
        #host-actions-container {
             display: flex;
             flex-wrap: wrap;
             gap: 1rem;
        }

        /* Custom Scrollbars */
        .lobby-sidebar::-webkit-scrollbar,
        #player-list-container::-webkit-scrollbar,
        .lobby-chat-messages::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .lobby-sidebar::-webkit-scrollbar-track,
        #player-list-container::-webkit-scrollbar-track,
        .lobby-chat-messages::-webkit-scrollbar-track,
        .custom-scrollbar::-webkit-scrollbar-track { border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb,
        #player-list-container::-webkit-scrollbar-thumb,
        .lobby-chat-messages::-webkit-scrollbar-thumb,
        .custom-scrollbar::-webkit-scrollbar-thumb { border-radius: 4px; }
        
        /* ===== CORRECTED RESPONSIVE STYLES ===== */
        @media (min-width: 640px) { /* sm breakpoint */
            .lobby-item {
                flex-direction: row; /* Align items in a row */
                text-align: right; /* Text aligned right in RTL */
            }
            .lobby-item .lobby-actions {
                flex-direction: row; /* Buttons side-by-side */
                width: auto; /* Buttons take their natural width */
                margin-top: 0; /* No top margin when side-by-side */
                gap: 0.5rem; /* Small gap between buttons */
            }
            /* Add margin-left to close button for spacing from join button */
            .lobby-item .close-lobby-btn {
                margin-right: 0.5rem; /* Space from join button in RTL */
            }
            .lobby-item .join-lobby-btn,
            .lobby-item .close-lobby-btn {
                width: auto; /* Allow buttons to size naturally */
                font-size: 0.9rem; /* Slightly smaller for compactness */
                padding: 0.6rem 1.2rem; /* Adjusted padding */
            }
        }

        @media (max-width: 860px) {
            .lobby-detail-content {
                flex-direction: column; /* Stack panels on smaller screens */
                height: calc(100% - 80px); /* Adjust height */
                margin: 40px auto;
                padding: 1rem;
                overflow: hidden; /* ** THE MAIN FIX **: Prevent the whole card from scrolling */
            }
            .lobby-sidebar {
                width: 100%; /* Sidebar takes full width */
                flex-shrink: 0; /* ** FIX **: Prevent sidebar from shrinking when keyboard opens */
                max-height: 250px; /* Limit sidebar height */
            }
            .lobby-main-panel {
                flex-grow: 1; /* ** FIX **: Allow panel to fill remaining vertical space */
                min-height: 0; /* ** FIX **: Flexbox fix to allow shrinking properly */
            }
        }
        /* General Responsive */
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header, .app-footer, .lobby-footer { padding: 0.5rem; }
            .app-header, .lobby-header { height: 60px; }
            .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; }
            .lobby-detail-content { margin: 20px auto; height: calc(100% - 40px); }

            /* New Coin Display responsive */
            #header-user-coins-container {
                font-size: 1.2rem;
                padding: 0.4rem 0.8rem; /* Adjusted for smaller screens */
            }
            #header-user-coins-container .coin-icon {
                width: 1.2rem; /* Smaller icon */
                height: 1.2rem;
                margin-left: 0.2rem; /* Adjusted margin */
            }
            /* Responsive loading screen */
            #loading-main-text { font-size: 1.8rem; }
            #loading-sub-text { font-size: 1rem; }
            .glass-lens { width: 140px; height: 140px; border-width: 10px; }
            .glass-handle { width: 25px; height: 80px; bottom: -50px; right: -50px; }
            .glass-lens .icon-human, .glass-lens .icon-ai { width: 80px; height: 80px; }
        }
        
        /* Lobby Type Toggle Styles */
        .lobby-type-btn { padding: 0.5rem 1.5rem; border: 2px solid; border-radius: 10px; transition: all 0.2s ease-in-out; background-color: transparent; font-weight: bold; }
        .lobby-lock-icon { width: 1.2rem; height: 1.2rem; margin-left: 0.5rem; display: inline-block; vertical-align: middle; }

        /* NEW: Countdown Animation */
        @keyframes countdown-pulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .countdown-effect {
            animation: countdown-pulse 1s ease-out forwards;
        }

        /* NEW: Game Player Status Pods */
        .game-player-pod {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            min-width: 120px;
            transition: all 0.3s ease-in-out;
            position: relative;
        }
        .game-player-pod.current-active-player {
            transform: scale(1.05);
        }
        .game-player-pod .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }
        .game-player-pod .player-role {
            font-size: 0.9rem;
        }
        .game-player-pod .player-status {
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        /* Voting Buttons */
        .voting-btn {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            border-radius: 15px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .voting-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
        }
        .voting-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Coin Icon for Buttons */
        .coin-icon {
            width: 1.25rem; /* Equivalent to w-5 */
            height: 1.25rem; /* Equivalent to h-5 */
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.25rem; /* Equivalent to mr-1 */
        }
    </style>
</head>
<body class="theme-classic">

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">
        
        <!-- NEW: Maintenance Mode Screen (Highest Z-index) -->
        <div id="maintenance-screen" class="hidden fixed inset-0 flex justify-center items-center z-60 bg-black bg-opacity-80">
            <div class="classic-card p-8 w-11/12 max-w-lg text-center">
                <h2 class="text-3xl font-bold mb-4">... در حال بروزرسانی ...</h2>
                <p id="maintenance-message-text" class="text-xl">لطفاً کمی صبر کنید. به زودی باز خواهیم گشت.</p>
            </div>
        </div>


        <!-- 1. Loading Screen (NEW GRAPHICAL VERSION) -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center z-50 page-transition-active page-transition-visible">
            <div class="loading-screen-container">
                <div id="binary-background"></div>
                
                <div class="magnifying-glass">
                    <div class="glass-lens">
                        <!-- Human Icon -->
                        <svg class="icon-human" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                        </svg>
                        <!-- AI Icon -->
                        <svg class="icon-ai" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="16" height="16" x="4" y="4" rx="2" /><rect width="6" height="6" x="9" y="9" rx="1" /><path d="M9 2v2" /><path d="M15 2v2" /><path d="M9 20v2" /><path d="M15 20v2" /><path d="M20 9h2" /><path d="M20 14h2" /><path d="M2 9h2" /><path d="M2 14h2" />
                        </svg>
                    </div>
                    <div class="glass-handle"></div>
                </div>

                <div class="loading-text-container">
                    <h1 id="loading-main-text">جستجوی بازیکنان</h1>
                    <p id="loading-sub-text">در حال اتصال به سرور...</p>
                </div>
            </div>
        </div>


        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="email" placeholder="ایمیل شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <!-- Toggle buttons for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth-btn"
                            class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info and ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                    </svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg">نام کاربری</span>
                        <span id="header-user-id" class="text-xs break-all">ID: ---</span>
                    </div>
                </div>

                <!-- Spacer to push elements to ends -->
                <div class="flex-grow"></div> 

                <!-- NEW LOCATION FOR COINS - Near the menu button (left for RTL) -->
                <div id="header-user-coins-container" class="flex items-center text-xl sm:text-2xl font-extrabold">
                    <svg class="coin-icon w-6 h-6 sm:w-8 sm:h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span id="header-user-coins">---</span>
                </div>

                <!-- Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area flex flex-col justify-center items-center">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text-4xl font-bold mb-8">به بازی متنی خوش آمدید!</h1>
                <p class="text-lg">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer flex justify-center items-center gap-4">
                <button id="friendly-game-btn"
                        class="classic-btn btn-purple-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                        <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span>بازی دوستانه (<span id="friendly-game-cost">100</span>)</span>
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="classic-btn btn-brown-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                    بازی امتیازی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
                            <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                        </svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p>در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Main Menu Modal (Replaces Profile Modal) -->
        <div id="main-menu-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <button id="close-main-menu-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>

                <!-- Main Menu Navigation -->
                <div id="main-menu-nav" class="space-y-4">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">منوی اصلی</h2>
                    <button id="show-profile-btn" class="w-full classic-btn btn-blue-classic text-lg sm:text-xl">
                        پروفایل کاربری
                    </button>
                    <button id="show-themes-btn" class="w-full classic-btn btn-green-classic text-lg sm:text-xl">
                        انتخاب تم
                    </button>
                    <button id="main-menu-logout-btn" class="w-full classic-btn btn-red-classic text-lg sm:text-xl">
                        خروج از حساب
                    </button>
                </div>

                <!-- Profile View (initially hidden, shown when "Profile" is clicked) -->
                <div id="profile-view" class="hidden text-lg space-y-4 mb-8 text-right">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm">---</span></p>
                    <p><strong>سکه‌ها:</strong> <span id="profile-coins" class="font-bold">---</span></p>
                    <button id="back-to-main-menu-from-profile" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">
                        بازگشت
                    </button>
                </div>

                <!-- Themes View (initially hidden, shown when "Themes" is clicked) -->
                <div id="themes-view" class="hidden text-lg space-y-4 mb-8">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">انتخاب تم</h2>
                    <div id="theme-buttons-container" class="grid grid-cols-2 gap-4">
                        <!-- Theme buttons will be dynamically generated by JS -->
                    </div>
                    <button id="back-to-main-menu-from-themes" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">
                        بازگشت
                    </button>
                </div>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative overflow-y-auto custom-scrollbar">
                <h2 id="create-lobby-modal-title" class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">

                    <!-- NEW: Lobby Name Selection/Proposal Area -->
                    <div id="lobby-name-selection-area" class="hidden">
                        <label for="approved-lobby-names-select" class="block text-right text-sm mb-1">نام لابی تأیید شده خود را انتخاب کنید:</label>
                        <select id="approved-lobby-names-select" class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                            <!-- Options will be dynamically loaded here -->
                            <option value="">نام لابی را انتخاب کنید</option>
                        </select>
                    </div>

                    <div id="lobby-name-proposal-area" class="hidden">
                        <label for="proposed-lobby-name-input" class="block text-right text-sm mb-1">نام لابی جدید را برای تأیید ارسال کنید (می‌توانید از کد رنگی [#RRGGBB] در ابتدای نام استفاده کنید):</label>
                        <input type="text" id="proposed-lobby-name-input" placeholder="مثال: [#FFD700]لابی طلایی من"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" id="submit-lobby-name-for-approval-btn"
                                class="w-full mt-4 classic-btn btn-blue-classic text-lg sm:text-xl">
                            ارسال برای تأیید
                        </button>
                        <p class="text-sm mt-2" id="lobby-proposal-message">بعد از ارسال، ادمین نام لابی شما را بررسی و تأیید می‌کند. سپس می‌توانید از آن نام استفاده کنید.</p>
                    </div>
                    
                    <!-- NEW: Pending Lobby Names Area -->
                    <div id="pending-lobby-names-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold mb-2">نام‌های لابی در انتظار تأیید شما:</h3>
                        <div id="pending-lobby-names-list" class="space-y-2 text-right max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Pending names will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی در انتظار تایید ندارید.</p>
                        </div>
                    </div>

                    <!-- NEW: Approved Lobby Names Management Area -->
                    <div id="approved-lobby-names-management-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold mb-2">نام‌های لابی تأیید شده شما:</h3>
                        <div id="approved-lobby-names-management-list" class="space-y-2 text-right max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Approved names with delete buttons will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>
                        </div>
                    </div>

                    <div class="w-full h-px bg-yellow-600 my-4"></div> <!-- Divider -->

                    <!-- NEW: Lobby Type Toggle (Public/Private) -->
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="public" class="sr-only" checked>
                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
                    </div>
        
                    <!-- NEW: Password field for private lobbies (initially hidden) -->
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 4 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
                    
                    <!-- NEW: Game Duration Input -->
                    <div>
                        <label for="game-duration-input" class="block text-right text-sm mb-1">مدت زمان بازی (دقیقه):</label>
                        <input type="number" id="game-duration-input" value="5" min="1" max="60"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 text-center"
                               required>
                    </div>

                    <button type="submit" id="submit-create-lobby-btn"
                            class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED for Text-Based Game) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full">
            <div class="lobby-detail-content">
                
                <!-- Sidebar: Lobby Info & Players -->
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold mb-4">بازیکنان: 0/4</p>
                    
                    <div class="w-full h-px bg-yellow-600 mb-4"></div>

                    <!-- Player List / Status Display (moved here for game view) -->
                    <div id="game-player-status" class="flex flex-wrap justify-center gap-2 p-2 bg-gray-800 rounded-lg mb-4 shadow-inner">
                        <!-- Player status pods will be injected here -->
                    </div>

                    <div id="player-list-container" class="flex-grow min-h-0 overflow-y-auto">
                        <!-- Player list items will be dynamically loaded here (for non-game state) -->
                    </div>
                </div>

                <!-- Main Panel: Chat & Actions (Now contains game elements) -->
                <div class="lobby-main-panel">

                    <!-- Game Header for inside the lobby chat -->
                    <div id="game-info-panel" class="bg-gray-800 bg-opacity-70 rounded-lg p-3 mb-4 flex justify-between items-center shadow-md border border-yellow-600 hidden">
                        <div class="flex items-center space-x-4 space-x-reverse text-lg font-bold">
                            <span id="game-timer-display" class="text-3xl text-green-400 font-extrabold mr-4 hidden">--:--</span>
                            <div id="game-role-display" class="text-xl">نقش: <span id="my-role">---</span></div>
                            <div id="game-scores-display" class="text-xl text-blue-300 hidden">
                                <span id="ai-score">AI: 0</span> | <span id="human-score">Human: 0</span>
                            </div>
                        </div>
                        <button id="leave-game-from-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4 hidden">ترک بازی</button>
                    </div>

                    <!-- Countdown Overlay (now relative to lobby-main-panel) -->
                    <div id="game-countdown-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                        <div class="text-7xl font-extrabold countdown-effect" style="opacity:0; transform: scale(0.5);"></div>
                        <p class="text-2xl mt-4">بازی در حال شروع است...</p>
                    </div>

                    <!-- Game Chat Container (Reusing lobby chat styles) -->
                    <div class="lobby-chat-container flex-grow min-h-0">
                        <div id="lobby-chat-messages" class="lobby-chat-messages">
                            <!-- Game messages and events will appear here -->
                        </div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form flex-shrink-0">
                            <input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>

                    <!-- Voting/Game End Overlay (now relative to lobby-main-panel) -->
                    <div id="game-voting-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                        <h2 class="text-4xl font-bold mb-6" id="voting-title">رای‌گیری آغاز شد!</h2>
                        <p class="text-xl mb-8" id="voting-instructions">برای چه کسی رای می‌دهید؟</p>
                        <div id="voting-options" class="flex flex-wrap justify-center gap-4">
                            <!-- Voting buttons will be injected here -->
                        </div>
                        <div id="game-result-display" class="hidden text-center mt-10">
                            <h2 class="text-5xl font-extrabold mb-4" id="winnerText"></h2>
                            <p class="text-2xl" id="reasonText"></p>
                            <button id="return-to-lobbies-btn" class="classic-btn btn-blue-classic mt-8 py-3 px-6">بازگشت به لابی‌ها</button>
                        </div>
                    </div>

                    <!-- Action Buttons Footer -->
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled>
                                شروع بازی
                            </button>
                             <button id="toggle-chat-lock-btn" class="classic-btn btn-gray-classic text-sm py-2 px-4">
                                قفل کردن چت
                            </button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4">
                                لیست اخراجی‌ها
                            </button>
                        </div>
                        <!-- Leave Lobby Button (now only for host to close lobby outside of game) -->
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4 hidden">
                            بستن لابی
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ... All other modals (kick, kicked message, etc.) remain the same ... -->
        <!-- 10. Kick Player Confirmation Modal -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">اخراج بازیکن</h2>
                <button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <p class="text-lg mb-8">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button>
                    <button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                </div>
            </div>
        </div>

        <!-- 11. Kicked Message Modal -->
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">شما اخراج شدید!</h2>
                <p id="kicked-message-text" class="text-lg mb-8">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p>
                <button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button>
            </div>
        </div>

        <!-- 12. Kicked Players List Modal -->
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">لیست بازیکنان اخراج شده</h2>
                <button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div id="kicked-players-list-content" class="space-y-4 mb-8 text-left max-h-60 overflow-y-auto custom-scrollbar">
                    <!-- Kicked players will be dynamically loaded here -->
                    <p class="text-center">هیچ بازیکنی اخراج نشده است.</p>
                </div>
                <button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button>
            </div>
        </div>
        
        <!-- 13. Enter Password Modal (for private lobbies) -->
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2>
                <p class="text-lg mb-6">لابی <span id="password-prompt-lobby-name" class="font-bold"></span> نیاز به رمز عبور دارد.</p>
                <form id="enter-password-form" class="space-y-5">
                    <div>
                        <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                               required>
                    </div>
                    <div class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // REVISED: Imported writeBatch for atomic updates
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4", // Replace with your Firebase project API Key
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase context (as per environment instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global AI API Key for Content Moderation (FOR DEMONSTRATION ONLY - INSECURE FOR PRODUCTION)
        // **WARNING**: Hardcoding API keys in client-side code is a SECURITY VULNERABILITY.
        // For production, this should be moved to a secure backend (e.g., Firebase Cloud Functions).
        // You can get a Gemini API key from Google AI Studio: https://makersuite.google.com/
        // Ensure you enable the Gemini API in your Google Cloud Project.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // <<< REPLACE THIS WITH YOUR OWN GEMINI API KEY

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 
        
        // NEW: Loading Screen specific elements
        const binaryBackground = document.getElementById('binary-background');
        const loadingSubText = document.getElementById('loading-sub-text');
        
        // NEW: Maintenance Screen elements
        const maintenanceScreen = document.getElementById('maintenance-screen');
        const maintenanceMessageText = document.getElementById('maintenance-message-text');

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const headerUserCoins = document.getElementById('header-user-coins'); // NEW (Updated for new location)
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const friendlyGameCostSpan = document.getElementById('friendly-game-cost'); // NEW
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen UI Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn'); // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Main Menu Modal Elements (Replaced Profile Modal)
        const mainMenuModal = document.getElementById('main-menu-modal');
        const closeMainMenuModalBtn = document.getElementById('close-main-menu-modal-btn');
        const mainMenuNav = document.getElementById('main-menu-nav');
        const showProfileBtn = document.getElementById('show-profile-btn');
        const showThemesBtn = document.getElementById('show-themes-btn');
        const mainMenuLogoutBtn = document.getElementById('main-menu-logout-btn'); // Logout button now in main menu modal

        // Profile View (inside Main Menu Modal)
        const profileView = document.getElementById('profile-view');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileCoins = document.getElementById('profile-coins');
        const backToMainMenuFromProfile = document.getElementById('back-to-main-menu-from-profile');

        // Themes View (inside Main Menu Modal)
        const themesView = document.getElementById('themes-view');
        const themeButtonsContainer = document.getElementById('theme-buttons-container');
        const backToMainMenuFromThemes = document.getElementById('back-to-main-menu-from-themes');


        // Create Lobby Modal Elements
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field'); // Corrected ID
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');
        const gameDurationInput = document.getElementById('game-duration-input'); // NEW
        const createLobbyModalTitle = document.getElementById('create-lobby-modal-title'); // NEW: Added ID to H2

        // NEW: Lobby Name Selection/Proposal specific elements
        const lobbyNameSelectionArea = document.getElementById('lobby-name-selection-area');
        const approvedLobbyNamesSelect = document.getElementById('approved-lobby-names-select');
        const lobbyNameProposalArea = document.getElementById('lobby-name-proposal-area');
        const proposedLobbyNameInput = document.getElementById('proposed-lobby-name-input');
        const submitLobbyNameForApprovalBtn = document.getElementById('submit-lobby-name-for-approval-btn');
        const lobbyProposalMessage = document.getElementById('lobby-proposal-message'); // NEW for message about pending requests

        // NEW: Pending Lobby Names Area (for display of names waiting for admin approval)
        const pendingLobbyNamesArea = document.getElementById('pending-lobby-names-area');
        const pendingLobbyNamesList = document.getElementById('pending-lobby-names-list');

        // NEW: Approved Lobby Names Management Area (for deletion)
        const approvedLobbyNamesManagementArea = document.getElementById('approved-lobby-names-management-area');
        const approvedLobbyNamesManagementList = document.getElementById('approved-lobby-names-management-list');


        // Custom Confirmation Modal Elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // Lobby Detail Screen Elements (UPDATED)
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const toggleChatLockBtn = document.getElementById('toggle-chat-lock-btn');
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn'); // Host-only to close lobby outside of game
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChatSendBtn = document.getElementById('lobby-chat-send-btn');

        // Game specific UI elements within Lobby Detail Screen (NEW)
        const gameInfoPanel = document.getElementById('game-info-panel');
        const gameTimerDisplay = document.getElementById('game-timer-display');
        const gameRoleDisplay = document.getElementById('game-role-display');
        const myRole = document.getElementById('my-role');
        const gameScoresDisplay = document.getElementById('game-scores-display');
        const aiScore = document.getElementById('ai-score');
        const humanScore = document.getElementById('human-score');
        const leaveGameFromLobbyBtn = document.getElementById('leave-game-from-lobby-btn'); // Player-initiated leave during game
        const gamePlayerStatus = document.getElementById('game-player-status');
        const gameCountdownOverlay = document.getElementById('game-countdown-overlay');
        const countdownNumber = gameCountdownOverlay.querySelector('.countdown-effect');
        const gameVotingOverlay = document.getElementById('game-voting-overlay');
        const votingTitle = document.getElementById('voting-title');
        const votingInstructions = document.getElementById('voting-instructions');
        const votingOptions = document.getElementById('voting-options');
        const gameResultDisplay = document.getElementById('game-result-display');
        const winnerText = document.getElementById('winnerText'); 
        const reasonText = document.getElementById('reasonText');
        const returnToLobbiesBtn = document.getElementById('return-to-lobbies-btn');


        // Kick Player Confirmation Modal Elements
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-btn');
        const kickPlayerConfirmName = document.getElementById('kick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');

        // Kicked Message Modal Elements
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedMessageText = document.getElementById('kicked-message-text');
        const kickedLobbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');

        // Kicked Players List Modal Elements
        const kickedPlayersListModal = document.getElementById('kicked-players-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        const kickedPlayersListContent = document.getElementById('kicked-players-list-content');
        const kickedListOkBtn = document.getElementById('kicked-list-ok-btn');
        
        // New Enter Password Modal Elements
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // State variables
        let authMode = 'login'; // Default mode is login
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; // To store user's profile data
        let unsubscribeLobbies = null; // Global variable to store the unsubscribe function for lobby list listener
        let unsubscribeLobbyDetail = null; // Global variable for single lobby detail listener
        let unsubscribeKickedPlayers = null; // Listener for kicked players list
        let unsubscribeLobbyChat = null; // NEW: Listener for lobby chat messages
        let unsubscribeUserProfile = null; // NEW: Listener for real-time user profile updates
        let unsubscribePendingLobbyNames = null; // NEW: Listener for pending lobby names
        let unsubscribeGameSettings = null; // NEW: Listener for real-time game settings
        let isInitialAuthCheckComplete = false; // Flag to ensure initial loading screen transition happens only once
        let userHasActiveLobby = false; // Track if the current user has an active lobby (created or joined)
        let currentLobbyId = null; // Stores the ID of the lobby the current user is in
        let kickedPlayerToProcess = null; // Stores UID/name of player selected for kicking
        let lobbyToJoin = null; // To store data of private lobby user wants to join
        let isRefreshing = false; // NEW: State for refresh button
        let gameEntryCost = 100; // NEW: Default game entry cost, will be fetched from Firebase
        let currentTheme = 'classic'; // NEW: To store the currently active theme
        let isMaintenanceModeActive = false; // NEW: State for maintenance mode

        // Promise resolver for custom confirmation modal
        let resolveCustomConfirm;

        // Global timer variables for game
        let gameCountdownInterval = null;
        let gameTimerInterval = null;
        
        // NEW: Max pending proposals limit
        const MAX_PENDING_PROPOSALS = 5;

        // ===============================================
        // === START: NEW JS FOR ANIMATED LOADING SCREEN ===
        // ===============================================

        /**
         * Creates a random-looking background of binary code.
         */
        function createBinaryBackground() {
            if (!binaryBackground) return;
            const screenArea = window.innerWidth * window.innerHeight;
            const chars = Math.floor(screenArea / 150); // Adjust density
            let binaryString = '';
            for (let i = 0; i < chars; i++) {
                binaryString += Math.random() > 0.5 ? '1 ' : '0 ';
            }
            binaryBackground.textContent = binaryString;
        }

        /**
         * Sets a random thematic subtext for the loading screen.
         */
        function setRandomLoadingSubtext() {
            if (!loadingSubText) return;
            const subtexts = [
                "آیا می‌توانی هوش مصنوعی را در میان انسان‌ها بیابی؟",
                "هر پیامی می‌تواند یک سرنخ باشد...",
                "سکوت، گاهی بلندتر از فریاد است.",
                "در دنیای دیجیتال، به چه کسی می‌توان اعتماد کرد؟",
                "در حال تحلیل بازیکنان...",
                "برقراری ارتباط امن..."
            ];
            const randomIndex = Math.floor(Math.random() * subtexts.length);
            loadingSubText.textContent = subtexts[randomIndex];
        }

        // Initialize the new loading screen graphics immediately.
        createBinaryBackground();
        setRandomLoadingSubtext();

        // =============================================
        // === END: NEW JS FOR ANIMATED LOADING SCREEN ===
        // =============================================

        // Function to clear all game-related intervals
        function clearGameIntervals() {
            if (gameCountdownInterval) {
                clearInterval(gameCountdownInterval);
                gameCountdownInterval = null;
            }
            if (gameTimerInterval) {
                clearInterval(gameTimerInterval);
                gameTimerInterval = null;
            }
        }

        // Function to reset game UI elements
        function resetGameUI() {
            gameInfoPanel.classList.add('hidden');
            gameTimerDisplay.classList.add('hidden');
            gameRoleDisplay.classList.add('hidden');
            myRole.textContent = '---'; // Reset role display
            gameScoresDisplay.classList.add('hidden');
            leaveGameFromLobbyBtn.classList.add('hidden');
            gamePlayerStatus.innerHTML = ''; // Clear player pods
            gameCountdownOverlay.classList.add('hidden');
            gameVotingOverlay.classList.add('hidden');
            gameResultDisplay.classList.add('hidden');
            votingOptions.innerHTML = '';
            votingOptions.classList.remove('hidden'); // Ensure it's not hidden for next game
            votingTitle.classList.remove('hidden'); // Ensure it's not hidden
            votingInstructions.classList.remove('hidden'); // Ensure it's not hidden
            
            lobbyChatInput.disabled = false;
            lobbyChatSendBtn.disabled = false;
            lobbyChatInput.placeholder = "پیام خود را بنویسید...";
            lobbyChatInput.value = ''; // Clear any previous input

            // Ensure all overlays are hidden (explicitly display: none for immediate effect if needed)
            gameCountdownOverlay.style.display = 'none';
            gameVotingOverlay.style.display = 'none';
        }

        // NEW: Theme Configurations
        const themeConfigs = {
            'classic': {
                displayName: 'کلاسیک',
                bodyClass: 'theme-classic',
                buttonClass: 'btn-brown-classic'
            },
            'cyberpunk': {
                displayName: 'سایبرپانک',
                bodyClass: 'theme-cyberpunk',
                buttonClass: 'btn-purple-classic'
            },
            'forest': {
                displayName: 'جنگلی',
                bodyClass: 'theme-forest',
                buttonClass: 'btn-green-classic'
            },
            'ocean': {
                displayName: 'اقیانوس',
                bodyClass: 'theme-ocean',
                buttonClass: 'btn-blue-classic'
            },
            'minimal': {
                displayName: 'مینیمال',
                bodyClass: 'theme-minimal',
                buttonClass: 'btn-gray-classic'
            }
        };

        /**
         * Applies the specified theme to the body and saves it to user profile.
         * @param {string} themeName - The key of the theme to apply (e.g., 'classic', 'cyberpunk').
         */
        async function applyTheme(themeName) {
            let config = themeConfigs[themeName];
            if (!config) {
                console.warn(`Theme "${themeName}" not found. Falling back to 'classic'.`);
                themeName = 'classic';
                config = themeConfigs['classic'];
            }

            // Remove all existing theme classes from the body
            Object.values(themeConfigs).forEach(conf => {
                document.body.classList.remove(conf.bodyClass);
            });

            // Add the new theme class to the body
            document.body.classList.add(config.bodyClass);
            currentTheme = themeName; // Update global state

            // Update active button visual in modal if it's open
            updateThemeButtonsActiveState();

            // Save selected theme to user's profile in Firebase
            if (auth.currentUser && currentUserData && currentUserData.theme !== themeName) {
                try {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                    await updateDoc(userProfileRef, { theme: themeName });
                    console.log(`Theme "${themeName}" saved to user profile.`);
                } catch (error) {
                    console.error("Error saving theme to user profile:", error);
                    // This error shouldn't prevent theme application, just means it might not persist.
                }
            } else if (auth.currentUser && !currentUserData) {
                console.warn("User data not fully loaded, cannot save theme yet.");
            }
        }

        /**
         * Populates the theme selection buttons and sets the active state.
         */
        function populateThemeButtons() {
            themeButtonsContainer.innerHTML = ''; // Clear existing buttons

            for (const themeKey in themeConfigs) {
                const theme = themeConfigs[themeKey];
                const button = document.createElement('button');
                button.className = `classic-btn ${theme.buttonClass} text-base sm:text-lg theme-button`;
                button.dataset.theme = themeKey;
                button.textContent = theme.displayName;
                button.addEventListener('click', () => applyTheme(themeKey));
                themeButtonsContainer.appendChild(button);
            }
            updateThemeButtonsActiveState();
        }

        /**
         * Updates the 'active-theme-btn' class on theme buttons based on currentTheme.
         */
        function updateThemeButtonsActiveState() {
            document.querySelectorAll('.theme-button').forEach(btn => {
                if (btn.dataset.theme === currentTheme) {
                    btn.classList.add('active-theme-btn');
                } else {
                    btn.classList.remove('active-theme-btn');
                }
            });
        }


        // Function to open the main menu modal and show default view (Main Nav)
        function openMainMenuModal() {
            mainMenuModal.classList.remove('hidden');
            void mainMenuModal.offsetWidth;
            mainMenuModal.classList.add('profile-modal-enter-active');
            
            // Show main nav and hide other views
            mainMenuNav.classList.remove('hidden');
            profileView.classList.add('hidden');
            themesView.classList.add('hidden');
        }

        // Function to close the main menu modal
        function closeMainMenuModal() {
            mainMenuModal.classList.remove('profile-modal-enter-active');
            mainMenuModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                mainMenuModal.classList.add('hidden');
                mainMenuModal.classList.remove('profile-modal-leave-active');
            }, 300);
        }

        // Function to show custom message box (re-used for auth and create lobby modals)
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            console.log(`پیام نمایش داده شد (${type}): ${message}`);
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        // Wrapper for main message box
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        // Wrapper for create lobby message box
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);


        // Function to show custom confirmation modal
        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                void customConfirmModal.offsetWidth; // Trigger reflow for transition
                customConfirmModal.classList.add('profile-modal-enter-active');

                resolveCustomConfirm = resolve; // Store the resolve function

                // Event listeners for Yes/No buttons
                confirmYesBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(true);
                };
                confirmNoBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(false);
                };
            });
        }

        // Function to close the custom confirmation modal
        function closeCustomConfirm() {
            customConfirmModal.classList.remove('profile-modal-enter-active');
            customConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                customConfirmModal.classList.add('hidden');
                customConfirmModal.classList.remove('profile-modal-leave-active');
            }, 300); // Match modal transition duration
        }

        /**
         * Calls a simulated AI content moderation API to check if the lobby name is appropriate.
         * @param {string} lobbyName - The name of the lobby to check.
         * @returns {Promise<{is_appropriate: boolean, reason: string}>} - The moderation result.
         */
        async function checkLobbyNameWithAI(lobbyName) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                console.warn("Gemini API Key is not configured. Skipping lobby name moderation. Please replace 'YOUR_GEMINI_API_KEY_HERE' with your actual key.");
                return { is_appropriate: true, reason: "API key missing. Moderation skipped." };
            }

            const prompt = `As a highly rigorous and professional content moderation AI, meticulously analyze the following lobby name for compliance with the strictest community guidelines across *all* languages. You must absolutely identify and disallow any political, racist, sexual, offensive, vulgar, violent, or otherwise inappropriate content, including but not to limited to terms like "fuck", "asshole", "shit", "bitch", and their equivalents in Persian such as "کیر", "کون", "کس", "کسکش", "جنده", "حرومزاده", "بیناموس" etc., regardless of how they are spelled (e.g., phonetic or deliberate misspellings to evade detection). Your analysis should consider the context and intent where possible. Your response *must* be a JSON object: {"is_appropriate": boolean, "reason": string}. If 'is_appropriate' is false, provide a *brief, objective, and precise* reason identifying the specific type of violation (e.g., "Contains offensive language", "Political reference detected", "Violates decency standards"). If appropriate, 'reason' should be an empty string. Lobby name to analyze: "${lobbyName}"`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "is_appropriate": { "type": "BOOLEAN" }, "reason": { "type": "STRING" } }, "propertyOrdering": ["is_appropriate", "reason"] } } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorText = await response.text(); console.error("AI API HTTP Error:", response.status, response.statusText, errorText); return { is_appropriate: false, reason: `خطا در ارتباط با سرور اعتدال: ${response.statusText}.` }; }
                const result = await response.json();
                if (result && result.candidates?.[0]?.content?.parts?.[0]) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try { const parsedJson = JSON.parse(jsonString); if (typeof parsedJson.is_appropriate === 'boolean' && typeof parsedJson.reason === 'string') { return parsedJson; } else { console.warn("AI response has unexpected structure:", parsedJson); return { is_appropriate: false, reason: "پاسخ سیستم اعتدال نامفهوم است." }; } } catch (parseError) { console.error("Error parsing AI response JSON:", parseError, "Raw:", jsonString); return { is_appropriate: false, reason: "خطا در پردازش پاسخ اعتدال." }; }
                } else { console.warn("AI response missing content structure:", result); return { is_appropriate: false, reason: "عدم دریافت پاسخ معتبر از سیستم اعتدال." }; }
            } catch (error) { console.error("Error calling AI moderation API:", error); return { is_appropriate: false, reason: `خطا در ارتباط با سیستم اعتدال: ${error.message}.` }; }
        }

        // Function to check if a message is "literary/AI-like" using Gemini AI
        async function checkMessageForLiteraryAIStyle(message) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                console.warn("Gemini API Key is not configured. Skipping chat style moderation. Please replace 'YOUR_GEMINI_API_KEY_HERE' with your actual key.");
                return { is_literary: true, reason: "API key missing. Moderation skipped." };
            }

            const prompt = `As a highly sophisticated and discerning AI language analyst, you are to evaluate the provided Persian text for its adherence to a "literary" or "AI-like" style. This implies:
            1.  **Formality and Politeness:** The language should be formal, respectful, and free of slang, colloquialisms, expletives, or overly casual expressions.
            2.  **Clarity and Precision:** The message should be well-structured and convey meaning clearly, avoiding ambiguity.
            3.  **Sophistication in Vocabulary/Grammar:** While not overly complex, the vocabulary should lean towards a more elevated or precise tone, and grammar should be impeccable.
            4.  **Absence of Emojis/Informal Punctuation:** No emojis, excessive exclamation marks, or textspeak.
            
            You must decide if the message *strictly* follows these guidelines. Your response *must* be a JSON object: {"is_literary": boolean, "reason": string}.
            If 'is_literary' is false, provide a *brief and objective* reason for rejection, e.g., "Contains slang," "Informal tone," "Includes emoji," "Grammar error detected." If true, 'reason' should be an empty string.

            Persian Message to analyze: "${message}"`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { 
                contents: chatHistory, 
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            "is_literary": { "type": "BOOLEAN" }, 
                            "reason": { "type": "STRING" }
                        }, 
                        "propertyOrdering": ["is_literary", "reason"] 
                    } 
                } 
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`; // Using 1.5-flash for speed/cost

            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) { 
                    const errorText = await response.text();
                    console.error("AI API HTTP Error:", response.status, response.statusText, errorText);
                    return { is_literary: false, reason: `خطا در ارتباط با سرور هوش مصنوعی: ${response.statusText}.` }; 
                }

                const result = await response.json();
                
                if (result && result.candidates?.[0]?.content?.parts?.[0]) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try { 
                        const parsedJson = JSON.parse(jsonString); 
                        if (typeof parsedJson.is_literary === 'boolean' && typeof parsedJson.reason === 'string') { 
                            return parsedJson; 
                        } else { 
                            console.warn("AI response has unexpected structure:", parsedJson); 
                            return { is_literary: false, reason: "پاسخ سیستم بررسی نامفهوم است." }; 
                        } 
                    } catch (parseError) { 
                        console.error("Error parsing AI response JSON:", parseError, "Raw:", jsonString); 
                        return { is_literary: false, reason: "خطا در پردازش پاسخ سیستم بررسی." }; 
                    }
                } else { 
                    console.warn("AI response missing content structure:", result); 
                    return { is_literary: false, reason: "عدم دریافت پاسخ معتبر از سیستم بررسی." }; 
                }
            } catch (error) { 
                console.error("Error calling AI chat style API:", error); 
                return { is_literary: false, reason: `خطا در ارتباط با سیستم بررسی: ${error.message}.` }; 
            }
        }

        // Function to apply color to lobby names
        function formatLobbyNameWithColor(name) {
            const regex = /^\[#([0-9A-Fa-f]{6})\](.*)/; // Matches [#RRGGBB] at the start
            const match = name.match(regex);
            if (match) {
                const colorCode = match[1];
                const cleanName = match[2].trim();
                return `<span style="color:#${colorCode};">${cleanName}</span>`;
            }
            return name;
        }


        // Function to transition between screens
        function setActiveScreen(newScreen) {
            console.log(`درخواست تغییر صفحه به: ${newScreen.id}. صفحه فعلی: ${currentActiveScreen.id}`);
            
            // NEW: Do not change screen if in maintenance mode, unless it's to hide the maintenance screen itself
            if (isMaintenanceModeActive) {
                console.log("تغییر صفحه در حالت تعمیرات مسدود شد.");
                return;
            }

            if (currentActiveScreen === newScreen) return;
            
            // Cleanup old listeners and game intervals when changing screens
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            clearGameIntervals();
            resetGameUI();


            // Hide the current screen with transition
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            currentActiveScreen.setAttribute('tabindex', '-1'); // Remove focus capability
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }

            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');

                // Show the new screen with transition
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth; // Trigger reflow for transition
                newScreen.classList.add('page-transition-visible');
                newScreen.removeAttribute('tabindex');
                console.log(`صفحه ${newScreen.id} اکنون قابل مشاهده است.`);

                if (newScreen === authScreen) {
                    initializeAuthScreen(); // Ensure auth UI is reset and focused
                }
                else if (newScreen === lobbyScreen) {
                    lobbySearchInput.focus();
                }

                currentActiveScreen = newScreen;

            }, 600); // Matches CSS transition duration
        }
        
        function openKickPlayerConfirmModal(playerName, playerUid) {
            kickPlayerConfirmName.textContent = playerName;
            kickPlayerConfirmModal.classList.remove('hidden');
            void kickPlayerConfirmModal.offsetWidth;
            kickPlayerConfirmModal.classList.add('profile-modal-enter-active');
            kickedPlayerToProcess = { uid: playerUid, displayName: playerName };
        }

        function closeKickPlayerConfirmModal() {
            kickPlayerConfirmModal.classList.remove('profile-modal-enter-active');
            kickPlayerConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickPlayerConfirmModal.classList.add('hidden');
                kickPlayerConfirmModal.classList.remove('profile-modal-leave-active');
                kickedPlayerToProcess = null;
            }, 300);
        }

        function showKickedMessageModal(lobbyName) {
            kickedLobbyName.textContent = lobbyName;
            kickedMessageModal.classList.remove('hidden');
            void kickedMessageModal.offsetWidth;
            kickedMessageModal.classList.add('profile-modal-enter-active');
        }

        function closeKickedMessageModal() {
            kickedMessageModal.classList.remove('profile-modal-enter-active');
            kickedMessageModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickedMessageModal.classList.add('hidden');
                kickedMessageModal.classList.remove('profile-modal-leave-active');
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            }, 300);
        }

        function openKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('hidden');
            void kickedPlayersListModal.offsetWidth;
            kickedPlayersListModal.classList.add('profile-modal-enter-active');
            if (currentLobbyId) {
                unsubscribeKickedPlayers = setupKickedPlayersListListener(currentLobbyId);
            } else {
                kickedPlayersListContent.innerHTML = '<p class="text-center">خطا: لابی فعال یافت نشد.</p>';
            }
        }

        function closeKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('profile-modal-enter-active');
            kickedPlayersListModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickedPlayersListModal.classList.add('hidden');
                kickedPlayersListModal.classList.remove('profile-modal-leave-active');
                if (unsubscribeKickedPlayers) {
                    unsubscribeKickedPlayers();
                    unsubscribeKickedPlayers = null;
                }
            }, 300);
        }

        // NEW: Function to update coins display in header
        function updateUserCoinsDisplay() {
            if (currentUserData && currentUserData.coins !== undefined) {
                headerUserCoins.textContent = currentUserData.coins.toLocaleString('fa-IR'); // Display only number now
            } else {
                headerUserCoins.textContent = `---`;
            }
        }
        
        // =========================================================================
        // === START OF MODIFIED AUTH & REAL-TIME SETTINGS LOGIC =================
        // =========================================================================

        /**
         * MODIFIED: Sets up a real-time listener for game settings.
         * Now listens for maintenance mode status as well.
         */
        function setupGameSettingsListener() {
            if (unsubscribeGameSettings) unsubscribeGameSettings(); // Clean up previous listener

            const configRef = doc(db, `artifacts/${appId}/config/game_settings`);
            unsubscribeGameSettings = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    
                    // 1. Handle Game Entry Cost (existing logic)
                    const newCost = settings.gameEntryCost;
                    if (typeof newCost === 'number') {
                        gameEntryCost = newCost;
                        friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa-IR');
                        console.log(`هزینه ورودی بازی به صورت لحظه‌ای به ${gameEntryCost} تغییر کرد.`);
                    }

                    // 2. Handle Maintenance Mode (NEW logic)
                    const appIsEnabled = settings.isAppEnabled;
                    const message = settings.maintenanceMessage || "برنامه موقتا از دسترس خارج است. لطفاً بعدا مراجعه کنید.";

                    if (appIsEnabled === false) {
                        // Enter maintenance mode
                        if (!isMaintenanceModeActive) {
                            console.log("ورود به حالت تعمیرات...");
                            isMaintenanceModeActive = true;
                            maintenanceMessageText.textContent = message;
                            maintenanceScreen.classList.remove('hidden');
                        }
                    } else {
                        // Exit maintenance mode
                        if (isMaintenanceModeActive) {
                            console.log("خروج از حالت تعمیرات...");
                            isMaintenanceModeActive = false;
                            maintenanceScreen.classList.add('hidden');
                            
                            // After exiting maintenance, decide which screen to show
                            // This safely resets the user's view.
                            if (!isInitialAuthCheckComplete) {
                                // This case is unlikely but safe to handle
                                setActiveScreen(auth.currentUser ? mainScreen : authScreen);
                                isInitialAuthCheckComplete = true;
                            } else {
                                setActiveScreen(auth.currentUser ? mainScreen : authScreen);
                            }
                        }
                    }

                } else {
                    console.warn("سند تنظیمات بازی یافت نشد. از مقادیر پیش‌فرض استفاده می‌شود.");
                }
            }, (error) => {
                console.error("خطا در گوش دادن به تنظیمات بازی:", error);
            });
        }
        
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged triggered. User:", user ? user.uid : "logged out");

            // Part 1: Manage User Data and Listeners
            if (user) {
                if (unsubscribeUserProfile) unsubscribeUserProfile();

                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                unsubscribeUserProfile = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = { uid: user.uid, email: user.email, ...docSnap.data() };
                        headerDisplayName.textContent = currentUserData.displayName || 'کاربر ناشناس';
                        headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                        updateUserCoinsDisplay();
                        
                        const savedTheme = currentUserData.theme || 'classic';
                        if (currentTheme !== savedTheme) {
                            applyTheme(savedTheme);
                        }

                        if (!createLobbyModal.classList.contains('hidden')) {
                           renderApprovedLobbyNamesManagementList();
                           updateCreateLobbyModalUI(createLobbyModalTitle.textContent === 'مدیریت نام‌های لابی و ساخت لابی' ? 'myLobbies' : 'create');
                        }
                    } else {
                        console.warn("User profile document not found. Creating a default one.");
                        setDoc(userDocRef, {
                            displayName: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            coins: 500,
                            approvedLobbyNames: [],
                            banStatus: { isBanned: false },
                            createdAt: serverTimestamp(),
                            theme: 'classic'
                        }, { merge: true }).then(() => {
                            console.log("Default user profile created.");
                            applyTheme('classic');
                        }).catch(e => console.error("Error creating default user profile:", e));
                        currentUserData = { uid: user.uid, email: user.email, displayName: 'کاربر جدید', coins: 0, approvedLobbyNames: [], theme: 'classic' };
                        applyTheme('classic');
                    }
                }, (error) => {
                    console.error("خطا در گوش دادن به user profile:", error);
                });

            } else {
                // User is logged out. Clean up all data and listeners.
                if (unsubscribeUserProfile) unsubscribeUserProfile();
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                if (unsubscribeKickedPlayers) unsubscribeKickedPlayers();
                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                if (unsubscribePendingLobbyNames) unsubscribePendingLobbyNames();
                
                unsubscribeUserProfile = unsubscribeLobbies = unsubscribeLobbyDetail = unsubscribeKickedPlayers = unsubscribeLobbyChat = unsubscribePendingLobbyNames = null;
                clearGameIntervals();
                
                currentUserData = null;
                currentLobbyId = null;
                userHasActiveLobby = false;
                
                resetGameUI();
                updateUserCoinsDisplay();
                applyTheme('classic');
            }

            // Part 2: Manage Screen Transitions (no change needed here)
            if (!isInitialAuthCheckComplete) {
                // The settings listener will handle showing maintenance screen if needed
                if (!isMaintenanceModeActive) {
                    setActiveScreen(user ? mainScreen : authScreen);
                }
                isInitialAuthCheckComplete = true;
            } else {
                 if (!isMaintenanceModeActive) {
                    if (user && currentActiveScreen === authScreen) {
                        setActiveScreen(mainScreen);
                    } else if (!user && currentActiveScreen !== authScreen) {
                        setActiveScreen(authScreen);
                    }
                 }
            }
        });

        /**
         * MODIFIED: Initializes app-wide settings.
         * Now automatically creates maintenance mode fields if they don't exist.
         */
        async function performAsyncAppSetup() {
            console.log("Performing asynchronous app setup...");

            try {
                const configRef = doc(db, `artifacts/${appId}/config/game_settings`);
                const configSnap = await getDoc(configRef);
                
                if (!configSnap.exists()) {
                    console.log("`game_settings` document not found. Creating with default values...");
                    await setDoc(configRef, { 
                        gameEntryCost: 100,
                        isAppEnabled: true, // Default: app is ON
                        maintenanceMessage: "برنامه به زودی در دسترس خواهد بود." 
                    });
                    console.log("Default `game_settings` config created successfully.");
                } else {
                    // Document exists, check if new fields need to be added without overwriting existing ones.
                    const data = configSnap.data();
                    const updates = {};
                    if (!data.hasOwnProperty('isAppEnabled')) {
                        updates.isAppEnabled = true;
                    }
                    if (!data.hasOwnProperty('maintenanceMessage')) {
                        updates.maintenanceMessage = "برنامه به زودی در دسترس خواهد بود.";
                    }
                    if (Object.keys(updates).length > 0) {
                        console.log("Adding new maintenance fields to existing config...");
                        await updateDoc(configRef, updates);
                    }
                }
            } catch (error) {
                console.error("CRITICAL: Error initializing game settings config:", error);
                showMessageBox("خطا در بارگذاری تنظیمات بازی.", "error");
            }
            
            setupGameSettingsListener();

            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with initial custom token:", error);
                }
            }
            console.log("Firebase initialization finished.");
        }
        performAsyncAppSetup();

        // --- END OF MODIFIED LOGIC ---

        // Maps Firebase auth error codes to user-friendly Persian messages.
        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': "فرمت ایمیل نامعتبر است.",
                'auth/user-disabled': "حساب کاربری شما غیرفعال شده است.",
                'auth/user-not-found': "کاربری با این ایمیل یافت نشد.",
                'auth/wrong-password': "ایمیل یا رمز عبور اشتباه است.",
                'auth/invalid-credential': "ایمیل یا رمز عبور اشتباه است.",
                'auth/email-already-in-use': "این ایمیل قبلاً ثبت نام شده است.",
                'auth/weak-password': "رمز عبور باید حداقل ۶ کاراکتر باشد.",
                'auth/operation-not-allowed': "این نوع ورود فعال نیست.",
                'auth/network-request-failed': "مشکل در اتصال به اینترنت.",
                'auth/too-many-requests': "تعداد تلاش‌های ناموفق بیش از حد مجاز.",
            };
            return messages[errorCode] || "خطایی ناشناخته رخ داده است.";
        }

        /**
         * Checks for lobby name proposals marked as "approved" by an admin,
         * adds them to the user's profile, and updates the proposal status to "processed".
         * This function acts as the missing link between admin approval and user data.
         * NOTE: In a production environment, this is ideally handled by a Cloud Function for reliability.
         */
        async function processNewlyApprovedLobbyNames() {
            if (!auth.currentUser) return;

            const proposedLobbyNamesRef = collection(db, `artifacts/${appId}/proposedLobbyNames`);
            const qApproved = query(
                proposedLobbyNamesRef,
                where("userId", "==", auth.currentUser.uid),
                where("status", "==", "approved") // Find names marked as "approved"
            );

            try {
                const approvedSnapshot = await getDocs(qApproved);
                if (approvedSnapshot.empty) {
                    // No new approvals to process
                    return;
                }

                const namesToAdd = [];
                const docsToUpdate = [];
                approvedSnapshot.forEach(doc => {
                    namesToAdd.push(doc.data().name);
                    docsToUpdate.push(doc.ref);
                });

                // Use a batch write for atomicity: update user profile AND proposal status together
                const batch = writeBatch(db);
                
                // 1. Update the user's profile with the new names
                const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                batch.update(userProfileRef, {
                    approvedLobbyNames: arrayUnion(...namesToAdd)
                });

                // 2. Update each proposal's status to "processed" to prevent re-processing
                docsToUpdate.forEach(docRef => {
                    batch.update(docRef, { status: "processed" });
                });

                // 3. Commit all changes
                await batch.commit();
                console.log(`Processed ${namesToAdd.length} newly approved lobby names for the user.`);
                // The onSnapshot listener on the user's profile will automatically pick up this change
                // and update currentUserData, triggering UI updates.

            } catch (error) {
                console.error("Error processing newly approved lobby names:", error);
                // We can show a message, but it's a background process, so console log is sufficient
            }
        }

        // NEW: Function to render the list of approved lobby names for management (deletion)
        function renderApprovedLobbyNamesManagementList() {
            if (!currentUserData || !currentUserData.approvedLobbyNames) {
                approvedLobbyNamesManagementList.innerHTML = '<p class="text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>';
                approvedLobbyNamesManagementArea.classList.add('hidden');
                return;
            }

            const approvedNames = currentUserData.approvedLobbyNames;
            approvedLobbyNamesManagementList.innerHTML = ''; // Clear existing list

            if (approvedNames.length === 0) {
                approvedLobbyNamesManagementList.innerHTML = '<p class="text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>';
                approvedLobbyNamesManagementArea.classList.add('hidden');
            } else {
                approvedLobbyNamesManagementArea.classList.remove('hidden');
                approvedNames.forEach(name => {
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg mb-1';
                    nameDiv.innerHTML = `
                        <span>${formatLobbyNameWithColor(name)}</span>
                        <button type="button" class="classic-btn btn-red-classic text-sm py-1 px-3 delete-approved-lobby-name-btn" data-name="${name}">
                            حذف
                        </button>
                    `;
                    approvedLobbyNamesManagementList.appendChild(nameDiv);
                });

                approvedLobbyNamesManagementList.querySelectorAll('.delete-approved-lobby-name-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const nameToDelete = e.target.dataset.name;
                        const confirmed = await showCustomConfirm(`آیا مطمئن هستید که می‌خواهید نام لابی "${nameToDelete}" را حذف کنید؟`, "حذف نام لابی");
                        if (confirmed) {
                            await deleteApprovedLobbyName(nameToDelete);
                        }
                    });
                });
            }
        }

        // NEW: Function to delete an approved lobby name from user's profile
        async function deleteApprovedLobbyName(nameToDelete) {
            if (!auth.currentUser || !currentUserData) {
                showCreateLobbyMessageBox("خطا: اطلاعات کاربری در دسترس نیست.", "error");
                return;
            }

            const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
            try {
                await updateDoc(userProfileRef, {
                    approvedLobbyNames: arrayRemove(nameToDelete)
                });
                showCreateLobbyMessageBox(`نام لابی "${nameToDelete}" با موفقیت حذف شد.`, "success");
                // The onSnapshot for user profile will re-trigger and update UI.
            } catch (error) {
                console.error("Error deleting approved lobby name:", error);
                showCreateLobbyMessageBox(`خطا در حذف نام لابی: ${error.message}`, "error");
            }
        }


        // NEW: Function to update the UI of the Create Lobby modal based on mode and user data
        async function updateCreateLobbyModalUI(mode) {
            // Clear any previous pending names listener from a prior modal opening
            if (unsubscribePendingLobbyNames) {
                unsubscribePendingLobbyNames();
                unsubscribePendingLobbyNames = null;
            }

            if (!auth.currentUser || !currentUserData) {
                // Initial state if user data isn't loaded yet
                approvedLobbyNamesSelect.innerHTML = '<option value="">در حال بارگذاری اطلاعات...</option>';
                lobbyNameSelectionArea.classList.add('hidden');
                lobbyNameProposalArea.classList.add('hidden');
                pendingLobbyNamesArea.classList.add('hidden');
                approvedLobbyNamesManagementArea.classList.add('hidden'); // Also hide management area
                submitCreateLobbyBtn.classList.add('hidden'); // Hide create button too
                submitLobbyNameForApprovalBtn.classList.add('hidden');
                return;
            }

            const approvedNames = currentUserData.approvedLobbyNames || [];
            
            // Clear existing options for the dropdown
            approvedLobbyNamesSelect.innerHTML = '<option value="">نام لابی را انتخاب کنید</option>';
            
            // Populate dropdown if approved names exist
            if (approvedNames.length > 0) {
                approvedNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.innerHTML = formatLobbyNameWithColor(name);
                    approvedLobbyNamesSelect.appendChild(option);
                });
                lobbyNameSelectionArea.classList.remove('hidden'); // Show the dropdown
                submitCreateLobbyBtn.disabled = true; // Still disabled until selection
                submitCreateLobbyBtn.classList.remove('hidden'); // Make sure create button is visible
            } else {
                lobbyNameSelectionArea.classList.add('hidden'); // Hide the dropdown if no approved names
                submitCreateLobbyBtn.disabled = true;
                submitCreateLobbyBtn.classList.add('hidden'); // Hide create button if no approved names
            }

            // Manage visibility based on mode
            if (mode === 'create') {
                createLobbyModalTitle.textContent = 'ساخت لابی جدید';
                lobbyNameProposalArea.classList.remove('hidden'); // Always show proposal area in create mode
                submitLobbyNameForApprovalBtn.classList.remove('hidden'); // Always show its button
            } else { // mode === 'myLobbies'
                createLobbyModalTitle.textContent = 'مدیریت نام‌های لابی و ساخت لابی'; // More accurate title
                lobbyNameProposalArea.classList.add('hidden'); // Hide proposal area in myLobbies mode
                submitLobbyNameForApprovalBtn.classList.add('hidden'); // Hide its button
            }

            // Render and manage approved names list for deletion (visible in both modes)
            renderApprovedLobbyNamesManagementList();

            // Set up listener for PENDING requests for the current user
            const proposedLobbyNamesRef = collection(db, `artifacts/${appId}/proposedLobbyNames`);
            const qPending = query(
                proposedLobbyNamesRef,
                where("userId", "==", auth.currentUser.uid),
                where("status", "==", "pending")
            );

            unsubscribePendingLobbyNames = onSnapshot(qPending, (snapshot) => {
                pendingLobbyNamesList.innerHTML = ''; // Clear existing list
                const pendingCount = snapshot.size;
                if (pendingCount === 0) {
                    pendingLobbyNamesList.innerHTML = '<p class="text-center">هیچ نام لابی در انتظار تایید ندارید.</p>';
                    pendingLobbyNamesArea.classList.add('hidden');
                } else {
                    pendingLobbyNamesArea.classList.remove('hidden');
                    snapshot.forEach(doc => {
                        const proposal = doc.data();
                        const proposalDiv = document.createElement('div');
                        proposalDiv.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg mb-1';
                        proposalDiv.innerHTML = `<span>${formatLobbyNameWithColor(proposal.name)}</span><span class="text-yellow-400 text-sm">در حال تایید...</span>`;
                        pendingLobbyNamesList.appendChild(proposalDiv);
                    });
                }

                // Control proposal input based on pending limit (only for 'create' mode)
                if (mode === 'create') {
                    if (pendingCount >= MAX_PENDING_PROPOSALS) {
                        lobbyProposalMessage.textContent = `شما ${pendingCount} درخواست نام لابی در انتظار تایید دارید. تا زمانی که درخواست‌های شما بررسی نشوند، نمی‌توانید درخواست جدیدی ارسال کنید.`;
                        lobbyProposalMessage.classList.remove('text-gray-400');
                        lobbyProposalMessage.classList.add('text-red-400');
                        submitLobbyNameForApprovalBtn.disabled = true;
                        proposedLobbyNameInput.disabled = true;
                        proposedLobbyNameInput.placeholder = "تعداد درخواست‌های شما به حداکثر رسیده است.";
                    } else {
                        lobbyProposalMessage.textContent = "بعد از ارسال، ادمین نام لابی شما را بررسی و تأیید می‌کند. سپس می‌توانید از آن نام استفاده کنید.";
                        lobbyProposalMessage.classList.remove('text-red-400');
                        lobbyProposalMessage.classList.add('text-gray-400');
                        submitLobbyNameForApprovalBtn.disabled = false;
                        proposedLobbyNameInput.disabled = false;
                        proposedLobbyNameInput.placeholder = "مثال: [#FFD700]لابی طلایی من";
                    }
                }
            }, (error) => {
                console.error("Error listening to pending lobby names:", error);
                pendingLobbyNamesList.innerHTML = `<p class="text-red-400 text-center">خطا در بارگذاری درخواست‌های شما.</p>`;
            });

            proposedLobbyNameInput.value = ''; // Clear proposed input field
            if (mode === 'create' && approvedNames.length === 0) {
                proposedLobbyNameInput.focus();
            } else if (approvedNames.length > 0) {
                 approvedLobbyNamesSelect.focus();
            }
        }


        async function openCreateLobbyModal(mode = 'create') {
            if (!auth.currentUser || !currentUserData) {
                showCreateLobbyMessageBox("ابتدا وارد حساب کاربری خود شوید.", "error");
                return;
            }

            await processNewlyApprovedLobbyNames();
            
            // Check if the user is already a host of an active lobby (only relevant for 'create' mode)
            if (userHasActiveLobby && currentLobbyId && mode === 'create') {
                try {
                    const activeLobbyRef = doc(db, `global_lobbies`, currentLobbyId);
                    const activeLobbySnap = await getDoc(activeLobbyRef);
                    if (activeLobbySnap.exists() && activeLobbySnap.data().hostId === auth.currentUser.uid && activeLobbySnap.data().status !== 'ended') {
                        showCreateLobbyMessageBox("شما از قبل یک لابی فعال ساخته‌اید. برای مدیریت آن به صفحه لابی برگردید.", "info");
                        closeCreateLobbyModal();
                        return;
                    } else if (activeLobbySnap.exists() && activeLobbySnap.data().status === 'ended' && activeLobbySnap.data().hostId === auth.currentUser.uid) {
                        userHasActiveLobby = false;
                        currentLobbyId = null;
                    }
                } catch (error) {
                    console.error("Error checking active lobby for host:", error);
                }
            }

            createLobbyModal.classList.remove('hidden');
            void createLobbyModal.offsetWidth;
            createLobbyModal.classList.add('profile-modal-enter-active');
            createLobbyMessageBox.classList.add('hidden'); 
            
            createLobbyForm.reset();
            document.querySelector('input[name="lobby-type"][value="public"]').checked = true;
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('input[value="public"]').nextElementSibling.classList.add('active');
            newLobbyPasswordField.classList.add('hidden');
            gameDurationInput.value = 5;

            // Use the new helper function to manage UI visibility
            await updateCreateLobbyModalUI(mode); 

            // Special handling for 'myLobbies' mode: show specific message if no approved lobbies to manage
            if (mode === 'myLobbies' && (!currentUserData.approvedLobbyNames || currentUserData.approvedLobbyNames.length === 0)) {
                 showCreateLobbyMessageBox("شما هیچ نام لابی تایید شده‌ای برای مدیریت یا ساخت لابی ندارید.", "info");
            }
        }

        function closeCreateLobbyModal() {
            createLobbyModal.classList.remove('profile-modal-enter-active');
            createLobbyModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                createLobbyModal.classList.add('hidden');
                createLobbyModal.classList.remove('profile-modal-leave-active');
                                createLobbyForm.reset();

                newLobbyPasswordField.classList.add('hidden');
                document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('input[value="public"]').nextElementSibling.classList.add('active');
                gameDurationInput.value = 5; 
                lobbyProposalMessage.classList.remove('text-red-400'); 
                lobbyProposalMessage.classList.add('text-gray-400');
                
                // Ensure all related areas are hidden when closing
                lobbyNameSelectionArea.classList.add('hidden');
                lobbyNameProposalArea.classList.add('hidden');
                pendingLobbyNamesArea.classList.add('hidden');
                approvedLobbyNamesManagementArea.classList.add('hidden');
                submitCreateLobbyBtn.classList.add('hidden'); // Hide it again on close
                submitLobbyNameForApprovalBtn.classList.add('hidden'); // Hide it again on close


                if (unsubscribePendingLobbyNames) {
                    unsubscribePendingLobbyNames();
                    unsubscribePendingLobbyNames = null;
                }
            }, 300);
        }
        
        // --- Firebase Lobby Functions ---
        async function createLobby(lobbyName, userId, displayName, lobbyType, password, gameDurationMinutes) {
            try {
                const creatorDisplayName = displayName && displayName.trim() !== '' ? displayName : 'ناشناس';
        
                const userLobbiesQuery = query(
                    collection(db, `global_lobbies`),
                    where("hostId", "==", userId),
                    where("status", "in", ["waiting", "playing"])
                );
                const userLobbiesSnapshot = await getDocs(userLobbiesQuery);
                if (!userLobbiesSnapshot.empty) {
                    throw new Error("شما از قبل یک لابی فعال ساخته‌اید. لطفاً ابتدا لابی قبلی خود را ببندید.");
                }
        
                const lobbiesRef = collection(db, `global_lobbies`);
                
                const newLobbyData = {
                    name: lobbyName,
                    hostId: userId,
                    status: "waiting",
                    type: lobbyType,
                    players: {
                        [userId]: creatorDisplayName // Using a map: { "uid": "displayName" }
                    },
                    kickedPlayers: [], // Still an array of objects
                    createdAt: serverTimestamp(),
                    isChatLocked: false, // NEW: Chat is open by default
                    gameSettings: { 
                        maxPlayers: 4, 
                        gameDurationMinutes: gameDurationMinutes // NEW
                    }
                };
        
                if (lobbyType === 'private') {
                    newLobbyData.password = password;
                }
        
                const newLobbyRef = await addDoc(lobbiesRef, newLobbyData);
                
                console.log(`لابی ${lobbyType} با ID ساخته شد: `, newLobbyRef.id);
                userHasActiveLobby = true;
                return newLobbyRef.id;
            } catch (e) {
                console.error("خطا در ساخت لابی: ", e);
                throw e;
            }
        }
        
        async function closeLobby(lobbyId, userId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { showMessageBox("لابی مورد نظر یافت نشد.", "error"); return; }
                const lobbyData = lobbySnap.data();
                if (lobbyData.hostId !== userId) { showMessageBox("شما اجازه بستن این لابی را ندارید.", "error"); return; }

                const lobbyElement = document.querySelector(`[data-lobby-id="${lobbyId}"]`);
                if (lobbyElement) {
                    lobbyElement.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                await deleteDoc(lobbyRef);
                showMessageBox(`لابی "${lobbyData.name}" با موفقیت بسته شد.`, "success");
                userHasActiveLobby = false; // Host just closed their lobby
                if (currentLobbyId === lobbyId) currentLobbyId = null;

                clearGameIntervals();
                resetGameUI();
            } catch (e) {
                console.error("خطا در بستن لابی: ", e);
                showMessageBox(`خطا در بستن لابی: ${e.message}`, "error");
            }
        }
        
        function setupLobbyListener(searchTerm = '') {
            console.log(`شروع راه‌اندازی Listener لابی‌ها با عبارت جستجو: "${searchTerm}"`);

            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            clearGameIntervals();
            resetGameUI(); 

            lobbiesList.innerHTML = '<p>در حال بارگذاری لابی‌ها...</p>';
            userHasActiveLobby = false; // Reset this flag when entering lobby list view

            const allLobbiesQuery = query(
                collection(db, `global_lobbies`),
                where("status", "in", ["waiting", "playing"]) // Check all active lobbies
            );
            getDocs(allLobbiesQuery).then(allLobbiesSnapshot => {
                if (auth.currentUser) {
                    let foundActiveLobby = false;
                    allLobbiesSnapshot.forEach(doc => {
                        const lobbyData = doc.data();
                        if (lobbyData.players && lobbyData.players[auth.currentUser.uid]) {
                            foundActiveLobby = true;
                            userHasActiveLobby = true;
                            currentLobbyId = doc.id; 
                        }
                    });
                    if (!foundActiveLobby) { // If user was in a lobby but it's now gone/ended
                        userHasActiveLobby = false;
                        currentLobbyId = null;
                    }
                }
                console.log(`User has active lobby: ${userHasActiveLobby} (ID: ${currentLobbyId})`);
            }).catch(error => {
                console.error("Error checking user's active lobby status:", error);
            });
        
            const normalizedSearchTerm = searchTerm.toLowerCase();
            const q = query(
                collection(db, `global_lobbies`), 
                where("status", "==", "waiting") 
            );
        
            const unsubscribe = onSnapshot(q, (snapshot) => {
                lobbiesList.innerHTML = '';
        
                let lobbiesToDisplay = [];

                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    const playersMap = lobby.players || {};
                    
                    const hostDisplayName = (playersMap[lobby.hostId] || 'ناشناس').toLowerCase();
                    const lobbyName = (lobby.name || '').toLowerCase();
                    
                    if (normalizedSearchTerm === '' || lobbyName.includes(normalizedSearchTerm) || hostDisplayName.includes(normalizedSearchTerm)) {
                        lobbiesToDisplay.push(lobby);
                    }
                });
                
                getDocs(query(collection(db, `global_lobbies`), where("status", "==", "playing"))).then(playingSnapshot => {
                    activeGamesCount.textContent = playingSnapshot.size;
                });
                
                lobbiesToDisplay.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        
                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p>لابی با این مشخصات یافت نشد.</p>';
                } else {
                    lobbiesToDisplay.forEach((lobby) => {
                        const playersMap = lobby.players || {};
                        const playerCount = Object.keys(playersMap).length;
                        const maxPlayers = lobby.gameSettings?.maxPlayers || 4;
                        const hostDisplayName = playersMap[lobby.hostId] || 'ناشناس';
                        const isCurrentUserHostOfThisLobby = auth.currentUser && lobby.hostId === auth.currentUser.uid;
                        const isCurrentUserKicked = auth.currentUser && lobby.kickedPlayers?.some(p => p.uid === auth.currentUser.uid);
                        const canJoinThisLobby = auth.currentUser && !userHasActiveLobby && playerCount < maxPlayers && !isCurrentUserKicked;
        
                        const lockIconHtml = lobby.type === 'private' 
                            ? `<svg xmlns="http://www.w3.org/2000/svg" class="lobby-lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` 
                            : '';
                        
                        const formattedLobbyName = formatLobbyNameWithColor(lobby.name);
        
                        let joinButtonHtml = '';
                        if (isCurrentUserKicked) {
                             joinButtonHtml = `<button class="join-lobby-btn classic-btn btn-red-classic opacity-50 cursor-not-allowed" disabled>اخراج شده‌اید</button>`;
                        } else if (isCurrentUserHostOfThisLobby) {
                            joinButtonHtml = `<button data-lobby-id="${lobby.id}" class="view-my-lobby-btn classic-btn btn-blue-classic">ورود به لابی من</button>`;
                        } else if (canJoinThisLobby) {
                            joinButtonHtml = `<button data-lobby-id="${lobby.id}" data-lobby-type="${lobby.type || 'public'}" data-lobby-name="${lobby.name}" class="join-lobby-btn classic-btn btn-blue-classic">ورود به لابی</button>`;
                        } else {
                            joinButtonHtml = `<button class="join-lobby-btn classic-btn btn-blue-classic opacity-50 cursor-not-allowed" disabled>ورود به لابی</button>`;
                        }
                        
                        const closeButtonHtml = isCurrentUserHostOfThisLobby 
                            ? `<button data-lobby-id="${lobby.id}" class="close-lobby-btn classic-btn btn-red-classic">بستن لابی</button>` : '';
        
                        const lobbyItem = document.createElement('div');
                        lobbyItem.className = 'lobby-item mb-3 w-full';
                        lobbyItem.dataset.lobbyId = lobby.id;
                        lobbyItem.innerHTML = `
                            <div class="mb-2 sm:mb-0 text-center sm:text-right">
                                <h3 class="text-xl font-bold">${lockIconHtml}${formattedLobbyName}</h3>
                                <p class="text-sm">سازنده: ${hostDisplayName}</p>
                                <p class="text-sm">بازیکنان: ${playerCount}/${maxPlayers}</p>
                            </div>
                            <div class="lobby-actions">
                                ${closeButtonHtml}
                                ${joinButtonHtml}
                            </div>
                        `;
                        lobbiesList.appendChild(lobbyItem);
                    });
                }
                
                lobbiesList.querySelectorAll('.join-lobby-btn:not([disabled])').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.currentTarget.dataset.lobbyId;
                        const lobbyType = e.currentTarget.dataset.lobbyType;
                        const lobbyName = e.currentTarget.dataset.lobbyName;
                        
                        if (lobbyType === 'private') {
                            openEnterPasswordModal(lobbyId, lobbyName);
                        } else {
                            try {
                                await joinLobby(lobbyId, auth.currentUser.uid, currentUserData.displayName);
                            } catch (error) {
                                console.error("Error joining public lobby:", error);
                                showMessageBox(`خطا در ورود به لابی: ${error.message}`, "error");
                            }
                        }
                    });
                });
        
                lobbiesList.querySelectorAll('.view-my-lobby-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const lobbyId = e.target.dataset.lobbyId;
                        if (lobbyId && auth.currentUser) {
                            currentLobbyId = lobbyId;
                            setActiveScreen(lobbyDetailScreen);
                            unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
                        }
                    });
                });
        
                lobbiesList.querySelectorAll('.close-lobby-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.target.dataset.lobbyId;
                        if (lobbyId && auth.currentUser) {
                            const lobbyName = e.target.closest('.lobby-item').querySelector('h3').textContent;
                            const cleanLobbyName = lobbyName.replace(/<[^>]*>/g, '');
                            const confirmed = await showCustomConfirm(`آیا مطمئن هستید که می‌خواهید لابی "${cleanLobbyName}" را ببندید؟`);
                            if (confirmed) {
                                await closeLobby(lobbyId, auth.currentUser.uid);
                            }
                        }
                    });
                });
        
            }, (error) => {
                console.error("خطا در گوش دادن به لابی‌ها: ", error);
                lobbiesList.innerHTML = `<p class="text-red-400">خطا در بارگذاری لیست لابی‌ها. (${error.message})</p>`;
            });
        
            return unsubscribe;
        }

        async function joinLobby(lobbyId, userId, displayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { throw new Error("لابی یافت نشد."); }
                
                const lobbyData = lobbySnap.data();
                const playersMap = lobbyData.players || {};
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                const kickedPlayers = lobbyData.kickedPlayers || [];

                if (kickedPlayers.some(p => p.uid === userId)) {
                    throw new Error("شما از این لابی اخراج شده‌اید.");
                }
                if (playersMap[userId]) { // Player is already in
                    currentLobbyId = lobbyId;
                    userHasActiveLobby = true; // Set this to true as user is in a lobby
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
                    return;
                }
                if (Object.keys(playersMap).length >= maxPlayers) { throw new Error("لابی پر است."); }
                
                // Add player to map using dot notation for the key
                await updateDoc(lobbyRef, {
                    [`players.${userId}`]: displayName
                });
                
                showMessageBox(`شما به لابی "${lobbyData.name}" وارد شدید.`, "success");
                
                currentLobbyId = lobbyId;
                userHasActiveLobby = true; // Set this to true as user just joined a lobby
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
            } catch (e) {
                console.error("خطا در ورود به لابی: ", e);
                throw e; // Re-throw to be caught by the caller
            }
        }
        
        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to lobby details for ID: ${lobbyId}`);
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            clearGameIntervals();
            resetGameUI();

            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const unsubscribe = onSnapshot(lobbyRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    showMessageBox("لابی که در آن بودید بسته شد.", "info");
                    currentLobbyId = null;
                    userHasActiveLobby = false;
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                    return;
                }
                
                const lobbyData = docSnap.data();
                const isCurrentUserHost = auth.currentUser && lobbyData.hostId === auth.currentUser.uid;
                const myUid = auth.currentUser.uid;

                if (!lobbyData.players || !lobbyData.players[myUid]) {
                    console.log("Current user is no longer in this lobby's player list.");
                    if (lobbyData.kickedPlayers?.some(p => p.uid === myUid)) {
                        showKickedMessageModal(lobbyData.name);
                    } else {
                        showMessageBox("شما از لابی خارج شدید.", "info");
                        currentLobbyId = null;
                        userHasActiveLobby = false;
                        setActiveScreen(lobbyScreen);
                        unsubscribeLobbies = setupLobbyListener('');
                    }
                    return;
                }

                if (lobbyData.status === 'playing' && lobbyData.gameState) {
                    setupGameUI(lobbyId, lobbyData);
                    hostActionsContainer.style.display = 'none';
                    leaveLobbyBtn.classList.add('hidden');
                    return;
                } else {
                    resetGameUI();
                    if (isCurrentUserHost) {
                        hostActionsContainer.style.display = 'flex';
                        leaveLobbyBtn.classList.remove('hidden');
                        leaveLobbyBtn.textContent = 'بستن لابی';
                    } else {
                        hostActionsContainer.style.display = 'none';
                        leaveLobbyBtn.classList.add('hidden');
                    }
                }

                const playersMap = lobbyData.players || {};
                const playerCount = Object.keys(playersMap).length;
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                const isChatLocked = lobbyData.isChatLocked || false;

                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                unsubscribeLobbyChat = setupLobbyChatListener(lobbyId, lobbyData.hostId);

                detailLobbyName.innerHTML = formatLobbyNameWithColor(lobbyData.name);
                detailHostName.textContent = `سازنده: ${playersMap[lobbyData.hostId] || 'ناشناس'}`;
                detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                playerListContainer.innerHTML = '';
                gamePlayerStatus.innerHTML = ''; 
                const playerList = Object.entries(playersMap).map(([uid, displayName]) => ({ uid, displayName }));

                for (const player of playerList) {
                    const isHost = player.uid === lobbyData.hostId;
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-list-item';
                    if (isHost) playerItem.classList.add('is-host');

                    const kickButtonHtml = (isCurrentUserHost && !isHost) 
                        ? `<button class="kick-player-btn" data-player-uid="${player.uid}" data-player-name="${player.displayName}">اخراج</button>` 
                        : '';
                    
                    const hostLabelHtml = isHost ? '<span class="host-label">(سازنده)</span>' : '';

                    playerItem.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 lucide lucude-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <span class="player-name">${player.displayName}</span>
                            ${hostLabelHtml}
                        </div>
                        ${kickButtonHtml}
                    `;
                    playerListContainer.appendChild(playerItem);
                }

                playerListContainer.querySelectorAll('.kick-player-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                       openKickPlayerConfirmModal(e.currentTarget.dataset.playerName, e.currentTarget.dataset.playerUid);
                    });
                });

                if (isCurrentUserHost) {
                    startGameBtn.disabled = playerCount !== maxPlayers;
                    startGameBtn.textContent = `شروع بازی (${playerCount}/${maxPlayers})`;
                    toggleChatLockBtn.textContent = isChatLocked ? 'باز کردن چت' : 'قفل کردن چت';
                }

                if (isChatLocked && !isCurrentUserHost) {
                    lobbyChatInput.disabled = true;
                    lobbyChatSendBtn.disabled = true;
                    lobbyChatInput.placeholder = "چت توسط سازنده قفل شده است";
                } else {
                    lobbyChatInput.disabled = false;
                    lobbyChatSendBtn.disabled = false;
                    lobbyChatInput.placeholder = "پیام خود را بنویسید...";
                }

            }, (error) => {
                console.error("Lobby detail listener error:", error);
                showMessageBox("خطا در بارگذاری جزئیات لابی.", "error");
                currentLobbyId = null;
                userHasActiveLobby = false;
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            });
            return unsubscribe;
        }

        async function leaveLobby() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const userId = auth.currentUser.uid;
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) {
                    showMessageBox("لابی مورد نظر یافت نشد.", "error");
                    currentLobbyId = null;
                    userHasActiveLobby = false;
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                    return;
                }
                const isHost = lobbySnap.data().hostId === userId;
                if (isHost) {
                    const confirmed = await showCustomConfirm("شما سازنده لابی هستید. خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟", "بستن لابی");
                    if (confirmed) {
                        await deleteDoc(lobbyRef);
                    }
                }
            } catch (e) { console.error("Error leaving lobby:", e); showMessageBox("خطا در ترک لابی.", "error"); }
        }

        async function kickPlayer(lobbyId, playerToKickUid, playerToKickDisplayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    [`players.${playerToKickUid}`]: deleteField(),
                    kickedPlayers: arrayUnion({ uid: playerToKickUid, displayName: playerToKickDisplayName })
                });
                showMessageBox(`بازیکن "${playerToKickDisplayName}" اخراج شد.`, "success");
                closeKickPlayerConfirmModal();
            } catch (e) { console.error("Error kicking player:", e); showMessageBox("خطا در اخراج بازیکن.", "error"); }
        }

        async function unkickPlayer(lobbyId, playerToUnkickUid) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists()) {
                    const kickedPlayers = lobbySnap.data().kickedPlayers || [];
                    const playerToUnkick = kickedPlayers.find(p => p.uid === playerToUnkickUid);
                    if (playerToUnkick) {
                        await updateDoc(lobbyRef, { kickedPlayers: arrayRemove(playerToUnkick) });
                        showMessageBox(`بازیکن "${playerToUnkick.displayName}" می‌تواند دوباره وارد شود.`, "success");
                    }
                }
            } catch (e) { console.error("Error unkicking player:", e); showMessageBox("خطا در بازگرداندن بازیکن.", "error"); }
        }

        function setupKickedPlayersListListener(lobbyId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                kickedPlayersListContent.innerHTML = '';
                if (docSnap.exists()) {
                    const kickedPlayers = docSnap.data().kickedPlayers || [];
                    const validKickedPlayers = kickedPlayers.filter(p => p && p.displayName && p.uid);

                    if (validKickedPlayers.length === 0) {
                        kickedPlayersListContent.innerHTML = '<p class="text-center">هیچ بازیکنی اخراج نشده است.</p>';
                    } else {
                        validKickedPlayers.forEach(player => {
                            const playerDiv = document.createElement('div');
                            playerDiv.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg mb-2';
                            playerDiv.innerHTML = `<span>${player.displayName}</span><button data-player-uid="${player.uid}" class="unkick-player-btn classic-btn btn-green-classic text-sm py-1 px-3">بازگرداندن</button>`;
                            kickedPlayersListContent.appendChild(playerDiv);
                        });
                        kickedPlayersListContent.querySelectorAll('.unkick-player-btn').forEach(button => {
                            button.addEventListener('click', (e) => unkickPlayer(currentLobbyId, e.target.dataset.playerUid));
                        });
                    }
                }
            });
        }
        
        async function sendLobbyMessage(lobbyId, text) {
            if (!text.trim() || !auth.currentUser || !currentUserData) return;
            
            const lobbyDocRef = doc(db, `global_lobbies`, lobbyId);
            const lobbySnap = await getDoc(lobbyDocRef);
            if (lobbySnap.exists() && lobbySnap.data().status === 'playing') {
                const moderationResult = await checkMessageForLiteraryAIStyle(text);
                if (!moderationResult.is_literary) {
                    showMessageBox(`پیام شما به دلیل لحن نامناسب ارسال نشد: ${moderationResult.reason}`, "error");
                    return;
                }
            }

            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            try {
                await addDoc(messagesRef, {
                    text: text.trim(),
                    senderUid: auth.currentUser.uid,
                    senderName: currentUserData.displayName,
                    timestamp: serverTimestamp(),
                    isDeleted: false
                });
                lobbyChatInput.value = '';
            } catch (error) {
                console.error("Error sending chat message:", error);
                showMessageBox("خطا در ارسال پیام.", "error");
            }
        }
        
        async function deleteLobbyMessage(lobbyId, messageId) {
            const messageRef = doc(db, `global_lobbies/${lobbyId}/messages`, messageId);
            try {
                await updateDoc(messageRef, {
                    text: "[این پیام حذف شده است]",
                    isDeleted: true
                });
            } catch (error) {
                console.error("Error deleting message:", error);
                showMessageBox("خطا در حذف پیام.", "error");
            }
        }

        function setupLobbyChatListener(lobbyId, hostId) {
            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            return onSnapshot(q, (snapshot) => {
                const wasScrolledToBottom = lobbyChatMessages.scrollTop + lobbyChatMessages.clientHeight >= lobbyChatMessages.scrollHeight - 20;
                
                lobbyChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    const messageId = doc.id;
                    const isCurrentUserMsg = messageData.senderUid === auth.currentUser.uid;
                    const isCurrentUserHost = auth.currentUser.uid === hostId;

                    const canDelete = !messageData.isDeleted && (isCurrentUserMsg || isCurrentUserHost);

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('chat-message');
                    if (isCurrentUserMsg) {
                        messageDiv.classList.add('current-user');
                    }
                    
                    const deleteButtonHtml = canDelete ? `
                        <button class="delete-message-btn" data-message-id="${messageId}" title="حذف پیام">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    ` : '';

                    const messageContentHtml = messageData.isDeleted ? `
                        <p class="message-text-deleted">${messageData.text}</p>
                    ` : `
                        <span class="sender-name">${messageData.senderName}</span>
                        <p class="message-text">${messageData.text}</p>
                    `;

                    messageDiv.innerHTML = `
                        <div class="chat-message-content">
                            ${messageContentHtml}
                        </div>
                        ${deleteButtonHtml}
                    `;
                    lobbyChatMessages.appendChild(messageDiv);
                });

                if (wasScrolledToBottom) {
                    lobbyChatMessages.scrollTop = lobbyChatMessages.scrollHeight;
                }

            }, (error) => {
                console.error("Lobby chat listener error:", error);
                console.warn("Could not load chat messages:", error.message);
            });
        }
        
        // --- Game Logic Functions (NEW) ---

        async function initializeGameInFirestore(lobbyId, lobbyData) {
            const playerUIDs = Object.keys(lobbyData.players);
            const playerNames = lobbyData.players;

            if (playerUIDs.length !== 4) {
                throw new Error("برای شروع بازی باید 4 بازیکن در لابی باشند.");
            }

            const currentEntryCost = gameEntryCost;

            for (const playerId of playerUIDs) {
                const playerProfileRef = doc(db, `artifacts/${appId}/users/${playerId}/profile/data`);
                const playerProfileSnap = await getDoc(playerProfileRef);
                if (!playerProfileSnap.exists() || (playerProfileSnap.data().coins || 0) < currentEntryCost) {
                    throw new Error(`بازیکن ${playerNames[playerId]} سکه کافی برای شروع بازی ندارد. (نیاز: ${currentEntryCost} سکه)`);
                }
            }

            const batch = writeBatch(db);
            for (const playerId of playerUIDs) {
                const playerProfileRef = doc(db, `artifacts/${appId}/users/${playerId}/profile/data`);
                batch.update(playerProfileRef, { coins: increment(-currentEntryCost) });
            }
            await batch.commit();
            console.log(`Successfully deducted ${currentEntryCost} coins from all players.`);

            if (currentUserData && playerUIDs.includes(currentUserData.uid)) {
                currentUserData.coins -= currentEntryCost;
                updateUserCoinsDisplay();
            }

            const shuffledPlayers = [...playerUIDs].sort(() => Math.random() - 0.5);
            const roles = {};
            roles[shuffledPlayers[0]] = 'AI';
            for (let i = 1; i < shuffledPlayers.length; i++) {
                roles[shuffledPlayers[i]] = 'Human';
            }

            const gameDurationMinutes = lobbyData.gameSettings?.gameDurationMinutes || 5;
            const countdownDurationSeconds = 5;

            const initialGameState = {
                players: playerUIDs,
                playerNames: playerNames,
                roles: roles,
                status: 'countdown',
                winner: null,
                winReason: null,
                gameStartTimestamp: null,
                gameDurationSeconds: gameDurationMinutes * 60,
                countdownEndTime: Date.now() + countdownDurationSeconds * 1000 + 500,
                votes: {},
                aiScore: 0,
                humanScore: 0
            };

            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    gameState: initialGameState,
                    status: "playing"
                });
                console.log(`Game state initialized for lobby ${lobbyId}`);
            } catch (error) {
                console.error("Error initializing game state:", error);
                await updateDoc(lobbyRef, { status: "waiting" });
                throw new Error("Failed to initialize game.");
            }
        }
        
        function setupGameUI(lobbyId, lobbyData) {
            console.log(`Setting up game UI for lobby ID: ${lobbyId}`);
            clearGameIntervals();
            resetGameUI();

            const gameState = lobbyData.gameState;
            const myUid = auth.currentUser.uid;
            
            gameInfoPanel.classList.remove('hidden');
                        leaveGameFromLobbyBtn.classList.remove('hidden');
            
            hostActionsContainer.style.display = 'none';
            leaveLobbyBtn.classList.add('hidden');
            
            playerListContainer.innerHTML = ''; 

            gamePlayerStatus.innerHTML = '';
            if (Array.isArray(gameState.players) && lobbyData.players) {
                gameState.players.forEach(pUid => {
                    const playerPod = document.createElement('div');
                    playerPod.className = `game-player-pod flex-grow`;
                    const isAI = gameState.roles[pUid] === 'AI';
                    playerPod.classList.add(isAI ? 'is-ai' : 'is-human');
                    if (pUid === myUid) {
                        myRole.textContent = isAI ? 'هوش مصنوعی' : 'انسان';
                        gameRoleDisplay.classList.remove('hidden');
                    }
                    
                    const isPlayerInLobby = lobbyData.players && lobbyData.players[pUid];
                    const playerStatusText = isPlayerInLobby ? 'آنلاین' : 'ترک کرده';
                    
                    playerPod.innerHTML = `
                        <span class="player-name">${gameState.playerNames[pUid] || 'ناشناس'}</span>
                        <span class="player-role">${isAI ? 'هوش مصنوعی' : 'انسان'}</span>
                        <span class="player-status">${playerStatusText}</span>
                    `;
                    gamePlayerStatus.appendChild(playerPod);
                });
            }


            const currentTime = Date.now();
            const lobbyRef = doc(db, 'global_lobbies', lobbyId);

            if (gameState.status === 'countdown') {
                gameCountdownOverlay.style.display = 'flex';
                gameVotingOverlay.style.display = 'none';
                gameResultDisplay.classList.add('hidden');
                gameTimerDisplay.classList.add('hidden');
                gameScoresDisplay.classList.add('hidden');

                lobbyChatInput.disabled = true;
                lobbyChatSendBtn.disabled = true;
                lobbyChatInput.placeholder = "بازی در حال شروع است...";

                let countdownSecs = Math.ceil((gameState.countdownEndTime - currentTime) / 1000);
                countdownNumber.textContent = Math.max(0, countdownSecs);
                countdownNumber.style.animation = 'none';
                countdownNumber.offsetHeight; // Trigger reflow to restart animation
                countdownNumber.style.animation = 'countdown-pulse 1s ease-out forwards';


                gameCountdownInterval = setInterval(async () => {
                    countdownSecs--;
                    countdownNumber.textContent = Math.max(0, countdownSecs);
                    if (gameCountdownOverlay.style.display !== 'none') {
                        countdownNumber.style.animation = 'none';
                        countdownNumber.offsetHeight;
                        countdownNumber.style.animation = 'countdown-pulse 1s ease-out forwards';
                    }

                    if (countdownSecs <= 0) {
                        clearInterval(gameCountdownInterval);
                        gameCountdownInterval = null;
                        gameCountdownOverlay.style.display = 'none';
                        if (auth.currentUser && lobbyData.hostId === auth.currentUser.uid) {
                            try {
                                await updateDoc(lobbyRef, {
                                    'gameState.status': 'active',
                                    'gameState.gameStartTimestamp': serverTimestamp()
                                });
                            } catch (error) {
                                console.error("Error updating game state to active:", error);
                            }
                        }
                    }
                }, 1000);

            } else if (gameState.status === 'active' && gameState.gameStartTimestamp) {
                gameCountdownOverlay.style.display = 'none';
                gameVotingOverlay.style.display = 'none';
                gameResultDisplay.classList.add('hidden');
                gameTimerDisplay.classList.remove('hidden');
                gameScoresDisplay.classList.remove('hidden');

                lobbyChatInput.disabled = false;
                lobbyChatSendBtn.disabled = false;
                lobbyChatInput.placeholder = "پیام خود را بنویسید...";

                if (!gameTimerInterval) {
                    gameTimerInterval = setInterval(async () => {
                        const startMillis = gameState.gameStartTimestamp ? gameState.gameStartTimestamp.toMillis() : Date.now();
                        const elapsedMs = Date.now() - startMillis;
                        const remainingMs = gameState.gameDurationSeconds * 1000 - elapsedMs;

                        if (remainingMs <= 0) {
                            clearInterval(gameTimerInterval);
                            gameTimerInterval = null;
                            gameTimerDisplay.textContent = "00:00";
                            if (auth.currentUser && lobbyData.hostId === auth.currentUser.uid) {
                                try {
                                    await updateDoc(lobbyRef, { 'gameState.status': 'voting' });
                                } catch(error) {
                                    console.error("Error updating game state to voting:", error);
                                }
                            }
                            return;
                        }

                        const remainingSeconds = Math.max(0, Math.floor(remainingMs / 1000));
                        const minutes = Math.floor(remainingSeconds / 60);
                        const seconds = remainingSeconds % 60;
                        gameTimerDisplay.textContent = 
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }, 1000);
                }

            } else if (gameState.status === 'voting') {
                gameCountdownOverlay.style.display = 'none';
                gameVotingOverlay.style.display = 'flex';
                gameResultDisplay.classList.add('hidden');
                gameTimerDisplay.classList.add('hidden');
                
                lobbyChatInput.disabled = true;
                lobbyChatSendBtn.disabled = true;
                lobbyChatInput.placeholder = "رای‌گیری در جریان است. چت موقتاً غیرفعال شد.";

                renderVotingOptions(lobbyId, myUid, gameState, lobbyData);
                
            } else if (gameState.status === 'ended') {
                gameCountdownOverlay.style.display = 'none';
                gameVotingOverlay.style.display = 'flex';
                gameResultDisplay.classList.remove('hidden');
                gameTimerDisplay.classList.add('hidden');
                votingOptions.classList.add('hidden');
                votingTitle.classList.add('hidden');
                votingInstructions.classList.add('hidden');
                
                lobbyChatInput.disabled = true;
                lobbyChatSendBtn.disabled = true;
                lobbyChatInput.placeholder = "بازی به پایان رسید.";

                winnerText.textContent = gameState.winner === 'Human' ? 'تیم انسان‌ها برنده شد!' : 'هوش مصنوعی برنده شد!';
                winnerText.classList.toggle('text-green-500', gameState.winner === 'Human');
                winnerText.classList.toggle('text-red-500', gameState.winner === 'AI');
                reasonText.textContent = gameState.winReason || 'بازی به پایان رسید.';
            }

            aiScore.textContent = `AI: ${gameState.aiScore || 0}`;
            humanScore.textContent = `Human: ${gameState.humanScore || 0}`;
        }

        function renderVotingOptions(lobbyId, myUid, gameState, lobbyData) {
            votingOptions.innerHTML = '';
            
            const hasVoted = gameState.votes && gameState.votes[myUid];

            if (hasVoted) {
                const votedForName = gameState.playerNames[gameState.votes[myUid]] || 'ناشناس';
                votingInstructions.textContent = `شما به ${votedForName} رای داده‌اید. منتظر بقیه بازیکنان باشید.`;
                return;
            }

            // Players eligible to be voted for (everyone except the voter themselves)
            const eligibleToVoteFor = gameState.players.filter(uid => 
                uid !== myUid && lobbyData.players && lobbyData.players[uid]
            );

            eligibleToVoteFor.forEach(playerUid => {
                const isAI = gameState.roles[playerUid] === 'AI';
                const button = document.createElement('button');
                button.className = 'voting-btn';
                // We don't color buttons based on role here to avoid giving hints
                button.classList.add('btn-blue-classic');
                button.textContent = `رای به ${gameState.playerNames[playerUid]}`;
                button.onclick = () => castVote(lobbyId, myUid, playerUid);
                votingOptions.appendChild(button);
            });


            votingOptions.classList.remove('hidden');
            votingTitle.classList.remove('hidden');
            votingInstructions.classList.remove('hidden');
            votingInstructions.textContent = "برای چه کسی رای می‌دهید؟";
        }

        async function castVote(lobbyId, voterUid, votedForUid) {
            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            try {
                await db.runTransaction(async (transaction) => {
                    const lobbyDoc = await transaction.get(lobbyRef);
                    if (!lobbyDoc.exists()) throw new Error("لابی یافت نشد یا بسته شده است.");
                    
                    const lobbyData = lobbyDoc.data();
                    let gameState = lobbyData.gameState;

                    if (gameState.status !== 'voting') throw new Error("رای‌گیری فعال نیست.");
                    if (gameState.votes && gameState.votes[voterUid]) throw new Error("شما قبلاً رای داده‌اید.");

                    const newVotes = { ...gameState.votes, [voterUid]: votedForUid };
                    transaction.update(lobbyRef, { 'gameState.votes': newVotes });

                    const livingPlayers = gameState.players.filter(uid => lobbyData.players && lobbyData.players[uid]);
                    const allHaveVoted = livingPlayers.every(uid => newVotes[uid]);

                    if (allHaveVoted && lobbyData.hostId === auth.currentUser.uid) {
                        // Pass the transaction object to resolveVotes
                        await resolveVotesInTransaction(transaction, lobbyRef, { ...gameState, votes: newVotes }, lobbyData);
                    }
                });
                showMessageBox(`رای شما ثبت شد.`, "success");
            } catch (error) {
                console.error("Error casting vote:", error);
                showMessageBox(`خطا در ثبت رای: ${error.message}`, "error");
            }
        }

        async function resolveVotesInTransaction(transaction, lobbyRef, gameState, lobbyData) {
            const votes = gameState.votes || {};
            const roles = gameState.roles || {};
            
            const voteCounts = {};
            Object.values(votes).forEach(votedFor => {
                voteCounts[votedFor] = (voteCounts[votedFor] || 0) + 1;
            });

            let maxVotes = -1;
            let playersWithMaxVotes = [];
            for (const player in voteCounts) {
                if (voteCounts[player] > maxVotes) {
                    maxVotes = voteCounts[player];
                    playersWithMaxVotes = [player];
                } else if (voteCounts[player] === maxVotes) {
                    playersWithMaxVotes.push(player);
                }
            }
            
            let winner = null;
            let winReason = '';

            if (playersWithMaxVotes.length === 1 && maxVotes > 0) {
                const eliminatedPlayer = playersWithMaxVotes[0];
                const eliminatedPlayerRole = roles[eliminatedPlayer];

                if (eliminatedPlayerRole === 'AI') {
                    winner = 'Human';
                    winReason = `هوش مصنوعی (${lobbyData.players[eliminatedPlayer]}) با موفقیت شناسایی و حذف شد!`;
                } else {
                    winner = 'AI';
                    winReason = `یک انسان (${lobbyData.players[eliminatedPlayer]}) به اشتباه حذف شد! هوش مصنوعی برنده شد.`;
                }
            } else {
                winner = 'AI'; // Draw or no majority results in an AI win
                winReason = 'بازیکنان به توافق نرسیدند. هوش مصنوعی برنده شد.';
            }

            transaction.update(lobbyRef, {
                'gameState.status': 'ended',
                'gameState.winner': winner,
                'gameState.winReason': winReason
            });
        }


        // --- Event Listeners ---
        function initializeAuthScreen() {
            authMode = 'login';
            displayNameField.classList.add('hidden');
            submitAuthBtn.textContent = 'ورود';
            loginToggleBtn.classList.add('hidden');
            registerToggleBtn.classList.remove('hidden');
            authForm.reset();
            if (currentActiveScreen === authScreen) {
                 emailInput.focus();
            }
        }

        loginToggleBtn.addEventListener('click', () => {
            authMode = 'login';
            displayNameField.classList.add('hidden');
            submitAuthBtn.textContent = 'ورود';
            loginToggleBtn.classList.add('hidden');
            registerToggleBtn.classList.remove('hidden');
            authForm.reset();
            messageBox.classList.add('hidden');
            emailInput.focus();
        });

        registerToggleBtn.addEventListener('click', () => {
            authMode = 'register';
            displayNameField.classList.remove('hidden');
            submitAuthBtn.textContent = 'ثبت نام';
            registerToggleBtn.classList.add('hidden');
            loginToggleBtn.classList.remove('hidden');
            authForm.reset();
            messageBox.classList.add('hidden');
            emailInput.focus();
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const displayName = displayNameInput.value.trim();

            if (!email || !password) { showMessageBox("لطفاً ایمیل و رمز عبور را وارد کنید.", 'error'); return; }
            if (authMode === 'register' && !displayName) { showMessageBox("لطفاً نام نمایشی را وارد کنید.", 'error'); return; }
            if (authMode === 'register' && password.length < 6) { showMessageBox("رمز عبور باید حداقل ۶ کاراکتر باشد.", "error"); return; }
            
            submitAuthBtn.disabled = true;
            submitAuthBtn.textContent = 'در حال پردازش...';

            try {
                if (authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile/data`);
                    await setDoc(userDocRef, {
                        displayName: displayName,
                        email: userCredential.user.email,
                        coins: 500, // Starting coins
                        approvedLobbyNames: [],
                        banStatus: { isBanned: false },
                        createdAt: serverTimestamp(),
                        theme: 'classic' // Set default theme on registration
                    });
                    console.log("User profile document created immediately after registration.");
                }
            } catch (error) { 
                showMessageBox(getFirebaseErrorMessage(error.code), 'error'); 
            } finally {
                submitAuthBtn.disabled = false;
                submitAuthBtn.textContent = authMode === 'login' ? 'ورود' : 'ثبت نام';
            }
        });

        menuBtn.addEventListener('click', openMainMenuModal);
        profileSummary.addEventListener('click', openMainMenuModal);

        closeMainMenuModalBtn.addEventListener('click', closeMainMenuModal);
        mainMenuModal.addEventListener('click', (e) => e.target === mainMenuModal && closeMainMenuModal());

        showProfileBtn.addEventListener('click', () => {
            mainMenuNav.classList.add('hidden');
            profileView.classList.remove('hidden');
            themesView.classList.add('hidden');
            if (currentUserData) {
                profileDisplayName.textContent = currentUserData.displayName || 'ناشناس';
                profileEmail.textContent = currentUserData.email || 'ناشناس';
                profileUid.textContent = currentUserData.uid || 'ناشناس';
                profileCoins.textContent = currentUserData.coins !== undefined ? currentUserData.coins.toLocaleString('fa-IR') : '---';
            }
        });

        showThemesBtn.addEventListener('click', () => {
            mainMenuNav.classList.add('hidden');
            profileView.classList.add('hidden');
            themesView.classList.remove('hidden');
            populateThemeButtons();
        });

        backToMainMenuFromProfile.addEventListener('click', () => {
            profileView.classList.add('hidden');
            mainMenuNav.classList.remove('hidden');
        });

        backToMainMenuFromThemes.addEventListener('click', () => {
            themesView.classList.add('hidden');
            mainMenuNav.classList.remove('hidden');
        });

        mainMenuLogoutBtn.addEventListener('click', async () => {
            const confirmed = await showCustomConfirm("آیا مطمئن هستید که می‌خواهید از حساب کاربری خود خارج شوید؟");
            if (confirmed) {
                try { 
                    await signOut(auth); 
                    closeMainMenuModal(); 
                } catch (error) { 
                    showMessageBox(getFirebaseErrorMessage(error.code), 'error'); 
                }
            }
        });

        friendlyGameBtn.addEventListener('click', () => {
            if (!auth.currentUser) {
                showMessageBox("برای مشاهده لابی‌ها، ابتدا وارد شوید.", "error"); return;
            }
            if (!currentUserData) {
                showMessageBox("در حال بارگذاری اطلاعات کاربری، لطفاً کمی صبر کنید.", "info"); return;
            }
            if ((currentUserData.coins || 0) < gameEntryCost) {
                showMessageBox(`سکه شما برای ورود به بازی دوستانه کافی نیست. (نیاز: ${gameEntryCost} سکه، موجودی شما: ${currentUserData.coins || 0})`, "error"); return;
            }
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener('');
        });
        
        ratedGameBtn.addEventListener('click', () => showMessageBox("بازی امتیازی به زودی!", "info"));

        backToMainBtn.addEventListener('click', () => {
            setActiveScreen(mainScreen);
        });

        addIconBtn.addEventListener('click', () => {
            if (!auth.currentUser) { showMessageBox("برای ساخت لابی، ابتدا وارد شوید.", "error"); return; }
            openCreateLobbyModal('create');
        });

        myLobbiesBtn.addEventListener('click', () => {
            if (!auth.currentUser) { showMessageBox("برای مشاهده لابی‌های من، ابتدا وارد شوید.", "error"); return; }
            openCreateLobbyModal('myLobbies');
        });

        submitLobbyNameForApprovalBtn.addEventListener('click', async () => {
            const proposedName = proposedLobbyNameInput.value.trim();
            if (!proposedName) { showCreateLobbyMessageBox("لطفاً نام لابی پیشنهادی خود را وارد کنید.", "error"); return; }
            if (!auth.currentUser || !currentUserData) { showCreateLobbyMessageBox("خطا: اطلاعات کاربری در دسترس نیست.", "error"); return; }

            const proposedLobbyNamesRef = collection(db, `artifacts/${appId}/proposedLobbyNames`);
            const qPending = query(
                proposedLobbyNamesRef,
                where("userId", "==", auth.currentUser.uid),
                where("status", "==", "pending")
            );
            const pendingSnapshot = await getDocs(qPending);
            if (pendingSnapshot.size >= MAX_PENDING_PROPOSALS) {
                showCreateLobbyMessageBox(`شما به حداکثر تعداد (${MAX_PENDING_PROPOSALS}) درخواست لابی در انتظار تایید رسیده‌اید.`, "error");
                return;
            }

            showCreateLobbyMessageBox("در حال بررسی و ارسال نام لابی برای تأیید...", "info");
            submitLobbyNameForApprovalBtn.disabled = true;
            try {
                const moderationResult = await checkLobbyNameWithAI(proposedName);
                if (!moderationResult.is_appropriate) {
                    showCreateLobbyMessageBox(`نام لابی نامناسب: ${moderationResult.reason}`, "error");
                    return;
                }

                await addDoc(proposedLobbyNamesRef, {
                    name: proposedName,
                    userId: auth.currentUser.uid,
                    displayName: currentUserData.displayName,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                showCreateLobbyMessageBox("نام لابی شما با موفقیت برای تأیید ارسال شد.", "success");
                proposedLobbyNameInput.value = '';
            } catch (error) {
                console.error("خطا در ارسال نام لابی برای تأیید:", error);
                showCreateLobbyMessageBox(`خطا در ارسال نام لابی: ${error.message}`, "error");
            } finally {
                submitLobbyNameForApprovalBtn.disabled = false;
            }
        });
        
        approvedLobbyNamesSelect.addEventListener('change', () => {
            submitCreateLobbyBtn.disabled = !approvedLobbyNamesSelect.value;
        });

        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let lobbyName;
            
            if (!lobbyNameSelectionArea.classList.contains('hidden') && approvedLobbyNamesSelect.value) {
                lobbyName = approvedLobbyNamesSelect.value;
            } else {
                showCreateLobbyMessageBox("لطفاً یک نام لابی تأیید شده را از لیست انتخاب کنید.", "error"); 
                return; 
            }

            const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;
            const gameDuration = parseInt(gameDurationInput.value, 10);
        
            if (lobbyType === 'private' && password.length < 4) { showCreateLobbyMessageBox("رمز عبور برای لابی خصوصی باید حداقل ۴ کاراکتر باشد.", "error"); return; }
            if (isNaN(gameDuration) || gameDuration < 1 || gameDuration > 60) { showCreateLobbyMessageBox("مدت زمان بازی باید بین ۱ تا ۶۰ دقیقه باشد.", "error"); return; }
            if (!auth.currentUser || !currentUserData?.displayName) { showCreateLobbyMessageBox("مشکلی در اطلاعات کاربری شما وجود دارد.", "error"); return; }
            if (userHasActiveLobby) { showCreateLobbyMessageBox("شما از قبل در یک لابی فعال هستید.", "info"); closeCreateLobbyModal(); return; }
            
            submitCreateLobbyBtn.disabled = true;
            try {
                const newLobbyId = await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName, lobbyType, password, gameDuration);
                showCreateLobbyMessageBox("لابی شما با موفقیت ساخته شد!", "success");
                
                setTimeout(() => {
                    closeCreateLobbyModal();
                    currentLobbyId = newLobbyId;
                    userHasActiveLobby = true;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailListener(newLobbyId);
                }, 1500);
                
            } catch (error) {
                console.error("خطا در ساخت لابی از مودال:", error);
                showCreateLobbyMessageBox(error.message.includes("شما از قبل یک لابی فعال ساخته‌اید.") ? error.message : `خطا در ساخت لابی: ${error.message}`, "error");
            } finally {
                submitCreateLobbyBtn.disabled = false;
            }
        });

        closeCreateLobbyModalBtn.addEventListener('click', closeCreateLobbyModal);
        createLobbyModal.addEventListener('click', (e) => e.target === createLobbyModal && closeCreateLobbyModal());
        
        refreshLobbiesBtn.addEventListener('click', () => {
            if (isRefreshing) return;
            if (!auth.currentUser) { showMessageBox("برای بروزرسانی لابی‌ها، ابتدا وارد شوید.", "info"); return; }
            isRefreshing = true;
            refreshLobbiesBtn.disabled = true;
            const refreshIconSvg = refreshLobbiesBtn.querySelector('svg');
            if (refreshIconSvg) {
                refreshIconSvg.classList.add('is-refreshing');
            }
            lobbiesList.innerHTML = '<p>در حال بروزرسانی لیست...</p>';
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value.trim().toLowerCase());
            setTimeout(() => {
                isRefreshing = false;
                refreshLobbiesBtn.disabled = false;
                if (refreshIconSvg) {
                    refreshIconSvg.classList.remove('is-refreshing');
                }
                showMessageBox("لیست لابی‌ها بروزرسانی شد.", "info");
            }, 1000);
        });


        lobbySearchInput.addEventListener('input', (e) => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(e.target.value.trim().toLowerCase());
        });
        lobbySearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchLobbiesBtn.click());
        searchLobbiesBtn.addEventListener('click', () => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value.trim().toLowerCase());
        });

        // --- Lobby Detail Screen Event Listeners ---
        leaveLobbyBtn.addEventListener('click', leaveLobby);

        startGameBtn.addEventListener('click', async () => {
            if (currentLobbyId && auth.currentUser) {
                try {
                    const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
                    const lobbySnap = await getDoc(lobbyRef);
                    if (lobbySnap.exists()) {
                        await initializeGameInFirestore(currentLobbyId, lobbySnap.data());
                    }
                } catch (error) {
                    console.error("Error starting game:", error);
                    showMessageBox(`خطا در شروع بازی: ${error.message}`, "error");
                }
            }
        });
        
        toggleChatLockBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists() && lobbySnap.data().hostId === auth.currentUser.uid) {
                    const currentLockState = lobbySnap.data().isChatLocked || false;
                    await updateDoc(lobbyRef, { isChatLocked: !currentLockState });
                }
            } catch (error) {
                console.error("Error toggling chat lock:", error);
                showMessageBox("خطا در تغییر وضعیت چت.", "error");
            }
        });

        // Kick/Unkick related
        kickPlayerConfirmBtn.addEventListener('click', () => kickedPlayerToProcess && kickPlayer(currentLobbyId, kickedPlayerToProcess.uid, kickedPlayerToProcess.displayName));
        cancelKickPlayerBtn.addEventListener('click', closeKickPlayerConfirmModal);
        closeKickPlayerConfirmModalBtn.addEventListener('click', closeKickPlayerConfirmModal);
        kickPlayerConfirmModal.addEventListener('click', (e) => e.target === kickPlayerConfirmModal && closeKickPlayerConfirmModal());
        kickedMessageOkBtn.addEventListener('click', closeKickedMessageModal);
        viewKickedPlayersBtn.addEventListener('click', openKickedPlayersListModal);
        closeKickedPlayersListModalBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedListOkBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedPlayersListModal.addEventListener('click', (e) => e.target === kickedPlayersListModal && closeKickedPlayersListModal());
        
        function showPasswordPromptMessage(message, type = 'error') {
            passwordPromptMessageBox.textContent = message;
            passwordPromptMessageBox.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            passwordPromptMessageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-blue-500', 'text-white');
            passwordPromptMessageBox.classList.remove('hidden');
            setTimeout(() => passwordPromptMessageBox.classList.add('hidden'), 4000);
        }

        function openEnterPasswordModal(lobbyId, lobbyName) {
            lobbyToJoin = { id: lobbyId, name: lobbyName };
            passwordPromptLobbyName.textContent = lobbyName;
            enterPasswordForm.reset();
            passwordPromptMessageBox.classList.add('hidden');
            enterPasswordModal.classList.remove('hidden');
            void enterPasswordModal.offsetWidth;
            enterPasswordModal.classList.add('profile-modal-enter-active');
            joinLobbyPasswordInput.focus();
        }

        function closeEnterPasswordModal() {
            enterPasswordModal.classList.remove('profile-modal-enter-active');
            enterPasswordModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                enterPasswordModal.classList.add('hidden');
                enterPasswordModal.classList.remove('profile-modal-leave-active');
                lobbyToJoin = null;
            }, 300);
        }

        lobbyTypeToggle.addEventListener('change', (e) => {
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            e.target.nextElementSibling.classList.add('active');
            if (e.target.value === 'private') {
                newLobbyPasswordField.classList.remove('hidden');
            } else {
                newLobbyPasswordField.classList.add('hidden');
            }
        });

        togglePasswordVisibilityBtn.addEventListener('click', () => {
            const isPassword = newLobbyPasswordInput.type === 'password';
            newLobbyPasswordInput.type = isPassword ? 'text' : 'password';
            eyeIconOpen.style.display = isPassword ? 'none' : 'block';
            eyeIconClosed.style.display = isPassword ? 'block' : 'none';
        });

        cancelJoinPasswordBtn.addEventListener('click', closeEnterPasswordModal);
        enterPasswordModal.addEventListener('click', (e) => e.target === enterPasswordModal && closeEnterPasswordModal());

        enterPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!lobbyToJoin) return;
            const enteredPassword = joinLobbyPasswordInput.value;
            if (!enteredPassword) { showPasswordPromptMessage('لطفاً رمز عبور را وارد کنید.'); return; }

            submitJoinPasswordBtn.disabled = true;
            submitJoinPasswordBtn.textContent = 'در حال بررسی...';
            try {
                const lobbyRef = doc(db, 'global_lobbies', lobbyToJoin.id);
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists() || lobbySnap.data().type !== 'private') {
                    showPasswordPromptMessage('این لابی دیگر خصوصی نیست یا وجود ندارد.');
                    closeEnterPasswordModal();
                    return;
                }
                if (enteredPassword === lobbySnap.data().password) {
                    closeEnterPasswordModal();
                    await joinLobby(lobbyToJoin.id, auth.currentUser.uid, currentUserData.displayName);
                } else {
                    showPasswordPromptMessage('رمز عبور اشتباه است.');
                    joinLobbyPasswordInput.value = '';
                    joinLobbyPasswordInput.focus();
                }
            } catch (error) {
                console.error("Error verifying lobby password:", error);
                showPasswordPromptMessage('خطا در بررسی رمز عبور.');
            } finally {
                submitJoinPasswordBtn.disabled = false;
                submitJoinPasswordBtn.textContent = 'ورود';
            }
        });
        
        lobbyChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentLobbyId) {
                sendLobbyMessage(currentLobbyId, lobbyChatInput.value);
            }
        });

        lobbyChatMessages.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-message-btn');
            if (deleteButton) {
                const messageId = deleteButton.dataset.messageId;
                if (currentLobbyId && messageId) {
                    deleteLobbyMessage(currentLobbyId, messageId);
                }
            }
        });

        leaveGameFromLobbyBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;

            const confirmed = await showCustomConfirm("آیا مطمئن هستید که می‌خواهید بازی را ترک کنید؟ این عمل غیرقابل بازگشت است.");
            if (!confirmed) return;

            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const myUid = auth.currentUser.uid;
            
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { throw new Error("Lobby not found"); }
                
                const lobbyData = lobbySnap.data();
                if (lobbyData.hostId === myUid) {
                    const hostConfirmedClose = await showCustomConfirm("شما سازنده لابی هستید. خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟", "بستن لابی");
                    if (hostConfirmedClose) {
                        await deleteDoc(lobbyRef);
                    } else {
                        return;
                    }
                } else {
                    await db.runTransaction(async (transaction) => {
                        const currentLobbyDoc = await transaction.get(lobbyRef);
                        if (!currentLobbyDoc.exists()) {
                            throw new Error("Lobby not found or already closed.");
                        }
                        transaction.update(lobbyRef, { [`players.${myUid}`]: deleteField() });
                    });
                }
                
                showMessageBox("شما از بازی خارج شدید.", "info");
            } catch (error) {
                console.error("Error leaving game:", error);
                showMessageBox("خطا در خروج از بازی: " + error.message, "error");
            }
        });


        returnToLobbiesBtn.addEventListener('click', () => {
            currentLobbyId = null;
            userHasActiveLobby = false;
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener('');
        });

    </script>
</body>
</html>
