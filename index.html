<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars */
        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            /* Deep, rich, slightly textured background for classic feel */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod border */
            border-radius: 20px; /* Slightly larger radius */
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            backdrop-filter: blur(10px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh; /* Ensure card doesn't overflow viewport */
            overflow-y: auto; /* Enable scrolling if content exceeds max-height */
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid #FFD700;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid #FFD700;
            border-right: 5px solid #FFD700;
            border-radius: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }


        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother transition */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); /* Stronger shadow on hover */
        }

        /* Specific Button Colors - Classic Pallette */
        .btn-purple-classic {
            background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); /* Amethyst */
        }
        .btn-blue-classic {
            background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); /* Steel Blue / Royal Blue */
        }
        .btn-green-classic {
            background: linear-gradient(145deg, #228B22 0%, #006400 100%); /* Forest Green */
        }
        .btn-red-classic {
            background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); /* Indian Red / Firebrick */
        }
        .btn-gray-classic {
            background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); /* Dark Gray */
        }
        .btn-brown-classic { /* New for Profile/Shop */
            background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); /* Saddle Brown / Dark Sienna */
        }
        .btn-gold-classic { /* For footer icons */
            background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); /* Gold */
            border: none; /* No border for these small buttons */
            padding: 0.5rem;
            border-radius: 10px;
        }
        .btn-gold-classic:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3);
        }


        /* Input Field Styles - More refined Classic Look */
        input {
            background-color: #202020; /* Even darker input background */
            border: 2px solid #5A5A5A; /* Dark gray border */
            color: #E0E0E0; /* Light text color */
            padding: 0.875rem; /* Equivalent to p-3.5 */
            border-radius: 0.75rem; /* Equivalent to rounded-xl */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); /* Inner shadow for depth */
        }
        input::placeholder {
            color: #A0A0A0; /* Lighter placeholder text */
        }
        input:focus {
            border-color: #DAA520 !important; /* Gold border on focus */
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; /* Gold focus ring with inner shadow */
        }

        /* Header specific styles - Richer Gold/Brown */
        .app-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            border-bottom: 3px solid #FFD700; /* Thicker gold border */
            box-shadow: 0 8px 20px rgba(0,0,0,0.7); /* Deeper shadow */
            height: 70px; /* Fixed height for header */
            position: fixed; /* Explicitly fixed */
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Lobby Screen Specific Header */
        .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-bottom: 3px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            height: 70px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center; /* Align items vertically */
            justify-content: center; /* Center horizontally by default */
        }
        .lobby-header .search-container {
            display: flex;
            flex-grow: 1; /* Allow search container to take available space */
            max-width: 600px; /* Limit max width on larger screens */
            margin: 0 auto; /* Center the search container */
            align-items: center;
            background-color: #303030; /* Darker background for search bar */
            border-radius: 15px; /* Rounded corners for search bar */
            border: 2px solid #5A5A5A;
            padding: 0.5rem 1rem; /* Adjust padding */
        }
        .lobby-header .search-container input {
            flex-grow: 1;
            background-color: transparent; /* Transparent background */
            border: none; /* No border for input inside search bar */
            padding: 0.25rem 0.5rem;
            outline: none; /* No outline on focus */
            text-align: right; /* Align text to right for RTL */
        }
        .lobby-header .search-container input::placeholder {
            color: #A0A0A0;
        }
        .lobby-header .search-container svg {
            color: #DAA520; /* Gold color for icons */
            min-width: 24px; /* Ensure icons don't shrink */
            min-height: 24px;
        }
        .lobby-header .search-container button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.5rem;
        }
        .lobby-header .back-btn-wrapper {
            margin-left: 10px; /* Space between back button and search bar (for RTL) */
        }
        .lobby-header .search-icon-wrapper {
            margin-right: 10px; /* Space between search icon and search input (for RTL) */
        }


        .app-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            border-top: 3px solid #FFD700; /* Thicker gold border */
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7); /* Deeper shadow */
            height: 90px; /* Fixed height for footer */
            position: fixed; /* Explicitly fixed */
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        /* Lobby Screen Specific Footer */
        .lobby-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-top: 3px solid #FFD700;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
            height: 90px;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #FFD700; /* Gold color for icons */
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .lobby-footer .icon-btn:hover {
            transform: translateY(-5px);
        }
        .lobby-footer .icon-btn svg {
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
        }
        .lobby-footer .games-running-text {
            color: #E0E0E0;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main content area padding to avoid overlap with fixed header/footer */
        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 90px; /* Footer height */
            flex-grow: 1; /* Allow content to fill available space */
            overflow-y: auto; /* Enable scrolling for main content */
            width: 100%; /* Ensure it takes full width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start for scrollable lists */
            align-items: center; /* Center content horizontally */
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); /* Subtle dark grey gradient for main area */
            position: relative; /* For any absolute positioned elements inside */
        }
        
        /* Profile Modal specific styles */
        .profile-modal-overlay {
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            transition: opacity 0.3s ease-in-out;
        }
        .profile-modal-content {
            transform: translateY(-20px); /* Initial slightly elevated */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .profile-modal-enter-active .profile-modal-content {
            transform: translateY(0);
        }
        .profile-modal-leave-active .profile-modal-content {
            transform: translateY(-20px);
            opacity: 0;
        }

        /* Create Lobby Modal Specific Styles */
        #create-lobby-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 640px) {
            .max-w-md {
                max-width: 95%;
            }
            .p-6, .p-8 {
                padding: 1.5rem;
            }
            .text-3xl {
                font-size: 2rem;
            }
            .space-y-5 > *:not([hidden]) ~ *:not([hidden]) {
                margin-top: 1.25rem;
            }
            .space-y-4 > *:not([hidden]) ~ *:not([hidden]) {
                margin-top: 1rem;
            }
            .sm\\:flex-row {
                flex-direction: column;
            }
            .sm\\:w-1\\/2 {
                width: 100%;
            }
            .sm\\:space-x-4 {
                margin-left: 0;
                margin-right: 0;
            }
            .sm\\:space-y-0 {
                margin-top: 1rem; /* Add some space between stacked buttons */
            }
             .classic-card {
                border-radius: 15px; /* Slightly smaller radius on mobile for consistency */
                /* Ensure it fits on smaller screens */
                max-height: 85vh; /* Slightly less max-height for mobile */
            }
             .classic-btn {
                padding: 0.75rem 1.25rem; /* Slightly smaller padding on mobile */
                font-size: 1rem; /* Slightly smaller font on mobile buttons */
            }
            .app-header, .lobby-header, .app-footer, .lobby-footer {
                padding: 0.5rem; /* Smaller padding on mobile */
            }
            .app-header, .lobby-header {
                height: 60px; /* Slightly smaller header on mobile */
            }
            .lobby-header .search-container {
                padding: 0.3rem 0.8rem;
            }
            .app-footer, .lobby-footer {
                height: 80px; /* Slightly smaller footer on mobile */
            }
            .main-content-area {
                padding-top: 60px; /* Adjust for smaller header */
                padding-bottom: 80px; /* Adjust for smaller footer */
            }
            .lobby-footer .icon-btn svg {
                width: 25px;
                height: 25px;
            }
            .lobby-footer .games-running-text {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="email" placeholder="ایمیل شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <!-- Toggle buttons for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth-btn"
                            class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl hidden">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <!-- Using a full-height, full-width flex container to manage fixed header/footer and scrollable content -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info and ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                    </svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <!-- Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer">
                <button id="friendly-game-btn"
                        class="classic-btn btn-purple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">
                    بازی دوستانه
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="classic-btn btn-brown-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">
                    بازی امتیازی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
                            <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                        </svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <!-- Removed the 'create-lobby-btn' from here as per user request -->
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Profile Modal (Hidden by default) -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div class="text-lg space-y-4 mb-8 text-white">
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                    <!-- Add more profile stats here later (e.g., wins, losses) -->
                </div>
                <button id="profile-logout-btn"
                        class="w-full classic-btn btn-red-classic text-lg sm:text-xl">
                    خروج از حساب
                </button>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">
                    <div>
                        <input type="text" id="new-lobby-name-input" placeholder="نام لابی شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500"
                               required>
                    </div>
                    <button type="submit" id="submit-create-lobby-btn"
                            class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from user's input)
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com", // Corrected storageBucket format
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase context (as per environment instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        // Re-using messageBox for auth screen specific messages.
        const messageBox = document.getElementById('message-box'); 

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen UI Elements (NEW)
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        // Removed createLobbyBtn from here, using the footer icon instead
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn'); // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Profile Modal Elements
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        // Create Lobby Modal Elements (NEW)
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn');
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');


        // State variables for authentication mode (login or register)
        let authMode = 'login'; // Default mode is login

        // Global variable to keep track of the current active screen
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; // To store user's profile data
        let unsubscribeLobbies = null; // Global variable to store the unsubscribe function for lobby listener

        // Function to show custom message box (re-used for auth and create lobby modals)
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            console.log(`پیام نمایش داده شد (${type}): ${message}`);
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        // Wrapper for main message box
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        // Wrapper for create lobby message box
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);


        // Function to transition between screens
        function setActiveScreen(newScreen) {
            console.log(`درخواست تغییر صفحه به: ${newScreen.id}. صفحه فعلی: ${currentActiveScreen.id}`);

            // Hide the current screen with transition
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            currentActiveScreen.setAttribute('tabindex', '-1'); // Remove focus capability
            // Remove focus from any active element on the current screen
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }

            setTimeout(() => {
                currentActiveScreen.classList.add('hidden'); // Fully hide
                currentActiveScreen.classList.remove('page-transition-hidden'); // Clean up class

                // Show the new screen with transition
                newScreen.classList.remove('hidden');
                // Force reflow to ensure transition starts from hidden state
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                newScreen.removeAttribute('tabindex'); // Allow focus for new screen
                console.log(`صفحه ${newScreen.id} اکنون قابل مشاهده است.`);

                // Manage focus based on the new screen
                if (newScreen === authScreen) {
                    emailInput.focus(); // Focus on email input for auth screen
                } else if (newScreen === mainScreen) {
                    document.activeElement.blur(); // Ensure no input has focus on main screen
                } else if (newScreen === lobbyScreen) {
                    lobbySearchInput.focus(); // Focus on search input on lobby screen
                }

                currentActiveScreen = newScreen; // Update the current active screen

            }, 600); // Matches CSS transition duration
        }

        // Function to open the profile modal
        function openProfileModal() {
            profileModal.classList.remove('hidden');
            void profileModal.offsetWidth; // Trigger reflow for transition
            profileModal.classList.add('profile-modal-enter-active');
            // Populate profile data
            if (currentUserData) {
                profileDisplayName.textContent = currentUserData.displayName || 'ناشناس';
                profileEmail.textContent = currentUserData.email || 'ناشناس';
                profileUid.textContent = currentUserData.uid || 'ناشناس';
            }
        }

        // Function to close the profile modal
        function closeProfileModal() {
            profileModal.classList.remove('profile-modal-enter-active');
            profileModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                profileModal.classList.add('hidden');
                profileModal.classList.remove('profile-modal-leave-active');
            }, 300); // Match modal transition duration
        }

        // Function to open the create lobby modal
        function openCreateLobbyModal() {
            createLobbyModal.classList.remove('hidden');
            void createLobbyModal.offsetWidth;
            createLobbyModal.classList.add('profile-modal-enter-active');
            newLobbyNameInput.focus(); // Focus on the input field
            createLobbyMessageBox.classList.add('hidden'); // Hide previous messages
        }

        // Function to close the create lobby modal
        function closeCreateLobbyModal() {
            createLobbyModal.classList.remove('profile-modal-enter-active');
            createLobbyModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                createLobbyModal.classList.add('hidden');
                createLobbyModal.classList.remove('profile-modal-leave-active');
                createLobbyForm.reset(); // Clear the form after closing
            }, 300);
        }


        // Firebase Authentication State Listener
        // This listener is crucial for managing the UI state based on user authentication.
        // It fetches/updates currentUserData and handles screen transitions.
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged فایر بیس فعال شد. وضعیت کاربر:", user ? user.uid : "کاربر وارد نشده");
            if (user) {
                // User is signed in. Fetch or update their profile data.
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                    const userDocSnap = await getDoc(userDocRef);

                    // Initialize currentUserData based on Firebase user and Firestore profile
                    currentUserData = {
                        uid: user.uid,
                        email: user.email,
                        // Prioritize displayName from Firestore, then user.displayName (if set by Firebase, e.g., Google Sign-in),
                        // then fallback to part of email.
                        displayName: (userDocSnap.exists() && userDocSnap.data().displayName)
                                    ? userDocSnap.data().displayName
                                    : (user.displayName || (user.email ? user.email.split('@')[0] : 'کاربر ناشناس'))
                    };
                    
                    // If a user just registered and displayName was provided in the form,
                    // ensure it's saved in Firestore if it wasn't already.
                    if (userDocSnap.exists() && !userDocSnap.data().displayName && displayNameInput.value.trim() !== '') {
                        await setDoc(userDocRef, { displayName: displayNameInput.value.trim() }, { merge: true });
                        currentUserData.displayName = displayNameInput.value.trim(); // Update current data immediately
                    } else if (!userDocSnap.exists() && authMode === 'register' && displayNameInput.value.trim() !== '') {
                        // This case should ideally be covered by the initial register logic, but as a fallback
                         await setDoc(userDocRef, { displayName: displayNameInput.value.trim(), email: user.email }, { merge: true });
                         currentUserData.displayName = displayNameInput.value.trim();
                    }


                    // Update header display with fetched/derived data
                    headerDisplayName.textContent = currentUserData.displayName;
                    headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`; // Display first 8 chars of UID

                    console.log("نام نمایشی کاربر: " + currentUserData.displayName);
                    setActiveScreen(mainScreen); // Transition to main screen once user data is ready

                } catch (firestoreError) {
                    console.error("خطا در دریافت/به‌روزرسانی پروفایل کاربر از Firestore:", firestoreError);
                    // Fallback if Firestore read fails
                    currentUserData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'کاربر ناشناس')
                    };
                    headerDisplayName.textContent = currentUserData.displayName;
                    headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                    setActiveScreen(mainScreen); // Still transition even if profile fetch fails
                    showMessageBox("مشکلی در بارگذاری پروفایل شما پیش آمد.", "error");
                }

            } else {
                // User is signed out or not signed in.
                setActiveScreen(authScreen); // Transition to authentication screen
                // Reset auth form state
                authForm.reset();
                displayNameField.classList.add('hidden'); // Hide display name field
                submitAuthBtn.classList.add('hidden'); // Hide submit button initially
                loginToggleBtn.classList.remove('hidden'); // Show login toggle
                registerToggleBtn.classList.remove('hidden'); // Show register toggle
                authMode = 'login'; // Reset mode to login
                currentUserData = null; // Clear user data
                // If there's an active lobby listener, unsubscribe it to prevent unauthorized access
                if (unsubscribeLobbies) {
                    unsubscribeLobbies();
                    unsubscribeLobbies = null;
                }
            }
            console.log("onAuthStateChanged به پایان رسید.");
        });

        // Initial Firebase Authentication when the app loads
        async function initializeFirebaseAndAuth() {
            console.log("تابع initializeFirebaseAndAuth فراخوانی شد.");
            try {
                // This will trigger onAuthStateChanged after completion
                if (initialAuthToken) {
                    console.log("تلاش برای ورود با custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("احراز هویت اولیه تکمیل شد. onAuthStateChanged وضعیت را مدیریت می‌کند.");
            } catch (error) {
                console.error("خطا در احراز هویت اولیه فایربیس:", error);
                showMessageBox(`خطا در ورود اولیه: ${getFirebaseErrorMessage(error.code)}`, 'error');
                setActiveScreen(authScreen); // Ensure auth screen is shown on critical initial auth failure
            }
        }

        /**
         * Maps Firebase auth error codes to user-friendly Persian messages.
         * @param {string} errorCode - The Firebase error code.
         * @returns {string} User-friendly message.
         */
        function getFirebaseErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return "فرمت ایمیل وارد شده نامعتبر است. لطفا یک ایمیل معتبر وارد کنید.";
                case 'auth/user-disabled':
                    return "حساب کاربری شما غیرفعال شده است. لطفاً با پشتیبانی تماس بگیرید.";
                case 'auth/user-not-found':
                    return "کاربری با این ایمیل یافت نشد. لطفا ثبت نام کنید یا ایمیل را بررسی کنید.";
                case 'auth/wrong-password':
                case 'auth/invalid-credential': // Modern Firebase error for wrong password/email
                    return "ایمیل یا رمز عبور اشتباه است.";
                case 'auth/email-already-in-use':
                    return "این ایمیل قبلاً ثبت نام شده است. لطفاً وارد شوید یا از ایمیل دیگری استفاده کنید.";
                case 'auth/weak-password':
                    return "رمز عبور بسیار ضعیف است. لطفاً رمزی با حداقل ۶ کاراکتر انتخاب کنید.";
                case 'auth/operation-not-allowed':
                    return "این نوع احراز هویت در حال حاضر فعال نیست. لطفاً با پشتیبانی تماس بگیرید.";
                case 'auth/network-request-failed':
                    return "مشکل در اتصال به اینترنت. لطفاً اتصال خود را بررسی کنید.";
                case 'auth/too-many-requests':
                    return "تعداد تلاش‌های ناموفق بیش از حد مجاز. لطفاً بعداً امتحان کنید.";
                default:
                    return "خطایی ناشناخته رخ داده است. لطفاً دوباره تلاش کنید.";
            }
        }

        // --- Firebase Lobby Functions ---

        /**
         * Creates a new lobby document in Firestore.
         * @param {string} lobbyName - The name of the lobby.
         * @param {string} userId - The UID of the user creating the lobby.
         * @param {string} displayName - The display name of the user creating the lobby.
         * @returns {Promise<string>} The ID of the newly created lobby.
         */
        async function createLobby(lobbyName, userId, displayName) {
            try {
                // Ensure display name is not empty or null
                const creatorDisplayName = displayName && displayName.trim() !== '' ? displayName : 'ناشناس';

                const lobbiesRef = collection(db, `artifacts/${appId}/public/data/lobbies`);
                const newLobbyRef = await addDoc(lobbiesRef, {
                    name: lobbyName,
                    hostId: userId,
                    status: "waiting", // Initial status: waiting for players
                    players: [{ uid: userId, displayName: creatorDisplayName }], // Host is the first player
                    createdAt: serverTimestamp(), // Firestore timestamp for ordering/cleanup
                    gameSettings: { // Default game settings
                        maxPlayers: 4, // Hokm is typically 4 players
                        roundsToWin: 7
                    }
                });
                console.log("لابی با ID ساخته شد: ", newLobbyRef.id);
                return newLobbyRef.id;
            } catch (e) {
                console.error("خطا در ساخت لابی: ", e);
                throw e; // Re-throw to be caught by the caller
            }
        }

        /**
         * Sets up a real-time listener for available lobbies and updates the UI.
         * @returns {function} An unsubscribe function to detach the listener.
         */
        function setupLobbyListener() {
            // Clear previous lobbies list
            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>';

            // Query for lobbies with 'waiting' status
            // Removed orderBy("createdAt", "desc") to avoid potential index errors as per instructions.
            // Sorting will be handled client-side if needed for visual presentation.
            const q = query(
                collection(db, `artifacts/${appId}/public/data/lobbies`),
                where("status", "==", "waiting")
            );

            // Set up the real-time listener
            const unsubscribe = onSnapshot(q, (snapshot) => {
                lobbiesList.innerHTML = ''; // Clear existing list
                let activeGamesCountNum = 0; // Reset count for games in 'playing' status
                let lobbiesToDisplay = [];

                snapshot.forEach((doc) => {
                    const lobby = doc.data();
                    const lobbyId = doc.id;
                    lobbiesToDisplay.push({ id: lobbyId, ...lobby });

                    // Increment active games count if lobby is "playing"
                    if (lobby.status === "playing") {
                        activeGamesCountNum++;
                    }
                });

                // Sort lobbies client-side if needed (e.g., by createdAt if available and if orderBy was removed)
                // If createdAt is available and you removed orderBy from query, you can sort here:
                lobbiesToDisplay.sort((a, b) => {
                    // Handle cases where createdAt might be missing (though serverTimestamp should ensure it's there)
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA; // Sort by newest first
                });

                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p class="text-gray-400">در حال حاضر لابی فعالی وجود ندارد. اولین نفر باشید!</p>';
                } else {
                    lobbiesToDisplay.forEach((lobby) => {
                        const playerCount = lobby.players ? lobby.players.length : 0;
                        const maxPlayers = lobby.gameSettings?.maxPlayers || 4; // Default to 4 if not set
                        
                        const hostDisplayName = lobby.players && lobby.players.length > 0
                                                ? lobby.players[0].displayName || 'ناشناس'
                                                : 'ناشناس';

                        // Make the join button always disabled for now as per user request
                        const joinButtonHtml = `<button data-lobby-id="${lobby.id}" class="join-lobby-btn classic-btn btn-blue-classic text-sm py-2 px-4 opacity-50 cursor-not-allowed" disabled>
                                                ورود به لابی
                                            </button>`;

                        const lobbyItem = document.createElement('div');
                        // Adjusted for RTL and flex layout for better responsiveness
                        lobbyItem.className = 'bg-gray-800 p-4 rounded-lg shadow-md mb-3 flex flex-col sm:flex-row justify-between items-center text-right sm:text-left w-full';
                        lobbyItem.innerHTML = `
                            <div class="mb-2 sm:mb-0 text-center sm:text-right">
                                <h3 class="text-xl font-bold text-yellow-300">${lobby.name}</h3>
                                <p class="text-sm text-gray-300">سازنده: ${hostDisplayName}</p>
                                <p class="text-sm text-gray-300">بازیکنان: ${playerCount}/${maxPlayers}</p>
                            </div>
                            <div class="mt-2 sm:mt-0">
                                ${joinButtonHtml}
                            </div>
                        `;
                        lobbiesList.appendChild(lobbyItem);
                    });
                }
                
                activeGamesCount.textContent = activeGamesCountNum; // Update active games count in footer

                // Attach Event Listeners for "Join Lobby" buttons
                // For now, these buttons will just show a message that they are not active.
                lobbiesList.querySelectorAll('.join-lobby-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        showMessageBox("قابلیت ورود به لابی فعلا فعال نیست!", "info");
                        console.log("دکمه ورود به لابی کلیک شد اما غیرفعال است.");
                    });
                });

            }, (error) => {
                console.error("خطا در گوش دادن به لابی‌ها: ", error);
                showMessageBox("خطا در بارگذاری لیست لابی‌ها.", "error");
            });

            return unsubscribe; // Return the unsubscribe function
        }

        /**
         * Adds a user to an existing lobby. (This function is currently not directly called by UI due to disabled join button)
         * @param {string} lobbyId - The ID of the lobby to join.
         * @param {string} userId - The UID of the user joining.
         * @param {string} displayName - The display name of the user joining.
         */
        async function joinLobby(lobbyId, userId, displayName) {
            const lobbyRef = doc(db, `artifacts/${appId}/public/data/lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) {
                    showMessageBox("لابی مورد نظر یافت نشد.", "error");
                    return;
                }

                const lobbyData = lobbySnap.data();
                const players = lobbyData.players || [];
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;

                if (players.some(p => p.uid === userId)) {
                    showMessageBox("شما قبلاً در این لابی هستید.", "info");
                    // Optionally, redirect to the lobby details page
                    return;
                }

                if (players.length >= maxPlayers) {
                    showMessageBox("لابی پر است.", "error");
                    return;
                }

                // Add the new player
                const newPlayer = { uid: userId, displayName: displayName };
                await updateDoc(lobbyRef, {
                    players: arrayUnion(newPlayer)
                });

                showMessageBox(`شما به لابی "${lobbyData.name}" وارد شدید.`, "success");
                console.log(`کاربر ${userId} به لابی ${lobbyId} پیوست.`);

                // Check if the lobby is now full after joining
                const updatedLobbySnap = await getDoc(lobbyRef); // Fetch again for latest state
                const updatedPlayers = updatedLobbySnap.data().players;
                if (updatedPlayers.length === maxPlayers) {
                    await updateDoc(lobbyRef, {
                        status: "playing" // Change status to playing if full
                    });
                    showMessageBox("لابی پر شد! بازی به زودی شروع می‌شود.", "info");
                    // TODO: Implement game start logic and transition to game screen
                }

            } catch (e) {
                console.error("خطا در ورود به لابی: ", e);
                showMessageBox("خطا در ورود به لابی. لطفاً دوباره تلاش کنید.", "error");
                throw e; // Re-throw to be caught by the event listener
            }
        }

        // --- Event Listeners for Auth Screen Toggles ---
        loginToggleBtn.addEventListener('click', () => {
            authMode = 'login';
            displayNameField.classList.add('hidden'); // Hide display name field for login
            submitAuthBtn.textContent = 'ورود'; // Set text for submit button
            submitAuthBtn.classList.remove('hidden'); // Show submit button
            loginToggleBtn.classList.add('hidden'); // Hide login toggle
            registerToggleBtn.classList.remove('hidden'); // Show register toggle
            emailInput.focus(); // Focus on email input
            console.log("حالت احراز هویت به: ورود تغییر یافت.");
        });

        registerToggleBtn.addEventListener('click', () => {
            authMode = 'register';
            displayNameField.classList.remove('hidden'); // Show display name field for register
            submitAuthBtn.textContent = 'ثبت نام'; // Set text for submit button
            submitAuthBtn.classList.remove('hidden'); // Show submit button
            registerToggleBtn.classList.add('hidden'); // Hide register toggle
            loginToggleBtn.classList.remove('hidden'); // Show login toggle
            emailInput.focus(); // Focus on email input
            console.log("حالت احراز هویت به: ثبت نام تغییر یافت.");
        });

        // --- Event Listener for Main Auth Form Submission ---
        submitAuthBtn.addEventListener('click', async (e) => {
            e.preventDefault(); // Prevent default form submission
            console.log(`فرم احراز هویت در حالت ${authMode} ارسال شد.`);

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const displayName = displayNameInput.value.trim(); // Get display name

            if (!email || !password) {
                showMessageBox("لطفاً ایمیل و رمز عبور را وارد کنید.", 'error');
                return;
            }

            if (authMode === 'register' && !displayName) {
                showMessageBox("لطفاً نام نمایشی خود را وارد کنید.", 'error');
                return;
            }

            if (authMode === 'login') {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessageBox(`با موفقیت وارد شدید!`, 'success');
                } catch (error) {
                    console.error("خطا در ورود:", error);
                    showMessageBox(getFirebaseErrorMessage(error.code), 'error');
                }
            } else if (authMode === 'register') {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Save user's display name to Firestore immediately after successful registration
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile/data`);
                    await setDoc(userDocRef, { displayName: displayName, email: email }, { merge: true }); // Use merge:true to avoid overwriting if doc exists
                    showMessageBox(`ثبت نام با موفقیت انجام شد!`, 'success');
                    // onAuthStateChanged will handle screen transition and data load after this
                } catch (error) {
                    console.error("خطا در ثبت نام:", error);
                    showMessageBox(getFirebaseErrorMessage(error.code), 'error');
                }
            }
        });

        // Prevent default form submission for the main form
        authForm.addEventListener('submit', (e) => e.preventDefault());


        // --- Event Listeners for Main Screen UI ---
        menuBtn.addEventListener('click', () => {
            openProfileModal(); // Menu button opens profile modal
            console.log("دکمه منو (سه خط) کلیک شد.");
        });

        profileSummary.addEventListener('click', () => {
            openProfileModal(); // Profile summary also opens profile modal
            console.log("روی خلاصه پروفایل کلیک شد.");
        });

        closeProfileModalBtn.addEventListener('click', closeProfileModal);

        profileModal.addEventListener('click', (e) => {
            // Close modal if clicked outside content
            if (e.target === profileModal) {
                closeProfileModal();
            }
        });

        // Friendly Game button now navigates to the lobby screen
        friendlyGameBtn.addEventListener('click', () => {
            if (!auth.currentUser) {
                showMessageBox("برای مشاهده لابی‌ها، ابتدا وارد حساب کاربری خود شوید.", "error");
                return;
            }
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener(); // Start listening to lobbies
            console.log("دکمه بازی دوستانه کلیک شد. رفتیم صفحه لابی‌ها.");
        });

        ratedGameBtn.addEventListener('click', () => {
            showMessageBox("صفحه بازی امتیازی به زودی!", "info");
            console.log("دکمه بازی امتیازی کلیک شد.");
        });

        // Logout button is now inside the profile modal
        profileLogoutBtn.addEventListener('click', async () => {
            console.log("دکمه خروج کلیک شد.");
            try {
                await signOut(auth);
                showMessageBox("با موفقیت از حساب کاربری خود خارج شدید.", 'info');
                closeProfileModal(); // Close modal after logout
                // onAuthStateChanged will handle screen transition
            } catch (error) {
                console.error("خطا در خروج:", error);
                showMessageBox(`خطا در خروج: ${getFirebaseErrorMessage(error.code)}`, 'error');
            }
        });

        // --- Event Listeners for Lobby Screen UI (NEW) ---
        backToMainBtn.addEventListener('click', () => {
            setActiveScreen(mainScreen);
            // If there's an active lobby listener, unsubscribe it to stop real-time updates
            if (unsubscribeLobbies) {
                unsubscribeLobbies();
                unsubscribeLobbies = null; // Clear the variable
                console.log("Listener لابی‌ها غیرفعال شد.");
            }
            console.log("دکمه بازگشت به صفحه اصلی کلیک شد.");
        });

        // Footer Add Icon Button opens the create lobby modal
        addIconBtn.addEventListener('click', () => {
            if (!auth.currentUser || !currentUserData || !currentUserData.displayName) {
                showMessageBox("برای ساخت لابی، باید وارد حساب کاربری خود شوید و نام نمایشی داشته باشید.", "error");
                return;
            }
            openCreateLobbyModal();
            console.log("آیکون 'ایجاد' در فوتر کلیک شد. مودال ساخت لابی باز شد.");
        });
        
        // This button was removed from HTML as per user request. 
        // createLobbyBtn.addEventListener('click', ...) // No longer needed

        // Create Lobby Modal form submission
        submitCreateLobbyBtn.addEventListener('click', async (e) => {
            e.preventDefault(); // Prevent default form submission
            const lobbyName = newLobbyNameInput.value.trim();

            if (!lobbyName) {
                showCreateLobbyMessageBox("لطفاً نام لابی را وارد کنید.", "error");
                return;
            }

            if (!auth.currentUser || !currentUserData || !currentUserData.displayName) {
                showCreateLobbyMessageBox("مشکلی در اطلاعات کاربری شما وجود دارد. لطفاً دوباره وارد شوید.", "error");
                return;
            }

            try {
                // Pass display name along with UID
                await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName);
                showCreateLobbyMessageBox("لابی شما با موفقیت ساخته شد!", "success");
                newLobbyNameInput.value = ''; // Clear input
                setTimeout(closeCreateLobbyModal, 1500); // Close modal after a short delay
            } catch (error) {
                console.error("خطا در ساخت لابی از مودال:", error);
                showCreateLobbyMessageBox(`خطا در ساخت لابی: ${error.message}`, "error"); // Use raw error message for debug
            }
        });

        // Close Create Lobby Modal button
        closeCreateLobbyModalBtn.addEventListener('click', closeCreateLobbyModal);

        // Close Create Lobby Modal if clicked outside content
        createLobbyModal.addEventListener('click', (e) => {
            if (e.target === createLobbyModal) {
                closeCreateLobbyModal();
            }
        });
        
        refreshLobbiesBtn.addEventListener('click', () => {
            // Simply re-trigger the listener by unsubscribing and re-subscribing
            if (unsubscribeLobbies) {
                unsubscribeLobbies();
                unsubscribeLobbies = null;
            }
            if (auth.currentUser) { // Only refresh if a user is logged in
                unsubscribeLobbies = setupLobbyListener();
                showMessageBox("لیست لابی‌ها بروزرسانی شد.", "info");
                console.log("آیکون 'بروزرسانی' در فوتر کلیک شد.");
            } else {
                showMessageBox("برای بروزرسانی لابی‌ها، ابتدا وارد شوید.", "info");
            }
        });

        myLobbiesBtn.addEventListener('click', () => {
            showMessageBox("قابلیت 'لابی‌های من' به زودی!", "info");
            console.log("آیکون 'لابی‌های من' در فوتر کلیک شد.");
        });

        // Search input functionality (basic for now)
        lobbySearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            // TODO: Implement actual search/filter logic here.
            // For now, this just logs the search term.
            // In a real app, you'd modify the Firestore query or filter the displayed list.
            console.log("جستجو برای:", searchTerm);
        });
        
        // Search button (currently only logs search term)
        searchLobbiesBtn.addEventListener('click', () => {
            const searchTerm = lobbySearchInput.value.trim();
            if (searchTerm) {
                showMessageBox(`در حال جستجو برای "${searchTerm}"... (قابلیت جستجو به زودی فعال می‌شود)`, "info");
            } else {
                showMessageBox("لطفاً عبارتی برای جستجو وارد کنید.", "info");
            }
            console.log("دکمه جستجو کلیک شد. عبارت جستجو:", searchTerm);
        });


        // Start Firebase initialization when the window loads
        window.onload = initializeFirebaseAndAuth;

    </script>
</body>
</html>

