<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            /* Deep, rich, slightly textured background for classic feel */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod border */
            border-radius: 20px; /* Slightly larger radius */
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            backdrop-filter: blur(10px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh; /* Ensure card doesn't overflow viewport */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
            /* UPDATED: Allow vertical scroll for taller modals */
            overflow-y: auto;
        }
        /* Custom Scrollbar for Modals */
        .classic-card::-webkit-scrollbar { width: 8px; }
        .classic-card::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .classic-card::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .classic-card::-webkit-scrollbar-thumb:hover { background: #FFD700; }
        
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid #FFD700;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid #FFD700;
            border-right: 5px solid #FFD700;
            border-radius: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }


        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother transition */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); /* Stronger shadow on hover */
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
        }

        /* Specific Button Colors - Classic Pallette */
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        .btn-gold-classic { background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); border: none; padding: 0.5rem; border-radius: 10px; }
        .btn-gold-classic:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3); }

        /* Input Field Styles - More refined Classic Look */
        input, select, textarea {
            background-color: #202020; /* Even darker input background */
            border: 2px solid #5A5A5A; /* Dark gray border */
            color: #E0E0E0; /* Light text color */
            padding: 0.875rem; /* Equivalent to p-3.5 */
            border-radius: 0.75rem; /* Equivalent to rounded-xl */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); /* Inner shadow for depth */
            width: 100%; /* Make all form elements full width by default */
        }
        input::placeholder, textarea::placeholder { color: #A0A0A0; /* Lighter placeholder text */ }
        input:focus, select:focus, textarea:focus {
            border-color: #DAA520 !important; /* Gold border on focus */
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; /* Gold focus ring with inner shadow */
            outline: none;
        }

        /* === NEW: Create Lobby Form Specific Styles === */
        .form-section-title {
            color: #DAA520;
            font-size: 1.1rem;
            font-weight: bold;
            border-bottom: 1px solid #DAA520;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #E0E0E0;
            font-weight: bold;
            text-align: right;
        }
        .form-radio-group {
            display: flex;
            gap: 1rem;
            background-color: #202020;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 2px solid #5A5A5A;
        }
        .form-radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 0.5rem;
        }
        .form-radio-group input[type="radio"] {
            width: auto; /* Override default width for radios */
        }

        /* Lobby Type Toggle Styles */
        .lobby-type-btn { padding: 0.5rem 1.5rem; border: 2px solid #DAA520; border-radius: 10px; transition: all 0.2s ease-in-out; background-color: transparent; color: #DAA520; font-weight: bold; }
        .lobby-type-btn.active { background-color: #DAA520; color: #1A1A1A; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .lobby-lock-icon { width: 1.2rem; height: 1.2rem; margin-left: 0.5rem; color: #FFD700; display: inline-block; vertical-align: middle; }

        /* Header specific styles - Richer Gold/Brown */
        .app-header { background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); height: 70px; position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
        .lobby-header { background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); height: 70px; position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: center; }
        .lobby-header .search-container { display: flex; flex-grow: 1; max-width: 600px; margin: 0 auto; align-items: center; background-color: #303030; border-radius: 15px; border: 2px solid #5A5A5A; padding: 0.5rem 1rem; }
        .lobby-header .search-container input { flex-grow: 1; background-color: transparent; border: none; padding: 0.25rem 0.5rem; outline: none; text-align: right; }
        .lobby-header .search-container input::placeholder { color: #A0A0A0; }
        .lobby-header .search-container svg { color: #DAA520; min-width: 24px; min-height: 24px; }
        .lobby-header .search-container button { background: none; border: none; cursor: pointer; padding: 0 0.5rem; }
        .lobby-header .back-btn-wrapper { margin-left: 10px; }
        .lobby-header .search-icon-wrapper { margin-right: 10px; }

        .app-footer { background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); height: 90px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding: 1rem; display: flex; justify-content: space-around; align-items: center; }
        .lobby-footer { background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); height: 90px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding: 1rem; display: flex; justify-content: space-around; align-items: center; }
        .lobby-footer .icon-btn { display: flex; flex-direction: column; align-items: center; color: #FFD700; font-size: 0.8rem; text-align: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        .lobby-footer .icon-btn:hover { transform: translateY(-5px); }
        .lobby-footer .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .lobby-footer .icon-btn svg { width: 30px; height: 30px; margin-bottom: 5px; transition: transform 0.8s ease-in-out; }
        .lobby-footer .games-running-text { color: #E0E0E0; font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        .main-content-area { padding-top: 70px; padding-bottom: 90px; flex-grow: 1; overflow-y: auto; overflow-x: hidden; width: 100%; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); position: relative; }
        .main-content-area::-webkit-scrollbar { width: 8px; }
        .main-content-area::-webkit-scrollbar-track { background: #202020; }
        .main-content-area::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        
        .profile-modal-overlay { background-color: rgba(0,0,0,0.7); transition: opacity 0.3s ease-in-out; }
        .profile-modal-content { transform: translateY(-20px); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .profile-modal-enter-active .profile-modal-content { transform: translateY(0); }
        .profile-modal-leave-active .profile-modal-content { transform: translateY(-20px); opacity: 0; }
        #create-lobby-modal, #confirmation-modal { background-color: rgba(0,0,0,0.7); transition: opacity 0.3s ease-in-out; }
        .lobby-item.fade-out { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }

        /* Enhanced Lobby Item Styling */
        .lobby-item { background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%); border: 2px solid #DAA520; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; overflow: hidden; padding: 1.25rem 1.5rem; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; }
        .lobby-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255,255,255,0.05); transform: skewX(-30deg); transition: all 0.3s ease-in-out; }
        .lobby-item:hover::before { left: 100%; }
        .lobby-item:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2); }
        .lobby-item h3 { color: #FFD700; font-size: 1.75rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        .lobby-item p { color: #C0C0C0; font-size: 1rem; margin-top: 0.25rem; }
        .lobby-item .lobby-details { margin-top: 0.5rem; font-size: 0.9rem; color: #b0b0b0; } /* NEW: For showing game settings */
        .lobby-item .lobby-actions { margin-top: 1rem; display: flex; flex-direction: column; width: 100%; gap: 0.75rem; }
        .lobby-item .join-lobby-btn, .lobby-item .close-lobby-btn { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; }
        @media (min-width: 640px) {
            .lobby-item { flex-direction: row; text-align: right; }
            .lobby-item .lobby-actions { flex-direction: row; width: auto; margin-top: 0; gap: 0.5rem; }
            .lobby-item .close-lobby-btn { margin-right: 0.5rem; }
            .lobby-item .join-lobby-btn, .lobby-item .close-lobby-btn { width: auto; font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        }

        /* === Lobby Detail Screen Styles (Major Redesign) === */
        .lobby-detail-screen-full { padding-top: 0; padding-bottom: 0; display: flex; flex-direction: column; width: 100%; height: 100%; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        .lobby-detail-content { background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%); border: 3px solid #DAA520; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.7); padding: 1.5rem; width: 95%; max-width: 1200px; height: calc(100% - 100px); display: flex; flex-direction: row; gap: 1.5rem; margin: 50px auto; overflow: hidden; }
        .lobby-sidebar { display: flex; flex-direction: column; flex-shrink: 0; width: 300px; background-color: rgba(0,0,0,0.3); border-radius: 15px; padding: 1rem; border: 1px solid #444; overflow-y: auto; }
        .lobby-main-panel { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        #player-list-container { margin-top: 1rem; flex-grow: 1; overflow-y: auto; }
        .player-list-item { background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: all 0.2s ease-in-out; }
        .player-list-item.is-host { border-color: #FFD700; }
        .player-list-item .player-name { font-weight: bold; color: #E0E0E0; }
        .player-list-item .host-label { color: #FFD700; font-size: 0.8rem; margin-right: 0.5rem; }
        .kick-player-btn { background: none; border: 1px solid #B22222; color: #B22222; border-radius: 5px; padding: 0.2rem 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
        .kick-player-btn:hover { background: #B22222; color: white; }
        .lobby-chat-container { background-color: rgba(0,0,0,0.4); border: 2px solid #5A5A5A; border-radius: 10px; padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .lobby-chat-messages { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; display: flex; flex-direction: column; }
        .chat-message { background-color: #333; padding: 0.5rem 0.75rem; border-radius: 10px; margin-bottom: 0.5rem; max-width: 80%; word-wrap: break-word; align-self: flex-start; display: flex; align-items: center; gap: 0.5rem; }
        .chat-message.current-user { background-color: #4682B4; align-self: flex-end; flex-direction: row-reverse; }
        .chat-message-content { flex-grow: 1; }
        .chat-message .sender-name { font-weight: bold; color: #FFD700; display: block; font-size: 0.9em; margin-bottom: 0.2rem; }
        .chat-message .message-text-deleted { font-style: italic; color: #999; }
        .delete-message-btn { background: none; border: none; color: #aaa; cursor: pointer; padding: 0.25rem; opacity: 0.5; transition: all 0.2s ease; flex-shrink: 0; }
        .chat-message:hover .delete-message-btn { opacity: 1; }
        .delete-message-btn:hover { color: #ff6b6b; transform: scale(1.1); }
        .lobby-chat-input-form { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-shrink: 0; }
        .lobby-actions-footer { flex-shrink: 0; margin-top: 1rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
        .start-game-btn { background: linear-gradient(145deg, #228B22 0%, #006400 100%); border: 2px solid #DAA520; font-size: 1.1rem; padding: 0.6rem 1.2rem; }
        #host-actions-container { display: flex; flex-wrap: wrap; gap: 1rem; }
        .lobby-sidebar::-webkit-scrollbar, #player-list-container::-webkit-scrollbar, .lobby-chat-messages::-webkit-scrollbar { width: 8px; }
        .lobby-sidebar::-webkit-scrollbar-track, #player-list-container::-webkit-scrollbar-track, .lobby-chat-messages::-webkit-scrollbar-track { background: #202020; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb, #player-list-container::-webkit-scrollbar-thumb, .lobby-chat-messages::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb:hover, #player-list-container::-webkit-scrollbar-thumb:hover, .lobby-chat-messages::-webkit-scrollbar-thumb:hover { background: #FFD700; }
        
        /* ===== CORRECTED RESPONSIVE STYLES ===== */
        @media (max-width: 860px) {
            .lobby-detail-content { flex-direction: column; height: calc(100% - 80px); margin: 40px auto; padding: 1rem; overflow: hidden; }
            .lobby-sidebar { width: 100%; flex-shrink: 0; max-height: 250px; }
            .lobby-main-panel { flex-grow: 1; min-height: 0; }
        }
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header, .app-footer, .lobby-footer { padding: 0.5rem; }
            .app-header, .lobby-header { height: 60px; }
            .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; }
            .lobby-detail-content { margin: 20px auto; height: calc(100% - 40px); }
        }
        
        /* === Game Screen Styles (REDESIGNED) === */
        #game-screen { background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); transform-style: preserve-3d; perspective: 2000px; }
        #game-table { background: #6B4F35; background-image: radial-gradient(ellipse at center, rgba(160, 127, 92, 0.8) 0%, rgba(74, 51, 32, 0.9) 100%), repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px); border: 15px solid #4A3320; border-image-source: linear-gradient(145deg, #4A3320, #8C6F4F, #4A3320); border-image-slice: 1; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.85), inset 0 0 40px rgba(0,0,0,0.7); border-radius: 100px; transform-style: preserve-3d; position: relative; }
        .player-slot { transform-style: preserve-3d; }
        .player-area-container { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 12px; transition: all 0.3s ease-in-out; z-index: 10; }
        .player-avatar { width: 60px; height: 60px; background: linear-gradient(145deg, #333, #111); border: 3px solid #DAA520; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #FFD700; box-shadow: inset 0 3px 6px rgba(0,0,0,0.6), 0 2px 4px rgba(0,0,0,0.4); }
        .player-avatar svg { width: 32px; height: 32px; }
        .player-name-display { color: white; font-weight: bold; text-shadow: 2px 2px 3px #000; background: rgba(0,0,0,0.5); padding: 0.2rem 0.8rem; border-radius: 8px; }
        .player-slot.active-turn .player-area-container { transform: scale(1.1); background-color: rgba(255, 215, 0, 0.1); box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5); }
        .player-slot.active-turn .player-name-display { color: #FFD700; }
        .player-slot .player-hand { display: flex; perspective: 800px; }
        .card { width: 70px; height: 100px; background-color: white; border: 1px solid #333; border-radius: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; font-size: 24px; font-weight: bold; user-select: none; transition: all 0.2s ease-out; position: relative; }
        .card.back { background-image: linear-gradient(135deg, #4B0000, #800000); border: 2px solid #DAA520; }
        .card.red { color: #DC2626; } .card.black { color: #111827; }
        .card-rank { font-family: 'Playfair Display', serif; }
        .card-suit { font-size: 20px; } .card-suit.top { transform: rotate(0deg); } .card-suit.bottom { transform: rotate(180deg); }
        #player-slot-bottom .player-hand { gap: -35px; margin-top: -30px; }
        #player-slot-bottom .card:not(.back) { cursor: pointer; }
        #player-slot-bottom .card:not(.back):hover { transform: translateY(-20px) scale(1.05); z-index: 100; box-shadow: 0 12px 24px rgba(0,0,0,0.5); }
        #player-slot-left, #player-slot-right { display: flex; align-items: center; gap: 1.5rem; }
        #player-slot-right { flex-direction: row-reverse; }
        #player-slot-left .player-hand, #player-slot-right .player-hand { flex-direction: column; gap: -80px; }
        #player-slot-top .player-area-container { flex-direction: column-reverse; }
        #player-slot-top .player-hand { gap: -35px; margin-bottom: -30px; }
        #play-area { transform-style: preserve-3d; perspective: 1000px; }
        #play-area .card { position: absolute; transform: none; box-shadow: 0 8px 16px rgba(0,0,0,0.5); transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        #play-area .played-card-bottom { bottom: -50px; transform: translateY(0); }
        #play-area .played-card-left { left: -50px; transform: rotate(90deg) translateX(-50%) translateY(50%); transform-origin: center; }
        #play-area .played-card-top { top: -50px; transform: rotate(180deg); }
        #play-area .played-card-right { right: -50px; transform: rotate(-90deg) translateX(50%) translateY(50%); transform-origin: center; }
        #player-slot-bottom { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; }
        #player-slot-top { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center;}
        #player-slot-left { left: 40px; top: 50%; transform: translateY(-50%); }
        #player-slot-right { right: 40px; top: 50%; transform: translateY(-50%); }
        @media (max-width: 768px) {
            .card { width: 50px; height: 75px; font-size: 18px; border-radius: 4px; } .card-suit { font-size: 16px; }
            #player-slot-bottom .player-hand, #player-slot-top .player-hand { gap: -25px; } #player-slot-left .player-hand, #player-slot-right .player-hand { gap: -60px; }
            #player-slot-bottom { bottom: 10px; } #player-slot-top { top: 10px; } #player-slot-left { left: 10px; } #player-slot-right { right: 10px; }
            .player-avatar { width: 50px; height: 50px; } .player-avatar svg { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- All Modals and other screens remain the same... -->
        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="email" placeholder="ایمیل شما"
                               class="focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)"
                               class="focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">ورود</button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">ثبت نام</button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl hidden">ادامه</button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="app-header">
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </header>
            <div class="main-content-area">
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>
            <footer class="app-footer">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">بازی دوستانه</button>
                <button id="rated-game-btn" class="classic-btn btn-brown-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">بازی امتیازی</button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </button>
                </div>
            </header>
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Profile Modal (Hidden by default) -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div class="text-lg space-y-4 mb-8 text-white">
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                </div>
                <button id="profile-logout-btn" class="w-full classic-btn btn-red-classic text-lg sm:text-xl">خروج از حساب</button>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (REDESIGNED with Advanced Options) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-lg text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <form id="create-lobby-form" class="space-y-4 text-right">
                    
                    <!-- Basic Info Section -->
                    <h3 class="form-section-title">اطلاعات پایه</h3>
                    <div>
                        <label for="new-lobby-name-input" class="form-label">نام لابی</label>
                        <input type="text" id="new-lobby-name-input" placeholder="مثال: بازی دوستانه ما" required>
                    </div>
                    
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="public" class="sr-only" checked>
                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
                    </div>
        
                    <div id="new-lobby-password-field" class="hidden relative">
                        <label for="new-lobby-password-input" class="form-label">رمز عبور لابی</label>
                        <input type="password" id="new-lobby-password-input" placeholder="حداقل ۴ کاراکتر" class="pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 mt-3 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>

                    <!-- Game Settings Section -->
                    <h3 class="form-section-title">تنظیمات بازی</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-lobby-gamemode" class="form-label">حالت بازی</label>
                            <select id="new-lobby-gamemode">
                                <option value="classic_hokm">حکم کلاسیک</option>
                                <option value="shelem" disabled>شلم (به زودی)</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-lobby-score-to-win" class="form-label">امتیاز برای پیروزی</label>
                            <input type="number" id="new-lobby-score-to-win" value="7" min="1" max="11">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">چیدمان تیم‌ها</label>
                        <div class="form-radio-group">
                            <label>
                                <input type="radio" name="team-arrangement" value="random" checked>
                                <span>تصادفی</span>
                            </label>
                             <label>
                                <input type="radio" name="team-arrangement" value="manual">
                                <span>دستی (در لابی)</span>
                            </label>
                        </div>
                    </div>
                    <div>
                         <label for="new-lobby-description" class="form-label">توضیحات لابی (اختیاری)</label>
                         <textarea id="new-lobby-description" rows="3" placeholder="قوانین خاص یا پیام خوشامدگویی خود را اینجا بنویسید..."></textarea>
                    </div>
        
                    <button type="submit" id="submit-create-lobby-btn" class="w-full mt-6 classic-btn btn-green-classic text-xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-2">بازیکنان: 0/4</p>
                    
                    <!-- NEW: Display for game settings -->
                    <div id="detail-game-settings" class="text-sm text-gray-400 space-y-1 mb-4">
                        <p><strong>حالت:</strong> <span id="detail-game-mode">---</span></p>
                        <p><strong>هدف:</strong> <span id="detail-score-to-win">---</span> امتیاز</p>
                        <p><strong>تیم‌بندی:</strong> <span id="detail-team-arrangement">---</span></p>
                    </div>

                    <div class="w-full h-px bg-yellow-600 mb-4"></div>
                    <div id="player-list-container"></div>
                </div>
                <div class="lobby-main-panel">
                    <div class="lobby-chat-container">
                        <div id="lobby-chat-messages" class="lobby-chat-messages"></div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form">
                            <input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled>شروع بازی</button>
                            <button id="toggle-chat-lock-btn" class="classic-btn btn-gray-classic text-sm py-2 px-4">قفل کردن چت</button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4">لیست اخراجی‌ها</button>
                        </div>
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4 hidden">بستن لابی</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9. Game Screen -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden flex flex-col items-center justify-center p-2" tabindex="-1">
            <div class="absolute top-0 left-0 right-0 h-20 bg-black bg-opacity-40 flex justify-between items-center px-4 z-20">
                <div id="game-team-scores" class="text-white text-lg font-bold">
                    <span>تیم ما: <span id="our-team-score" class="text-xl text-green-300">0</span></span> |
                    <span>تیم حریف: <span id="their-team-score" class="text-xl text-red-300">0</span></span>
                </div>
                <div id="game-hokm-indicator" class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-xl font-bold text-yellow-300">حکم:</span>
                    <span id="hokm-suit-icon" class="text-4xl">❓</span>
                </div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی</button>
            </div>
            <div id="game-table" class="relative w-[98vw] h-[85vh] max-w-[1200px] max-h-[800px] flex items-center justify-center">
                <div id="play-area" class="absolute w-80 h-48 flex items-center justify-center"></div>
                <div id="player-slot-bottom" class="player-slot absolute"><div class="player-area-container"><div class="player-avatar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></div><span class="player-name-display">شما</span></div><div class="player-hand flex justify-center"></div></div>
                <div id="player-slot-left" class="player-slot absolute"><div class="player-hand flex justify-center"></div><div class="player-area-container"><div class="player-avatar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></div><span class="player-name-display">بازیکن ۲</span></div></div>
                <div id="player-slot-top" class="player-slot absolute"><div class="player-area-container"><div class="player-avatar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></div><span class="player-name-display">یار شما</span></div><div class="player-hand flex justify-center"></div></div>
                <div id="player-slot-right" class="player-slot absolute"><div class="player-hand flex justify-center"></div><div class="player-area-container"><div class="player-avatar"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></div><span class="player-name-display">بازیکن ۴</span></div></div>
            </div>
        </div>

        <!-- Remaining Modals (Kick, Kicked Message, etc.) -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"><div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">اخراج بازیکن</h2><button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button><p class="text-lg mb-8 text-white">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p><div class="flex justify-around space-x-4 space-x-reverse"><button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button><button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button></div></div></div>
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"><div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-400">شما اخراج شدید!</h2><p id="kicked-message-text" class="text-lg mb-8 text-white">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p><button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button></div></div>
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"><div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">لیست بازیکنان اخراج شده</h2><button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button><div id="kicked-players-list-content" class="space-y-4 mb-8 text-white text-left max-h-60 overflow-y-auto custom-scrollbar"><p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p></div><button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button></div></div>
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"><div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2><p class="text-lg mb-6 text-white">لابی <span id="password-prompt-lobby-name" class="font-bold text-yellow-300"></span> نیاز به رمز عبور دارد.</p><form id="enter-password-form" class="space-y-5"><div><input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید" class="text-center" required></div><div class="flex justify-around space-x-4 space-x-reverse"><button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button><button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button></div></form><div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div></div></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements (Existing ones remain the same)
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const ratedGameBtn = document.getElementById('rated-game-btn');
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn');
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn');
        const myLobbiesBtn = document.getElementById('my-lobbies-btn');
        const activeGamesCount = document.getElementById('active-games-count');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const toggleChatLockBtn = document.getElementById('toggle-chat-lock-btn');
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChatSendBtn = document.getElementById('lobby-chat-send-btn');
        const gameScreen = document.getElementById('game-screen');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const hokmSuitIcon = document.getElementById('hokm-suit-icon');
        const ourTeamScoreEl = document.getElementById('our-team-score');
        const theirTeamScoreEl = document.getElementById('their-team-score');
        const playArea = document.getElementById('play-area');
        const playerSlots = { bottom: document.getElementById('player-slot-bottom'), left: document.getElementById('player-slot-left'), top: document.getElementById('player-slot-top'), right: document.getElementById('player-slot-right'), };
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-btn');
        const kickPlayerConfirmName = document.getElementById('kick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedLobbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');
        const kickedPlayersListModal = document.getElementById('kicked-players-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        const kickedPlayersListContent = document.getElementById('kicked-players-list-content');
        const kickedListOkBtn = document.getElementById('kicked-list-ok-btn');
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');
        
        // --- NEW: Create Lobby Modal Elements ---
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field');
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');
        const newLobbyGameModeInput = document.getElementById('new-lobby-gamemode');
        const newLobbyScoreToWinInput = document.getElementById('new-lobby-score-to-win');
        const newLobbyDescriptionInput = document.getElementById('new-lobby-description');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');

        // --- NEW: Lobby Detail Screen Game Setting Elements ---
        const detailGameSettings = document.getElementById('detail-game-settings');
        const detailGameMode = document.getElementById('detail-game-mode');
        const detailScoreToWin = document.getElementById('detail-score-to-win');
        const detailTeamArrangement = document.getElementById('detail-team-arrangement');

        // State variables (Existing ones remain the same)
        let authMode = 'login'; 
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; 
        let unsubscribeLobbies = null; 
        let unsubscribeLobbyDetail = null; 
        let unsubscribeGame = null; 
        let unsubscribeKickedPlayers = null;
        let unsubscribeLobbyChat = null;
        let isAuthResolved = false;
        let userHasActiveLobby = false;
        let currentLobbyId = null;
        let kickedPlayerToProcess = null;
        let lobbyToJoin = null;
        let isRefreshing = false;
        let resolveCustomConfirm;

        // Utility Functions (showCustomMessage, showMessageBox, etc.) remain the same
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);

        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                void customConfirmModal.offsetWidth;
                customConfirmModal.classList.add('profile-modal-enter-active');
                resolveCustomConfirm = resolve;
                confirmYesBtn.onclick = () => { closeCustomConfirm(); resolveCustomConfirm(true); };
                confirmNoBtn.onclick = () => { closeCustomConfirm(); resolveCustomConfirm(false); };
            });
        }
        function closeCustomConfirm() {
            customConfirmModal.classList.remove('profile-modal-enter-active');
            customConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                customConfirmModal.classList.add('hidden');
                customConfirmModal.classList.remove('profile-modal-leave-active');
            }, 300);
        }

        // Screen and Modal Management functions (setActiveScreen, open/close modals) remain the same
        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                currentActiveScreen = newScreen;
            }, 600);
        }
        function openProfileModal() { /* ... implementation unchanged ... */ }
        function closeProfileModal() { /* ... implementation unchanged ... */ }
        function openCreateLobbyModal() {
            createLobbyModal.classList.remove('hidden');
            void createLobbyModal.offsetWidth;
            createLobbyModal.classList.add('profile-modal-enter-active');
            newLobbyNameInput.focus();
            createLobbyMessageBox.classList.add('hidden');
            createLobbyForm.reset();
            // Reset state to default
            document.querySelector('input[value="public"]').click();
            document.querySelector('input[name="team-arrangement"][value="random"]').checked = true;
            newLobbyScoreToWinInput.value = 7;
        }

        function closeCreateLobbyModal() {
            createLobbyModal.classList.remove('profile-modal-enter-active');
            createLobbyModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                createLobbyModal.classList.add('hidden');
                createLobbyModal.classList.remove('profile-modal-leave-active');
            }, 300);
        }
        // ... other modal functions remain unchanged ...

        /**
         * AI content moderation function - unchanged.
         */
        async function checkLobbyNameWithAI(lobbyName) {
            const prompt = `As a highly rigorous and professional content moderation AI, meticulously analyze the following lobby name for compliance with the strictest community guidelines across *all* languages. You must absolutely identify and disallow any political, racist, sexual, offensive, vulgar, violent, or otherwise inappropriate content, including but not limited to terms like "fuck", "asshole", "shit", "bitch", and their equivalents in Persian such as "کیر", "کون", "کس", "کسکش", "جنده", "حرومزاده", "بیناموس" etc., regardless of how they are spelled (e.g., phonetic or deliberate misspellings to evade detection). Your analysis should consider the context and intent where possible. Your response *must* be a JSON object: {"is_appropriate": boolean, "reason": string}. If 'is_appropriate' is false, provide a *brief, objective, and precise* reason identifying the specific type of violation (e.g., "Contains offensive language", "Political reference detected", "Violates decency standards"). If appropriate, 'reason' should be an empty string. Lobby name to analyze: "${lobbyName}"`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "is_appropriate": { "type": "BOOLEAN" }, "reason": { "type": "STRING" } }, "propertyOrdering": ["is_appropriate", "reason"] } } };
            const apiKey = "AIzaSyDfMZwyWNnRFUDLHKR1t_hZ5cWv2c_KvvE"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorText = await response.text(); console.error("AI API HTTP Error:", response.status, response.statusText, errorText); return { is_appropriate: false, reason: `خطا در ارتباط با سرور اعتدال: ${response.statusText}.` }; }
                const result = await response.json();
                if (result && result.candidates?.[0]?.content?.parts?.[0]) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try { const parsedJson = JSON.parse(jsonString); if (typeof parsedJson.is_appropriate === 'boolean' && typeof parsedJson.reason === 'string') { return parsedJson; } else { console.warn("AI response has unexpected structure:", parsedJson); return { is_appropriate: false, reason: "پاسخ سیستم اعتدال نامفهوم است." }; } } catch (parseError) { console.error("Error parsing AI response JSON:", parseError, "Raw:", jsonString); return { is_appropriate: false, reason: "خطا در پردازش پاسخ اعتدال." }; }
                } else { console.warn("AI response missing content structure:", result); return { is_appropriate: false, reason: "عدم دریافت پاسخ معتبر از سیستم اعتدال." }; }
            } catch (error) { console.error("Error calling AI moderation API:", error); return { is_appropriate: false, reason: `خطا در ارتباط با سیستم اعتدال: ${error.message}.` }; }
        }

        // Auth and Initialization logic remains the same
        onAuthStateChanged(auth, async (user) => { /* ... implementation unchanged ... */ });
        async function initializeFirebaseAndAuth() { /* ... implementation unchanged ... */ }
        function getFirebaseErrorMessage(errorCode) { /* ... implementation unchanged ... */ }

        // --- Firebase Lobby Functions (UPDATED) ---

        /**
         * Creates a new lobby with advanced settings.
         * @param {string} lobbyName - The name of the lobby.
         * @param {string} userId - The host's user ID.
         * @param {string} displayName - The host's display name.
         * @param {string} lobbyType - 'public' or 'private'.
         * @param {string|null} password - The password if private.
         * @param {object} settings - An object with advanced game settings.
         * @returns {Promise<string>} - The ID of the newly created lobby.
         */
        async function createLobby(lobbyName, userId, displayName, lobbyType, password, settings) {
            try {
                const creatorDisplayName = displayName && displayName.trim() !== '' ? displayName : 'ناشناس';
        
                // Check if user already has an active lobby (unchanged)
                const userLobbiesQuery = query(collection(db, `global_lobbies`), where("hostId", "==", userId), where("status", "in", ["waiting", "playing"]));
                const userLobbiesSnapshot = await getDocs(userLobbiesQuery);
                if (!userLobbiesSnapshot.empty) {
                    throw new Error("شما از قبل یک لابی فعال ساخته‌اید. لطفاً ابتدا لابی قبلی خود را ببندید.");
                }
        
                const newLobbyData = {
                    name: lobbyName,
                    hostId: userId,
                    status: "waiting",
                    type: lobbyType,
                    players: { [userId]: creatorDisplayName },
                    kickedPlayers: [],
                    createdAt: serverTimestamp(),
                    isChatLocked: false,
                    // === NEW: Store advanced settings ===
                    description: settings.description, // Store the lobby description
                    gameSettings: {
                        maxPlayers: 4, // Still fixed for Hokm
                        gameMode: settings.gameMode,
                        scoreToWin: settings.scoreToWin,
                        teamArrangement: settings.teamArrangement
                    }
                };
        
                if (lobbyType === 'private') {
                    newLobbyData.password = password;
                }
        
                const newLobbyRef = await addDoc(collection(db, `global_lobbies`), newLobbyData);
                console.log(`لابی ${lobbyType} با تنظیمات پیشرفته و ID ساخته شد: `, newLobbyRef.id);
                userHasActiveLobby = true;
                return newLobbyRef.id;
            } catch (e) {
                console.error("خطا در ساخت لابی: ", e);
                throw e;
            }
        }
        
        /**
         * Sets up the listener for the main lobby list (UPDATED to show new info).
         */
        function setupLobbyListener(searchTerm = '') {
            // ... (initial cleanup logic is unchanged)
            const q = query(collection(db, `global_lobbies`), where("status", "==", "waiting"));
        
            return onSnapshot(q, (snapshot) => {
                lobbiesList.innerHTML = '';
                let lobbiesToDisplay = [];
                let currentUserIsInAnyLobby = false;
        
                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    // ... (search and filter logic is unchanged)
                    lobbiesToDisplay.push(lobby);
                });

                userHasActiveLobby = lobbiesToDisplay.some(lobby => lobby.players[auth.currentUser?.uid]);
                
                lobbiesToDisplay.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        
                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p class="text-gray-400">لابی با این مشخصات یافت نشد.</p>';
                } else {
                    lobbiesToDisplay.forEach((lobby) => {
                        const { id, name, type, players, gameSettings, hostId, kickedPlayers } = lobby;
                        const playerCount = Object.keys(players || {}).length;
                        const maxPlayers = gameSettings?.maxPlayers || 4;
                        const hostDisplayName = players?.[hostId] || 'ناشناس';
                        const scoreToWin = gameSettings?.scoreToWin || 7;
                        
                        // ... (button logic is unchanged)
                        const isCurrentUserHostOfThisLobby = auth.currentUser && hostId === auth.currentUser.uid;
                        const isCurrentUserKicked = auth.currentUser && kickedPlayers?.some(p => p.uid === auth.currentUser.uid);
                        const canJoinThisLobby = auth.currentUser && !userHasActiveLobby && playerCount < maxPlayers && !isCurrentUserKicked;

                        const lockIconHtml = type === 'private' ? `<svg xmlns="http://www.w3.org/2000/svg" class="lobby-lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` : '';
        
                        let joinButtonHtml = `<button class="join-lobby-btn classic-btn btn-blue-classic opacity-50 cursor-not-allowed" disabled>ورود به لابی</button>`;
                        if (isCurrentUserKicked) joinButtonHtml = `<button class="join-lobby-btn classic-btn btn-red-classic opacity-50 cursor-not-allowed" disabled>اخراج شده‌اید</button>`;
                        else if (isCurrentUserHostOfThisLobby) joinButtonHtml = `<button data-lobby-id="${id}" class="view-my-lobby-btn classic-btn btn-blue-classic">ورود به لابی من</button>`;
                        else if (canJoinThisLobby) joinButtonHtml = `<button data-lobby-id="${id}" data-lobby-type="${type || 'public'}" data-lobby-name="${name}" class="join-lobby-btn classic-btn btn-blue-classic">ورود به لابی</button>`;
                        
                        const closeButtonHtml = isCurrentUserHostOfThisLobby ? `<button data-lobby-id="${id}" class="close-lobby-btn classic-btn btn-red-classic">بستن لابی</button>` : '';

                        const lobbyItem = document.createElement('div');
                        lobbyItem.className = 'lobby-item mb-3 w-full';
                        lobbyItem.dataset.lobbyId = id;
                        lobbyItem.innerHTML = `
                            <div class="flex-grow mb-2 sm:mb-0 text-center sm:text-right">
                                <h3 class="text-xl font-bold">${lockIconHtml}${name}</h3>
                                <p class="text-sm">سازنده: ${hostDisplayName} | بازیکنان: ${playerCount}/${maxPlayers}</p>
                                <!-- NEW: Display score goal in the list -->
                                <p class="lobby-details">بازی تا ${scoreToWin} امتیاز</p>
                            </div>
                            <div class="lobby-actions">
                                ${closeButtonHtml}
                                ${joinButtonHtml}
                            </div>
                        `;
                        lobbiesList.appendChild(lobbyItem);
                    });
                }
                
                // ... (event listeners for buttons are unchanged)
            });
        }
        
        /**
         * Sets up the listener for the lobby detail screen (UPDATED to show new info).
         */
        function setupLobbyDetailListener(lobbyId) {
            // ... (initial cleanup logic is unchanged)
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists()) {
                    const lobbyData = docSnap.data();
                    // ... (existing logic for game start, player list, host actions is unchanged)
                    
                    // === NEW: Update UI with detailed game settings ===
                    const settings = lobbyData.gameSettings || {};
                    const teamArrangementMap = { 'random': 'تصادفی', 'manual': 'دستی' };
                    const gameModeMap = { 'classic_hokm': 'حکم کلاسیک' };
                    
                    detailGameMode.textContent = gameModeMap[settings.gameMode] || 'نامشخص';
                    detailScoreToWin.textContent = settings.scoreToWin || '7';
                    detailTeamArrangement.textContent = teamArrangementMap[settings.teamArrangement] || 'نامشخص';

                    // Make the container visible if it was hidden
                    detailGameSettings.classList.remove('hidden');

                    // ... (rest of the function is unchanged: updating player list, buttons, chat lock, etc.)
                } else {
                    // ... (handle lobby deletion)
                }
            });
        }
        
        // --- Event Listeners ---
        // Auth, Profile, etc. listeners remain the same

        // --- UPDATED: createLobbyForm Submit Listener ---
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lobbyName = newLobbyNameInput.value.trim();
            const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;
        
            // === NEW: Get values from advanced settings fields ===
            const gameMode = newLobbyGameModeInput.value;
            const scoreToWin = parseInt(newLobbyScoreToWinInput.value, 10);
            const teamArrangement = document.querySelector('input[name="team-arrangement"]:checked').value;
            const description = newLobbyDescriptionInput.value.trim();
        
            // --- Validation ---
            if (!lobbyName) { showCreateLobbyMessageBox("لطفاً نام لابی را وارد کنید.", "error"); return; }
            if (lobbyType === 'private' && password.length < 4) { showCreateLobbyMessageBox("رمز عبور برای لابی خصوصی باید حداقل ۴ کاراکتر باشد.", "error"); return; }
            if (isNaN(scoreToWin) || scoreToWin < 1 || scoreToWin > 11) { showCreateLobbyMessageBox("امتیاز پیروزی باید عددی بین ۱ تا ۱۱ باشد.", "error"); return; }
            if (!auth.currentUser || !currentUserData?.displayName) { showCreateLobbyMessageBox("مشکلی در اطلاعات کاربری شما وجود دارد.", "error"); return; }
            if (userHasActiveLobby) { showCreateLobbyMessageBox("شما از قبل در یک لابی فعال هستید.", "info"); closeCreateLobbyModal(); return; }
        
            showCreateLobbyMessageBox("در حال بررسی نام لابی...", "info");
            try {
                const moderationResult = await checkLobbyNameWithAI(lobbyName);
                if (!moderationResult.is_appropriate) { showCreateLobbyMessageBox(`نام لابی نامناسب: ${moderationResult.reason}`, "error"); return; }
            } catch (aiError) { console.error("خطا در بررسی AI نام لابی:", aiError); showCreateLobbyMessageBox("خطایی در بررسی نام لابی پیش آمد.", "error"); return; }
        
            try {
                // Create settings object to pass to the function
                const lobbySettings = {
                    gameMode,
                    scoreToWin,
                    teamArrangement,
                    description
                };

                const newLobbyId = await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName, lobbyType, password, lobbySettings);
                
                showCreateLobbyMessageBox("لابی شما با موفقیت ساخته شد!", "success");
                
                setTimeout(() => {
                    closeCreateLobbyModal();
                    currentLobbyId = newLobbyId;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailListener(newLobbyId);
                }, 1500);
                
            } catch (error) {
                console.error("خطا در ساخت لابی از مودال:", error);
                showCreateLobbyMessageBox(error.message.includes("شما از قبل یک لابی فعال ساخته‌اید.") ? error.message : `خطا در ساخت لابی: ${error.message}`, "error");
            }
        });

        closeCreateLobbyModalBtn.addEventListener('click', closeCreateLobbyModal);
        createLobbyModal.addEventListener('click', (e) => e.target === createLobbyModal && closeCreateLobbyModal());

        lobbyTypeToggle.addEventListener('change', (e) => {
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            e.target.nextElementSibling.classList.add('active');
            if (e.target.value === 'private') {
                newLobbyPasswordField.classList.remove('hidden');
            } else {
                newLobbyPasswordField.classList.add('hidden');
            }
        });

        togglePasswordVisibilityBtn.addEventListener('click', () => {
            const isPassword = newLobbyPasswordInput.type === 'password';
            newLobbyPasswordInput.type = isPassword ? 'text' : 'password';
            eyeIconOpen.style.display = isPassword ? 'none' : 'block';
            eyeIconClosed.style.display = isPassword ? 'block' : 'none';
        });

        // All other event listeners (lobby list interactions, detail screen, game screen, etc.) remain unchanged.
        // ...

        // Initialize the app when the window loads
        window.onload = initializeFirebaseAndAuth;

        // --- Dummy implementations for unchanged functions to avoid breaking the script ---
        function openKickPlayerConfirmModal(playerName, playerUid) { kickPlayerConfirmName.textContent = playerName; kickPlayerConfirmModal.classList.remove('hidden'); kickedPlayerToProcess = { uid: playerUid, displayName: playerName }; }
        function closeKickPlayerConfirmModal() { kickPlayerConfirmModal.classList.add('hidden'); kickedPlayerToProcess = null; }
        function showKickedMessageModal(lobbyName) { kickedLobbyName.textContent = lobbyName; kickedMessageModal.classList.remove('hidden'); }
        function closeKickedMessageModal() { kickedMessageModal.classList.add('hidden'); setActiveScreen(lobbyScreen); unsubscribeLobbies = setupLobbyListener(''); }
        function openKickedPlayersListModal() { kickedPlayersListModal.classList.remove('hidden'); if (currentLobbyId) { unsubscribeKickedPlayers = setupKickedPlayersListListener(currentLobbyId); } }
        function closeKickedPlayersListModal() { kickedPlayersListModal.classList.add('hidden'); if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; } }
        async function kickPlayer(lobbyId, playerToKickUid, playerToKickDisplayName) { const lobbyRef = doc(db, `global_lobbies`, lobbyId); try { await updateDoc(lobbyRef, { [`players.${playerToKickUid}`]: deleteField(), kickedPlayers: arrayUnion({ uid: playerToKickUid, displayName: playerToKickDisplayName }) }); showMessageBox(`بازیکن "${playerToKickDisplayName}" اخراج شد.`, "success"); closeKickPlayerConfirmModal(); } catch (e) { console.error("Error kicking player:", e); showMessageBox("خطا در اخراج بازیکن.", "error"); } }
        async function unkickPlayer(lobbyId, playerToUnkickUid) { const lobbyRef = doc(db, `global_lobbies`, lobbyId); try { const lobbySnap = await getDoc(lobbyRef); if (lobbySnap.exists()) { const kickedPlayers = lobbySnap.data().kickedPlayers || []; const playerToUnkick = kickedPlayers.find(p => p.uid === playerToUnkickUid); if (playerToUnkick) { await updateDoc(lobbyRef, { kickedPlayers: arrayRemove(playerToUnkick) }); showMessageBox(`بازیکن "${playerToUnkick.displayName}" می‌تواند دوباره وارد شود.`, "success"); } } } catch (e) { console.error("Error unkicking player:", e); showMessageBox("خطا در بازگرداندن بازیکن.", "error"); } }
        function setupKickedPlayersListListener(lobbyId) { /* ... implementation unchanged ... */ return onSnapshot(doc(db, `global_lobbies`, lobbyId), (docSnap) => { /* ... */ }); }
        async function joinLobby(lobbyId, userId, displayName) { /* ... implementation unchanged ... */ }
        async function leaveLobby() { /* ... implementation unchanged ... */ }
        async function sendLobbyMessage(lobbyId, text) { /* ... implementation unchanged ... */ }
        async function deleteLobbyMessage(lobbyId, messageId) { /* ... implementation unchanged ... */ }
        function setupLobbyChatListener(lobbyId, hostId) { /* ... implementation unchanged ... */ return onSnapshot(query(collection(db, `global_lobbies/${lobbyId}/messages`), orderBy("timestamp", "asc")), (snapshot) => { /* ... */ }); }
        async function initializeGameInFirestore(lobbyId, lobbyData) { /* ... implementation unchanged ... */ }
        function setupGameListener(lobbyId) { /* ... implementation unchanged ... */ return onSnapshot(doc(db, `global_lobbies`, lobbyId), (docSnap) => { /* ... */ }); }
        function renderGameScreen(lobbyData) { /* ... implementation unchanged ... */ }

    </script>
</body>
</html>