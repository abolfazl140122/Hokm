<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی متنی هوش مصنوعی و انسان</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look & New Themes -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&family=Share+Tech+Mono&family=Orbitron:wght@400..900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
            transition: background-color 0.8s ease-in-out, color 0.8s ease-in-out; /* Smooth overall transition */
        }

        /* Base transitions for elements that change color/background */
        .classic-card,
        .classic-btn,
        input, select,
        .app-header, .lobby-header,
        .app-footer, .lobby-footer,
        .lobby-item,
        .lobby-chat-container,
        .chat-message,
        .game-player-pod,
        .voting-btn,
        .lobby-type-btn {
            transition: background 0.8s ease-in-out, background-color 0.8s ease-in-out,
                        color 0.8s ease-in-out, border-color 0.8s ease-in-out,
                        box-shadow 0.8s ease-in-out, transform 0.3s ease; /* Keep transform faster */
        }

        /* ================================================= */
        /* === START: NEW ANIMATED LOADING SCREEN STYLES === */
        /* ================================================= */

        #loading-screen {
            background-color: #050510; /* A very dark blue, almost black */
            overflow: hidden; /* Important for animations */
        }

        .loading-screen-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #binary-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: 'Share Tech Mono', monospace;
            color: rgba(0, 255, 13, 0.2); /* Faint green */
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            z-index: 1;
            user-select: none;
        }

        .magnifying-glass {
            position: absolute;
            z-index: 3;
            animation: magnify-roam 15s infinite alternate ease-in-out;
        }

        .glass-lens {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 15px solid #888;
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5), inset 0 0 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        .glass-lens .icon-human,
        .glass-lens .icon-ai {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            color: #00FF85; /* Bright green scan color */
            animation-duration: 6s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            opacity: 0;
        }

        .glass-lens .icon-human {
            animation-name: fade-icons-A;
        }

        .glass-lens .icon-ai {
            animation-name: fade-icons-B;
        }
        
        .glass-handle {
            width: 30px;
            height: 100px;
            background: linear-gradient(#666, #333);
            position: absolute;
            bottom: -60px;
            right: -60px;
            transform: rotate(-45deg);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
        }

        .loading-text-container {
            z-index: 2;
            text-align: center;
        }

        #loading-main-text {
            font-family: 'Share Tech Mono', monospace;
            font-size: 2.5rem;
            color: #DAA520; /* Gold to match classic theme */
            text-shadow: 0 0 10px #FFD700;
            border-right: .15em solid #FFD700; /* Blinking cursor */
            white-space: nowrap;
            overflow: hidden;
            animation:
                typing 3s steps(30, end) infinite alternate,
                blink-caret .75s step-end infinite;
            margin: 0 auto;
            letter-spacing: .15em;
        }

        #loading-sub-text {
            font-family: 'Merriweather', serif;
            color: #E0E0E0;
            font-size: 1.2rem;
            margin-top: 1rem;
            opacity: 0;
            animation: fade-in-slow 4s forwards;
            animation-delay: 1s;
        }
        
        /* Typing animation */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        /* Cursor blink animation */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #FFD700; }
        }

        /* Magnifying glass movement */
        @keyframes magnify-roam {
            0% { top: 20%; left: 15%; transform: rotate(0deg); }
            25% { top: 50%; left: 70%; transform: rotate(20deg); }
            50% { top: 60%; left: 25%; transform: rotate(-10deg); }
            75% { top: 30%; left: 80%; transform: rotate(5deg); }
            100% { top: 20%; left: 15%; transform: rotate(0deg); }
        }

        /* Icon cross-fade animations */
        @keyframes fade-icons-A {
            0%, 45% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
        @keyframes fade-icons-B {
            0%, 50% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            55%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* Subtext fade-in */
        @keyframes fade-in-slow {
            to { opacity: 0.8; }
        }

        /* Hide the old spinner and text as they are no longer used */
        body .spinner, 
        body .loading-text {
            display: none;
        }

        /* =============================================== */
        /* === END: NEW ANIMATED LOADING SCREEN STYLES === */
        /* =============================================== */


        /* === THEME: CLASSIC (Existing styles moved under this class) === */
        body.theme-classic {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        body.theme-classic h1,
        body.theme-classic h2 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        body.theme-classic p, 
        body.theme-classic span {
            color: #E0E0E0; /* Default text color */
        }
        
        body.theme-classic .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod border */
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
        }
        body.theme-classic .classic-card::before,
        body.theme-classic .classic-card::after {
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        body.theme-classic .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
            color: #FFFFFF;
        }
        body.theme-classic .classic-btn:hover {
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2);
        }

        body.theme-classic .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        body.theme-classic .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        body.theme-classic .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        body.theme-classic .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        body.theme-classic .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        body.theme-classic .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        body.theme-classic .btn-gold-classic { background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); border: none; }
        body.theme-classic .btn-gold-classic:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3); }


        body.theme-classic input,
        body.theme-classic select {
            background-color: #202020;
            border: 2px solid #5A5A5A;
            color: #E0E0E0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        body.theme-classic input::placeholder { color: #A0A0A0; }
        body.theme-classic input:focus,
        body.theme-classic select:focus {
            border-color: #DAA520 !important;
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }

        body.theme-classic .app-header,
        body.theme-classic .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-bottom: 3px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
        }
        body.theme-classic #header-user-coins-container {
            background-color: rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: #FFD700; /* Coin text color */
        }
        body.theme-classic .lobby-header .search-container {
            background-color: #303030;
            border: 2px solid #5A5A5A;
        }
        body.theme-classic .lobby-header .search-container svg { color: #DAA520; }


        body.theme-classic .app-footer,
        body.theme-classic .lobby-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-top: 3px solid #FFD700;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
        }
        body.theme-classic .lobby-footer .icon-btn { color: #FFD700; }
        body.theme-classic .lobby-footer .games-running-text { color: #E0E0E0; }

        body.theme-classic .main-content-area {
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }
        body.theme-classic .main-content-area h1 { color: #FFD700; }
        body.theme-classic .main-content-area p { color: #C0C0C0; }

        body.theme-classic .lobby-item {
            background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%);
            border: 2px solid #DAA520;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1);
        }
        body.theme-classic .lobby-item:hover {
            box-shadow: 0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2);
        }
        body.theme-classic .lobby-item h3 { color: #FFD700; }
        body.theme-classic .lobby-item p { color: #C0C0C0; }

        body.theme-classic .lobby-detail-screen-full {
             /* This is now handled by the new layout rules below */
        }
        body.theme-classic .lobby-detail-content {
             /* This is now handled by the new layout rules below */
        }

        body.theme-classic .profile-modal-content h2,
        body.theme-classic .custom-confirm-modal h2,
        body.theme-classic .create-lobby-modal h2,
        body.theme-classic .kick-player-confirm-modal h2,
        body.theme-classic .kicked-players-list-modal h2,
        body.theme-classic .enter-password-modal h2 {
            color: #FFD700;
        }

        body.theme-classic .profile-modal-content p,
        body.theme-classic .create-lobby-modal label,
        body.theme-classic .create-lobby-modal h3,
        body.theme-classic .pending-lobby-names-list p,
        body.theme-classic .approved-lobby-names-management-list p,
        body.theme-classic .custom-confirm-modal p,
        body.theme-classic .kick-player-confirm-modal p,
        body.theme-classic .kicked-message-modal p,
        body.theme-classic .kicked-players-list-modal p,
        body.theme-classic .enter-password-modal p {
            color: #E0E0E0;
        }
        body.theme-classic .lobby-proposal-message.text-red-400 {
            color: #FF6347; /* Ensure good visibility for error messages too */
        }
        body.theme-classic .profile-modal-content #profile-uid,
        body.theme-classic .pending-lobby-names-list .text-sm,
        body.theme-classic .approved-lobby-names-management-list .text-sm {
            color: #A0A0A0; /* Darker gray for UID and secondary info */
        }
        body.theme-classic .kicked-message-modal h2 {
            color: #CD5C5C; /* Red for kicked message */
        }

        body.theme-classic .lobby-sidebar {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid #444;
        }
        body.theme-classic .player-list-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
        }
        body.theme-classic .player-list-item.is-host { border-color: #FFD700; }
        body.theme-classic .player-list-item .player-name { color: #E0E0E0; }
        body.theme-classic .player-list-item .host-label { color: #FFD700; }
        body.theme-classic .kick-player-btn { border: 1px solid #B22222; color: #B22222; }
        body.theme-classic .kick-player-btn:hover { background: #B22222; color: white; }

        body.theme-classic .lobby-chat-container {
            background-color: rgba(0,0,0,0.4);
            border: 2px solid #5A5A5A;
        }
        body.theme-classic .chat-message { background-color: #333; }
        body.theme-classic .chat-message.current-user { background-color: #4682B4; }
        body.theme-classic .chat-message .sender-name { color: #FFD700; }
        body.theme-classic .chat-message .message-text-deleted { color: #999; }
        body.theme-classic .delete-message-btn { color: #aaa; }
        body.theme-classic .delete-message-btn:hover { color: #ff6b6b; }

        body.theme-classic .start-game-btn { background: linear-gradient(145deg, #228B22 0%, #006400 100%); border: 2px solid #DAA520; }

        body.theme-classic .lobby-sidebar::-webkit-scrollbar-track,
        body.theme-classic #player-list-container::-webkit-scrollbar-track,
        body.theme-classic .lobby-chat-messages::-webkit-scrollbar-track,
        body.theme-classic .custom-scrollbar::-webkit-scrollbar-track { background: #202020; }
        body.theme-classic .lobby-sidebar::-webkit-scrollbar-thumb,
        body.theme-classic #player-list-container::-webkit-scrollbar-thumb,
        body.theme-classic .lobby-chat-messages::-webkit-scrollbar-thumb,
        body.theme-classic .custom-scrollbar::-webkit-scrollbar-thumb { background: #DAA520; }
        body.theme-classic .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        body.theme-classic #player-list-container::-webkit-scrollbar-thumb:hover,
        body.theme-classic .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        body.theme-classic .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #FFD700; }

        body.theme-classic .lobby-type-btn { border: 2px solid #DAA520; background-color: transparent; color: #DAA520; }
        body.theme-classic .lobby-type-btn.active { background-color: #DAA520; color: #1A1A1A; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        body.theme-classic .lobby-lock-icon { color: #FFD700; }

        body.theme-classic .game-player-pod {
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        body.theme-classic .game-player-pod.is-ai { background-color: rgba(255, 99, 71, 0.1); border-color: #FF6347; }
        body.theme-classic .game-player-pod.is-human { background-color: rgba(100, 149, 237, 0.1); border-color: #6495ED; }
        body.theme-classic .game-player-pod.current-active-player { border-color: #FFD700; box-shadow: 0 0 15px rgba(255,215,0,0.7); }
        body.theme-classic .game-player-pod .player-name { color: #E0E0E0; }
        body.theme-classic .game-player-pod .player-role { color: #DAA520; }
        body.theme-classic .game-player-pod .player-status { color: #C0C0C0; }

        body.theme-classic .voting-btn { border: 3px solid #FFD700; }
        body.theme-classic .voting-btn.ai-vote { background: linear-gradient(145deg, #E24B4B 0%, #B22222 100%); color: white; }
        body.theme-classic .voting-btn.human-vote { background: linear-gradient(145deg, #4BBEE2 0%, #2A52BE 100%); color: white; }

        body.theme-classic .coin-icon { fill: #FFD700; }

        /* === NEW THEME: CYBERPUNK === */
        body.theme-cyberpunk {
            background: linear-gradient(to bottom right, #0F0F1A, #1A0F1A);
            color: #00FFFF; /* Cyan */
            font-family: 'Share Tech Mono', monospace; /* More techy font */
        }
        body.theme-cyberpunk h1,
        body.theme-cyberpunk h2 {
            font-family: 'Orbitron', sans-serif; /* Futuristic heading */
            color: #FF00FF; /* Magenta */
            text-shadow: 0 0 5px #00FFFF, 0 0 10px #FF00FF;
        }
        body.theme-cyberpunk p,
        body.theme-cyberpunk span {
            color: #00FFFF; /* Default text color */
        }
        
        /* Cyberpunk loading screen adjustments */
        body.theme-cyberpunk #loading-screen { background-color: #0F0F1A; }
        body.theme-cyberpunk #binary-background { color: rgba(255, 0, 255, 0.2); }
        body.theme-cyberpunk #loading-main-text { color: #00FFFF; text-shadow: 0 0 10px #00FFFF; border-color: #00FFFF; }
        body.theme-cyberpunk #loading-sub-text { color: #FF00FF; }
        body.theme-cyberpunk .glass-lens { border-color: #FF00FF; box-shadow: 0 0 30px rgba(0, 255, 255, 0.5), inset 0 0 15px rgba(0, 0, 0, 0.5); }
        body.theme-cyberpunk .glass-handle { background: linear-gradient(#3A003A, #1A001A); }
        body.theme-cyberpunk .glass-lens .icon-human, body.theme-cyberpunk .glass-lens .icon-ai { color: #FF00FF; }


        body.theme-cyberpunk .classic-card {
            background: linear-gradient(145deg, #2A002A 0%, #4B004B 100%);
            border: 3px solid #FF00FF;
            box-shadow: 0 0 20px rgba(255,0,255,0.7), inset 0 0 10px rgba(0,255,255,0.5);
        }
        body.theme-cyberpunk .classic-card::before,
        body.theme-cyberpunk .classic-card::after {
            border-color: #00FFFF;
            box-shadow: 0 0 10px rgba(0,255,255,0.7);
        }
        body.theme-cyberpunk .classic-btn {
            border: 2px solid #00FFFF;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 0 5px #FF00FF;
            color: #FFF;
        }
        body.theme-cyberpunk .classic-btn:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.7), inset 0 0 8px #FF00FF;
        }
        body.theme-cyberpunk .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); } /* Keep same or adjust */
        body.theme-cyberpunk .btn-blue-classic { background: linear-gradient(145deg, #00BFFF 0%, #008080 100%); } /* Deep Sky Blue to Teal */
        body.theme-cyberpunk .btn-green-classic { background: linear-gradient(145deg, #39FF14 0%, #228B22 100%); } /* Neon Green */
        body.theme-cyberpunk .btn-red-classic { background: linear-gradient(145deg, #FF0077 0%, #CC0055 100%); } /* Hot Pink */
        body.theme-cyberpunk .btn-gray-classic { background: linear-gradient(145deg, #3A3A3A 0%, #202020 100%); }
        body.theme-cyberpunk .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        body.theme-cyberpunk .btn-gold-classic { background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); } /* Can still be gold */

        body.theme-cyberpunk input,
        body.theme-cyberpunk select {
            background-color: #05050A;
            border: 2px solid #00FFFF;
            color: #00FFFF;
            box-shadow: inset 0 0 5px #FF00FF;
        }
        body.theme-cyberpunk input::placeholder { color: #808080; }
        body.theme-cyberpunk input:focus,
        body.theme-cyberpunk select:focus {
            border-color: #FF00FF !important;
            box-shadow: 0 0 0 4px rgba(0,255,255,0.5) !important, inset 0 0 5px #FF00FF !important;
        }

        body.theme-cyberpunk .app-header,
        body.theme-cyberpunk .lobby-header {
            background: linear-gradient(to right, #001A1A, #003333);
            border-bottom: 3px solid #00FFFF;
            box-shadow: 0 5px 15px rgba(0,255,255,0.5);
        }
        body.theme-cyberpunk #header-user-coins-container {
            background-color: rgba(0,255,255,0.1);
            box-shadow: 0 2px 5px rgba(0,255,255,0.3);
            color: #FF00FF; /* Coin text color */
        }
        body.theme-cyberpunk .lobby-header .search-container {
            background-color: #10101A;
            border: 2px solid #00FFFF;
        }
        body.theme-cyberpunk .lobby-header .search-container svg { color: #FF00FF; }

        body.theme-cyberpunk .app-footer,
        body.theme-cyberpunk .lobby-footer {
            background: linear-gradient(to left, #001A1A, #003333);
            border-top: 3px solid #00FFFF;
            box-shadow: 0 -5px 15px rgba(0,255,255,0.5);
        }
        body.theme-cyberpunk .lobby-footer .icon-btn { color: #00FFFF; }
        body.theme-cyberpunk .lobby-footer .games-running-text { color: #FF00FF; }

        body.theme-cyberpunk .main-content-area {
            background: linear-gradient(180deg, #100510 0%, #050005 100%);
        }
        body.theme-cyberpunk .main-content-area h1 { color: #FF00FF; }
        body.theme-cyberpunk .main-content-area p { color: #00FFFF; }

        body.theme-cyberpunk .lobby-item {
            background: linear-gradient(145deg, #1A001A 0%, #2A002A 100%);
            border: 2px solid #FF00FF;
            box-shadow: 0 5px 10px rgba(0,255,255,0.3), inset 0 0 8px rgba(255,0,255,0.3);
        }
        body.theme-cyberpunk .lobby-item:hover {
            box-shadow: 0 8px 15px rgba(0,255,255,0.5), inset 0 0 10px rgba(255,0,255,0.5);
        }
        body.theme-cyberpunk .lobby-item h3 { color: #00FFFF; }
        body.theme-cyberpunk .lobby-item p { color: #C0C0C0; }

        body.theme-cyberpunk .profile-modal-content h2,
        body.theme-cyberpunk .custom-confirm-modal h2,
        body.theme-cyberpunk .create-lobby-modal h2,
        body.theme-cyberpunk .kick-player-confirm-modal h2,
        body.theme-cyberpunk .kicked-players-list-modal h2,
        body.theme-cyberpunk .enter-password-modal h2 {
            color: #FF00FF;
        }
        body.theme-cyberpunk .profile-modal-content p,
        body.theme-cyberpunk .create-lobby-modal label,
        body.theme-cyberpunk .create-lobby-modal h3,
        body.theme-cyberpunk .pending-lobby-names-list p,
        body.theme-cyberpunk .approved-lobby-names-management-list p,
        body.theme-cyberpunk .custom-confirm-modal p,
        body.theme-cyberpunk .kick-player-confirm-modal p,
        body.theme-cyberpunk .kicked-message-modal p,
        body.theme-cyberpunk .kicked-players-list-modal p,
        body.theme-cyberpunk .enter-password-modal p {
            color: #00FFFF;
        }
        body.theme-cyberpunk .lobby-proposal-message.text-red-400 {
            color: #FF0077;
        }
        body.theme-cyberpunk .profile-modal-content #profile-uid,
        body.theme-cyberpunk .pending-lobby-names-list .text-sm,
        body.theme-cyberpunk .approved-lobby-names-management-list .text-sm {
            color: #808080; /* Gray for UID and secondary info */
        }
        body.theme-cyberpunk .kicked-message-modal h2 {
            color: #FF0077; /* Hot Pink for kicked message */
        }

        body.theme-cyberpunk .lobby-chat-container {
            background-color: rgba(0,0,0,0.6);
            border: 2px solid #FF00FF;
        }
        body.theme-cyberpunk .chat-message { background-color: #1A001A; }
        body.theme-cyberpunk .chat-message.current-user { background-color: #004444; }
        body.theme-cyberpunk .chat-message .sender-name { color: #00FFFF; }
        body.theme-cyberpunk .chat-message .message-text-deleted { color: #777; }
        body.theme-cyberpunk .delete-message-btn { color: #777; }
        body.theme-cyberpunk .delete-message-btn:hover { color: #FF0077; }

        body.theme-cyberpunk .start-game-btn { background: linear-gradient(145deg, #39FF14 0%, #228B22 100%); border: 2px solid #FF00FF; }

        body.theme-cyberpunk .lobby-sidebar::-webkit-scrollbar-track,
        body.theme-cyberpunk #player-list-container::-webkit-scrollbar-track,
        body.theme-cyberpunk .lobby-chat-messages::-webkit-scrollbar-track,
        body.theme-cyberpunk .custom-scrollbar::-webkit-scrollbar-track { background: #0A0A0A; }
        body.theme-cyberpunk .lobby-sidebar::-webkit-scrollbar-thumb,
        body.theme-cyberpunk #player-list-container::-webkit-scrollbar-thumb,
        body.theme-cyberpunk .lobby-chat-messages::-webkit-scrollbar-thumb,
        body.theme-cyberpunk .custom-scrollbar::-webkit-scrollbar-thumb { background: #00FFFF; }
        body.theme-cyberpunk .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        body.theme-cyberpunk #player-list-container::-webkit-scrollbar-thumb:hover,
        body.theme-cyberpunk .lobby-chat-messages::-webkit-scrollbar-thumb:hover,
        body.theme-cyberpunk .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #FF00FF; }

        body.theme-cyberpunk .lobby-type-btn { border: 2px solid #FF00FF; background-color: transparent; color: #FF00FF; }
        body.theme-cyberpunk .lobby-type-btn.active { background-color: #FF00FF; color: #1A001A; box-shadow: 0 0 10px rgba(0,255,255,0.5); }
        body.theme-cyberpunk .lobby-lock-icon { color: #FF00FF; }

        body.theme-cyberpunk .game-player-pod {
            background-color: rgba(0,255,255,0.1);
            border: 1px solid rgba(0,255,255,0.3);
        }
        body.theme-cyberpunk .game-player-pod.is-ai { background-color: rgba(255, 0, 119, 0.1); border-color: #FF0077; }
        body.theme-cyberpunk .game-player-pod.is-human { background-color: rgba(0, 191, 255, 0.1); border-color: #00BFFF; }
        body.theme-cyberpunk .game-player-pod.current-active-player { border-color: #FF00FF; box-shadow: 0 0 15px rgba(255,0,255,0.7); }
        body.theme-cyberpunk .game-player-pod .player-name { color: #00FFFF; }
        body.theme-cyberpunk .game-player-pod .player-role { color: #FF00FF; }
        body.theme-cyberpunk .game-player-pod .player-status { color: #AAA; }

        body.theme-cyberpunk .voting-btn { border: 3px solid #00FFFF; }
        body.theme-cyberpunk .voting-btn.ai-vote { background: linear-gradient(145deg, #FF0077 0%, #CC0055 100%); color: white; }
        body.theme-cyberpunk .voting-btn.human-vote { background: linear-gradient(145deg, #00BFFF 0%, #008080 100%); color: white; }

        body.theme-cyberpunk .coin-icon { fill: #00FFFF; } /* Cyan coin */

        /* Other themes (Forest, Ocean, Minimal) are omitted for brevity but would be here */
        /* ... */

        /* Styles for active theme button */
        .theme-button.active-theme-btn {
            background-color: #DAA520; /* Default gold for classic */
            color: #1A1A1A; /* Dark text for classic */
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
            border-color: #FFD700;
        }
        body.theme-cyberpunk .theme-button.active-theme-btn {
            background-color: #FF00FF; /* Magenta for cyberpunk */
            color: #1A001A;
            box-shadow: 0 0 10px rgba(0,255,255,0.5);
            border-color: #00FFFF;
        }
        
        /* ... other theme active button styles ... */


        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            border-radius: 20px; /* Slightly larger radius */
            backdrop-filter: blur(10px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh; /* Ensure card doesn't overflow viewport */
            overflow-y: hidden; /* Removed vertical scrollbars */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid;
            border-left: 5px solid;
            border-radius: 5px 0 0 0;
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid;
            border-right: 5px solid;
            border-radius: 0 0 5px 0;
        }


        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother transition */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and scale */
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Input Field Styles - More refined Classic Look */
        input, select { /* Added select for lobby names dropdown */
            padding: 0.875rem; /* Equivalent to p-3.5 */
            border-radius: 0.75rem; /* Equivalent to rounded-xl */
        }
        /* Header specific styles - Richer Gold/Brown */
        .app-header {
            height: 70px; /* Fixed height for header */
            position: fixed; /* Explicitly fixed */
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-between; /* Spreads items */
            align-items: center;
        }

        /* NEW: Coin display container in header (positioned on the left for RTL) */
        #header-user-coins-container {
            /* flex-grow added directly in HTML to push it rightwards */
            border-radius: 10px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            margin-left: 1rem; /* Space between coins and menu button */
        }
        #header-user-coins-container:hover {
            transform: translateY(-2px);
        }

        /* Lobby Screen Specific Header */
        .lobby-header {
            height: 70px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center; /* Align items vertically */
            justify-content: center; /* Center horizontally by default */
        }
        .lobby-header .search-container {
            display: flex;
            flex-grow: 1; /* Allow search container to take available space */
            max-width: 600px; /* Limit max width on larger screens */
            margin: 0 auto; /* Center the search container */
            align-items: center;
            border-radius: 15px; /* Rounded corners for search bar */
            padding: 0.5rem 1rem; /* Adjust padding */
        }
        .lobby-header .search-container input {
            flex-grow: 1;
            background-color: transparent; /* Transparent background */
            border: none; /* No border for input inside search bar */
            padding: 0.25rem 0.5rem;
            outline: none; /* No outline on focus */
            text-align: right; /* Align text to right for RTL */
        }
        .lobby-header .search-container input::placeholder {
        }
        .lobby-header .search-container svg {
            min-width: 24px; /* Ensure icons don't shrink */
            min-height: 24px;
        }
        .lobby-header .search-container button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.5rem;
        }
        .lobby-header .back-btn-wrapper {
            margin-left: 10px; /* Space between back button and search bar (for RTL) */
        }
        .lobby-header .search-icon-wrapper {
            margin-right: 10px; /* Space between search icon and search input (RTL) */
        }


        .app-footer {
            height: 90px; /* Fixed height for footer */
            position: fixed; /* Explicitly fixed */
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1rem; /* Added gap here for spacing buttons */
        }
        /* Lobby Screen Specific Footer */
        .lobby-footer {
            height: 90px;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .lobby-footer .icon-btn:hover {
            transform: translateY(-5px);
        }
        .lobby-footer .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .lobby-footer .icon-btn svg {
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
            transition: transform 0.8s ease-in-out;
        }
        .lobby-footer .games-running-text {
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main content area padding to avoid overlap with fixed header/footer */
        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 90px; /* Footer height */
            flex-grow: 1; /* Allow content to fill available space */
            overflow-y: auto; /* Re-enabled for scrollable lists */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for main content */
            width: 100%; /* Ensure it takes full width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start for scrollable lists */
            align-items: center; /* Center content horizontally */
            position: relative; /* For any absolute positioned elements inside */
        }
        
        /* Profile Modal specific styles (now main-menu-modal) */
        .profile-modal-overlay {
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            transition: opacity 0.3s ease-in-out;
        }
        .profile-modal-content {
            transform: translateY(-20px); /* Initial slightly elevated */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .profile-modal-enter-active .profile-modal-content {
            transform: translateY(0);
        }
        .profile-modal-leave-active .profile-modal-content {
            transform: translateY(-20px);
            opacity: 0;
        }

        /* Create Lobby Modal Styles */
        #create-lobby-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Confirmation Modal Styles */
        #confirmation-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Animation for lobby items when closing */
        .lobby-item.fade-out {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Enhanced Lobby Item Styling */
        .lobby-item {
            border-radius: 15px; /* Rounded corners */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smooth transitions for hover effects */
            position: relative; /* For overflow hidden and pseudo-elements */
            overflow: hidden; /* Ensures internal elements stay within rounded corners */
            padding: 1.25rem 1.5rem; /* More generous padding */
            display: flex;
            flex-direction: column; /* Default to column for small screens */
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }

        .lobby-item::before { /* Subtle light overlay on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
            transform: skewX(-30deg);
            transition: all 0.3s ease-in-out;
        }

        .lobby-item:hover::before {
            left: 100%;
        }

        .lobby-item:hover {
            transform: translateY(-8px) scale(1.02); /* More pronounced lift and slight scale */
        }

        .lobby-item h3 {
            font-size: 1.75rem; /* Larger font for name */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }

        .lobby-item p {
            font-size: 1rem;
            margin-top: 0.25rem;
        }
        
        .lobby-item .lobby-actions { /* Container for buttons in lobby item */
            margin-top: 1rem; /* Space between text and buttons */
            display: flex;
            flex-direction: column; /* Stack buttons on mobile */
            width: 100%; /* Take full width on mobile */
            gap: 0.75rem; /* Space between stacked buttons */
        }

        /* Ensure buttons within lobby-item are full width on mobile */
        .lobby-item .join-lobby-btn,
        .lobby-item .close-lobby-btn {
            width: 100%; /* Take full width on small screens */
            padding: 0.75rem 1rem; /* Consistent padding */
            font-size: 1rem; /* Consistent font size */
        }

        /* 
        ===========================================================
        === START: NEW LAYOUT FOR LOBBY DETAIL SCREEN (GAME VIEW) ===
        ===========================================================
        */
        
        /* Main container for the game view. It has the background image. */
        .lobby-detail-screen-full {
            padding: 0;
            display: flex; /* Kept flex for centering children if needed */
            width: 100%;
            height: 100%;
            position: relative; /* Crucial for positioning child elements absolutely */
            background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAQAAwADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1VXV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACii-igAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigA-all an existing screen */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            overflow: hidden; /* Hide any overflow */
            padding: 0;
        }

        /* This container will hold all the absolutely positioned elements */
        #game-table-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Top header for lobby info */
        #game-lobby-info-header {
            position: absolute;
            top: 20px;
            right: 20px;
            left: 20px;
            text-align: center;
            color: white;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 10;
        }
        #game-lobby-info-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #FFD700; /* Gold */
            text-shadow: 2px 2px 4px #000;
        }
        #game-lobby-info-header p {
            margin: 4px 0 0;
            font-size: 1rem;
            color: #E0E0E0; /* Light gray */
            text-shadow: 1px 1px 2px #000;
        }

        /* Exit button */
        #game-lobby-exit-btn {
            position: absolute;
            top: 25px;
            left: 25px;
            padding: 8px 25px;
            background-color: #2A52BE; /* Blue */
            color: white;
            border: 2px solid #DAA520;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            z-index: 11;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #game-lobby-exit-btn:hover {
            background-color: #4682B4;
        }
        
        /* Central area where player pods will be placed */
        #game-table-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }

        /* Player pod styles for the new layout */
        .game-player-pod-on-rug {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.6);
            border: 3px solid #DAA520; /* Gold border */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
            transform: translate(-50%, -50%); /* Center the pod on its coordinates */
            color: white;
            text-align: center;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            overflow: hidden; /* To keep avatar inside */
        }
        .game-player-pod-on-rug .player-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .game-player-pod-on-rug .player-name-on-rug {
            position: absolute;
            bottom: -22px;
            width: 120%;
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px #000;
            background-color: rgba(0,0,0,0.5);
            padding: 2px 0;
            border-radius: 5px;
        }
        .game-player-pod-on-rug .player-number-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 28px;
            height: 28px;
            background-color: #660000; /* Dark red */
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1rem;
            border: 2px solid white;
            z-index: 1;
        }

        /* Bottom controls footer */
        #game-lobby-controls-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 10;
        }

        .control-cluster {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #mic-and-ready-container {
            position: absolute;
            left: 50%;
            bottom: 15px;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #mic-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4A4A4A;
            border: 3px solid #777;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #mic-btn svg {
            width: 32px;
            height: 32px;
            color: #0f0;
        }

        #ready-toggle-btn {
            padding: 8px 30px;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #ready-toggle-btn.not-ready {
            background-color: #B22222; /* Red */
        }
        #ready-toggle-btn.is-ready {
            background-color: #228B22; /* Green */
        }

        .emote-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid #DAA520;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            backdrop-filter: blur(3px);
        }
        .emote-btn svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        /* END OF NEW LAYOUT STYLES */


        /* Custom Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { border-radius: 4px; }
        
        /* ===== CORRECTED RESPONSIVE STYLES ===== */
        @media (min-width: 640px) { /* sm breakpoint */
            .lobby-item {
                flex-direction: row; /* Align items in a row */
                text-align: right; /* Text aligned right in RTL */
            }
            .lobby-item .lobby-actions {
                flex-direction: row; /* Buttons side-by-side */
                width: auto; /* Buttons take their natural width */
                margin-top: 0; /* No top margin when side-by-side */
                gap: 0.5rem; /* Small gap between buttons */
            }
            /* Add margin-left to close button for spacing from join button */
            .lobby-item .close-lobby-btn {
                margin-right: 0.5rem; /* Space from join button in RTL */
            }
            .lobby-item .join-lobby-btn,
            .lobby-item .close-lobby-btn {
                width: auto; /* Allow buttons to size naturally */
                font-size: 0.9rem; /* Slightly smaller for compactness */
                padding: 0.6rem 1.2rem; /* Adjusted padding */
            }
        }

        @media (max-width: 860px) {
            /* This section for the old layout is no longer relevant for the new game view */
        }
        /* General Responsive */
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header { padding: 0.5rem; }
            .app-header, .lobby-header { height: 60px; }
            .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; }

            /* Responsive for NEW Game View */
            .game-player-pod-on-rug { width: 75px; height: 75px; border-width: 2px; }
            .game-player-pod-on-rug .player-name-on-rug { font-size: 0.8rem; bottom: -20px;}
            .game-player-pod-on-rug .player-number-badge { width: 24px; height: 24px; font-size: 0.8rem; }
            #game-lobby-info-header h2 { font-size: 1.2rem; }
            #game-lobby-info-header p { font-size: 0.8rem; }
            #game-lobby-exit-btn { top: 15px; left: 15px; padding: 6px 18px; font-size: 0.9rem; }
            #mic-and-ready-container { bottom: 10px; }
            #mic-btn { width: 50px; height: 50px; }
            #mic-btn svg { width: 28px; height: 28px; }
            #ready-toggle-btn { font-size: 1rem; padding: 6px 25px;}
            .emote-btn { width: 40px; height: 40px; }
            .emote-btn svg { width: 20px; height: 20px; }
            .control-cluster { gap: 10px; }


            /* New Coin Display responsive */
            #header-user-coins-container {
                font-size: 1.2rem;
                padding: 0.4rem 0.8rem; /* Adjusted for smaller screens */
            }
            #header-user-coins-container .coin-icon {
                width: 1.2rem; /* Smaller icon */
                height: 1.2rem;
                margin-left: 0.2rem; /* Adjusted margin */
            }
            /* Responsive loading screen */
            #loading-main-text { font-size: 1.8rem; }
            #loading-sub-text { font-size: 1rem; }
            .glass-lens { width: 140px; height: 140px; border-width: 10px; }
            .glass-handle { width: 25px; height: 80px; bottom: -50px; right: -50px; }
            .glass-lens .icon-human, .glass-lens .icon-ai { width: 80px; height: 80px; }
        }
        
        /* Lobby Type Toggle Styles */
        .lobby-type-btn { padding: 0.5rem 1.5rem; border: 2px solid; border-radius: 10px; transition: all 0.2s ease-in-out; background-color: transparent; font-weight: bold; }
        .lobby-lock-icon { width: 1.2rem; height: 1.2rem; margin-left: 0.5rem; display: inline-block; vertical-align: middle; }

        /* NEW: Countdown Animation */
        @keyframes countdown-pulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .countdown-effect {
            animation: countdown-pulse 1s ease-out forwards;
        }

        /* NEW: Game Player Status Pods (Old layout, can be removed or kept for game phase) */
        .game-player-pod {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            min-width: 120px;
            transition: all 0.3s ease-in-out;
            position: relative;
        }
        .game-player-pod.current-active-player {
            transform: scale(1.05);
        }
        .game-player-pod .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }
        .game-player-pod .player-role {
            font-size: 0.9rem;
        }
        .game-player-pod .player-status {
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        /* Voting Buttons */
        .voting-btn {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            border-radius: 15px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .voting-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
        }
        .voting-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Coin Icon for Buttons */
        .coin-icon {
            width: 1.25rem; /* Equivalent to w-5 */
            height: 1.25rem; /* Equivalent to h-5 */
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.25rem; /* Equivalent to mr-1 */
        }
    </style>
</head>
<body class="theme-classic">

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- All Modals and other screens remain the same... -->
        <!-- 1. Loading Screen (NEW GRAPHICAL VERSION) -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center z-50 page-transition-active page-transition-visible">
            <div class="loading-screen-container">
                <div id="binary-background"></div>
                
                <div class="magnifying-glass">
                    <div class="glass-lens">
                        <!-- Human Icon -->
                        <svg class="icon-human" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                        </svg>
                        <!-- AI Icon -->
                        <svg class="icon-ai" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="16" height="16" x="4" y="4" rx="2" /><rect width="6" height="6" x="9" y="9" rx="1" /><path d="M9 2v2" /><path d="M15 2v2" /><path d="M9 20v2" /><path d="M15 20v2" /><path d="M20 9h2" /><path d="M20 14h2" /><path d="M2 9h2" /><path d="M2 14h2" />
                        </svg>
                    </div>
                    <div class="glass-handle"></div>
                </div>

                <div class="loading-text-container">
                    <h1 id="loading-main-text">جستجوی بازیکنان</h1>
                    <p id="loading-sub-text">در حال اتصال به سرور...</p>
                </div>
            </div>
        </div>


        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="email" placeholder="ایمیل شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <!-- Toggle buttons for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth-btn"
                            class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info and ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                    </svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg">نام کاربری</span>
                        <span id="header-user-id" class="text-xs break-all">ID: ---</span>
                    </div>
                </div>

                <!-- Spacer to push elements to ends -->
                <div class="flex-grow"></div> 

                <!-- NEW LOCATION FOR COINS - Near the menu button (left for RTL) -->
                <div id="header-user-coins-container" class="flex items-center text-xl sm:text-2xl font-extrabold">
                    <svg class="coin-icon w-6 h-6 sm:w-8 sm:h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span id="header-user-coins">---</span>
                </div>

                <!-- Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area flex flex-col justify-center items-center">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text-4xl font-bold mb-8">به بازی متنی خوش آمدید!</h1>
                <p class="text-lg">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer flex justify-center items-center gap-4">
                <button id="friendly-game-btn"
                        class="classic-btn btn-purple-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                        <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span>بازی دوستانه (<span id="friendly-game-cost">100</span>)</span>
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="classic-btn btn-brown-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                    بازی امتیازی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
                            <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                        </svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p>در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Main Menu Modal (Replaces Profile Modal) -->
        <div id="main-menu-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <button id="close-main-menu-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>

                <!-- Main Menu Navigation -->
                <div id="main-menu-nav" class="space-y-4">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">منوی اصلی</h2>
                    <button id="show-profile-btn" class="w-full classic-btn btn-blue-classic text-lg sm:text-xl">
                        پروفایل کاربری
                    </button>
                    <button id="show-themes-btn" class="w-full classic-btn btn-green-classic text-lg sm:text-xl">
                        انتخاب تم
                    </button>
                    <button id="main-menu-logout-btn" class="w-full classic-btn btn-red-classic text-lg sm:text-xl">
                        خروج از حساب
                    </button>
                </div>

                <!-- Profile View (initially hidden, shown when "Profile" is clicked) -->
                <div id="profile-view" class="hidden text-lg space-y-4 mb-8 text-right">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm">---</span></p>
                    <p><strong>سکه‌ها:</strong> <span id="profile-coins" class="font-bold">---</span></p>
                    <button id="back-to-main-menu-from-profile" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">
                        بازگشت
                    </button>
                </div>

                <!-- Themes View (initially hidden, shown when "Themes" is clicked) -->
                <div id="themes-view" class="hidden text-lg space-y-4 mb-8">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">انتخاب تم</h2>
                    <div id="theme-buttons-container" class="grid grid-cols-2 gap-4">
                        <!-- Theme buttons will be dynamically generated by JS -->
                    </div>
                    <button id="back-to-main-menu-from-themes" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">
                        بازگشت
                    </button>
                </div>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative overflow-y-auto custom-scrollbar">
                <h2 id="create-lobby-modal-title" class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">

                    <!-- NEW: Lobby Name Selection/Proposal Area -->
                    <div id="lobby-name-selection-area" class="hidden">
                        <label for="approved-lobby-names-select" class="block text-right text-sm mb-1">نام لابی تأیید شده خود را انتخاب کنید:</label>
                        <select id="approved-lobby-names-select" class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                            <!-- Options will be dynamically loaded here -->
                            <option value="">نام لابی را انتخاب کنید</option>
                        </select>
                    </div>

                    <div id="lobby-name-proposal-area" class="hidden">
                        <label for="proposed-lobby-name-input" class="block text-right text-sm mb-1">نام لابی جدید را برای تأیید ارسال کنید (می‌توانید از کد رنگی [#RRGGBB] در ابتدای نام استفاده کنید):</label>
                        <input type="text" id="proposed-lobby-name-input" placeholder="مثال: [#FFD700]لابی طلایی من"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" id="submit-lobby-name-for-approval-btn"
                                class="w-full mt-4 classic-btn btn-blue-classic text-lg sm:text-xl">
                            ارسال برای تأیید
                        </button>
                        <p class="text-sm mt-2" id="lobby-proposal-message">بعد از ارسال، ادمین نام لابی شما را بررسی و تأیید می‌کند. سپس می‌توانید از آن نام استفاده کنید.</p>
                    </div>
                    
                    <!-- NEW: Pending Lobby Names Area -->
                    <div id="pending-lobby-names-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold mb-2">نام‌های لابی در انتظار تأیید شما:</h3>
                        <div id="pending-lobby-names-list" class="space-y-2 text-right max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Pending names will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی در انتظار تایید ندارید.</p>
                        </div>
                    </div>

                    <!-- NEW: Approved Lobby Names Management Area -->
                    <div id="approved-lobby-names-management-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold mb-2">نام‌های لابی تأیید شده شما:</h3>
                        <div id="approved-lobby-names-management-list" class="space-y-2 text-right max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Approved names with delete buttons will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>
                        </div>
                    </div>

                    <div class="w-full h-px bg-yellow-600 my-4"></div> <!-- Divider -->

                    <!-- NEW: Lobby Type Toggle (Public/Private) -->
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="public" class="sr-only" checked>
                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
                    </div>
        
                    <!-- NEW: Password field for private lobbies (initially hidden) -->
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 4 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
                    
                    <!-- NEW: Game Duration Input -->
                    <div>
                        <label for="game-duration-input" class="block text-right text-sm mb-1">مدت زمان بازی (دقیقه):</label>
                        <input type="number" id="game-duration-input" value="5" min="1" max="60"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 text-center"
                               required>
                    </div>

                    <button type="submit" id="submit-create-lobby-btn"
                            class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED for Text-Based Game) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full">
            
            <!-- This container holds all the new absolutely positioned elements -->
            <div id="game-table-container">

                <!-- Top Header for Lobby Info -->
                <div id="game-lobby-info-header">
                    <h2 id="detail-lobby-name">نام لابی</h2>
                    <p id="detail-host-name" class="mt-1">سازنده: ---</p>
                    <p id="detail-scenario-name" class="mt-1">سناریو: Rifleman</p> <!-- Static as per image -->
                    <p id="detail-player-count" class="mt-1">بازیکنان: 0/10</p>
                </div>

                <!-- Exit Button -->
                <button id="game-lobby-exit-btn">خروج</button>

                <!-- Central Area for Player Pods -->
                <div id="game-table-area">
                    <!-- Player pods will be dynamically injected here by JavaScript -->
                </div>

                <!-- Footer for Game Controls -->
                <div id="game-lobby-controls-footer">
                    <!-- Left Cluster of Emotes -->
                    <div class="control-cluster">
                        <button class="emote-btn" title="خوشحال">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                        </button>
                        <button class="emote-btn" title="پیام">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </button>
                    </div>

                    <!-- Center Cluster for Mic and Ready Button -->
                    <div id="mic-and-ready-container">
                         <button id="mic-btn" title="میکروفون">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></svg>
                         </button>
                         <button id="ready-toggle-btn" class="not-ready">آماده نیستم</button>
                    </div>

                    <!-- Right Cluster of Emotes -->
                    <div class="control-cluster">
                        <button class="emote-btn" title="بزن قدش">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 18h-2.4c-1 0-1.8-.8-1.8-1.8V12c0-.8.7-1.4 1.4-1.4h2.6c.8 0 1.4.6 1.4 1.4v.4c0 1-.8 1.8-1.8 1.8h-1.2"/><path d="M12 10.4V5.8c0-1 .8-1.8 1.8-1.8h1.4c1 0 1.8.8 1.8 1.8v1.8"/><path d="M6 18H5c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2h1"/><path d="M7 5v13"/><path d="M12 5.5c0-1.4-1.1-2.5-2.5-2.5S7 4.1 7 5.5V11"/></svg>
                        </button>
                        <button class="emote-btn" title="لایک">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 1.79 1.11L15 5.88z"/></svg>
                        </button>
                        <button class="emote-btn" title="دیسلایک">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a2 2 0 0 1-1.79-1.11L9 18.12z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- These overlays are now relative to the main container, not a sub-panel -->
                <!-- Countdown Overlay -->
                <div id="game-countdown-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                    <div class="text-7xl font-extrabold countdown-effect" style="opacity:0; transform: scale(0.5);"></div>
                    <p class="text-2xl mt-4">بازی در حال شروع است...</p>
                </div>
                <!-- Voting/Game End Overlay -->
                <div id="game-voting-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                    <h2 class="text-4xl font-bold mb-6" id="voting-title">رای‌گیری آغاز شد!</h2>
                    <p class="text-xl mb-8" id="voting-instructions">برای چه کسی رای می‌دهید؟</p>
                    <div id="voting-options" class="flex flex-wrap justify-center gap-4">
                        <!-- Voting buttons will be injected here -->
                    </div>
                    <div id="game-result-display" class="hidden text-center mt-10">
                        <h2 class="text-5xl font-extrabold mb-4" id="winnerText"></h2>
                        <p class="text-2xl" id="reasonText"></p>
                        <button id="return-to-lobbies-btn" class="classic-btn btn-blue-classic mt-8 py-3 px-6">بازگشت به لابی‌ها</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ... All other modals (kick, kicked message, etc.) remain the same ... -->
        <!-- 10. Kick Player Confirmation Modal -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">اخراج بازیکن</h2>
                <button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <p class="text-lg mb-8">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button>
                    <button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                </div>
            </div>
        </div>

        <!-- 11. Kicked Message Modal -->
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">شما اخراج شدید!</h2>
                <p id="kicked-message-text" class="text-lg mb-8">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p>
                <button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button>
            </div>
        </div>

        <!-- 12. Kicked Players List Modal -->
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">لیست بازیکنان اخراج شده</h2>
                <button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div id="kicked-players-list-content" class="space-y-4 mb-8 text-left max-h-60 overflow-y-auto custom-scrollbar">
                    <!-- Kicked players will be dynamically loaded here -->
                    <p class="text-center">هیچ بازیکنی اخراج نشده است.</p>
                </div>
                <button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button>
            </div>
        </div>
        
        <!-- 13. Enter Password Modal (for private lobbies) -->
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2>
                <p class="text-lg mb-6">لابی <span id="password-prompt-lobby-name" class="font-bold"></span> نیاز به رمز عبور دارد.</p>
                <form id="enter-password-form" class="space-y-5">
                    <div>
                        <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                               required>
                    </div>
                    <div class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // REVISED: Imported writeBatch for atomic updates
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4", // Replace with your Firebase project API Key
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase context (as per environment instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global AI API Key for Content Moderation (FOR DEMONSTRATION ONLY - INSECURE FOR PRODUCTION)
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // <<< REPLACE THIS WITH YOUR OWN GEMINI API KEY

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 
        
        // NEW: Loading Screen specific elements
        const binaryBackground = document.getElementById('binary-background');
        const loadingSubText = document.getElementById('loading-sub-text');

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const headerUserCoins = document.getElementById('header-user-coins'); // NEW (Updated for new location)
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const friendlyGameCostSpan = document.getElementById('friendly-game-cost'); // NEW
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen UI Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn'); // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Main Menu Modal Elements (Replaced Profile Modal)
        const mainMenuModal = document.getElementById('main-menu-modal');
        const closeMainMenuModalBtn = document.getElementById('close-main-menu-modal-btn');
        const mainMenuNav = document.getElementById('main-menu-nav');
        const showProfileBtn = document.getElementById('show-profile-btn');
        const showThemesBtn = document.getElementById('show-themes-btn');
        const mainMenuLogoutBtn = document.getElementById('main-menu-logout-btn'); // Logout button now in main menu modal

        // Profile View (inside Main Menu Modal)
        const profileView = document.getElementById('profile-view');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileCoins = document.getElementById('profile-coins');
        const backToMainMenuFromProfile = document.getElementById('back-to-main-menu-from-profile');

        // Themes View (inside Main Menu Modal)
        const themesView = document.getElementById('themes-view');
        const themeButtonsContainer = document.getElementById('theme-buttons-container');
        const backToMainMenuFromThemes = document.getElementById('back-to-main-menu-from-themes');


        // Create Lobby Modal Elements
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field'); // Corrected ID
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');
        const gameDurationInput = document.getElementById('game-duration-input'); // NEW
        const createLobbyModalTitle = document.getElementById('create-lobby-modal-title'); // NEW: Added ID to H2

        // NEW: Lobby Name Selection/Proposal specific elements
        const lobbyNameSelectionArea = document.getElementById('lobby-name-selection-area');
        const approvedLobbyNamesSelect = document.getElementById('approved-lobby-names-select');
        const lobbyNameProposalArea = document.getElementById('lobby-name-proposal-area');
        const proposedLobbyNameInput = document.getElementById('proposed-lobby-name-input');
        const submitLobbyNameForApprovalBtn = document.getElementById('submit-lobby-name-for-approval-btn');
        const lobbyProposalMessage = document.getElementById('lobby-proposal-message'); // NEW for message about pending requests

        // NEW: Pending Lobby Names Area (for display of names waiting for admin approval)
        const pendingLobbyNamesArea = document.getElementById('pending-lobby-names-area');
        const pendingLobbyNamesList = document.getElementById('pending-lobby-names-list');

        // NEW: Approved Lobby Names Management Area (for deletion)
        const approvedLobbyNamesManagementArea = document.getElementById('approved-lobby-names-management-area');
        const approvedLobbyNamesManagementList = document.getElementById('approved-lobby-names-management-list');


        // Custom Confirmation Modal Elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // --- NEW: LOBBY DETAIL SCREEN (GAME VIEW) ELEMENTS ---
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const detailScenarioName = document.getElementById('detail-scenario-name');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const gameLobbyExitBtn = document.getElementById('game-lobby-exit-btn');
        const gameTableArea = document.getElementById('game-table-area');
        const readyToggleBtn = document.getElementById('ready-toggle-btn');


        // Game specific UI elements for overlays (re-used)
        const gameCountdownOverlay = document.getElementById('game-countdown-overlay');
        const countdownNumber = gameCountdownOverlay.querySelector('.countdown-effect');
        const gameVotingOverlay = document.getElementById('game-voting-overlay');
        const votingTitle = document.getElementById('voting-title');
        const votingInstructions = document.getElementById('voting-instructions');
        const votingOptions = document.getElementById('voting-options');
        const gameResultDisplay = document.getElementById('game-result-display');
        const winnerText = document.getElementById('winnerText'); 
        const reasonText = document.getElementById('reasonText');
        const returnToLobbiesBtn = document.getElementById('return-to-lobbies-btn');


        // Kick Player Confirmation Modal Elements
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-btn');
        const kickPlayerConfirmName = document.getElementById('kick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');

        // Kicked Message Modal Elements
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedMessageText = document.getElementById('kicked-message-text');
        const kickedLobbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');

        // Kicked Players List Modal Elements
        const kickedPlayersListModal = document.getElementById('kicked-players-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        const kickedPlayersListContent = document.getElementById('kicked-players-list-content');
        const kickedListOkBtn = document.getElementById('kicked-list-ok-btn');
        
        // New Enter Password Modal Elements
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // State variables
        let authMode = 'login'; // Default mode is login
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; // To store user's profile data
        let unsubscribeLobbies = null; // Global variable to store the unsubscribe function for lobby list listener
        let unsubscribeLobbyDetail = null; // Global variable for single lobby detail listener
        let unsubscribeKickedPlayers = null; // Listener for kicked players list
        let unsubscribeUserProfile = null; // NEW: Listener for real-time user profile updates
        let unsubscribePendingLobbyNames = null; // NEW: Listener for pending lobby names
        let unsubscribeGameSettings = null; // NEW: Listener for real-time game settings
        let isInitialAuthCheckComplete = false; // Flag to ensure initial loading screen transition happens only once
        let userHasActiveLobby = false; // Track if the current user has an active lobby (created or joined)
        let currentLobbyId = null; // Stores the ID of the lobby the current user is in
        let kickedPlayerToProcess = null; // Stores UID/name of player selected for kicking
        let lobbyToJoin = null; // To store data of private lobby user wants to join
        let isRefreshing = false; // NEW: State for refresh button
        let gameEntryCost = 100; // NEW: Default game entry cost, will be fetched from Firebase
        let currentTheme = 'classic'; // NEW: To store the currently active theme

        // Promise resolver for custom confirmation modal
        let resolveCustomConfirm;

        // Global timer variables for game
        let gameCountdownInterval = null;
        let gameTimerInterval = null;
        
        // NEW: Max pending proposals limit
        const MAX_PENDING_PROPOSALS = 5;

        // NEW: Player positions for the new layout
        const playerPositions = [
            { top: '45%', left: '18%' },
            { top: '35%', right: '18%' },
            { top: '65%', left: '25%' },
            // Add more positions up to 10
            { top: '65%', right: '25%' },
            { top: '25%', left: '40%' },
            { top: '25%', right: '40%' },
            { top: '80%', left: '40%' },
            { top: '80%', right: '40%' },
            { top: '50%', left: '50%' }, // Center-ish
            { top: '90%', left: '50%' }  // Bottom center
        ];

        // ===============================================
        // === START: NEW JS FOR ANIMATED LOADING SCREEN ===
        // ===============================================

        function createBinaryBackground() {
            if (!binaryBackground) return;
            const screenArea = window.innerWidth * window.innerHeight;
            const chars = Math.floor(screenArea / 150); // Adjust density
            let binaryString = '';
            for (let i = 0; i < chars; i++) {
                binaryString += Math.random() > 0.5 ? '1 ' : '0 ';
            }
            binaryBackground.textContent = binaryString;
        }

        function setRandomLoadingSubtext() {
            if (!loadingSubText) return;
            const subtexts = [
                "آیا می‌توانی هوش مصنوعی را در میان انسان‌ها بیابی؟",
                "هر پیامی می‌تواند یک سرنخ باشد...",
                "سکوت، گاهی بلندتر از فریاد است.",
                "در دنیای دیجیتال، به چه کسی می‌توان اعتماد کرد؟",
                "در حال تحلیل بازیکنان...",
                "برقراری ارتباط امن..."
            ];
            const randomIndex = Math.floor(Math.random() * subtexts.length);
            loadingSubText.textContent = subtexts[randomIndex];
        }

        // Initialize the new loading screen graphics immediately.
        createBinaryBackground();
        setRandomLoadingSubtext();

        // =============================================
        // === END: NEW JS FOR ANIMATED LOADING SCREEN ===
        // =============================================

        // Function to clear all game-related intervals
        function clearGameIntervals() {
            if (gameCountdownInterval) {
                clearInterval(gameCountdownInterval);
                gameCountdownInterval = null;
            }
            if (gameTimerInterval) {
                clearInterval(gameTimerInterval);
                gameTimerInterval = null;
            }
        }

        // Function to reset game UI elements
        function resetGameUI() {
            // Hide overlays from the new game view
            gameCountdownOverlay.classList.add('hidden');
            gameVotingOverlay.classList.add('hidden');

            // Reset other game-related UI elements if they exist from the old design
            const gameInfoPanel = document.getElementById('game-info-panel');
            if(gameInfoPanel) gameInfoPanel.classList.add('hidden');
        }

        // NEW: Theme Configurations
        const themeConfigs = {
            'classic': {
                displayName: 'کلاسیک',
                bodyClass: 'theme-classic',
                buttonClass: 'btn-brown-classic'
            },
            'cyberpunk': {
                displayName: 'سایبرپانک',
                bodyClass: 'theme-cyberpunk',
                buttonClass: 'btn-purple-classic'
            }
            // Other themes removed for brevity
        };

        async function applyTheme(themeName) {
            let config = themeConfigs[themeName];
            if (!config) {
                console.warn(`Theme "${themeName}" not found. Falling back to 'classic'.`);
                themeName = 'classic';
                config = themeConfigs['classic'];
            }
            Object.values(themeConfigs).forEach(conf => {
                document.body.classList.remove(conf.bodyClass);
            });
            document.body.classList.add(config.bodyClass);
            currentTheme = themeName;
            updateThemeButtonsActiveState();
            if (auth.currentUser && currentUserData && currentUserData.theme !== themeName) {
                try {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                    await updateDoc(userProfileRef, { theme: themeName });
                } catch (error) {
                    console.error("Error saving theme to user profile:", error);
                }
            }
        }

        function populateThemeButtons() {
            themeButtonsContainer.innerHTML = ''; 
            for (const themeKey in themeConfigs) {
                const theme = themeConfigs[themeKey];
                const button = document.createElement('button');
                button.className = `classic-btn ${theme.buttonClass} text-base sm:text-lg theme-button`;
                button.dataset.theme = themeKey;
                button.textContent = theme.displayName;
                button.addEventListener('click', () => applyTheme(themeKey));
                themeButtonsContainer.appendChild(button);
            }
            updateThemeButtonsActiveState();
        }

        function updateThemeButtonsActiveState() {
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.toggle('active-theme-btn', btn.dataset.theme === currentTheme);
            });
        }

        function openMainMenuModal() {
            mainMenuModal.classList.remove('hidden');
            void mainMenuModal.offsetWidth;
            mainMenuModal.classList.add('profile-modal-enter-active');
            mainMenuNav.classList.remove('hidden');
            profileView.classList.add('hidden');
            themesView.classList.add('hidden');
        }

        function closeMainMenuModal() {
            mainMenuModal.classList.remove('profile-modal-enter-active');
            mainMenuModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                mainMenuModal.classList.add('hidden');
                mainMenuModal.classList.remove('profile-modal-leave-active');
            }, 300);
        }

        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            console.log(`پیام نمایش داده شد (${type}): ${message}`);
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);

        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                void customConfirmModal.offsetWidth; 
                customConfirmModal.classList.add('profile-modal-enter-active');
                resolveCustomConfirm = resolve;
                confirmYesBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(true);
                };
                confirmNoBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(false);
                };
            });
        }

        function closeCustomConfirm() {
            customConfirmModal.classList.remove('profile-modal-enter-active');
            customConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                customConfirmModal.classList.add('hidden');
                customConfirmModal.classList.remove('profile-modal-leave-active');
            }, 300); 
        }

        async function checkLobbyNameWithAI(lobbyName) {
            // Placeholder: Assume name is appropriate
            return { is_appropriate: true, reason: "" };
        }

        async function checkMessageForLiteraryAIStyle(message) {
            // Placeholder: Assume message is appropriate
            return { is_literary: true, reason: "" };
        }

        function formatLobbyNameWithColor(name) {
            const regex = /^\[#([0-9A-Fa-f]{6})\](.*)/;
            const match = name.match(regex);
            if (match) {
                const colorCode = match[1];
                const cleanName = match[2].trim();
                return `<span style="color:#${colorCode};">${cleanName}</span>`;
            }
            return name;
        }

        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            clearGameIntervals();
            resetGameUI();

            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');

                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                
                if (newScreen === authScreen) initializeAuthScreen();
                else if (newScreen === lobbyScreen) lobbySearchInput.focus();

                currentActiveScreen = newScreen;
            }, 600);
        }
        
        // ... (All other helper functions like open/close modals remain the same) ...

        function updateUserCoinsDisplay() {
            if (currentUserData && currentUserData.coins !== undefined) {
                headerUserCoins.textContent = currentUserData.coins.toLocaleString('fa-IR');
            } else {
                headerUserCoins.textContent = `---`;
            }
        }
        
        function setupGameSettingsListener() {
            if (unsubscribeGameSettings) unsubscribeGameSettings(); 
            const configRef = doc(db, `artifacts/${appId}/config/game_settings`);
            unsubscribeGameSettings = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const newCost = docSnap.data().gameEntryCost;
                    if (typeof newCost === 'number') {
                        gameEntryCost = newCost;
                        friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa-IR');
                    }
                }
            }, (error) => {
                console.error("خطا در گوش دادن به تنظیمات بازی:", error);
            });
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (unsubscribeUserProfile) unsubscribeUserProfile();
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                unsubscribeUserProfile = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = { uid: user.uid, email: user.email, ...docSnap.data() };
                        headerDisplayName.textContent = currentUserData.displayName || 'کاربر ناشناس';
                        headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                        updateUserCoinsDisplay();
                        const savedTheme = currentUserData.theme || 'classic';
                        if (currentTheme !== savedTheme) {
                            applyTheme(savedTheme);
                        }
                    } else {
                        // Create default profile if it doesn't exist
                        setDoc(userDocRef, {
                            displayName: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            coins: 500,
                            approvedLobbyNames: [],
                            banStatus: { isBanned: false },
                            createdAt: serverTimestamp(),
                            theme: 'classic'
                        });
                    }
                });
            } else {
                if (unsubscribeUserProfile) unsubscribeUserProfile();
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                // ... other listener cleanups ...
                currentUserData = null;
                applyTheme('classic');
            }

            if (!isInitialAuthCheckComplete) {
                setActiveScreen(user ? mainScreen : authScreen);
                isInitialAuthCheckComplete = true;
            } else {
                if (user && currentActiveScreen === authScreen) setActiveScreen(mainScreen);
                else if (!user && currentActiveScreen !== authScreen) setActiveScreen(authScreen);
            }
        });

        async function performAsyncAppSetup() {
            try {
                const configRef = doc(db, `artifacts/${appId}/config/game_settings`);
                const configSnap = await getDoc(configRef);
                if (!configSnap.exists()) {
                    await setDoc(configRef, { gameEntryCost: 100 });
                }
            } catch (error) {
                console.error("CRITICAL: Error initializing game settings config:", error);
            }
            setupGameSettingsListener();
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with initial custom token:", error);
                }
            }
        }
        performAsyncAppSetup();

        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': "فرمت ایمیل نامعتبر است.",
                'auth/user-not-found': "کاربری با این ایمیل یافت نشد.",
                'auth/wrong-password': "ایمیل یا رمز عبور اشتباه است.",
                'auth/email-already-in-use': "این ایمیل قبلاً ثبت نام شده است.",
                'auth/weak-password': "رمز عبور باید حداقل ۶ کاراکتر باشد."
                // ... more messages
            };
            return messages[errorCode] || "خطایی ناشناخته رخ داده است.";
        }
        
        async function createLobby(lobbyName, userId, displayName, lobbyType, password, gameDurationMinutes) {
            // Simplified logic: Assume user can create a lobby
            const lobbiesRef = collection(db, `global_lobbies`);
            const newLobbyData = {
                name: lobbyName,
                hostId: userId,
                status: "waiting", // "waiting" is the pre-game state
                type: lobbyType,
                players: { [userId]: { displayName: displayName, isReady: false } },
                kickedPlayers: [],
                createdAt: serverTimestamp(),
                gameSettings: { 
                    maxPlayers: 10, // As per image
                    gameDurationMinutes: gameDurationMinutes,
                    scenario: "Rifleman" // Static from image
                }
            };
            if (lobbyType === 'private') newLobbyData.password = password;
            const newLobbyRef = await addDoc(lobbiesRef, newLobbyData);
            userHasActiveLobby = true;
            return newLobbyRef.id;
        }

        // --- All other DB functions like joinLobby, closeLobby, etc. are assumed to be correct and are omitted for brevity ---
        // ...
        
        // =============================================================
        // === START: MODIFIED LOBBY DETAIL LISTENER FOR NEW LAYOUT  ===
        // =============================================================
        
        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to lobby details for ID: ${lobbyId} with NEW layout.`);
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            clearGameIntervals();
            resetGameUI();

            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const unsubscribe = onSnapshot(lobbyRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    showMessageBox("لابی که در آن بودید بسته شد.", "info");
                    currentLobbyId = null; userHasActiveLobby = false;
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                    return;
                }
                
                const lobbyData = docSnap.data();
                const myUid = auth.currentUser.uid;

                // Check if user is still in lobby
                if (!lobbyData.players || !lobbyData.players[myUid]) {
                    // Logic for when user is kicked or leaves
                     setActiveScreen(lobbyScreen);
                     unsubscribeLobbies = setupLobbyListener('');
                    return;
                }

                // If game is playing, redirect to game logic (can be added later)
                if (lobbyData.status === 'playing') {
                    // setupGameUI(lobbyId, lobbyData); // Future function call
                    return;
                }
                
                // --- RENDER NEW LAYOUT ---
                const playersMap = lobbyData.players || {};
                const playerCount = Object.keys(playersMap).length;
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 10;
                const hostDisplayName = playersMap[lobbyData.hostId]?.displayName || 'ناشناس';

                // Update top info header
                detailLobbyName.innerHTML = formatLobbyNameWithColor(lobbyData.name);
                detailHostName.textContent = `سازنده: ${hostDisplayName}`;
                detailScenarioName.textContent = `سناریو: ${lobbyData.gameSettings?.scenario || 'نامشخص'}`;
                detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                // Render players on the rug
                gameTableArea.innerHTML = ''; // Clear previous pods
                const playerArray = Object.entries(playersMap);

                playerArray.forEach(([uid, playerData], index) => {
                    if (index >= playerPositions.length) return; // Don't render more players than we have positions for

                    const pos = playerPositions[index];
                    const playerPod = document.createElement('div');
                    playerPod.className = 'game-player-pod-on-rug';
                    playerPod.style.top = pos.top;
                    playerPod.style.left = pos.left;
                    playerPod.style.right = pos.right || 'auto';
                    playerPod.style.bottom = pos.bottom || 'auto';
                    
                    // Default SVG Avatar
                    const avatarHTML = `
                        <svg class="player-avatar-img" viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80">
                            <mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36">
                                <rect width="36" height="36" rx="72" fill="#FFFFFF"></rect>
                            </mask>
                            <g mask="url(#mask__beam)">
                                <rect width="36" height="36" fill="#F0F0F0"></rect>
                                <rect x="0" y="0" width="36" height="36" transform="translate(4 4) rotate(324 18 18) scale(1.1)" fill="#A0A0A0" rx="6"></rect>
                                <g transform="translate(2 -5) rotate(4 18 18)">
                                    <path d="M15 20c2 1 4 1 6 0" stroke="#000000" fill="none" stroke-linecap="round"></path>
                                    <rect x="14" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect>
                                    <rect x="20" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect>
                                </g>
                            </g>
                        </svg>`;

                    playerPod.innerHTML = `
                        <div class="player-number-badge">${index + 1}</div>
                        ${avatarHTML}
                        <div class="player-name-on-rug">${playerData.displayName}</div>
                    `;
                    gameTableArea.appendChild(playerPod);
                });
                
                // Update "Ready" button status
                const myReadyStatus = playersMap[myUid]?.isReady || false;
                if (myReadyStatus) {
                    readyToggleBtn.textContent = "آماده‌ام";
                    readyToggleBtn.classList.remove('not-ready');
                    readyToggleBtn.classList.add('is-ready');
                } else {
                    readyToggleBtn.textContent = "آماده نیستم";
                    readyToggleBtn.classList.remove('is-ready');
                    readyToggleBtn.classList.add('not-ready');
                }


            }, (error) => {
                console.error("Lobby detail listener error:", error);
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            });
            return unsubscribe;
        }

        // Function to toggle the ready state of a player
        async function toggleReadyState() {
            if (!currentLobbyId || !auth.currentUser) return;
            const myUid = auth.currentUser.uid;
            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);

            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists()) {
                    const currentPlayers = lobbySnap.data().players;
                    const myCurrentState = currentPlayers[myUid]?.isReady || false;
                    
                    // Update the state in Firestore using dot notation
                    await updateDoc(lobbyRef, {
                        [`players.${myUid}.isReady`]: !myCurrentState
                    });
                }
            } catch (error) {
                console.error("Error toggling ready state:", error);
                showMessageBox("خطا در تغییر وضعیت آمادگی.", "error");
            }
        }
        
        // --- Event Listeners ---

        // All other event listeners are assumed to be correct and are omitted for brevity.
        // ... (authForm submit, menu clicks, lobby creation, etc.) ...
        
        // NEW EVENT LISTENERS FOR THE REDESIGNED LOBBY VIEW
        gameLobbyExitBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;

            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const myUid = auth.currentUser.uid;
            
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { 
                    setActiveScreen(lobbyScreen);
                    return; 
                }
                const lobbyData = lobbySnap.data();

                if (lobbyData.hostId === myUid) {
                    const confirmed = await showCustomConfirm("شما سازنده لابی هستید. خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟", "بستن لابی");
                    if (confirmed) {
                        await deleteDoc(lobbyRef);
                        // The listener will automatically handle screen transition
                    }
                } else {
                    // Just remove the player from the map
                    await updateDoc(lobbyRef, {
                        [`players.${myUid}`]: deleteField()
                    });
                     // The listener will automatically handle screen transition
                }
            } catch (error) {
                console.error("Error leaving lobby:", error);
                showMessageBox("خطا در خروج از لابی.", "error");
            }
        });

        readyToggleBtn.addEventListener('click', toggleReadyState);


        // --- Simplified event listeners for brevity ---
        // (The full version from the original file should be kept)
        authForm.addEventListener('submit', async (e) => { e.preventDefault(); /* ... auth logic ... */ });
        menuBtn.addEventListener('click', openMainMenuModal);
        profileSummary.addEventListener('click', openMainMenuModal);
        closeMainMenuModalBtn.addEventListener('click', closeMainMenuModal);
        mainMenuLogoutBtn.addEventListener('click', async () => { /* ... logout logic ... */ });
        friendlyGameBtn.addEventListener('click', () => { 
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener('');
        });
        backToMainBtn.addEventListener('click', () => setActiveScreen(mainScreen));
        addIconBtn.addEventListener('click', () => openCreateLobbyModal('create'));


    </script>
</body>
</html>
