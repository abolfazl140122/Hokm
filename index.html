<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ======================================================================== */
        /*                          پایه و تم کلی                                  */
        /* ======================================================================== */
        html, body, #app { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            font-family: 'Merriweather', serif;
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%);
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3 { font-family: 'Playfair Display', serif; color: #FFD700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .page-transition-active { transition: opacity 0.6s ease-in-out; }
        .page-transition-hidden { opacity: 0; }
        .page-transition-visible { opacity: 1; }

        /* ======================================================================== */
        /*                      کارت‌ها و مودال‌های کلاسیک                            */
        /* ======================================================================== */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%);
            border: 4px solid #DAA520;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            max-height: 95vh; /* کمی بیشتر فضا */
            overflow-y: auto;
            overflow-x: hidden;
        }
        .classic-card::before, .classic-card::after { content: ''; position: absolute; width: 30px; height: 30px; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .classic-card::before { top: -10px; left: -10px; border-top: 5px solid #FFD700; border-left: 5px solid #FFD700; border-radius: 5px 0 0 0; }
        .classic-card::after { bottom: -10px; right: -10px; border-bottom: 5px solid #FFD700; border-right: 5px solid #FFD700; border-radius: 0 0 5px 0; }

        /* ======================================================================== */
        /*                           دکمه‌ها و ورودی‌ها                                */
        /* ======================================================================== */
        .classic-btn { border: 2px solid #DAA520; border-radius: 15px; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); color: #FFFFFF; padding: 0.875rem 1.5rem; font-size: 1.125rem; position: relative; overflow: hidden; }
        .classic-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255,255,255,0.1); transform: skewX(-30deg); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .classic-btn:hover::before { left: 100%; }
        .classic-btn:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); }
        .classic-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background: #555 !important; border-color: #777 !important; }

        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }

        input { background-color: #202020; border: 2px solid #5A5A5A; color: #E0E0E0; padding: 0.875rem; border-radius: 0.75rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        input:focus { border-color: #DAA520 !important; box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; }

        /* ======================================================================== */
        /*                           هدر، فوتر و محتوا اصلی                          */
        /* ======================================================================== */
        .app-header, .lobby-header { background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); height: 70px; position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between; }
        .app-footer, .lobby-footer { background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); height: 90px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding: 1rem; display: flex; justify-content: space-around; align-items: center; }
        .main-content-area { padding-top: 70px; padding-bottom: 90px; flex-grow: 1; overflow-y: auto; overflow-x: hidden; width: 100%; display: flex; flex-direction: column; align-items: center; }

        /* ======================================================================== */
        /*                   استایل‌های اختصاصی قابلیت‌های جدید                      */
        /* ======================================================================== */

        /* --- مودال پروفایل پیشرفته --- */
        #profile-xp-bar-container { background-color: #333; border: 2px solid #555; border-radius: 9999px; padding: 2px; }
        #profile-xp-bar { background: linear-gradient(90deg, #DAA520, #FFD700); border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .stat-card { background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 12px; padding: 1rem; }
        .stat-card-value { font-family: 'Playfair Display', serif; font-size: 1.75rem; color: #fff; }
        .stat-card-label { font-size: 0.9rem; color: #aaa; }

        /* --- صفحه جزئیات لابی (انتخاب تیم) --- */
        .lobby-detail-content {
            display: flex; flex-direction: row; gap: 1.5rem; width: 95%; max-width: 1400px; /* Wider for new layout */
            margin: auto; padding: 1.5rem; height: calc(100vh - 40px);
            background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%); border-radius: 20px;
        }
        .team-container {
            border-radius: 15px; padding: 1rem; flex-grow: 1;
            display: flex; flex-direction: column; transition: box-shadow 0.3s ease;
        }
        .team-container:hover { box-shadow: 0 0 25px rgba(255, 215, 0, 0.3); }
        .team-a { border: 2px solid #3B82F6; background: rgba(59, 130, 246, 0.1); }
        .team-b { border: 2px solid #EF4444; background: rgba(239, 68, 68, 0.1); }

        .player-slot {
            background: rgba(255,255,255,0.05); border: 1px solid #444;
            border-radius: 10px; padding: 0.75rem 1rem; margin-bottom: 0.75rem;
            display: flex; align-items: center; justify-content: space-between;
            transition: all 0.2s ease-in-out;
        }
        .player-slot.is-host { border-left: 5px solid #FFD700; }
        .player-name { font-weight: bold; }
        .ready-status {
            width: 20px; height: 20px; border-radius: 50%; background-color: #EF4444;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #444; transition: all 0.3s ease;
        }
        .ready-status.ready { background-color: #22C55E; border-color: #fff; }
        .ready-status.ready svg { display: block; }
        .ready-status svg { display: none; color: white; }

        .lobby-sidebar { flex-shrink: 0; width: 350px; overflow-y: auto; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 15px; border: 1px solid #333; }
        .lobby-main-panel { flex-grow: 1; display: flex; flex-direction: column; gap: 1rem; min-width: 0; }
        .teams-grid { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .detail-actions-footer { display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-shrink: 0; }
        select { color: black; padding: 4px 8px; border-radius: 5px; background: #ddd; } /* For settings dropdown */
        
        @media (max-width: 1024px) {
            .lobby-detail-content { flex-direction: column; height: auto; max-height: 95vh; }
            .lobby-sidebar { width: 100%; max-height: 300px; }
        }
        @media (max-width: 640px) {
            .teams-grid { grid-template-columns: 1fr; }
            .detail-actions-footer { flex-direction: column; align-items: stretch; }
            .classic-btn { font-size: 1rem; padding: 0.75rem 1rem; }
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #202020; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #FFD700; }
    </style>
</head>
<body>

    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- ===== 1. Loading Screen ===== -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-black z-50">
            <!-- Spinner and text will be the same as original -->
            <p>در حال بارگذاری...</p>
        </div>

        <!-- ===== 2. Authentication Screen ===== -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden">
             <!-- Same as original file -->
        </div>

        <!-- ===== 3. Main Screen ===== -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
             <!-- Same as original file, header/footer logic will remain -->
        </div>

        <!-- ===== 4. Lobby List Screen ===== -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Same as original file, logic remains the same -->
        </div>

        <!-- ===== 5. Profile Modal (UPGRADED) ===== -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-lg text-center relative">
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 6 6 18m0-12 12 12"/></svg>
                </button>
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">پروفایل کاربری</h2>
                
                <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-4 mb-6 text-right w-full">
                    <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center border-2 border-yellow-400 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="none" stroke="#FFD700" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8m-2 9a2 2 0 0 0-2 2v1h8v-1a2 2 0 0 0-2-2z"/></svg>
                    </div>
                    <div>
                        <p class="text-xl font-bold" id="profile-display-name">---</p>
                        <p id="profile-email" class="text-gray-300">---</p>
                        <p id="profile-uid" class="text-xs text-gray-500 break-all">---</p>
                    </div>
                </div>

                <div class="mb-6 px-2">
                    <div class="flex justify-between items-center mb-1 text-yellow-300">
                        <span class="font-bold">سطح <span id="profile-level">1</span></span>
                        <span class="text-sm"><span id="profile-current-xp">0</span> / <span id="profile-next-level-xp">1000</span> XP</span>
                    </div>
                    <div id="profile-xp-bar-container" class="w-full h-4">
                        <div id="profile-xp-bar" class="h-full" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 text-white mb-8">
                    <div class="stat-card">
                        <p class="stat-card-value" id="profile-wins">0</p>
                        <p class="stat-card-label">برد</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card-value" id="profile-losses">0</p>
                        <p class="stat-card-label">باخت</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card-value" id="profile-win-rate">0%</p>
                        <p class="stat-card-label">درصد پیروزی</p>
                    </div>
                </div>

                <button id="profile-logout-btn" class="w-full classic-btn btn-red-classic text-lg">خروج از حساب</button>
            </div>
        </div>

        <!-- ===== 6. Lobby Detail Screen (COMPLETELY REDESIGNED) ===== -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden p-2 sm:p-5 flex items-center justify-center">
            <div class="lobby-detail-content">
                
                <!-- Sidebar: Info, Settings, Chat -->
                <aside class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl font-bold truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-1">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    
                    <div class="w-full h-px bg-yellow-600 my-4"></div>

                    <!-- NEW: Game Settings -->
                    <h3 class="text-xl font-bold mb-3">تنظیمات بازی</h3>
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between items-center bg-black bg-opacity-25 p-2 rounded-lg">
                            <label for="rounds-to-win-select" class="text-gray-300">امتیاز نهایی:</label>
                            <select id="rounds-to-win-select" class="bg-gray-700 border border-gray-500 rounded px-2 py-1" disabled>
                                <option value="5">5 امتیاز</option>
                                <option value="7">7 امتیاز</option>
                                <option value="9">9 امتیاز</option>
                            </select>
                        </div>
                    </div>

                    <div class="w-full h-px bg-yellow-600 my-4"></div>

                    <!-- Chat Container -->
                    <div class="lobby-chat-container flex flex-col flex-grow min-h-0">
                         <h3 class="text-xl font-bold mb-3">چت لابی</h3>
                        <div id="lobby-chat-messages" class="flex-grow overflow-y-auto mb-2 bg-black bg-opacity-25 p-2 rounded-lg">
                            <!-- Chat messages -->
                        </div>
                        <form id="lobby-chat-form" class="flex gap-2">
                            <input type="text" id="lobby-chat-input" class="w-full" placeholder="پیام شما...">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic !p-2 !text-sm">ارسال</button>
                        </form>
                    </div>
                </aside>

                <!-- Main Panel: Teams & Actions -->
                <main class="lobby-main-panel">
                    <!-- Teams -->
                    <div class="teams-grid">
                        <!-- Team A -->
                        <div id="team-a-container" class="team-container team-a">
                            <h3 class="text-2xl text-center text-blue-300 mb-4">تیم آبی</h3>
                            <div id="team-a-players" class="flex-grow space-y-3">
                                <!-- Player slots for team A -->
                            </div>
                            <button id="join-team-a-btn" class="classic-btn btn-blue-classic w-full mt-4 !text-base !py-2">پیوستن به تیم آبی</button>
                        </div>
                        <!-- Team B -->
                        <div id="team-b-container" class="team-container team-b">
                            <h3 class="text-2xl text-center text-red-300 mb-4">تیم قرمز</h3>
                            <div id="team-b-players" class="flex-grow space-y-3">
                               <!-- Player slots for team B -->
                            </div>
                             <button id="join-team-b-btn" class="classic-btn btn-red-classic w-full mt-4 !text-base !py-2">پیوستن به تیم قرمز</button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="detail-actions-footer pt-4 mt-auto">
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic w-full sm:w-auto">ترک لابی</button>
                        <button id="ready-btn" class="classic-btn btn-gray-classic w-full sm:w-auto text-xl">آماده نیستم</button>
                        <button id="start-game-btn" class="classic-btn start-game-btn w-full sm:w-auto text-xl" disabled>شروع بازی</button>
                    </div>
                    <!-- Simulate game over button for testing stats -->
                    <button id="simulate-game-over-btn" style="display: none;" class="classic-btn btn-purple-classic">Test GameOver</button>
                </main>
            </div>
        </div>

        <!-- All other modals (create, confirm, kick, password, etc.) remain here -->
        <!-- Their HTML does not need to change -->

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, deleteDoc, getDocs, deleteField, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (Replace with yours) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };
        
        // --- Initialize ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUserData = null; // Full profile data including stats
        let currentLobbyId = null;
        let unsubscribeLobbyDetail = null;
        let unsubscribeLobbies = null;

        // --- DOM Elements (Simplified for brevity) ---
        // Profile Modal
        const profileModal = document.getElementById('profile-modal');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLevel = document.getElementById('profile-level');
        const profileCurrentXp = document.getElementById('profile-current-xp');
        const profileNextLevelXp = document.getElementById('profile-next-level-xp');
        const profileXpBar = document.getElementById('profile-xp-bar');
        const profileWins = document.getElementById('profile-wins');
        const profileLosses = document.getElementById('profile-losses');
        const profileWinRate = document.getElementById('profile-win-rate');

        // Lobby Detail Screen
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const roundsToWinSelect = document.getElementById('rounds-to-win-select');
        const teamAPlayersContainer = document.getElementById('team-a-players');
        const teamBPlayersContainer = document.getElementById('team-b-players');
        const joinTeamABtn = document.getElementById('join-team-a-btn');
        const joinTeamBBtn = document.getElementById('join-team-b-btn');
        const readyBtn = document.getElementById('ready-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const simulateGameOverBtn = document.getElementById('simulate-game-over-btn'); // for testing
        
        // Chat
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        
        /* 
        ======================================================================
        ========= ALL OTHER ORIGINAL DOM ELEMENTS AND FUNCTIONS ==============
        ========= (showCustomMessage, setActiveScreen, Modals, etc) ==========
        ========= ARE ASSUMED TO BE HERE, UNCHANGED, FOR BREVITY      =========
        ======================================================================
        */
       
        // --- Core Authentication and Profile Logic (UPGRADED) ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Fetch full user profile, including new stats
                const userDocRef = doc(db, `users/${user.uid}`);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUserData = { uid: user.uid, ...userDocSnap.data() };
                } else {
                    // Create a new profile for a new user
                    const newUserProfile = {
                        displayName: user.email.split('@')[0],
                        email: user.email,
                        level: 1,
                        xp: 0,
                        stats: { wins: 0, losses: 0, gamesPlayed: 0 },
                        createdAt: serverTimestamp()
                    };
                    await setDoc(userDocRef, newUserProfile);
                    currentUserData = { uid: user.uid, ...newUserProfile };
                }
                
                // Assuming setActiveScreen etc. are defined elsewhere
                // setActiveScreen(mainScreen);

            } else {
                currentUserData = null;
                // Cleanup listeners and go to auth screen
                if(unsubscribeLobbies) unsubscribeLobbies();
                if(unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                // setActiveScreen(authScreen);
            }
        });
        
        function openProfileModal() {
            if (!currentUserData) return;
            // Populate basic info
            profileDisplayName.textContent = currentUserData.displayName;
            profileEmail.textContent = currentUserData.email;
            profileUid.textContent = currentUserData.uid;

            // Populate stats
            const stats = currentUserData.stats || { wins: 0, losses: 0, gamesPlayed: 0 };
            profileWins.textContent = stats.wins;
            profileLosses.textContent = stats.losses;
            const winRate = (stats.gamesPlayed > 0) ? Math.round((stats.wins / stats.gamesPlayed) * 100) : 0;
            profileWinRate.textContent = `${winRate}%`;
            
            // Populate level and XP
            const level = currentUserData.level || 1;
            const xp = currentUserData.xp || 0;
            const xpForNextLevel = level * 1000; // Example formula
            profileLevel.textContent = level;
            profileCurrentXp.textContent = xp;
            profileNextLevelXp.textContent = xpForNextLevel;
            const xpPercentage = (xp / xpForNextLevel) * 100;
            profileXpBar.style.width = `${xpPercentage}%`;
            
            profileModal.classList.remove('hidden');
        }


        // --- Core Lobby Logic (COMPLETELY REWRITTEN) ---

        /**
         * The new lobby data model in Firestore:
         * collection: `global_lobbies`
         * document: {lobbyId}
         * {
         *   name: "Lobby Name",
         *   hostId: "uid_of_host",
         *   status: "waiting" | "playing" | "finished",
         *   createdAt: timestamp,
         *   players: { // This is now a MAP of objects
         *     "player_uid_1": {
         *       displayName: "Player 1",
         *       teamId: "team_a" | "team_b" | null,
         *       isReady: false,
         *       joinedAt: timestamp // CRUCIAL for host migration
         *     },
         *     "player_uid_2": { ... }
         *   },
         *   gameSettings: {
         *     roundsToWin: 7,
         *     maxPlayers: 4
         *   },
         *   teams: { // For quick counts and team data
         *      team_a: { playerCount: 1 },
         *      team_b: { playerCount: 0 }
         *   }
         * }
        */

        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to upgraded lobby details for ID: ${lobbyId}`);
            if (unsubscribeLobbies) unsubscribeLobbies();

            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            unsubscribeLobbyDetail = onSnapshot(lobbyRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // Lobby was deleted, probably by the host
                    // showMessageBox("لابی که در آن بودید بسته شد.", "info");
                    // setActiveScreen(lobbyScreen);
                    return;
                }

                const lobbyData = docSnap.data();
                const playersMap = lobbyData.players || {};
                const playerList = Object.entries(playersMap);
                const isCurrentUserHost = auth.currentUser.uid === lobbyData.hostId;
                const currentUserLobbyData = playersMap[auth.currentUser.uid];

                // Clear UI before repopulating
                teamAPlayersContainer.innerHTML = '';
                teamBPlayersContainer.innerHTML = '';

                // --- 1. Populate UI Header ---
                detailLobbyName.textContent = lobbyData.name;
                detailHostName.textContent = `سازنده: ${playersMap[lobbyData.hostId]?.displayName || 'نامشخص'}`;
                detailPlayerCount.textContent = `بازیکنان: ${playerList.length}/${lobbyData.gameSettings.maxPlayers}`;

                // --- 2. Populate Teams ---
                playerList.forEach(([uid, playerData]) => {
                    const playerElement = createPlayerSlotElement(uid, playerData, lobbyData.hostId);
                    if (playerData.teamId === 'team_a') {
                        teamAPlayersContainer.appendChild(playerElement);
                    } else if (playerData.teamId === 'team_b') {
                        teamBPlayersContainer.appendChild(playerElement);
                    } else {
                        // Player hasn't joined a team yet. For this design, we force team selection.
                        // We could add an "unassigned" area if needed.
                    }
                });

                // --- 3. Manage Button States ---
                const isTeamAFull = lobbyData.teams.team_a.playerCount >= lobbyData.gameSettings.maxPlayers / 2;
                const isTeamBFull = lobbyData.teams.team_b.playerCount >= lobbyData.gameSettings.maxPlayers / 2;
                
                joinTeamABtn.disabled = isTeamAFull;
                joinTeamBBtn.disabled = isTeamBFull;
                
                // --- 4. Manage Ready/Start State ---
                if (currentUserLobbyData) {
                    readyBtn.textContent = currentUserLobbyData.isReady ? "آماده!" : "آماده نیستم";
                    readyBtn.classList.toggle('btn-green-classic', currentUserLobbyData.isReady);
                    readyBtn.classList.toggle('btn-gray-classic', !currentUserLobbyData.isReady);
                }
                
                const allPlayersReady = playerList.length === lobbyData.gameSettings.maxPlayers && playerList.every(([_, p]) => p.isReady);
                startGameBtn.style.display = isCurrentUserHost ? 'block' : 'none';
                startGameBtn.disabled = !allPlayersReady;

                // --- 5. Manage Game Settings ---
                roundsToWinSelect.value = lobbyData.gameSettings.roundsToWin;
                roundsToWinSelect.disabled = !isCurrentUserHost;
            });

            // Add other listeners (chat, etc.) here
        }
        
        function createPlayerSlotElement(uid, playerData, hostId) {
            const isHost = uid === hostId;
            const isReady = playerData.isReady;

            const div = document.createElement('div');
            div.className = `player-slot ${isHost ? 'is-host' : ''}`;
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="ready-status ${isReady ? 'ready' : ''}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                    </div>
                    <span class="player-name">${playerData.displayName}</span>
                    ${isHost ? '<span class="text-xs text-yellow-400">(سازنده)</span>' : ''}
                </div>
                <!-- Maybe add a kick button for the host here -->
            `;
            return div;
        }

        async function leaveLobbyLogic() {
            if (!currentLobbyId || !auth.currentUser) return;
            
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if (!lobbySnap.exists()) return;
            
            const lobbyData = lobbySnap.data();
            const myUid = auth.currentUser.uid;
            const iAmHost = lobbyData.hostId === myUid;
            const remainingPlayers = Object.keys(lobbyData.players).filter(uid => uid !== myUid);

            if (iAmHost && remainingPlayers.length > 0) {
                // Host Migration!
                const playersArray = Object.entries(lobbyData.players)
                    .filter(([uid, _]) => uid !== myUid)
                    .sort((a, b) => a[1].joinedAt.seconds - b[1].joinedAt.seconds);
                
                const newHostUid = playersArray[0][0]; // Oldest player becomes new host
                
                await updateDoc(lobbyRef, {
                    hostId: newHostUid,
                    [`players.${myUid}`]: deleteField() // Atomically remove self
                });
            } else if (iAmHost && remainingPlayers.length === 0) {
                // I am host and last one out. Delete lobby.
                await deleteDoc(lobbyRef);
            } else {
                // I am not host. Just remove me.
                await updateDoc(lobbyRef, {
                    [`players.${myUid}`]: deleteField(),
                    [`teams.${lobbyData.players[myUid].teamId}.playerCount`]: (lobbyData.teams[lobbyData.players[myUid].teamId].playerCount - 1)
                });
            }

            currentLobbyId = null;
            // setActiveScreen(lobbyScreen);
        }

        async function joinTeam(teamId) {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);

            // A transaction would be better here, but for simplicity:
            const lobbySnap = await getDoc(lobbyRef);
            const lobbyData = lobbySnap.data();
            const myUid = auth.currentUser.uid;
            const me = lobbyData.players[myUid];

            // If I am already on a team, do nothing
            if(me.teamId === teamId) return;

            // Update my data
            const updates = {};
            updates[`players.${myUid}.teamId`] = teamId;
            updates[`players.${myUid}.isReady`] = false; // Un-ready on team switch
            
            // Decrement old team count if I was on a team
            if(me.teamId){
                 updates[`teams.${me.teamId}.playerCount`] = lobbyData.teams[me.teamId].playerCount - 1;
            }
            // Increment new team count
            updates[`teams.${teamId}.playerCount`] = lobbyData.teams[teamId].playerCount + 1;
            
            await updateDoc(lobbyRef, updates);
        }

        async function toggleReady() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            
            const lobbySnap = await getDoc(lobbyRef);
            const amIReady = lobbySnap.data().players[auth.currentUser.uid].isReady;

            await updateDoc(lobbyRef, {
                [`players.${auth.currentUser.uid}.isReady`]: !amIReady
            });
        }
        
        async function updateGameSettings(newRoundsToWin) {
            if (!currentLobbyId) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            await updateDoc(lobbyRef, { 'gameSettings.roundsToWin': parseInt(newRoundsToWin) });
        }


        // --- New Logic for post-game stats update (Example) ---
        async function handleGameOver(winningTeamId) {
             if (!currentLobbyId || !auth.currentUser) return;
            
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if (!lobbySnap.exists()) return;
            const lobbyData = lobbySnap.data();
            const playersMap = lobbyData.players;

            const batch = writeBatch(db);

            for (const uid in playersMap) {
                const player = playersMap[uid];
                const playerRef = doc(db, 'users', uid);

                // Determine win/loss
                const xpGained = (player.teamId === winningTeamId) ? 150 : 50;
                
                // Get current stats to update them
                const userSnap = await getDoc(playerRef);
                const userData = userSnap.data();
                
                const newWins = (player.teamId === winningTeamId) ? (userData.stats.wins + 1) : userData.stats.wins;
                const newLosses = (player.teamId !== winningTeamId) ? (userData.stats.losses + 1) : userData.stats.losses;
                
                const currentXp = userData.xp;
                const newXp = currentXp + xpGained;
                const xpForNextLevel = userData.level * 1000;
                
                let newLevel = userData.level;
                let finalXp = newXp;
                
                if(newXp >= xpForNextLevel) {
                    newLevel++;
                    finalXp = newXp - xpForNextLevel; // Reset XP for new level
                }

                batch.update(playerRef, {
                    'stats.wins': newWins,
                    'stats.losses': newLosses,
                    'stats.gamesPlayed': (userData.stats.gamesPlayed + 1),
                    'xp': finalXp,
                    'level': newLevel
                });
            }

            // Mark lobby as finished and commit all user updates
            batch.update(lobbyRef, { status: "finished" });
            await batch.commit();
            console.log("Game over! Stats have been updated for all players.");
        }


        // --- Event Listeners for New Features ---
        joinTeamABtn.addEventListener('click', () => joinTeam('team_a'));
        joinTeamBBtn.addEventListener('click', () => joinTeam('team_b'));
        readyBtn.addEventListener('click', toggleReady);
        leaveLobbyBtn.addEventListener('click', leaveLobbyLogic);
        roundsToWinSelect.addEventListener('change', (e) => updateGameSettings(e.target.value));

        // For testing purpose only
        simulateGameOverBtn.addEventListener('click', () => {
            // Assume team A wins for testing
            handleGameOver('team_a'); 
        });


        // Initialize App on Load
        // window.onload = () => { /* original logic */ };

        // Dummy call to simulate opening profile after login
        // setTimeout(openProfileModal, 2000); 

    </script>
</body>
</html>
