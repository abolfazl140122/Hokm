<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی متنی هوش مصنوعی و انسان</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Futuristic Look -->
    <!-- Orbitron for bold, techy headings -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <!-- Rajdhani for sleek body text -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* NEW: Futuristic / Cyberpunk Theme */

        /* General Body and App Container */
        html, body, #app {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Rajdhani', sans-serif; /* Sleek body font */
            background: linear-gradient(135deg, #0A0A10 0%, #1A0D1A 50%, #0A0A10 100%); /* Deep, dark, subtle gradient */
            color: #E0E0E0; /* Light gray text for contrast */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Add subtle grain/noise for texture */
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M0 0h3v3H0V0zm3 3h3v3H3V3z'/%3E%3C/g%3E%3C/svg%3E");
        }

        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif; /* Bold, techy headings */
            color: #00FFFF; /* Cyan/Aqua for titles, for a digital feel */
            text-shadow: 0 0 8px rgba(0,255,255,0.7); /* Glowing effect */
            letter-spacing: 1px;
        }

        /* Custom spinner - Pulsating Hexagon */
        .spinner {
            width: 60px; /* Larger spinner */
            height: 60px;
            border-radius: 50%; /* Still circular, but we'll use pseudo-elements for hex look */
            position: relative;
            animation: spin-pulse 2s cubic-bezier(0.65, 0.05, 0.36, 1) infinite;
            background: transparent;
        }
        .spinner::before, .spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #00FFFF; /* Cyan top */
            border-right-color: #A020F0; /* Purple right */
            border-bottom-color: #00FFFF; /* Cyan bottom */
            border-left-color: #A020F0; /* Purple left */
            border-radius: 50%;
            animation: spinner-border-rotate 1.5s linear infinite;
        }
        .spinner::after {
            animation-delay: -0.75s; /* Opposite direction/phase */
            transform: rotateY(180deg);
        }
        @keyframes spinner-border-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes spin-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Refresh button icon animation */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out; /* Add transform for slide effect */
        }
        .page-transition-hidden {
            opacity: 0;
            transform: translateY(20px); /* Slide down slightly on hide */
        }
        .page-transition-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Futuristic Card/Modal Styling - Glassmorphism & Glowing Edges */
        .futuristic-card {
            background: rgba(15, 15, 25, 0.8); /* Darker, semi-transparent base */
            border: 1px solid rgba(0,255,255,0.3); /* Subtle outer border */
            border-radius: 15px; /* Softer rounded corners */
            box-shadow: 0 0 20px rgba(0,255,255,0.3), inset 0 0 10px rgba(0,255,255,0.1); /* Cyan glow */
            backdrop-filter: blur(12px) brightness(1.1); /* Stronger blur, slightly brighter behind */
            -webkit-backdrop-filter: blur(12px) brightness(1.1);
            position: relative;
            max-height: 95vh; /* Slightly more room */
            overflow-y: hidden;
            overflow-x: hidden;
            padding: 2.5rem; /* More generous padding */
            animation: card-appear 0.8s ease-out forwards;
        }
        /* Card entry animation */
        @keyframes card-appear {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        /* Add glowing border effect with pseudo-element */
        .futuristic-card::before {
            content: '';
            position: absolute;
            inset: -2px; /* Expand slightly beyond the card */
            border-radius: 15px;
            padding: 2px;
            background: linear-gradient(45deg, #00FFFF, #A020F0, #00FFFF); /* Cyan-Purple gradient glow */
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none; /* Ensure it doesn't block clicks */
            animation: border-glow 4s linear infinite alternate;
        }
        @keyframes border-glow {
            0% { filter: hue-rotate(0deg); opacity: 0.7; }
            50% { opacity: 1; }
            100% { filter: hue-rotate(360deg); opacity: 0.7; }
        }


        /* Button Base Styles - Modern, Glowing */
        .futuristic-btn {
            border: none; /* No direct border */
            border-radius: 10px; /* Less rounded than classic */
            font-weight: 600; /* Rajdhani semibold */
            text-shadow: 0 0 5px rgba(0,255,255,0.5); /* Subtle cyan text glow */
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smoother cubic bezier */
            box-shadow: 0 4px 15px rgba(0,0,0,0.4), 0 0 10px rgba(0,255,255,0.4); /* Deeper shadow, cyan glow */
            color: #FFFFFF;
            padding: 0.875rem 1.75rem; /* Slightly more horizontal padding */
            font-size: 1.125rem;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #0A0A15 0%, #1A0D1A 100%); /* Dark gradient base */
            /* Add subtle noise for texture */
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.08' fill-rule='evenodd'%3E%3Cpath d='M0 0h3v3H0V0zm3 3h3v3H3V3z'/%3E%3C/g%3E%3C/svg%3E");
            z-index: 1; /* For pseudo-elements to be below glow */
        }
        /* Inner glowing border on button */
        .futuristic-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 10px;
            padding: 2px; /* Controls border thickness */
            background: linear-gradient(45deg, #00FFFF, #A020F0); /* Cyan-Purple gradient */
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1; /* Place behind button content */
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0.7;
        }
        /* Hover effect on buttons */
        .futuristic-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.6), 0 0 20px rgba(0,255,255,0.7); /* Stronger glow on hover */
            color: #00FFFF; /* Text color change on hover */
        }
        .futuristic-btn:hover::before {
            opacity: 1;
            transform: scale(1.05); /* Make inner border slightly larger */
        }
        .futuristic-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4), 0 0 10px rgba(0,255,255,0.2);
            color: #CCC;
            text-shadow: none;
        }
        .futuristic-btn:disabled::before {
             opacity: 0.3;
             transform: scale(1);
             background: linear-gradient(45deg, #555, #777); /* Grayed out gradient */
        }

        /* Specific Button Colors - Futuristic Palette */
        .btn-blue-futuristic {
            background: linear-gradient(135deg, #1A1A2A 0%, #2A2A5A 100%);
        }
        .btn-green-futuristic {
            background: linear-gradient(135deg, #152A15 0%, #2A5A2A 100%);
        }
        .btn-red-futuristic {
            background: linear-gradient(135deg, #2A1515 0%, #5A2A2A 100%);
        }
        .btn-gray-futuristic {
            background: linear-gradient(135deg, #2A2A2A 0%, #4A4A4A 100%);
        }
        .btn-purple-futuristic {
            background: linear-gradient(135deg, #2A152A 0%, #5A2A5A 100%);
        }
        .btn-brown-futuristic { /* Repurpose brown to a darker sci-fi tone */
            background: linear-gradient(135deg, #302010 0%, #503020 100%);
        }
        .btn-aqua-futuristic { /* For footer icons/small actions */
            background: linear-gradient(135deg, #00CACA 0%, #00FFFF 100%);
            border-radius: 8px; /* Slightly less rounded */
            padding: 0.6rem 1rem;
            box-shadow: 0 0 15px rgba(0,255,255,0.6);
            color: #0A0A10; /* Dark text on bright button */
            text-shadow: none;
        }
        .btn-aqua-futuristic:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 25px rgba(0,255,255,0.8);
            color: #0A0A10;
        }


        /* Input Field Styles - Sleek and Digital */
        input, select {
            background-color: #0F0F1A; /* Very dark blue */
            border: 1px solid #00FFFF; /* Cyan border */
            color: #E0E0E0;
            padding: 0.75rem 1rem; /* Adjust padding */
            border-radius: 8px; /* Slightly less rounded */
            box-shadow: inset 0 2px 5px rgba(0,255,255,0.2); /* Inner glow */
            outline: none; /* Remove default outline */
            transition: all 0.3s ease;
        }
        input::placeholder {
            color: #707080; /* Muted placeholder */
        }
        input:focus, select:focus {
            border-color: #A020F0 !important; /* Purple on focus */
            box-shadow: 0 0 0 3px rgba(160,32,240,0.5) !important, inset 0 2px 5px rgba(0,255,255,0.2) !important; /* Purple focus ring with inner glow */
        }
        /* Specific input styles for search bar in lobby header */
        .lobby-header .search-container input {
            padding: 0.5rem 1rem; /* Slightly less padding */
            border-radius: 8px; /* Consistent with other inputs */
        }

        /* Header specific styles - Digital Display */
        .app-header {
            background: rgba(10, 10, 20, 0.9); /* Darker, semi-transparent */
            border-bottom: 2px solid #00FFFF; /* Cyan bottom line */
            box-shadow: 0 5px 15px rgba(0,255,255,0.2), inset 0 -2px 5px rgba(0,255,255,0.1); /* Subtle top glow */
            height: 80px; /* Slightly taller */
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1.5rem; /* More padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(8px); /* Glassmorphism */
            -webkit-backdrop-filter: blur(8px);
        }
        /* Coin display container in header */
        #header-user-coins-container {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid #A020F0; /* Purple border */
            border-radius: 12px;
            padding: 0.4rem 0.8rem; /* Smaller padding */
            box-shadow: 0 2px 10px rgba(160,32,240,0.3); /* Purple glow */
            transition: all 0.3s ease;
            margin-left: 1rem;
        }
        #header-user-coins-container:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 15px rgba(160,32,240,0.6);
        }
        #header-user-coins {
            color: #A020F0; /* Purple coin text */
            font-size: 1.6rem; /* Slightly larger */
            font-weight: 700;
        }
        .coin-icon {
            fill: #00FFFF; /* Cyan color for coins */
        }

        /* Lobby Screen Specific Header */
        .lobby-header {
            background: rgba(10, 10, 20, 0.9);
            border-bottom: 2px solid #00FFFF;
            box-shadow: 0 5px 15px rgba(0,255,255,0.2), inset 0 -2px 5px rgba(0,255,255,0.1);
            height: 80px;
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .lobby-header .search-container {
            display: flex;
            flex-grow: 1;
            max-width: 700px; /* Wider search bar */
            margin: 0 auto;
            align-items: center;
            background-color: #0A0A10; /* Very dark background */
            border-radius: 10px;
            border: 1px solid #A020F0; /* Purple border */
            padding: 0.5rem 1rem;
            box-shadow: inset 0 0 8px rgba(160,32,240,0.3); /* Inner purple glow */
        }
        .lobby-header .search-container input {
            background-color: transparent;
            border: none;
            padding: 0.25rem 0.5rem;
            outline: none;
            text-align: right;
        }
        .lobby-header .search-container svg {
            color: #00FFFF; /* Cyan color for icons */
            min-width: 28px; /* Larger icons */
            min-height: 28px;
            transition: color 0.2s ease;
        }
        .lobby-header .search-container button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.5rem;
            transition: transform 0.2s ease;
        }
        .lobby-header .search-container button:hover svg {
            color: #A020F0; /* Purple on hover */
            transform: scale(1.1);
        }


        .app-footer {
            background: rgba(10, 10, 20, 0.9);
            border-top: 2px solid #00FFFF;
            box-shadow: 0 -5px 15px rgba(0,255,255,0.2), inset 0 2px 5px rgba(0,255,255,0.1);
            height: 100px; /* Taller footer */
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1.5rem; /* Increased gap */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        /* Lobby Screen Specific Footer */
        .lobby-footer {
            background: rgba(10, 10, 20, 0.9);
            border-top: 2px solid #00FFFF;
            box-shadow: 0 -5px 15px rgba(0,255,255,0.2), inset 0 2px 5px rgba(0,255,255,0.1);
            height: 100px;
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #00FFFF; /* Cyan for icons */
            font-size: 0.9rem; /* Slightly larger font */
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, color 0.2s ease, text-shadow 0.2s ease;
            text-shadow: 0 0 5px rgba(0,255,255,0.4);
        }
        .lobby-footer .icon-btn:hover {
            transform: translateY(-5px);
            color: #A020F0; /* Purple on hover */
            text-shadow: 0 0 10px rgba(160,32,240,0.8);
        }
        .lobby-footer .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            text-shadow: none;
            color: #888;
        }
        .lobby-footer .icon-btn svg {
            width: 35px; /* Larger icons */
            height: 35px;
            margin-bottom: 5px;
            transition: transform 0.8s ease-in-out;
        }
        .lobby-footer .games-running-text {
            color: #E0E0E0;
            font-size: 1.2rem; /* Larger and bolder */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px; /* More space */
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 1px solid rgba(0,255,255,0.2);
            box-shadow: inset 0 0 5px rgba(0,255,255,0.1);
        }
        .lobby-footer .games-running-text #active-games-count {
            color: #A020F0; /* Purple count */
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(160,32,240,0.7);
        }


        /* Main content area padding to avoid overlap with fixed header/footer */
        .main-content-area {
            padding-top: 80px; /* Header height */
            padding-bottom: 100px; /* Footer height */
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background: rgba(0,0,0,0.3); /* Slightly transparent for background to show */
            position: relative;
            padding-left: 1rem; /* Adjust for RTL padding */
            padding-right: 1rem; /* Adjust for RTL padding */
        }
        
        /* Profile Modal specific styles */
        .profile-modal-overlay {
            background-color: rgba(0,0,0,0.85); /* Darker, more immersive overlay */
            transition: opacity 0.4s ease-in-out;
        }
        .profile-modal-content {
            transform: translateY(-30px); /* More pronounced initial elevation */
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .profile-modal-enter-active .profile-modal-content {
            transform: translateY(0);
        }
        .profile-modal-leave-active .profile-modal-content {
            transform: translateY(-30px);
            opacity: 0;
        }

        /* Create Lobby Modal Specific Styles */
        #create-lobby-modal {
            background-color: rgba(0,0,0,0.85);
            transition: opacity 0.4s ease-in-out;
        }

        /* Confirmation Modal Styles */
        #confirmation-modal {
            background-color: rgba(0,0,0,0.85);
            transition: opacity 0.4s ease-in-out;
        }

        /* Animation for lobby items when closing */
        .lobby-item.fade-out {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        /* Enhanced Lobby Item Styling - Grid-like, glowing */
        .lobby-item {
            background: linear-gradient(145deg, #0F0F1A 0%, #1A0D1A 100%); /* Dark gradient base */
            border: 1px solid rgba(0,255,255,0.3); /* Subtle outer border */
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5), 0 0 12px rgba(0,255,255,0.3); /* Glow */
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            padding: 1.5rem 1.8rem; /* More generous padding */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        /* Inner glowing border on lobby item */
        .lobby-item::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(45deg, #00FFFF, #A020F0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
            opacity: 0.5;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .lobby-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.7), 0 0 20px rgba(0,255,255,0.7); /* Stronger glow on hover */
        }
        .lobby-item:hover::before {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .lobby-item h3 {
            color: #00FFFF; /* Cyan for lobby names */
            font-size: 1.8rem; /* Larger font */
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px rgba(0,255,255,0.7);
            margin-bottom: 0.5rem; /* Space below title */
        }

        .lobby-item p {
            color: #B0B0C0; /* Muted light gray */
            font-size: 1.05rem;
            margin-top: 0.15rem;
        }
        
        .lobby-item .lobby-actions {
            margin-top: 1.25rem;
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 0.8rem;
        }

        /* Lobby buttons, use futuristic-btn base */
        .lobby-item .join-lobby-btn,
        .lobby-item .close-lobby-btn,
        .lobby-item .view-my-lobby-btn { /* Added this for consistency */
            width: 100%;
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
        }

        /* Responsive adjustments for lobby-item buttons on larger screens */
        @media (min-width: 640px) { /* sm breakpoint */
            .lobby-item {
                flex-direction: row;
                text-align: right;
            }
            .lobby-item .lobby-actions {
                flex-direction: row;
                width: auto;
                margin-top: 0;
                gap: 0.75rem; /* Small gap between buttons */
            }
            .lobby-item .close-lobby-btn {
                margin-right: 0.75rem;
            }
            .lobby-item .join-lobby-btn,
            .lobby-item .close-lobby-btn,
            .lobby-item .view-my-lobby-btn {
                width: auto;
                font-size: 0.95rem;
                padding: 0.7rem 1.4rem;
            }
        }

        /* === Lobby Detail Screen Styles (Futuristic HUD) === */
        .lobby-detail-screen-full {
            padding-top: 0;
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background: linear-gradient(160deg, #05050A 0%, #0A0A10 100%); /* Even darker, subtle gradient */
        }

        .lobby-detail-content {
            background: rgba(10, 10, 20, 0.7); /* Semi-transparent dark blue */
            border: 2px solid #A020F0; /* Purple border */
            border-radius: 20px;
            box-shadow: 0 12px 25px rgba(0,0,0,0.7), 0 0 25px rgba(160,32,240,0.5); /* Deep shadow, purple glow */
            padding: 2rem;
            width: 98%; /* Slightly wider */
            max-width: 1400px; /* Max width for larger screens */
            height: calc(100% - 120px); /* Fill available space minus header/margins */
            display: flex;
            flex-direction: row;
            gap: 2rem; /* More space between panels */
            margin: 60px auto; /* Centered with margin top/bottom */
            overflow: hidden;
            backdrop-filter: blur(15px); /* Stronger glass effect */
            -webkit-backdrop-filter: blur(15px);
        }

        /* Sidebar for player info */
        .lobby-sidebar {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 320px; /* Slightly wider sidebar */
            background-color: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(0,255,255,0.3); /* Cyan border */
            box-shadow: inset 0 0 10px rgba(0,255,255,0.1);
            overflow-y: auto;
        }

        /* Main panel for chat and actions */
        .lobby-main-panel {
            position: relative;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
            overflow: hidden;
        }
        /* Ensure overlay z-index is higher than chat but lower than other modals */
        #game-countdown-overlay, #game-voting-overlay {
            z-index: 40;
        }
        
        #player-list-container {
            margin-top: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex-grow to work in scrollable container */
        }
        .player-list-item {
            background-color: rgba(0,255,255,0.08); /* Cyan tint */
            border-radius: 10px;
            padding: 0.8rem 1rem;
            margin-bottom: 0.6rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .player-list-item.is-host {
            border-color: #A020F0; /* Purple host indicator */
            box-shadow: 0 0 10px rgba(160,32,240,0.5);
        }
        .player-list-item .player-name {
            font-weight: 600; /* Semibold */
            color: #E0E0E0;
            letter-spacing: 0.5px;
        }
        .player-list-item .host-label {
            color: #00FFFF; /* Cyan label */
            font-size: 0.9rem;
            margin-right: 0.6rem;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
        }
        .kick-player-btn {
            background: linear-gradient(135deg, #3A0A0A 0%, #5A2A2A 100%);
            border: 1px solid #FF0000; /* Red border */
            color: #FF0000;
            border-radius: 8px;
            padding: 0.3rem 0.7rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 0 5px rgba(255,0,0,0.5);
        }
        .kick-player-btn:hover {
            background: #FF0000;
            color: white;
            box-shadow: 0 0 10px rgba(255,0,0,0.7);
            text-shadow: none;
        }

        .lobby-chat-container {
            background-color: rgba(10,10,20,0.6); /* Darker, more opaque */
            border: 2px solid rgba(160,32,240,0.4); /* Purple border */
            border-radius: 12px;
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(160,32,240,0.2); /* Inner purple glow */
        }
        .lobby-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.75rem; /* For scrollbar */
            display: flex;
            flex-direction: column;
            gap: 0.6rem; /* Space between messages */
        }
        .chat-message {
            background-color: #2A2A3A; /* Dark blue-gray */
            padding: 0.6rem 1rem;
            border-radius: 12px;
            max-width: 85%; /* Wider bubbles */
            word-wrap: break-word;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            border: 1px solid rgba(0,255,255,0.1); /* Subtle border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .chat-message.current-user {
            background-color: #1A3A4A; /* Darker blue for user */
            align-self: flex-end;
            flex-direction: row-reverse;
            border-color: rgba(160,32,240,0.1); /* Subtle purple border */
        }
        .chat-message .sender-name {
            font-weight: 700; /* Bold */
            color: #00FFFF; /* Cyan name */
            display: block;
            font-size: 0.95em;
            margin-bottom: 0.1rem;
        }
        .chat-message .message-text {
            color: #E0E0E0;
            font-size: 1rem;
        }
        .chat-message .message-text-deleted {
            font-style: italic;
            color: #707080; /* Darker gray for deleted */
            font-size: 0.9rem;
        }
        .delete-message-btn {
            background: none;
            border: none;
            color: #F00000; /* Red icon */
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.3; /* Less visible when not hovered */
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .chat-message:hover .delete-message-btn {
            opacity: 0.8; /* More visible on hover */
            text-shadow: 0 0 8px rgba(255,0,0,0.7);
        }
        .delete-message-btn:hover {
            color: #FF6347; /* Lighter red on active hover */
            transform: scale(1.2);
        }

        .lobby-chat-input-form {
            margin-top: 1rem;
            display: flex;
            gap: 0.6rem;
            flex-shrink: 0;
        }
        .lobby-chat-input-form input {
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }

        .lobby-actions-footer {
            flex-shrink: 0;
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1.25rem; /* Larger gap */
        }
        .start-game-btn {
            background: linear-gradient(135deg, #103A10 0%, #206A20 100%); /* Darker green */
            border: 2px solid #00FF00; /* Bright green border */
            font-size: 1.2rem;
            padding: 0.7rem 1.4rem;
            box-shadow: 0 0 15px rgba(0,255,0,0.5);
            text-shadow: 0 0 8px rgba(0,255,0,0.7);
        }
        .start-game-btn:disabled {
            box-shadow: none;
            text-shadow: none;
        }
        #host-actions-container {
             display: flex;
             flex-wrap: wrap;
             gap: 1.25rem;
        }

        /* Custom Scrollbars - Glowing */
        ::-webkit-scrollbar { width: 10px; } /* Thicker scrollbar */
        ::-webkit-scrollbar-track { background: #0A0A15; border-radius: 5px; } /* Dark track */
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00FFFF, #A020F0); /* Cyan-Purple gradient thumb */
            border-radius: 5px;
            border: 1px solid #00FFFF; /* Subtle border */
        }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #A020F0, #00FFFF); } /* Invert colors on hover */
        
        /* ===== CORRECTED RESPONSIVE STYLES ===== */
        @media (max-width: 860px) {
            .lobby-detail-content {
                flex-direction: column;
                height: calc(100% - 100px); /* Adjust height */
                margin: 50px auto;
                padding: 1.5rem;
                overflow: hidden;
            }
            .lobby-sidebar {
                width: 100%;
                flex-shrink: 0;
                max-height: 280px; /* Increased sidebar height on mobile */
            }
            .lobby-main-panel {
                flex-grow: 1;
                min-height: 0;
            }
            .lobby-actions-footer {
                justify-content: center; /* Center buttons on small screens */
            }
            .lobby-item .join-lobby-btn,
            .lobby-item .close-lobby-btn,
            .lobby-item .view-my-lobby-btn {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
        }
        /* General Responsive */
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .futuristic-card { padding: 2rem; }
            h1 { font-size: 2.5rem; }
            h2 { font-size: 1.8rem; }
            .text-3xl { font-size: 2rem; }
            .futuristic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header { height: 70px; padding: 0.5rem 1rem;}
            .app-footer, .lobby-footer { height: 90px; padding: 0.8rem 1rem; gap: 0.8rem;}
            .main-content-area { padding-top: 70px; padding-bottom: 90px; }
            .lobby-detail-content { margin: 20px auto; height: calc(100% - 40px); padding: 1rem;}
            .lobby-sidebar { padding: 1rem; max-height: 200px; }
            .lobby-footer .icon-btn svg { width: 30px; height: 30px; }
            .lobby-footer .icon-btn { font-size: 0.8rem; }
            .lobby-footer .games-running-text { font-size: 1rem; padding: 0.4rem 0.8rem; }
            .lobby-footer .games-running-text #active-games-count { font-size: 1.3rem; }
            
            #header-user-coins-container {
                font-size: 1.1rem;
                padding: 0.3rem 0.6rem;
            }
            #header-user-coins-container .coin-icon {
                width: 1.1rem;
                height: 1.1rem;
                margin-left: 0.1rem;
            }
            .profile-modal-content { padding: 1.5rem; }
            .profile-summary svg { width: 20px; height: 20px; }
            #profile-summary { padding: 0.5rem; }
            #header-display-name { font-size: 0.9rem; }
            #header-user-id { font-size: 0.7rem; }
        }
        
        /* Lobby Type Toggle Styles - Futuristic Buttons */
        .lobby-type-btn { 
            padding: 0.6rem 1.8rem; /* More generous padding */
            border: none; /* No direct border */
            border-radius: 10px;
            transition: all 0.2s ease-in-out; 
            background: rgba(0,0,0,0.3); /* Transparent base for non-active */
            color: #00FFFF; 
            font-weight: 600; 
            box-shadow: inset 0 0 5px rgba(0,255,255,0.2);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .lobby-type-btn::before { /* Inner border glow */
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 10px;
            padding: 2px;
            background: linear-gradient(45deg, #00FFFF, #A020F0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
            opacity: 0.5;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .lobby-type-btn.active { 
            background: linear-gradient(135deg, #00CACA 0%, #00FFFF 100%); /* Bright cyan gradient for active */
            color: #0A0A10; /* Dark text on bright button */
            box-shadow: 0 0 15px rgba(0,255,255,0.6);
            text-shadow: none;
        }
        .lobby-type-btn.active::before {
             opacity: 0; /* Hide inner glow when active/filled */
        }
        .lobby-type-btn:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(0,255,255,0.5), inset 0 0 8px rgba(0,255,255,0.4);
            color: #00FFFF;
        }
        .lobby-type-btn:hover:not(.active)::before {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .lobby-lock-icon { 
            width: 1.3rem; 
            height: 1.3rem; 
            margin-left: 0.6rem; 
            color: #A020F0; /* Purple for lock */
            display: inline-block; 
            vertical-align: middle; 
            text-shadow: 0 0 5px rgba(160,32,240,0.5);
        }

        /* NEW: Countdown Animation */
        @keyframes countdown-pulse {
            0% { transform: scale(0.6) translateY(10px); opacity: 0; filter: blur(5px); }
            50% { transform: scale(1.1) translateY(0px); opacity: 1; filter: blur(0px); }
            100% { transform: scale(1) translateY(0px); opacity: 0; filter: blur(5px); }
        }
        .countdown-effect {
            animation: countdown-pulse 1s ease-out forwards;
            font-family: 'Orbitron', sans-serif; /* Digital font for countdown */
            text-shadow: 0 0 20px rgba(0,255,255,0.8), 0 0 40px rgba(160,32,240,0.6);
            color: #00FFFF;
        }

        /* NEW: Game Player Status Pods - Modular HUD elements */
        .game-player-pod {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(0,255,255,0.2); /* Cyan border */
            border-radius: 10px;
            padding: 0.75rem 1rem;
            min-width: 130px; /* Slightly wider */
            box-shadow: 0 4px 10px rgba(0,0,0,0.4), inset 0 0 8px rgba(0,255,255,0.1); /* Subtle glow */
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            font-family: 'Rajdhani', sans-serif;
            text-align: center;
        }
        .game-player-pod.is-ai {
            background-color: rgba(255, 99, 71, 0.15); /* Tomato red tint */
            border-color: #FF6347; /* Tomato */
            box-shadow: 0 4px 10px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,99,71,0.2);
        }
        .game-player-pod.is-human {
            background-color: rgba(100, 149, 237, 0.15); /* Cornflower Blue tint */
            border-color: #6495ED; /* Cornflower Blue */
            box-shadow: 0 4px 10px rgba(0,0,0,0.4), inset 0 0 8px rgba(100,149,237,0.2);
        }
        .game-player-pod.current-active-player {
            transform: scale(1.08); /* More pronounced lift */
            border-color: #A020F0; /* Purple active border */
            box-shadow: 0 0 20px rgba(160,32,240,0.8), inset 0 0 15px rgba(160,32,240,0.5); /* Stronger purple glow */
        }
        .game-player-pod .player-name {
            font-weight: 600;
            color: #E0E0E0;
            font-size: 1.15rem; /* Slightly larger */
            margin-bottom: 0.1rem;
        }
        .game-player-pod .player-role {
            font-size: 0.9rem;
            color: #00FFFF; /* Cyan for role */
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .game-player-pod .player-status {
            font-size: 0.8rem;
            color: #B0B0C0;
            margin-top: 0.2rem;
            opacity: 0.8;
        }
        .game-info-panel {
            background: rgba(0,0,0,0.6);
            border: 1px solid #A020F0;
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 0 10px rgba(160,32,240,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }
        #game-timer-display {
            font-size: 2.8rem;
            color: #00FF00; /* Green timer */
            text-shadow: 0 0 15px rgba(0,255,0,0.7);
        }
        #game-role-display {
            color: #E0E0E0;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0,255,255,0.4);
        }
        #my-role {
            color: #00FFFF;
            font-weight: 700;
        }
        #game-scores-display {
            color: #E0E0E0;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0,255,255,0.4);
        }
        #ai-score, #human-score {
            font-weight: 700;
        }
        #ai-score { color: #FF6347; } /* Tomato for AI */
        #human-score { color: #6495ED; } /* Cornflower Blue for Human */


        /* Voting Buttons */
        .voting-btn {
            padding: 1.2rem 2.5rem; /* Larger buttons */
            font-size: 1.8rem; /* Larger font */
            border-radius: 15px;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            text-shadow: 0 0 10px rgba(255,255,255,0.7);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .voting-btn::before { /* Inner glow border */
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 15px;
            padding: 3px;
            background: linear-gradient(45deg, #00FFFF, #A020F0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
            opacity: 0.7;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .voting-btn.ai-vote {
            background: linear-gradient(145deg, #5A0A0A 0%, #8A2020 100%); /* Darker red */
            color: white;
            box-shadow: 0 0 20px rgba(255,0,0,0.6);
        }
        .voting-btn.human-vote {
            background: linear-gradient(145deg, #0A0A5A 0%, #20208A 100%); /* Darker blue */
            color: white;
            box-shadow: 0 0 20px rgba(0,0,255,0.6);
        }
        .voting-btn:hover:not(:disabled) {
            transform: translateY(-8px) scale(1.08); /* More dramatic lift */
            box-shadow: 0 15px 30px rgba(0,0,0,0.8), 0 0 30px currentColor; /* Deeper shadow, color matching glow */
        }
        .voting-btn:hover:not(:disabled)::before {
            opacity: 1;
            transform: scale(1.05);
        }
        .voting-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            text-shadow: none;
        }
        .voting-btn:disabled::before {
             opacity: 0.2;
             background: linear-gradient(45deg, #555, #777);
        }

        /* Game Result Display */
        #game-result-display {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1.5px;
        }
        #winner-text {
            text-shadow: 0 0 25px currentColor;
        }
        #winner-text.text-green-500 { color: #00FF00; }
        #winner-text.text-red-500 { color: #FF0000; }
        #reason-text {
            color: #B0B0C0;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.5rem;
        }
        #return-to-lobbies-btn {
            font-size: 1.2rem;
            padding: 0.8rem 1.8rem;
        }

        /* Coin Icon for Buttons */
        .coin-icon {
            width: 1.4rem; /* Slightly larger */
            height: 1.4rem;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.3rem; /* Adjusted margin */
            fill: currentColor; /* Inherit color from parent for easier styling */
            filter: drop-shadow(0 0 5px currentColor); /* Glow effect for icon */
        }
        /* Specific override for header coins */
        #header-user-coins-container .coin-icon {
            fill: #00FFFF; /* Force cyan for header coin */
        }

        /* General icons (back button, search, profile, menu, etc.) */
        .lucide {
            color: #00FFFF; /* Cyan for all lucide icons */
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .lucide:hover {
            color: #A020F0; /* Purple on hover */
            transform: scale(1.1);
        }
        /* Override for header profile icon for consistent look with profile summary */
        #profile-summary svg {
            color: #E0E0E0; /* White/gray for user icon */
            filter: drop-shadow(0 0 3px rgba(255,255,255,0.3));
        }
        #profile-summary:hover svg {
            color: #A020F0; /* Purple on hover for user icon */
        }

    </style>
</head>
<body>

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- All Modals and other screens remain the same... -->
        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="futuristic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="email" placeholder="ایمیل شما"
                               class="w-full"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)"
                               class="w-full"
                               required>
                    </div>
                    <!-- Toggle buttons for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn"
                                class="w-full sm:w-1/2 futuristic-btn btn-blue-futuristic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"
                                class="w-full sm:w-1/2 futuristic-btn btn-green-futuristic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth-btn"
                            class="w-full mt-4 futuristic-btn btn-purple-futuristic text-xl sm:text-2xl">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info and ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                    </svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>

                <!-- Spacer to push elements to ends -->
                <div class="flex-grow"></div> 

                <!-- NEW LOCATION FOR COINS - Near the menu button (left for RTL) -->
                <div id="header-user-coins-container" class="flex items-center text-xl sm:text-2xl font-extrabold text-yellow-300">
                    <svg class="coin-icon w-6 h-6 sm:w-8 sm:h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span id="header-user-coins">---</span>
                </div>

                <!-- Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area flex flex-col justify-center items-center">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی متنی خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer flex justify-center items-center gap-4">
                <button id="friendly-game-btn"
                        class="futuristic-btn btn-purple-futuristic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                        <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span>بازی دوستانه (<span id="friendly-game-cost">100</span>)</span>
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="futuristic-btn btn-brown-futuristic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                    بازی امتیازی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
                            <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                        </svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Profile Modal (Hidden by default) -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="futuristic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div class="text-lg space-y-4 mb-8 text-white">
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                    <p><strong>سکه‌ها:</strong> <span id="profile-coins" class="font-bold text-yellow-300">---</span></p>
                    <!-- Add more profile stats here later (e.g., wins, losses) -->
                </div>
                <button id="profile-logout-btn"
                        class="w-full futuristic-btn btn-red-futuristic text-lg sm:text-xl">
                    خروج از حساب
                </button>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="futuristic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative overflow-y-auto custom-scrollbar">
                <h2 id="create-lobby-modal-title" class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">

                    <!-- NEW: Lobby Name Selection/Proposal Area -->
                    <div id="lobby-name-selection-area" class="hidden">
                        <label for="approved-lobby-names-select" class="block text-right text-sm text-gray-300 mb-1">نام لابی تأیید شده خود را انتخاب کنید:</label>
                        <select id="approved-lobby-names-select" class="w-full">
                            <!-- Options will be dynamically loaded here -->
                            <option value="">نام لابی را انتخاب کنید</option>
                        </select>
                    </div>

                    <div id="lobby-name-proposal-area" class="hidden">
                        <label for="proposed-lobby-name-input" class="block text-right text-sm text-gray-300 mb-1">نام لابی جدید را برای تأیید ارسال کنید (می‌توانید از کد رنگی [#RRGGBB] در ابتدای نام استفاده کنید):</label>
                        <input type="text" id="proposed-lobby-name-input" placeholder="مثال: [#00FFFF]لابی دیجیتالی من"
                               class="w-full">
                        <button type="button" id="submit-lobby-name-for-approval-btn"
                                class="w-full mt-4 futuristic-btn btn-blue-futuristic text-lg sm:text-xl">
                            ارسال برای تأیید
                        </button>
                        <p class="text-gray-400 text-sm mt-2" id="lobby-proposal-message">بعد از ارسال، ادمین نام لابی شما را بررسی و تأیید می‌کند. سپس می‌توانید از آن نام استفاده کنید.</p>
                    </div>
                    
                    <!-- NEW: Pending Lobby Names Area -->
                    <div id="pending-lobby-names-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold text-gray-300 mb-2">نام‌های لابی در انتظار تأیید شما:</h3>
                        <div id="pending-lobby-names-list" class="space-y-2 text-right text-gray-400 max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Pending names will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی در انتظار تایید ندارید.</p>
                        </div>
                    </div>

                    <!-- NEW: Approved Lobby Names Management Area -->
                    <div id="approved-lobby-names-management-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold text-gray-300 mb-2">نام‌های لابی تأیید شده شما:</h3>
                        <div id="approved-lobby-names-management-list" class="space-y-2 text-right text-gray-400 max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Approved names with delete buttons will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>
                        </div>
                    </div>

                    <div class="w-full h-px bg-purple-600 my-4 shadow-md shadow-purple-900"></div> <!-- Divider -->

                    <!-- NEW: Lobby Type Toggle (Public/Private) -->
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="public" class="sr-only" checked>
                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
                    </div>
        
                    <!-- NEW: Password field for private lobbies (initially hidden) -->
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)"
                               class="w-full pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 4 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
                    
                    <!-- NEW: Game Duration Input -->
                    <div>
                        <label for="game-duration-input" class="block text-right text-sm text-gray-300 mb-1">مدت زمان بازی (دقیقه):</label>
                        <input type="number" id="game-duration-input" value="5" min="1" max="60"
                               class="w-full text-center"
                               required>
                    </div>

                    <button type="submit" id="submit-create-lobby-btn"
                            class="w-full mt-4 futuristic-btn btn-green-futuristic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="futuristic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 futuristic-btn btn-red-futuristic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 futuristic-btn btn-gray-futuristic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED for Text-Based Game) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                
                <!-- Sidebar: Lobby Info & Players -->
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    
                    <div class="w-full h-px bg-purple-600 mb-4 shadow-md shadow-purple-900"></div>

                    <!-- Player List / Status Display (moved here for game view) -->
                    <div id="game-player-status" class="flex flex-wrap justify-center gap-2 p-2 bg-gray-800 rounded-lg mb-4 shadow-inner">
                        <!-- Player status pods will be injected here -->
                    </div>

                    <div id="player-list-container" class="flex-grow min-h-0 overflow-y-auto">
                        <!-- Player list items will be dynamically loaded here (for non-game state) -->
                    </div>
                </div>

                <!-- Main Panel: Chat & Actions (Now contains game elements) -->
                <div class="lobby-main-panel">

                    <!-- Game Header for inside the lobby chat -->
                    <div id="game-info-panel" class="bg-gray-800 bg-opacity-70 rounded-lg p-3 mb-4 flex justify-between items-center shadow-md border border-yellow-600 hidden">
                        <div class="flex items-center space-x-4 space-x-reverse text-white text-lg font-bold">
                            <span id="game-timer-display" class="text-3xl text-green-400 font-extrabold mr-4 hidden">--:--</span>
                            <div id="game-role-display" class="text-xl text-yellow-300 hidden">نقش: <span id="my-role">---</span></div>
                            <div id="game-scores-display" class="text-xl text-blue-300 hidden">
                                <span id="ai-score">AI: 0</span> | <span id="human-score">Human: 0</span>
                            </div>
                        </div>
                        <button id="leave-game-from-lobby-btn" class="futuristic-btn btn-red-futuristic text-sm py-2 px-4 hidden">ترک بازی</button>
                    </div>

                    <!-- Countdown Overlay (now relative to lobby-main-panel) -->
                    <div id="game-countdown-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                        <div class="text-7xl font-extrabold text-yellow-400 countdown-effect" style="opacity:0; transform: scale(0.5);"></div>
                        <p class="text-2xl text-white mt-4">بازی در حال شروع است...</p>
                    </div>

                    <!-- Game Chat Container (Reusing lobby chat styles) -->
                    <div class="lobby-chat-container flex-grow min-h-0">
                        <div id="lobby-chat-messages" class="lobby-chat-messages">
                            <!-- Game messages and events will appear here -->
                        </div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form flex-shrink-0">
                            <input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="futuristic-btn btn-blue-futuristic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>

                    <!-- Voting/Game End Overlay (now relative to lobby-main-panel) -->
                    <div id="game-voting-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                        <h2 class="text-4xl font-bold text-yellow-400 mb-6" id="voting-title">رای‌گیری آغاز شد!</h2>
                        <p class="text-xl text-white mb-8" id="voting-instructions">برای چه کسی رای می‌دهید؟</p>
                        <div id="voting-options" class="flex flex-wrap justify-center gap-4">
                            <!-- Voting buttons will be injected here -->
                        </div>
                        <div id="game-result-display" class="hidden text-center mt-10">
                            <h2 class="text-5xl font-extrabold text-green-500 mb-4" id="winner-text"></h2>
                            <p class="text-2xl text-white" id="reason-text"></p>
                            <button id="return-to-lobbies-btn" class="futuristic-btn btn-blue-futuristic mt-8 py-3 px-6">بازگشت به لابی‌ها</button>
                        </div>
                    </div>

                    <!-- Action Buttons Footer -->
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style="display: none;">
                            <button id="start-game-btn" class="futuristic-btn start-game-btn" disabled>
                                شروع بازی
                            </button>
                             <button id="toggle-chat-lock-btn" class="futuristic-btn btn-gray-futuristic text-sm py-2 px-4">
                                قفل کردن چت
                            </button>
                            <button id="view-kicked-players-btn" class="futuristic-btn btn-brown-futuristic text-sm py-2 px-4">
                                لیست اخراجی‌ها
                            </button>
                        </div>
                        <!-- Leave Lobby Button (now only for host to close lobby outside of game) -->
                        <button id="leave-lobby-btn" class="futuristic-btn btn-red-futuristic text-sm py-2 px-4 hidden">
                            بستن لابی
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ... All other modals (kick, kicked message, etc.) remain the same ... -->
        <!-- 10. Kick Player Confirmation Modal -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="futuristic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">اخراج بازیکن</h2>
                <button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <p class="text-lg mb-8 text-white">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="kick-player-confirm-btn" class="w-1/2 futuristic-btn btn-red-futuristic">اخراج کردن</button>
                    <button id="cancel-kick-player-btn" class="w-1/2 futuristic-btn btn-gray-futuristic">انصراف</button>
                </div>
            </div>
        </div>

        <!-- 11. Kicked Message Modal -->
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="futuristic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-400">شما اخراج شدید!</h2>
                <p id="kicked-message-text" class="text-lg mb-8 text-white">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p>
                <button id="kicked-message-ok-btn" class="w-full futuristic-btn btn-blue-futuristic">متوجه شدم</button>
            </div>
        </div>

        <!-- 12. Kicked Players List Modal -->
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="futuristic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">لیست بازیکنان اخراج شده</h2>
                <button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div id="kicked-players-list-content" class="space-y-4 mb-8 text-white text-left max-h-60 overflow-y-auto custom-scrollbar">
                    <!-- Kicked players will be dynamically loaded here -->
                    <p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p>
                </div>
                <button id="kicked-list-ok-btn" class="w-full futuristic-btn btn-gray-futuristic">بستن</button>
            </div>
        </div>
        
        <!-- 13. Enter Password Modal (for private lobbies) -->
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="futuristic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2>
                <p class="text-lg mb-6 text-white">لابی <span id="password-prompt-lobby-name" class="font-bold text-yellow-300"></span> نیاز به رمز عبور دارد.</p>
                <form id="enter-password-form" class="space-y-5">
                    <div>
                        <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید"
                               class="w-full text-center"
                               required>
                    </div>
                    <div class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 futuristic-btn btn-green-futuristic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 futuristic-btn btn-gray-futuristic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // REVISED: Imported writeBatch for atomic updates
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Firebase Configuration (from user's input)
        // **IMPORTANT**: You should replace these with your actual Firebase project configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4", // Replace with your Firebase project API Key
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase context (as per environment instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global AI API Key for Content Moderation (FOR DEMONSTRATION ONLY - INSECURE FOR PRODUCTION)
        // **WARNING**: Hardcoding API keys in client-side code is a SECURITY VULNERABILITY.
        // For production, this should be moved to a secure backend (e.g., Firebase Cloud Functions).
        // You can get a Gemini API key from Google AI Studio: https://makersuite.google.com/
        // Ensure you enable the Gemini API in your Google Cloud Project.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // <<< REPLACE THIS WITH YOUR OWN GEMINI API KEY

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const headerUserCoins = document.getElementById('header-user-coins'); // NEW (Updated for new location)
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const friendlyGameCostSpan = document.getElementById('friendly-game-cost'); // NEW
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen UI Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn'); // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Profile Modal Elements
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileCoins = document.getElementById('profile-coins'); // NEW
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        // Create Lobby Modal Elements
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field'); // Corrected ID
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');
        const gameDurationInput = document.getElementById('game-duration-input'); // NEW
        const createLobbyModalTitle = document.getElementById('create-lobby-modal-title'); // NEW: Added ID to H2

        // NEW: Lobby Name Selection/Proposal specific elements
        const lobbyNameSelectionArea = document.getElementById('lobby-name-selection-area');
        const approvedLobbyNamesSelect = document.getElementById('approved-lobby-names-select');
        const lobbyNameProposalArea = document.getElementById('lobby-name-proposal-area');
        const proposedLobbyNameInput = document.getElementById('proposed-lobby-name-input');
        const submitLobbyNameForApprovalBtn = document.getElementById('submit-lobby-name-for-approval-btn');
        const lobbyProposalMessage = document.getElementById('lobby-proposal-message'); // NEW for message about pending requests

        // NEW: Pending Lobby Names Area (for display of names waiting for admin approval)
        const pendingLobbyNamesArea = document.getElementById('pending-lobby-names-area');
        const pendingLobbyNamesList = document.getElementById('pending-lobby-names-list');

        // NEW: Approved Lobby Names Management Area (for deletion)
        const approvedLobbyNamesManagementArea = document.getElementById('approved-lobby-names-management-area');
        const approvedLobbyNamesManagementList = document.getElementById('approved-lobby-names-management-list');


        // Custom Confirmation Modal Elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // Lobby Detail Screen Elements (UPDATED)
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const toggleChatLockBtn = document.getElementById('toggle-chat-lock-btn');
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn'); // Host-only to close lobby outside of game
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChatSendBtn = document.getElementById('lobby-chat-send-btn');

        // Game specific UI elements within Lobby Detail Screen (NEW)
        const gameInfoPanel = document.getElementById('game-info-panel');
        const gameTimerDisplay = document.getElementById('game-timer-display');
        const gameRoleDisplay = document.getElementById('game-role-display');
        const myRole = document.getElementById('my-role');
        const gameScoresDisplay = document.getElementById('game-scores-display');
        const aiScore = document.getElementById('ai-score');
        const humanScore = document.getElementById('human-score');
        const leaveGameFromLobbyBtn = document.getElementById('leave-game-from-lobby-btn'); // Player-initiated leave during game
        const gamePlayerStatus = document.getElementById('game-player-status');
        const gameCountdownOverlay = document.getElementById('game-countdown-overlay');
        const countdownNumber = gameCountdownOverlay.querySelector('.countdown-effect');
        const gameVotingOverlay = document.getElementById('game-voting-overlay');
        const votingTitle = document.getElementById('voting-title');
        const votingInstructions = document.getElementById('voting-instructions');
        const votingOptions = document.getElementById('voting-options');
        const gameResultDisplay = document.getElementById('game-result-display');
        const winnerText = document.getElementById('winner-text'); 
        const reasonText = document.getElementById('reason-text');
        const returnToLobbiesBtn = document.getElementById('return-to-lobbies-btn');


        // Kick Player Confirmation Modal Elements
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-btn');
        const kickPlayerConfirmName = document.getElementById('kick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');

        // Kicked Message Modal Elements
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedMessageText = document.getElementById('kicked-message-text');
        const kickedLobbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');

        // Kicked Players List Modal Elements
        const kickedPlayersListModal = document.getElementById('kicked-players-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        const kickedPlayersListContent = document.getElementById('kicked-players-list-content');
        const kickedListOkBtn = document.getElementById('kicked-list-ok-btn');
        
        // New Enter Password Modal Elements
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // State variables
        let authMode = 'login'; // Default mode is login
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; // To store user's profile data
        let unsubscribeLobbies = null; // Global variable to store the unsubscribe function for lobby list listener
        let unsubscribeLobbyDetail = null; // Global variable for single lobby detail listener
        let unsubscribeKickedPlayers = null; // Listener for kicked players list
        let unsubscribeLobbyChat = null; // NEW: Listener for lobby chat messages
        let unsubscribeUserProfile = null; // NEW: Listener for real-time user profile updates
        let unsubscribePendingLobbyNames = null; // NEW: Listener for pending lobby names
        let unsubscribeGameSettings = null; // NEW: Listener for real-time game settings
        let isInitialAuthCheckComplete = false; // Flag to ensure initial loading screen transition happens only once
        let userHasActiveLobby = false; // Track if the current user has an active lobby (created or joined)
        let currentLobbyId = null; // Stores the ID of the lobby the current user is in
        let kickedPlayerToProcess = null; // Stores UID/name of player selected for kicking
        let lobbyToJoin = null; // To store data of private lobby user wants to join
        let isRefreshing = false; // NEW: State for refresh button
        let gameEntryCost = 100; // NEW: Default game entry cost, will be fetched from Firebase

        // Promise resolver for custom confirmation modal
        let resolveCustomConfirm;

        // Global timer variables for game
        let gameCountdownInterval = null;
        let gameTimerInterval = null;
        
        // NEW: Max pending proposals limit
        const MAX_PENDING_PROPOSALS = 5;

        // Function to clear all game-related intervals
        function clearGameIntervals() {
            if (gameCountdownInterval) {
                clearInterval(gameCountdownInterval);
                gameCountdownInterval = null;
            }
            if (gameTimerInterval) {
                clearInterval(gameTimerInterval);
                gameTimerInterval = null;
            }
        }

        // Function to reset game UI elements
        function resetGameUI() {
            gameInfoPanel.classList.add('hidden');
            gameTimerDisplay.classList.add('hidden');
            gameRoleDisplay.classList.add('hidden');
            myRole.textContent = '---'; // Reset role display
            gameScoresDisplay.classList.add('hidden');
            leaveGameFromLobbyBtn.classList.add('hidden');
            gamePlayerStatus.innerHTML = ''; // Clear player pods
            gameCountdownOverlay.classList.add('hidden');
            gameVotingOverlay.classList.add('hidden');
            gameResultDisplay.classList.add('hidden');
            votingOptions.innerHTML = '';
            votingOptions.classList.remove('hidden'); // Ensure it's not hidden for next game
            votingTitle.classList.remove('hidden'); // Ensure it's not hidden
            votingInstructions.classList.remove('hidden'); // Ensure it's not hidden
            
            lobbyChatInput.disabled = false;
            lobbyChatSendBtn.disabled = false;
            lobbyChatInput.placeholder = "پیام خود را بنویسید...";
            lobbyChatInput.value = ''; // Clear any previous input

            // Ensure all overlays are hidden (explicitly display: none for immediate effect if needed)
            gameCountdownOverlay.style.display = 'none';
            gameVotingOverlay.style.display = 'none';
        }


        // Function to show custom message box (re-used for auth and create lobby modals)
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            console.log(`پیام نمایش داده شد (${type}): ${message}`);
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        // Wrapper for main message box
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        // Wrapper for create lobby message box
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);


        // Function to show custom confirmation modal
        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                void customConfirmModal.offsetWidth; // Trigger reflow for transition
                customConfirmModal.classList.add('profile-modal-enter-active');

                resolveCustomConfirm = resolve; // Store the resolve function

                // Event listeners for Yes/No buttons
                confirmYesBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(true);
                };
                confirmNoBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(false);
                };
            });
        }

        // Function to close the custom confirmation modal
        function closeCustomConfirm() {
            customConfirmModal.classList.remove('profile-modal-enter-active');
            customConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                customConfirmModal.classList.add('hidden');
                customConfirmModal.classList.remove('profile-modal-leave-active');
            }, 300); // Match modal transition duration
        }

        /**
         * Calls a simulated AI content moderation API to check if the lobby name is appropriate.
         * @param {string} lobbyName - The name of the lobby to check.
         * @returns {Promise<{is_appropriate: boolean, reason: string}>} - The moderation result.
         */
        async function checkLobbyNameWithAI(lobbyName) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                console.warn("Gemini API Key is not configured. Skipping lobby name moderation. Please replace 'YOUR_GEMINI_API_KEY_HERE' with your actual key.");
                return { is_appropriate: true, reason: "API key missing. Moderation skipped." };
            }

            const prompt = `As a highly rigorous and professional content moderation AI, meticulously analyze the following lobby name for compliance with the strictest community guidelines across *all* languages. You must absolutely identify and disallow any political, racist, sexual, offensive, vulgar, violent, or otherwise inappropriate content, including but not limited to terms like "fuck", "asshole", "shit", "bitch", and their equivalents in Persian such as "کیر", "کون", "کس", "کسکش", "جنده", "حرومزاده", "بیناموس" etc., regardless of how they are spelled (e.g., phonetic or deliberate misspellings to evade detection). Your analysis should consider the context and intent where possible. Your response *must* be a JSON object: {"is_appropriate": boolean, "reason": string}. If 'is_appropriate' is false, provide a *brief, objective, and precise* reason identifying the specific type of violation (e.g., "Contains offensive language", "Political reference detected", "Violates decency standards"). If appropriate, 'reason' should be an empty string. Lobby name to analyze: "${lobbyName}"`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "is_appropriate": { "type": "BOOLEAN" }, "reason": { "type": "STRING" } }, "propertyOrdering": ["is_appropriate", "reason"] } } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorText = await response.text(); console.error("AI API HTTP Error:", response.status, response.statusText, errorText); return { is_appropriate: false, reason: `خطا در ارتباط با سرور اعتدال: ${response.statusText}.` }; }
                const result = await response.json();
                if (result && result.candidates?.[0]?.content?.parts?.[0]) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try { const parsedJson = JSON.parse(jsonString); if (typeof parsedJson.is_appropriate === 'boolean' && typeof parsedJson.reason === 'string') { return parsedJson; } else { console.warn("AI response has unexpected structure:", parsedJson); return { is_appropriate: false, reason: "پاسخ سیستم اعتدال نامفهوم است." }; } } catch (parseError) { console.error("Error parsing AI response JSON:", parseError, "Raw:", jsonString); return { is_appropriate: false, reason: "خطا در پردازش پاسخ اعتدال." }; }
                } else { console.warn("AI response missing content structure:", result); return { is_appropriate: false, reason: "عدم دریافت پاسخ معتبر از سیستم اعتدال." }; }
            } catch (error) { console.error("Error calling AI moderation API:", error); return { is_appropriate: false, reason: `خطا در ارتباط با سیستم اعتدال: ${error.message}.` }; }
        }

        // Function to check if a message is "literary/AI-like" using Gemini AI
        async function checkMessageForLiteraryAIStyle(message) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                console.warn("Gemini API Key is not configured. Skipping chat style moderation. Please replace 'YOUR_GEMINI_API_KEY_HERE' with your actual key.");
                return { is_literary: true, reason: "API key missing. Moderation skipped." };
            }

            const prompt = `As a highly sophisticated and discerning AI language analyst, you are to evaluate the provided Persian text for its adherence to a "literary" or "AI-like" style. This implies:
            1.  **Formality and Politeness:** The language should be formal, respectful, and free of slang, colloquialisms, expletives, or overly casual expressions.
            2.  **Clarity and Precision:** The message should be well-structured and convey meaning clearly, avoiding ambiguity.
            3.  **Sophistication in Vocabulary/Grammar:** While not overly complex, the vocabulary should lean towards a more elevated or precise tone, and grammar should be impeccable.
            4.  **Absence of Emojis/Informal Punctuation:** No emojis, excessive exclamation marks, or textspeak.
            
            You must decide if the message *strictly* follows these guidelines. Your response *must* be a JSON object: {"is_literary": boolean, "reason": string}.
            If 'is_literary' is false, provide a *brief and objective* reason for rejection, e.g., "Contains slang," "Informal tone," "Includes emoji," "Grammar error detected." If true, 'reason' should be an empty string.

            Persian Message to analyze: "${message}"`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { 
                contents: chatHistory, 
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            "is_literary": { "type": "BOOLEAN" }, 
                            "reason": { "type": "STRING" } 
                        }, 
                        "propertyOrdering": ["is_literary", "reason"] 
                    } 
                } 
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`; // Using 1.5-flash for speed/cost

            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) { 
                    const errorText = await response.text();
                    console.error("AI API HTTP Error:", response.status, response.statusText, errorText);
                    return { is_literary: false, reason: `خطا در ارتباط با سرور هوش مصنوعی: ${response.statusText}.` }; 
                }

                const result = await response.json();
                
                if (result && result.candidates?.[0]?.content?.parts?.[0]) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try { 
                        const parsedJson = JSON.parse(jsonString); 
                        if (typeof parsedJson.is_literary === 'boolean' && typeof parsedJson.reason === 'string') { 
                            return parsedJson; 
                        } else { 
                            console.warn("AI response has unexpected structure:", parsedJson); 
                            return { is_literary: false, reason: "پاسخ سیستم بررسی نامفهوم است." }; 
                        } 
                    } catch (parseError) { 
                        console.error("Error parsing AI response JSON:", parseError, "Raw:", jsonString); 
                        return { is_literary: false, reason: "خطا در پردازش پاسخ سیستم بررسی." }; 
                    }
                } else { 
                    console.warn("AI response missing content structure:", result); 
                    return { is_literary: false, reason: "عدم دریافت پاسخ معتبر از سیستم بررسی." }; 
                }
            } catch (error) { 
                console.error("Error calling AI chat style API:", error); 
                return { is_literary: false, reason: `خطا در ارتباط با سیستم بررسی: ${error.message}.` }; 
            }
        }

        // Function to apply color to lobby names
        function formatLobbyNameWithColor(name) {
            const regex = /^\[#([0-9A-Fa-f]{6})\](.*)/; // Matches [#RRGGBB] at the start
            const match = name.match(regex);
            if (match) {
                const colorCode = match[1];
                const cleanName = match[2].trim();
                return `<span style="color:#${colorCode};">${cleanName}</span>`;
            }
            return name;
        }


        // Function to transition between screens
        function setActiveScreen(newScreen) {
            console.log(`درخواست تغییر صفحه به: ${newScreen.id}. صفحه فعلی: ${currentActiveScreen.id}`);

            if (currentActiveScreen === newScreen) return;
            
            // Cleanup old listeners and game intervals when changing screens
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            clearGameIntervals();
            resetGameUI();


            // Hide the current screen with transition
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            currentActiveScreen.setAttribute('tabindex', '-1'); // Remove focus capability
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }

            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');

                // Show the new screen with transition
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                newScreen.removeAttribute('tabindex');
                console.log(`صفحه ${newScreen.id} اکنون قابل مشاهده است.`);

                if (newScreen === authScreen) {
                    initializeAuthScreen(); // Ensure auth UI is reset and focused
                }
                else if (newScreen === lobbyScreen) lobbySearchInput.focus();

                currentActiveScreen = newScreen;

            }, 600); // Matches CSS transition duration
        }

        // Functions to open/close modals
        function openProfileModal() {
            profileModal.classList.remove('hidden');
            void profileModal.offsetWidth;
            profileModal.classList.add('profile-modal-enter-active');
            if (currentUserData) {
                profileDisplayName.textContent = currentUserData.displayName || 'ناشناس';
                profileEmail.textContent = currentUserData.email || 'ناشناس';
                profileUid.textContent = currentUserData.uid || 'ناشناس';
                profileCoins.textContent = currentUserData.coins !== undefined ? currentUserData.coins.toLocaleString('fa-IR') : '---'; // NEW
            }
        }

        function closeProfileModal() {
            profileModal.classList.remove('profile-modal-enter-active');
            profileModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                profileModal.classList.add('hidden');
                profileModal.classList.remove('profile-modal-leave-active');
            }, 300);
        }

        /**
         * Checks for lobby name proposals marked as "approved" by an admin,
         * adds them to the user's profile, and updates the proposal status to "processed".
         * This function acts as the missing link between admin approval and user data.
         * NOTE: In a production environment, this is ideally handled by a Cloud Function for reliability.
         */
        async function processNewlyApprovedLobbyNames() {
            if (!auth.currentUser) return;

            const proposedLobbyNamesRef = collection(db, `artifacts/${appId}/proposedLobbyNames`);
            const qApproved = query(
                proposedLobbyNamesRef,
                where("userId", "==", auth.currentUser.uid),
                where("status", "==", "approved") // Find names marked as "approved"
            );

            try {
                const approvedSnapshot = await getDocs(qApproved);
                if (approvedSnapshot.empty) {
                    // No new approvals to process
                    return;
                }

                const namesToAdd = [];
                const docsToUpdate = [];
                approvedSnapshot.forEach(doc => {
                    namesToAdd.push(doc.data().name);
                    docsToUpdate.push(doc.ref);
                });

                // Use a batch write for atomicity: update user profile AND proposal status together
                const batch = writeBatch(db);
                
                // 1. Update the user's profile with the new names
                const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                batch.update(userProfileRef, {
                    approvedLobbyNames: arrayUnion(...namesToAdd)
                });

                // 2. Update each proposal's status to "processed" to prevent re-processing
                docsToUpdate.forEach(docRef => {
                    batch.update(docRef, { status: "processed" });
                });

                // 3. Commit all changes
                await batch.commit();
                console.log(`Processed ${namesToAdd.length} newly approved lobby names for the user.`);
                // The onSnapshot listener on the user's profile will automatically pick up this change
                // and update currentUserData, triggering UI updates.

            } catch (error) {
                console.error("Error processing newly approved lobby names:", error);
                // We can show a message, but it's a background process, so console log is sufficient
            }
        }

        // NEW: Function to render the list of approved lobby names for management (deletion)
        function renderApprovedLobbyNamesManagementList() {
            if (!currentUserData || !currentUserData.approvedLobbyNames) {
                approvedLobbyNamesManagementList.innerHTML = '<p class="text-sm text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>';
                approvedLobbyNamesManagementArea.classList.add('hidden');
                return;
            }

            const approvedNames = currentUserData.approvedLobbyNames;
            approvedLobbyNamesManagementList.innerHTML = ''; // Clear existing list

            if (approvedNames.length === 0) {
                approvedLobbyNamesManagementList.innerHTML = '<p class="text-sm text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>';
                approvedLobbyNamesManagementArea.classList.add('hidden');
            } else {
                approvedLobbyNamesManagementArea.classList.remove('hidden');
                approvedNames.forEach(name => {
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg mb-1';
                    nameDiv.innerHTML = `
                        <span>${formatLobbyNameWithColor(name)}</span>
                        <button type="button" class="futuristic-btn btn-red-futuristic text-sm py-1 px-3 delete-approved-lobby-name-btn" data-name="${name}">
                            حذف
                        </button>
                    `;
                    approvedLobbyNamesManagementList.appendChild(nameDiv);
                });

                approvedLobbyNamesManagementList.querySelectorAll('.delete-approved-lobby-name-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const nameToDelete = e.target.dataset.name;
                        const confirmed = await showCustomConfirm(`آیا مطمئن هستید که می‌خواهید نام لابی "${nameToDelete}" را حذف کنید؟`, "حذف نام لابی");
                        if (confirmed) {
                            await deleteApprovedLobbyName(nameToDelete);
                        }
                    });
                });
            }
        }

        // NEW: Function to delete an approved lobby name from user's profile
        async function deleteApprovedLobbyName(nameToDelete) {
            if (!auth.currentUser || !currentUserData) {
                showCreateLobbyMessageBox("خطا: اطلاعات کاربری در دسترس نیست.", "error");
                return;
            }

            const userProfileRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
            try {
                await updateDoc(userProfileRef, {
                    approvedLobbyNames: arrayRemove(nameToDelete)
                });
                showCreateLobbyMessageBox(`نام لابی "${nameToDelete}" با موفقیت حذف شد.`, "success");
                // The onSnapshot for user profile will re-trigger and update UI.
            } catch (error) {
                console.error("Error deleting approved lobby name:", error);
                showCreateLobbyMessageBox(`خطا در حذف نام لابی: ${error.message}`, "error");
            }
        }


        // NEW: Function to update the UI of the Create Lobby modal based on mode and user data
        async function updateCreateLobbyModalUI(mode) {
            // Clear any previous pending names listener from a prior modal opening
            if (unsubscribePendingLobbyNames) {
                unsubscribePendingLobbyNames();
                unsubscribePendingLobbyNames = null;
            }

            if (!auth.currentUser || !currentUserData) {
                // Initial state if user data isn't loaded yet
                approvedLobbyNamesSelect.innerHTML = '<option value="">در حال بارگذاری اطلاعات...</option>';
                lobbyNameSelectionArea.classList.add('hidden');
                lobbyNameProposalArea.classList.add('hidden');
                pendingLobbyNamesArea.classList.add('hidden');
                approvedLobbyNamesManagementArea.classList.add('hidden'); // Also hide management area
                submitCreateLobbyBtn.classList.add('hidden'); // Hide create button too
                submitLobbyNameForApprovalBtn.classList.add('hidden');
                return;
            }

            const approvedNames = currentUserData.approvedLobbyNames || [];
            
            // Clear existing options for the dropdown
            approvedLobbyNamesSelect.innerHTML = '<option value="">نام لابی را انتخاب کنید</option>';
            
            // Populate dropdown if approved names exist
            if (approvedNames.length > 0) {
                approvedNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.innerHTML = formatLobbyNameWithColor(name);
                    approvedLobbyNamesSelect.appendChild(option);
                });
                lobbyNameSelectionArea.classList.remove('hidden'); // Show the dropdown
                submitCreateLobbyBtn.disabled = true; // Still disabled until selection
                submitCreateLobbyBtn.classList.remove('hidden'); // Make sure create button is visible
            } else {
                lobbyNameSelectionArea.classList.add('hidden'); // Hide the dropdown if no approved names
                submitCreateLobbyBtn.disabled = true;
                submitCreateLobbyBtn.classList.add('hidden'); // Hide create button if no approved names
            }

            // Manage visibility based on mode
            if (mode === 'create') {
                createLobbyModalTitle.textContent = 'ساخت لابی جدید';
                lobbyNameProposalArea.classList.remove('hidden'); // Always show proposal area in create mode
                submitLobbyNameForApprovalBtn.classList.remove('hidden'); // Always show its button
            } else { // mode === 'myLobbies'
                createLobbyModalTitle.textContent = 'مدیریت نام‌های لابی و ساخت لابی'; // More accurate title
                lobbyNameProposalArea.classList.add('hidden'); // Hide proposal area in myLobbies mode
                submitLobbyNameForApprovalBtn.classList.add('hidden'); // Hide its button
            }

            // Render and manage approved names list for deletion (visible in both modes)
            renderApprovedLobbyNamesManagementList();

            // Set up listener for PENDING requests for the current user
            const proposedLobbyNamesRef = collection(db, `artifacts/${appId}/proposedLobbyNames`);
            const qPending = query(
                proposedLobbyNamesRef,
                where("userId", "==", auth.currentUser.uid),
                where("status", "==", "pending")
            );

            unsubscribePendingLobbyNames = onSnapshot(qPending, (snapshot) => {
                pendingLobbyNamesList.innerHTML = ''; // Clear existing list
                const pendingCount = snapshot.size;
                if (pendingCount === 0) {
                    pendingLobbyNamesList.innerHTML = '<p class="text-sm text-center">هیچ نام لابی در انتظار تایید ندارید.</p>';
                    pendingLobbyNamesArea.classList.add('hidden');
                } else {
                    pendingLobbyNamesArea.classList.remove('hidden');
                    snapshot.forEach(doc => {
                        const proposal = doc.data();
                        const proposalDiv = document.createElement('div');
                        proposalDiv.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg mb-1';
                        proposalDiv.innerHTML = `<span>${formatLobbyNameWithColor(proposal.name)}</span><span class="text-yellow-400 text-sm">در حال تایید...</span>`;
                        pendingLobbyNamesList.appendChild(proposalDiv);
                    });
                }

                // Control proposal input based on pending limit (only for 'create' mode)
                if (mode === 'create') {
                    if (pendingCount >= MAX_PENDING_PROPOSALS) {
                        lobbyProposalMessage.textContent = `شما ${pendingCount} درخواست نام لابی در انتظار تایید دارید. تا زمانی که درخواست‌های شما بررسی نشوند، نمی‌توانید درخواست جدیدی ارسال کنید.`;
                        lobbyProposalMessage.classList.remove('text-gray-400');
                        lobbyProposalMessage.classList.add('text-red-400');
                        submitLobbyNameForApprovalBtn.disabled = true;
                        proposedLobbyNameInput.disabled = true;
                        proposedLobbyNameInput.placeholder = "تعداد درخواست‌های شما به حداکثر رسیده است.";
                    } else {
                        lobbyProposalMessage.textContent = "بعد از ارسال، ادمین نام لابی شما را بررسی و تأیید می‌کند. سپس می‌توانید از آن نام استفاده کنید.";
                        lobbyProposalMessage.classList.remove('text-red-400');
                        lobbyProposalMessage.classList.add('text-gray-400');
                        submitLobbyNameForApprovalBtn.disabled = false;
                        proposedLobbyNameInput.disabled = false;
                        proposedLobbyNameInput.placeholder = "مثال: [#00FFFF]لابی دیجیتالی من";
                    }
                }
            }, (error) => {
                console.error("Error listening to pending lobby names:", error);
                pendingLobbyNamesList.innerHTML = `<p class="text-red-400 text-center">خطا در بارگذاری درخواست‌های شما.</p>`;
            });

            proposedLobbyNameInput.value = ''; // Clear proposed input field
            if (mode === 'create' && approvedNames.length === 0) {
                proposedLobbyNameInput.focus();
            } else if (approvedNames.length > 0) {
                 approvedLobbyNamesSelect.focus();
            }
        }


        async function openCreateLobbyModal(mode = 'create') {
            if (!auth.currentUser || !currentUserData) {
                showCreateLobbyMessageBox("ابتدا وارد حساب کاربری خود شوید.", "error");
                return;
            }

            await processNewlyApprovedLobbyNames();
            
            // Check if the user is already a host of an active lobby (only relevant for 'create' mode)
            if (userHasActiveLobby && currentLobbyId && mode === 'create') {
                try {
                    const activeLobbyRef = doc(db, `global_lobbies`, currentLobbyId);
                    const activeLobbySnap = await getDoc(activeLobbyRef);
                    if (activeLobbySnap.exists() && activeLobbySnap.data().hostId === auth.currentUser.uid && activeLobbySnap.data().status !== 'ended') {
                        showCreateLobbyMessageBox("شما از قبل یک لابی فعال ساخته‌اید. برای مدیریت آن به صفحه لابی برگردید.", "info");
                        closeCreateLobbyModal();
                        return;
                    } else if (activeLobbySnap.exists() && activeLobbySnap.data().status === 'ended' && activeLobbySnap.data().hostId === auth.currentUser.uid) {
                        userHasActiveLobby = false;
                        currentLobbyId = null;
                    }
                } catch (error) {
                    console.error("Error checking active lobby for host:", error);
                }
            }

            createLobbyModal.classList.remove('hidden');
            void createLobbyModal.offsetWidth;
            createLobbyModal.classList.add('profile-modal-enter-active');
            createLobbyMessageBox.classList.add('hidden'); 
            
            createLobbyForm.reset();
            document.querySelector('input[name="lobby-type"][value="public"]').checked = true;
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('input[value="public"]').nextElementSibling.classList.add('active');
            newLobbyPasswordField.classList.add('hidden');
            gameDurationInput.value = 5;

            // Use the new helper function to manage UI visibility
            await updateCreateLobbyModalUI(mode); 

            // Special handling for 'myLobbies' mode: show specific message if no approved lobbies to manage
            if (mode === 'myLobbies' && (!currentUserData.approvedLobbyNames || currentUserData.approvedLobbyNames.length === 0)) {
                 showCreateLobbyMessageBox("شما هیچ نام لابی تایید شده‌ای برای مدیریت یا ساخت لابی ندارید.", "info");
            }
        }

        function closeCreateLobbyModal() {
            createLobbyModal.classList.remove('profile-modal-enter-active');
            createLobbyModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                createLobbyModal.classList.add('hidden');
                createLobbyModal.classList.remove('profile-modal-leave-active');
                createLobbyForm.reset();

                newLobbyPasswordField.classList.add('hidden');
                document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('input[value="public"]').nextElementSibling.classList.add('active');
                gameDurationInput.value = 5; 
                lobbyProposalMessage.classList.remove('text-red-400'); 
                lobbyProposalMessage.classList.add('text-gray-400');
                
                // Ensure all related areas are hidden when closing
                lobbyNameSelectionArea.classList.add('hidden');
                lobbyNameProposalArea.classList.add('hidden');
                pendingLobbyNamesArea.classList.add('hidden');
                approvedLobbyNamesManagementArea.classList.add('hidden');
                submitCreateLobbyBtn.classList.add('hidden'); // Hide it again on close
                submitLobbyNameForApprovalBtn.classList.add('hidden'); // Hide it again on close


                if (unsubscribePendingLobbyNames) {
                    unsubscribePendingLobbyNames();
                    unsubscribePendingLobbyNames = null;
                }
            }, 300);
        }
        
        function openKickPlayerConfirmModal(playerName, playerUid) {
            kickPlayerConfirmName.textContent = playerName;
            kickPlayerConfirmModal.classList.remove('hidden');
            void kickPlayerConfirmModal.offsetWidth;
            kickPlayerConfirmModal.classList.add('profile-modal-enter-active');
            kickedPlayerToProcess = { uid: playerUid, displayName: playerName };
        }

        function closeKickPlayerConfirmModal() {
            kickPlayerConfirmModal.classList.remove('profile-modal-enter-active');
            kickPlayerConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickPlayerConfirmModal.classList.add('hidden');
                kickPlayerConfirmModal.classList.remove('profile-modal-leave-active');
                kickedPlayerToProcess = null;
            }, 300);
        }

        function showKickedMessageModal(lobbyName) {
            kickedLobbyName.textContent = lobbyName;
            kickedMessageModal.classList.remove('hidden');
            void kickedMessageModal.offsetWidth;
            kickedMessageModal.classList.add('profile-modal-enter-active');
        }

        function closeKickedMessageModal() {
            kickedMessageModal.classList.remove('profile-modal-enter-active');
            kickedMessageModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickedMessageModal.classList.add('hidden');
                kickedMessageModal.classList.remove('profile-modal-leave-active');
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            }, 300);
        }

        function openKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('hidden');
            void kickedPlayersListModal.offsetWidth;
            kickedPlayersListModal.classList.add('profile-modal-enter-active');
            if (currentLobbyId) {
                unsubscribeKickedPlayers = setupKickedPlayersListListener(currentLobbyId);
            } else {
                kickedPlayersListContent.innerHTML = '<p class="text-gray-400 text-center">خطا: لابی فعال یافت نشد.</p>';
            }
        }

        function closeKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('profile-modal-enter-active');
            kickedPlayersListModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickedPlayersListModal.classList.add('hidden');
                kickedPlayersListModal.classList.remove('profile-modal-leave-active');
                if (unsubscribeKickedPlayers) {
                    unsubscribeKickedPlayers();
                    unsubscribeKickedPlayers = null;
                }
            }, 300);
        }

        // NEW: Function to update coins display in header
        function updateUserCoinsDisplay() {
            if (currentUserData && currentUserData.coins !== undefined) {
                headerUserCoins.textContent = currentUserData.coins.toLocaleString('fa-IR'); // Display only number now
            } else {
                headerUserCoins.textContent = `---`;
            }
        }
        
        // =========================================================================
        // === START OF CORRECTED AUTH & REAL-TIME SETTINGS LOGIC =================
        // =========================================================================

        /**
         * NEW: Sets up a real-time listener for game settings (like entry cost).
         * This ensures any changes in Firestore are immediately reflected in the app.
         */
        function setupGameSettingsListener() {
            if (unsubscribeGameSettings) unsubscribeGameSettings(); // Clean up previous listener if any

            const configRef = doc(db, `artifacts/${appId}/config/game_settings`);
            unsubscribeGameSettings = onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const newCost = docSnap.data().gameEntryCost;
                    if (typeof newCost === 'number') {
                        gameEntryCost = newCost;
                        friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa-IR');
                        console.log(`هزینه ورودی بازی به صورت لحظه‌ای به ${gameEntryCost} تغییر کرد.`);
                    }
                } else {
                    console.warn("سند تنظیمات بازی یافت نشد. از مقدار پیش‌فرض استفاده می‌شود.");
                    // Fallback to default if somehow the document is deleted after app start
                    gameEntryCost = 100;
                    friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa-IR');
                }
            }, (error) => {
                console.error("خطا در گوش دادن به تنظیمات بازی:", error);
            });
        }
        
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged triggered. User:", user ? user.uid : "logged out");

            // Part 1: Manage User Data and Listeners
            if (user) {
                // If a user is logged in, set up listeners.
                if (unsubscribeUserProfile) unsubscribeUserProfile();
                if (unsubscribeGameSettings) unsubscribeGameSettings();

                // Setup listener for user profile
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                unsubscribeUserProfile = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = { uid: user.uid, email: user.email, ...docSnap.data() };
                        headerDisplayName.textContent = currentUserData.displayName || 'کاربر ناشناس';
                        headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                        updateUserCoinsDisplay();
                        // Also update the approved lobby names list in the modal whenever profile data changes
                        if (!createLobbyModal.classList.contains('hidden')) { // Only if modal is open
                           renderApprovedLobbyNamesManagementList(); // Rerender management list
                           // Re-evaluate approved names dropdown & proposal area visibility
                           updateCreateLobbyModalUI(createLobbyModalTitle.textContent === 'مدیریت نام‌های لابی و ساخت لابی' ? 'myLobbies' : 'create'); // Use the new helper here
                        }
                    } else {
                        console.warn("User profile document not found. Creating a default one.");
                        // Create a default profile if it doesn't exist
                        setDoc(userDocRef, {
                            displayName: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            coins: 500, // Starting coins
                            approvedLobbyNames: [],
                            banStatus: { isBanned: false },
                            createdAt: serverTimestamp()
                        }, { merge: true }).then(() => {
                            console.log("Default user profile created.");
                        }).catch(e => {
                            console.error("Error creating default user profile:", e);
                        });
                        currentUserData = { uid: user.uid, email: user.email, displayName: 'کاربر جدید', coins: 0, approvedLobbyNames: [] };
                    }
                }, (error) => {
                    console.error("خطا در گوش دادن به user profile:", error);
                });

                // NEW: Setup listener for game settings
                setupGameSettingsListener();

            } else {
                // User is logged out. Clean up all data and listeners.
                if (unsubscribeUserProfile) unsubscribeUserProfile();
                if (unsubscribeGameSettings) unsubscribeGameSettings();
                // ... (other listener cleanups) ...
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                if (unsubscribeKickedPlayers) unsubscribeKickedPlayers();
                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                if (unsubscribePendingLobbyNames) unsubscribePendingLobbyNames();
                
                unsubscribeUserProfile = unsubscribeGameSettings = unsubscribeLobbies = unsubscribeLobbyDetail = unsubscribeKickedPlayers = unsubscribeLobbyChat = unsubscribePendingLobbyNames = null;
                clearGameIntervals();
                
                currentUserData = null;
                currentLobbyId = null;
                userHasActiveLobby = false;
                
                resetGameUI();
                updateUserCoinsDisplay();
            }

            // Part 2: Manage Screen Transitions (no change needed here)
            if (!isInitialAuthCheckComplete) {
                setActiveScreen(user ? mainScreen : authScreen);
                isInitialAuthCheckComplete = true;
            } else {
                if (user && currentActiveScreen === authScreen) {
                    setActiveScreen(mainScreen);
                } else if (!user && currentActiveScreen !== authScreen) {
                    setActiveScreen(authScreen);
                }
            }
        });

        async function initializeFirebaseAndAuth() {
            console.log("Initializing Firebase...");

            // Ensure game_settings config exists at startup. If not, create it.
            // The real-time listener will then pick up the value.
            try {
                const configRef = doc(db, `artifacts/${appId}/config/game_settings`);
                const configSnap = await getDoc(configRef);
                if (!configSnap.exists()) {
                    console.log("`game_settings` document not found. Creating with default values...");
                    await setDoc(configRef, { gameEntryCost: 100 });
                    console.log("Default `game_settings` config created successfully.");
                }
            } catch (error) {
                console.error("CRITICAL: Error initializing game settings config:", error);
                showMessageBox("خطا در بارگذاری تنظیمات بازی.", "error");
            }
            
            // Handle initial authentication
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with initial custom token:", error);
                }
            }
            console.log("Firebase initialization finished.");
        }
        // --- END OF CORRECTED AUTH & REAL-TIME SETTINGS LOGIC ---

        // Maps Firebase auth error codes to user-friendly Persian messages.
        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': "فرمت ایمیل نامعتبر است.",
                'auth/user-disabled': "حساب کاربری شما غیرفعال شده است.",
                'auth/user-not-found': "کاربری با این ایمیل یافت نشد.",
                'auth/wrong-password': "ایمیل یا رمز عبور اشتباه است.",
                'auth/invalid-credential': "ایمیل یا رمز عبور اشتباه است.",
                'auth/email-already-in-use': "این ایمیل قبلاً ثبت نام شده است.",
                'auth/weak-password': "رمز عبور باید حداقل ۶ کاراکتر باشد.",
                'auth/operation-not-allowed': "این نوع ورود فعال نیست.",
                'auth/network-request-failed': "مشکل در اتصال به اینترنت.",
                'auth/too-many-requests': "تعداد تلاش‌های ناموفق بیش از حد مجاز.",
            };
            return messages[errorCode] || "خطایی ناشناخته رخ داده است.";
        }

        // --- Firebase Lobby Functions ---
        async function createLobby(lobbyName, userId, displayName, lobbyType, password, gameDurationMinutes) {
            try {
                const creatorDisplayName = displayName && displayName.trim() !== '' ? displayName : 'ناشناس';
        
                const userLobbiesQuery = query(
                    collection(db, `global_lobbies`),
                    where("hostId", "==", userId),
                    where("status", "in", ["waiting", "playing"])
                );
                const userLobbiesSnapshot = await getDocs(userLobbiesQuery);
                if (!userLobbiesSnapshot.empty) {
                    throw new Error("شما از قبل یک لابی فعال ساخته‌اید. لطفاً ابتدا لابی قبلی خود را ببندید.");
                }
        
                const lobbiesRef = collection(db, `global_lobbies`);
                
                const newLobbyData = {
                    name: lobbyName,
                    hostId: userId,
                    status: "waiting",
                    type: lobbyType,
                    players: {
                        [userId]: creatorDisplayName // Using a map: { "uid": "displayName" }
                    },
                    kickedPlayers: [], // Still an array of objects
                    createdAt: serverTimestamp(),
                    isChatLocked: false, // NEW: Chat is open by default
                    gameSettings: { 
                        maxPlayers: 4, 
                        gameDurationMinutes: gameDurationMinutes // NEW
                    }
                };
        
                if (lobbyType === 'private') {
                    newLobbyData.password = password;
                }
        
                const newLobbyRef = await addDoc(lobbiesRef, newLobbyData);
                
                console.log(`لابی ${lobbyType} با ID ساخته شد: `, newLobbyRef.id);
                userHasActiveLobby = true;
                return newLobbyRef.id;
            } catch (e) {
                console.error("خطا در ساخت لابی: ", e);
                throw e;
            }
        }
        
        async function closeLobby(lobbyId, userId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { showMessageBox("لابی مورد نظر یافت نشد.", "error"); return; }
                const lobbyData = lobbySnap.data();
                if (lobbyData.hostId !== userId) { showMessageBox("شما اجازه بستن این لابی را ندارید.", "error"); return; }

                const lobbyElement = document.querySelector(`[data-lobby-id="${lobbyId}"]`);
                if (lobbyElement) {
                    lobbyElement.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                await deleteDoc(lobbyRef);
                showMessageBox(`لابی "${lobbyData.name}" با موفقیت بسته شد.`, "success");
                userHasActiveLobby = false; // Host just closed their lobby
                if (currentLobbyId === lobbyId) currentLobbyId = null;

                clearGameIntervals();
                resetGameUI();
            } catch (e) {
                console.error("خطا در بستن لابی: ", e);
                showMessageBox(`خطا در بستن لابی: ${e.message}`, "error");
            }
        }
        
        function setupLobbyListener(searchTerm = '') {
            console.log(`شروع راه‌اندازی Listener لابی‌ها با عبارت جستجو: "${searchTerm}"`);

            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            clearGameIntervals();
            resetGameUI(); 

            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>';
            userHasActiveLobby = false; // Reset this flag when entering lobby list view

            const allLobbiesQuery = query(collection(db, `global_lobbies`));
            getDocs(allLobbiesQuery).then(allLobbiesSnapshot => {
                if (auth.currentUser) {
                    allLobbiesSnapshot.forEach(doc => {
                        const lobbyData = doc.data();
                        if (lobbyData.players && lobbyData.players[auth.currentUser.uid]) {
                            userHasActiveLobby = true;
                            currentLobbyId = doc.id; 
                        }
                    });
                }
                console.log(`User has active lobby: ${userHasActiveLobby} (ID: ${currentLobbyId})`);
            }).catch(error => {
                console.error("Error checking user's active lobby status:", error);
            });
        
            const normalizedSearchTerm = searchTerm.toLowerCase();
            const q = query(
                collection(db, `global_lobbies`), 
                where("status", "==", "waiting") 
            );
        
            const unsubscribe = onSnapshot(q, (snapshot) => {
                lobbiesList.innerHTML = '';
        
                let lobbiesToDisplay = [];

                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    const playersMap = lobby.players || {};
                    
                    const hostDisplayName = (playersMap[lobby.hostId] || 'ناشناس').toLowerCase();
                    const lobbyName = (lobby.name || '').toLowerCase();
                    
                    if (normalizedSearchTerm === '' || lobbyName.includes(normalizedSearchTerm) || hostDisplayName.includes(normalizedSearchTerm)) {
                        lobbiesToDisplay.push(lobby);
                    }
                });
                
                getDocs(query(collection(db, `global_lobbies`), where("status", "==", "playing"))).then(playingSnapshot => {
                    activeGamesCount.textContent = playingSnapshot.size;
                });
                
                lobbiesToDisplay.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        
                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p class="text-gray-400">لابی با این مشخصات یافت نشد.</p>';
                } else {
                    lobbiesToDisplay.forEach((lobby) => {
                        const playersMap = lobby.players || {};
                        const playerCount = Object.keys(playersMap).length;
                        const maxPlayers = lobby.gameSettings?.maxPlayers || 4;
                        const hostDisplayName = playersMap[lobby.hostId] || 'ناشناس';
                        const isCurrentUserHostOfThisLobby = auth.currentUser && lobby.hostId === auth.currentUser.uid;
                        const isCurrentUserKicked = auth.currentUser && lobby.kickedPlayers?.some(p => p.uid === auth.currentUser.uid);
                        const canJoinThisLobby = auth.currentUser && !userHasActiveLobby && playerCount < maxPlayers && !isCurrentUserKicked;
        
                        const lockIconHtml = lobby.type === 'private' 
                            ? `<svg xmlns="http://www.w3.org/2000/svg" class="lobby-lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` 
                            : '';
                        
                        const formattedLobbyName = formatLobbyNameWithColor(lobby.name);
        
                        let joinButtonHtml = '';
                        if (isCurrentUserKicked) {
                             joinButtonHtml = `<button class="join-lobby-btn futuristic-btn btn-red-futuristic opacity-50 cursor-not-allowed" disabled>اخراج شده‌اید</button>`;
                        } else if (isCurrentUserHostOfThisLobby) {
                            joinButtonHtml = `<button data-lobby-id="${lobby.id}" class="view-my-lobby-btn futuristic-btn btn-blue-futuristic">ورود به لابی من</button>`;
                        } else if (canJoinThisLobby) {
                            joinButtonHtml = `<button data-lobby-id="${lobby.id}" data-lobby-type="${lobby.type || 'public'}" data-lobby-name="${lobby.name}" class="join-lobby-btn futuristic-btn btn-blue-futuristic">ورود به لابی</button>`;
                        } else {
                            joinButtonHtml = `<button class="join-lobby-btn futuristic-btn btn-blue-futuristic opacity-50 cursor-not-allowed" disabled>ورود به لابی</button>`;
                        }
                        
                        const closeButtonHtml = isCurrentUserHostOfThisLobby 
                            ? `<button data-lobby-id="${lobby.id}" class="close-lobby-btn futuristic-btn btn-red-futuristic">بستن لابی</button>` : '';
        
                        const lobbyItem = document.createElement('div');
                        lobbyItem.className = 'lobby-item mb-3 w-full';
                        lobbyItem.dataset.lobbyId = lobby.id;
                        lobbyItem.innerHTML = `
                            <div class="mb-2 sm:mb-0 text-center sm:text-right">
                                <h3 class="text-xl font-bold">${lockIconHtml}${formattedLobbyName}</h3>
                                <p class="text-sm">سازنده: ${hostDisplayName}</p>
                                <p class="text-sm">بازیکنان: ${playerCount}/${maxPlayers}</p>
                            </div>
                            <div class="lobby-actions">
                                ${closeButtonHtml}
                                ${joinButtonHtml}
                            </div>
                        `;
                        lobbiesList.appendChild(lobbyItem);
                    });
                }
                
                lobbiesList.querySelectorAll('.join-lobby-btn:not([disabled])').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.currentTarget.dataset.lobbyId;
                        const lobbyType = e.currentTarget.dataset.lobbyType;
                        const lobbyName = e.currentTarget.dataset.lobbyName;
                        
                        if (lobbyType === 'private') {
                            openEnterPasswordModal(lobbyId, lobbyName);
                        } else {
                            try {
                                await joinLobby(lobbyId, auth.currentUser.uid, currentUserData.displayName);
                            } catch (error) {
                                console.error("Error joining public lobby:", error);
                                showMessageBox(`خطا در ورود به لابی: ${error.message}`, "error");
                            }
                        }
                    });
                });
        
                lobbiesList.querySelectorAll('.view-my-lobby-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const lobbyId = e.target.dataset.lobbyId;
                        if (lobbyId && auth.currentUser) {
                            currentLobbyId = lobbyId;
                            setActiveScreen(lobbyDetailScreen);
                            unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
                        }
                    });
                });
        
                lobbiesList.querySelectorAll('.close-lobby-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.target.dataset.lobbyId;
                        if (lobbyId && auth.currentUser) {
                            const lobbyName = e.target.closest('.lobby-item').querySelector('h3').textContent;
                            const cleanLobbyName = lobbyName.replace(/<[^>]*>/g, '');
                            const confirmed = await showCustomConfirm(`آیا مطمئن هستید که می‌خواهید لابی "${cleanLobbyName}" را ببندید؟`);
                            if (confirmed) {
                                await closeLobby(lobbyId, auth.currentUser.uid);
                            }
                        }
                    });
                });
        
            }, (error) => {
                console.error("خطا در گوش دادن به لابی‌ها: ", error);
                lobbiesList.innerHTML = `<p class="text-red-400">خطا در بارگذاری لیست لابی‌ها. (${error.message})</p>`;
            });
        
            return unsubscribe;
        }

        async function joinLobby(lobbyId, userId, displayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { throw new Error("لابی یافت نشد."); }
                
                const lobbyData = lobbySnap.data();
                const playersMap = lobbyData.players || {};
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                const kickedPlayers = lobbyData.kickedPlayers || [];

                if (kickedPlayers.some(p => p.uid === userId)) {
                    throw new Error("شما از این لابی اخراج شده‌اید.");
                }
                if (playersMap[userId]) { // Player is already in
                    currentLobbyId = lobbyId;
                    userHasActiveLobby = true; // Set this to true as user is in a lobby
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
                    return;
                }
                if (Object.keys(playersMap).length >= maxPlayers) { throw new Error("لابی پر است."); }
                
                // Add player to map using dot notation for the key
                await updateDoc(lobbyRef, {
                    [`players.${userId}`]: displayName
                });
                
                showMessageBox(`شما به لابی "${lobbyData.name}" وارد شدید.`, "success");
                
                currentLobbyId = lobbyId;
                userHasActiveLobby = true; // Set this to true as user just joined a lobby
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
            } catch (e) {
                console.error("خطا در ورود به لابی: ", e);
                throw e; // Re-throw to be caught by the caller
            }
        }
        
        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to lobby details for ID: ${lobbyId}`);
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            clearGameIntervals();
            resetGameUI();

            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const unsubscribe = onSnapshot(lobbyRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    showMessageBox("لابی که در آن بودید بسته شد.", "info");
                    currentLobbyId = null;
                    userHasActiveLobby = false;
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                    return;
                }
                
                const lobbyData = docSnap.data();
                const isCurrentUserHost = auth.currentUser && lobbyData.hostId === auth.currentUser.uid;
                const myUid = auth.currentUser.uid;

                if (!lobbyData.players || !lobbyData.players[myUid]) {
                    console.log("Current user is no longer in this lobby's player list.");
                    if (lobbyData.kickedPlayers?.some(p => p.uid === myUid)) {
                        showKickedMessageModal(lobbyData.name);
                    } else {
                        showMessageBox("شما از لابی خارج شدید.", "info");
                        currentLobbyId = null;
                        userHasActiveLobby = false;
                        setActiveScreen(lobbyScreen);
                        unsubscribeLobbies = setupLobbyListener('');
                    }
                    return;
                }

                if (lobbyData.status === 'playing') {
                    setupGameUI(lobbyId, lobbyData);
                    hostActionsContainer.style.display = 'none';
                    leaveLobbyBtn.classList.add('hidden');
                    return;
                } else {
                    resetGameUI();
                    if (isCurrentUserHost) {
                        hostActionsContainer.style.display = 'flex';
                        leaveLobbyBtn.classList.remove('hidden');
                        leaveLobbyBtn.textContent = 'بستن لابی';
                    } else {
                        hostActionsContainer.style.display = 'none';
                        leaveLobbyBtn.classList.add('hidden');
                    }
                }

                const playersMap = lobbyData.players || {};
                const playerCount = Object.keys(playersMap).length;
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                const isChatLocked = lobbyData.isChatLocked || false;

                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                unsubscribeLobbyChat = setupLobbyChatListener(lobbyId, lobbyData.hostId);

                detailLobbyName.innerHTML = formatLobbyNameWithColor(lobbyData.name);
                detailHostName.textContent = `سازنده: ${playersMap[lobbyData.hostId] || 'ناشناس'}`;
                detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                playerListContainer.innerHTML = '';
                gamePlayerStatus.innerHTML = ''; 
                const playerList = Object.entries(playersMap).map(([uid, displayName]) => ({ uid, displayName }));

                for (const player of playerList) {
                    const isHost = player.uid === lobbyData.hostId;
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-list-item';
                    if (isHost) playerItem.classList.add('is-host');

                    const kickButtonHtml = (isCurrentUserHost && !isHost) 
                        ? `<button class="kick-player-btn" data-player-uid="${player.uid}" data-player-name="${player.displayName}">اخراج</button>` 
                        : '';
                    
                    const hostLabelHtml = isHost ? '<span class="host-label">(سازنده)</span>' : '';

                    playerItem.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 lucide lucude-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <span class="player-name">${player.displayName}</span>
                            ${hostLabelHtml}
                        </div>
                        ${kickButtonHtml}
                    `;
                    playerListContainer.appendChild(playerItem);
                }

                playerListContainer.querySelectorAll('.kick-player-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                       openKickPlayerConfirmModal(e.currentTarget.dataset.playerName, e.currentTarget.dataset.playerUid);
                    });
                });

                if (isCurrentUserHost) {
                    startGameBtn.disabled = playerCount !== maxPlayers;
                    startGameBtn.textContent = `شروع بازی (${playerCount}/${maxPlayers})`;
                    toggleChatLockBtn.textContent = isChatLocked ? 'باز کردن چت' : 'قفل کردن چت';
                }

                if (isChatLocked && !isCurrentUserHost) {
                    lobbyChatInput.disabled = true;
                    lobbyChatSendBtn.disabled = true;
                    lobbyChatInput.placeholder = "چت توسط سازنده قفل شده است";
                } else {
                    lobbyChatInput.disabled = false;
                    lobbyChatSendBtn.disabled = false;
                    lobbyChatInput.placeholder = "پیام خود را بنویسید...";
                }


            }, (error) => {
                console.error("Lobby detail listener error:", error);
                showMessageBox("خطا در بارگذاری جزئیات لابی.", "error");
                currentLobbyId = null;
                userHasActiveLobby = false;
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            });
            return unsubscribe;
        }

        async function leaveLobby() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const userId = auth.currentUser.uid;
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) {
                    showMessageBox("لابی مورد نظر یافت نشد.", "error");
                    currentLobbyId = null;
                    userHasActiveLobby = false;
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                    return;
                }
                const isHost = lobbySnap.data().hostId === userId;
                if (isHost) {
                    const confirmed = await showCustomConfirm("شما سازنده لابی هستید. خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟", "بستن لابی");
                    if (confirmed) {
                        await deleteDoc(lobbyRef);
                    }
                }
            } catch (e) { console.error("Error leaving lobby:", e); showMessageBox("خطا در ترک لابی.", "error"); }
        }

        async function kickPlayer(lobbyId, playerToKickUid, playerToKickDisplayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    [`players.${playerToKickUid}`]: deleteField(),
                    kickedPlayers: arrayUnion({ uid: playerToKickUid, displayName: playerToKickDisplayName })
                });
                showMessageBox(`بازیکن "${playerToKickDisplayName}" اخراج شد.`, "success");
                closeKickPlayerConfirmModal();
            } catch (e) { console.error("Error kicking player:", e); showMessageBox("خطا در اخراج بازیکن.", "error"); }
        }

        async function unkickPlayer(lobbyId, playerToUnkickUid) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists()) {
                    const kickedPlayers = lobbySnap.data().kickedPlayers || [];
                    const playerToUnkick = kickedPlayers.find(p => p.uid === playerToUnkickUid);
                    if (playerToUnkick) {
                        await updateDoc(lobbyRef, { kickedPlayers: arrayRemove(playerToUnkick) });
                        showMessageBox(`بازیکن "${playerToUnkick.displayName}" می‌تواند دوباره وارد شود.`, "success");
                    }
                }
            } catch (e) { console.error("Error unkicking player:", e); showMessageBox("خطا در بازگرداندن بازیکن.", "error"); }
        }

        function setupKickedPlayersListListener(lobbyId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                kickedPlayersListContent.innerHTML = '';
                if (docSnap.exists()) {
                    const kickedPlayers = docSnap.data().kickedPlayers || [];
                    const validKickedPlayers = kickedPlayers.filter(p => p && p.displayName && p.uid);

                    if (validKickedPlayers.length === 0) {
                        kickedPlayersListContent.innerHTML = '<p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p>';
                    } else {
                        validKickedPlayers.forEach(player => {
                            const playerDiv = document.createElement('div');
                            playerDiv.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg mb-2';
                            playerDiv.innerHTML = `<span>${player.displayName}</span><button data-player-uid="${player.uid}" class="unkick-player-btn futuristic-btn btn-green-futuristic text-sm py-1 px-3">بازگرداندن</button>`;
                            kickedPlayersListContent.appendChild(playerDiv);
                        });
                        kickedPlayersListContent.querySelectorAll('.unkick-player-btn').forEach(button => {
                            button.addEventListener('click', (e) => unkickPlayer(currentLobbyId, e.target.dataset.playerUid));
                        });
                    }
                }
            });
        }
        
        async function sendLobbyMessage(lobbyId, text) {
            if (!text.trim() || !auth.currentUser || !currentUserData) return;
            
            const lobbyDocRef = doc(db, `global_lobbies`, lobbyId);
            const lobbySnap = await getDoc(lobbyDocRef);
            if (lobbySnap.exists() && lobbySnap.data().status === 'playing') {
                const moderationResult = await checkMessageForLiteraryAIStyle(text);
                if (!moderationResult.is_literary) {
                    showMessageBox(`پیام شما به دلیل لحن نامناسب ارسال نشد: ${moderationResult.reason}`, "error");
                    return;
                }
            }

            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            try {
                await addDoc(messagesRef, {
                    text: text.trim(),
                    senderUid: auth.currentUser.uid,
                    senderName: currentUserData.displayName,
                    timestamp: serverTimestamp(),
                    isDeleted: false
                });
                lobbyChatInput.value = '';
            } catch (error) {
                console.error("Error sending chat message:", error);
                showMessageBox("خطا در ارسال پیام.", "error");
            }
        }
        
        async function deleteLobbyMessage(lobbyId, messageId) {
            const messageRef = doc(db, `global_lobbies/${lobbyId}/messages`, messageId);
            try {
                await updateDoc(messageRef, {
                    text: "[این پیام حذف شده است]",
                    isDeleted: true
                });
            } catch (error) {
                console.error("Error deleting message:", error);
                showMessageBox("خطا در حذف پیام.", "error");
            }
        }

        function setupLobbyChatListener(lobbyId, hostId) {
            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            return onSnapshot(q, (snapshot) => {
                lobbyChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    const messageId = doc.id;
                    const isCurrentUserMsg = messageData.senderUid === auth.currentUser.uid;
                    const isCurrentUserHost = auth.currentUser.uid === hostId;

                    const canDelete = !messageData.isDeleted && (isCurrentUserMsg || isCurrentUserHost);

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('chat-message');
                    if (isCurrentUserMsg) {
                        messageDiv.classList.add('current-user');
                    }
                    
                    const deleteButtonHtml = canDelete ? `
                        <button class="delete-message-btn" data-message-id="${messageId}" title="حذف پیام">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    ` : '';

                    const messageContentHtml = messageData.isDeleted ? `
                        <p class="message-text-deleted">${messageData.text}</p>
                    ` : `
                        <span class="sender-name">${messageData.senderName}</span>
                        <p class="message-text">${messageData.text}</p>
                    `;

                    messageDiv.innerHTML = `
                        <div class="chat-message-content">
                            ${messageContentHtml}
                        </div>
                        ${deleteButtonHtml}
                    `;
                    lobbyChatMessages.appendChild(messageDiv);
                });

                lobbyChatMessages.scrollTop = lobbyChatMessages.scrollHeight;
            }, (error) => {
                console.error("Lobby chat listener error:", error);
                console.warn("Could not load chat messages:", error.message);
            });
        }
        
        // --- Game Logic Functions (NEW) ---

        async function initializeGameInFirestore(lobbyId, lobbyData) {
            const playerUIDs = Object.keys(lobbyData.players);
            const playerNames = lobbyData.players;

            if (playerUIDs.length !== 4) {
                throw new Error("برای شروع بازی باید 4 بازیکن در لابی باشند.");
            }

            const currentEntryCost = gameEntryCost;

            for (const playerId of playerUIDs) {
                const playerProfileRef = doc(db, `artifacts/${appId}/users/${playerId}/profile/data`);
                const playerProfileSnap = await getDoc(playerProfileRef);
                if (!playerProfileSnap.exists() || (playerProfileSnap.data().coins || 0) < currentEntryCost) {
                    throw new Error(`بازیکن ${playerNames[playerId]} سکه کافی برای شروع بازی ندارد. (نیاز: ${currentEntryCost} سکه)`);
                }
            }

            const batch = writeBatch(db);
            for (const playerId of playerUIDs) {
                const playerProfileRef = doc(db, `artifacts/${appId}/users/${playerId}/profile/data`);
                batch.update(playerProfileRef, { coins: increment(-currentEntryCost) });
            }
            await batch.commit();
            console.log(`Successfully deducted ${currentEntryCost} coins from all players.`);

            if (currentUserData && playerUIDs.includes(currentUserData.uid)) {
                currentUserData.coins -= currentEntryCost;
                updateUserCoinsDisplay();
            }

            const shuffledPlayers = [...playerUIDs].sort(() => Math.random() - 0.5);
            const roles = {};
            roles[shuffledPlayers[0]] = 'AI';
            for (let i = 1; i < shuffledPlayers.length; i++) {
                roles[shuffledPlayers[i]] = 'Human';
            }

            const gameDurationMinutes = lobbyData.gameSettings?.gameDurationMinutes || 5;
            const countdownDurationSeconds = 5;

            const initialGameState = {
                players: playerUIDs,
                playerNames: playerNames,
                roles: roles,
                status: 'countdown',
                winner: null,
                winReason: null,
                gameStartTimestamp: null,
                gameDurationSeconds: gameDurationMinutes * 60,
                countdownEndTime: Date.now() + countdownDurationSeconds * 1000 + 500,
                votes: {},
                aiScore: 0,
                humanScore: 0
            };

            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    gameState: initialGameState,
                    status: "playing"
                });
                console.log(`Game state initialized for lobby ${lobbyId}`);
            } catch (error) {
                console.error("Error initializing game state:", error);
                await updateDoc(lobbyRef, { status: "waiting" });
                throw new Error("Failed to initialize game.");
            }
        }
        
        function setupGameUI(lobbyId, lobbyData) {
            console.log(`Setting up game UI for lobby ID: ${lobbyId}`);
            clearGameIntervals();
            resetGameUI();

            const gameState = lobbyData.gameState;
            const myUid = auth.currentUser.uid;
            
            gameInfoPanel.classList.remove('hidden');
            leaveGameFromLobbyBtn.classList.remove('hidden');
            
            hostActionsContainer.style.display = 'none';
            leaveLobbyBtn.classList.add('hidden');
            
            playerListContainer.innerHTML = ''; 

            gamePlayerStatus.innerHTML = '';
            if (Array.isArray(gameState.players) && lobbyData.players) {
                gameState.players.forEach(pUid => {
                    const playerPod = document.createElement('div');
                    playerPod.className = `game-player-pod flex-grow`;
                    const isAI = gameState.roles[pUid] === 'AI';
                    playerPod.classList.add(isAI ? 'is-ai' : 'is-human');
                    if (pUid === myUid) {
                        myRole.textContent = isAI ? 'هوش مصنوعی' : 'انسان';
                        gameRoleDisplay.classList.remove('hidden');
                    }
                    
                    const isPlayerInLobby = lobbyData.players && lobbyData.players[pUid];
                    const playerStatusText = isPlayerInLobby ? 'آنلاین' : 'ترک کرده';
                    
                    playerPod.innerHTML = `
                        <span class="player-name">${gameState.playerNames[pUid] || 'ناشناس'}</span>
                        <span class="player-role">${isAI ? 'هوش مصنوعی' : 'انسان'}</span>
                        <span class="player-status">${playerStatusText}</span>
                    `;
                    gamePlayerStatus.appendChild(playerPod);
                });
            }


            const currentTime = Date.now();
            const lobbyRef = doc(db, 'global_lobbies', lobbyId);

            if (gameState.status === 'countdown') {
                gameCountdownOverlay.classList.remove('hidden');
                gameVotingOverlay.classList.add('hidden');
                gameResultDisplay.classList.add('hidden');
                gameTimerDisplay.classList.add('hidden');
                gameScoresDisplay.classList.add('hidden');

                lobbyChatInput.disabled = true;
                lobbyChatSendBtn.disabled = true;
                lobbyChatInput.placeholder = "بازی در حال شروع است...";

                let countdownSecs = Math.ceil((gameState.countdownEndTime - currentTime) / 1000);
                countdownNumber.textContent = Math.max(0, countdownSecs);
                countdownNumber.style.animation = 'none';
                countdownNumber.offsetHeight;
                countdownNumber.style.animation = 'countdown-pulse 1s ease-out forwards';


                gameCountdownInterval = setInterval(async () => {
                    countdownSecs--;
                    countdownNumber.textContent = Math.max(0, countdownSecs);
                    if (!gameCountdownOverlay.classList.contains('hidden')) {
                        countdownNumber.style.animation = 'none';
                        countdownNumber.offsetHeight;
                        countdownNumber.style.animation = 'countdown-pulse 1s ease-out forwards';
                    }

                    if (countdownSecs <= 0) {
                        clearInterval(gameCountdownInterval);
                        gameCountdownInterval = null;
                        gameCountdownOverlay.classList.add('hidden');
                        if (auth.currentUser && lobbyData.hostId === auth.currentUser.uid) {
                            await updateDoc(lobbyRef, {
                                'gameState.status': 'active',
                                'gameState.gameStartTimestamp': serverTimestamp()
                            });
                        }
                    }
                }, 1000);

            } else if (gameState.status === 'active' && gameState.gameStartTimestamp) {
                gameCountdownOverlay.classList.add('hidden');
                gameVotingOverlay.classList.add('hidden');
                gameResultDisplay.classList.add('hidden');
                gameTimerDisplay.classList.remove('hidden');
                gameScoresDisplay.classList.remove('hidden');

                lobbyChatInput.disabled = false;
                lobbyChatSendBtn.disabled = false;
                lobbyChatInput.placeholder = "پیام خود را بنویسید...";

                if (!gameTimerInterval) {
                    gameTimerInterval = setInterval(async () => {
                        const startMillis = gameState.gameStartTimestamp ? gameState.gameStartTimestamp.toMillis() : Date.now();
                        const elapsedMs = Date.now() - startMillis;
                        const remainingMs = gameState.gameDurationSeconds * 1000 - elapsedMs;

                        if (remainingMs <= 0) {
                            clearInterval(gameTimerInterval);
                            gameTimerInterval = null;
                            gameTimerDisplay.textContent = "00:00";
                            if (auth.currentUser && lobbyData.hostId === auth.currentUser.uid) {
                                await updateDoc(lobbyRef, { 'gameState.status': 'voting' });
                            }
                            return;
                        }

                        const remainingSeconds = Math.max(0, Math.floor(remainingMs / 1000));
                        const minutes = Math.floor(remainingSeconds / 60);
                        const seconds = remainingSeconds % 60;
                        gameTimerDisplay.textContent = 
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }, 1000);
                }

            } else if (gameState.status === 'voting') {
                gameCountdownOverlay.classList.add('hidden');
                gameVotingOverlay.classList.remove('hidden');
                gameResultDisplay.classList.add('hidden');
                gameTimerDisplay.classList.add('hidden');
                
                lobbyChatInput.disabled = true;
                lobbyChatSendBtn.disabled = true;
                lobbyChatInput.placeholder = "رای‌گیری در جریان است. چت موقتاً غیرفعال شد.";

                renderVotingOptions(lobbyId, myUid, gameState, lobbyData);
                
            } else if (gameState.status === 'ended') {
                gameCountdownOverlay.classList.add('hidden');
                gameVotingOverlay.classList.remove('hidden');
                gameResultDisplay.classList.remove('hidden');
                gameTimerDisplay.classList.add('hidden');
                votingOptions.classList.add('hidden');
                votingTitle.classList.add('hidden');
                votingInstructions.classList.add('hidden');
                
                lobbyChatInput.disabled = true;
                lobbyChatSendBtn.disabled = true;
                lobbyChatInput.placeholder = "بازی به پایان رسید.";

                winnerText.textContent = gameState.winner === 'Human' ? 'تیم انسان‌ها برنده شد!' : 'هوش مصنوعی برنده شد!';
                winnerText.classList.toggle('text-green-500', gameState.winner === 'Human');
                winnerText.classList.toggle('text-red-500', gameState.winner === 'AI');
                reasonText.textContent = gameState.winReason || 'بازی به پایان رسید.';
            }

            aiScore.textContent = `AI: ${gameState.aiScore || 0}`;
            humanScore.textContent = `Human: ${gameState.humanScore || 0}`;
        }

        function renderVotingOptions(lobbyId, myUid, gameState, lobbyData) {
            votingOptions.innerHTML = '';
            
            const hasVoted = gameState.votes && gameState.votes[myUid];

            if (hasVoted) {
                const votedForName = gameState.playerNames[gameState.votes[myUid]] || 'ناشناس';
                votingInstructions.textContent = `شما به ${votedForName} رای داده‌اید. منتظر بقیه بازیکنان باشید.`;
                return;
            }

            const livingPlayers = gameState.players.filter(uid => lobbyData.players && lobbyData.players[uid]);
            const aiPlayers = livingPlayers.filter(uid => gameState.roles[uid] === 'AI');
            const humanPlayers = livingPlayers.filter(uid => gameState.roles[uid] === 'Human' && uid !== myUid);

            if (aiPlayers.length > 0) {
                const aiButton = document.createElement('button');
                aiButton.className = 'voting-btn ai-vote';
                aiButton.textContent = `رای به هوش مصنوعی (${gameState.playerNames[aiPlayers[0]]})`;
                aiButton.onclick = () => castVote(lobbyId, myUid, aiPlayers[0]);
                votingOptions.appendChild(aiButton);
            }

            humanPlayers.forEach(playerUid => {
                const humanButton = document.createElement('button');
                humanButton.className = 'voting-btn human-vote';
                humanButton.textContent = `رای به انسان (${gameState.playerNames[playerUid]})`;
                humanButton.onclick = () => castVote(lobbyId, myUid, playerUid);
                votingOptions.appendChild(humanButton);
            });

            votingOptions.classList.remove('hidden');
        }

        async function castVote(lobbyId, voterUid, votedForUid) {
            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    [`gameState.votes.${voterUid}`]: votedForUid
                });
                showMessageBox(`رای شما ثبت شد.`, "success");

                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists() && lobbySnap.data().gameState.status === 'voting') {
                    const updatedGameState = lobbySnap.data().gameState;
                    const updatedLobbyData = lobbySnap.data();
                    const livingHumanPlayers = updatedGameState.players.filter(uid => 
                        updatedGameState.roles[uid] === 'Human' && updatedLobbyData.players && updatedLobbyData.players[uid]
                    );
                    const totalVotesExpected = livingHumanPlayers.length; 
                    const actualVotesCount = Object.keys(updatedGameState.votes || {}).length;

                    if (actualVotesCount >= totalVotesExpected) {
                        if (auth.currentUser && updatedLobbyData.hostId === auth.currentUser.uid) {
                            await resolveVotes(lobbyId, updatedGameState, updatedLobbyData);
                        }
                    }
                }

            } catch (error) {
                console.error("Error casting vote:", error);
                showMessageBox("خطا در ثبت رای.", "error");
            }
        }

        async function resolveVotes(lobbyId, gameState, lobbyData) {
            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            const votes = gameState.votes || {};
            const playerUidsInGame = gameState.players || [];
            const roles = gameState.roles || {};
            const currentLobbyPlayers = lobbyData.players || {};
            const livingPlayersInGameAndLobby = playerUidsInGame.filter(uid => currentLobbyPlayers[uid]);
            const livingHumanPlayers = livingPlayersInGameAndLobby.filter(uid => roles[uid] === 'Human');
            const livingAIPlayers = livingPlayersInGameAndLobby.filter(uid => roles[uid] === 'AI');

            if (livingPlayersInGameAndLobby.length === 1 && roles[livingPlayersInGameAndLobby[0]] === 'AI') {
                 await updateDoc(lobbyRef, {
                    'gameState.status': 'ended', 'gameState.winner': 'AI',
                    'gameState.winReason': `تمام انسان‌ها از بازی خارج شدند. هوش مصنوعی برنده است.`
                }); return;
            }

            if (livingPlayersInGameAndLobby.length === 1 && roles[livingPlayersInGameAndLobby[0]] === 'Human') {
                 await updateDoc(lobbyRef, {
                    'gameState.status': 'ended', 'gameState.winner': 'Human',
                    'gameState.winReason': `هوش مصنوعی از بازی خارج شد. انسان برنده است.`
                }); return;
            }

            if (livingAIPlayers.length === 1 && livingHumanPlayers.length === 1 && livingPlayersInGameAndLobby.length === 2) {
                await updateDoc(lobbyRef, {
                    'gameState.status': 'ended', 'gameState.winner': 'AI',
                    'gameState.winReason': `فقط هوش مصنوعی و یک انسان باقی ماندند. هوش مصنوعی برنده است.`
                }); return;
            }
            
            if (livingAIPlayers.length > 0) {
                const aiPlayerUid = livingAIPlayers[0];
                const votesForAI = Object.values(votes).filter(votedUid => votedUid === aiPlayerUid).length;
                
                if (votesForAI > livingHumanPlayers.length / 2) {
                     await updateDoc(lobbyRef, {
                        'gameState.status': 'ended', 'gameState.winner': 'AI',
                        'gameState.winReason': `بیشتر بازیکنان به هوش مصنوعی رای دادند.`
                    });
                } else {
                     await updateDoc(lobbyRef, {
                        'gameState.status': 'ended', 'gameState.winner': 'Human',
                        'gameState.winReason': `بازیکنان هوش مصنوعی را تشخیص ندادند. انسان‌ها برنده شدند.`
                    });
                }
            } else {
                await updateDoc(lobbyRef, {
                    'gameState.status': 'ended', 'gameState.winner': 'Human',
                    'gameState.winReason': `هوش مصنوعی از بازی خارج شد. انسان‌ها برنده شدند.`
                });
            }
        }


        // --- Event Listeners ---
        function initializeAuthScreen() {
            authMode = 'login';
            displayNameField.classList.add('hidden');
            submitAuthBtn.textContent = 'ورود';
            loginToggleBtn.classList.add('hidden');
            registerToggleBtn.classList.remove('hidden');
            authForm.reset();
            if(currentActiveScreen === authScreen) {
                 emailInput.focus();
            }
        }

        loginToggleBtn.addEventListener('click', () => {
            authMode = 'login';
            displayNameField.classList.add('hidden');
            submitAuthBtn.textContent = 'ورود';
            loginToggleBtn.classList.add('hidden');
            registerToggleBtn.classList.remove('hidden');
            authForm.reset();
            messageBox.classList.add('hidden');
            emailInput.focus();
        });

        registerToggleBtn.addEventListener('click', () => {
            authMode = 'register';
            displayNameField.classList.remove('hidden');
            submitAuthBtn.textContent = 'ثبت نام';
            registerToggleBtn.classList.add('hidden');
            loginToggleBtn.classList.remove('hidden');
            authForm.reset();
            messageBox.classList.add('hidden');
            emailInput.focus();
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const displayName = displayNameInput.value.trim();

            if (!email || !password) { showMessageBox("لطفاً ایمیل و رمز عبور را وارد کنید.", 'error'); return; }
            if (authMode === 'register' && !displayName) { showMessageBox("لطفاً نام نمایشی را وارد کنید.", 'error'); return; }
            if (authMode === 'register' && password.length < 6) { showMessageBox("رمز عبور باید حداقل ۶ کاراکتر باشد.", "error"); return; }
            
            submitAuthBtn.disabled = true;
            submitAuthBtn.textContent = 'در حال پردازش...';

            try {
                if (authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile/data`);
                    await setDoc(userDocRef, {
                        displayName: displayName,
                        email: userCredential.user.email,
                        coins: 500, // Starting coins
                        approvedLobbyNames: [],
                        banStatus: { isBanned: false },
                        createdAt: serverTimestamp()
                    });
                    console.log("User profile document created immediately after registration.");
                }
            } catch (error) { 
                showMessageBox(getFirebaseErrorMessage(error.code), 'error'); 
            } finally {
                submitAuthBtn.disabled = false;
                submitAuthBtn.textContent = authMode === 'login' ? 'ورود' : 'ثبت نام';
            }
        });

        menuBtn.addEventListener('click', openProfileModal);
        profileSummary.addEventListener('click', openProfileModal);
        closeProfileModalBtn.addEventListener('click', closeProfileModal);
        profileModal.addEventListener('click', (e) => e.target === profileModal && closeProfileModal());
        
        profileLogoutBtn.addEventListener('click', async () => {
            try { 
                await signOut(auth); 
                closeProfileModal(); 
            } catch (error) { 
                showMessageBox(getFirebaseErrorMessage(error.code), 'error'); 
            }
        });

        friendlyGameBtn.addEventListener('click', () => {
            if (!auth.currentUser) {
                showMessageBox("برای مشاهده لابی‌ها، ابتدا وارد شوید.", "error"); return;
            }
            if (!currentUserData) {
                showMessageBox("در حال بارگذاری اطلاعات کاربری، لطفاً کمی صبر کنید.", "info"); return;
            }
            if ((currentUserData.coins || 0) < gameEntryCost) {
                showMessageBox(`سکه شما برای ورود به بازی دوستانه کافی نیست. (نیاز: ${gameEntryCost} سکه، موجودی شما: ${currentUserData.coins || 0})`, "error"); return;
            }
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener('');
        });
        
        ratedGameBtn.addEventListener('click', () => showMessageBox("بازی امتیازی به زودی!", "info"));

        backToMainBtn.addEventListener('click', () => {
            setActiveScreen(mainScreen);
        });

        addIconBtn.addEventListener('click', () => {
            if (!auth.currentUser) { showMessageBox("برای ساخت لابی، ابتدا وارد شوید.", "error"); return; }
            openCreateLobbyModal('create');
        });

        myLobbiesBtn.addEventListener('click', () => {
            if (!auth.currentUser) { showMessageBox("برای مشاهده لابی‌های من، ابتدا وارد شوید.", "error"); return; }
            openCreateLobbyModal('myLobbies');
        });

        submitLobbyNameForApprovalBtn.addEventListener('click', async () => {
            const proposedName = proposedLobbyNameInput.value.trim();
            if (!proposedName) { showCreateLobbyMessageBox("لطفاً نام لابی پیشنهادی خود را وارد کنید.", "error"); return; }
            if (!auth.currentUser || !currentUserData) { showCreateLobbyMessageBox("خطا: اطلاعات کاربری در دسترس نیست.", "error"); return; }

            const proposedLobbyNamesRef = collection(db, `artifacts/${appId}/proposedLobbyNames`);
            const qPending = query(
                proposedLobbyNamesRef,
                where("userId", "==", auth.currentUser.uid),
                where("status", "==", "pending")
            );
            const pendingSnapshot = await getDocs(qPending);
            if (pendingSnapshot.size >= MAX_PENDING_PROPOSALS) { // Use constant for limit
                showCreateLobbyMessageBox(`شما به حداکثر تعداد (${MAX_PENDING_PROPOSALS}) درخواست لابی در انتظار تایید رسیده‌اید.`, "error");
                return;
            }

            showCreateLobbyMessageBox("در حال بررسی و ارسال نام لابی برای تأیید...", "info");
            submitLobbyNameForApprovalBtn.disabled = true;
            try {
                const moderationResult = await checkLobbyNameWithAI(proposedName);
                if (!moderationResult.is_appropriate) {
                    showCreateLobbyMessageBox(`نام لابی نامناسب: ${moderationResult.reason}`, "error");
                    return;
                }

                await addDoc(proposedLobbyNamesRef, {
                    name: proposedName,
                    userId: auth.currentUser.uid,
                    displayName: currentUserData.displayName,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                showCreateLobbyMessageBox("نام لابی شما با موفقیت برای تأیید ارسال شد.", "success");
                proposedLobbyNameInput.value = '';
            } catch (error) {
                console.error("خطا در ارسال نام لابی برای تأیید:", error);
                showCreateLobbyMessageBox(`خطا در ارسال نام لابی: ${error.message}`, "error");
            } finally {
                submitLobbyNameForApprovalBtn.disabled = false;
            }
        });
        
        // Listen for changes in the approved lobby names dropdown to enable/disable the "Create Lobby" button
        approvedLobbyNamesSelect.addEventListener('change', () => {
            submitCreateLobbyBtn.disabled = !approvedLobbyNamesSelect.value;
        });

        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let lobbyName;
            
            // Check if lobby name selection area is visible and a name is selected
            if (!lobbyNameSelectionArea.classList.contains('hidden') && approvedLobbyNamesSelect.value) {
                lobbyName = approvedLobbyNamesSelect.value;
            } else {
                showCreateLobbyMessageBox("لطفاً یک نام لابی تأیید شده را از لیست انتخاب کنید.", "error"); 
                return; 
            }

            const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;
            const gameDuration = parseInt(gameDurationInput.value, 10);
        
            if (lobbyType === 'private' && password.length < 4) { showCreateLobbyMessageBox("رمز عبور برای لابی خصوصی باید حداقل ۴ کاراکتر باشد.", "error"); return; }
            if (isNaN(gameDuration) || gameDuration < 1 || gameDuration > 60) { showCreateLobbyMessageBox("مدت زمان بازی باید بین ۱ تا ۶۰ دقیقه باشد.", "error"); return; }
            if (!auth.currentUser || !currentUserData?.displayName) { showCreateLobbyMessageBox("مشکلی در اطلاعات کاربری شما وجود دارد.", "error"); return; }
            if (userHasActiveLobby) { showCreateLobbyMessageBox("شما از قبل در یک لابی فعال هستید.", "info"); closeCreateLobbyModal(); return; }
            
            submitCreateLobbyBtn.disabled = true;
            try {
                const newLobbyId = await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName, lobbyType, password, gameDuration);
                showCreateLobbyMessageBox("لابی شما با موفقیت ساخته شد!", "success");
                
                // ===================================================================
                // === تغییر کلیدی: طبق درخواست شما، این بخش کامنت شد تا نام لابی ===
                // === بعد از استفاده از لیست نام‌های تایید شده حذف نشود.          ===
                // ===================================================================
                /*
                // Remove the used lobby name from the user's approved list
                const userDocRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                await updateDoc(userDocRef, {
                    approvedLobbyNames: arrayRemove(lobbyName)
                });
                */

                setTimeout(() => {
                    closeCreateLobbyModal();
                    currentLobbyId = newLobbyId;
                    userHasActiveLobby = true;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailListener(newLobbyId);
                }, 1500);
                
            } catch (error) {
                console.error("خطا در ساخت لابی از مودال:", error);
                showCreateLobbyMessageBox(error.message.includes("شما از قبل یک لابی فعال ساخته‌اید.") ? error.message : `خطا در ساخت لابی: ${error.message}`, "error");
            } finally {
                submitCreateLobbyBtn.disabled = false;
            }
        });

        closeCreateLobbyModalBtn.addEventListener('click', closeCreateLobbyModal);
        createLobbyModal.addEventListener('click', (e) => e.target === createLobbyModal && closeCreateLobbyModal());
        
        refreshLobbiesBtn.addEventListener('click', () => {
            if (isRefreshing) return;
            if (!auth.currentUser) { showMessageBox("برای بروزرسانی لابی‌ها، ابتدا وارد شوید.", "info"); return; }
            isRefreshing = true;
            refreshLobbiesBtn.disabled = true;
            const refreshIconSvg = refreshLobbiesBtn.querySelector('svg');
            if (refreshIconSvg) {
                refreshIconSvg.classList.add('is-refreshing');
            }
            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بروزرسانی لیست...</p>';
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value.trim().toLowerCase());
            setTimeout(() => {
                isRefreshing = false;
                refreshLobbiesBtn.disabled = false;
                if (refreshIconSvg) {
                    refreshIconSvg.classList.remove('is-refreshing');
                }
                showMessageBox("لیست لابی‌ها بروزرسانی شد.", "info");
            }, 1000);
        });


        lobbySearchInput.addEventListener('input', (e) => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(e.target.value.trim().toLowerCase());
        });
        lobbySearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchLobbiesBtn.click());
        searchLobbiesBtn.addEventListener('click', () => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value.trim().toLowerCase());
        });

        // --- Lobby Detail Screen Event Listeners ---
        leaveLobbyBtn.addEventListener('click', leaveLobby);

        startGameBtn.addEventListener('click', async () => {
            if (currentLobbyId && auth.currentUser) {
                try {
                    const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
                    const lobbySnap = await getDoc(lobbyRef);
                    if (lobbySnap.exists()) {
                        await initializeGameInFirestore(currentLobbyId, lobbySnap.data());
                    }
                } catch (error) {
                    console.error("Error starting game:", error);
                    showMessageBox(`خطا در شروع بازی: ${error.message}`, "error");
                }
            }
        });
        
        toggleChatLockBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists() && lobbySnap.data().hostId === auth.currentUser.uid) {
                    const currentLockState = lobbySnap.data().isChatLocked || false;
                    await updateDoc(lobbyRef, { isChatLocked: !currentLockState });
                }
            } catch (error) {
                console.error("Error toggling chat lock:", error);
                showMessageBox("خطا در تغییر وضعیت چت.", "error");
            }
        });

        // Kick/Unkick related
        kickPlayerConfirmBtn.addEventListener('click', () => kickedPlayerToProcess && kickPlayer(currentLobbyId, kickedPlayerToProcess.uid, kickedPlayerToProcess.displayName));
        cancelKickPlayerBtn.addEventListener('click', closeKickPlayerConfirmModal);
        closeKickPlayerConfirmModalBtn.addEventListener('click', closeKickPlayerConfirmModal);
        kickPlayerConfirmModal.addEventListener('click', (e) => e.target === kickPlayerConfirmModal && closeKickPlayerConfirmModal());
        kickedMessageOkBtn.addEventListener('click', closeKickedMessageModal);
        viewKickedPlayersBtn.addEventListener('click', openKickedPlayersListModal);
        closeKickedPlayersListModalBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedListOkBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedPlayersListModal.addEventListener('click', (e) => e.target === kickedPlayersListModal && closeKickedPlayersListModal());
        
        function showPasswordPromptMessage(message, type = 'error') {
            passwordPromptMessageBox.textContent = message;
            passwordPromptMessageBox.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            passwordPromptMessageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-blue-500', 'text-white');
            passwordPromptMessageBox.classList.remove('hidden');
            setTimeout(() => passwordPromptMessageBox.classList.add('hidden'), 4000);
        }

        function openEnterPasswordModal(lobbyId, lobbyName) {
            lobbyToJoin = { id: lobbyId, name: lobbyName };
            passwordPromptLobbyName.textContent = lobbyName;
            enterPasswordForm.reset();
            passwordPromptMessageBox.classList.add('hidden');
            enterPasswordModal.classList.remove('hidden');
            void enterPasswordModal.offsetWidth;
            enterPasswordModal.classList.add('profile-modal-enter-active');
            joinLobbyPasswordInput.focus();
        }

        function closeEnterPasswordModal() {
            enterPasswordModal.classList.remove('profile-modal-enter-active');
            enterPasswordModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                enterPasswordModal.classList.add('hidden');
                enterPasswordModal.classList.remove('profile-modal-leave-active');
                lobbyToJoin = null;
            }, 300);
        }

        lobbyTypeToggle.addEventListener('change', (e) => {
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            e.target.nextElementSibling.classList.add('active');
            if (e.target.value === 'private') {
                newLobbyPasswordField.classList.remove('hidden');
            } else {
                newLobbyPasswordField.classList.add('hidden');
            }
        });

        togglePasswordVisibilityBtn.addEventListener('click', () => {
            const isPassword = newLobbyPasswordInput.type === 'password';
            newLobbyPasswordInput.type = isPassword ? 'text' : 'password';
            eyeIconOpen.style.display = isPassword ? 'none' : 'block';
            eyeIconClosed.style.display = isPassword ? 'block' : 'none';
        });

        cancelJoinPasswordBtn.addEventListener('click', closeEnterPasswordModal);
        enterPasswordModal.addEventListener('click', (e) => e.target === enterPasswordModal && closeEnterPasswordModal());

        enterPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!lobbyToJoin) return;
            const enteredPassword = joinLobbyPasswordInput.value;
            if (!enteredPassword) { showPasswordPromptMessage('لطفاً رمز عبور را وارد کنید.'); return; }

            submitJoinPasswordBtn.disabled = true;
            submitJoinPasswordBtn.textContent = 'در حال بررسی...';
            try {
                const lobbyRef = doc(db, 'global_lobbies', lobbyToJoin.id);
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists() || lobbySnap.data().type !== 'private') {
                    showPasswordPromptMessage('این لابی دیگر خصوصی نیست یا وجود ندارد.');
                    closeEnterPasswordModal();
                    return;
                }
                if (enteredPassword === lobbySnap.data().password) {
                    closeEnterPasswordModal();
                    await joinLobby(lobbyToJoin.id, auth.currentUser.uid, currentUserData.displayName);
                } else {
                    showPasswordPromptMessage('رمز عبور اشتباه است.');
                    joinLobbyPasswordInput.value = '';
                    joinLobbyPasswordInput.focus();
                }
            } catch (error) {
                console.error("Error verifying lobby password:", error);
                showPasswordPromptMessage('خطا در بررسی رمز عبور.');
            } finally {
                submitJoinPasswordBtn.disabled = false;
                submitJoinPasswordBtn.textContent = 'ورود';
            }
        });
        
        lobbyChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentLobbyId) {
                sendLobbyMessage(currentLobbyId, lobbyChatInput.value);
            }
        });

        lobbyChatMessages.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-message-btn');
            if (deleteButton) {
                const messageId = deleteButton.dataset.messageId;
                if (currentLobbyId && messageId) {
                    deleteLobbyMessage(currentLobbyId, messageId);
                }
            }
        });

        leaveGameFromLobbyBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;

            const confirmed = await showCustomConfirm("آیا مطمئن هستید که می‌خواهید بازی را ترک کنید؟ این عمل غیرقابل بازگشت است.");
            if (!confirmed) return;

            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const myUid = auth.currentUser.uid;
            
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { throw new Error("Lobby not found"); }
                
                const lobbyData = lobbySnap.data();
                const gameState = lobbyData.gameState;
                
                // If a player leaves, they are removed from the active game.
                await updateDoc(lobbyRef, {
                    [`players.${myUid}`]: deleteField(), // Remove from main lobby player list
                    // The player remains in gameState.players and gameState.roles to preserve game history,
                    // but they are now considered "inactive".
                });
                
                // Now, re-fetch the lobby to check win/loss conditions
                const updatedLobbySnap = await getDoc(lobbyRef);
                if (updatedLobbySnap.exists()) {
                    const updatedLobbyData = updatedLobbySnap.data();
                    const updatedGameState = updatedLobbyData.gameState;
                    
                    // Host should check for game end conditions
                    if (updatedLobbyData.hostId === myUid || auth.currentUser.uid === updatedLobbyData.hostId) { 
                        await resolveVotes(lobbyId, updatedGameState, updatedLobbyData);
                    }
                }
                
                showMessageBox("شما از بازی خارج شدید.", "info");
            } catch (error) {
                console.error("Error leaving game:", error);
                showMessageBox("خطا در خروج از بازی.", "error");
            } finally {
                // Regardless of outcome, transition user away from the game.
                currentLobbyId = null;
                userHasActiveLobby = false;
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            }
        });

        returnToLobbiesBtn.addEventListener('click', () => {
            currentLobbyId = null;
            userHasActiveLobby = false;
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener('');
        });


        // Initialize the app when the window loads
        window.onload = initializeFirebaseAndAuth;
        console.log("Script execution finished.");
    </script>
</body>
</html>
