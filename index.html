<!DOCTYPE html> styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8 Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair">
    <meta name="viewport" content="width=device-width, initial-scale=1.0+Display:wght@700&family=Merriweather:wght@400;700">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    &display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
<script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
                <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wghtmargin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars,@700&family=Merriweather:wght@400;700&display=swap including horizontal */
        }
        body {
            font-family: 'Merriweather', serif; /*" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body Default body font for readability */
            /* Deep, rich, slightly textured background for classic feel */
            background: radial, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin-gradient(ellipse at bottom, #100C08 0%, #000000: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
 100%); /* Darker, more intense background */
            color: #E0E0E0; /*        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: readability */
            /* Deep, rich, slightly textured background for classic feel */
            background: radial-gradient(ellipse center;
            min-height: 100vh;
        }

        h1, h2 at bottom, #100C08 0%, #000000 100 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD7%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for00; /* Gold color for titles */
            text-shadow: 2px 2px 4px elegance */
            display: flex;
            justify-content: center;
            align-items: center; rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        
            min-height: 100vh;
        }

        h1, h2 {
/* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD7(255, 255, 255, 0.3);
            border-00; /* Gold color for titles */
            text-shadow: 2px 2px 4pxtop: 4px solid #DAA520; /* Gold spinner */
            border-radius:  rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        50%;
            width: 50px; /* Slightly larger spinner */
            height: 50/* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgbapx;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            (255, 255, 255, 0.3);
            border-0% { transform: rotate(0deg); }
            100% { transform: rotate(36top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 0deg); }
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-50%;
            width: 50px; /* Slightly larger spinner */
            height: 50refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(36px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% {0deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0 transform: rotate(0deg); }
            100% { transform: rotate(360deg);.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition }
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg);        }
        .page-transition-hidden {
            opacity: 0;
        }
        . }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-activepage-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
         detailed */
        .classic-card {
            background: linear-gradient(145deg, #4B00.page-transition-hidden {
            opacity: 0;
        }
        .page-transition-00 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0; /* Goldenrod border */
            border-radius: 20px; /* Slightly larger radius */
            box%, #660000 60%, #800000 100%);-shadow: 0 15px 30px rgba(0,0,0,0.6 /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod), inset 0 0 15px rgba(255,255,255, border */
            border-radius: 20px; /* Slightly larger radius */
            box-shadow: 0.1); /* Deeper outer shadow, subtle inner light */
            backdrop-filter: blur(100 15px 30px rgba(0,0,0,0.6), inset 0px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(1 0 15px rgba(255,255,255,0.1);0px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 9 /* Deeper outer shadow, subtle inner light */
            backdrop-filter: blur(10px); /* Strong0vh; /* Ensure card doesn't overflow viewport */
            overflow-y: hidden; /* Removed vertical scroller blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* Forbars */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
        }
 Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30; /* Ensure card doesn't overflow viewport */
            overflow-y: hidden; /* Removed vertical scrollbars */px;
            height: 30px;
            border-top: 5px solid #FFD700
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
;
            border-left: 5px solid #FFD700;
            border-radius:            top: -10px;
            left: -10px;
            width: 30 5px 0 0 0;
            box-shadow: 0 0 10pxpx;
            height: 30px;
            border-top: 5px solid #FFD700 rgba(255,215,0,0.5);
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px: -10px;
            right: -10px;
            width: 30px; rgba(255,215,0,0.5);
        }
        .classic-
            height: 30px;
            border-bottom: 5px solid #FFD70card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom0;
            border-right: 5px solid #FFD700;
            border-radius: -10px;
            right: -10px;
            width: 30px;: 0 0 5px 0;
            box-shadow: 0 0 10
            height: 30px;
            border-bottom: 5px solid #FFD70px rgba(255,215,0,0.5);
        }


        /* Button0;
            border-right: 5px solid #FFD700;
            border-radius Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }


        /* Button520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners */ */
            transition: all 0.3s cubic-bezier(0.2, 0.8,
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 0.2, 1); /* Smoother transition */
            box-shadow: 0 8px 1 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition6px rgba(0,0,0,0.4), inset 0 0 8px rgba(: all 0.3s cubic-bezier(0.2, 0.8, 0.2255,255,255,0.1); /* Deeper outer shadow, subtle inner, 1); /* Smoother transition */
            box-shadow: 0 8px 16px rgba( light */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.870,0,0,0.4), inset 0 0 8px rgba(255,5rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /*255,255,0.1); /* Deeper outer shadow, subtle inner light */
             For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classiccolor: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top:.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
 0;
            left: -100%;
            width: 100%;
            height            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /*: 100%;
            background: rgba(255,255,255,0.1 Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-
            left: -100%;
            width: 100%;
            height: 1bezier(0.2, 0.8, 0.2, 1);
        }
        00%;
            background: rgba(255,255,255,0.1.classic-btn:hover::before {
            left: 100%;
        }
        .classic);
            transform: skewX(-30deg);
            transition: all 0.3s cubic--btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronouncedbezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        . lift and scale */
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,2classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More55,255,0.2); /* Stronger shadow on hover */
        }
        .classic-btn pronounced lift and scale */
            box-shadow: 0 12px 24px rgba(0:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform:,0,0,0.6), inset 0 0 10px rgba(255, none;
            box-shadow: 0 8px 16px rgba(0,0,0255,255,0.2); /* Stronger shadow on hover */
        }
        ,0.4), inset 0 0 8px rgba(255,255,2.classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 16px rgba(055,0.1);
        }

        /* Specific Button Colors - Classic Pallette */
        .btn,0,0,0.4), inset 0 0 8px rgba(255,2-purple-classic {
            background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); /* Amethyst */
        }
        .btn-blue-55,255,0.1);
        }

        /* Specific Button Colors - Classic Pallette */
        .btn-purple-classic {
            background: linear-gradient(145deg, #8classic {
            background: linear-gradient(145deg, #4682B4 0A2BE2 0%, #6A0DAD 100%); /* Amethyst */
        }
        .%, #2A52BE 100%); /* Steel Blue / Royal Blue */
        }
        .btn-btn-blue-classic {
            background: linear-gradient(145deg, #4682green-classic {
            background: linear-gradient(145deg, #228B22B4 0%, #2A52BE 100%); /* Steel Blue / Royal Blue */
        }
 0%, #006400 100%); /* Forest Green */
        }
        .btn-red-classic {
            background: linear-gradient(145deg, #CD5C        .btn-green-classic {
            background: linear-gradient(145deg, #225C 0%, #B22222 100%); /* Indian Red / Firebrick */8B22 0%, #006400 100%); /* Forest Green */
        }
        .btn-red-classic {
            background: linear-gradient(145deg,
        }
        .btn-gray-classic {
            background: linear-gradient(145deg #CD5C5C 0%, #B22222 100%); /* Indian Red, #A9A9A9 0%, #808080 100%); /* / Firebrick */
        }
        .btn-gray-classic {
            background: linear-gradient( Dark Gray */
        }
        .btn-brown-classic { /* New for Profile/Shop */
            background:145deg, #A9A9A9 0%, #808080 1 linear-gradient(145deg, #8B4513 0%, #69320E 100%); /* Saddle Brown / Dark Sienna */
        }
        .btn-gold-00%); /* Dark Gray */
        }
        .btn-brown-classic { /* New for Profile/Shop */
            background: linear-gradient(145deg, #8B4513 0%, #classic { /* For footer icons */
            background: linear-gradient(145deg, #FFD769320E 100%); /* Saddle Brown / Dark Sienna */
        }
        .00 0%, #DAA520 100%); /* Gold */
            border: none; /* Nobtn-gold-classic { /* For footer icons */
            background: linear-gradient(145deg, border for these small buttons */
            padding: 0.5rem;
            border-radius: 1 #FFD700 0%, #DAA520 100%); /* Gold */
            border:0px;
        }
        .btn-gold-classic:hover {
            transform: translateY(-2px) none; /* No border for these small buttons */
            padding: 0.5rem;
            border- scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,radius: 10px;
        }
        .btn-gold-classic:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 1255,255,0.3);
        }


        /* Input Field Styles - More refined Classic Look2px rgba(0,0,0,0.5), inset 0 0 5px rgba( */
        input {
            background-color: #202020; /* Even darker input background255,255,255,0.3);
        }


        /* Input Field */
            border: 2px solid #5A5A5A; /* Dark gray border */
            color: #E0E0E0; /* Light text color */
            padding: 0.875rem; Styles - More refined Classic Look */
        input {
            background-color: #202020; /* Even darker input background */
            border: 2px solid #5A5A5A; /* Dark /* Equivalent to p-3.5 */
            border-radius: 0.75rem; /* Equivalent to gray border */
            color: #E0E0E0; /* Light text color */
            padding: rounded-xl */
            box-shadow: inset 0 2px 4px rgba(0,0,0, 0.875rem; /* Equivalent to p-3.5 */
            border-radius: 00.5); /* Inner shadow for depth */
        }
        input::placeholder {
            color: #.75rem; /* Equivalent to rounded-xl */
            box-shadow: inset 0 2px 4A0A0A0; /* Lighter placeholder text */
        }
        input:focus {
            px rgba(0,0,0,0.5); /* Inner shadow for depth */
        }
        border-color: #DAA520 !important; /* Gold border on focus */
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0input::placeholder {
            color: #A0A0A0; /* Lighter placeholder text */
        }
        input:focus {
            border-color: #DAA520 !important; /* Gold.5) !important, inset 0 2px 4px rgba(0,0,0,0 border on focus */
            box-shadow: 0 0 0 4px rgba(218.5) !important; /* Gold focus ring with inner shadow */
        }

        /* Header specific styles -, 165, 32, 0.5) !important, inset 0 2px Richer Gold/Brown */
        .app-header {
            background: linear-gradient(to right, #4 4px rgba(0,0,0,0.5) !important; /* Gold focus ring with innerA2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            border-bottom: 3px solid #FF shadow */
        }

        /* Header specific styles - Richer Gold/Brown */
        .app-headerD700; /* Thicker gold border */
            box-shadow: 0 8px 20px rgba {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/(0,0,0,0.7); /* Deeper shadow */
            height: 70px; /* Fixed height for header */
            position: fixed; /* Explicitly fixed */
            top: 0brown gradient */
            border-bottom: 3px solid #FFD700; /* Thicker gold border */
            box-shadow: 0 8px 20px rgba(0,0,0,0; left: 0; right: 0;
            z-index: 40;
            padding.7); /* Deeper shadow */
            height: 70px; /* Fixed height for header */
: 0.75rem 1rem; /* Adjust padding */
            display: flex;
            justify            position: fixed; /* Explicitly fixed */
            top: 0; left: 0; right: 0;-content: space-between;
            align-items: center;
        }
        /* Lobby Screen Specific Header */

            z-index: 40;
            padding: 0.75rem 1rem;        .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, /* Adjust padding */
            display: flex;
            justify-content: space-between;
            align- #7A4C00 50%, #4A2B00 100%);
            border-bottom: 3px solid #FFD700;
            box-shadow: 0items: center;
        }
        /* Lobby Screen Specific Header */
        .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C 8px 20px rgba(0,0,0,0.7);
            height: 00 50%, #4A2B00 100%);
            border-bottom:70px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem  3px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            height: 70px;
1rem;
            display: flex;
            align-items: center; /* Align items vertically */
                        position: fixed;
            top: 0; left: 0; right: 0;
            justify-content: center; /* Center horizontally by default */
        }
        .lobby-header .search-container {z-index: 40;
            padding: 0.75rem 1rem;
            
            display: flex;
            flex-grow: 1; /* Allow search container to take available space */display: flex;
            align-items: center; /* Align items vertically */
            justify-content: center; /* Center horizontally by default */
        }
        .lobby-header .search-container {
            display
            max-width: 600px; /* Limit max width on larger screens */
            margin: 0 auto; /* Center the search container */
            align-items: center;
            background-color: #3: flex;
            flex-grow: 1; /* Allow search container to take available space */
            max-width:03030; /* Darker background for search bar */
            border-radius: 15px 600px; /* Limit max width on larger screens */
            margin: 0 auto; /* Center; /* Rounded corners for search bar */
            border: 2px solid #5A5A5A;
            padding: 0.5rem 1rem; /* Adjust padding */
        }
        .lobby-header the search container */
            align-items: center;
            background-color: #303030; /* Darker background for search bar */
            border-radius: 15px; /* Rounded corners .search-container input {
            flex-grow: 1;
            background-color: transparent; /* for search bar */
            border: 2px solid #5A5A5A;
            padding: 0.5rem 1rem; /* Adjust padding */
        }
        .lobby-header .search-container Transparent background */
            border: none; /* No border for input inside search bar */
            padding: 0 input {
            flex-grow: 1;
            background-color: transparent; /* Transparent background */
.25rem 0.5rem;
            outline: none; /* No outline on focus */
            text-align            border: none; /* No border for input inside search bar */
            padding: 0.25rem 0.: right; /* Align text to right for RTL */
        }
        .lobby-header .search-container input5rem;
            outline: none; /* No outline on focus */
            text-align: right; /* Align::placeholder {
            color: #A0A0A0;
        }
        .lobby-header .search-container svg {
            color: #DAA520; /* Gold color for icons */
            min text to right for RTL */
        }
        .lobby-header .search-container input::placeholder {
-width: 24px; /* Ensure icons don't shrink */
            min-height: 2            color: #A0A0A0;
        }
        .lobby-header .search-container svg {
            color: #DAA520; /* Gold color for icons */
            min-width: 4px;
        }
        .lobby-header .search-container button {
            background: none;24px; /* Ensure icons don't shrink */
            min-height: 24px;

            border: none;
            cursor: pointer;
            padding: 0 0.5rem;
        }
        .lobby-header .back-btn-wrapper {
            margin-left: 1        }
        .lobby-header .search-container button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.5rem;
        }
0px; /* Space between back button and search bar (for RTL) */
        }
        .lobby-        .lobby-header .back-btn-wrapper {
            margin-left: 10px; /*header .search-icon-wrapper {
            margin-right: 10px; /* Space between search icon and search input (RTL) */
        }


        .app-footer {
            background: linear- Space between back button and search bar (for RTL) */
        }
        .lobby-header .search-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            icon-wrapper {
            margin-right: 10px; /* Space between search icon and search input (RTL) */
        }


        .app-footer {
            background: linear-gradient(to leftborder-top: 3px solid #FFD700; /* Thicker gold border */
            box, #4A2B00 0%, #7A4C00 50%, #4-shadow: 0 -8px 20px rgba(0,0,0,0.7);A2B00 100%); /* Richer gold/brown gradient */
            border-top: 3px /* Deeper shadow */
            height: 90px; /* Fixed height for footer */
            position: solid #FFD700; /* Thicker gold border */
            box-shadow: 0 -8px 2 fixed; /* Explicitly fixed */
            bottom: 0; left: 0; right: 0;0px rgba(0,0,0,0.7); /* Deeper shadow */
            height: 
            z-index: 40;
            padding: 1rem; /* Adjust padding */
            display: flex90px; /* Fixed height for footer */
            position: fixed; /* Explicitly fixed */
            bottom;
            justify-content: space-around;
            align-items: center;
        }
        : 0; left: 0; right: 0;
            z-index: 40;/* Lobby Screen Specific Footer */
        .lobby-footer {
            background: linear-gradient(to left, #4A
            padding: 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        /* Lobby Screen Specific Footer */
2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-top: 3px solid #FFD700;
        .lobby-footer {
            background: linear-gradient(to left, #4A2B00            box-shadow: 0 -8px 20px rgba(0,0,0,0. 0%, #7A4C00 50%, #4A2B00 107);
            height: 90px;
            position: fixed;
            bottom: 0;0%);
            border-top: 3px solid #FFD700;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
             left: 0; right: 0;
            z-index: 40;
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-height: 90px;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem;items: center;
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #FFD7
            display: flex;
            justify-content: space-around;
            align-items: center;00; /* Gold color for icons */
            font-size: 0.8rem;
            text
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex--align: center;
            cursor: pointer;
            transition: transform 0.2s ease-indirection: column;
            align-items: center;
            color: #FFD700; /* Gold color for icons */
            font-size: 0.8rem;
            text-align: center-out;
        }
        .lobby-footer .icon-btn:hover {
            transform: translateY(-5px);
        }
        .lobby-footer .icon-btn:disabled {
            opacity:;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
 0.5;
            cursor: not-allowed;
            transform: none;
        }
                }
        .lobby-footer .icon-btn:hover {
            transform: translateY(-5px);
        }
        .lobby-footer .icon-btn:disabled {
            opacity: 0.5.lobby-footer .icon-btn svg {
            width: 30px;
            height: ;
            cursor: not-allowed;
            transform: none;
        }
        .lobby-footer .icon-btn svg {
            width: 30px;
            height: 30px;30px;
            margin-bottom: 5px;
            transition: transform 0.8s ease-in-out;
        }
        .lobby-footer .games-running-text {
            color: #E0E0E0;
            font-size: 1.1rem;
            
            margin-bottom: 5px;
            transition: transform 0.8s ease-in-font-weight: bold;
            display: flex;
            align-items: center;
            gap:out;
        }
        .lobby-footer .games-running-text {
            color: #E 5px;
        }

        /* Main content area padding to avoid overlap with fixed header/footer */
0E0E0;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 90px; /* Footer height */
            flex-grow: 1; /* Allow content to
        }

        /* Main content area padding to avoid overlap with fixed header/footer */
        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 9 fill available space */
            overflow-y: hidden; /* Removed vertical scrollbars */
            overflow-x:0px; /* Footer height */
            flex-grow: 1; /* Allow content to fill available space */
             hidden; /* Ensure horizontal scrollbar is hidden for main content */
            width: 100%; /* Ensure it takes full width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start for scrollable lists */
            align-items: center; /* Center content horizontallyoverflow-y: hidden; /* Removed vertical scrollbars */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for main content */
            width: 100%; /* Ensure it takes full width */
 */
            background: linear-gradient(180deg, #2C2C2C 0%, #1            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start for scrollable lists */
            align-items: center; /* Center content horizontally */
            A1A1A 100%); /* Subtle dark grey gradient for main area */
            position: relativebackground: linear-gradient(180deg, #2C2C2C 0%, #1A1A1; /* For any absolute positioned elements inside */
        }
        
        /* Profile Modal specific styles */
        .profile-modal-overlay {
            background-color: rgba(0,0,0,0.7); /* Darker overlayA 100%); /* Subtle dark grey gradient for main area */
            position: relative; /* For any absolute positioned elements inside */
        }
        
        /* Profile Modal specific styles */
        .profile-modal-overlay { */
            transition: opacity 0.3s ease-in-out;
        }
        .profile
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
-modal-content {
            transform: translateY(-20px); /* Initial slightly elevated */
            transition: all             transition: opacity 0.3s ease-in-out;
        }
        .profile-modal0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .profile-modal-enter-active .profile-modal-content {
            transform-content {
            transform: translateY(-20px); /* Initial slightly elevated */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1: translateY(0);
        }
        .profile-modal-leave-active .profile-modal-content {
            transform: translateY(-20px);
            opacity: 0;
        }

        /* Create Lobby);
        }
        .profile-modal-enter-active .profile-modal-content {
            transform Modal Specific Styles */
        #create-lobby-modal {
            background-color: rgba(0,0,0: translateY(0);
        }
        .profile-modal-leave-active .profile-modal-content {
            transform: translateY(-20px);
            opacity: 0;
        }

        /*,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Confirmation Modal Styles */
        #confirmation-modal {
            background-color: rgba(0,0, Create Lobby Modal Specific Styles */
        #create-lobby-modal {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
0,0.7);
            transition: opacity 0.3s ease-in-out;
                }

        /* Confirmation Modal Styles */
        #confirmation-modal {
            background-color: rgba(}

        /* Animation for lobby items when closing */
        .lobby-item.fade-out {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.50,0,0,0.7);
            transition: opacity 0.3s ease-in-out;
        }

        /* Animation for lobby items when closing */
        .lobby-item.fade-s ease-out, transform 0.5s ease-out;
        }

        /* Enhanced Lobby Item Styling */
out {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity        .lobby-item {
            background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%); /* Deep gradient background */
             0.5s ease-out, transform 0.5s ease-out;
        }

        /* Enhanced Lobby Item Styling */
        .lobby-item {
            background: linear-gradient(145border: 2px solid #DAA520; /* Gold border */
            border-radius: deg, #2A2A2A 0%, #1A1A1A 100%);15px; /* Rounded corners */
            box-shadow: 0 8px 16px rgba /* Deep gradient background */
            border: 2px solid #DAA520; /* Gold border */
            border(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1); /* Deep outer shadow, subtle inner glow */
            transition-radius: 15px; /* Rounded corners */
            box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smooth transitions for hover effects */
            position: relative; /* For overflow hidden and pseudo- rgba(255,215,0,0.1); /* Deep outer shadow, subtle inner glow */
            transition: all 0.3s cubic-bezier(0.2, 0.8, elements */
            overflow: hidden; /* Ensures internal elements stay within rounded corners */
            padding: 1.0.2, 1); /* Smooth transitions for hover effects */
            position: relative; /* For overflow hidden and pseudo25rem 1.5rem; /* More generous padding */
            display: flex;
            flex-direction: column-elements */
            overflow: hidden; /* Ensures internal elements stay within rounded corners */
            padding: 1.25; /* Default to column for small screens */
            justify-content: space-between;
            align-items: center;rem 1.5rem; /* More generous padding */
            display: flex;
            flex-direction:
            text-align: center;
        }

        .lobby-item::before { /* Subtle light overlay column; /* Default to column for small screens */
            justify-content: space-between;
            align- on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
items: center;
            text-align: center;
        }

        .lobby-item::before { /* Subtle light overlay on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height:             transform: skewX(-30deg);
            transition: all 0.3s ease-in-out;
        }

        .lobby-item:hover::before {
            left: 100%;
        }

        100%;
            background: rgba(255,255,255,0.05);
            transform: skewX(-30deg);
            transition: all 0.3s ease-in.lobby-item:hover {
            transform: translateY(-8px) scale(1.02); /* More pronounced lift and slight scale */
            box-shadow: 0 15px 25px rgba-out;
        }

        .lobby-item:hover::before {
            left: 100%;
        }

        .lobby-item:hover {
            transform: translateY(-8px) scale(0,0,0,0.6), inset 0 0 12px rgba(25(1.02); /* More pronounced lift and slight scale */
            box-shadow: 0 15,215,0,0.2); /* Stronger shadow, more glow */
        }

        .lobby-item h3 {
            color: #FFD700; /* Gold for lobby names5px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2); /* Stronger shadow, */
            font-size: 1.75rem; /* Larger font for name */
            font-family: more glow */
        }

        .lobby-item h3 {
            color: #FFD70 'Playfair Display', serif;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }

        .lobby-item p {
            color0; /* Gold for lobby names */
            font-size: 1.75rem; /* Larger font for name */
            font-family: 'Playfair Display', serif;
            text-shadow: 1px 1px: #C0C0C0; /* Silver for details */
            font-size: 1rem; 3px rgba(0,0,0,0.7);
        }

        .lobby-item p {

            margin-top: 0.25rem;
        }
        
        .lobby-item .lobby            color: #C0C0C0; /* Silver for details */
            font-size: 1rem;
            margin-top: 0.25rem;
        }
        
        .lobby-actions { /* Container for buttons in lobby item */
            margin-top: 1rem; /* Space between text and buttons */
            display: flex;
            flex-direction: column; /* Stack buttons on mobile */
            width: 100%; /* Take full width on mobile */
            gap: 0.75rem;-item .lobby-actions { /* Container for buttons in lobby item */
            margin-top: 1rem; /* Space between text and buttons */
            display: flex;
            flex-direction: column; /* Stack buttons on mobile */ /* Space between stacked buttons */
        }

        /* Ensure buttons within lobby-item are full width on mobile */
            width: 100%; /* Take full width on mobile */
            gap: 0.75rem; /* Space between stacked buttons */
        }

        /* Ensure buttons within lobby-item are full width on mobile */
        .lobby-item .join-lobby-btn,
        .lobby-item .close-lobby-btn {
            width: 100%; /* Take full width on small screens */
            padding: 0.75rem 1rem; /* Consistent padding */
            font-size: 1rem; /* Consistent font size
        .lobby-item .join-lobby-btn,
        .lobby-item .close-lobby- */
        }

        /* Responsive adjustments for lobby-item buttons on larger screens */
        @media (min-width:btn {
            width: 100%; /* Take full width on small screens */
            padding: 0.75rem 1rem; /* Consistent padding */
            font-size: 1rem; /* Consistent font size 640px) { /* sm breakpoint */
            .lobby-item {
                flex-direction: row; /* Align items in a row */
                text-align: right; /* Text aligned right in RTL */
            }
 */
        }

        /* Responsive adjustments for lobby-item buttons on larger screens */
        @media (min-width: 640px) { /* sm breakpoint */
            .lobby-item {
                flex-direction            .lobby-item .lobby-actions {
                flex-direction: row; /* Buttons side-by-: row; /* Align items in a row */
                text-align: right; /* Text aligned right in RTL */
            }
            .lobby-item .lobby-actions {
                flex-direction: row; /*side */
                width: auto; /* Buttons take their natural width */
                margin-top: 0; /* No Buttons side-by-side */
                width: auto; /* Buttons take their natural width */
                margin-top:  top margin when side-by-side */
                gap: 0.5rem; /* Small gap between buttons */
            }
            /* Add margin-left to close button for spacing from join button */
            .lobby-item .close0; /* No top margin when side-by-side */
                gap: 0.5rem; /* Small gap between-lobby-btn {
                margin-right: 0.5rem; /* Space from join button in RTL buttons */
            }
            /* Add margin-left to close button for spacing from join button */
            .lobby-item .close-lobby-btn {
                margin-right: 0.5rem; /* Space from join */
            }
            .lobby-item .join-lobby-btn,
            .lobby-item .close-lobby-btn {
                width: auto; /* Allow buttons to size naturally */
                font-size: 0.9rem; /* Slightly smaller for compactness */
                padding: 0.6rem 1 button in RTL */
            }
            .lobby-item .join-lobby-btn,
            .lobby.2rem; /* Adjusted padding */
            }
        }

        /* === Lobby Detail Screen Styles (Major-item .close-lobby-btn {
                width: auto; /* Allow buttons to size naturally */
                font-size: 0.9rem; /* Slightly smaller for compactness */
                padding: 0.6rem  Redesign) === */
        .lobby-detail-screen-full {
            padding-top: 01.2rem; /* Adjusted padding */
            }
        }

        /* === Lobby Detail Screen Styles (Major Redesign) === */
        .lobby-detail-screen-full {
            padding-top: 0; /* No; /* No padding, the content will manage it */
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            width: 100%;
            height:  padding, the content will manage it */
            padding-bottom: 0;
            display: flex;
100%;
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }

        .lobby-detail            flex-direction: column;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }

        .lobby-detail-content {-content {
            background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%);
            border: 3px solid #DAA52
            background: linear-gradient(145deg, #1A1A1A 0%, #00;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.7);
            padding: 1.5rem;D0D0D 100%);
            border: 3px solid #DAA520;
            border-radius: 20px;
            box-shadow: 0 10px 2
            width: 95%;
            max-width: 1200px;
            height: calc(100% - 100px); /* Fill available space minus header/margins */
0px rgba(0,0,0,0.7);
            padding: 1.5rem;
            width: 95%;
            max-width: 1200px;
            height            display: flex;
            flex-direction: row; /* Side-by-side layout on desktop */
            gap: 1.5rem;
            margin: 50px auto; /* Centered with margin: calc(100% - 100px); /* Fill available space minus header/margins */
 top/bottom */
            overflow: hidden; /* Prevent content from spilling */
        }

        /* Sidebar for            display: flex;
            flex-direction: row; /* Side-by-side layout on desktop */
 player info */
        .lobby-sidebar {
            display: flex;
            flex-direction: column;            gap: 1.5rem;
            margin: 50px auto; /* Centered with margin top/bottom */
            overflow: hidden; /* Prevent content from spilling */
        }

        /* Sidebar for player info */
        .lobby-sidebar {
            display: flex;
            flex-direction: column;

            flex-shrink: 0;
            width: 300px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 15px;
                        flex-shrink: 0;
            width: 300px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding:padding: 1rem;
            border: 1px solid #444;
            overflow-y: auto;
        }

        /* Main panel for chat and actions */
        .lobby-main-panel {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 1rem;
            border: 1px solid #444;
            overflow-y: auto;
        }

        /* Main panel for chat and actions */
        .lobby-main-panel {
            display:
            min-width: 0; /* Flexbox fix for overflow */
        }
        
        #player-list flex;
            flex-direction: column;
            flex-grow: 1;
            min-width-container {
            margin-top: 1rem;
            flex-grow: 1; /* Allow list to: 0; /* Flexbox fix for overflow */
        }
        
        #player-list-container {
 take space */
            overflow-y: auto; /* Scroll if many players */
        }
        .player-list-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;            margin-top: 1rem;
            flex-grow: 1; /* Allow list to take space */
            overflow-y: auto; /* Scroll if many players */
        }
        .player-list
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            -item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            transition: all 0.2s ease-in-out;
        }
        .player-list-item.is-host {
            border-color: #FFD700;
        }
        justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        ..player-list-item .player-name {
            font-weight: bold;
            color: #player-list-item.is-host {
            border-color: #FFD700;
E0E0E0;
        }
        .player-list-item .host-label {
        }
        .player-list-item .player-name {
            font-weight: bold;
            color: #E0E0E0;
        }
        .player-list-item .host-label {
            color: #FFD700;
            font-size: 0.8            color: #FFD700;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        .kick-player-btn {
            background: none;
            border: 1px solid #B22222;
            color:rem;
            margin-right: 0.5rem;
        }
        .kick-player-btn {
            background: none;
            border: 1px solid #B22222; #B22222;
            border-radius: 5px;
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kick-player
            color: #B22222;
            border-radius: 5px;
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem-btn:hover {
            background: #B22222;
            color: white;
        }

        .lobby-chat-container {
            background-color: rgba(0,0,0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kick-player-btn:hover {
            background: #B22222;
            color,0.4);
            border: 2px solid #5A5A5A;
            border-radius: white;
        }

        .lobby-chat-container {
            background-color: rgba(0,0,: 10px;
            padding: 0.75rem;
            flex-grow: 0,0.4);
            border: 2px solid #5A5A5A;
            border-radius1; /* Key change: makes chat take all vertical space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* CRITICAL: This contains the scrolling child */
        }
        .lobby-chat-messages {
            flex-grow: 1; /* CRITICAL: This element grows to fill the: 10px;
            padding: 0.75rem;
            flex-grow: 1; /* Key change: makes chat take all vertical space */
            display: flex;
            flex-direction: column; parent */
            overflow-y: auto; /* CRITICAL: This element gets the scrollbar */
            padding
            overflow: hidden; /* CRITICAL: This contains the scrolling child */
        }
        .lobby-chat-messages {
            flex-grow: 1; /* CRITICAL: This element grows to fill the parent */
-right: 0.5rem;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            background-color: #333;
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            margin-bottom:            overflow-y: auto; /* CRITICAL: This element gets the scrollbar */
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
        }
        .chat 0.5rem;
            max-width: 80%;
            word-wrap: break--message {
            background-color: #333;
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            margin-bottom: word;
            align-self: flex-start;
            display: flex; /* NEW: Flex layout for message content0.5rem;
            max-width: 80%;
            word-wrap: break-word and delete button */
            align-items: center; /* NEW: Vertically align content and button */
            gap: 0.5rem; /* NEW: Space between message and button */
        }
        .chat-message.current-user {
            background-color: #4682B4;
            align-self;
            align-self: flex-start;
            display: flex; /* NEW: Flex layout for message content: flex-end;
            flex-direction: row-reverse; /* NEW: Puts delete button on the left for RTL */
        }
        .chat-message-content {
             flex-grow: 1 and delete button */
            align-items: center; /* NEW: Vertically align content and button */
            gap: 0.5rem; /* NEW: Space between message and button */
        }
        .chat-message.current-user {
            background-color: #4682B4;
            align-self: flex-end; /* NEW: Allows text content to take up available space */
        }
        .chat-message .sender-name {
            font-weight: bold;
            color: #FFD700;
            ;
            flex-direction: row-reverse; /* NEW: Puts delete button on the left for RTL */
        }
        .chat-message-content {
             flex-grow: 1; /* NEW: Allowsdisplay: block;
            font-size: 0.9em;
            margin-bottom: 0 text content to take up available space */
        }
        .chat-message .sender-name {
            font-weight.2rem;
        }
        .chat-message .message-text-deleted { /* NEW STYLE */: bold;
            color: #FFD700;
            display: block;
            font-
            font-style: italic;
            color: #999;
        }
        .delete-message-btn { /* NEW STYLE */
            background: none;
            border: none;
            colorsize: 0.9em;
            margin-bottom: 0.2rem;
        }
        .chat-message .message-text-deleted { /* NEW STYLE */
            font-style: italic;
            color: #999;
        }
        .delete-message-btn { /* NEW STYLE: #aaa;
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.5;
            transition: all 0.2s ease;
            flex-shrink: 0; */
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
 /* Prevent button from shrinking */
        }
        .chat-message:hover .delete-message-btn { /* NEW STYLE */
            opacity: 1;
        }
        .delete-message-btn:hover            padding: 0.25rem;
            opacity: 0.5;
            transition: all 0.2s ease;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .chat-message:hover .delete-message-btn { /* NEW STYLE */
            opacity: 1;
         { /* NEW STYLE */
            color: #ff6b6b;
            transform: scale(1.1);
        }

        .lobby-chat-input-form {
            margin-top: 0}
        .delete-message-btn:hover { /* NEW STYLE */
            color: #ff6b.75rem;
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0; /* CRITICAL: Prevents the input form from shrinking */
        }

        .lobby-actions6b;
            transform: scale(1.1);
        }

        .lobby-chat-input-form {
            margin-top: 0.75rem;
            display: flex;
            gap: -footer {
            flex-shrink: 0; /* Prevent shrinking */
            margin-top: 10.5rem;
            flex-shrink: 0; /* CRITICAL: Prevents the input form from shrinking */
rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .        }

        .lobby-actions-footer {
            flex-shrink: 0; /* Prevent shrinking */
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;start-game-btn {
            background: linear-gradient(145deg, #228B22 0%, #006400 100%);
            border: 2px
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .start-game-btn {
            background: linear-gradient(14 solid #DAA520;
            font-size: 1.1rem;
            padding: 0.6rem 1.2rem;
        }
        #host-actions-container {
             5deg, #228B22 0%, #006400 100%);
            border: 2px solid #DAA520;
            font-size: 1display: flex;
             flex-wrap: wrap;
             gap: 1rem;
        }

.1rem;
            padding: 0.6rem 1.2rem;
        }
                /* Custom Scrollbars */
        .lobby-sidebar::-webkit-scrollbar,
        #player-list-#host-actions-container {
             display: flex;
             flex-wrap: wrap;
             gap:container::-webkit-scrollbar,
        .lobby-chat-messages::-webkit-scrollbar { width: 8px; }
        .lobby-sidebar::-webkit-scrollbar-track,
        #player-list-container::-webkit-scrollbar-track,
        .lobby-chat-messages::-webkit-scrollbar-track { background: #202 1rem;
        }

        /* Custom Scrollbars */
        .lobby-sidebar::-webkit-scrollbar,
        #player-list-container::-webkit-scrollbar,
        .lobby-chat-messages::-webkit-scrollbar { width: 8px; }
        .lobby-sidebar::-webkit-scrollbar-track,
        #player-020; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb,
        #player-list-container::-webkit-scrollbar-thumb,
        .lobby-chat-list-container::-webkit-scrollbar-track,
        .lobby-chat-messages::-webkit-scrollbar-trackmessages::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px { background: #202020; border-radius: 4px; }
        .lobby-sidebar::-; }
        .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        #player-list-container::-webkit-scrollbar-thumb:hover,
        .lobby-chat-messages::-webkit-scrollbar-thumbwebkit-scrollbar-thumb,
        #player-list-container::-webkit-scrollbar-thumb,
        .lobby-chat-messages::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb:hover,
        #:hover { background: #FFD700; }
        
        /* ===== CORRECTED RESPONSIVE STplayer-list-container::-webkit-scrollbar-thumb:hover,
        .lobby-chat-messages::-webkitYLES ===== */
        @media (max-width: 860px) {
            .lobby-detail-content {
                flex-direction: column; /* Stack panels on smaller screens */
                height: calc(100% - 80px); /* Adjust height */
                margin: 40px auto;
-scrollbar-thumb:hover { background: #FFD700; }
        
        /* ===== CORRECTED RESPONSIVE STYLES ===== */
        @media (max-width: 860px)                padding: 1rem;
                overflow: hidden; /* ** THE MAIN FIX **: Prevent the whole card from scrolling */
            }
            .lobby-sidebar {
                width: 100%; /* Sidebar takes full width */ {
            .lobby-detail-content {
                flex-direction: column; /* Stack panels on smaller screens */
                height: calc(100% - 80px); /* Adjust height */
                margin: 40px auto;
                padding: 1rem;
                overflow: hidden; /* ** THE MAIN FIX **
                flex-shrink: 0; /* ** FIX **: Prevent sidebar from shrinking when keyboard opens */
                max-height: 250px; /* Limit sidebar height */
            }
            .lobby-main-panel {
                flex: Prevent the whole card from scrolling */
            }
            .lobby-sidebar {
                width: 100%;-grow: 1; /* ** FIX **: Allow panel to fill remaining vertical space */
                min-height: /* Sidebar takes full width */
                flex-shrink: 0; /* ** FIX **: Prevent sidebar from shrinking when keyboard 0; /* ** FIX **: Flexbox fix to allow shrinking properly */
            }
        }
        /* General Responsive */
        @media (max-width: 640px) {
            .max-w opens */
                max-height: 250px; /* Limit sidebar height */
            }
            .lobby-main-panel {
                flex-grow: 1; /* ** FIX **: Allow panel to fill remaining vertical space */
                min-height: 0; /* ** FIX **: Flexbox fix to allow shrinking properly */
-md { max-width: 95%; }
            .p-6, .p-8 {            }
        }
        /* General Responsive */
        @media (max-width: 640px padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header, .app-footer,) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-footer { padding: 0.5rem; }
            .app-header, .lobby-header { height: 60px; }
            .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 8 .lobby-header, .app-footer, .lobby-footer { padding: 0.5rem; }
            .app-header, .lobby-header { height: 60px; }
            .app0px; }
            .lobby-detail-content { margin: 20px auto; height: calc(100% - 40px); }
        }
        
        /* Lobby Type Toggle Styles-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; }
            .lobby */
        .lobby-type-btn { padding: 0.5rem 1.5rem; border: 2-detail-content { margin: 20px auto; height: calc(100% - 4px solid #DAA520; border-radius: 10px; transition: all 0.2s ease0px); }
        }
        
        /* Lobby Type Toggle Styles */
        .lobby-type--in-out; background-color: transparent; color: #DAA520; font-weight: bold; }
        .lobby-type-btn.active { background-color: #DAA520; colorbtn { padding: 0.5rem 1.5rem; border: 2px solid #DAA520; border-radius: 10px; transition: all 0.2s ease-in-out; background-color: #1A1A1A; box-shadow: 0 0 10px rgba(255: transparent; color: #DAA520; font-weight: bold; }
        .lobby-,215,0,0.5); }
        .lobby-lock-icon { width: 1.2rem; height: 1.2rem; margin-left: 0.5rem; color: #FFD700; display: inline-block; vertical-align: middle; }

        /* === Gametype-btn.active { background-color: #DAA520; color: #1A1A1A; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .lobby-lock-icon { width: 1.2rem; height: Screen Styles (REDESIGNED) === */
        #game-screen {
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 10 1.2rem; margin-left: 0.5rem; color: #FFD700; display: inline-block; vertical-align: middle; }

        /* === Game Screen Styles (REDESIGNED) ===0%);
            transform-style: preserve-3d;
            perspective: 2000px;
         */
        #game-screen {
            background: radial-gradient(ellipse at bottom, #100}
        #game-table {
            background: #6B4F35; /* Fallback color for theC08 0%, #000000 100%);
            transform-style: wooden table */
            background-image: radial-gradient(ellipse at center, rgba(160, 127, 92, 0.8) 0%, rgba(74, 51, 3 preserve-3d;
            perspective: 2000px;
        }
        #game-table {
            background: #6B4F35; /* Fallback color for the wooden table */
            background-image: radial-gradient(ellipse at center, rgba(160, 127, 92,2, 0.9) 100%),
                              repeating-linear-gradient(45deg, transparent 0.8) 0%, rgba(74, 51, 32, 0.9) 100%),
                              repeating-linear-gradient(45deg, transparent, transparent 10px, rgba, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px);
            border: 15px solid #4A3320;
            border-image-source: linear-gradient(145deg, #4A3320,(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px);
            border: 15px solid #4A3320;
            border-image-source: linear #8C6F4F, #4A3320);
            border-image-slice: 1;
            box-shadow: 0 25px 50px -12px rgba-gradient(145deg, #4A3320, #8C6F4F, #4A3320);
            border-image-slice: 1;
            box-shadow(0, 0, 0, 0.85), inset 0 0 40px rgba(0,0,0,0.7);
            border-radius: 100px;: 0 25px 50px -12px rgba(0, 0, 0
            transform-style: preserve-3d;
            position: relative;
        }
        .player-slot {, 0.85), inset 0 0 40px rgba(0,0,0,
            transform-style: preserve-3d; /* Allows child transforms to work correctly */
        }

        /* NEW: Player Info Pod Styling */
        .player-area-container {
            display: flex;
            flex-0.7);
            border-radius: 100px;
            transform-style: preserve-3d;
            position: relative;
        }
        .player-slot {
            transform-styledirection: column;
            align-items: center;
            gap: 0.5rem; /* 8px */
            padding: 0.5rem; /* 8px */
            border-radius:: preserve-3d; /* Allows child transforms to work correctly */
        }

        /* NEW: Player Info Pod Styling */
        .player-area-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem; /* 8px */
            padding: 0.5rem; /* 8px */
            border-radius: 12px 12px;
            transition: all 0.3s ease-in-out;
            z-index: 10;
        }
        .player-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #333, #111);
            border: 3px solid #DAA520;
            ;
            transition: all 0.3s ease-in-out;
            z-index: 10;
        }
        .player-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #333border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #FFD700;
            box-shadow: inset 0 , #111);
            border: 3px solid #DAA520;
            border3px 6px rgba(0,0,0,0.6), 0 2px 4px rgba-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #FFD700;
            box-shadow: inset 0 3(0,0,0,0.4);
        }
        .player-avatar svg {
            width: 32px;
            height: 32px;
        }
        .player-name-display {
            color: white;
            font-weight: bold;
            text-shadow:px 6px rgba(0,0,0,0.6), 0 2px 4px rgba(0,0,0,0.4);
        }
        .player-avatar svg {
 2px 2px 3px #000;
            background: rgba(0,0,0,            width: 32px;
            height: 32px;
        }
        .player-name-display {
            color: white;
            font-weight: bold;
            text-shadow0.5);
            padding: 0.2rem 0.8rem;
            border-radius: 8: 2px 2px 3px #000;
            background: rgba(0,0,0,0.5);
            padding: 0.2rem 0.8rem;
            px;
        }
        .player-slot.active-turn .player-area-container {
            transform: scale(1.1);
            background-color: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 25px rgba(2border-radius: 8px;
        }
        .player-slot.active-turn .player-area-container {
            transform: scale(1.1);
            background-color: rgba(2555, 215, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5);
        }5, 215, 0, 0.1);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8),
         .player-slot.active-turn .player-name-display {
             color: #FFD 0 0 10px rgba(255, 255, 255,700;
        }

        .player-slot .player-hand {
            display: flex;
 0.5);
        }
         .player-slot.active-turn .player-name-display {
             color: #FFD700;
        }

        .player-slot .player-hand {
            perspective: 800px; /* Adds depth to card arrangements */
        }

        /* Styles for playing cards */
        .card {
            width: 70px;
            height: 100px;
            background-color: white;
            border: 1px solid #333;
            border            display: flex;
            perspective: 800px; /* Adds depth to card arrangements */
        }

        /* Styles for playing cards */
        .card {
            width: 70px;
            height: 100px;
            background-color: white;
            border: 1px solid-radius: 6px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify #333;
            border-radius: 6px;
            box-shadow: 2px 2px-content: space-between;
            align-items: center;
            padding: 5px;
            font-size: 24px;
            font-weight: bold;
            user-select: none;
 5px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.2s ease-out;
            position: relative;
        }
        .card.back {
            background-image: linear-gradient(135deg, #4B0            user-select: none;
            transition: all 0.2s ease-out;
            position: relative000, #800000); /* Rich red back */
            border: 2px;
        }
        .card.back {
            background-image: linear-gradient(135deg, # solid #DAA520;
        }
        .card.red { color: #DC2626; } /* Tailwind Red-600 */
        .card.black { color: #11184B0000, #800000); /* Rich red back */
            border: 2px solid #DAA520;
        }
        .card.red { color: #DC2627; } /* Tailwind Gray-900 */
        .card-rank { font-family: 'Playfair Display', serif; }
        .card-suit { font-size: 20px; }
        .card-suit.top { transform: rotate(0deg); }
        .card-suit.bottom {26; } /* Tailwind Red-600 */
        .card.black { color: #111827; } /* Tailwind Gray-900 */
        .card-rank { font-family transform: rotate(180deg); }

        /* My hand cards (bottom player) */
        #player-slot-bottom .player-hand {
             gap: -35px; /* Overlap cards */: 'Playfair Display', serif; }
        .card-suit { font-size: 20px; }
        .card-suit.top { transform: rotate(0deg); }
        .card-suit.bottom { transform: rotate(180deg); }

        /* My hand cards (bottom player)
             margin-top: -30px; /* Pull cards up slightly over the table edge */
        }
        #player-slot-bottom .card:not(.back) {
            cursor: pointer;
         */
        #player-slot-bottom .player-hand {
             gap: -35px; /* Overlap cards */
             margin-top: -30px; /* Pull cards up slightly over the table edge}
        #player-slot-bottom .card:not(.back):hover {
            transform: translateY(- */
        }
        #player-slot-bottom .card:not(.back) {
            cursor:20px) scale(1.05);
            z-index: 100; /* Bring pointer;
        }
        #player-slot-bottom .card:not(.back):hover {
            transform: translateY(-20px) scale(1.05);
            z-index: 10 hovered card to front */
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }
        
        /* Side players' hands & info pods */
        #player-slot-left, #player-slot-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        #player-slot-0; /* Bring hovered card to front */
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }
        
        /* Side players' hands & inforight {
             flex-direction: row-reverse;
        }
        #player-slot-left .player-hand, #player-slot-right .player-hand {
            flex-direction: column;
 pods */
        #player-slot-left, #player-slot-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        #player-slot-right {
             flex-direction: row-reverse;
        }
        #player-            gap: -80px; /* Overlap vertical cards */
        }

        /* Top player's hand & info pod */
        #player-slot-top .player-area-container {
             flex-direction: column-reverse;
        }
        #player-slot-top .player-hand {
             slot-left .player-hand, #player-slot-right .player-hand {
            flex-direction: column;
            gap: -80px; /* Overlap vertical cards */
        }

        /* Top player's hand & info pod */
        #player-slot-top .player-area-container {gap: -35px; /* Overlap cards */
             margin-bottom: -30px;
        }
        
        /* Cards in the play area */
        #play-area {
            transform-style: preserve
             flex-direction: column-reverse;
        }
        #player-slot-top .player-hand {
             gap: -35px; /* Overlap cards */
             margin-bottom: -3-3d;
            perspective: 1000px;
        }
        #play-area0px;
        }
        
        /* Cards in the play area */
        #play-area { .card {
            position: absolute;
            transform: none; /* Reset hover transforms */
            box-
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        shadow: 0 8px 16px rgba(0,0,0,0.5);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0#play-area .card {
            position: absolute;
            transform: none; /* Reset hover transforms */
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        /* Positioning and rotation for played cards */
        #.2, 1);
        }
        /* Positioning and rotation for played cards */
        #play-area .played-card-bottom {
            bottom: -50px;
            transform: translateY(0);
play-area .played-card-bottom {
            bottom: -50px;
            transform: translateY(0);
        }
        #play-area .played-card-left {
            left: -        }
        #play-area .played-card-left {
            left: -50px;
            transform: rotate(90deg) translateX(-50%) translateY(50%);
            transform-origin: center;
        }
        #play-area .played-card-top {
            top: -5050px;
            transform: rotate(90deg) translateX(-50%) translateY(50%);
            transformpx;
            transform: rotate(180deg);
        }
        #play-area .played-card-right {
            right: -50px;
            transform: rotate(-90deg)-origin: center;
        }
        #play-area .played-card-top {
            top: -50px;
            transform: rotate(180deg);
        }
        #play-area .played-card-right {
            right: -50px;
            transform: rotate(- translateX(50%) translateY(50%);
            transform-origin: center;
        }

        /* General player slot positioning */
        #player-slot-bottom { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; }
90deg) translateX(50%) translateY(50%);
            transform-origin: center;
        }

        /* General player slot positioning */
        #player-slot-bottom { bottom: 20px        #player-slot-top { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center;}
        #player-slot-left; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; }
        #player-slot-top { top: 20px; left: 50 { left: 40px; top: 50%; transform: translateY(-50%); }
        #player-slot-right { right: 40px; top: 50%; transform: translateY(-%; transform: translateX(-50%); flex-direction: column; align-items: center;}
        #player-slot-left { left: 40px; top: 50%; transform: translateY(-5050%); }

        @media (max-width: 768px) {
            .card { width:%); }
        #player-slot-right { right: 40px; top: 50%; 50px; height: 75px; font-size: 18px; border-radius transform: translateY(-50%); }

        @media (max-width: 768px) {
            .card { width: 50px; height: 75px; font-size: 18px; border-radius: 4px; }
            .card-suit { font-size: 16px: 4px; }
            .card-suit { font-size: 16px; }
            #player-slot-bottom .player-hand, #player-slot-top .player-hand { gap: -25px; }
            #player-slot-left .player-hand, #player-slot-right .; }
            #player-slot-bottom .player-hand, #player-slot-top .player-hand { gap: -25px; }
            #player-slot-left .player-hand, #player-slot-right .player-hand { gap: -60px; }
             #player-slot-bottomplayer-hand { gap: -60px; }
             #player-slot-bottom { bottom: 10px; }
            #player-slot-top { top: 10px; }
            #player-slot-left { left: 10px; }
            #player-slot-right { right: 10px; }
            .player-avatar { width: 50px; height: { bottom: 10px; }
            #player-slot-top { top: 10px; }
            #player-slot-left { left: 10px; }
            #player- 50px; }
            .player-avatar svg { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>

    <!-- Main containerslot-right { right: 10px; }
            .player-avatar { width: 50px; height: 50px; }
            .player-avatar svg { width: 24px for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-; height: 24px; }
        }
    </style>
</head>
<body>

center">

        <!-- 1. Loading Screen - MODIFIED -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen-transition-active page-transition-visible" tabindex="-1">
            <!-- Container for standard loading spinner and text -->
            " class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900<div id="loading-spinner-container">
                <div class="spinner mb-4"></div>
                <p z-50 page-transition-active page-transition-visible" tabindex="-1">
            <!-- This part id="loading-text" class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
            </div>
            <!-- Container for "App Closed" message, hidden by default -->
            <div id="app-closed-message-container" class="hidden text-center shows during initial check -->
            <div id="loading-spinner-container">
                <div class="spinner mb-4"></div>
                <p id="loading-text" class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
            </div>

            <!-- NEW: p-4 max-w-lg mx-auto">
                <h2 class="text-3xl text This panel is shown if the app is closed by admin -->
            <div id="app-closed-panel" class="hidden classic-card p-6 sm:p-8 w-11/12 max-w-md text-red-400 font-bold mb-4">توجه</h2>
                <div class="classic-card p-6 bg-red-900 border-red-500">
                    <p id="app-closed-message" class="text-lg text-gray-200">اپلیکیشن توسط مدیر-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-400">توجه</h2>
                <p id="app-closed-message" class=" بسته شده است.</p>
                </div>
            </div>
        </div>


        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justifytext-lg text-white">این برنامه به طور موقت توسط مدیر بسته شده است. لطفاً بعداً دوباره تلاش کنید.</p>
            </div>
        </div>

        <!-- 2. Authentication Screen (Login/Register) -->-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden6 sm:p-8 w-11/12 max-w-md text-center">
                " tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-<h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="<input type="email" id="email" placeholder="ایمیل شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="email" placeholder="ایمیل شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-fieldtext" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    " class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-<div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کار500">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="اکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <!-- Toggle buttons for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 smرمز عبور (حداقل ۶ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <!-- Toggle buttons:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4" id="login-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn"
                                class="w-full sm:-blue-classic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth-btn"
                            class="w-full mt-
                                class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth4 classic-btn btn-purple-classic text-xl sm:text-2xl hidden">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message--btn"
                            class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:textbox" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert">-2xl hidden">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3</div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info andtransition-hidden" tabindex="-1">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info and ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg"0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle">
                        <circle width="24" height="24" viewBox="0 0 24 24" fill=" cx="12" cy="12" r="10"/><circle cx="12" cy="1none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"0" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1  class="lucide lucide-user-circle">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                    2 2v1.662"/>
                    </svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <!--</svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        < Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.orgspan id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <!-- Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap=" hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="round" stroke-linejoin="round" class="lucide lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide4" x2="20" y1="6" y2="6"/><line x1="4" lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" x2="20" y1="18" y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer --> y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text
            <div class="main-content-area">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer">
                <button id="friendly-game-btn"
                        class="classic-btn btn-purple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">
                    بازی دوستان را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer">
                <button id="friendly-game-btn"
                        class="classic-btn btn-ه
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="classic-btn btn-brown-classic text-base sm:textpurple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5-lg w-1/2 mx-2 py-3.5 px-4">
                    بازی امتیا px-4">
                    بازی دوستانه
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="classic-btn btn-brown-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-زی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
4">
                    بازی امتیازی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">                    <button id="back-to-main-btn" class="p-1">
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="2-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
                            <path d="M5 12h14"/><path d="m12 5 7 4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow7-7 7"/>
                        </svg>
                    </button>
                    <input type="text"-right">
                            <path d="M5 12h14"/><path d="m12 id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p 5 7 7-7 7"/>
                        </svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، ساز-1">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 2نده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <!-- Search icon -->
                        <svg xmlns="http://4 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                            <circle cx="11www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="" cy="11" r="8"/><path d="m21 21-4.3-2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
4.3"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                        </svg>
                    </button>
                </div>-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div idy-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add="lobbies-list" class="space-y-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p class="text-gray-400">در حال بارگذاری ل-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0ابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap                    <svg xmlns="http://www.w3.org/2000/svg" width="2="round" stroke-linejoin="round" class="lucide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg4" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="luc>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 ide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>

                    <svg xmlns="http://www.w3.org/2000/svg" width="                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke- 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Profile Modal (Hidden by default) -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z- id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Profile Modal (Hidden by default) -->
        <div id="profile-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <hmodal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                <button id="svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucclose-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"ide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div class="text-lg space-y-4 mb-8 text-white">
                    <p><strong>نام stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div class="text-lg space نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شنا-y-4 mb-8 text-white">
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-سه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                    <!-- Add more profile stats here later (e.gemail">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="., wins, losses) -->
                </div>
                <button id="profile-logout-btn"
                        classprofile-uid" class="break-all text-sm text-gray-400">---</span></p>
                    <!-- Add more profile stats here later (e.g., wins, losses) -->
                </div>
                <button id="profile-logout-btn"
                        class="w-full classic-btn btn-red-classic text-="w-full classic-btn btn-red-classic text-lg sm:text-xl">
                    خروج از حساب
                </button>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        lg sm:text-xl">
                    خروج از حساب
                </button>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"><div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text- top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-" width="28" height="28" viewBox="0 0 24 24" fillwhite hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-</button>
                <form id="create-lobby-form" class="space-y-5">
                    <div>
                        <input type="text" id="new-lobby-name-input" placeholder="نام لx">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">
                    <div>
                        <input type="ابی شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500"
                               required>
                    </div>
        
                    <!-- NEW: Lobby Type Toggle (text" id="new-lobby-name-input" placeholder="نام لابی شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500"
                               Public/Private) -->
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer">
                            <required>
                    </div>
        
                    <!-- NEW: Lobby Type Toggle (Public/Private) -->
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-typeinput type="radio" name="lobby-type" value="public" class="sr-only" checked>
-toggle">
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
-type" value="public" class="sr-only" checked>
                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
                    </div>
        
                    <!--                    </div>
        
                    <!-- NEW: Password field for private lobbies (initially hidden) -->
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 NEW: Password field for private lobbies (initially hidden) -->
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 pr-10">
                         pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/20<button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width00/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-13"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-0/svg" width="20" height="20" viewBox="0 0 24 2linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.4308A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.6 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="1A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
        
                    <button type="submit" id="submit-create-lobby-btn"
                            class="0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
        
                    w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-<button type="submit" id="submit-create-lobby-btn"
                            class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساختlobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text- لابی
                    </button>
                </form>
                <div id="create-lobby-message-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">تایید عملیات</h2>
                <p id="confirm--confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">تایید عملیات</h2>
                <p id="confirm-message"message" class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse"> class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED) -->
        <div id="بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED) -->
        <div id="lobby-detail-screen"lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                
                <!-- Sidebar: Lobby Info & Players -->
                <div class="lobby-sidebar">
 class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-                <!-- Sidebar: Lobby Info & Players -->
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold textname" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
 mb-4">بازیکنان: 0/4</p>
                    
                    <div class="w-                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-full h-px bg-yellow-600 mb-4"></div>

                    <div id="player-list-container">
                        <!-- Player list items will be dynamically loaded here -->
                    </div>
                </div>

                <!-- Main Panel:4">بازیکنان: 0/4</p>
                    
                    <div class="w-full h-px bg-yellow-600 mb-4"></div>

                    <div id="player-list-container">
                        <!-- Player list items will be dynamically loaded here -->
                    </div>
                </div>

                <!-- Main Panel: Chat & Actions -->
                <div class="lobby-main-panel">
                    <!-- Chat Container -->
                    <div class=" Chat & Actions -->
                <div class="lobby-main-panel">
                    <!-- Chat Container -->
                    <div class="lobby-chat-container">
                        <div id="lobby-chat-messages" class="lobby-chat-messages">
                            <!-- Chat messages will appear here -->
                        </div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form">
                            <input type="text" idlobby-chat-container">
                        <div id="lobby-chat-messages" class="lobby-chat-messages">
                            <!-- Chat messages will appear here -->
                        </div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form">
                            <input type="text" id="lobby-chat-input="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py py-2 px-4">ارسال</button>
                        </form>
                    </div>

                    <!-- Action Buttons Footer -->
                    <div class="lobby-actions-footer">
                        <div id="host-actions-2 px-4">ارسال</button>
                        </form>
                    </div>

                    <!-- Action Buttons Footer -->
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style-container" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled>
                                شروع بازی
                            </button>
                             <button id="toggle-="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btnchat-lock-btn" class="classic-btn btn-gray-classic text-sm py-2 px-" disabled>
                                شروع بازی
                            </button>
                             <button id="toggle-chat-lock-4">
                                قفل کردن چت
                            </button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4">
                                لیست اخراجی‌ها
                            </button>
                        </div>
                        <button id="leave-lobby-btnbtn" class="classic-btn btn-gray-classic text-sm py-2 px-4">
                                قفل کردن چت
                            </button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4">
                                لیست اخراجی‌ها
                            </button>
                        </div>
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4 hidden">
                            بستن ل" class="classic-btn btn-red-classic text-sm py-2 px-4 hidden">
                            بستن لابی
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- 9. Game Screen (REDESIGNED) -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden flex flex-col items-center justify-center p-2" tabindex="-1">
            <!-- Game Header: Score, Hokm, etc.ابی
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- 9. Game Screen (REDESIGNED) -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden flex flex-col items-center justify-center p -->
            <div class="absolute top-0 left-0 right-0 h-20 bg-black bg-opacity-40 flex justify-between items-center px-4 z-20">
                <div id="game-team-scores" class="text-white text-lg font-bold">
                    <span>تیم-2" tabindex="-1">
            <!-- Game Header: Score, Hokm, etc. -->
            <div class="absolute top-0 left-0 right-0 h-20 bg-black bg-opacity-40 flex justify-between items-center px-4 z-20">
                <div id="game-team-scores" class="text-white text-lg font-bold">
                    <span>تیم ما: <span ما: <span id="our-team-score" class="text-xl text-green-300">0</span></span> |
                    <span>تیم حریف: <span id="their-team-score" class="text-xl text-red-300">0</span></span>
                </div>
                <div id=" id="our-team-score" class="text-xl text-green-300">0</span></span> |
                    <span>تیم حریف: <span id="their-team-score" class="text-xl text-red-300">0</span></span>
                </div>
                <div id="game-hokm-indicator"game-hokm-indicator" class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-xl font-bold text-yellow-300">حکم:</span>
                    <span id="hokm-suit-icon" class="text-4xl">❓</span>
                 class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-xl font-bold text-yellow-300">حکم:</span>
                    <span id="hokm-</div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی</button>
            </div>

            <!-- Main Game Table -->
            <div idsuit-icon" class="text-4xl">❓</span>
                </div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی="game-table" class="relative w-[98vw] h-[85vh] max-w-[1200px] max-h-[800px] flex items-center justify-center">
                </button>
            </div>

            <!-- Main Game Table -->
            <div id="game-table" class="relative w-[98vw] h-[85vh] max-w-[1200px]<!-- Center play area -->
                <div id="play-area" class="absolute w-80 h-48 flex items-center justify-center">
                    <!-- Cards played in the current trick will appear here -->
                </div> max-h-[800px] flex items-center justify-center">
                <!-- Center play area -->
                <div id="play-area" class="absolute w-80 h-48 flex items-center justify

                <!-- Player Slots -->
                <div id="player-slot-bottom" class="player-slot absolute-center">
                    <!-- Cards played in the current trick will appear here -->
                </div>

                <!-- Player Slots">
                    <div class="player-area-container">
                        <div class="player-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke -->
                <div id="player-slot-bottom" class="player-slot absolute">
                    <div class="player-area-container">
                        <div class="player-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svgwidth="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 >
                        </div>
                        <span class="player-name-display">شما</span>
                    </div>
                    <div class="player-hand flex justify-center">
                        <!-- Player's cards generated by JS -->
21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">شما</span>
                    </div>
                    <div class="player-hand flex justify                    </div>
                </div>

                <div id="player-slot-left" class="player-slot absolute">-center">
                        <!-- Player's cards generated by JS -->
                    </div>
                </div>

                <div
                    <div class="player-hand flex justify-center">
                         <!-- Opponent's cards (face down) -->
                    </div>
                    <div class="player-area-container">
                        <div class="player-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" id="player-slot-left" class="player-slot absolute">
                    <div class="player-hand flex justify-center">
                         <!-- Opponent's cards (face down) -->
                    </div>
                    <div class="player-area-container">
                        <div class="player-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke- width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">بازیکن ۲</span>
width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">بازیکن ۲</span>
                    </div>
                </div>

                <                    </div>
                </div>

                <div id="player-slot-top" class="player-slot absolute">
                     <div class="player-area-container">
                        <div class="player-avatar">
                             div id="player-slot-top" class="player-slot absolute">
                     <div class="player-area-container">
                        <div class="player-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circleM20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">یار شما</span>
                    </div>
                     cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class<div class="player-hand flex justify-center">
                        <!-- Partner's cards (face down) -->
                    </div>
                </div>

                <div id="player-slot-right" class="player-slot absolute">
                    ="player-name-display">یار شما</span>
                    </div>
                    <div class="player-hand flex justify-center">
                        <!-- Partner's cards (face down) -->
                    </div>
                </div>

                <div id<div class="player-hand flex justify-center">
                        <!-- Opponent's cards (face down) -->
                    </div>
                    <div class="player-area-container">
                        <div class="player-="player-slot-right" class="player-slot absolute">
                    <div class="player-hand flex justify-center">
                        <!-- Opponent's cards (face down) -->
                    </div>
                    <divavatar">
                             <svg xmlns="http://www.w3.org/2000/svg" class="player-area-container">
                        <div class="player-avatar">
                             <svg xmlns=" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">بازیکن ۴</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10. Kick Player Confirmation Modal -->
        <width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        </div>
                        <span class="player-name-display">بازیکن ۴</span>
                    </div>
                </div>
            </div>
        div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center</div>

        <!-- ... All other modals (kick, kicked message, etc.) remain the same ... -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal- relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">اخراج بازیکن</h2>
                <button id="close-kick-player-confirmcontent p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb--modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.6 text-yellow-300">اخراج بازیکن</h2>
                <button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-3org/2000/svg" width="28" height="28" viewBox="0 000 transition-colors duration-200">
                    <svg xmlns="http://www.w3. 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <p class="text-lg mb-8 text-white">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p>
                <div class="flex justify-around"/>
                    </svg>
                </button>
                <p class="text-lg mb-8 text-white">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p>
                <div class space-x-4 space-x-reverse">
                    <button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button>
="flex justify-around space-x-4 space-x-reverse">
                    <button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button                    <button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                </div>
            </div>
        </div>

        <!-- 11. Kicked Message Modal -->
        <div id="kicked-message-modal" class="hidden>
                    <button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                </div>
            </div>
        </div>
        <div id fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-12 max-w-md text-center relative">
                <h2 class="text-2xl sm50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-40:text-3xl font-bold mb-6 text-red-400">شما اخراج شدید!</h2>
                <p id="kicked-message-text" class="text-lg mb-8 text0">شما اخراج شدید!</h2>
                <p id="kicked-message-text" class="text-lg mb-8 text-white">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p>
                <button-white">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p>
                <button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button>
            </div>
        </div>

        <!-- 12. Kicked Players List Modal -->
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text">متوجه شدم</button>
            </div>
        </div>
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">لیست بازیکنان اخراج شده</h2>
                <button id="close-kicked-players-list-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">لیست بازیکنان اخراج شده</h2>
                <button id="-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0close-kicked-players-list-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide- 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div id="kicked-players-list-content" class="space-y-4 mb-8 text-white text-left max-h-60 overflow-y-auto custom-scrollbar">
                    <!-- Kicked players will be dynamically"/>
                    </svg>
                </button>
                <div id="kicked-players-list-content" class="space-y-4 mb-8 text-white text-left max-h-60 overflow-y-auto custom-scrollbar">
                    <p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p>
                </div>
                <button id="k loaded here -->
                    <p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p>
                </div>
                <button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button>
            </div>
        icked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button>
            </div>
        </div>
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            </div>
        
        <!-- 13. Enter Password Modal (for private lobbies) -->
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6<div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی-3xl font-bold mb-4">ورود به لابی خصوصی</h2>
                <p class="text-lg mb-6 text-white">لابی <span id="password-prompt-lobby-name" class="font- خصوصی</h2>
                <p class="text-lg mb-6 text-white">لابی <span id="password-bold text-yellow-300"></span> نیاز به رمز عبور دارد.</p>
                <form idprompt-lobby-name" class="font-bold text-yellow-300"></span> نیاز به رمز عب="enter-password-form" class="space-y-5">
                    <div>
                        <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید"
                               classور دارد.</p>
                <form id="enter-password-form" class="space-y-5">
                    <div>
                        <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                               required>
                    </div>
                    <div="w-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                               required>
                    </div>
                    <div class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 classic- class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="btn btn-gray-classic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKmt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {s you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // REVISED: Imported deleteField for updating player maps
        import { getFirestore, doc        // REVISED: Imported deleteField for updating player maps
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField } from "https://www.gstatic.com/firebasejs, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Firebase Configuration (from user's input)
        // **IMPORTANT**: You should replace these with your actual Firebase project configuration.
        const firebase/11.6.1/firebase-firestore.js"; 

        // Firebase Configuration (from user's input)
        // **IMPORTANT**: You should replace these with your actual Firebase project configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128owsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);// Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase context (as per environment instructions)
        const db = getFirestore(app);

        // Global variables for Firebase context (as per environment instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements
        const loadingScreen = document.getElementById('loading-token : null;

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('mainscreen');
        // NEW: Elements for the app status check
        const loadingSpinnerContainer = document.getElementById('loading-spinner-container');
        const appClosedPanel = document.getElementById('app-closed-panel');
        const app-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameFieldClosedMessage = document.getElementById('app-closed-message');

        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth- = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('btn');
        const messageBox = document.getElementById('message-box'); 

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const friendlyGameBtn = document.getElementById('friendlygetElementById('message-box'); 

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.-game-btn');
        const ratedGameBtn = document.getElementById('rated-game-btn');

        getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');// Lobby Screen UI Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen UI Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn'); // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Profile Modal Elements
        const profileModal = document.getElementById('-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn');profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        // Create Lobby Modal Elements
        const create // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Profile Modal Elements
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-LobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = documentdisplay-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        // Create Lobby Modal Elements
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const submitCreateL        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field');
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');obbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field');
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibility
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');

        // Custom Confirmation Modal Elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        constBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');

        // Custom Confirmation Modal Elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById(' Lobby Detail Screen Elements (UPDATED)
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName =confirm-no-btn');

        // Lobby Detail Screen Elements (UPDATED)
        const lobbyDetailScreen = document.getElementById document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const toggleChatLockBtn = document.getElementById('toggle-chat-lock-btn');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const toggleChatLockBtn = document.getElementById'); // NEW
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChat('toggle-chat-lock-btn'); // NEW
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm =SendBtn = document.getElementById('lobby-chat-send-btn');

        // Game Screen Elements (NEW)
        const gameScreen = document.getElementById('game-screen');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const hokmSuitIcon = document.getElementById('hokm-suit-icon document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChatSendBtn = document.getElementById('lobby-chat-send-btn');

        // Game Screen Elements (NEW)
        const gameScreen = document.getElementById('game-screen');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const hokmSuitIcon = document.getElementById('hokm-suit-icon');
        const ourTeamScoreEl = document.getElementById('our-');
        const ourTeamScoreEl = document.getElementById('our-team-score');
        const theirTeamScoreEl = document.getElementById('their-team-score');
        const playArea = document.getElementById('play-area');
        const playerSlots = {
            bottom: document.getElementById('player-slot-bottom'),
            left: document.getElementById('player-slot-left'),
            top: document.getElementById('player-team-score');
        const theirTeamScoreEl = document.getElementById('their-team-score');
        const playArea = document.getElementById('play-area');
        const playerSlots = {
            bottom: document.getElementById('player-slot-bottom'),
            left: document.getElementById('player-slot-left'),
            top: document.getElementById('player-slot-top'),
            right: document.getElementById('player-slotslot-top'),
            right: document.getElementById('player-slot-right'),
        };

        // Kick Player Confirmation Modal Elements
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-right'),
        };

        // Kick Player Confirmation Modal Elements
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-btn');
        const kickPlayerConfirmName = document.getElementById('-btn');
        const kickPlayerConfirmName = document.getElementById('kick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');

        // Kicked Message Modal Elements
        const kickedkick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');MessageModal = document.getElementById('kicked-message-modal');
        const kickedMessageText = document.getElementById('kicked-message-text');
        const kickedLobbyName = document.getElementById('kicked-lobby

        // Kicked Message Modal Elements
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedMessageText = document.getElementById('kicked-message-text');
        const kickedL-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');

        // Kicked Players List Modal Elements
        const kickedPlayersListModal = document.getElementById('kicked-obbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');

        // Kicked Players List Modal Elements
        const kickedplayers-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        const kickedPlayersListContent = document.getElementById('kicked-players-PlayersListModal = document.getElementById('kicked-players-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        constlist-content');
        const kickedListOkBtn = document.getElementById('kicked-list-ok-btn kickedPlayersListContent = document.getElementById('kicked-players-list-content');
        const kickedListOk');
        
        // New Enter Password Modal Elements
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyBtn = document.getElementById('kicked-list-ok-btn');
        
        // New Enter Password Modal Elements
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
PasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // State variables
        let authMode = 'login'; // Default mode is login
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; // To store user's profile data
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // State variables
        let authMode = 'login'; // Default mode is login
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; // To store user's profile data
        let unsubscribeLobbies = null; // Global variable to        let unsubscribeLobbies = null; // Global variable to store the unsubscribe function for lobby list listener
        let unsubscribeLobbyDetail = null; // Global variable for single lobby detail listener
        let unsubscribeGame = null; // NEW store the unsubscribe function for lobby list listener
        let unsubscribeLobbyDetail = null; // Global variable for single lobby detail listener
        let unsubscribeGame = null; // NEW: Listener for the active game state
        let unsubscribeKickedPlayers = null; // Listener for kicked players list
        let unsubscribeLobbyChat = null; // NEW: Listener for lobby: Listener for the active game state
        let unsubscribeKickedPlayers = null; // Listener for kicked players list
        let unsubscribeLobbyChat = null; // NEW: Listener for lobby chat messages
        let isAuthResolved = false; // Flag to indicate if onAuthStateChanged has run at least once
        let userHasActiveLobby = false; // Track if the current user has an active lobby (created or joined)
        let currentLobbyId = null; chat messages
        let isAuthResolved = false; // Flag to indicate if onAuthStateChanged has run at least once
        let userHasActiveLobby = false; // Track if the current user has an active lobby (created or joined)
        let currentLobbyId = null; // Stores the ID of the lobby the current user is in // Stores the ID of the lobby the current user is in
        let kickedPlayerToProcess = null; // Stores UID/name of player selected for kicking
        let lobbyToJoin = null; // To store data of private lobby user wants to join
        let isRefreshing = false; // NEW: State for refresh button

        // Promise resolver
        let kickedPlayerToProcess = null; // Stores UID/name of player selected for kicking
        let lobbyToJoin = null; // To store data of private lobby user wants to join
        let isRefreshing = false; // for custom confirmation modal
        let resolveCustomConfirm;

        // --- NEW: App Status Check Function ---
        /**
         * Fetches the app's operational status from a remote JSON file.
         * @returns {Promise<{ NEW: State for refresh button

        // Promise resolver for custom confirmation modal
        let resolveCustomConfirm;

        // --- STARTstatus: 'open' | 'closed', message: string}>}
         */
        async function checkAppStatus() {
 OF NEW IMPLEMENTATION: App Status Control ---

        // متغیر اول: آدرس فایل JSON برای کنترل وضعیت برنامه            const url = 'https://litebase.ir/code/servers/baz_or_bastan_Hokm.json';
            try {
                // Add a cache-busting parameter to ensure we always get the latest version
        const appStatusConfigUrl = "https://litebase.ir/code/servers/baz_or_bastan_Hokm.json";

        // متغیر دوم: برای نگهداری وضعیت فعلی برنامه (این متغیر داخل تابع پر می‌شود)
        let currentAppState = {
            isAppOpen: false,
            message: ''
                const response = await fetch(`${url}?_=${new Date().getTime()}`);
                if (!response.ok) {
                    console.warn(`Could not fetch app status from server (HTTP ${response.status}). Assuming "open" as a safe fallback.`);
                    return { status: 'open', message: '' };
                }
                const data = await response.json();
                
                // Validate the response from the server
                if (data &&
        };

        /**
         * این تابع وضعیت برنامه را از سرور بررسی می‌کند.
         * اگر برنامه باز باشد، به طور عادی ادامه می‌دهد.
         * اگر بسته باشد، یک پیام نمایش داده و اجرای برنامه را متوقف می‌کند.
         */
        async function initializeFirebaseAndAuth() {
            console.log("بررسی وضعیت (data.app_status === 'open' || data.app_status === 'closed')) {
                    console.log(`App status received from server: ${data.app_status}`);
                    return { status: data.app_status, message: data.message || 'اپلیکیشن توسط مدیر بسته شده است.' };
                }
                 برنامه از سرور...");

            try {
                // با اضافه کردن یک پارامتر تصادفی، از کش شدن فایل جلوگیری می‌کنیم
                const response = await fetch(`${appStatusConfigUrl}?t=${new Date().getTime()
                console.warn('Invalid app status format received from server. Assuming "open".', data);
                return { status: 'open', message: '' };
            } catch (error) {
                console.error('Network error while}`);
                if (!response.ok) {
                    throw new Error(`خطای شبکه: ${response.status}`); fetching app status. Assuming "open".', error);
                return { status: 'open', message: '' };
                }
                const config = await response.json();

                // فرض می‌کنیم JSON شما ساختاری شبیه به // Safe fallback for network errors
            }
        }


        // --- START: MODIFIED Initial Firebase Authentication Flow ---
        async function initializeFirebaseAndAuth() {
            console.log("Initializing App... Checking server status first.");

 این دارد:
                // { "appStatus": "open" or "closed", "closedMessage": "دلیل بسته بودن" }
                // متغیر appStatus در فایل JSON شما باید به "open" تنظیم شده باشد تا برنامه باز شود.
                if (config.appStatus !== 'open') {
                    // برنامه بسته است. پیام            // Get DOM elements for the loading/closed message panels
            const loadingSpinnerContainer = document.getElementById('loading-spinner-container');
            const loadingText = document.getElementById('loading-text');
            const appClosedContainer = document.getElementById('app-closed-message-container');
            const appClosedMessage = document.getElementById('app-closed-message');

            // Update loading text to show what's happening
            loadingText.textContent = 'در را نمایش بده و متوقف شو.
                    currentAppState.isAppOpen = false;
                    currentAppState.message = config.closedMessage || "برنامه توسط مدیر بسته شده است.";
                    
                    console.warn(`بر حال بررسی وضعیت سرور...';

            // First, check if the app is open or closed by the admin
            const appStatus = await checkAppStatus();

            if (appStatus.status === 'closed') {
                نامه بسته است. پیام: ${currentAppState.message}`);
                    loadingSpinnerContainer.classList.add('hidden');
                    appClosedMessage.textContent = currentAppState.message;
                    appClosedPanel.classList.remove('hidden');
                    console.log("App status is 'closed'. Halting application load.");
                
                // Hide the standard loading spinner and text
                if (loadingSpinnerContainer) loadingSpinnerContainer.classList.add('hidden');

                // Populate andreturn; // اجرای ادامه کد را متوقف کن
                }

                // اگر به اینجا رسیدیم، یعنی برنامه باز است.
                console.log("وضعیت برنامه: باز. ادامه فرآیند احراز هویت...");
                currentAppState show the 'app closed' message panel
                if (appClosedMessage) appClosedMessage.textContent = appStatus.message;
                if (appClosedContainer) appClosedContainer.classList.remove('hidden');

                //.isAppOpen = true;

            } catch (error) {
                // در صورت بروز خطا در دریافت IMPORTANT: Stop the entire application from loading further.
                // The user will remain on the loading screen with this message.
                 فایل (مثلا قطعی اینترنت)
                currentAppState.isAppOpen = false;
                currentAppStatereturn;
            }
            
            // If we reach here, app status is 'open'. Proceed with normal loading.
            loadingText.textContent = 'در حال بارگذاری...'; // Reset loading text
            console.log("App status is 'open'. Proceeding with Firebase Authentication...");

            // The rest of the original function continues here
            if (.message = "خطا در برقراری ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کرده و مجدداً تلاش کنید.";
                
                console.error("خطا در دریافت فایل وضعیت برنامه:", error);
                loadingSpinnerContainer.classList.add('hidden');
                appClosedMessage.textContent = currentAppState.message;
                appClosedPanel.classList.remove('hidden');
                return; // اجرای ادامه کد را متوقف کنinitialAuthToken) {
                console.log("Initial auth token found. Attempting to sign in...");
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Sign in with custom token successful.");
                } catch (error) {
                    console.error("Error signing in with initial custom token:", error);
                }
            } else {
                console.log("No initial auth token. Waiting for
            }

            // --- این بخش کد اصلی شماست که فقط در صورت باز بودن برنامه اجرا می‌شود ---
            console.log("Initializing Firebase Auth...");
            if (initialAuthToken) {
                console.log("Initial auth token found. Attempting to sign in...");
                try {
                    await signInWithCustomToken(auth, onAuthStateChanged to resolve session.");
            }
        }
        // --- END: MODIFIED Initial Firebase Authentication Flow ---
        
        // All other functions (showCustomMessage, setActiveScreen, etc.) remain unchanged.
        // ... initialAuthToken);
                    console.log("Sign in with custom token successful.");
                } catch (error) {
                    console.error("Error signing in with initial custom token:", error);
                }
            } else {
                console.log("No initial auth token. Waiting for onAuthStateChanged to resolve session.");
            }
        }
         (The entire rest of your JavaScript code follows here)
        // Function to show custom message box (re-used for auth// --- END OF NEW IMPLEMENTATION ---


        // Function to show custom message box (re-used for auth and create lobby and create lobby modals)
        function showCustomMessage(element, message, type = 'info') {
             modals)
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-whitered-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            console.log(`پیام نمایش داده شد (${type}): ${message}`);
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        // Wrapper for main message box
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        // Wrapper for create lobby message box
        ');
            }
            element.classList.remove('hidden');
            console.log(`پیام نمایش داده شد (${type}): ${message}`);
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        // Wrapper for main message box
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        // Wrapper for create lobbyconst showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);


        // Function to show custom confirmation modal
        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                void message box
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);


        // Function to show custom confirmation modal
        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                void customConfirmModal.offsetWidth; // Trigger reflow for transition
                customConfirmModal.classList.add('profile-modal-enter-active');

                resolveCustomConfirm = resolve; // Store the resolve function

                // Event listeners for customConfirmModal.offsetWidth; // Trigger reflow for transition
                customConfirmModal.classList.add('profile-modal-enter-active');

                resolveCustomConfirm = resolve; // Store the resolve function

                // Event listeners for Yes/No buttons
                confirmYesBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(true);
                };
                confirmNoBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(false);
                };
            });
        }

        // Function to Yes/No buttons
                confirmYesBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(true);
                };
                confirmNoBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(false);
                };
            });
        }

        // Function to close the custom confirmation modal
        function closeCustomConfirm() {
            customConfirmModal.classList.remove('profile-modal-enter-active');
            customConfirmModal.classList.add('profile-modal-leave-active'); close the custom confirmation modal
        function closeCustomConfirm() {
            customConfirmModal.classList.remove('profile-modal-enter-active');
            customConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                customConfirmModal.classList.add('hidden');
                customConfirmModal.classList.remove('profile-modal-leave-active');
            }, 300); // Match modal transition duration

            setTimeout(() => {
                customConfirmModal.classList.add('hidden');
                customConfirmModal.classList.remove('profile-modal-leave-active');
            }, 300); // Match modal transition duration
        }


        // Function to transition between screens
        function setActiveScreen(newScreen) {
            console.        }


        // Function to transition between screens
        function setActiveScreen(newScreen) {
            console.log(`درخواست تغییر صفحه به: ${newScreen.id}. صفحه فعلی: ${currentActiveScreen.id}`);

            if (currentActiveScreen === newScreen) return;
            
            // Cleanup old listeners when changing screenslog(`درخواست تغییر صفحه به: ${newScreen.id}. صفحه فعلی: ${currentActiveScreen.id}`);

            if (currentActiveScreen === newScreen) return;
            
            // Cleanup old listeners when changing screens
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }


            // Hide the current screen with transition
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            currentActiveScreen.setAttribute('tabindex', '-1'); // Remove focus capability
            if (documentunsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }


            // Hide the current screen with transition
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            currentActiveScreen.setAttribute('tabindex', '-1'); // Remove focus capability
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }

            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');

                // Show the new screen with transition
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                new.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }

            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');

                // Show the new screen with transition
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                newScreen.removeAttribute('tabindex');
                console.log(`صفحه ${newScreen.id} اکنون قابل مشاهده است.`);

                if (newScreen === authScreen) emailInput.focus();
                else if (newScreenScreen.removeAttribute('tabindex');
                console.log(`صفحه ${newScreen.id} اکنون قابل مشاهده است.`);

                if (newScreen === authScreen) emailInput.focus();
                else if (newScreen === lobbyScreen) lobbySearchInput.focus();

                currentActiveScreen = newScreen;

            }, 600); // Matches CSS transition duration
        }

        // Functions to open/close modals
        function openProfileModal() {
            profileModal.classList.remove('hidden');
            void profileModal.offsetWidth;
             === lobbyScreen) lobbySearchInput.focus();

                currentActiveScreen = newScreen;

            }, 600); // Matches CSS transition duration
        }

        // Functions to open/close modals
        function openProfileModal() {
            profileModal.classList.remove('hidden');
            void profileModal.offsetWidth;
            profileModal.classList.add('profile-modal-enter-active');
            if (currentUserData) {
                profileDisplayName.textContent = currentUserData.displayName || 'ناشناس';
                profileEmail.textContent =profileModal.classList.add('profile-modal-enter-active');
            if (currentUserData) {
                profileDisplayName.textContent = currentUserData.displayName || 'ناشناس';
                profileEmail.textContent = currentUserData.email || 'ناشناس';
                profileUid.textContent = currentUserData.uid || 'ناشناس';
            }
        }

        function closeProfileModal() {
            profileModal.classList.remove currentUserData.email || 'ناشناس';
                profileUid.textContent = currentUserData.uid || 'ناشناس';
            }
        }

        function closeProfileModal() {
            profileModal.classList.remove('profile-modal-enter-active');
            profileModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                profileModal.classList.add('hidden');
                profileModal('profile-modal-enter-active');
            profileModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                profileModal.classList.add('hidden');
                profileModal.classList.remove('profile-modal-leave-active');
            }, 300);
        }

.classList.remove('profile-modal-leave-active');
            }, 300);
        }

        function openCreateLobbyModal() {
            createLobbyModal.classList.remove('hidden');
            void createLobbyModal.offsetWidth;
            createLobbyModal.classList.add('profile-modal-        function openCreateLobbyModal() {
            createLobbyModal.classList.remove('hidden');
            void createLobbyModal.offsetWidth;
            createLobbyModal.classList.add('profile-modal-enter-active');
            newLobbyNameInput.focus();
            createLobbyMessageBox.classList.add('hidden');
        }

        enter-active');
            newLobbyNameInput.focus();
            createLobbyMessageBox.classList.add('hidden');
        }

        function closeCreateLobbyModal() {
            createLobbyModal.classList.remove('profilefunction closeCreateLobbyModal() {
            createLobbyModal.classList.remove('profile-modal-enter-active');
            createLobbyModal.classList.add('profile-modal-leave-active');
            -modal-enter-active');
            createLobbyModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                createLobbyModal.classList.add('hidden');
                createsetTimeout(() => {
                createLobbyModal.classList.add('hidden');
                createLobbyModal.classList.remove('profile-modal-leave-active');
                createLobbyForm.reset();
                // Reset toggle buttons to default
                newLobbyPasswordField.classList.add('hidden');
                document.querySelectorAll('.lobbyLobbyModal.classList.remove('profile-modal-leave-active');
                createLobbyForm.reset();
                // Reset toggle buttons to default
                newLobbyPasswordField.classList.add('hidden');
                document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
                document-type-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('input[value="public"]').nextElementSibling.classList.add('active');
            }, 300);
        .querySelector('input[value="public"]').nextElementSibling.classList.add('active');
            }, 300);
        }
        
        function openKickPlayerConfirmModal(playerName, playerUid) {
            }
        
        function openKickPlayerConfirmModal(playerName, playerUid) {
            kickPlayerConfirmName.textContent = playerName;
            kickPlayerConfirmModal.classList.remove('hidden');
            void kickPlayerConfirmkickPlayerConfirmName.textContent = playerName;
            kickPlayerConfirmModal.classList.remove('hidden');
            void kickPlayerConfirmModal.offsetWidth;
            kickPlayerConfirmModal.classList.add('profile-modal-enterModal.offsetWidth;
            kickPlayerConfirmModal.classList.add('profile-modal-enter-active');
            kickedPlayerToProcess = { uid: playerUid, displayName: playerName };
        }

        function close-active');
            kickedPlayerToProcess = { uid: playerUid, displayName: playerName };
        }

        function closeKickPlayerConfirmModal() {
            kickPlayerConfirmModal.classList.remove('profile-modalKickPlayerConfirmModal() {
            kickPlayerConfirmModal.classList.remove('profile-modal-enter-active');
            kickPlayerConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(()-enter-active');
            kickPlayerConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickPlayerConfirmModal.classList.add('hidden');
                kickPlayerConfirm => {
                kickPlayerConfirmModal.classList.add('hidden');
                kickPlayerConfirmModal.classList.Modal.classList.remove('profile-modal-leave-active');
                kickedPlayerToProcess = null;remove('profile-modal-leave-active');
                kickedPlayerToProcess = null;
            }, 300);
        }

        function showKickedMessageModal(lobbyName) {
            kickedLobbyName.textContent = lobbyName;
            kickedMessageModal.classList.remove('hidden');
            
            }, 300);
        }

        function showKickedMessageModal(lobbyName) {
            kickedLobbyName.textContent = lobbyName;
            kickedMessageModal.classList.remove('void kickedMessageModal.offsetWidth;
            kickedMessageModal.classList.add('profile-modal-enter-active');
        }

        function closeKickedMessageModal() {
            kickedMessageModal.classList.remove('profile-modal-enter-active');
            kickedMessageModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickedMessageModal.classList.add('hidden');
                hidden');
            void kickedMessageModal.offsetWidth;
            kickedMessageModal.classList.add('profile-modal-enter-active');
        }

        function closeKickedMessageModal() {
            kickedMessageModal.classList.remove('profile-modal-enter-active');
            kickedMessageModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickedMessageModal.classList.add('hidden');
                kickedMessageModal.classList.remove('profile-modal-leave-active');
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            }, 300);kickedMessageModal.classList.remove('profile-modal-leave-active');
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            }, 300);
        }


        }

        function openKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('hidden');
            void kickedPlayersListModal.offsetWidth;
            kickedPlayersListModal.classList.add('profile-modal-enter-active');
            if (currentLobbyId) {
                unsubscribeKickedPlayers = setupKickedPlayersListListener(currentLobbyId);
            } else {
                kickedPlayersListContent        function openKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('hidden');
            void kickedPlayersListModal.offsetWidth;
            kickedPlayersListModal.classList.add('profile-modal-enter-active');
            if (currentLobbyId) {
                unsubscribeKickedPlayers = setupKickedPlayersListListener(currentLobbyId);
            } else {
                kickedPlayersListContent.innerHTML = '<p class="text-gray-400 text-center">خطا: لابی فعال یافت نشد.</p>';.innerHTML = '<p class="text-gray-400 text-center">خطا: لابی فعال یافت نشد.</p>';
            }
        }

        function closeKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('profile-modal-enter-active');
            kickedPlayersListModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kicked
            }
        }

        function closeKickedPlayersListModal() {
            kickedPlayersListModal.classList.remove('profile-modal-enter-active');
            kickedPlayersListModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                kickedPlayersListModal.classList.add('hidden');
                kickedPlayersListModal.classList.remove('profile-modal-leave-activePlayersListModal.classList.add('hidden');
                kickedPlayersListModal.classList.remove('profile-modal-leave-active');
                if (unsubscribeKickedPlayers) {
                    unsubscribeKickedPlayers();
                    unsubscribeKickedPlayers = null;
                }
            }, 300);
        }


        ');
                if (unsubscribeKickedPlayers) {
                    unsubscribeKickedPlayers();
                    unsubscribeKickedPlayers = null;
                }
            }, 300);
        }


        /**
         * Calls a simulated AI content moderation API to check if the lobby name is appropriate.
         * @param {string} lobbyName - The name of the lobby to check.
         * @returns {Promise<{is_appropriate: boolean,/**
         * Calls a simulated AI content moderation API to check if the lobby name is appropriate.
         * @param {string} lobbyName - The name of the lobby to check.
         * @returns {Promise<{is_appropriate: boolean, reason: string}>} - The moderation result.
         */
        async function checkL reason: string}>} - The moderation result.
         */
        async function checkLobbyNameWithAI(lobbyName) {
            const prompt = `As a highly rigorous and professional content moderation AI, meticulously analyze the followingobbyNameWithAI(lobbyName) {
            const prompt = `As a highly rigorous and professional content moderation AI, meticulously analyze the following lobby name for compliance with the strictest community guidelines across *all* languages. You must absolutely identify and disallow lobby name for compliance with the strictest community guidelines across *all* languages. You must absolutely identify and disallow any political, racist, sexual, offensive, vulgar, violent, or otherwise inappropriate content, including but not limited to terms like "fuck", any political, racist, sexual, offensive, vulgar, violent, or otherwise inappropriate content, including but not limited to terms like "fuck", "asshole", "shit", "bitch", and their equivalents in Persian such as "ک "asshole", "shit", "bitch", and their equivalents in Persian such as "کیر", "کون", "کس", "کسکش", "جنده", "حرومزاده", "بیناموس" etc.,یر", "کون", "کس", "کسکش", "جنده", "حرومزاده", "بینام regardless of how they are spelled (e.g., phonetic or deliberate misspellings to evade detection). Your analysis shouldوس" etc., regardless of how they are spelled (e.g., phonetic or deliberate misspellings to evade detection). Your analysis should consider the context and intent where possible. Your response *must* be a JSON object: {"is_appropriate": boolean, "reason": string}. If 'is_appropriate' is false, provide a *brief, objective, and precise consider the context and intent where possible. Your response *must* be a JSON object: {"is_appropriate": boolean, "reason": string}. If 'is_appropriate' is false, provide a *brief, objective, and precise* reason identifying the specific type of violation (e.g., "Contains offensive language", "Political reference detected", "Violates decency standards"). If appropriate, 'reason' should be an empty string. Lobby name to analyze: "${lobbyName}"`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json", responseSchema* reason identifying the specific type of violation (e.g., "Contains offensive language", "Political reference detected", "Violates decency standards"). If appropriate, 'reason' should be an empty string. Lobby name to analyze: "${lobbyName}"`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "is_appropriate": { "type": "BOOLEAN" }, "reason": { "type": "STRING" } }, "propertyOrdering": ["is_appropriate", "reason"]: { type: "OBJECT", properties: { "is_appropriate": { "type": "BOOLEAN" }, "reason": { "type": "STRING" } }, "propertyOrdering": ["is_appropriate", "reason"] } } };
            const apiKey = "AIzaSyDfMZwyWNnRFUDLHKR1t_hZ5cWv2c_KvvE"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key } } };
            const apiKey = "AIzaSyDfMZwyWNnRFUDLHKR1t_hZ5cWv2c_KvvE"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                =${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorText = await response.text(); console.error("AI API HTTP Error:", response.status, response.statusText, errorText); return { is_appropriate: false, reason: `if (!response.ok) { const errorText = await response.text(); console.error("AI API HTTP Error:", response.status, response.statusText, errorText); return { is_appropriate: false, reason: `خطا در ارتباط با سرور اعتدال: ${response.statusText}.` }; }
                const result = await response.json();
                if (result && result.candidates?.[0]?.content?.parts?.[خطا در ارتباط با سرور اعتدال: ${response.statusText}.` }; }
                const result = await response.json();
                if (result && result.candidates?.[0]?.content?.parts?.[0]) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try { const parsedJson = JSON.parse(jsonString); if (typeof parsedJson.is_appropriate === 'boolean' &&0]) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try { const parsedJson = JSON.parse(jsonString); if (typeof parsedJson.is_appropriate === 'boolean' && typeof parsedJson.reason === 'string') { return parsedJson; } else { console.warn("AI response has typeof parsedJson.reason === 'string') { return parsedJson; } else { console.warn("AI response has unexpected structure:", parsedJson); return { is_appropriate: false, reason: "پاسخ سیستم اعتدال نام unexpected structure:", parsedJson); return { is_appropriate: false, reason: "پاسخ سیستم اعتدال نامفهوم است." }; } } catch (parseError) { console.error("Error parsing AI response JSON:", parseError, "فهوم است." }; } } catch (parseError) { console.error("Error parsing AI response JSON:", parseError, "Raw:", jsonString); return { is_appropriate: false, reason: "خطا در پردازش پاسخ اعتدال." };Raw:", jsonString); return { is_appropriate: false, reason: "خطا در پردازش پاسخ اعتدال." }; }
                } else { console.warn("AI response missing content structure:", result); return { is_appropriate: }
                } else { console.warn("AI response missing content structure:", result); return { is_appropriate: false, reason: "عدم دریافت پاسخ معتبر از سیستم اعتدال." }; }
            } catch ( false, reason: "عدم دریافت پاسخ معتبر از سیستم اعتدال." }; }
            } catch (error) { console.error("Error calling AI moderation API:", error); return { is_appropriate: false, reasonerror) { console.error("Error calling AI moderation API:", error); return { is_appropriate: false, reason: `خطا در ارتباط با سیستم اعتدال: ${error.message}.` }; }
        }

        : `خطا در ارتباط با سیستم اعتدال: ${error.message}.` }; }
        }

        // Firebase Authentication State Listener
        onAuthStateChanged(auth, async (user) => {
            console.log// Firebase Authentication State Listener
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged triggered. User:", user ? user.uid : "logged out");
            
            // This is the("onAuthStateChanged triggered. User:", user ? user.uid : "logged out");
            
            // This is the first time the auth state has been determined.
            // We can now safely transition away from the loading screen.
             first time the auth state has been determined.
            // We can now safely transition away from the loading screen.
            if (!isAuthResolved) {
                isAuthResolved = true;
            }

            if (userif (!isAuthResolved) {
                isAuthResolved = true;
            }

            if (user)) {
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users {
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${/${user.uid}/profile/data`); 
                    const userDocSnap = await getDoc(userDocRef);
                    currentUserData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: (userDocSnap.exists() && userDocSnap.data().displayName) ? userDocSnap.data().displayNameuser.uid}/profile/data`); 
                    const userDocSnap = await getDoc(userDocRef);
                    currentUserData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: (userDocSnap.exists() && userDocSnap.data().displayName) ? userDocSnap.data().displayName : (user.displayName || (user.email ? user.email.split('@')[0] : 'کاربر ناشناس')) : (user.displayName || (user.email ? user.email.split('@')[0] : 'کاربر ناشناس'))
                    };
                    if (!userDocSnap.exists() && authMode === 'register' && displayNameInput.value.trim() !== '') {
                        await setDoc(userDocRef, { displayName: displayNameInput.value.trim(), email: user.email }, { merge: true });
                        currentUserData.displayName = displayNameInput.value.trim();
                    }
                    headerDisplayName.textContent = currentUserData.displayName;
                    
                    };
                    if (!userDocSnap.exists() && authMode === 'register' && displayNameInput.value.trim() !== '') {
                        await setDoc(userDocRef, { displayName: displayNameInput.value.trim(), email: user.email }, { merge: true });
                        currentUserData.displayName = displayNameInput.value.trim();
                    }
                    headerDisplayName.textContent = currentUserData.displayName;
                    headerUserId.textContent = `شناسه:headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                    
                    // Only transition if we are coming from loading or auth screen
                    if(currentActiveScreen === loadingScreen || currentActiveScreen === authScreen) {
                        setActiveScreen(mainScreen);
                    }

                } catch (firestoreError) {
                    console.error("Firestore profile error:", firestoreError);
                    currentUserData = ${currentUserData.uid.substring(0, 8)}...`;
                    
                    // Only transition if we are coming from loading or auth screen
                    if(currentActiveScreen === loadingScreen || currentActiveScreen === authScreen) {
                        setActiveScreen(mainScreen);
                    }

                } catch (firestoreError) {
                    console.error("Firestore profile error:", firestoreError);
                    currentUserData = { uid: user.uid, email: user.email, displayName: user.displayName || (user.email ? user.email.split('@')[0] : { uid: user.uid, email: user.email, displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'کاربر ناشناس') };
                    headerDisplayName.textContent = currentUserData.displayName;
                    headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                    setActiveScreen(mainScreen);
                    showMessageBox("مشکل در بار 'کاربر ناشناس') };
                    headerDisplayName.textContent = currentUserData.displayName;
                    headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                    setActiveScreen(mainScreen);
                    showMessageBox("مشکل در بارگذاری پروفایل.", "error");
                }
            } else {
                // User is logged out
                setActiveScreen(authScreen);
                authForm.resetگذاری پروفایل.", "error");
                }
            } else {
                // User is logged out
                setActiveScreen(authScreen);
                authForm.reset();
                displayNameField.classList.add('hidden');
                submitAuthBtn.classList.add('hidden');
                loginToggleBtn.classList.remove('hidden');
                registerToggleBtn.classList.remove('hidden');
                authMode = 'login';
                currentUserData = null;
();
                displayNameField.classList.add('hidden');
                submitAuthBtn.classList.add('hidden');
                loginToggleBtn.classList.remove('hidden');
                registerToggleBtn.classList.remove('hidden');
                authMode = 'login';
                currentUserData = null;
                // Clean up all listeners
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                                // Clean up all listeners
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                if (unsubscribeKickedPlayers) unsubscribeKickedPlayers();
                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                if (unsubscribeGame) unsubscribeGame();
                unsubscribeLobbiesif (unsubscribeKickedPlayers) unsubscribeKickedPlayers();
                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                if (unsubscribeGame) unsubscribeGame();
                unsubscribeLobbies = unsubscribeLobbyDetail = unsubscribeKickedPlayers = unsubscribeLobbyChat = unsubscribeGame = null;
                currentLobbyId = null;
            }
        });

        // Maps Firebase auth error codes to user-friendly Persian messages.
        function get = unsubscribeLobbyDetail = unsubscribeKickedPlayers = unsubscribeLobbyChat = unsubscribeGame = null;
                currentLobbyId = null;
            }
        });

        
        // Maps Firebase auth error codes to user-friendly Persian messages.
        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': "فرمت ایمیل نامعتبر است.",
                'auth/user-disabled': "حFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': "فرمت ایمیل نامعتبر است.",
                'auth/user-disabled': "حساب کاربری شما غیرفعال شده است.",
                'auth/user-not-found': "کاربری با این ایمیل یافت نشد.",
                'auth/wrong-ساب کاربری شما غیرفعال شده است.",
                'auth/user-not-found': "کاربری با این ایمیل یافت نشد.",
                'auth/wrong-password': "ایمیل یا رمز عبور اشتباه است.",
                'auth/invalid-credential': "ایمیل یا رمز عبور اشتباه است.",
                'password': "ایمیل یا رمز عبور اشتباه است.",
                'auth/invalid-credential': "ایمیل یا رمز عبور اشتباه است.",
                'auth/email-already-in-use': "این ایمیل قبلاً ثبت نام شده است.",
                'auth/weak-password': "رمز عبور باید حداقلauth/email-already-in-use': "این ایمیل قبلاً ثبت نام شده است.",
                'auth/weak-password': "رمز عبور باید حداقل ۶ کاراکتر باشد.",
                'auth/operation-not-allowed': "این نوع ورود فعال نیست.",
                'auth/network-request-failed': " ۶ کاراکتر باشد.",
                'auth/operation-not-allowed': "این نوع ورود فعال نیست.",
                'auth/network-request-failed': "مشکل در اتصال به اینترنت.",
                'auth/too-many-requests': "تعداد تلاش‌های ناموفق بیش از حد مجاز.",
            };مشکل در اتصال به اینترنت.",
                'auth/too-many-requests': "تعداد تلاش‌های ناموفق بیش از حد مجاز.",
            };
            return messages[errorCode] || "خطایی ناش
            return messages[errorCode] || "خطایی ناشناخته رخ داده است.";
        }

        //ناخته رخ داده است.";
        }

        // --- Firebase Lobby Functions ---
        async function createLobby( --- Firebase Lobby Functions ---
        async function createLobby(lobbyName, userId, displayName, lobbyType, password) {
            try {
                const creatorDisplayName = displayName && displayName.trim() !== '' ? displayName : 'ناشناس';
        
                const userLobbiesQuery = query(
                    collection(db, `global_lobbieslobbyName, userId, displayName, lobbyType, password) {
            try {
                const creatorDisplayName = displayName && displayName.trim() !== '' ? displayName : 'ناشناس';
        
                const userLobbiesQuery = query(
                    collection(db, `global_lobbies`),
                    where("hostId", "==", userId),
                    where("status", "in", ["waiting", "playing"])
                );
                const userLobbiesSnapshot = await getDocs(userLobbiesQuery);
                if (!userLobbiesSnapshot.empty) {
                    throw new Error("شما از قبل یک لابی فعال ساخته‌اید. لطفاً ابتدا لابی قبلی خود را ببندید`),
                    where("hostId", "==", userId),
                    where("status", "in", ["waiting", "playing"])
                );
                const userLobbiesSnapshot = await getDocs(userLobbiesQuery);
                if (!userLobbiesSnapshot.empty) {
                    throw new Error("شما از قبل یک لابی فعال ساخته‌اید. لطفاً ابتدا لابی قبلی خود را ببندید.");
                }
        
                const lobbiesRef = collection(db, `global_lobbies`);
                
                const newLobbyData = {
                    name: lobbyName,
                    hostId: userId,
                    status: "waiting",
                    type: lobbyType,
                    players: {
.");
                }
        
                const lobbiesRef = collection(db, `global_lobbies`);
                
                const newLobbyData = {
                    name: lobbyName,
                    hostId: userId,
                    status: "waiting",
                    type: lobbyType,
                    players: {
                        [userId]: creatorDisplayName // Using a map: { "uid": "displayName" }
                    },
                    kickedPlayers: [], // Still an array of objects
                    createdAt: serverTimestamp(),
                    isChatLocked: false, // NEW: Chat is open by default
                    gameSettings: { maxPlayers: 4, roundsToWin: 7 }                        [userId]: creatorDisplayName // Using a map: { "uid": "displayName" }
                    },
                    kickedPlayers: [], // Still an array of objects
                    createdAt: serverTimestamp(),
                    isChatLocked: false, // NEW: Chat
                };
        
                if (lobbyType === 'private') {
                    newLobbyData.password = password;
                }
        
                const newLobbyRef = await addDoc(lobbiesRef, newLobbyData);
                
                console.log(`لابی ${lobbyType} با ID ساخته شد: `, is open by default
                    gameSettings: { maxPlayers: 4, roundsToWin: 7 }
                };
        
                if (lobbyType === 'private') {
                    newLobbyData.password = password;
                }
        
                const newLobbyRef = await addDoc(lobbiesRef, newLobbyData);
                
                console.log(`لابی ${lobbyType} با ID ساخته شد: `, newLobbyRef.id);
                userHasActiveLobby = true;
                return newLobbyRef.id;
 newLobbyRef.id);
                userHasActiveLobby = true;
                return newLobbyRef.id;
            } catch (e) {
                console.error("خطا در ساخت لابی: ", e);
                throw e;
            }
        }
        
        async function closeLobby(lobbyId, userId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId            } catch (e) {
                console.error("خطا در ساخت لابی: ", e);
                throw e;
            }
        }
        
        async function closeLobby(lobbyId, userId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) {);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { showMessageBox("لابی مورد نظر یافت نشد.", "error"); return; }
                const lobbyData = lobbySnap.data();
                if (lobbyData.hostId !== userId) { showMessageBox(" showMessageBox("لابی مورد نظر یافت نشد.", "error"); return; }
                const lobbyData = lobbySnap.data();
                if (lobbyData.hostId !== userId) { showMessageBox("شما اجازه بستن این لابی را ندارید.", "error"); return; }

                const lobbyElement = document.querySelector(`[data-شما اجازه بستن این لابی را ندارید.", "error"); return; }

                const lobbyElement = document.querySelector(`[data-lobby-id="${lobbyId}"]`);
                if (lobbyElement) {
                    lobbyElement.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 500));
lobby-id="${lobbyId}"]`);
                if (lobbyElement) {
                    lobbyElement.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                await deleteDoc(lobbyRef);
                showMessageBox(`لابی "${lobbyData.name}" با موفقیت بسته                }

                await deleteDoc(lobbyRef);
                showMessageBox(`لابی "${lobbyData.name}" با موفقیت بسته شد.`, "success");
                userHasActiveLobby = false;
                if (currentLobbyId === lobbyId) currentLobbyId = null;
            } catch (e) {
 شد.`, "success");
                userHasActiveLobby = false;
                if (currentLobbyId === lobbyId) currentLobbyId = null;
            } catch (e) {
                console.error                console.error("خطا در بستن لابی: ", e);
                showMessageBox(`خطا در بستن لابی: ${e.message}`, "error");
            }
        }
        
        function setupLobby("خطا در بستن لابی: ", e);
                showMessageBox(`خطا در بستن لابی: ${e.message}`, "error");
            }
        }
        
        function setupLobbyListener(searchTermListener(searchTerm = '') {
            console.log(`شروع راه‌اندازی Listener لابی‌ها با عبارت جستجو: "${searchTerm}"`);
            if (unsubscribeLobbyDetail) {
                unsubscribeLobbyDetail(); = '') {
            console.log(`شروع راه‌اندازی Listener لابی‌ها با عبارت جستجو: "${searchTerm}"`);
            if (unsubscribeLobbyDetail) {
                unsubscribeLobbyDetail();
                unsubscribeL
                unsubscribeLobbyDetail = null;
                currentLobbyId = null;
            }
            if (unsubscribeKickedPlayers) {
                unsubscribeKickedPlayers();
                unsubscribeKickedPlayers = null;
obbyDetail = null;
                currentLobbyId = null;
            }
            if (unsubscribeKickedPlayers) {
                unsubscribeKickedPlayers();
                unsubscribeKickedPlayers = null;
            }
                        }
            if (unsubscribeLobbyChat) {
                unsubscribeLobbyChat();
                unsubscribeLobbyChat = null;
            }
            if (unsubscribeGame) { // NEW: Clear game listener too
                if (unsubscribeLobbyChat) {
                unsubscribeLobbyChat();
                unsubscribeLobbyChat = null;
            }
            if (unsubscribeGame) { // NEW: Clear game listener too
                unsubscribeGame();
                unsubscribeGame = null;
            }
        
            lobbiesList.innerHTML = '<p class="text-grayunsubscribeGame();
                unsubscribeGame = null;
            }
        
            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>';
            userHasActiveLobby = false;
        
            const normalizedSearchTerm = searchTerm.toLowerCase();
            const q-400">در حال بارگذاری لابی‌ها...</p>';
            userHasActiveLobby = false;
        
            const normalizedSearchTerm = searchTerm.toLowerCase();
            const q = query(
                collection(db = query(
                collection(db, `global_lobbies`), 
                where("status", "==", "waiting") // This is key: only shows 'waiting' lobbies.
            );
        
            const unsubscribe = onSnapshot, `global_lobbies`), 
                where("status", "==", "waiting") // This is key:(q, (snapshot) => {
                lobbiesList.innerHTML = '';
        
                let lobbiesToDisplay = []; only shows 'waiting' lobbies.
            );
        
            const unsubscribe = onSnapshot(q, (snapshot) => {
                lobbiesList.innerHTML = '';
        
                let lobbiesToDisplay = [];
                let currentUserIsInAnyLobby = false;
        
                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    const playersMap = lobby.players || {};
                    
                    
                let currentUserIsInAnyLobby = false;
        
                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    const playersMap = lobby.players || {};
                    
                    const hostDisplayName = (playersMap[lobby.hostId] || 'ناشناس').toLowerCase();const hostDisplayName = (playersMap[lobby.hostId] || 'ناشناس').toLowerCase();
                    const lobbyName = (lobby.name || '').toLowerCase();
                    
                    if (auth.currentUser && playersMap[auth.currentUser.uid]) {
                        currentUserIsInAnyLobby = true;
                    }
        
                    if (
                    const lobbyName = (lobby.name || '').toLowerCase();
                    
                    if (auth.currentUser && playersMap[auth.currentUser.uid]) {
                        currentUserIsInAnyLobby = true;
                    }
        
                    if (normalizedSearchTerm === '' || lobbyName.includes(normalizedSearchTerm) || hostDisplayName.includes(normalizedSearchTerm)) {
                        lobbiesToDisplay.push(lobby);
                    }
                });
        
                userHasActiveLobby = currentUserIsInAnyLobby;
                
                // Count active gamesnormalizedSearchTerm === '' || lobbyName.includes(normalizedSearchTerm) || hostDisplayName.includes(normalizedSearchTerm)) {
                        lobbiesToDisplay.push(lobby);
                    }
                });
        
                userHasActiveL separately by another query or accept this might be slightly off
                // For now, we will update the active games count less frequently or assume it's decorative.
                getDocs(query(collection(db, `global_lobbies`), where("status", "==", "playing"))).then(playingSnapshot => {
                    activeGamesCount.textContent = playingSnapshot.size;obby = currentUserIsInAnyLobby;
                
                // Count active games separately by another query or accept this might be slightly off
                // For now, we will update the active games count less frequently or assume it's decorative.
                getDocs(query(collection(db, `global_lobbies`), where("status", "==", "playing"))).then(playingSnapshot => {
                    activeGamesCount.textContent = playingSnapshot.size;
                });

                });
                
                lobbiesToDisplay.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        
                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p class="text-gray                
                lobbiesToDisplay.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        
                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p class="text-gray-400-400">لابی با این مشخصات یافت نشد.</p>';
                } else {
                    lobbiesToDisplay.forEach((lobby) => {
                        const playersMap = lobby.players || {};
                        const playerCount =">لابی با این مشخصات یافت نشد.</p>';
                } else {
                    lobbiesToDisplay.forEach((lobby) => {
                        const playersMap = lobby.players || {};
                        const playerCount = Object.keys( Object.keys(playersMap).length;
                        const maxPlayers = lobby.gameSettings?.maxPlayers || 4;
                        const hostDisplayName = playersMap[lobby.hostId] || 'ناشناس';
                        playersMap).length;
                        const maxPlayers = lobby.gameSettings?.maxPlayers || 4;
                        const hostDisplayName = playersMap[lobby.hostId] || 'ناشناس';
                        const isCurrentUserHostconst isCurrentUserHostOfThisLobby = auth.currentUser && lobby.hostId === auth.currentUser.uid;
                        const isCurrentUserKicked = auth.currentUser && lobby.kickedPlayers?.some(p => p.OfThisLobby = auth.currentUser && lobby.hostId === auth.currentUser.uid;
                        const isCurrentUserKicked = auth.currentUser && lobby.kickedPlayers?.some(p => p.uid === auth.uid === auth.currentUser.uid);
                        const canJoinThisLobby = auth.currentUser && !currentUserIsInAnyLobby && playerCount < maxPlayers && !isCurrentUserKicked;
        
                        const lockIconHtml = lobby.type === 'currentUser.uid);
                        const canJoinThisLobby = auth.currentUser && !currentUserIsInAnyLobby && playerCount < maxPlayers && !isCurrentUserKicked;
        
                        const lockIconHtml = lobby.type === 'private' 
                            ? `<svg xmlns="http://www.w3.org/2000/private' 
                            ? `<svg xmlns="http://www.w3.org/2000/svg" class="lobby-lock-icon" viewBox="0 0 24 24" fill="svg" class="lobby-lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` 
                            : '';
        
                        let joinButtonHtml = '';
                        if (isCurrentUserKicked) {
                             joinButtonHtml = `<button class="join-rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` 
                            : '';
        
                        let joinButtonHtml = '';
                        if (isCurrentUserKicked) {
                             joinButtonHtml = `<button class="join-lobby-btn classic-btn btn-red-classic opacity-50 cursor-not-allowed" disabled>اخراج شده‌اید</button>`;
                        } else if (isCurrentUserHostOfThisLobby) {
                            lobby-btn classic-btn btn-red-classic opacity-50 cursor-not-allowed" disabled>اخراج شده‌اید</button>`;
                        } else if (isCurrentUserHostOfThisLobby) {
                            joinButtonHtml = `<button data-lobby-id="${lobby.id}" class="view-my-lobby-btn classic-joinButtonHtml = `<button data-lobby-id="${lobby.id}" class="view-my-lobby-btn classic-btn btn-blue-classic">ورود به لابی من</button>`;
                        } else if (canJoinThisLobby) {
                            joinButtonHtml = `<button data-lobby-id="${lobby.id}" data-lobby-type="${lobby.type || 'public'}" data-lobby-name="${lobby.name}" classbtn btn-blue-classic">ورود به لابی من</button>`;
                        } else if (canJoinThisLobby) {
                            joinButtonHtml = `<button data-lobby-id="${lobby.id}" data-lobby-type="${lobby.type || 'public'}" data-lobby-name="${lobby.name}" class="join-lobby-btn classic-btn btn-blue-classic">ورود به لابی</button>`;
                        } else {
                            joinButtonHtml = `<button class="join-lobby-btn classic-btn btn-blue-classic opacity-50 cursor-not-allowed" disabled>ورود به لابی</button>`;
                        }
="join-lobby-btn classic-btn btn-blue-classic">ورود به لابی</button>`;
                        } else {
                            joinButtonHtml = `<button class="join-lobby-btn classic-btn btn-blue-classic opacity-50 cursor-not-allowed" disabled>ورود به لابی</button>`;
                        }
                        
                        const closeButtonHtml = isCurrentUserHostOfThisLobby 
                            ? `<button data-lobby-                        
                        const closeButtonHtml = isCurrentUserHostOfThisLobby 
                            ? `<button data-lobby-id="${lobby.id}" class="close-lobby-btn classic-btn btn-red-classic">بستن لابی</button>` : '';
        
                        const lobbyItem = document.createElement('div');
                        lobbyItem.className = 'lobby-item mb-3 w-full';
                        lobbyItem.dataset.lobbyId = lobby.idid="${lobby.id}" class="close-lobby-btn classic-btn btn-red-classic">بستن لابی</button>` : '';
        
                        const lobbyItem = document.createElement('div');
                        lobbyItem.className = 'lobby-item mb-3 w-full';
                        lobbyItem.dataset.lobbyId = lobby.id;
                        lobbyItem.innerHTML = `
                            <div class="mb-2 sm:mb-0 text;
                        lobbyItem.innerHTML = `
                            <div class="mb-2 sm:mb-0 text-center sm:text-right">
                                <h3 class="text-xl font-bold">${lockIconHtml}${lobby.name}</h3>
                                <p class="text-sm">سازنده: ${hostDisplayName}</p>-center sm:text-right">
                                <h3 class="text-xl font-bold">${lockIconHtml}${lobby.name}</h3>
                                <p class="text-sm">سازنده: ${hostDisplayName}</p>
                                <
                                <p class="text-sm">بازیکنان: ${playerCount}/${maxPlayers}</p>
                            </div>
                            <div class="lobby-actions">
                                ${closeButtonHtml}
                                ${joinButtonHtml}
                            </div>
                        `;
                        lobbiesList.appendChild(lobbyItem);
                    });
                }
                p class="text-sm">بازیکنان: ${playerCount}/${maxPlayers}</p>
                            </div>
                            <div class="lobby-actions">
                                ${closeButtonHtml}
                                ${joinButtonHtml}
                            </div>
                        `;
                        lobbiesList.appendChild(lobbyItem);
                    });
                }
                
                lobbiesList.querySelectorAll('.join-lobby-btn:not([disabled])').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.currentTarget.
                lobbiesList.querySelectorAll('.join-lobby-btn:not([disabled])').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.currentTarget.dataset.lobbyId;
                        const lobbyType = e.currentTarget.dataset.lobbyType;
                        const lobbyName = e.currentTarget.dataset.lobbyName;
                        
                        if (lobbyType === 'private') {dataset.lobbyId;
                        const lobbyType = e.currentTarget.dataset.lobbyType;
                        const lobbyName = e.currentTarget.dataset.lobbyName;
                        
                        if (lobbyType === 'private') {
                            openEnterPasswordModal(lobbyId, lobbyName);
                        } else {
                            try {
                                await joinLobby(lobbyId, auth.currentUser.uid, currentUserData.displayName);
                            } catch (error) {
                            openEnterPasswordModal(lobbyId, lobbyName);
                        } else {
                            try {
                                await joinLobby(lobbyId, auth.currentUser.uid, currentUserData.displayName);
                            } catch (error) {
                                console.error("Error joining public lobby:", error);
                                showMessageBox(`خطا در ورود به لابی: ${error.message}`, "error");
                            }
                        }
                    });
                });
        
                
                                console.error("Error joining public lobby:", error);
                                showMessageBox(`خطا در ورود به لابی: ${error.message}`, "error");
                            }
                        }
                    });
                });
        
                lobbiesList.querySelectorAll('.view-my-lobby-btn').forEach(button => {
                    button.addEventListener('click',lobbiesList.querySelectorAll('.view-my-lobby-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const lobbyId = e.target.dataset.lobbyId;
                        if ( (e) => {
                        const lobbyId = e.target.dataset.lobbyId;
                        if (lobbyId && auth.currentUser) {
                            currentLobbyId = lobbyId;
                            setActiveScreen(lobbyDetailScreen);
                            unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
                        }
                    });
                });
        
                lobbiesList.querySelectorAll('.close-lobby-btn').forEach(button =>lobbyId && auth.currentUser) {
                            currentLobbyId = lobbyId;
                            setActiveScreen(lobbyDetailScreen);
                            unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
                        }
                    });
                });
        
                lobbiesList.querySelectorAll('.close-lobby-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.target {
                    button.addEventListener('click', async (e) => {
                        const lobbyId = e.target.dataset.lobbyId;
                        if (lobbyId && auth.currentUser) {
                            const lobbyName = e.target.closest('.lobby-item').querySelector('h3').textContent;
                            const confirmed = await showCustomConfirm(`آیا مطمئن هستید که می‌خواهید لابی "${lobbyName}" را ببندید؟`);
.dataset.lobbyId;
                        if (lobbyId && auth.currentUser) {
                            const lobbyName = e.target.closest('.lobby-item').querySelector('h3').textContent;
                            const confirmed = await showCustomConfirm(`آیا مطمئن هستید که می‌خواهید لابی "${lobbyName}" را ببندید؟`);
                            if (confirmed) {
                                await closeLobby(lobbyId, auth.currentUser.uid);
                            if (confirmed) {
                                await closeLobby(lobbyId, auth.currentUser.uid);
                            }
                        }
                    });
                });
        
            }, (error) => {
                console.error("خطا در گوش دادن به لابی‌ها: ", error);
                lobbiesList.innerHTML = `<p class="text-red-400">خطا در بارگذاری لیست لابی‌ها. (${error.message})                            }
                        }
                    });
                });
        
            }, (error) => {
                console.error("خطا در گوش دادن به لابی‌ها: ", error);
                lobbiesList.innerHTML = `<p class="text-red-400">خطا در بارگذاری لیست لابی‌ها. (${error.message})</p>`;
            });
        
            return unsubscribe;
        }

        async function joinLobby(lobbyId, userId, displayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try</p>`;
            });
        
            return unsubscribe;
        }

        async function joinLobby(lobbyId, userId, displayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) { throw new Error("لابی یافت نشد."); }
                
                const lobbyData = lobbySnap.data();
                const playersMap = lobbyData.players || {};
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                const kickedPlayers = lobbyData.kickedPlayers || [];

                if (()) { throw new Error("لابی یافت نشد."); }
                
                const lobbyData = lobbySnap.data();
                const playersMap = lobbyData.players || {};
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                const kickedPlayers = lobbyData.kickedPlayers || [];

                if (kickedPlayerskickedPlayers.some(p => p.uid === userId)) {
                    throw new Error("شما از این لابی اخراج شده‌اید.");
                }
                if (playersMap[userId]) { // Player is already in
                    currentLobbyId = lobbyId;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobby.some(p => p.uid === userId)) {
                    throw new Error("شما از این لابی اخراج شده‌اید.");
                }
                if (playersMap[userId]) { // Player is already in
                    currentLobbyId = lobbyId;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
                    return;
                }
                if (Object.keys(playersMap).length >= maxPlayers) { throw new Error("لابی پر است."); }
                
Detail = setupLobbyDetailListener(lobbyId);
                    return;
                }
                if (Object.keys(playersMap).length >= maxPlayers) { throw new Error("لابی پر است."); }
                
                // Add player to map using dot notation for the key
                await updateDoc(lobbyRef, {
                    [`players.${userId}`]: displayName
                });
                
                showMessageBox(`شما به لابی "${lobbyData.name}" وارد                // Add player to map using dot notation for the key
                await updateDoc(lobbyRef, {
                    [`players.${userId}`]: displayName
                });
                
                showMessageBox(`شما به لابی "${lobbyData.name}" شدید.`, "success");
                
                currentLobbyId = lobbyId;
                userHasActiveL وارد شدید.`, "success");
                
                currentLobbyId = lobbyId;
                userHasActiveobby = true;
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
            } catch (e) {
                console.error("خطا در ورود به لابی: ", e);
                throw e; // Re-throw to be caught by the caller
            }
        }
        
        function setupLobbyDetailListener(lobbyId) {
            console.log(`Lobby = true;
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
            } catch (e) {
                console.error("خطا در ورود به لابی: ", e);
                throw e; // Re-throw to be caught by the caller
            }
Listening to lobby details for ID: ${lobbyId}`);
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat =        }
        
        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to lobby details for ID: ${lobbyId}`);
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }
            
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const unsubscribe = onSnapshot(lobbyRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const = null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }
            
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const unsubscribe = onSnapshot(lobbyRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const lobby lobbyData = docSnap.data();
                    const isCurrentUserHost = auth.currentUser && lobbyData.hostId === auth.currentUser.uid;

                    // NEW: Check if game has started
                    if (lobbyData.status === 'Data = docSnap.data();
                    const isCurrentUserHost = auth.currentUser && lobbyData.hostId === auth.currentUser.uid;

                    // NEW: Check if game has started
                    if (lobbyData.statusplaying') {
                        if (currentActiveScreen !== gameScreen) {
                            setActiveScreen(gameScreen);
                        }
                        // Start the game listener if it's not already running
                        if (!unsubscribeGame) { === 'playing') {
                        if (currentActiveScreen !== gameScreen) {
                            setActiveScreen(gameScreen);
                        }
                        // Start the game listener if it's not already running
                        if (!unsubscribeGame) {

                            unsubscribeGame = setupGameListener(lobbyId);
                        }
                        return; // Stop processing lobby details, let game listener take over
                    }

                    const playersMap = lobbyData.players || {};
                    const playerCount = Object                            unsubscribeGame = setupGameListener(lobbyId);
                        }
                        return; // Stop processing lobby details, let game.keys(playersMap).length;
                    const maxPlayers = lobbyData.gameSettings?.maxPlayers ||  listener take over
                    }

                    const playersMap = lobbyData.players || {};
                    const playerCount = Object.keys(playersMap).length;
                    const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                    const isChatLocked = lobbyData.isChatLocked || false;

                    if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                    unsubscribeLobbyChat = setupLobbyChatListener(lobbyId,4;
                    const isChatLocked = lobbyData.isChatLocked || false;

                    if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                    unsubscribeLobbyChat = setupLobbyChatListener(lobbyId, lobbyData.hostId);

                    detailLobbyName.textContent = lobbyData.name;
                    detailHost lobbyData.hostId);

                    detailLobbyName.textContent = lobbyData.name;
                    detailHostName.textContent = `سازنده: ${playersMap[lobbyData.hostId] || 'ناشناس'}`;
                    detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                    if (auth.currentUser && lobbyData.kickedPlayers?.some(p => p.uid === auth.currentUser.uid)) {
                        showKickedMessageModal(lobbyData.name);
                        return;
                    }

Name.textContent = `سازنده: ${playersMap[lobbyData.hostId] || 'ناشناس'}`;
                    detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                    if (auth.currentUser && lobbyData.kickedPlayers?.some(p => p.uid === auth.currentUser.uid)) {
                        showKickedMessageModal(lobbyData.name);
                        return;
                    }

                    playerListContainer.innerHTML = '';
                    const playerList = Object.entries(playersMap).map(([uid, displayName]) => ({ uid, displayName }));

                    for (const player of playerList) {
                        const isHost = player.uid === lobbyData.hostId;
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-list-item';
                        if (isHost) playerItem.                    playerListContainer.innerHTML = '';
                    const playerList = Object.entries(playersMap).map(([uid, displayName]) => ({ uid, displayName }));

                    for (const player of playerList) {
                        const isHost = player.uid === lobbyData.hostId;
                        const playerItem = document.createElement('div');classList.add('is-host');

                        const kickButtonHtml = (isCurrentUserHost && !isHost) 
                            ? `<button class="kick-player-btn" data-player-uid="${player.uid}" data-player-name="${player.displayName}">اخراج</button>` 
                            : '';
                        
                        const hostLabelHtml = isHost ? '<span class="host-label">(سازنده)</span>' : '';

                        playerItem.
                        playerItem.className = 'player-list-item';
                        if (isHost) playerItem.classList.add('is-host');

                        const kickButtonHtml = (isCurrentUserHost && !isHost) 
                            ? `<button class="kick-player-btn" data-player-uid="${player.uid}" data-player-name="${player.displayName}">اخراج</button>` 
                            : '';
                        
                        const hostLabelHtml = isHost ? '<span class="host-label">(سازنده)</span>' : '';

                        playerItem.innerHTML =innerHTML = `
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 lucide lucide-user"><path d="M19 21v-2a4 `
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <span class="player-name">${player.displayName}</span>
                                ${hostLabelHtml}
                            </div>
                            ${kickButtonHtml}
                        `;
                        playerListContainer.appendChild(playerItem);
                    }

                    player-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <span class="player-name">${player.displayName}</span>
                                ${hostLabelHtml}
                            </div>
                            ${kickButtonHtml}
                        `;
                        playerListContainer.appendChild(playerItem);
                    }

                    playerListContainer.querySelectorAll('.kick-player-btn').forEach(button => {
                        button.addEventListenerListContainer.querySelectorAll('.kick-player-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                           openKickPlayerConfirmModal(e.currentTarget.dataset.playerName, e.currentTarget.dataset.playerUid);
                        });
                    });

                    // === LOGIC CHANGE: Manage "Leave/Close Lobby" Button Visibility ===
                    if (isCurrentUserHost) {
                        leaveLobbyBtn.classList.remove('hidden('click', (e) => {
                           openKickPlayerConfirmModal(e.currentTarget.dataset.playerName, e.currentTarget.dataset.playerUid);
                        });
                    });

                    // === LOGIC CHANGE: Manage "Leave/Close Lobby" Button Visibility ===
                    if (isCurrentUserHost) {
                        leaveLobbyBtn.classList.remove('');
                        leaveLobbyBtn.textContent = 'بستن لابی'; // Host closes the lobby
                    } else {
                        // Per instructions, the leave button is hidden for non-hosts.
                        // They must use the back button in the header (if available) or restart to leave.
                        leaveLobbyBtn.classList.addhidden');
                        leaveLobbyBtn.textContent = 'بستن لابی'; // Host closes the lobby
                    } else {
                        // Per instructions, the leave button is hidden for non-hosts.
                        // They must use the back button in the header (if available) or restart to leave.
                        leaveLobbyBtn.classList.('hidden');
                    }

                    // Manage Host Actions
                    if (isCurrentUserHost) {
                        hostActionsContainer.style.display = 'flex';
                        startGameBtn.disabled = playerCount !== maxPlayers;
                        startGameBtn.textContent = `شروع بازی (${playerCount}/${maxPlayers})`;
                        
                        toggleChatLockBtnadd('hidden');
                    }

                    // Manage Host Actions
                    if (isCurrentUserHost) {
                        hostActionsContainer.style.display = 'flex';
                        startGameBtn.disabled = playerCount !== maxPlayers;
                        startGameBtn.textContent = `شروع بازی (${playerCount}/${maxPlayers})`;
                        
                        toggleChatLock.textContent = isChatLocked ? 'باز کردن چت' : 'قفل کردن چت';

                    } else {
                        hostActionsContainer.style.display = 'none';
                    }

                    if (isChatLocked && Btn.textContent = isChatLocked ? 'باز کردن چت' : 'قفل کردن چت';

                    } else {
                        hostActionsContainer.style.display = 'none';
                    }

                    if (isChatLocked && !isCurrentUserHost) {
                        lobbyChatInput.disabled = true;
                        lobbyChatSendBtn.disabled = true;
                        lobbyChatInput.placeholder = "چت توسط سازنده قفل شده است";
                    }!isCurrentUserHost) {
                        lobbyChatInput.disabled = true;
                        lobbyChatSendBtn.disabled = true;
                        lobbyChatInput.placeholder = "چت توسط سازنده قفل شده است";
                    } else {
                        lobbyChatInput.disabled = false;
                        lobbyChatSendBtn.disabled = false;
                        lobbyChatInput.placeholder = "پیام خود را بنویسید...";
                    }


                } else { else {
                        lobbyChatInput.disabled = false;
                        lobbyChatSendBtn.disabled = false;

                    showMessageBox("لابی که در آن بودید بسته شد یا بازی شروع شد.", "info");
                    setActive                        lobbyChatInput.placeholder = "پیام خود را بنویسید...";
                    }


                } else {
                    showMessageBox("لابی که در آن بودید بسته شد یا بازی شروع شد.", "info");
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            }, (errorScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            }, (error) => {
                console.error("Lobby detail listener error:", error);
                showMessageBox("خطا در بارگذاری جزئیات لابی.", "error");
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobby) => {
                console.error("Lobby detail listener error:", error);
                showMessageBox("خطا در بارگذاری جزئیات لابی.", "error");
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            });
            return unsubscribe;
        }

        async function leaveLobby() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const userId = auth.currentUser.uid;
Listener('');
            });
            return unsubscribe;
        }

        async function leaveLobby() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const userId = auth.currentUser.uid;
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) {
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                    return;
                }
                const isHost = lobbySnap.data().hostId === userId;
                // The button is now only visible to the host, so this check is redundant but safe.
                if (isHost) {
                    const confirmed = await            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) {
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                    return;
                }
                const isHost = lobbySnap.data().hostId === userId;
                // The button is now only visible showCustomConfirm("شما سازنده لابی هستید. خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟", "بستن لابی");
                    if (confirmed) {
                        await deleteDoc(lobbyRef);
                        // The onSnapshot listener will handle screen transition for all players.
                    }
                } else {
                    // This block is now unreachable via the UI as per the new requirement, but the logic is kept for safety. to the host, so this check is redundant but safe.
                if (isHost) {
                    const confirmed = await showCustomConfirm("شما سازنده لابی هستید. خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟", "بستن لابی");
                    if (confirmed) {
                        await deleteDoc(lobbyRef);
                        // The onSnapshot listener will handle screen transition for all players.
                    }
                } else {
                    // This block is now unreachable via the UI as per the new requirement, but the logic is kept for safety.
                    console.warn("A non-host tried to leave the lobby. This path should not be reachable.");
                    await updateDoc(lobbyRef, {
                        [`players.${userId}`]: deleteField()
                    });
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            } catch (e
                    console.warn("A non-host tried to leave the lobby. This path should not be reachable.");
                    await updateDoc(lobbyRef, {
                        [`players.${userId}`]: deleteField()
                    });
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            } catch (e) { console) { console.error("Error leaving lobby:", e); showMessageBox("خطا در ترک لابی.", "error"); }
        }

        async function kickPlayer(lobbyId, playerToKickUid, playerToKickDisplayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                await updateDoc.error("Error leaving lobby:", e); showMessageBox("خطا در ترک لابی.", "error"); }
        }

        async function kickPlayer(lobbyId, playerToKickUid, playerToKickDisplayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    [`players.${playerToKickUid}`]: deleteField(),
                    kickedPlayers: arrayUnion({ uid: playerToKickUid, displayName: playerToKickDisplayName })
                });
                showMessageBox(`باز(lobbyRef, {
                    [`players.${playerToKickUid}`]: deleteField(),
                    kickedPlayers: arrayUnion({ uid: playerToKickUid, displayName: playerToKickDisplayName })
                });
                showMessageBox(`یکن "${playerToKickDisplayName}" اخراج شد.`, "success");
                closeKickPlayerConfirmModal();
            } catch (e) { console.error("Error kicking player:", e); showMessageBox("خطا در اخبازیکن "${playerToKickDisplayName}" اخراج شد.`, "success");
                closeKickPlayerConfirmModal();
            } catch (e) { console.error("Error kicking player:", e); showMessageBox("خطا در اخراج بازیکن.", "راج بازیکن.", "error"); }
        }

        async function unkickPlayer(lobbyId, playerToUnkickUid) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
error"); }
        }

        async function unkickPlayer(lobbyId, playerToUnkickUid) {            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists()) {
                    const kickedPlayers = lobbySnap.data().kickedPlayers || [];
                    const playerToUn
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists()) {
                    const kickedPlayers = lobbySnap.data().kickedPlayers || [];
                    const playerToUnkick = kickedPlayers.find(p => p.uid === playerToUnkickUid);
                    if (playerToUnkick) {
                        await updateDoc(lobbyRef, { kickedPlayers: arrayRemove(playerToUnkick) });
kick = kickedPlayers.find(p => p.uid === playerToUnkickUid);
                    if (playerToUnkick) {
                        await updateDoc(lobbyRef, { kickedPlayers: arrayRemove(playerToUnkick) });
                        showMessageBox(`بازیکن "${playerToUnkick.displayName}" می‌تواند دوباره وارد شود.`, "success");                        showMessageBox(`بازیکن "${playerToUnkick.displayName}" می‌تواند دوباره وارد شود.`, "success");
                    }
                }
            } catch (e) { console.error("Error unkicking player:", e); showMessageBox("خطا در بازگرداندن بازیکن.", "error"); }
        }

        function setupKickedPlayers
                    }
                }
            } catch (e) { console.error("Error unkicking player:", e); showMessageBox("خطا در بازگرداندن بازیکن.", "error"); }
        }

        function setupKickedPlayersListListener(lobbyId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                kickedPlayersListContent.innerHTML = '';
                if (docSnap.exists()) {
                    const kickedPlayers = docSnap.dataListListener(lobbyId) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                kickedPlayersListContent.innerHTML = '';
                if (docSnap.exists()) {
                    const kickedPlayers = docSnap.data().kickedPlayers || [];
                    if (kickedPlayers.length === 0) {
                        kicked().kickedPlayers || [];
                    if (kickedPlayers.length === 0) {
                        kickedPlayersListContent.innerHTML = '<p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p>';
                    } else {
                        kickedPlayers.forEach(player => {
                            const playerDiv = document.createElement('div');
                            playerDiv.className = 'flex items-PlayersListContent.innerHTML = '<p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p>';
                    } else {
                        kickedPlayers.forEach(player => {
                            const playerDiv = document.createElement('div');
                            playerDiv.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg mb-2';
                            playerDiv.innerHTML = `<span>${player.displayName}</span><button data-player-uid="${player.uid}" class="unkick-player-btn classic-btn btn-green-classic text-sm py-1 px-3">بازcenter justify-between bg-gray-700 p-3 rounded-lg mb-2';
                            playerDiv.innerHTML = `<span>${player.displayName}</span><button data-player-uid="${player.uid}" class="unkick-player-btn classic-btn btn-green-classic text-sm py-1 px-گرداندن</button>`;
                            kickedPlayersListContent.appendChild(playerDiv);
                        });
                        kickedPlayersListContent.querySelectorAll('.unkick-player-btn').forEach(button => {
                            button.addEventListener('click', (e) => unkickPlayer(currentLobbyId, e.target.dataset.player3">بازگرداندن</button>`;
                            kickedPlayersListContent.appendChild(playerDiv);
                        });
                        kickedPlayersListContent.querySelectorAll('.unkick-player-btn').forEach(button => {
                            button.addEventListener('click', (e) => unkickPlayer(currentLobbyId, e.target.dataset.playerUid));
                        });
                    }
                }
            });
        }
        
        async function sendLobbyMessage(lobbyId, text) {
            if (!text.trim() || !auth.currentUser || !currentUserData) return;
            const messagesRef = collection(db, `global_lobbies/${lobbyIdUid));
                        });
                    }
                }
            });
        }
        
        async function sendLobbyMessage(lobbyId, text) {
            if (!text.trim() || !auth.currentUser || !currentUserData) return;
            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            try {
                await addDoc(messagesRef, {
                    text: text.trim(),
                    senderUid: auth.currentUser.uid,
                    senderName: currentUserData.displayName,
                    }/messages`);
            try {
                await addDoc(messagesRef, {
                    text: text.trim(),
                    senderUid: auth.currentUser.uid,
                    senderName: currentUserData.displayName,
                    timestamp: serverTimestamp(),
                    isDeleted: false // NEW
                });
                lobbyChatInput.value = ''; // Clear input after sending
            } catch (error) {
                console.error("Error sending chat message:", error);timestamp: serverTimestamp(),
                    isDeleted: false // NEW
                });
                lobbyChatInput.value = ''; // Clear input after sending
            } catch (error) {
                console.error("Error sending chat message:", error);
                showMessageBox("خطا در ارسال پیام.", "error");
            }
        }
        
        // NEW: Soft-deletes a message
        async function deleteLobbyMessage(lobbyId, messageId) {
            const messageRef = doc(db, `global_lobbies/${lobbyId}/messages`, messageId
                showMessageBox("خطا در ارسال پیام.", "error");
            }
        }
        
        // NEW: Soft-deletes a message
        async function deleteLobbyMessage(lobbyId, messageId) {
            );
            try {
                await updateDoc(messageRef, {
                    text: "[این پیام حذف شده است]",
                    isDeleted: true
                });
            } catch (error) {
                console.errorconst messageRef = doc(db, `global_lobbies/${lobbyId}/messages`, messageId);
            try {
                await updateDoc(messageRef, {
                    text: "[این پیام حذف شده است]",
("Error deleting message:", error);
                showMessageBox("خطا در حذف پیام.", "error");
            }                    isDeleted: true
                });
            } catch (error) {
                console.error("Error deleting message:", error);
                showMessageBox("خطا در حذف پیام.", "error");
            }
        }
        }

        function setupLobbyChatListener(lobbyId, hostId) {
            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            return onSnapshot(q, (snapshot) => {
                lobbyChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    const

        function setupLobbyChatListener(lobbyId, hostId) {
            const messagesRef = collection(db, `global_lobbies/${lobbyId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            return onSnapshot(q, (snapshot) => {
                lobbyChatMessages.innerHTML = messageId = doc.id;
                    const isCurrentUserMsg = messageData.senderUid === auth.currentUser.uid;
                    const isCurrentUserHost = auth.currentUser.uid === hostId;

                    const canDelete = !messageData.isDeleted && (isCurrentUserMsg || isCurrentUserHost);

                    const messageDiv = document.createElement('div '';
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    const messageId = doc.id;
                    const isCurrentUserMsg = messageData.senderUid === auth.currentUser.uid;
                    const isCurrentUserHost = auth.currentUser.uid === hostId;

                    const canDelete = !messageData.isDeleted && (isCurrentUserMsg || isCurrentUserHost);

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('chat-message');
                    if (isCurrentUserMsg) {
                        ');
                    messageDiv.classList.add('chat-message');
                    if (isCurrentUserMsg) {
                        messageDiv.classList.add('current-user');
                    }
                    
                    const deleteButtonHtml = canDelete ? `
                        <button class="delete-message-btn" data-message-id="${messageId}" title="حذف پیام">
                            <svg xmlns="http://www.w3.org/20messageDiv.classList.add('current-user');
                    }
                    
                    const deleteButtonHtml = canDelete ? `
                        <button class="delete-message-btn" data-message-id="${messageId}" title="حذف پیام">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 200/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1--2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10"2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="1 y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    ` : '';

                    const messageContentHtml = messageData.isDeleted ? `
                        <p class="message-text1" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    ` : '';

                    const messageContentHtml = messageData.isDeleted ? `
                        <p class="message-text-deleted">${message-deleted">${messageData.text}</p>
                    ` : `
                        <span class="sender-name">${messageData.senderName}</span>
                        <p class="message-text">${messageData.text}</p>
                    `;

                    messageDiv.innerHTML = `
                        <div class="chat-message-content">
Data.text}</p>
                    ` : `
                        <span class="sender-name">${messageData.senderName}</span>
                        <p class="message-text">${messageData.text}</p>
                    `;

                    messageDiv.innerHTML = `
                        <div class="chat-message-content">
                            ${messageContentHtml}
                            ${messageContentHtml}
                        </div>
                        ${deleteButtonHtml}
                    `;
                    lobbyChatMessages.appendChild(messageDiv);
                });
                // Auto-scroll to the bottom
                lobbyChatMessages.scrollTop = lobbyChatMessages.scrollHeight;
            }, (error) => {
                console.error("Lobby chat listener error                        </div>
                        ${deleteButtonHtml}
                    `;
                    lobbyChatMessages.appendChild(messageDiv);
                });
                // Auto-scroll to the bottom
                lobbyChatMessages.scrollTop = lobbyChatMessages.scrollHeight;
            }, (error) => {
                console.error("Lobby chat listener error:", error);
                console.:", error);
                console.warn("Could not load chat messages:", error.message);
            });
        }
        
        // --- Game Logic Functions (NEW) ---

        function createShuffledDeck() {
            const suits = ['H', 'D', 'C', 'S']; // Hearts, Diamonds, Clubs, Spwarn("Could not load chat messages:", error.message);
            });
        }
        
        // --- Game Logic Functions (NEW) ---

        function createShuffledDeck() {
            const suits = ['H', 'D', 'C', 'S']; // Hearts, Diamonds, Clubs, Spades
            const ranks = ['2', 'ades
            const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
            const3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
            const deck = [];
            for (const suit of deck = [];
            for (const suit of suits) {
                for (const rank of ranks) {
                    deck.push(rank + suit); // Swapped to Rank+Suit for easier parsing
                }
            }
             suits) {
                for (const rank of ranks) {
                    deck.push(rank + suit); // Swapped to Rank+Suit for easier parsing
                }
            }
            // Fisher-Yates Shuffle
// Fisher-Yates Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        
            return deck;
        }

        async function initializeGameInFirestore(lobbyId, lobbyData) {
            const deck = createShuffledDeck();
            const playerUIDs = Object.keys(lobbyData.players);
            
            const hands = {};
            playerUIDs.forEach((uid, index) => {
                hands}

        async function initializeGameInFirestore(lobbyId, lobbyData) {
            const deck = createShuffledDeck();
            const playerUIDs = Object.keys(lobbyData.players);
            
            const hands = {};
            playerUIDs.forEach((uid, index) => {
                hands[uid] = deck.slice(index[uid] = deck.slice(index * 13, (index + 1) * 13);
            });

            const hakem = lobbyData.hostId;

            const initialGameState = {
                 * 13, (index + 1) * 13);
            });

            const hakem = lobbyData.hostId;

            const initialGameState = {
                players: playerUIDs,
                players: playerUIDs,
                playerNames: lobbyData.players, // Map of uid -> displayName
                hakem: hakem,
                currentTurn: hakem,
                phase: 'CHOOSE_HOKMplayerNames: lobbyData.players, // Map of uid -> displayName
                hakem: hakem,
                currentTurn: hakem,
                phase: 'CHOOSE_HOKM',
                hokmSuit:',
                hokmSuit: null,
                hands: hands,
                currentTrick: [],
                scores: { team1: 0, team2: 0 },
                roundPoints: { team1: 0, team2: 0 },
            };

            const lobbyRef = doc(db, 'global_ null,
                hands: hands,
                currentTrick: [],
                scores: { team1: 0, team2: 0 },
                roundPoints: { team1: 0, team2: 0 },
            lobbies', lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    gameState: initialGameState,
                    status: "playing"
                });
                console.log(`Game state initialized for lobby};

            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            try {
                await updateDoc(lobbyRef, {
                    gameState: initialGameState,
                    status: "playing"
                 ${lobbyId}`);
            } catch (error) {
                console.error("Error initializing game state:", error);
                await updateDoc(lobbyRef, { status: "waiting" }); // Revert on failure
                });
                console.log(`Game state initialized for lobby ${lobbyId}`);
            } catch (error) {
                console.error("Error initializing game state:", error);
                await updateDoc(lobbyRef, { statusthrow new Error("Failed to initialize game.");
            }
        }
        
        function setupGameListener(lobbyId) {
            console.log(`Listening to game state for lobby ID: ${lobbyId}`);
            : "waiting" }); // Revert on failure
                throw new Error("Failed to initialize game.");
            }
        }
        
        function setupGameListener(lobbyId) {
            console.log(`Listening to game state forif (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef lobby ID: ${lobbyId}`);
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            const lobbyRef = doc(db, `global_lobbies`, lobbyId, (docSnap) => {
                if (docSnap.exists() && docSnap.data().gameState) {
                    const lobbyData = docSnap.data();
                    renderGameScreen(lobbyData);
                });
            return onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().gameState) {
                    const lobbyData = docSnap.data();
                    renderGameScreen( else {
                    showMessageBox("بازی مورد نظر پایان یافت یا با خطا مواجه شد.", "info");
                    setActiveScreen(lobbyData);
                } else {
                    showMessageBox("بازی مورد نظر پایان یافت یا با خطا مواجه شدlobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            }, (error) => {
                console.error("Game state listener error:", error);
                showMessageBox("ارتباط با بازی قطع شد.", "error");
                setActiveScreen(lobbyScreen);
                unsubscribeLobbies = setupLobbyListener('');
            });
        }

        function renderGameScreen(lobbyData) {
            const gameState = lobbyData.", "info");
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            }, (error) => {
                console.error("Game state listener error:", error);
                showMessageBox("ارتباط با بازی قطع شد.", "error");
                setActiveScreen(lobbyScreen);
                unsubscribe.gameState;
            const myUid = auth.currentUser.uid;
            
            // Find my position in the game
            const myIndex = gameState.players.indexOf(myUid);
            if (myIndex === -1) {
                console.error("Current user not found in game players list!");
                // Possibly kicked during game start transition, or an error occurred.
                leaveGameBtn.click(); // Force leave
                return;
            }

            // Define positions relative to me
            const positions = ['bottom', 'left', 'top',Lobbies = setupLobbyListener('');
            });
        }

        function renderGameScreen(lobbyData) {
            const gameState = lobbyData.gameState;
            const myUid = auth.currentUser.uid;
            
            // Find my position in the game
            const myIndex = gameState.players.indexOf(myUid);
            if (myIndex === -1) {
                console.error("Current user not found in game players list!");
                // Possibly kicked during game start transition, or an error occurred.
                leaveGameBtn.click(); // Force leave
                return;
            }

            // Define positions relative to me
            const positions = ['bottom', 'left', 'top', 'right'];
            const slotMap = {}; // Maps UID to slot name ('bottom', 'left 'right'];
            const slotMap = {}; // Maps UID to slot name ('bottom', 'left', etc.)
            gameState.players.forEach((uid, index) => {
                const relativeIndex = (index - myIndex + ', etc.)
            gameState.players.forEach((uid, index) => {
                const relativeIndex = (index - myIndex + 4) % 4;
                slotMap[uid] = positions[relativeIndex];
            });

            // Render player names and turn indicator
            for (const uid in slotMap) {
                const slotName = slotMap[uid];
                const slotElement = playerSlots[slotName];
4) % 4;
                slotMap[uid] = positions[relativeIndex];
            });

            // Render player names and turn indicator
            for (const uid in slotMap) {
                const slotName = slotMap[uid];
                const slotElement = playerSlots[slotName];
                const nameDisplay = slotElement.querySelector('.player-name-display');
                nameDisplay.textContent = gameState.playerNames[uid];

                // Clear previous active turns before setting the new one
                Object.values(playerSlots).forEach(slot => slot.classList.remove('active-turn'));

                if (uid === gameState.currentTurn) {
                    slot                const nameDisplay = slotElement.querySelector('.player-name-display');
                nameDisplay.textContent = gameState.playerNames[uid];

                // Clear previous active turns before setting the new one
                Object.values(playerSlots).forEach(slot => slot.classList.remove('active-turn'));

                if (uid === gameState.currentTurn) {
                    slotElement.classList.add('active-turn');
                }
            }

            // Render hands
            for (const uid in gameState.hands) {
                const hand = gameState.Element.classList.add('active-turn');
                }
            }

            // Render hands
            for (const uid in gameState.hands) {
                const hand = gameState.hands[uid];
                const slotName = slotMap[uid];
                if (!slotName) continue; // Skip if player not in slot map (e.g., left game)

                const handContainer = playerSlots[slotName].querySelector('.player-hand');
                handContainer.innerHTML = ''; // Clear old cards

                /*
                // --- CARD RENDERING LOGIC DISABLEDhands[uid];
                const slotName = slotMap[uid];
                if (!slotName) continue; // Skip if player not in slot map (e.g., left game)

                const handContainer = playerSlots[slotName].querySelector('.player-hand');
                handContainer.innerHTML = ''; // Clear old cards

                /*
                // --- CARD RENDERING LOGIC DISABLED AS PER INSTRUCTIONS ---
                if (uid === myUid) {
                    // AS PER INSTRUCTIONS ---
                if (uid === myUid) {
                    // My hand - face up
                    hand.sort(); // Sort my hand for better view
                    hand.forEach(cardStr => {
                        handContainer.appendChild(createCardElement(cardStr, false));
                    });
                } else {
                    // Others' hands - face My hand - face up
                    hand.sort(); // Sort my hand for better view
                    hand.forEach(cardStr => {
                        handContainer.appendChild(createCardElement(cardStr, false));
                    });
                } else {
                    // Others' hands - face down
                    hand.forEach(() => {
                        handContainer down
                    hand.forEach(() => {
                        handContainer.appendChild(createCardElement(null, true));
                    });
                }
                */
            }
             // TODO: Render scores, hokm, and play area later
        }

        function createCardElement(cardStr, isBack) {
            const cardDiv.appendChild(createCardElement(null, true));
                    });
                }
                */
            }
             // TODO: Render scores, hokm, and play area later
        }

        function createCardElement(cardStr, isBack) {
            const cardDiv = document.createElement('div');
            cardDiv.className = = document.createElement('div');
            cardDiv.className = 'card';
            
            if (isBack) {
                cardDiv.classList.add('back');
                return cardDiv;
            }

            const suitMap = { 'S': '♠', 'H': '♥', 'D': '♦', 'card';
            
            if (isBack) {
                cardDiv.classList.add('back');
                return cardDiv;
            }

            const suitMap = { 'S': '♠', 'H': '♥', 'D': '♦', 'C': '♣' };
            const colorMap = { 'C': '♣' };
            const colorMap = { 'S': 'black', 'H': 'red', 'D': 'red', 'C': 'black' };

            const rank = cardStr.substring(0, cardStr.length - 1);
            const suitChar = cardStr.slice(-1); 'S': 'black', 'H': 'red', 'D': 'red', 'C': 'black' };

            const rank = cardStr.substring(0, cardStr.length - 1);
            const suitChar = cardStr.slice(-1);
            const suitSymbol = suitMap[suitChar];
            
            const suitSymbol = suitMap[suitChar];
            const color = colorMap[suitChar];

            cardDiv.classList.add(color);
            cardDiv.dataset.card = cardStr;

            cardDiv.innerHTML = `
                <div class="card-suit top">${suitSymbol}</div>
                <const color = colorMap[suitChar];

            cardDiv.classList.add(color);
            cardDiv.dataset.card = cardStr;

            cardDiv.innerHTML = `
                <div class="card-suit top">${div class="card-rank">${rank}</div>
                <div class="card-suit bottom">${suitSymbol}</div>
            `;
            return cardDiv;
        }


        // --- Event Listeners ---
        //suitSymbol}</div>
                <div class="card-rank">${rank}</div>
                <div class="card-suit bottom">${suitSymbol}</div>
            `;
            return cardDiv;
        }


        // --- Event Listeners ---
        // Auth, Profile, Modals, Lobby List
        loginToggleBtn.addEventListener(' Auth, Profile, Modals, Lobby List
        loginToggleBtn.addEventListener('click', () => {
            authMode = 'login';
            displayNameField.classList.add('hidden');
            submitAuthBtn.textContent = 'ورود';
            submitAuthBtn.classList.remove('hidden');
            loginToggleBtn.classList.click', () => {
            authMode = 'login';
            displayNameField.classList.add('hidden');
            submitAuthBtn.textContent = 'ورود';
            submitAuthBtn.classList.remove('hidden');
            loginToggleBtn.classList.add('hidden');
            registerToggleBtn.classList.remove('hidden');add('hidden');
            registerToggleBtn.classList.remove('hidden');
            emailInput.focus();
            authForm.reset();
        });

        registerToggleBtn.addEventListener('click', () => {
            authMode = 'register';
            displayNameField.classList.remove('hidden');
            submitAuthBtn.textContent
            emailInput.focus();
            authForm.reset();
        });

        registerToggleBtn.addEventListener('click', () => {
            authMode = 'register';
            displayNameField.classList.remove('hidden');
            submitAuthBtn.textContent = 'ثبت نام';
            submitAuthBtn.classList.remove(' = 'ثبت نام';
            submitAuthBtn.classList.remove('hidden');
            registerToggleBtn.classList.add('hidden');
            loginToggleBtn.classList.remove('hidden');
            emailInput.focus();
            authForm.reset();
        });

        authForm.addEventListener('submit', async (e)hidden');
            registerToggleBtn.classList.add('hidden');
            loginToggleBtn.classList.remove('hidden');
            emailInput.focus();
            authForm.reset();
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput. => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const displayName = displayNameInput.value.trim();

            if (value.trim();
            const password = passwordInput.value.trim();
            const displayName = displayNameInput.value.trim();

            if (!email || !password) { showMessageBox("لطفاً ایمیل و رمز عب!email || !password) { showMessageBox("لطفاً ایمیل و رمز عبور را وارد کنید.", 'error'); return; }
            if (authMode === 'register' && !displayName) { showMessageBox("لطفاً نام نمایور را وارد کنید.", 'error'); return; }
            if (authMode === 'register' && !displayName) { showMessageBox("لطفاً نام نمایشی را وارد کنید.", 'error'); return; }
            if (authMode ===شی را وارد کنید.", 'error'); return; }
            if (authMode === 'register' && password.length < 6) { showMessageBox("رمز عبور باید حداقل ۶ کاراکتر باشد.", "error"); return; } 'register' && password.length < 6) { showMessageBox("رمز عبور باید حداقل ۶ کاراکتر

            try {
                if (authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email باشد.", "error"); return; }

            try {
                if (authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile/data`);
                    await setDoc(, password);
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile/data`);
                    await setDoc(userDocRef, { displayName: displayName, email: email }, { merge: true });
                }
            } catch (error) { showMessageBox(getFirebaseErrorMessage(error.code), 'error'); }
        });

        menuBtn.addEventListener('click', openProfileModal);
        profileSummary.addEventListener('click', openProfileModal);
        closeProfileModalBtn.addEventListeneruserDocRef, { displayName: displayName, email: email }, { merge: true });
                }
            } catch (error) { showMessageBox(getFirebaseErrorMessage(error.code), 'error'); }
        });

        menuBtn.addEventListener('click', openProfileModal);
        profileSummary.addEventListener('click', openProfileModal);
        closeProfileModalBtn.addEventListener('click', closeProfileModal);
        profileModal.addEventListener('click', (e('click', closeProfileModal);
        profileModal.addEventListener('click', (e) => e.target === profileModal && closeProfileModal());
        
        profileLogoutBtn.addEventListener('click', async () => {
            try { await signOut(auth); closeProfileModal(); } catch (error) { showMessageBox(getFirebaseErrorMessage(error.code), 'error'); }
        });

        friendlyGameBtn.addEventListener('click', () =>) => e.target === profileModal && closeProfileModal());
        
        profileLogoutBtn.addEventListener('click', async () => {
            try { await signOut(auth); closeProfileModal(); } catch (error) { showMessageBox(getFirebaseErrorMessage(error.code), 'error'); }
        });

        friendlyGameBtn.addEventListener('click', () => {
            if (!auth.currentUser) { showMessageBox("برای مشاهده لابی‌ها {
            if (!auth.currentUser) { showMessageBox("برای مشاهده لابی‌ها، ابتدا وارد شوید.", "error"); return; }
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener('');
        });
        
        ratedGameBtn.addEventListener('click', () => showMessageBox("بازی امتیازی، ابتدا وارد شوید.", "error"); return; }
            setActiveScreen(lobbyScreen);
            unsubscribeLobbies = setupLobbyListener('');
        });
        
        ratedGameBtn.addEventListener('click', () => showMessageBox("بازی امتیازی به زودی!", "info"));

        backToMainBtn.addEventListener('click', به زودی!", "info"));

        backToMainBtn.addEventListener('click', () => {
            setActiveScreen(mainScreen);
            if (unsubscribeLobbies) unsubscribeLobbies();
            if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
            if (unsubscribeLobbyChat) unsubscribeLobbyChat();
            if (unsubscribeGame () => {
            setActiveScreen(mainScreen);
            if (unsubscribeLobbies) unsubscribeLobbies();
            if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
            if (unsubscribeLobbyChat) unsubscribeLobbyChat();
            if (unsubscribeGame) unsubscribeGame();
            unsubscribeLobbies = unsubscribeLobbyDetail =) unsubscribeGame();
            unsubscribeLobbies = unsubscribeLobbyDetail = unsubscribeLobbyChat = unsubscribeGame = null;
        });

        addIconBtn.addEventListener('click', () => {
            if (!auth.currentUser) { showMessageBox("برای ساخت لابی، ابتدا وارد شوید.", "error"); return; }
            if (userHasActiveLobby) unsubscribeLobbyChat = unsubscribeGame = null;
        });

        addIconBtn.addEventListener('click', () => {
            if (!auth.currentUser) { showMessageBox("برای ساخت لابی، ابتدا وارد شوید.", "error"); return; }
            if (userHasActiveLobby) { showMessageBox("شما از قبل در یک لابی { showMessageBox("شما از قبل در یک لابی فعال هستید.", "info"); return; }
            openCreateLobbyModal();
        });
        
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lobbyName = newLobbyNameInput.value. فعال هستید.", "info"); return; }
            openCreateLobbyModal();
        });
        
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lobbyName = newLobbyNameInput.value.trim();
            const lobbyType = document.querySelector('trim();
            const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;
        
            if (!lobbyName) { showCreateLobbyMessageBox("لطفاً نام لابی را وارد کنید.", "error"); return; }
            ifinput[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;
        
            if (!lobbyName) { showCreateLobbyMessageBox("لطفاً نام لابی را وارد کنید.", "error"); return; }
            if (lobbyType === 'private' && password.length < (lobbyType === 'private' && password.length < 4) { showCreateLobbyMessageBox("رمز عبور برای لابی خصوصی باید حداقل ۴ کاراکتر باشد.", "error"); return; }
            if (!auth.currentUser || 4) { showCreateLobbyMessageBox("رمز عبور برای لابی خصوصی باید حداقل ۴ کاراکتر باشد.", "error"); return; }
            if (!auth.currentUser || !currentUserData?.displayName) { showCreate !currentUserData?.displayName) { showCreateLobbyMessageBox("مشکلی در اطلاعات کاربری شما وجود دارد.", "error"); return; }
            if (userHasActiveLobby) { showCreateLobbyMessageBox("شما از قبل درLobbyMessageBox("مشکلی در اطلاعات کاربری شما وجود دارد.", "error"); return; }
            if (userHasActiveLobby) { showCreateLobbyMessageBox("شما از قبل در یک لابی فعال هستید.", " یک لابی فعال هستید.", "info"); closeCreateLobbyModal(); return; }
        
            showCreateLobbyMessageBox("در حال بررسی نام لابی...", "info");
            try {
                const moderationResultinfo"); closeCreateLobbyModal(); return; }
        
            showCreateLobbyMessageBox("در حال بررسی نام لابی...", "info");
            try {
                const moderationResult = await checkLobbyNameWithAI = await checkLobbyNameWithAI(lobbyName);
                if (!moderationResult.is_appropriate) { showCreateLobbyMessageBox(`نام لابی نامناسب: ${moderationResult.reason}`, "error");  (lobbyName);
                if (!moderationResult.is_appropriate) { showCreateLobbyMessageBox(`نام لابی نامناسب: ${moderationResult.reason}`, "error");  return; }
            } catch (return; }
            } catch (aiError) { console.error("خطا در بررسی AI نام لابی:", aiError); showCreateLobbyMessageBox("خطایی در بررسی نام لابی پیش آمد.", "error"); return; }aiError) { console.error("خطا در بررسی AI نام لابی:", aiError); showCreateLobbyMessageBox
        
            try {
                const newLobbyId = await createLobby(lobbyName, auth.("خطایی در بررسی نام لابی پیش آمد.", "error"); return; }
        
            try {
                const newcurrentUser.uid, currentUserData.displayName, lobbyType, password);
                showCreateLobbyMessageBox("لابی شما با موفقیت ساخته شد!", "success");
                
                setTimeout(() => {
                    closeCreateLobbyModal();
                    currentLobbyId = newLobbyId;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyId = await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName, lobbyType, password);
                showCreateLobbyMessageBox("لابی شما با موفقیت ساخته شد!", "success");
                
                setTimeout(() => {
                    closeCreateLobbyModal();
                    currentLobbyId = newLobbyId;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailLobbyDetail = setupLobbyDetailListener(newLobbyId);
                }, 1500);
                
            } catch (error) {
                console.error("خطا در ساخت لابی از مودال:", error);
                showCreateLobbyMessageBox(error.message.includes("شما از قبل یک لابی فعال ساخته‌اید.")Listener(newLobbyId);
                }, 1500);
                
            } catch (error) {
                console.error("خطا در ساخت لابی از مودال:", error);
                showCreateLobbyMessageBox(error.message.includes("شما از قبل یک لابی فعال ساخته‌اید.") ? error.message : ` ? error.message : `خطا در ساخت لابی: ${error.message}`, "error");
            }
        });

        closeCreateLobbyModalBtn.addEventListener('click', closeCreateLobbyModal);
        createLobbyModal.addEventListener('click', (e) => e.target === createLobbyModal && closeCreateLobbyModal());
خطا در ساخت لابی: ${error.message}`, "error");
            }
        });

        closeCreateLobbyModalBtn.addEventListener('click', closeCreateLobbyModal);
        createLobbyModal.addEventListener('click', (e) => e.target === createLobbyModal && closeCreateLobbyModal());
                
        refreshLobbiesBtn.addEventListener('click', () => {
            if (isRefreshing) return;
            if (!auth.currentUser) { showMessageBox("برای بروزرسانی لابی‌ها، ابتدا وارد شوید.", "info"); return; }
            isRefreshing = true;
            refreshLobbiesBtn.disabled = true;
        refreshLobbiesBtn.addEventListener('click', () => {
            if (isRefreshing) return;
            if (!auth.currentUser) { showMessageBox("برای بروزرسانی لابی‌ها، ابتدا وارد شوید.", "info"); return; }
            isRefreshing = true;
            refreshLobbiesBtn.disabled = true;

            const refreshIconSvg = refreshLobbiesBtn.querySelector('svg');
            refreshIconSvg.classList.add('is-refreshing');
            lobbiesList.innerHTML = '<p class="text-gray-4            const refreshIconSvg = refreshLobbiesBtn.querySelector('svg');
            refreshIconSvg.classList.add('is-refreshing');
            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بروزرسانی لیست...</p>';
            if (unsubscribeLobbies) { unsubscribeLobbies();00">در حال بروزرسانی لیست...</p>';
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value.trim(). unsubscribeLobbies = null; }
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value.trim().toLowerCase());
            setTimeout(() => {
                isRefreshing = false;
                refreshLobbiesBtn.disabled = false;
                refreshIconSvg.classList.remove('is-refreshing');
                showMessageBox("لیست لابی‌هاtoLowerCase());
            setTimeout(() => {
                isRefreshing = false;
                refreshLobbiesBtn.disabled = false;
                refreshIconSvg.classList.remove('is-refreshing');
                showMessageBox("لیست لابی‌ها بروزرسانی شد.", "info");
            }, 1000);
        });

        myLobbiesBtn.addEventListener('click', () => showMessageBox("لابی‌های من به زودی!", "info"));
        lobbySearchInput.addEventListener('input', (e) => {
            if (unsubscribeLobbies) unsubscribeLobbies بروزرسانی شد.", "info");
            }, 1000);
        });

        myLobbiesBtn.addEventListener('click', () => showMessageBox("لابی‌های من به زودی!", "info"));
        lobbySearchInput.addEventListener('input', (e) => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(e.target.value.trim().toLowerCase());
        ();
            unsubscribeLobbies = setupLobbyListener(e.target.value.trim().toLowerCase());
        });
        lobbySearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchLobbiesBtn.click());
        searchLobbiesBtn.addEventListener('click', () => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value});
        lobbySearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchLobbiesBtn.click());
        searchLobbiesBtn.addEventListener('click', () => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value.trim().toLowerCase());
        });

        // --- Lobby Detail Screen Event Listeners ---
        leaveLobbyBtn.addEventListener('click', leaveLobby);

        startGameBtn.addEventListener('click', async () => {
            if (currentLobbyId && auth.currentUser) {
                try {
                    const lobbyRef = doc(db,.trim().toLowerCase());
        });

        // --- Lobby Detail Screen Event Listeners ---
        leaveLobbyBtn.addEventListener('click', leaveLobby);

        startGameBtn.addEventListener('click', async () => {
            if (currentLobbyId && auth.currentUser) {
                try {
                    const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
                    const lobbySnap = await getDoc(lobbyRef);
                    if (lobbySnap.exists()) {
                        await initializeGameInFirestore(currentLobbyId, lobby 'global_lobbies', currentLobbyId);
                    const lobbySnap = await getDoc(lobbyRef);
                    if (lobbySnap.exists()) {
                        await initializeGameInFirestore(currentLobbyId, lobbySnap.data());
                    }
                } catch (error) {
                    console.error("Error starting game:", error);
                    showMessageBox(`خطا در شروع بازی: ${error.message}`, "error");
                }
            }
        });
        
        // NEW: Toggle Chat Lock Listener
        toggleChatLockBtn.addEventListener('clickSnap.data());
                    }
                } catch (error) {
                    console.error("Error starting game:", error);
                    showMessageBox(`خطا در شروع بازی: ${error.message}`, "error");
                }
            }
        });
        
        // NEW: Toggle Chat Lock Listener
        toggleChatLockBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef', async () => {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists() && lobbySnap.data().hostId === auth.currentUser.uid) {
                    const currentLockState = lobbySnap.data().isChat = doc(db, 'global_lobbies', currentLobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (lobbySnap.exists() && lobbySnap.data().hostId === auth.currentUser.uid) {
                    const currentLockState = lobbySnap.data().isChatLocked || false;
                    await updateDoc(lobbyRef, { isChatLocked: !currentLockState });
                }
Locked || false;
                    await updateDoc(lobbyRef, { isChatLocked: !currentLockState });
                }
            } catch (error) {
                console.error("Error toggling chat lock:", error);
                showMessageBox("خطا در تغییر وضعیت چت.", "error");
            }
        });

        // Kick/Unkick related
        kickPlayerConfirmBtn.addEventListener('click', () => kickedPlayerToProcess &&            } catch (error) {
                console.error("Error toggling chat lock:", error);
                showMessageBox("خطا در تغییر وضعیت چت.", "error");
            }
        });

        // Kick/Unkick related
        kickPlayerConfirmBtn.addEventListener('click', () => kickedPlayerToProcess && kickPlayer(currentLobbyId, kickedPlayerToProcess.uid, kickedPlayerToProcess.displayName));
        cancelKickPlayerBtn.addEventListener('click', close kickPlayer(currentLobbyId, kickedPlayerToProcess.uid, kickedPlayerToProcess.displayName));
        cancelKickPlayerBtn.addEventListener('click', closeKickPlayerConfirmModal);
        closeKickPlayerConfirmModalBtn.addEventListener('click', closeKickPlayerConfirmModal);
        kickPlayerConfirmModal.addEventListener('click', (e) => e.target === kickPlayerConfirmModal && closeKickPlayerConfirmModal());
        kickedMessageOkBtn.addEventListener('clickKickPlayerConfirmModal);
        closeKickPlayerConfirmModalBtn.addEventListener('click', closeKickPlayerConfirmModal);
        kickPlayerConfirmModal.addEventListener('click', (e) => e.target === kickPlayerConfirmModal && closeKickPlayerConfirmModal());
        kickedMessageOkBtn.addEventListener('click', closeKickedMessageModal);
        viewKickedPlayersBtn.addEventListener('click', openKickedPlayersListModal);
        closeKicked', closeKickedMessageModal);
        viewKickedPlayersBtn.addEventListener('click', openKickedPlayersListModal);
        closeKickedPlayersListModalBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedListOkBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedPlayersListModal.addEventListener('click', (e) => e.target === kickedPlayersListModal && closeKickedPlayersListPlayersListModalBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedListOkBtn.addEventListener('click', closeKickedPlayersListModal);
        kickedPlayersListModal.addEventListener('click', (e) => e.target === kickedPlayersListModal && closeKickedPlayersListModal());
        
        // Private lobby password related
        function showPasswordPromptMessage(message, type = 'error') {
            passwordPromptModal());
        
        // Private lobby password related
        function showPasswordPromptMessage(message, type = 'error') {
            passwordPromptMessageBox.textContent = message;
            passwordPromptMessageBox.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            passwordPromptMessageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-blue-5MessageBox.textContent = message;
            passwordPromptMessageBox.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            passwordPromptMessageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-blue-500', 'text-white');
            passwordPromptMessageBox.classList.remove('hidden');
            setTimeout(() => passwordPromptMessageBox.classList.00', 'text-white');
            passwordPromptMessageBox.classList.remove('hidden');
            setTimeout(() => passwordPromptMessageBox.classList.add('hidden'), 4000);
        }

        function openEnterPasswordModal(lobbyId, lobbyName) {
            lobbyToJoin = { id: lobbyId, name: lobbyName };
            passwordPromptLobbyName.textContent = lobbyName;
            enterPasswordForm.reset();
            add('hidden'), 4000);
        }

        function openEnterPasswordModal(lobbyId, lobbyName) {
            lobbyToJoin = { id: lobbyId, name: lobbyName };
            passwordPromptLobbyName.textContent = lobbyName;
            enterPasswordForm.reset();
            passwordPromptMessageBox.classList.add('hidden');
            enterPasswordModal.classList.remove('hidden');
            void enterPasswordModalpasswordPromptMessageBox.classList.add('hidden');
            enterPasswordModal.classList.remove('hidden');
            void enterPasswordModal.offsetWidth;
            enterPasswordModal.classList.add('profile-modal-enter-active');
            joinLobbyPasswordInput.focus();
        }

        function closeEnterPasswordModal() {
            enterPasswordModal.classList.remove('profile-modal-enter-active');
            enterPasswordModal.classList.add('profile-.offsetWidth;
            enterPasswordModal.classList.add('profile-modal-enter-active');
            joinLobbyPasswordInput.focus();
        }

        function closeEnterPasswordModal() {
            enterPasswordModal.classList.remove('profile-modal-enter-active');
            enterPasswordModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                enterPasswordModal.classList.add('hiddenmodal-leave-active');
            setTimeout(() => {
                enterPasswordModal.classList.add('hidden');
                enterPasswordModal.classList.remove('profile-modal-leave-active');
                lobbyToJoin = null;
            }, 300);
        }

        lobbyTypeToggle.addEventListener('change', (e) => {
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active');
                enterPasswordModal.classList.remove('profile-modal-leave-active');
                lobbyToJoin = null;
            }, 300);
        }

        lobbyTypeToggle.addEventListener('change', (e) => {
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            e.target.nextElementSibling.classList.add('active');
            if (e'));
            e.target.nextElementSibling.classList.add('active');
            if (e.target.value === 'private') {
                newLobbyPasswordField.classList.remove('hidden');
            } else {
                newLobbyPasswordField.classList.add('hidden');
            }
        });

        togglePasswordVisibilityBtn.addEventListener('click', () => {
            const isPassword = newLobbyPasswordInput.type === 'password';.target.value === 'private') {
                newLobbyPasswordField.classList.remove('hidden');
            } else {
                newLobbyPasswordField.classList.add('hidden');
            }
        });

        togglePasswordVisibilityBtn.addEventListener('click', () => {
            const isPassword = newLobbyPasswordInput.type === 'password';
            newLobbyPasswordInput.type = isPassword ? 'text' : 'password';
            
            newLobbyPasswordInput.type = isPassword ? 'text' : 'password';
            eyeIconOpen.style.display = isPassword ? 'none' : 'block';
            eyeIconClosed.style.display = isPassword ? 'block' : 'none';
        });

        cancelJoinPasswordBtn.addEventListener('click', closeEnterPasswordModal);
        enterPasswordModal.addEventListener('click', (e) => e.target === enterPasswordModaleyeIconOpen.style.display = isPassword ? 'none' : 'block';
            eyeIconClosed.style.display = isPassword ? 'block' : 'none';
        });

        cancelJoinPasswordBtn.addEventListener('click', closeEnterPasswordModal);
        enterPasswordModal.addEventListener('click', (e) => e.target === enterPasswordModal && closeEnterPasswordModal());

        enterPasswordForm.addEventListener('submit', async (e) => && closeEnterPasswordModal());

        enterPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!lobbyToJoin) return;
            const enteredPassword = joinLobbyPasswordInput.value;
            if (!enteredPassword) { showPasswordPromptMessage('لطفاً رمز عبور را وارد کنید.'); return; }

            submitJoinPasswordBtn.disabled = true;
            submitJoinPasswordBtn.textContent = ' {
            e.preventDefault();
            if (!lobbyToJoin) return;
            const enteredPassword = joinLobbyPasswordInput.value;
            if (!enteredPassword) { showPasswordPromptMessage('لطفاً رمز عبور را وارد کنید.'); return; }

            submitJoinPasswordBtn.disabled = true;
            submitJoinPasswordBtn.textContent = 'در حال بررسی...';
            try {
                const lobbyRef = doc(db, 'global_در حال بررسی...';
            try {
                const lobbyRef = doc(db, 'global_lobbies', lobbyToJoin.id);
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists() || lobbySnap.data().type !== 'private') {
                    showPasswordPromptMessage('این لابی دیگر خصوصی نیست یا وجود ندارد.');
                    closeEnterPasswordModal();
                    return;
                }
                if (lobbies', lobbyToJoin.id);
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists() || lobbySnap.data().type !== 'private') {
                    showPasswordPromptMessage('این لابی دیگر خصوصی نیست یا وجود ندارد.');
                    closeEnterPasswordModal();
                    return;
                }
                if (enteredPassword === lobbySnap.data().password) {
                    closeEnterPasswordModal();
                    enteredPassword === lobbySnap.data().password) {
                    closeEnterPasswordModal();
                    await joinLobby(lobbyToJoin.id, auth.currentUser.uid, currentUserData.displayName);
                } else {
                    showPasswordPromptMessage('رمز عبور اشتباه است.');
                    joinLobbyPasswordInput.value = '';
                    joinawait joinLobby(lobbyToJoin.id, auth.currentUser.uid, currentUserData.displayName);
                } else {
                    showPasswordPromptMessage('رمز عبور اشتباه است.');
                    joinLobbyPasswordInput.value = '';
                    joinLobbyPasswordInput.focus();
                }
            } catch (error) {
                LobbyPasswordInput.focus();
                }
            } catch (error) {
                console.error("Error verifying lobby password:", error);
                showPasswordPromptMessage('خطا در بررسی رمز عبور.');
            } finally {
                submitJoinPasswordBtn.disabled = false;
                submitJoinPasswordBtn.textContent = 'console.error("Error verifying lobby password:", error);
                showPasswordPromptMessage('خطا در بررسی رمز عبور.');
            } finally {
                submitJoinPasswordBtn.disabled = false;
                submitJoinPasswordBtn.textContent = 'ورود';
            }
        });
        
        // Chat Form Submission
        lobbyChatورود';
            }
        });
        
        // Chat Form Submission
        lobbyChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentLobbyId) {
                sendLobbyMessage(currentLobbyId, lobbyChatInput.value);
            }
        });

Form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentLobbyId) {
                sendLobbyMessage(currentLobbyId, lobbyChatInput.value);
            }
        });

        // NEW: Event Delegation for Message Deletion
        lobbyChatMessages.addEventListener('click', (e        // NEW: Event Delegation for Message Deletion
        lobbyChatMessages.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-message-btn');
            if (deleteButton) {
                const messageId = deleteButton.dataset.messageId;
                if (currentLobbyId &&) => {
            const deleteButton = e.target.closest('.delete-message-btn');
            if (deleteButton) {
                const messageId = deleteButton.dataset.messageId;
                if (currentLobbyId && messageId) {
                    deleteLobbyMessage(currentLobbyId, messageId);
 messageId) {
                    deleteLobbyMessage(currentLobbyId, messageId);
                }
            }
        });

        // NEW: Game Screen Event Listeners
        leaveGameBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;

            const confirmed                }
            }
        });

        // NEW: Game Screen Event Listeners
        leaveGameBtn.addEventListener('click', async () => {
            if (!currentLobbyId || !auth.currentUser) return;

            const confirmed = = await showCustomConfirm("آیا مطمئن هستید که می‌خواهید بازی را ترک کنید؟ اگر شما سازنده باشید، بازی برای همه تمام می‌شود.");
            if (!confirmed) return;

            const lobbyRef = doc await showCustomConfirm("آیا مطمئن هستید که می‌خواهید بازی را ترک کنید؟ اگر شما سازنده باشید، بازی برای همه تمام می‌شود.");
            if (!confirmed) return;

            const lobbyRef = doc(db,(db, `global_lobbies`, currentLobbyId);
            const lobbySnap = await getDoc(lobbyRef);

            if (lobbySnap.exists() && lobbySnap.data().hostId === auth.currentUser `global_lobbies`, currentLobbyId);
            const lobbySnap = await getDoc(lobbyRef);

            if (lobbySnap.exists() && lobbySnap.data().hostId === auth.currentUser.uid) {
                // Host leaves, delete the entire lobby/game
                await deleteDoc(lobbyRef);
            } else.uid) {
                // Host leaves, delete the entire lobby/game
                await deleteDoc(lobbyRef);
            } else {
                // A player leaves. For now, we'll just delete the lobby as well.
                // A more advanced implementation would replace the player with a bot or end the game.
                await deleteDoc(lobby {
                // A player leaves. For now, we'll just delete the lobby as well.
                // A more advanced implementation would replace the player with a bot or end the game.
                await deleteDoc(lobbyRef);
            }

Ref);
            }

            // All players will be kicked back to lobby screen by their listeners
        });

        // Initialize the app when the window loads
        window.onload = initializeFirebaseAndAuth;
    </script>
</body>
</html>