<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            /* Deep, rich, slightly textured background for classic feel */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod border */
            border-radius: 20px; /* Slightly larger radius */
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            backdrop-filter: blur(10px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh; /* Ensure card doesn't overflow viewport */
            overflow-y: auto; /* Allow vertical scroll for long content */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid #FFD700;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid #FFD700;
            border-right: 5px solid #FFD700;
            border-radius: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }


        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother transition */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); /* Stronger shadow on hover */
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
        }

        /* Specific Button Colors - Classic Pallette */
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        .btn-gold-classic { background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); border: none; padding: 0.5rem; border-radius: 10px; }
        .btn-gold-classic:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3); }


        /* Input Field Styles - More refined Classic Look */
        input, select {
            background-color: #202020; /* Even darker input background */
            border: 2px solid #5A5A5A; /* Dark gray border */
            color: #E0E0E0; /* Light text color */
            padding: 0.875rem; /* Equivalent to p-3.5 */
            border-radius: 0.75rem; /* Equivalent to rounded-xl */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); /* Inner shadow for depth */
        }
        input::placeholder { color: #A0A0A0; }
        input:focus, select:focus {
            border-color: #DAA520 !important; /* Gold border on focus */
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
            outline: none;
        }

        /* Header specific styles - Richer Gold/Brown */
        .app-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            border-bottom: 3px solid #FFD700; /* Thicker gold border */
            box-shadow: 0 8px 20px rgba(0,0,0,0.7); /* Deeper shadow */
            height: 70px; /* Fixed height for header */
            position: fixed; /* Explicitly fixed */
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Lobby Screen Specific Header */
        .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-bottom: 3px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            height: 70px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 40;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center; /* Align items vertically */
            justify-content: center; /* Center horizontally by default */
        }
        .lobby-header .search-container {
            display: flex;
            flex-grow: 1; /* Allow search container to take available space */
            max-width: 600px; /* Limit max width on larger screens */
            margin: 0 auto; /* Center the search container */
            align-items: center;
            background-color: #303030; /* Darker background for search bar */
            border-radius: 15px; /* Rounded corners for search bar */
            border: 2px solid #5A5A5A;
            padding: 0.5rem 1rem; /* Adjust padding */
        }
        .lobby-header .search-container input {
            flex-grow: 1;
            background-color: transparent; /* Transparent background */
            border: none; /* No border for input inside search bar */
            padding: 0.25rem 0.5rem;
            outline: none; /* No outline on focus */
            text-align: right; /* Align text to right for RTL */
        }
        .lobby-header .search-container input::placeholder { color: #A0A0A0; }
        .lobby-header .search-container svg { color: #DAA520; min-width: 24px; min-height: 24px; }
        .lobby-header .search-container button { background: none; border: none; cursor: pointer; padding: 0 0.5rem; }
        .lobby-header .back-btn-wrapper { margin-left: 10px; }
        .lobby-header .search-icon-wrapper { margin-right: 10px; }


        .app-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); /* Richer gold/brown gradient */
            border-top: 3px solid #FFD700; /* Thicker gold border */
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7); /* Deeper shadow */
            height: 90px; /* Fixed height for footer */
            position: fixed; /* Explicitly fixed */
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem; /* Adjust padding */
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        /* Lobby Screen Specific Footer */
        .lobby-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-top: 3px solid #FFD700;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
            height: 90px;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 40;
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .lobby-footer .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #FFD700; /* Gold color for icons */
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .lobby-footer .icon-btn:hover { transform: translateY(-5px); }
        .lobby-footer .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .lobby-footer .icon-btn svg { width: 30px; height: 30px; margin-bottom: 5px; transition: transform 0.8s ease-in-out; }
        .lobby-footer .games-running-text { color: #E0E0E0; font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* Main content area padding to avoid overlap with fixed header/footer */
        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 90px; /* Footer height */
            flex-grow: 1; /* Allow content to fill available space */
            overflow-y: auto; /* Allow vertical scroll for long lists */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for main content */
            width: 100%; /* Ensure it takes full width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start for scrollable lists */
            align-items: center; /* Center content horizontally */
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); /* Subtle dark grey gradient for main area */
            position: relative; /* For any absolute positioned elements inside */
        }
        
        /* Modal specific styles */
        .modal-overlay {
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transform: translateY(-20px); /* Initial slightly elevated */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-enter-active .modal-content { transform: translateY(0); }
        .modal-leave-active .modal-content { transform: translateY(-20px); opacity: 0; }

        /* Animation for lobby items when closing */
        .lobby-item.fade-out {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Enhanced Lobby Item Styling */
        .lobby-item {
            background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%); /* Deep gradient background */
            border: 2px solid #DAA520; /* Gold border */
            border-radius: 15px; /* Rounded corners */
            box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1); /* Deep outer shadow, subtle inner glow */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smooth transitions for hover effects */
            position: relative; /* For overflow hidden and pseudo-elements */
            overflow: hidden; /* Ensures internal elements stay within rounded corners */
            padding: 1.25rem 1.5rem; /* More generous padding */
            display: flex;
            flex-direction: column; /* Default to column for small screens */
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        .lobby-item:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2); }
        .lobby-item h3 { color: #FFD700; font-size: 1.75rem; font-family: 'Playfair Display', serif; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        .lobby-item p { color: #C0C0C0; font-size: 1rem; margin-top: 0.25rem; }
        .lobby-item .lobby-actions { margin-top: 1rem; display: flex; flex-direction: column; width: 100%; gap: 0.75rem; }
        .lobby-item .join-lobby-btn, .lobby-item .close-lobby-btn { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; }
        @media (min-width: 640px) {
            .lobby-item { flex-direction: row; text-align: right; }
            .lobby-item .lobby-actions { flex-direction: row; width: auto; margin-top: 0; gap: 0.5rem; }
            .lobby-item .close-lobby-btn { margin-right: 0.5rem; }
            .lobby-item .join-lobby-btn, .lobby-item .close-lobby-btn { width: auto; font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        }

        /* === Lobby Detail Screen Styles (Major Redesign) === */
        .lobby-detail-screen-full { padding-top: 0; padding-bottom: 0; display: flex; flex-direction: column; width: 100%; height: 100%; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        .lobby-detail-content { background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%); border: 3px solid #DAA520; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.7); padding: 1.5rem; width: 95%; max-width: 1200px; height: calc(100% - 100px); display: flex; flex-direction: row; gap: 1.5rem; margin: 50px auto; overflow: hidden; }
        .lobby-sidebar { display: flex; flex-direction: column; flex-shrink: 0; width: 300px; background-color: rgba(0,0,0,0.3); border-radius: 15px; padding: 1rem; border: 1px solid #444; overflow-y: auto; }
        .lobby-main-panel { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        #player-list-container { margin-top: 1rem; flex-grow: 1; overflow-y: auto; }
        .player-list-item { background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: all 0.2s ease-in-out; }
        .player-list-item.is-host { border-color: #FFD700; }
        .player-list-item .player-info { display: flex; align-items: center; gap: 0.75rem; } /* NEW */
        .player-list-item .player-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #DAA520; } /* NEW */
        .player-list-item .player-name { font-weight: bold; color: #E0E0E0; }
        .player-list-item .host-label { color: #FFD700; font-size: 0.8rem; margin-right: 0.5rem; }
        .player-action-buttons { display: flex; gap: 0.5rem; }
        .kick-player-btn { background: none; border: 1px solid #B22222; color: #B22222; border-radius: 5px; padding: 0.2rem 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
        .kick-player-btn:hover { background: #B22222; color: white; }
        .make-host-btn { background: none; border: 1px solid #DAA520; color: #DAA520; border-radius: 5px; padding: 0.2rem 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
        .make-host-btn:hover { background: #DAA520; color: #1A1A1A; }
        .player-status-container { display: flex; align-items: center; gap: 0.5rem; } /* NEW */
        .ready-indicator { width: 12px; height: 12px; border-radius: 50%; transition: background-color 0.3s; } /* NEW */
        .ready-indicator.not-ready { background-color: #B22222; box-shadow: 0 0 5px #B22222; } /* NEW */
        .ready-indicator.ready { background-color: #228B22; box-shadow: 0 0 5px #228B22; } /* NEW */

        .lobby-chat-container { background-color: rgba(0,0,0,0.4); border: 2px solid #5A5A5A; border-radius: 10px; padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .lobby-chat-messages { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; display: flex; flex-direction: column; }
        .chat-message { background-color: #333; padding: 0.5rem 0.75rem; border-radius: 10px; margin-bottom: 0.5rem; max-width: 80%; word-wrap: break-word; align-self: flex-start; display: flex; align-items: center; gap: 0.5rem; }
        .chat-message.current-user { background-color: #4682B4; align-self: flex-end; flex-direction: row-reverse; }
        .chat-message-content { flex-grow: 1; }
        .chat-message .sender-name { font-weight: bold; color: #FFD700; display: block; font-size: 0.9em; margin-bottom: 0.2rem; }
        .chat-message .message-text-deleted { font-style: italic; color: #999; }
        .delete-message-btn { background: none; border: none; color: #aaa; cursor: pointer; padding: 0.25rem; opacity: 0.5; transition: all 0.2s ease; flex-shrink: 0; }
        .chat-message:hover .delete-message-btn { opacity: 1; }
        .delete-message-btn:hover { color: #ff6b6b; transform: scale(1.1); }
        .chat-message .chat-avatar { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #DAA520; flex-shrink: 0; margin-left: 8px; margin-right: -4px; } /* NEW */
        .chat-message.current-user .chat-avatar { margin-right: 8px; margin-left: -4px; } /* NEW */

        .lobby-chat-input-form { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-shrink: 0; }
        .lobby-actions-footer { flex-shrink: 0; margin-top: 1rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
        .start-game-btn { background: linear-gradient(145deg, #228B22 0%, #006400 100%); border: 2px solid #DAA520; font-size: 1.1rem; padding: 0.6rem 1.2rem; }
        #host-actions-container { display: flex; flex-wrap: wrap; gap: 1rem; }

        /* Custom Scrollbars */
        .lobby-sidebar::-webkit-scrollbar, #player-list-container::-webkit-scrollbar, .lobby-chat-messages::-webkit-scrollbar, .classic-card::-webkit-scrollbar { width: 8px; }
        .lobby-sidebar::-webkit-scrollbar-track, #player-list-container::-webkit-scrollbar-track, .lobby-chat-messages::-webkit-scrollbar-track, .classic-card::-webkit-scrollbar-track { background: #202020; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb, #player-list-container::-webkit-scrollbar-thumb, .lobby-chat-messages::-webkit-scrollbar-thumb, .classic-card::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb:hover, #player-list-container::-webkit-scrollbar-thumb:hover, .lobby-chat-messages::-webkit-scrollbar-thumb:hover, .classic-card::-webkit-scrollbar-thumb:hover { background: #FFD700; }
        
        @media (max-width: 860px) {
            .lobby-detail-content { flex-direction: column; height: calc(100% - 80px); margin: 40px auto; padding: 1rem; overflow: hidden; }
            .lobby-sidebar { width: 100%; flex-shrink: 0; max-height: 250px; }
            .lobby-main-panel { flex-grow: 1; min-height: 0; }
        }
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; } .p-6, .p-8 { padding: 1.5rem; } .text-3xl { font-size: 2rem; } .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header, .app-footer, .lobby-footer { padding: 0.5rem; } .app-header, .lobby-header { height: 60px; } .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; } .lobby-detail-content { margin: 20px auto; height: calc(100% - 40px); }
        }
        
        /* Lobby Type Toggle Styles */
        .lobby-type-btn { padding: 0.5rem 1.5rem; border: 2px solid #DAA520; border-radius: 10px; transition: all 0.2s ease-in-out; background-color: transparent; color: #DAA520; font-weight: bold; }
        .lobby-type-btn.active { background-color: #DAA520; color: #1A1A1A; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .lobby-lock-icon { width: 1.2rem; height: 1.2rem; margin-left: 0.5rem; color: #FFD700; display: inline-block; vertical-align: middle; }

        /* NEW: Profile Avatar Selection Styles */
        .avatar-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 1rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .avatar-option:hover { transform: scale(1.1); border-color: #FFF; }
        .avatar-option.selected { border-color: #FFD700; box-shadow: 0 0 15px #FFD700; transform: scale(1.1); }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #DAA520; margin: 0 auto 1rem; }

        /* NEW: Coin Display Styles */
        .coin-balance { display: flex; align-items: center; gap: 0.5rem; background-color: rgba(0,0,0,0.5); padding: 0.25rem 0.75rem; border-radius: 20px; border: 1px solid #DAA520; }
        .coin-balance .coin-icon { color: #FFD700; width: 20px; height: 20px; }
        .coin-balance span { font-weight: bold; color: #FFF; }

        /* NEW: Shop & Item Styles */
        .shop-item { background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 100%); border: 2px solid #555; border-radius: 15px; padding: 1rem; text-align: center; transition: all 0.2s ease; }
        .shop-item:hover { transform: translateY(-5px); border-color: #DAA520; }
        .shop-item img.card-back-preview { width: 100px; height: auto; margin: 0 auto 1rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        .shop-item .item-price { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 0.5rem; color: #FFD700; font-weight: bold; }

        /* NEW: Daily Reward Modal */
        .daily-reward-icon { font-size: 5rem; color: #FFD700; text-shadow: 0 0 20px #FFD700; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div><input type="email" id="email" placeholder="ایمیل شما" class="w-full" required></div>
                    <div id="display-name-field" class="hidden"><input type="text" id="display-name" placeholder="نام نمایشی (در بازی)" class="w-full"></div>
                    <div><input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="w-full" required></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">ورود</button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">ثبت نام</button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl hidden">ادامه</button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="app-header">
                <div id="profile-summary" class="flex items-center space-x-4 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                    <img id="header-avatar" src="./avatars/default.png" alt="Avatar" class="w-12 h-12 rounded-full border-2 border-yellow-400">
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <div id="header-coin-balance" class="coin-balance mt-1">
                            <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v2h-2v-2zm0 4h2v6h-2v-6z"/></svg>
                            <span id="header-coin-amount">0</span>
                        </div>
                    </div>
                </div>
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </header>
            <div class="main-content-area items-center justify-center">
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>
            <footer class="app-footer">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">بازی دوستانه</button>
                <button id="rated-game-btn" class="classic-btn btn-brown-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">بازی امتیازی</button>
            </footer>
        </div>

        <!-- 4. Lobby Screen -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></button>
                </div>
            </header>
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full"><p class="text-gray-400">در حال بارگذاری لابی‌ها...</p></div>
                </div>
            </div>
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg><span>ایجاد</span></button>
                <button id="refresh-lobbies-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg><span>بروزرسانی</span></button>
                <!-- NEW: Shop Button -->
                <button id="shop-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg><span>فروشگاه</span></button>
                <button id="quick-join-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>ورود سریع</span></button>
            </footer>
        </div>

        <!-- 5. Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-lg text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">پروفایل کاربری</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                
                <img id="profile-modal-avatar" src="./avatars/default.png" alt="Avatar" class="profile-avatar">
                <p class="text-lg mb-4"><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>

                <div class="w-full h-px bg-yellow-600 my-4"></div>
                <h3 class="text-xl font-bold text-yellow-400 mb-2">انتخاب آواتار</h3>
                <div id="avatar-selection-grid" class="avatar-selection-grid mb-4"></div>

                <div class="w-full h-px bg-yellow-600 my-4"></div>
                <h3 class="text-xl font-bold text-yellow-400 mb-2">تجهیزات</h3>
                <div id="equip-section" class="text-left">
                    <label for="equip-card-back-select" class="block mb-2 text-white">پشت کارت:</label>
                    <select id="equip-card-back-select" class="w-full"></select>
                </div>
                
                <div class="w-full h-px bg-yellow-600 my-4"></div>
                <div class="text-lg space-y-2 mb-6 text-white text-right">
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه:</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                </div>
                <button id="profile-logout-btn" class="w-full classic-btn btn-red-classic text-lg sm:text-xl">خروج از حساب</button>
            </div>
        </div>

        <!-- 6. Create Lobby Modal -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <form id="create-lobby-form" class="space-y-5">
                    <div><input type="text" id="new-lobby-name-input" placeholder="نام لابی شما" class="w-full" required></div>
                    <!-- NEW: Game Settings -->
                    <div>
                        <label for="rounds-to-win-select" class="block mb-2 text-white text-right">امتیاز پیروزی:</label>
                        <select id="rounds-to-win-select" class="w-full">
                            <option value="3">بازی سرعتی (۳ دست)</option>
                            <option value="7" selected>بازی استاندارد (۷ دست)</option>
                            <option value="11">بازی طولانی (۱۱ دست)</option>
                        </select>
                    </div>
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer"><input type="radio" name="lobby-type" value="public" class="sr-only" checked><span class="lobby-type-btn active">عمومی</span></label>
                        <label class="cursor-pointer"><input type="radio" name="lobby-type" value="private" class="sr-only"><span class="lobby-type-btn">خصوصی</span></label>
                    </div>
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)" class="w-full pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
                    <button type="submit" id="submit-create-lobby-btn" class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">ساخت لابی</button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    <div class="w-full h-px bg-yellow-600 mb-4"></div>
                    <div id="player-list-container"></div>
                </div>
                <div class="lobby-main-panel">
                    <div class="lobby-chat-container">
                        <div id="lobby-chat-messages" class="lobby-chat-messages"></div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form">
                            <input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled>شروع بازی</button>
                            <button id="toggle-chat-lock-btn" class="classic-btn btn-gray-classic text-sm py-2 px-4">قفل کردن چت</button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4">لیست اخراجی‌ها</button>
                        </div>
                        <!-- NEW: Player Ready Button -->
                        <div id="player-actions-container" style="display: none;">
                            <button id="player-ready-btn" class="classic-btn btn-green-classic text-lg">آماده</button>
                        </div>
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک لابی</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All other modals (kick, kicked message, etc.) -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay"><div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">اخراج بازیکن</h2><button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button><p class="text-lg mb-8 text-white">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p><div class="flex justify-around space-x-4 space-x-reverse"><button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button><button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button></div></div></div>
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay"><div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-400">شما اخراج شدید!</h2><p id="kicked-message-text" class="text-lg mb-8 text-white">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p><button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button></div></div>
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay"><div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">لیست بازیکنان اخراج شده</h2><button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button><div id="kicked-players-list-content" class="space-y-4 mb-8 text-white text-left max-h-60 overflow-y-auto"></div><button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button></div></div>
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay"><div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"><h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2><p class="text-lg mb-6 text-white">لابی <span id="password-prompt-lobby-name" class="font-bold text-yellow-300"></span> نیاز به رمز عبور دارد.</p><form id="enter-password-form" class="space-y-5"><div><input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید" class="w-full text-center" required></div><div class="flex justify-around space-x-4 space-x-reverse"><button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button><button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button></div></form><div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div></div></div>

        <!-- NEW: Shop Modal -->
        <div id="shop-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-6 sm:p-8 w-11/12 max-w-2xl text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">فروشگاه</h2>
                <button id="close-shop-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <div class="w-full h-px bg-yellow-600 my-4"></div>
                <h3 class="text-xl font-bold text-yellow-400 mb-4">پشت کارت‌ها</h3>
                <div id="shop-card-backs-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Shop items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- NEW: Daily Reward Modal -->
        <div id="daily-reward-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 modal-overlay">
            <div class="classic-card modal-content p-8 w-11/12 max-w-sm text-center relative">
                <span class="daily-reward-icon">🎁</span>
                <h2 class="text-2xl sm:text-3xl font-bold my-4">پاداش روزانه!</h2>
                <p class="text-lg mb-6 text-white">برای ورود امروزتان، شما <span id="daily-reward-amount" class="font-bold text-yellow-300"></span> سکه طلا دریافت کردید!</p>
                <button id="claim-daily-reward-btn" class="w-full classic-btn btn-green-classic">عالیه!</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        
        // Auth
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 

        // Main Screen Header
        const profileSummary = document.getElementById('profile-summary');
        const headerAvatar = document.getElementById('header-avatar');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerCoinBalance = document.getElementById('header-coin-balance');
        const headerCoinAmount = document.getElementById('header-coin-amount');
        const menuBtn = document.getElementById('menu-btn');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn');
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn');
        const shopBtn = document.getElementById('shop-btn'); // New
        const quickJoinBtn = document.getElementById('quick-join-btn');

        // Modals
        const profileModal = document.getElementById('profile-modal');
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedPlayersListModal = document.getElementById('kicked-players-list-modal');
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const shopModal = document.getElementById('shop-modal'); // New
        const dailyRewardModal = document.getElementById('daily-reward-modal'); // New

        // Profile Modal
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileModalAvatar = document.getElementById('profile-modal-avatar');
        const profileDisplayName = document.getElementById('profile-display-name');
        const avatarSelectionGrid = document.getElementById('avatar-selection-grid');
        const equipCardBackSelect = document.getElementById('equip-card-back-select');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');

        // Create Lobby Modal
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const roundsToWinSelect = document.getElementById('rounds-to-win-select'); // New
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field');
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');

        // Lobby Detail Screen
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const playerActionsContainer = document.getElementById('player-actions-container'); // New
        const startGameBtn = document.getElementById('start-game-btn');
        const playerReadyBtn = document.getElementById('player-ready-btn'); // New
        const toggleChatLockBtn = document.getElementById('toggle-chat-lock-btn');
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChatSendBtn = document.getElementById('lobby-chat-send-btn');

        // Shop Modal
        const closeShopModalBtn = document.getElementById('close-shop-modal-btn');
        const shopCardBacksGrid = document.getElementById('shop-card-backs-grid');

        // Daily Reward Modal
        const dailyRewardAmount = document.getElementById('daily-reward-amount');
        const claimDailyRewardBtn = document.getElementById('claim-daily-reward-btn');

        // --- State Variables ---
        let authMode = 'login';
        let currentActiveScreen = loadingScreen;
        let currentUserData = null;
        let unsubscribeLobbies = null;
        let unsubscribeLobbyDetail = null;
        let unsubscribeKickedPlayers = null;
        let unsubscribeLobbyChat = null;
        let currentLobbyId = null;
        let isRefreshing = false;
        let resolveCustomConfirm;

        // --- Constants ---
        const AVATARS = Array.from({length: 12}, (_, i) => `./avatars/avatar${i + 1}.png`);
        AVATARS.unshift('./avatars/default.png'); // Add default avatar at the beginning

        const SHOP_ITEMS = {
            cardBacks: [
                { id: 'card_back_classic', name: 'کلاسیک', price: 0, url: './card_backs/classic.png' },
                { id: 'card_back_royal', name: 'سلطنتی', price: 500, url: './card_backs/royal.png' },
                { id: 'card_back_persian', name: 'فرش ایرانی', price: 750, url: './card_backs/persian.png' },
                { id: 'card_back_galaxy', name: 'کهکشانی', price: 1000, url: './card_backs/galaxy.png' },
                { id: 'card_back_gold', name: 'طلایی', price: 1500, url: './card_backs/gold.png' },
                { id: 'card_back_dark', name: 'تاریک', price: 500, url: './card_backs/dark.png' },
            ]
        };
        const DAILY_REWARD_COINS = 100;

        // --- Utility Functions ---
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            element.classList.add(type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-500'), 'text-white');
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);

        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            void modalElement.offsetWidth;
            modalElement.classList.add('modal-enter-active');
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('modal-enter-active');
            modalElement.classList.add('modal-leave-active');
            setTimeout(() => {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('modal-leave-active');
            }, 300);
        }

        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                showModal(customConfirmModal);
                resolveCustomConfirm = resolve;
            });
        }
        document.getElementById('confirm-yes-btn').onclick = () => { closeModal(customConfirmModal); resolveCustomConfirm(true); };
        document.getElementById('confirm-no-btn').onclick = () => { closeModal(customConfirmModal); resolveCustomConfirm(false); };

        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                currentActiveScreen = newScreen;
            }, 600);
        }

        function getFirebaseErrorMessage(errorCode) {
            const messages = { 'auth/invalid-email': "فرمت ایمیل نامعتبر است.", 'auth/user-not-found': "کاربری با این ایمیل یافت نشد.", 'auth/wrong-password': "ایمیل یا رمز عبور اشتباه است.", 'auth/invalid-credential': "ایمیل یا رمز عبور اشتباه است.", 'auth/email-already-in-use': "این ایمیل قبلاً ثبت نام شده است.", 'auth/weak-password': "رمز عبور باید حداقل ۶ کاراکتر باشد.", 'auth/network-request-failed': "مشکل در اتصال به اینترنت.", 'auth/too-many-requests': "تعداد تلاش‌های ناموفق بیش از حد مجاز.", };
            return messages[errorCode] || "خطایی ناشناخته رخ داده است.";
        }

        // --- Firebase Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, `users/${user.uid}`);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUserData = { uid: user.uid, ...userDocSnap.data() };
                    // Daily Reward Check
                    const today = new Date().setHours(0, 0, 0, 0);
                    const lastLogin = currentUserData.lastLogin?.toDate().setHours(0, 0, 0, 0) || 0;
                    if (today > lastLogin) {
                        await updateDoc(userDocRef, {
                            coins: increment(DAILY_REWARD_COINS),
                            lastLogin: serverTimestamp()
                        });
                        currentUserData.coins += DAILY_REWARD_COINS;
                        dailyRewardAmount.textContent = DAILY_REWARD_COINS;
                        showModal(dailyRewardModal);
                    }
                } else {
                    // First time user registration
                    const displayName = displayNameInput.value.trim() || user.email.split('@')[0];
                    currentUserData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: displayName,
                        coins: 200, // Starting coins
                        avatarUrl: './avatars/default.png',
                        unlockedCardBacks: ['card_back_classic'],
                        equippedCardBack: 'card_back_classic',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    };
                    await setDoc(userDocRef, currentUserData);
                }

                updateUIWithUserData();
                setActiveScreen(mainScreen);
            } else {
                // User is signed out
                setActiveScreen(authScreen);
                authForm.reset();
                displayNameField.classList.add('hidden');
                submitAuthBtn.classList.add('hidden');
                loginToggleBtn.classList.remove('hidden');
                registerToggleBtn.classList.remove('hidden');
                authMode = 'login';
                currentUserData = null;
                // Cleanup all listeners
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                if (unsubscribeKickedPlayers) unsubscribeKickedPlayers();
                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                unsubscribeLobbies = unsubscribeLobbyDetail = unsubscribeKickedPlayers = unsubscribeLobbyChat = null;
                currentLobbyId = null;
            }
        });

        function updateUIWithUserData() {
            if (!currentUserData) return;
            headerDisplayName.textContent = currentUserData.displayName;
            headerAvatar.src = currentUserData.avatarUrl;
            headerCoinAmount.textContent = currentUserData.coins;
        }

        // --- Lobby and Game Logic ---
        
        async function createLobby(lobbyName, userId, userData, lobbyType, password, gameSettings) {
            // Check for existing active lobby
            const userLobbiesQuery = query(collection(db, `global_lobbies`), where("hostId", "==", userId), where("status", "in", ["waiting", "playing"]));
            const userLobbiesSnapshot = await getDocs(userLobbiesQuery);
            if (!userLobbiesSnapshot.empty) {
                throw new Error("شما از قبل یک لابی فعال ساخته‌اید.");
            }

            // NEW: Player data is now an object
            const newLobbyData = {
                name: lobbyName,
                hostId: userId,
                status: "waiting",
                type: lobbyType,
                players: {
                    [userId]: {
                        displayName: userData.displayName,
                        avatarUrl: userData.avatarUrl,
                        isReady: true // Host is always ready
                    }
                },
                kickedPlayers: [],
                createdAt: serverTimestamp(),
                isChatLocked: false,
                gameSettings: gameSettings // Using the new settings
            };
            if (lobbyType === 'private') newLobbyData.password = password;
            
            const newLobbyRef = await addDoc(collection(db, `global_lobbies`), newLobbyData);
            return newLobbyRef.id;
        }
        
        async function joinLobby(lobbyId, userId, userData) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if (!lobbySnap.exists()) throw new Error("لابی یافت نشد.");

            const lobbyData = lobbySnap.data();
            if (lobbyData.kickedPlayers?.some(p => p.uid === userId)) throw new Error("شما از این لابی اخراج شده‌اید.");
            if (Object.keys(lobbyData.players || {}).length >= lobbyData.gameSettings.maxPlayers) throw new Error("لابی پر است.");

            // NEW: Player data is an object
            await updateDoc(lobbyRef, {
                [`players.${userId}`]: {
                    displayName: userData.displayName,
                    avatarUrl: userData.avatarUrl,
                    isReady: false // New players are not ready by default
                }
            });

            currentLobbyId = lobbyId;
            setActiveScreen(lobbyDetailScreen);
            unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
        }

        async function leaveLobby() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, `global_lobbies`, currentLobbyId);
            const userId = auth.currentUser.uid;
            const lobbySnap = await getDoc(lobbyRef);
            if (!lobbySnap.exists()) {
                setActiveScreen(lobbyScreen);
                return;
            }
            const isHost = lobbySnap.data().hostId === userId;
            if (isHost) {
                const confirmed = await showCustomConfirm("شما سازنده لابی هستید. خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟");
                if (confirmed) await deleteDoc(lobbyRef);
            } else {
                await updateDoc(lobbyRef, { [`players.${userId}`]: deleteField() });
                setActiveScreen(lobbyScreen);
            }
        }
        
        // NEW: Toggle Player Ready Status
        async function toggleReadyStatus() {
            if (!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if (!lobbySnap.exists()) return;
            
            const currentReadyState = lobbySnap.data().players[auth.currentUser.uid]?.isReady || false;
            await updateDoc(lobbyRef, {
                [`players.${auth.currentUser.uid}.isReady`]: !currentReadyState
            });
        }

        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to lobby details for ID: ${lobbyId}`);
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            if (unsubscribeLobbyChat) unsubscribeLobbyChat();
            
            unsubscribeLobbyChat = setupLobbyChatListener(lobbyId);
            
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showMessageBox("لابی که در آن بودید بسته شد.", "info");
                    setActiveScreen(lobbyScreen);
                    return;
                }

                const lobbyData = docSnap.data();
                const players = lobbyData.players || {};
                const playerCount = Object.keys(players).length;
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 4;
                const isCurrentUserHost = auth.currentUser && lobbyData.hostId === auth.currentUser.uid;
                
                // Update header
                detailLobbyName.textContent = lobbyData.name;
                detailHostName.textContent = `سازنده: ${players[lobbyData.hostId]?.displayName || 'ناشناس'}`;
                detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                // Render player list
                playerListContainer.innerHTML = '';
                let allPlayersReady = true;
                Object.entries(players).forEach(([uid, playerData]) => {
                    const isHost = uid === lobbyData.hostId;
                    if (!playerData.isReady) allPlayersReady = false;

                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-list-item' + (isHost ? ' is-host' : '');
                    
                    let actionButtonsHtml = '';
                    if (isCurrentUserHost && !isHost) {
                        actionButtonsHtml = `<div class="player-action-buttons">
                            <button class="make-host-btn" data-player-uid="${uid}" data-player-name="${playerData.displayName}">واگذاری</button>
                            <button class="kick-player-btn" data-player-uid="${uid}" data-player-name="${playerData.displayName}">اخراج</button>
                        </div>`;
                    }

                    playerItem.innerHTML = `
                        <div class="player-info">
                            <img src="${playerData.avatarUrl}" alt="Avatar" class="player-avatar">
                            <div>
                                <span class="player-name">${playerData.displayName}</span>
                                ${isHost ? '<span class="host-label">(سازنده)</span>' : ''}
                            </div>
                        </div>
                        <div class="player-status-container">
                            <div class="ready-indicator ${playerData.isReady ? 'ready' : 'not-ready'}" title="${playerData.isReady ? 'آماده' : 'آماده نیست'}"></div>
                            ${actionButtonsHtml}
                        </div>
                    `;
                    playerListContainer.appendChild(playerItem);
                });

                // Manage UI visibility and state
                if (isCurrentUserHost) {
                    hostActionsContainer.style.display = 'flex';
                    playerActionsContainer.style.display = 'none';
                    startGameBtn.disabled = !(playerCount === maxPlayers && allPlayersReady);
                    startGameBtn.textContent = allPlayersReady ? `شروع بازی (${playerCount}/${maxPlayers})` : `منتظر بازیکنان...`;
                    toggleChatLockBtn.textContent = lobbyData.isChatLocked ? 'باز کردن چت' : 'قفل کردن چت';
                } else {
                    hostActionsContainer.style.display = 'none';
                    playerActionsContainer.style.display = 'flex';
                    const myReadyState = players[auth.currentUser.uid]?.isReady || false;
                    playerReadyBtn.textContent = myReadyState ? 'لغو آمادگی' : 'آماده';
                    playerReadyBtn.classList.toggle('btn-red-classic', myReadyState);
                    playerReadyBtn.classList.toggle('btn-green-classic', !myReadyState);
                }
                
                // Chat lock for non-hosts
                lobbyChatInput.disabled = lobbyData.isChatLocked && !isCurrentUserHost;
                lobbyChatSendBtn.disabled = lobbyData.isChatLocked && !isCurrentUserHost;
                lobbyChatInput.placeholder = (lobbyData.isChatLocked && !isCurrentUserHost) ? "چت توسط سازنده قفل شده است" : "پیام خود را بنویسید...";
            });
        }
        
        function setupLobbyChatListener(lobbyId) {
            const q = query(collection(db, `global_lobbies/${lobbyId}/messages`), orderBy("timestamp", "asc"));
            return onSnapshot(q, (snapshot) => {
                lobbyChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'chat-message' + (msg.senderUid === auth.currentUser.uid ? ' current-user' : '');
                    
                    const canDelete = !msg.isDeleted && (msg.senderUid === auth.currentUser.uid || lobbyData?.hostId === auth.currentUser.uid);
                    const deleteBtnHtml = canDelete ? `<button class="delete-message-btn" data-message-id="${doc.id}" title="حذف"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>` : '';
                    
                    messageDiv.innerHTML = `
                        <img src="${msg.senderAvatarUrl}" alt="Avatar" class="chat-avatar">
                        <div class="chat-message-content">
                            ${msg.isDeleted ? `<p class="message-text-deleted">${msg.text}</p>` : `<span class="sender-name">${msg.senderName}</span><p>${msg.text}</p>`}
                        </div>
                        ${deleteBtnHtml}
                    `;
                    lobbyChatMessages.appendChild(messageDiv);
                });
                lobbyChatMessages.scrollTop = lobbyChatMessages.scrollHeight;
            });
        }

        async function sendLobbyMessage(lobbyId, text) {
            if (!text.trim() || !currentUserData) return;
            await addDoc(collection(db, `global_lobbies/${lobbyId}/messages`), {
                text: text.trim(),
                senderUid: currentUserData.uid,
                senderName: currentUserData.displayName,
                senderAvatarUrl: currentUserData.avatarUrl, // NEW
                timestamp: serverTimestamp(),
                isDeleted: false
            });
            lobbyChatInput.value = '';
        }

        // --- Event Listeners ---
        window.onload = () => {
            // Populate avatar grid
            avatarSelectionGrid.innerHTML = AVATARS.map(url => `<img src="${url}" class="avatar-option" data-url="${url}">`).join('');
        };

        // Auth
        loginToggleBtn.addEventListener('click', () => { authMode = 'login'; displayNameField.classList.add('hidden'); submitAuthBtn.textContent = 'ورود'; submitAuthBtn.classList.remove('hidden'); loginToggleBtn.classList.add('hidden'); registerToggleBtn.classList.remove('hidden'); authForm.reset(); });
        registerToggleBtn.addEventListener('click', () => { authMode = 'register'; displayNameField.classList.remove('hidden'); submitAuthBtn.textContent = 'ثبت نام'; submitAuthBtn.classList.remove('hidden'); registerToggleBtn.classList.add('hidden'); loginToggleBtn.classList.remove('hidden'); authForm.reset(); });
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) { showMessageBox("لطفاً ایمیل و رمز عبور را وارد کنید.", 'error'); return; }
            try {
                if (authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if (!displayNameInput.value.trim()) { showMessageBox("لطفاً نام نمایشی را وارد کنید.", "error"); return; }
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) { showMessageBox(getFirebaseErrorMessage(error.code), 'error'); }
        });

        // Main Screen & Profile
        menuBtn.addEventListener('click', () => showModal(profileModal));
        profileSummary.addEventListener('click', () => showModal(profileModal));
        closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));
        profileLogoutBtn.addEventListener('click', () => signOut(auth));
        
        // Profile Modal Actions
        avatarSelectionGrid.addEventListener('click', async (e) => {
            if (e.target.classList.contains('avatar-option')) {
                const newAvatarUrl = e.target.dataset.url;
                if (newAvatarUrl === currentUserData.avatarUrl) return;
                
                await updateDoc(doc(db, `users/${currentUserData.uid}`), { avatarUrl: newAvatarUrl });
                currentUserData.avatarUrl = newAvatarUrl;
                
                // Update UI immediately
                headerAvatar.src = newAvatarUrl;
                profileModalAvatar.src = newAvatarUrl;
                document.querySelectorAll('.avatar-option.selected').forEach(el => el.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        equipCardBackSelect.addEventListener('change', async (e) => {
            const newCardBackId = e.target.value;
            await updateDoc(doc(db, `users/${currentUserData.uid}`), { equippedCardBack: newCardBackId });
            currentUserData.equippedCardBack = newCardBackId;
            showMessageBox("پشت کارت با موفقیت تغییر کرد!", "success");
        });

        // Shop Logic
        shopBtn.addEventListener('click', () => {
            shopCardBacksGrid.innerHTML = '';
            SHOP_ITEMS.cardBacks.forEach(item => {
                const isOwned = currentUserData.unlockedCardBacks.includes(item.id);
                const canAfford = currentUserData.coins >= item.price;
                const shopItemDiv = document.createElement('div');
                shopItemDiv.className = 'shop-item';
                shopItemDiv.innerHTML = `
                    <img src="${item.url}" alt="${item.name}" class="card-back-preview">
                    <h4 class="font-bold text-lg text-white">${item.name}</h4>
                    <div class="item-price">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v2h-2v-2zm0 4h2v6h-2v-6z"/></svg>
                        <span>${item.price}</span>
                    </div>
                    <button class="classic-btn text-sm py-2 px-4 mt-2 ${isOwned ? 'btn-gray-classic' : (canAfford ? 'btn-green-classic' : 'btn-red-classic')}" 
                            data-item-id="${item.id}" data-item-price="${item.price}" ${isOwned || !canAfford ? 'disabled' : ''}>
                        ${isOwned ? 'خریداری شده' : (canAfford ? 'خرید' : 'سکه ناکافی')}
                    </button>
                `;
                shopCardBacksGrid.appendChild(shopItemDiv);
            });
            showModal(shopModal);
        });
        closeShopModalBtn.addEventListener('click', () => closeModal(shopModal));

        shopCardBacksGrid.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                const itemId = e.target.dataset.itemId;
                const itemPrice = parseInt(e.target.dataset.itemPrice);

                const confirmed = await showCustomConfirm(`آیا میخواهید این آیتم را با قیمت ${itemPrice} سکه خریداری کنید؟`);
                if (confirmed) {
                    const userRef = doc(db, `users/${currentUserData.uid}`);
                    await updateDoc(userRef, {
                        coins: increment(-itemPrice),
                        unlockedCardBacks: arrayUnion(itemId)
                    });
                    // Update local data and UI
                    currentUserData.coins -= itemPrice;
                    currentUserData.unlockedCardBacks.push(itemId);
                    updateUIWithUserData();
                    e.target.disabled = true;
                    e.target.textContent = 'خریداری شده';
                    e.target.classList.remove('btn-green-classic');
                    e.target.classList.add('btn-gray-classic');
                    showMessageBox("خرید با موفقیت انجام شد!", "success");
                }
            }
        });

        // Daily Reward
        claimDailyRewardBtn.addEventListener('click', () => closeModal(dailyRewardModal));

        // Lobby Navigation
        friendlyGameBtn.addEventListener('click', () => { setActiveScreen(lobbyScreen); unsubscribeLobbies = setupLobbyListener(''); });
        ratedGameBtn.addEventListener('click', () => showMessageBox("بازی امتیازی به زودی!", "info"));
        backToMainBtn.addEventListener('click', () => { setActiveScreen(mainScreen); if (unsubscribeLobbies) unsubscribeLobbies(); });

        // Lobby Creation
        addIconBtn.addEventListener('click', () => showModal(createLobbyModal));
        closeCreateLobbyModalBtn.addEventListener('click', () => closeModal(createLobbyModal));
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lobbyName = newLobbyNameInput.value.trim();
            if (!lobbyName) { showCreateLobbyMessageBox("لطفاً نام لابی را وارد کنید.", "error"); return; }
            
            const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;
            if (lobbyType === 'private' && password.length < 4) { showCreateLobbyMessageBox("رمز عبور باید حداقل ۴ کاراکتر باشد.", "error"); return; }

            // New game settings
            const gameSettings = {
                maxPlayers: 4, // For now, hardcoded
                roundsToWin: parseInt(roundsToWinSelect.value)
            };

            try {
                const newLobbyId = await createLobby(lobbyName, currentUserData.uid, currentUserData, lobbyType, password, gameSettings);
                closeModal(createLobbyModal);
                currentLobbyId = newLobbyId;
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(newLobbyId);
            } catch (error) {
                showCreateLobbyMessageBox(error.message, "error");
            }
        });

        // Lobby Detail Actions
        leaveLobbyBtn.addEventListener('click', leaveLobby);
        playerReadyBtn.addEventListener('click', toggleReadyStatus);
        lobbyChatForm.addEventListener('submit', (e) => { e.preventDefault(); sendLobbyMessage(currentLobbyId, lobbyChatInput.value); });
    </script>
</body>
</html>
