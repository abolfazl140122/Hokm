<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک (با چت صوتی)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%);
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* --- VOICE CHAT: Speaking Indicator Styles --- */
        .speaking-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #6b7280; /* Gray when silent */
            margin-right: 12px; /* For RTL layout, space between name and indicator */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 1);
            flex-shrink: 0; /* Prevent from shrinking */
        }
        .is-speaking .speaking-indicator {
            background-color: #22c55e; /* Green when speaking */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out;
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%);
            border: 4px solid #DAA520; /* Goldenrod border */
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            max-height: 90vh;
            overflow-y: hidden;
            overflow-x: hidden;
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid #FFD700;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid #FFD700;
            border-right: 5px solid #FFD700;
            border-radius: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem;
            font-size: 1.125rem;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .classic-btn svg {
            margin-left: 8px; /* For RTL */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before { left: 100%; }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2);
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
        }

        /* Specific Button Colors - Classic Pallette */
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }

        /* Input Field Styles - More refined Classic Look */
        input {
            background-color: #202020;
            border: 2px solid #5A5A5A;
            color: #E0E0E0;
            padding: 0.875rem;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        input:focus {
            border-color: #DAA520 !important;
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }

        /* === Lobby Detail Screen Styles === */
        .lobby-detail-screen-full {
            padding-top: 0;
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
        }

        .lobby-detail-content {
            background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%);
            border: 3px solid #DAA520;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.7);
            padding: 1.5rem;
            width: 95%;
            max-width: 1200px;
            height: calc(100% - 100px); /* Fill available space minus header/margins */
            display: flex;
            flex-direction: row; /* Side-by-side layout on desktop */
            gap: 1.5rem;
            margin: 50px auto; /* Centered with margin top/bottom */
            overflow: hidden;
        }

        /* Sidebar for player info */
        .lobby-sidebar {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 300px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 1rem;
            border: 1px solid #444;
            overflow-y: auto;
        }
        #player-list-container {
            margin-top: 1rem;
            flex-grow: 1;
            overflow-y: auto;
        }
        .player-list-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .player-list-item.is-host { border-color: #FFD700; }
        .player-list-item .player-name-container { /* NEW: Wrapper for name and indicator */
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 0; /* flexbox fix */
        }
        .player-list-item .player-name {
            font-weight: bold;
            color: #E0E0E0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-list-item .host-label {
            color: #FFD700;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        
        .player-action-buttons { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .kick-player-btn, .make-host-btn { background: none; border-radius: 5px; padding: 0.2rem 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
        .kick-player-btn { border: 1px solid #B22222; color: #B22222; }
        .kick-player-btn:hover { background: #B22222; color: white; }
        .make-host-btn { border: 1px solid #DAA520; color: #DAA520; }
        .make-host-btn:hover { background: #DAA520; color: #1A1A1A; }


        /* Main panel for chat and actions */
        .lobby-main-panel { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .lobby-chat-container { background-color: rgba(0,0,0,0.4); border: 2px solid #5A5A5A; border-radius: 10px; padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .lobby-chat-messages { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; display: flex; flex-direction: column; }
        .chat-message { background-color: #333; padding: 0.5rem 0.75rem; border-radius: 10px; margin-bottom: 0.5rem; max-width: 80%; word-wrap: break-word; align-self: flex-start; display: flex; align-items: center; gap: 0.5rem; }
        .chat-message.current-user { background-color: #4682B4; align-self: flex-end; flex-direction: row-reverse; }
        .chat-message-content { flex-grow: 1; }
        .chat-message .sender-name { font-weight: bold; color: #FFD700; display: block; font-size: 0.9em; margin-bottom: 0.2rem; }
        .chat-message .message-text-deleted { font-style: italic; color: #999; }
        .delete-message-btn { background: none; border: none; color: #aaa; cursor: pointer; padding: 0.25rem; opacity: 0.5; transition: all 0.2s ease; flex-shrink: 0; }
        .chat-message:hover .delete-message-btn { opacity: 1; }
        .delete-message-btn:hover { color: #ff6b6b; transform: scale(1.1); }
        .lobby-chat-input-form { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-shrink: 0; }

        .lobby-actions-footer {
            flex-shrink: 0;
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        #voice-controls-container { /* NEW: Container for voice controls */
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 1px solid #444;
        }
        #voice-status-text {
            color: #aaa;
            font-size: 0.8rem;
            transition: color 0.3s ease;
        }
        #voice-status-text.connected { color: #22c55e; }
        #voice-status-text.error { color: #ef4444; }


        /* ... (other existing styles remain unchanged) ... */
        .app-header,.lobby-header,.app-footer,.lobby-footer,.main-content-area,.profile-modal-overlay,.lobby-item,.lobby-type-btn{/* Existing styles */}
        .lobby-header{background:linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);border-bottom:3px solid #FFD700;box-shadow:0 8px 20px rgba(0,0,0,0.7);height:70px;position:fixed;top:0;left:0;right:0;z-index:40;padding:0.75rem 1rem;display:flex;align-items:center;justify-content:center}.lobby-header .search-container{display:flex;flex-grow:1;max-width:600px;margin:0 auto;align-items:center;background-color:#303030;border-radius:15px;border:2px solid #5A5A5A;padding:0.5rem 1rem}.lobby-header .search-container input{flex-grow:1;background-color:transparent;border:none;padding:0.25rem 0.5rem;outline:none;text-align:right}.lobby-header .search-container input::placeholder{color:#A0A0A0}.lobby-header .search-container svg{color:#DAA520;min-width:24px;min-height:24px}.lobby-header .search-container button{background:none;border:none;cursor:pointer;padding:0 0.5rem}.lobby-footer{background:linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);border-top:3px solid #FFD700;box-shadow:0 -8px 20px rgba(0,0,0,0.7);height:90px;position:fixed;bottom:0;left:0;right:0;z-index:40;padding:1rem;display:flex;justify-content:space-around;align-items:center}.lobby-footer .icon-btn{display:flex;flex-direction:column;align-items:center;color:#FFD700;font-size:0.8rem;text-align:center;cursor:pointer;transition:transform .2s ease-in-out}.lobby-footer .icon-btn:hover{transform:translateY(-5px)}.lobby-footer .icon-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}.lobby-footer .icon-btn svg{width:30px;height:30px;margin-bottom:5px;transition:transform .8s ease-in-out}.lobby-footer .games-running-text{color:#E0E0E0;font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:5px}.main-content-area{padding-top:70px;padding-bottom:90px;flex-grow:1;overflow-y:hidden;overflow-x:hidden;width:100%;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;background:linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);position:relative}.lobby-item{background:linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%);border:2px solid #DAA520;border-radius:15px;box-shadow:0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1);transition:all .3s cubic-bezier(0.2, 0.8, 0.2, 1);position:relative;overflow:hidden;padding:1.25rem 1.5rem;display:flex;flex-direction:column;justify-content:space-between;align-items:center;text-align:center}.lobby-item:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2)}.lobby-item h3{color:#FFD700;font-size:1.75rem;font-family:'Playfair Display',serif;text-shadow:1px 1px 3px rgba(0,0,0,0.7)}.lobby-item p{color:#C0C0C0;font-size:1rem;margin-top:0.25rem}.lobby-item .lobby-actions{margin-top:1rem;display:flex;flex-direction:column;width:100%;gap:0.75rem}.lobby-item .join-lobby-btn,.lobby-item .close-lobby-btn{width:100%;padding:0.75rem 1rem;font-size:1rem}.lobby-type-btn{padding:0.5rem 1.5rem;border:2px solid #DAA520;border-radius:10px;transition:all .2s ease-in-out;background-color:transparent;color:#DAA520;font-weight:700}.lobby-type-btn.active{background-color:#DAA520;color:#1A1A1A;box-shadow:0 0 10px rgba(255,215,0,0.5)}.lobby-lock-icon{width:1.2rem;height:1.2rem;margin-left:0.5rem;color:#FFD700;display:inline-block;vertical-align:middle}.profile-modal-overlay{background-color:rgba(0,0,0,0.7);transition:opacity .3s ease-in-out}
        
        /* Custom Scrollbars */
        .lobby-sidebar::-webkit-scrollbar, #player-list-container::-webkit-scrollbar, .lobby-chat-messages::-webkit-scrollbar { width: 8px; }
        .lobby-sidebar::-webkit-scrollbar-track, #player-list-container::-webkit-scrollbar-track, .lobby-chat-messages::-webkit-scrollbar-track { background: #202020; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb, #player-list-container::-webkit-scrollbar-thumb, .lobby-chat-messages::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb:hover, #player-list-container::-webkit-scrollbar-thumb:hover, .lobby-chat-messages::-webkit-scrollbar-thumb:hover { background: #FFD700; }

        @media (max-width: 860px) {
            .lobby-detail-content { flex-direction: column; height: calc(100% - 80px); margin: 40px auto; padding: 1rem; overflow: hidden; }
            .lobby-sidebar { width: 100%; flex-shrink: 0; max-height: 250px; }
            .lobby-main-panel { flex-grow: 1; min-height: 0; }
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .lobby-item{flex-direction:row;text-align:right}.lobby-item .lobby-actions{flex-direction:row;width:auto;margin-top:0;gap:0.5rem}.lobby-item .close-lobby-btn{margin-right:0.5rem}.lobby-item .join-lobby-btn,.lobby-item .close-lobby-btn{width:auto;font-size:0.9rem;padding:0.6rem 1.2rem}
        }
    </style>
</head>
<body>

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">
        <!-- All screens (loading, auth, main, lobby-list) are unchanged -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">...</div>
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">...</div>
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">...</div>
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">...</div>
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">...</div>
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">...</div>
        <!-- ... other modals ... -->


        <!-- 8. Lobby Detail Screen (REDESIGNED FOR VOICE CHAT) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                
                <!-- Sidebar: Lobby Info & Players -->
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    
                    <div class="w-full h-px bg-yellow-600 mb-4"></div>

                    <div id="player-list-container">
                        <!-- Player list items will be dynamically loaded here with speaking indicators -->
                    </div>
                </div>

                <!-- Main Panel: Chat & Actions -->
                <div class="lobby-main-panel">
                    <!-- Chat Container -->
                    <div class="lobby-chat-container">
                        <div id="lobby-chat-messages" class="lobby-chat-messages"></div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form">
                            <input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>

                    <!-- Action Buttons Footer -->
                    <div class="lobby-actions-footer">
                        <!-- Left side: Host actions -->
                        <div id="host-actions-container" style="display: none;" class="flex flex-wrap gap-4">
                            <button id="start-game-btn" class="classic-btn btn-green-classic text-base py-2 px-4" disabled>شروع بازی</button>
                            <button id="toggle-chat-lock-btn" class="classic-btn btn-gray-classic text-sm py-2 px-4">قفل کردن چت</button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4">لیست اخراجی‌ها</button>
                        </div>
                        
                        <!-- Middle/Right side: Voice and Leave actions -->
                        <div class="flex items-center gap-4 ml-auto">
                            <!-- NEW: Voice Chat Controls -->
                            <div id="voice-controls-container" class="hidden">
                                <button id="toggle-mute-btn" class="classic-btn btn-gray-classic text-sm py-2 px-4"></button>
                                <span id="voice-status-text">آماده‌سازی صدا...</span>
                            </div>
                            <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک لابی</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- This hidden container will hold the <audio> elements for remote streams -->
        <div id="remote-audio-container" class="hidden"></div>
    </div>

    <!-- The rest of the HTML (modals, etc.) and the script will go here. For brevity, I'm omitting the unchanged HTML modals. -->
    <!-- The following script tag replaces your entire existing script tag. -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your existing Firebase config and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Your existing DOM element selections and state variables...
        // ... (all your existing variables from `let authMode = 'login';` onwards)

        // --- NEW: Voice Chat State Variables ---
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };
        let localStream = null;
        let peerConnections = {};
        let signalsUnsubscribe = null;
        let isMuted = false;
        let voiceChatInitialized = false;

        // --- NEW: Voice Chat UI Elements ---
        const voiceControlsContainer = document.getElementById('voice-controls-container');
        const toggleMuteBtn = document.getElementById('toggle-mute-btn');
        const voiceStatusText = document.getElementById('voice-status-text');
        const remoteAudioContainer = document.getElementById('remote-audio-container');
        
        // --- VOICE CHAT CORE FUNCTIONS (Adapted for Lobby) ---

        /**
         * Initializes the voice chat for a specific lobby.
         * Gets user media and sets up Firestore listener for signaling.
         */
        async function initializeVoiceChat(lobbyId) {
            if (voiceChatInitialized) return;
            console.log(`VOICE: Initializing for lobby ${lobbyId}`);
            voiceControlsContainer.classList.remove('hidden');
            voiceStatusText.textContent = "درخواست دسترسی...";
            
            try {
                const audioConstraints = {
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true, channelCount: 2, sampleRate: 48000 },
                    video: false,
                };
                localStream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                voiceChatInitialized = true;
                voiceStatusText.textContent = "در حال اتصال...";
                updateMuteButton();
                
                // Listen for signals (offers, answers, candidates) in the lobby's subcollection
                const signalsCol = collection(db, `global_lobbies/${lobbyId}/signals`);
                const q = query(signalsCol, where("to", "==", auth.currentUser.uid));
                
                signalsUnsubscribe = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const signalData = change.doc.data();
                            const remoteId = signalData.from;
                            const pc = peerConnections[remoteId];

                            if (!pc) { 
                                console.warn(`VOICE: Received signal from unknown peer ${remoteId}`);
                                await deleteDoc(change.doc.ref);
                                return;
                            }
                            try {
                                if (signalData.offer && pc.signalingState === 'stable') {
                                    await pc.setRemoteDescription(new RTCSessionDescription(signalData.offer));
                                    const answer = await pc.createAnswer();
                                    const hqAnswer = setAudioQuality(answer);
                                    await pc.setLocalDescription(hqAnswer);
                                    await sendSignal(lobbyId, remoteId, { answer: hqAnswer });
                                } else if (signalData.answer && pc.signalingState === 'have-local-offer') {
                                    await pc.setRemoteDescription(new RTCSessionDescription(signalData.answer));
                                } else if (signalData.iceCandidate && pc.remoteDescription) {
                                    await pc.addIceCandidate(new RTCIceCandidate(signalData.iceCandidate));
                                }
                            } catch (err) { console.error("VOICE: Signal Processing Error:", err); }
                            await deleteDoc(change.doc.ref);
                        }
                    });
                });
                voiceStatusText.classList.add('connected');
                voiceStatusText.textContent = "چت صوتی فعال";

            } catch (err) {
                console.error("VOICE: GetUserMedia error:", err);
                voiceStatusText.classList.add('error');
                voiceStatusText.textContent = "خطا در دسترسی به میکروفون";
                voiceChatInitialized = false; // Allow retry if user gives permission later
            }
        }

        /**
         * Cleans up all voice chat connections and resources.
         */
        function hangupVoiceChat() {
            if (!voiceChatInitialized) return;
            console.log("VOICE: Hanging up all connections.");
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (signalsUnsubscribe) {
                signalsUnsubscribe();
            }
            Object.keys(peerConnections).forEach(id => closeConnection(id));

            localStream = null;
            peerConnections = {};
            signalsUnsubscribe = null;
            voiceChatInitialized = false;
            
            voiceControlsContainer.classList.add('hidden');
            remoteAudioContainer.innerHTML = ''; // Clear old audio elements
        }
        
        /**
         * Creates a new RTCPeerConnection for a remote user.
         */
        function createPeerConnection(remoteId, lobbyId) {
            const pc = new RTCPeerConnection(servers);
            
            pc.onicecandidate = e => {
                if (e.candidate) {
                    sendSignal(lobbyId, remoteId, { iceCandidate: e.candidate.toJSON() });
                }
            };

            pc.ontrack = event => {
                console.log(`VOICE: Received remote track from ${remoteId}`);
                let remoteAudio = document.getElementById(`audio-${remoteId}`);
                if (!remoteAudio) {
                    remoteAudio = document.createElement('audio');
                    remoteAudio.id = `audio-${remoteId}`;
                    remoteAudio.autoplay = true;
                    remoteAudio.playsInline = true;
                    remoteAudioContainer.appendChild(remoteAudio);
                }
                remoteAudio.srcObject = event.streams[0];
                setupAudioVisualizer(event.streams[0], remoteId);
            };

            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }

            return pc;
        }

        /**
         * Manages peer connections based on the current player list.
         */
        async function updatePeerConnections(lobbyId, playersMap) {
            if (!voiceChatInitialized) return;

            const myId = auth.currentUser.uid;
            const remotePlayerIds = Object.keys(playersMap).filter(id => id !== myId);
            const currentConnectionIds = Object.keys(peerConnections);

            // Add new connections
            for (const remoteId of remotePlayerIds) {
                if (!peerConnections[remoteId]) {
                    console.log(`VOICE: New player ${remoteId} detected. Creating peer connection.`);
                    peerConnections[remoteId] = createPeerConnection(remoteId, lobbyId);
                    // The "older" peer (lexicographically) sends the offer
                    if (myId < remoteId) {
                        await sendOffer(lobbyId, remoteId);
                    }
                }
            }

            // Remove old connections
            for (const connectionId of currentConnectionIds) {
                if (!remotePlayerIds.includes(connectionId)) {
                    console.log(`VOICE: Player ${connectionId} left. Closing connection.`);
                    closeConnection(connectionId);
                }
            }
        }

        async function sendOffer(lobbyId, remoteId) {
            const pc = peerConnections[remoteId];
            if (!pc) return;
            try {
                const offer = await pc.createOffer();
                const hqOffer = setAudioQuality(offer);
                await pc.setLocalDescription(hqOffer);
                await sendSignal(lobbyId, remoteId, { offer: hqOffer });
                console.log(`VOICE: Offer sent to ${remoteId}`);
            } catch (err) { console.error("VOICE: Offer Error:", err); }
        }

        async function sendSignal(lobbyId, toId, data) {
            const signalsCol = collection(db, `global_lobbies/${lobbyId}/signals`);
            await addDoc(signalsCol, { ...data, from: auth.currentUser.uid, to: toId });
        }

        function closeConnection(remoteId) {
            const pcData = peerConnections[remoteId];
            if (pcData) {
                if (pcData.visualizer) {
                    cancelAnimationFrame(pcData.visualizer.animationFrameId);
                    if (pcData.visualizer.audioContext.state !== 'closed') {
                       pcData.visualizer.audioContext.close();
                    }
                }
                pcData.close();
                delete peerConnections[remoteId];
            }
            document.getElementById(`audio-${remoteId}`)?.remove();
            const indicator = document.getElementById(`speaking-indicator-${remoteId}`);
            if (indicator) indicator.parentElement.classList.remove('is-speaking');
        }

        function setAudioQuality(sdpObject) {
            let sdp = sdpObject.sdp;
            const opusParams = 'useinbandfec=1;stereo=1;sprop-stereo=1;usedtx=0;maxaveragebitrate=128000;maxplaybackrate=48000';
            const opusRegex = /a=rtpmap:(\d+) opus\/48000\/2/i;
            const match = sdp.match(opusRegex);
            if (match) {
                const payloadType = match[1];
                const fmtpRegex = new RegExp(`a=fmtp:${payloadType} .*`, 'i');
                const newFmtpLine = `a=fmtp:${payloadType} ${opusParams}`;
                if (sdp.match(fmtpRegex)) { sdp = sdp.replace(fmtpRegex, newFmtpLine); } 
                else { sdp = sdp.replace(match[0], `${match[0]}\r\n${newFmtpLine}`); }
            }
            return { type: sdpObject.type, sdp };
        }

        function setupAudioVisualizer(stream, remoteId) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            if (peerConnections[remoteId]) {
                 peerConnections[remoteId].visualizer = { audioContext, animationFrameId: null };
            }

            const draw = () => {
                const playerListItem = document.getElementById(`player-item-${remoteId}`);
                if (!playerListItem || !peerConnections[remoteId]) {
                    if(peerConnections[remoteId]?.visualizer?.animationFrameId) {
                        cancelAnimationFrame(peerConnections[remoteId].visualizer.animationFrameId);
                    }
                    return;
                }
                analyser.getByteFrequencyData(dataArray);
                let average = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                
                if (average > 20) { playerListItem.classList.add('is-speaking'); } 
                else { playerListItem.classList.remove('is-speaking'); }
                
                peerConnections[remoteId].visualizer.animationFrameId = requestAnimationFrame(draw);
            };
            draw();
        }

        function updateMuteButton() {
            const icon = isMuted 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic-off"><line x1="2" x2="22" y1="2" y2="22"/><path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2a7 7 0 0 0-11.42-5.77"/><path d="M15 18V12a3 3 0 0 0-3-3H9"/><path d="M12 18v4m-4 0h8"/><path d="M9.06 9.06A7.12 7.12 0 0 0 5 12v2a7 7 0 0 0 12 5"/></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`;
            toggleMuteBtn.innerHTML = `${icon} <span>${isMuted ? 'وصل صدا' : 'قطع صدا'}</span>`;
            toggleMuteBtn.classList.toggle('btn-red-classic', isMuted);
            toggleMuteBtn.classList.toggle('btn-gray-classic', !isMuted);
        }

        // --- MODIFICATIONS to existing functions ---

        // Modify setupLobbyDetailListener to handle voice chat
        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to lobby details for ID: ${lobbyId}`);
            // ... (your existing cleanup code for other listeners)
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }

            // Initialize voice chat when entering the lobby
            initializeVoiceChat(lobbyId);

            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            const unsubscribe = onSnapshot(lobbyRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const lobbyData = docSnap.data();
                    const playersMap = lobbyData.players || {};
                    
                    // --- VOICE CHAT: Update peer connections based on player list ---
                    updatePeerConnections(lobbyId, playersMap);

                    // ... (your existing UI update logic for lobby name, player count, etc.)

                    playerListContainer.innerHTML = '';
                    const playerList = Object.entries(playersMap).map(([uid, displayName]) => ({ uid, displayName }));

                    for (const player of playerList) {
                        const isHost = player.uid === lobbyData.hostId;
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-list-item';
                        playerItem.id = `player-item-${player.uid}`; // ID for speaking indicator targeting
                        // ... (rest of your player item creation logic)
                        
                        const hostLabelHtml = isHost ? '<span class="host-label">(سازنده)</span>' : '';
                        const speakingIndicatorHtml = `<div class="speaking-indicator" id="speaking-indicator-${player.uid}"></div>`;
                        
                        // Action buttons logic...
                        let actionButtonsHtml = ''; // ... your existing logic for kick/make host buttons

                        playerItem.innerHTML = `
                            <div class="player-name-container">
                                ${speakingIndicatorHtml}
                                <span class="player-name">${player.displayName}</span>
                                ${hostLabelHtml}
                            </div>
                            ${actionButtonsHtml}
                        `;
                        playerListContainer.appendChild(playerItem);
                    }
                    // ... (rest of your existing logic in this function)

                } else {
                    // Lobby was deleted, hang up voice chat
                    hangupVoiceChat();
                    showMessageBox("لابی که در آن بودید بسته شد.", "info");
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            }, (error) => {
                // ... your existing error handling
            });
            return unsubscribe;
        }

        // Modify leaveLobby to hangup voice chat
        async function leaveLobby() {
            // Hangup voice chat first
            hangupVoiceChat();

            if (!currentLobbyId || !auth.currentUser) return;
            // ... (rest of your existing leaveLobby logic)
        }
        
        // Modify signOut process to hangup voice chat
        profileLogoutBtn.addEventListener('click', async () => {
            hangupVoiceChat(); // Hangup before signing out
            try { await signOut(auth); closeProfileModal(); } catch (error) { showMessageBox(getFirebaseErrorMessage(error.code), 'error'); }
        });
        
        // Add window unload listener to hangup
        window.addEventListener('beforeunload', hangupVoiceChat);
        
        // NEW: Event listener for the mute button
        toggleMuteBtn.addEventListener('click', () => {
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            updateMuteButton();
        });


        // The rest of your JavaScript file (event listeners, etc.) should remain as is.
        // Make sure you have all the necessary variable and function definitions.
        // I have omitted them here for brevity, but they should be in your final file.
    </script>
</body>
</html>
