<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی هوش مصنوعی</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ================================================= */
        /* === بخش CSS بدون تغییر باقی می‌ماند (بسیار طولانی است) === */
        /* === فقط استایل‌های جدید در زیر اضافه می‌شوند === */
        /* ================================================= */
        html, body, #app { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Vazirmatn', sans-serif; background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); color: #E0E0E0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        h1, h2 { font-family: 'Playfair Display', serif; color: #FFD700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .classic-card { background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); border: 4px solid #DAA520; border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); position: relative; max-height: 90vh; overflow-y: hidden; overflow-x: hidden; }
        .classic-btn { border: 2px solid #DAA520; border-radius: 15px; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); color: #FFFFFF; padding: 0.875rem 1.5rem; font-size: 1.125rem; position: relative; overflow: hidden; }
        .classic-btn:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); }
        input { background-color: #202020; border: 2px solid #5A5A5A; color: #E0E0E0; padding: 0.875rem; border-radius: 0.75rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        input:focus { border-color: #DAA520 !important; box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; }
        .main-content-area { padding-top: 70px; padding-bottom: 90px; flex-grow: 1; overflow-y: hidden; overflow-x: hidden; width: 100%; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); position: relative; }
        .page-transition-active { transition: opacity 0.6s ease-in-out; }
        .page-transition-hidden { opacity: 0; }
        .page-transition-visible { opacity: 1; }

        /* === استایل‌های جدید برای بازی هوش مصنوعی === */

        /* استایل برای شمارش معکوس شروع بازی */
        #game-countdown-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: opacity 0.5s ease-in-out;
        }
        #countdown-timer {
            font-family: 'Playfair Display', serif;
            font-size: 12rem;
            color: #FFD700;
            text-shadow: 0 0 30px #FFD700, 0 0 60px #DAA520;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* استایل برای نمایش نقش بازیکن */
        #my-role-display {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #FFD700;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            transition: all 0.5s ease-in-out;
            transform: translateY(-100px);
            opacity: 0;
        }
        #my-role-display.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .role-human { color: #60a5fa; /* blue-400 */ }
        .role-ai { color: #f87171; /* red-400 */ }

        /* استایل برای تایمر گفتگو */
        #discussion-timer {
            background-color: rgba(0,0,0,0.5);
            border-radius: 10px;
            border: 1px solid #DAA520;
        }
        
        /* استایل برای اینترفیس رای‌گیری */
        #voting-interface {
            background: rgba(10, 0, 0, 0.7);
            border: 2px solid #DAA520;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }
        .vote-player-btn {
            background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); /* Steel Blue / Royal Blue */
        }
        .vote-player-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .vote-player-btn.voted-for {
            border-color: #34d399; /* green-400 */
            box-shadow: 0 0 15px #34d399;
        }

        /* استایل برای صفحه پایان بازی */
        #game-over-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            transition: opacity 0.8s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="app" class="relative w-full h-full flex justify-center items-center">
        <!-- بقیه مودال‌ها و صفحه‌ها بدون تغییر باقی می‌مانند... -->

        <!-- Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible"></div>

        <!-- Auth Screen -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center z-40 page-transition-active page-transition-hidden"></div>
        
        <!-- Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden"></div>
        
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden"></div>

        <!-- Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50"></div>
        
        <!-- Create Lobby Modal (MODIFIED) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">
                    <input type="text" id="new-lobby-name-input" placeholder="نام لابی شما" class="w-full" required>
                    
                    <!-- NEW: Game Duration Setting -->
                    <div>
                        <label for="game-duration-select" class="block text-right mb-2 text-yellow-300">مدت زمان گفتگو:</label>
                        <select id="game-duration-select" class="w-full text-white bg-gray-800 border-gray-600 p-3 rounded-lg">
                            <option value="180">۳ دقیقه</option>
                            <option value="300" selected>۵ دقیقه</option>
                            <option value="600">۱۰ دقیقه</option>
                            <option value="900">۱۵ دقیقه</option>
                        </select>
                    </div>
                    
                    <button type="submit" id="submit-create-lobby-btn" class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>
        
        <!-- Lobby Detail Screen -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full"></div>
        
        <!-- Game Screen (HEAVILY MODIFIED) -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden flex flex-col items-center justify-center p-2" tabindex="-1">
            
            <!-- Game Header -->
            <div class="absolute top-0 left-0 right-0 h-24 bg-black bg-opacity-40 flex justify-between items-center px-4 z-20">
                <!-- NEW: My Role Display -->
                <div id="my-role-display" class="p-4 text-center">
                    <h3 class="text-lg">نقش شما:</h3>
                    <p id="my-role-text" class="text-2xl font-bold"></p>
                </div>
                
                <!-- NEW: Discussion Timer -->
                <div id="discussion-timer" class="p-4 text-center text-white">
                    <h3 class="text-lg text-yellow-300">زمان باقی‌مانده</h3>
                    <p id="timer-display" class="text-3xl font-bold">--:--</p>
                </div>

                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی</button>
            </div>

            <!-- Main Game Content (Replaces Table) -->
            <div id="game-content-area" class="w-full h-full flex pt-24">
                <!-- Player List Sidebar -->
                <div class="w-1/4 bg-black bg-opacity-30 p-4 rounded-lg overflow-y-auto">
                    <h3 class="text-xl font-bold text-yellow-300 mb-4">بازیکنان</h3>
                    <div id="game-player-list" class="space-y-3">
                        <!-- Player items will be dynamically loaded here -->
                    </div>
                </div>
                
                <!-- Chat Area -->
                <div class="w-3/4 flex flex-col p-4">
                    <div class="flex-grow bg-black bg-opacity-40 border-2 border-gray-700 rounded-lg p-2 flex flex-col overflow-hidden">
                        <div id="game-chat-messages" class="flex-grow overflow-y-auto space-y-2 pr-2">
                           <!-- Game chat messages will appear here -->
                        </div>
                        <form id="game-chat-form" class="mt-2 flex gap-2">
                            <input type="text" id="game-chat-input" placeholder="پیام خود را با لحنی ادبی بنویسید..." class="flex-grow" autocomplete="off">
                            <button type="submit" id="game-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- NEW: Countdown Overlay -->
            <div id="game-countdown-overlay" class="hidden absolute inset-0 z-50 flex flex-col justify-center items-center">
                <p id="countdown-timer">5</p>
                <h2 class="text-4xl mt-8">بازی در حال شروع است...</h2>
            </div>
            
            <!-- NEW: Voting Interface Overlay -->
            <div id="voting-interface" class="hidden absolute inset-0 z-40 flex flex-col justify-center items-center p-8">
                <h2 class="text-4xl mb-6">زمان رای‌گیری!</h2>
                <p class="text-lg mb-8">به فردی که فکر می‌کنید هوش مصنوعی است رای دهید تا حذف شود.</p>
                <div id="voting-options" class="grid grid-cols-2 gap-4 w-full max-w-lg">
                    <!-- Voting buttons will be generated here -->
                </div>
                 <p id="vote-status-text" class="mt-6 text-xl text-yellow-300"></p>
            </div>

            <!-- NEW: Game Over Overlay -->
            <div id="game-over-overlay" class="hidden absolute inset-0 z-50 flex flex-col justify-center items-center text-center p-8">
                <h2 id="game-over-title" class="text-6xl font-bold mb-4">بازی تمام شد</h2>
                <p id="game-over-reason" class="text-2xl mb-8"></p>
                <div id="game-over-roles" class="mb-8"></div>
                <button id="return-to-lobby-btn" class="classic-btn btn-blue-classic text-xl">بازگشت به لابی‌ها</button>
            </div>
        </div>

        <!-- All other modals (kick, confirmation, etc.) -->

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // All previous Firebase imports and config remain the same...
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // All previous Firebase and DOM element variables...
        // ... (The long list of variables from your original code)

        // === NEW & MODIFIED DOM Elements ===
        const gameDurationSelect = document.getElementById('game-duration-select');
        const gameScreen = document.getElementById('game-screen');
        const myRoleDisplay = document.getElementById('my-role-display');
        const myRoleText = document.getElementById('my-role-text');
        const discussionTimer = document.getElementById('discussion-timer');
        const timerDisplay = document.getElementById('timer-display');
        const gamePlayerList = document.getElementById('game-player-list');
        const gameChatMessages = document.getElementById('game-chat-messages');
        const gameChatForm = document.getElementById('game-chat-form');
        const gameChatInput = document.getElementById('game-chat-input');
        const gameChatSendBtn = document.getElementById('game-chat-send-btn');
        const gameCountdownOverlay = document.getElementById('game-countdown-overlay');
        const countdownTimer = document.getElementById('countdown-timer');
        const votingInterface = document.getElementById('voting-interface');
        const votingOptions = document.getElementById('voting-options');
        const voteStatusText = document.getElementById('vote-status-text');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const gameOverTitle = document.getElementById('game-over-title');
        const gameOverReason = document.getElementById('game-over-reason');
        const gameOverRoles = document.getElementById('game-over-roles');
        const returnToLobbyBtn = document.getElementById('return-to-lobby-btn');
        const leaveGameBtn = document.getElementById('leave-game-btn');


        // === NEW & MODIFIED State Variables ===
        let unsubscribeGame = null;
        let gameTimerInterval = null; // To hold the setInterval ID for the discussion timer

        // The Gemini API Key for chat validation
        const GEMINI_API_KEY = "AIzaSyDfMZwyWNnRFUDLHKR1t_hZ5cWv2c_KvvE"; // (This should be kept secure in a real app)

        // ==========================================================
        // === ALL PREVIOUS FUNCTIONS (Auth, Modals, etc.)
        // === ARE KEPT HERE, BUT ARE OMITTED FOR BREVITY.
        // === WE WILL FOCUS ONLY ON THE NEW/MODIFIED FUNCTIONS.
        // ==========================================================

        // --- Helper and Utility Functions (Some are new) ---

        // Function to transition between screens (Unchanged)
        function setActiveScreen(newScreen) { /* ... same as before ... */ }
        function showMessageBox(msg, type) { /* ... same as before ... */ }
        async function showCustomConfirm(message, title) { /* ... same as before ... */ }
        
        /**
         * MODIFIED: This function is now used to create the AI vs Human game lobby.
         */
        async function createLobby(lobbyName, userId, displayName, gameDuration) {
            // ... (previous checks for active lobbies remain the same) ...
            const lobbiesRef = collection(db, `global_lobbies`);
            const newLobbyData = {
                name: lobbyName,
                hostId: userId,
                status: "waiting", // Game starts as 'waiting'
                players: { [userId]: displayName },
                createdAt: serverTimestamp(),
                gameSettings: { 
                    maxPlayers: 4, 
                    // NEW: Store the game duration
                    durationSeconds: parseInt(gameDuration, 10) 
                }
            };
            const newLobbyRef = await addDoc(lobbiesRef, newLobbyData);
            return newLobbyRef.id;
        }

        /**
         * MODIFIED: The create lobby form handler now gets the duration.
         */
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lobbyName = newLobbyNameInput.value.trim();
            const gameDuration = gameDurationSelect.value;
            // ... (validation for name, user, etc. remains the same) ...
            try {
                // The AI check for the lobby name can be kept if desired.
                const newLobbyId = await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName, gameDuration);
                // ... (rest of the success logic) ...
            } catch (error) {
                // ... (error handling) ...
            }
        });

        /**
         * NEW: AI Chat Style Validator
         * Checks if the user's message is in a formal/literary/AI-like style.
         * @param {string} messageText - The message to validate.
         * @returns {Promise<{is_valid_style: boolean, reason: string}>}
         */
        async function validateMessageStyleWithAI(messageText) {
            const prompt = `As a strict linguistic style moderator for a role-playing game, analyze the following Persian text. The required style is formal, literary, and sophisticated, as if spoken by an advanced AI. The text MUST NOT contain modern slang, casual chat abbreviations, or overly simplistic conversational phrases. Your response MUST be a JSON object with this exact structure: {"is_valid_style": boolean, "reason": string}. If 'is_valid_style' is false, provide a brief, helpful reason in Persian for the user (e.g., "لحن بیش از حد عامیانه است", "از کلمات رسمی‌تری استفاده کنید"). If the style is valid, 'reason' should be an empty string. Text to analyze: "${messageText}"`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "is_valid_style": { "type": "BOOLEAN" },
                            "reason": { "type": "STRING" }
                        },
                        required: ["is_valid_style", "reason"]
                    }
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    return { is_valid_style: false, reason: "خطا در ارتباط با سرور اعتبارسنجی." };
                }
                const result = await response.json();
                const jsonString = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonString);
            } catch (error) {
                console.error("Error calling AI validation API:", error);
                return { is_valid_style: false, reason: "خطا در پردازش درخواست اعتبارسنجی." };
            }
        }


        /**
         * NEW: Function to initialize the AI vs Human game in Firestore.
         * This is called by the host when they click "Start Game".
         * @param {string} lobbyId - The ID of the lobby.
         * @param {object} lobbyData - The current data of the lobby.
         */
        async function initializeAiGameInFirestore(lobbyId, lobbyData) {
            const playerUIDs = Object.keys(lobbyData.players);
            
            // Shuffle players to randomly assign the AI role
            for (let i = playerUIDs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [playerUIDs[i], playerUIDs[j]] = [playerUIDs[j], playerUIDs[i]];
            }

            const aiPlayerUid = playerUIDs[0];
            const roles = {};
            playerUIDs.forEach(uid => {
                roles[uid] = (uid === aiPlayerUid) ? 'ai' : 'human';
            });

            const initialGameState = {
                phase: 'countdown', // Start with the countdown
                players: lobbyData.players, // Map of uid -> displayName
                activePlayers: playerUIDs, // Array of UIDs of players still in game
                roles: roles,
                gameStartTime: serverTimestamp(),
                durationSeconds: lobbyData.gameSettings.durationSeconds,
                votes: {},
                eliminatedPlayer: null,
                winner: null,
                winReason: null
            };

            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            try {
                // We're not creating a separate game document, just updating the lobby.
                await updateDoc(lobbyRef, {
                    gameState: initialGameState,
                    status: "playing" // Change lobby status to 'playing'
                });
                console.log(`AI vs Human game initialized for lobby ${lobbyId}`);
            } catch (error) {
                console.error("Error initializing game state:", error);
                // Revert on failure
                await updateDoc(lobbyRef, { status: "waiting", gameState: deleteField() }); 
                throw new Error("Failed to initialize game.");
            }
        }

        // MODIFIED: The Start Game button now calls the new initializer
        startGameBtn.addEventListener('click', async () => {
            if (currentLobbyId && auth.currentUser) {
                try {
                    const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
                    const lobbySnap = await getDoc(lobbyRef);
                    if (lobbySnap.exists()) {
                        // Call the new game initializer
                        await initializeAiGameInFirestore(currentLobbyId, lobbySnap.data());
                    }
                } catch (error) {
                    console.error("Error starting game:", error);
                    showMessageBox(`خطا در شروع بازی: ${error.message}`, "error");
                }
            }
        });


        /**
         * HEAVILY MODIFIED: This is now the main game state machine.
         * It listens to changes in the game state and updates the UI accordingly.
         * @param {string} lobbyId - The ID of the lobby/game.
         */
        function setupGameListener(lobbyId) {
            console.log(`Listening to AI game state for lobby ID: ${lobbyId}`);
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            
            return onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().gameState) {
                    const lobbyData = docSnap.data();
                    const gameState = lobbyData.gameState;
                    const myUid = auth.currentUser.uid;
                    
                    // Main render function that dispatches based on phase
                    renderGamePhase(gameState, myUid, lobbyId);
                } else {
                    // Game has ended or been deleted
                    if(gameTimerInterval) clearInterval(gameTimerInterval);
                    showMessageBox("بازی مورد نظر پایان یافت.", "info");
                    setActiveScreen(lobbyScreen);
                    // setupLobbyListener('');
                }
            }, (error) => {
                console.error("Game state listener error:", error);
                // ... error handling ...
            });
        }
        
        /**
         * NEW: Renders the UI based on the current game phase.
         */
        function renderGamePhase(gameState, myUid, lobbyId) {
            // Stop any previous timers
            if (gameTimerInterval) clearInterval(gameTimerInterval);

            // Hide all overlays by default
            gameCountdownOverlay.classList.add('hidden');
            votingInterface.classList.add('hidden');
            gameOverOverlay.classList.add('hidden');
            myRoleDisplay.classList.remove('visible');

            // Always render the player list
            renderGamePlayerList(gameState);

            switch (gameState.phase) {
                case 'countdown':
                    handleCountdownPhase(gameState);
                    break;
                case 'discussion':
                    handleDiscussionPhase(gameState, myUid, lobbyId);
                    break;
                case 'voting':
                    handleVotingPhase(gameState, myUid, lobbyId);
                    break;
                case 'gameOver':
                    handleGameOverPhase(gameState);
                    break;
            }
        }
        
        // --- Phase Handling Functions ---
        
        function handleCountdownPhase(gameState) {
            gameCountdownOverlay.classList.remove('hidden');
            const startTime = gameState.gameStartTime.toDate();
            const countdownInterval = setInterval(() => {
                const now = new Date();
                const diffSeconds = Math.floor((now - startTime) / 1000);
                const count = 5 - diffSeconds;
                countdownTimer.textContent = count > 0 ? count : 'شروع!';
                
                if (count < 0) {
                    clearInterval(countdownInterval);
                    // The server (or host client as a fallback) will change the phase.
                    // The onSnapshot listener will then catch this change.
                }
            }, 1000);
        }

        function handleDiscussionPhase(gameState, myUid) {
            // Show my role
            const myRole = gameState.roles[myUid];
            myRoleText.textContent = myRole === 'ai' ? 'هوش مصنوعی' : 'انسان';
            myRoleText.className = myRole === 'ai' ? 'role-ai' : 'role-human';
            myRoleDisplay.classList.add('visible');

            // Enable chat
            gameChatInput.disabled = false;
            gameChatSendBtn.disabled = false;
            gameChatInput.placeholder = "پیام خود را با لحنی ادبی بنویسید...";

            // Start the discussion timer
            const discussionEndTime = gameState.gameStartTime.toDate().getTime() + (gameState.durationSeconds * 1000);
            gameTimerInterval = setInterval(() => {
                const remaining = Math.max(0, discussionEndTime - new Date().getTime());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (remaining === 0) {
                    clearInterval(gameTimerInterval);
                    // The host is responsible for transitioning to the voting phase
                    // In a real app, this should be a Cloud Function.
                }
            }, 1000);
        }

        function handleVotingPhase(gameState, myUid, lobbyId) {
            votingInterface.classList.remove('hidden');
            votingOptions.innerHTML = '';
            
            // Check if I am an active player and haven't voted yet
            const canVote = gameState.activePlayers.includes(myUid) && !gameState.votes[myUid];
            
            gameState.activePlayers.forEach(playerUid => {
                if (playerUid === myUid) return; // Can't vote for yourself
                
                const playerName = gameState.players[playerUid];
                const btn = document.createElement('button');
                btn.className = 'classic-btn vote-player-btn';
                btn.textContent = `رای به: ${playerName}`;
                btn.dataset.voteFor = playerUid;
                btn.disabled = !canVote;
                
                votingOptions.appendChild(btn);
            });
            
            if (!canVote) {
                 voteStatusText.textContent = gameState.votes[myUid] ? "شما رای خود را ثبت کرده‌اید. منتظر بقیه بمانید..." : "شما حذف شده‌اید و حق رای ندارید.";
            } else {
                 voteStatusText.textContent = "به فرد مشکوک رای دهید.";
            }
        }
        
        function handleGameOverPhase(gameState) {
            gameOverOverlay.classList.remove('hidden');
            gameOverTitle.textContent = gameState.winner === 'humans' ? "انسان‌ها پیروز شدند!" : "هوش مصنوعی پیروز شد!";
            gameOverReason.textContent = gameState.winReason;
            
            // Show all roles at the end
            gameOverRoles.innerHTML = '<h4>نقش‌ها:</h4>';
            for (const uid in gameState.roles) {
                const playerName = gameState.players[uid];
                const role = gameState.roles[uid] === 'ai' ? 'هوش مصنوعی' : 'انسان';
                const roleClass = gameState.roles[uid] === 'ai' ? 'text-red-400' : 'text-blue-400';
                gameOverRoles.innerHTML += `<p>${playerName}: <span class="${roleClass} font-bold">${role}</span></p>`;
            }
        }
        
        // --- UI Rendering Sub-functions ---
        
        function renderGamePlayerList(gameState) {
            gamePlayerList.innerHTML = '';
            for (const uid in gameState.players) {
                const playerDiv = document.createElement('div');
                const isEliminated = !gameState.activePlayers.includes(uid);
                playerDiv.className = `p-2 rounded flex items-center ${isEliminated ? 'opacity-50' : 'bg-white bg-opacity-10'}`;
                playerDiv.innerHTML = `
                    <svg ...>...</svg> <!-- Avatar icon -->
                    <span class="mr-2 ${isEliminated ? 'line-through' : ''}">${gameState.players[uid]}</span>
                `;
                gamePlayerList.appendChild(playerDiv);
            }
        }


        // --- Event Handlers for New Game Mechanics ---

        // Game Chat Submission with AI Validation
        gameChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = gameChatInput.value.trim();
            if (!messageText) return;
            
            gameChatSendBtn.disabled = true;
            gameChatSendBtn.textContent = 'بررسی...';

            try {
                const validation = await validateMessageStyleWithAI(messageText);
                if (validation.is_valid_style) {
                    // If style is valid, send the message (logic to be added)
                    // sendGameMessage(currentLobbyId, messageText);
                    gameChatInput.value = '';
                } else {
                    // Show error to user
                    showMessageBox(`سبک پیام نامعتبر: ${validation.reason}`, 'error');
                }
            } catch (error) {
                showMessageBox("خطا در اعتبارسنجی پیام.", "error");
            } finally {
                gameChatSendBtn.disabled = false;
                gameChatSendBtn.textContent = 'ارسال';
            }
        });
        
        // Voting Button Clicks
        votingOptions.addEventListener('click', (e) => {
            if (e.target.matches('.vote-player-btn')) {
                const votedForUid = e.target.dataset.voteFor;
                // Cast vote in Firestore (logic to be added)
                // castVote(currentLobbyId, auth.currentUser.uid, votedForUid);
            }
        });

        // Return to Lobby Screen after game over
        returnToLobbyBtn.addEventListener('click', () => {
            // Host should delete the lobby doc to clean up
            // if (isHost) deleteDoc(...)
            setActiveScreen(lobbyScreen);
            // setupLobbyListener('');
        });

        // Leaving game
        leaveGameBtn.addEventListener('click', async () => {
             const confirmed = await showCustomConfirm("خروج از بازی باعث ثبت شکست برای شما می‌شود. آیا مطمئن هستید؟");
             if(confirmed) {
                // Handle leaving logic - for simplicity, we treat it as a loss and remove the player.
                // In a real app, the host leaving would end the game for everyone.
             }
        });


        // --- Initialize the app ---
        window.onload = initializeFirebaseAndAuth; // This should be your original function

        // A placeholder for the original auth/init function
        function initializeFirebaseAndAuth() {
            // All your original code from here
            console.log("App Initialized");
        }
    </script>
</body>
</html>