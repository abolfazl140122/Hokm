<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out;
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%);
            border: 4px solid #DAA520;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            max-height: 90vh;
            overflow-y: auto; /* Changed to auto for scrollable content */
            overflow-x: hidden;
        }
        .classic-card::before { content: ''; position: absolute; top: -10px; left: -10px; width: 30px; height: 30px; border-top: 5px solid #FFD700; border-left: 5px solid #FFD700; border-radius: 5px 0 0 0; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .classic-card::after { content: ''; position: absolute; bottom: -10px; right: -10px; width: 30px; height: 30px; border-bottom: 5px solid #FFD700; border-right: 5px solid #FFD700; border-radius: 0 0 5px 0; box-shadow: 0 0 10px rgba(255,215,0,0.5); }


        /* Button Base Styles */
        .classic-btn { border: 2px solid #DAA520; border-radius: 15px; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); color: #FFFFFF; padding: 0.875rem 1.5rem; font-size: 1.125rem; position: relative; overflow: hidden; }
        .classic-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255,255,255,0.1); transform: skewX(-30deg); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .classic-btn:hover::before { left: 100%; }
        .classic-btn:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); }
        .classic-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); }
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }

        /* Input Field Styles */
        input { background-color: #202020; border: 2px solid #5A5A5A; color: #E0E0E0; padding: 0.875rem; border-radius: 0.75rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        input::placeholder { color: #A0A0A0; }
        input:focus { border-color: #DAA520 !important; box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; }

        /* Header & Footer Styles */
        .app-header, .lobby-header { background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); height: 70px; position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 0.75rem 1rem; display: flex; align-items: center; }
        .app-header { justify-content: space-between; }
        .lobby-header { justify-content: center; }
        .lobby-header .search-container { display: flex; flex-grow: 1; max-width: 600px; margin: 0 auto; align-items: center; background-color: #303030; border-radius: 15px; border: 2px solid #5A5A5A; padding: 0.5rem 1rem; }
        .lobby-header .search-container input { flex-grow: 1; background-color: transparent; border: none; padding: 0.25rem 0.5rem; outline: none; text-align: right; }
        .lobby-header .search-container svg { color: #DAA520; min-width: 24px; min-height: 24px; }
        .lobby-header .search-container button { background: none; border: none; cursor: pointer; padding: 0 0.5rem; }

        .app-footer, .lobby-footer { background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); height: 90px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding: 1rem; display: flex; justify-content: space-around; align-items: center; }
        .lobby-footer .icon-btn { display: flex; flex-direction: column; align-items: center; color: #FFD700; font-size: 0.8rem; text-align: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        .lobby-footer .icon-btn:hover { transform: translateY(-5px); }
        .lobby-footer .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .lobby-footer .icon-btn svg { width: 30px; height: 30px; margin-bottom: 5px; transition: transform 0.8s ease-in-out; }
        .lobby-footer .games-running-text { color: #E0E0E0; font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* Main content area */
        .main-content-area { padding-top: 70px; padding-bottom: 90px; flex-grow: 1; overflow-y: auto; width: 100%; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        
        /* Modal Styles */
        .profile-modal-overlay { background-color: rgba(0,0,0,0.7); transition: opacity 0.3s ease-in-out; }
        .profile-modal-content { transform: translateY(-20px); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .profile-modal-enter-active .profile-modal-content { transform: translateY(0); }
        .profile-modal-leave-active .profile-modal-content { transform: translateY(-20px); opacity: 0; }

        /* Lobby Item & Detail Styles */
        .lobby-item { background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%); border: 2px solid #DAA520; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; overflow: hidden; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .lobby-detail-screen-full { display: flex; flex-direction: column; width: 100%; height: 100%; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        .lobby-detail-content { background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%); border: 3px solid #DAA520; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.7); padding: 1.5rem; width: 95%; max-width: 1200px; height: calc(100% - 100px); display: flex; gap: 1.5rem; margin: 50px auto; overflow: hidden; }
        .lobby-sidebar { display: flex; flex-direction: column; flex-shrink: 0; width: 300px; background-color: rgba(0,0,0,0.3); border-radius: 15px; padding: 1rem; border: 1px solid #444; overflow-y: auto; }
        .lobby-main-panel { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .player-list-item { background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: all 0.2s ease-in-out; }
        .player-list-item.is-host { border-color: #FFD700; }
        .lobby-chat-container { background-color: rgba(0,0,0,0.4); border: 2px solid #5A5A5A; border-radius: 10px; padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .lobby-chat-messages { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; display: flex; flex-direction: column; }
        .chat-message { background-color: #333; padding: 0.5rem 0.75rem; border-radius: 10px; margin-bottom: 0.5rem; max-width: 80%; word-wrap: break-word; align-self: flex-start; }
        .chat-message.current-user { background-color: #4682B4; align-self: flex-end; }
        .start-game-btn { background: linear-gradient(145deg, #228B22 0%, #006400 100%); border: 2px solid #DAA520; font-size: 1.1rem; padding: 0.6rem 1.2rem; }

        /* Custom Scrollbars */
        .lobby-sidebar::-webkit-scrollbar, #player-list-container::-webkit-scrollbar, .lobby-chat-messages::-webkit-scrollbar, .classic-card::-webkit-scrollbar { width: 8px; }
        .lobby-sidebar::-webkit-scrollbar-track, #player-list-container::-webkit-scrollbar-track, .lobby-chat-messages::-webkit-scrollbar-track, .classic-card::-webkit-scrollbar-track { background: #202020; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb, #player-list-container::-webkit-scrollbar-thumb, .lobby-chat-messages::-webkit-scrollbar-thumb, .classic-card::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .lobby-sidebar::-webkit-scrollbar-thumb:hover, #player-list-container::-webkit-scrollbar-thumb:hover, .lobby-chat-messages::-webkit-scrollbar-thumb:hover, .classic-card::-webkit-scrollbar-thumb:hover { background: #FFD700; }
        
        /* ============================================= */
        /*           GAME SCREEN & CARD STYLES           */
        /* ============================================= */
        #game-screen {
            background: radial-gradient(ellipse at bottom, #0a1809 0%, #010501 100%);
        }

        .player-area .player-info {
             transition: all 0.3s ease-in-out;
        }
        .player-area .player-info.is-turn {
            border-color: #FFD700;
            box-shadow: 0 0 15px #FFD700;
            transform: scale(1.05);
        }

        .card {
            width: 70px;
            height: 100px;
            border-radius: 8px;
            border: 2px solid #bbb;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.7);
            background-color: #fff;
            background-size: 90%;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding: 4px;
        }

        .card-vertical {
            width: 100px;
            height: 70px;
            padding: 2px 4px;
        }

        .card.face-down {
            background-color: #400;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 140"><rect width="100" height="140" fill="%23800000"/><path d="M20 20 Q50 60 80 20 L 80 120 Q 50 80 20 120 Z" fill="%23DAA520" stroke="black" stroke-width="2" /></svg>');
            background-size: 60%;
            font-size: 0; /* Hide text content */
        }

        /* Card suits and colors */
        .card.spades, .card.clubs { color: #222; }
        .card.hearts, .card.diamonds { color: #A00; }
        .card::after {
            position: absolute;
            bottom: 4px;
            left: 4px;
            font-size: 20px;
        }
        .card.spades::after { content: '♠'; }
        .card.hearts::after { content: '♥'; }
        .card.diamonds::after { content: '♦'; }
        .card.clubs::after { content: '♣'; }

        /* Player Hand (Bottom) Interactivity */
        #player-hand-bottom .card { cursor: pointer; }
        #player-hand-bottom .card:hover {
            transform: translateY(-20px) scale(1.1);
            z-index: 100;
        }

        #player-hand-bottom .card.playable {
            border-color: #FFD700;
            box-shadow: 0 0 15px #FFD700;
        }
        #player-hand-bottom .card.playable:hover {
            border-color: #fff;
            transform: translateY(-25px) scale(1.15);
        }

        #player-hand-bottom .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        #player-hand-bottom .card.disabled:hover { transform: none; }

        /* Card in Trick Area */
        #trick-area .card {
            position: absolute;
            transition: all 0.5s ease-out;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        #trick-area .card-bottom { top: 60%; left: 50%; transform: translate(-50%, -50%); }
        #trick-area .card-top { top: 20%; left: 50%; transform: translate(-50%, -50%); }
        #trick-area .card-right { top: 40%; left: 70%; transform: translate(-50%, -50%) rotate(90deg); }
        #trick-area .card-left { top: 40%; left: 30%; transform: translate(-50%, -50%) rotate(-90deg); }

        /* Choose Trump Suit Modal Content */
        #game-overlay-message {
            transition: opacity 0.3s ease-in-out;
        }
        #choose-trump-container .suit-btn {
            font-size: 4rem;
            padding: 1.5rem;
            border: 4px solid transparent;
            border-radius: 20px;
            transition: all 0.2s ease-in-out;
            background-color: rgba(0,0,0,0.3);
        }
        #choose-trump-container .suit-btn:hover {
            background-color: rgba(255,215,0,0.2);
            border-color: #FFD700;
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div><input type="email" id="email" placeholder="ایمیل شما" class="w-full focus:outline-none" required></div>
                    <div id="display-name-field" class="hidden"><input type="text" id="display-name" placeholder="نام نمایشی (در بازی)" class="w-full focus:outline-none"></div>
                    <div><input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="w-full focus:outline-none" required></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl">ورود</button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl">ثبت نام</button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic text-xl hidden">ادامه</button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="app-header">
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700/50" title="مشاهده پروفایل">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-300"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-700/50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </header>
            <div class="main-content-area">
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>
            <footer class="app-footer">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic text-lg w-1/2 mx-2">بازی دوستانه</button>
                <button id="rated-game-btn" class="classic-btn btn-brown-classic text-lg w-1/2 mx-2">بازی امتیازی</button>
            </footer>
        </div>

        <!-- 4. Lobby Screen -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی یا سازنده" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></button>
                </div>
            </header>
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div id="lobbies-list" class="space-y-3 w-full max-w-2xl mx-auto">
                    <p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>
                </div>
            </div>
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg><span>ایجاد</span></button>
                <button id="refresh-lobbies-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg><span>بروزرسانی</span></button>
                <button id="quick-join-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>ورود سریع</span></button>
                <div class="games-running-text"><span id="active-games-count">0</span><span>بازی در حال اجرا</span></div>
            </footer>
        </div>

        <!-- 8. Lobby Detail Screen -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    <div class="w-full h-px bg-yellow-600 mb-4"></div>
                    <div id="player-list-container"></div>
                </div>
                <div class="lobby-main-panel">
                    <div class="lobby-chat-container">
                        <div id="lobby-chat-messages" class="lobby-chat-messages"></div>
                        <form id="lobby-chat-form" class="flex gap-2 mt-2"><input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off" class="w-full"><button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button></form>
                    </div>
                    <div class="flex-shrink-0 mt-4 flex flex-wrap justify-between items-center gap-4">
                        <div id="host-actions-container" class="flex flex-wrap gap-4" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled>شروع بازی</button>
                            <button id="toggle-chat-lock-btn" class="classic-btn btn-gray-classic text-sm py-2 px-4">قفل کردن چت</button>
                        </div>
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک لابی</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- 9. GAME SCREEN (هسته اصلی بازی)             -->
        <!-- ============================================= -->
        <div id="game-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="relative w-full h-full max-w-screen-xl mx-auto flex items-center justify-center p-2 sm:p-4">
        
                <!-- Game Info Overlays -->
                <div id="game-info-top-left" class="absolute top-2 left-2 text-left bg-black bg-opacity-60 p-3 rounded-xl border-2 border-yellow-600 shadow-lg z-10">
                    <h3 class="text-lg font-bold text-yellow-300">امتیازها</h3>
                    <p class="text-sm text-gray-200">تیم شما: <span id="game-score-us" class="font-bold text-xl">0</span></p>
                    <p class="text-sm text-gray-200">تیم حریف: <span id="game-score-them" class="font-bold text-xl">0</span></p>
                </div>
        
                <div id="game-info-top-right" class="absolute top-2 right-2 text-right bg-black bg-opacity-60 p-3 rounded-xl border-2 border-yellow-600 shadow-lg z-10">
                    <h3 class="text-lg font-bold text-yellow-300">حکم: <span id="game-trump-suit" class="text-2xl align-middle">⏳</span></h3>
                    <p class="text-sm text-gray-200">حاکم: <span id="game-hakem-name" class="font-bold">---</span></p>
                </div>
        
                <!-- Game Table -->
                <div id="game-table" class="relative w-[65vw] h-[55vh] max-w-2xl max-h-[400px] bg-green-900/80 border-8 border-yellow-800 rounded-full shadow-2xl flex items-center justify-center">
                    <div id="trick-area" class="relative w-full h-full">
                        <!-- Played cards will be positioned here absolutely by JS -->
                    </div>
                </div>
        
                <!-- Player Areas -->
                <div id="player-area-bottom" class="player-area absolute bottom-0 sm:bottom-2 w-full flex flex-col items-center" data-position="bottom">
                    <div id="player-hand-bottom" class="player-hand flex justify-center space-x-[-40px] sm:space-x-[-50px] mb-2"></div>
                    <div class="player-info bg-black bg-opacity-70 px-4 py-1 rounded-t-lg border-2 border-transparent">
                        <span id="player-name-bottom" class="text-lg font-bold text-white">شما</span>
                    </div>
                </div>
                
                <div id="player-area-top" class="player-area absolute top-0 sm:top-2 w-full flex flex-col items-center" data-position="top">
                    <div class="player-info bg-black bg-opacity-70 px-4 py-1 rounded-b-lg border-2 border-transparent">
                        <span id="player-name-top" class="text-lg font-bold text-white">بازیکن مقابل</span>
                    </div>
                    <div id="player-hand-top" class="player-hand flex justify-center space-x-[-40px] sm:space-x-[-50px] mt-2"></div>
                </div>
        
                <div id="player-area-right" class="player-area absolute right-0 sm:right-2 top-1/2 -translate-y-1/2 flex items-center" data-position="right">
                    <div id="player-hand-right" class="player-hand flex flex-col space-y-[-70px] sm:space-y-[-80px] mr-2"></div>
                    <div class="player-info bg-black bg-opacity-70 px-2 py-4 rounded-l-lg border-2 border-transparent [writing-mode:vertical-rl]">
                        <span id="player-name-right" class="text-lg font-bold text-white">یار حریف</span>
                    </div>
                </div>
        
                <div id="player-area-left" class="player-area absolute left-0 sm:left-2 top-1/2 -translate-y-1/2 flex items-center" data-position="left">
                    <div class="player-info bg-black bg-opacity-70 px-2 py-4 rounded-r-lg border-2 border-transparent [writing-mode:vertical-rl]">
                        <span id="player-name-left" class="text-lg font-bold text-white">یار شما</span>
                    </div>
                    <div id="player-hand-left" class="player-hand flex flex-col space-y-[-70px] sm:space-y-[-80px] ml-2"></div>
                </div>
                
                <!-- Center Overlay for messages (e.g., "Waiting for Hakem...") -->
                <div id="game-overlay-message" class="hidden absolute inset-0 bg-black/60 flex-col justify-center items-center z-20 text-center p-4">
                    <h2 id="game-overlay-title" class="text-4xl font-bold text-yellow-300 mb-4"></h2>
                    <div id="game-overlay-content" class="text-xl text-white"></div>
                </div>
            </div>
        </div>

        <!-- All Modals -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
             <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                 <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                 <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                 <div class="text-lg space-y-4 mb-8 text-white"><p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p><p><strong>ایمیل:</strong> <span id="profile-email">---</span></p><p><strong>شناسه کاربر:</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p></div>
                 <button id="profile-logout-btn" class="w-full classic-btn btn-red-classic text-xl">خروج از حساب</button>
             </div>
        </div>
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <form id="create-lobby-form" class="space-y-5">
                    <input type="text" id="new-lobby-name-input" placeholder="نام لابی شما" class="w-full" required>
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer"><input type="radio" name="lobby-type" value="public" class="sr-only" checked><span class="lobby-type-btn active">عمومی</span></label>
                        <label class="cursor-pointer"><input type="radio" name="lobby-type" value="private" class="sr-only"><span class="lobby-type-btn">خصوصی</span></label>
                    </div>
                    <div id="new-lobby-password-field" class="hidden"><input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)" class="w-full"></div>
                    <button type="submit" class="w-full mt-4 classic-btn btn-green-classic text-xl">ساخت لابی</button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>
         <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2>
                <p class="text-lg mb-6 text-white">لابی <span id="password-prompt-lobby-name" class="font-bold text-yellow-300"></span> نیاز به رمز عبور دارد.</p>
                <form id="enter-password-form" class="space-y-5">
                    <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید" class="w-full text-center" required>
                    <div class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen'),
            authScreen = document.getElementById('auth-screen'),
            mainScreen = document.getElementById('main-screen'),
            lobbyScreen = document.getElementById('lobby-screen'),
            lobbyDetailScreen = document.getElementById('lobby-detail-screen'),
            gameScreen = document.getElementById('game-screen');
        // Other elements
        const authForm = document.getElementById('auth-form'), emailInput = document.getElementById('email'), displayNameInput = document.getElementById('display-name'), displayNameField = document.getElementById('display-name-field'), passwordInput = document.getElementById('password'), loginToggleBtn = document.getElementById('login-toggle-btn'), registerToggleBtn = document.getElementById('register-toggle-btn'), submitAuthBtn = document.getElementById('submit-auth-btn'), messageBox = document.getElementById('message-box');
        const headerDisplayName = document.getElementById('header-display-name'), headerUserId = document.getElementById('header-user-id'), friendlyGameBtn = document.getElementById('friendly-game-btn');
        const lobbiesList = document.getElementById('lobbies-list'), addIconBtn = document.getElementById('add-icon-btn'), refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'), quickJoinBtn = document.getElementById('quick-join-btn');
        const profileModal = document.getElementById('profile-modal'), closeProfileModalBtn = document.getElementById('close-profile-modal-btn'), profileDisplayName = document.getElementById('profile-display-name'), profileEmail = document.getElementById('profile-email'), profileUid = document.getElementById('profile-uid'), profileLogoutBtn = document.getElementById('profile-logout-btn');
        const createLobbyModal = document.getElementById('create-lobby-modal'), closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'), createLobbyForm = document.getElementById('create-lobby-form');
        const detailLobbyName = document.getElementById('detail-lobby-name'), detailHostName = document.getElementById('detail-host-name'), playerListContainer = document.getElementById('player-list-container'), detailPlayerCount = document.getElementById('detail-player-count'), hostActionsContainer = document.getElementById('host-actions-container'), startGameBtn = document.getElementById('start-game-btn'), toggleChatLockBtn = document.getElementById('toggle-chat-lock-btn'), leaveLobbyBtn = document.getElementById('leave-lobby-btn'), lobbyChatMessages = document.getElementById('lobby-chat-messages'), lobbyChatForm = document.getElementById('lobby-chat-form'), lobbyChatInput = document.getElementById('lobby-chat-input');
        const customConfirmModal = document.getElementById('custom-confirm-modal'), confirmTitle = document.getElementById('confirm-title'), confirmMessage = document.getElementById('confirm-message'), confirmYesBtn = document.getElementById('confirm-yes-btn'), confirmNoBtn = document.getElementById('confirm-no-btn');
        const enterPasswordModal = document.getElementById('enter-password-modal'), passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name'), enterPasswordForm = document.getElementById('enter-password-form'), joinLobbyPasswordInput = document.getElementById('join-lobby-password-input'), submitJoinPasswordBtn = document.getElementById('submit-join-password-btn'), cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn'), passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // GAME SCREEN DOM Elements
        const gameTable = document.getElementById('game-table'), trickArea = document.getElementById('trick-area'), gameScoreUs = document.getElementById('game-score-us'), gameScoreThem = document.getElementById('game-score-them'), gameTrumpSuit = document.getElementById('game-trump-suit'), gameHakemName = document.getElementById('game-hakem-name'), gameOverlayMessage = document.getElementById('game-overlay-message'), gameOverlayTitle = document.getElementById('game-overlay-title'), gameOverlayContent = document.getElementById('game-overlay-content');

        // State variables
        let authMode = 'login', currentActiveScreen = loadingScreen, currentUserData = null, currentLobbyId = null, lobbyToJoin = null;
        let unsubscribeLobbies = null, unsubscribeLobbyDetail = null, unsubscribeGame = null;

        // --- Core Functions (UI, Auth, Listeners) ---
        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            currentActiveScreen.classList.remove('page-transition-visible');
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                newScreen.classList.remove('hidden');
                setTimeout(() => newScreen.classList.add('page-transition-visible'), 50);
                currentActiveScreen = newScreen;
            }, 600);
        }

        function showMessageBox(message, type = 'info') {
            const el = document.getElementById('message-box');
            el.textContent = message;
            el.className = 'mt-5 p-3.5 rounded-xl text-base text-center text-white'; // Reset classes
            const typeClasses = { error: 'bg-red-600', success: 'bg-green-600', info: 'bg-blue-600' };
            el.classList.add(typeClasses[type] || 'bg-blue-600');
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, `users/${user.uid}`);
                const userDocSnap = await getDoc(userDocRef);
                currentUserData = { uid: user.uid, email: user.email, displayName: userDocSnap.exists() ? userDocSnap.data().displayName : user.email.split('@')[0] };
                if (!userDocSnap.exists() && authMode === 'register' && displayNameInput.value.trim()) {
                    currentUserData.displayName = displayNameInput.value.trim();
                    await setDoc(userDocRef, { displayName: currentUserData.displayName, email: user.email });
                }
                headerDisplayName.textContent = currentUserData.displayName;
                headerUserId.textContent = `شناسه: ${user.uid.substring(0, 8)}...`;
                setActiveScreen(mainScreen);
            } else {
                currentUserData = null;
                // Cleanup all listeners on logout
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                if (unsubscribeGame) unsubscribeGame();
                unsubscribeLobbies = unsubscribeLobbyDetail = unsubscribeGame = null;
                setActiveScreen(authScreen);
            }
        });

        // =============================================
        //        GAME LOGIC & STATE MANAGEMENT
        // =============================================

        // This listener is the main entry point into an active game.
        // It replaces the lobby detail listener once the game starts.
        function setupGameListener(gameId) {
            console.log(`[GAME] Attaching game listener for ID: ${gameId}`);
            if (unsubscribeGame) unsubscribeGame();
            
            const gameRef = doc(db, 'global_lobbies', gameId);
            unsubscribeGame = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) {
                    if (unsubscribeGame) unsubscribeGame();
                    setActiveScreen(lobbyScreen);
                    showMessageBox("بازی به پایان رسید یا میزبان خارج شد.", "info");
                    return;
                }
                const gameData = docSnap.data();
                if (gameData.gameState) {
                    renderGameState(gameData);
                } else if (gameData.status === 'starting' && gameData.hostId === auth.currentUser.uid) {
                    // ** SERVER LOGIC SIMULATION (HOST-SIDE) **
                    // In a real production app, this should be a Cloud Function triggered by status change.
                    // For this self-contained app, the host's client will set up the game.
                    console.log('[GAME] Host client is setting up the game...');
                    initializeNewGame(gameData, gameId);
                }
            });
        }

        // Draws the entire game UI based on the data from Firestore
        function renderGameState(gameData) {
            if (currentActiveScreen !== gameScreen) setActiveScreen(gameScreen);

            const gameState = gameData.gameState;
            const myUid = auth.currentUser.uid;
            
            // Find current player's info and their relative position
            const myPlayerInfo = gameState.playerSetup.find(p => p.uid === myUid);
            if (!myPlayerInfo) { console.error("Current user not found in playerSetup"); return; }
            
            const myPositionIndex = myPlayerInfo.positionIndex;
            const positions = ['bottom', 'left', 'top', 'right'];

            // Clear UI before re-rendering
            document.querySelectorAll('.player-hand').forEach(h => h.innerHTML = '');
            trickArea.innerHTML = '';

            // Render all player areas
            gameState.playerSetup.forEach(player => {
                const relativePositionIndex = (player.positionIndex - myPositionIndex + 4) % 4;
                const screenPosition = positions[relativePositionIndex];
                
                const handEl = document.getElementById(`player-hand-${screenPosition}`);
                const nameEl = document.getElementById(`player-name-${screenPosition}`);
                const infoEl = nameEl.parentElement;

                nameEl.textContent = player.displayName;
                infoEl.classList.toggle('is-turn', player.uid === gameState.turn);

                const isVertical = screenPosition === 'left' || screenPosition === 'right';
                const hand = gameState.hands[player.uid] || [];
                hand.forEach(cardCode => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    if(isVertical) cardDiv.classList.add('card-vertical');

                    if (player.uid !== myUid) {
                        cardDiv.classList.add('face-down');
                    } else {
                        const { suit, value } = parseCard(cardCode);
                        cardDiv.classList.add(suit);
                        cardDiv.textContent = value;
                        cardDiv.dataset.card = cardCode;
                        // TODO: Add playability logic
                        cardDiv.classList.add('playable');
                    }
                    handEl.appendChild(cardDiv);
                });
            });

            // Update score and game info panels
            const myTeam = myPlayerInfo.team;
            gameScoreUs.textContent = gameState.scores[`team${myTeam}`].totalScore;
            gameScoreThem.textContent = gameState.scores[`team${myTeam === 1 ? 2 : 1}`].totalScore;
            gameHakemName.textContent = gameState.playerSetup.find(p => p.uid === gameState.hakem)?.displayName || '---';
            gameTrumpSuit.textContent = gameState.trumpSuit ? {spades:'♠', hearts:'♥', diamonds:'♦', clubs:'♣'}[gameState.trumpSuit] : '⏳';
            
            // Handle game overlays (e.g., choosing trump)
            handleGameOverlay(gameState);
        }

        function handleGameOverlay(gameState) {
            gameOverlayMessage.classList.add('hidden');
            if (gameState.status === 'choosing_trump') {
                if (gameState.hakem === auth.currentUser.uid) {
                    gameOverlayTitle.textContent = "شما حاکم هستید!";
                    gameOverlayContent.innerHTML = `
                        <p class="mb-6">لطفاً حکم را انتخاب کنید:</p>
                        <div id="choose-trump-container" class="flex justify-center space-x-4 space-x-reverse">
                            <button class="suit-btn" data-suit="spades">♠</button>
                            <button class="suit-btn" data-suit="hearts">♥</button>
                            <button class="suit-btn" data-suit="diamonds">♦</button>
                            <button class="suit-btn" data-suit="clubs">♣</button>
                        </div>
                    `;
                    gameOverlayMessage.classList.remove('hidden');
                    // Add event listeners for suit buttons
                    document.getElementById('choose-trump-container').addEventListener('click', async (e) => {
                        const suit = e.target.closest('.suit-btn')?.dataset.suit;
                        if(suit) {
                            gameOverlayContent.innerHTML = `<p>حکم <strong>${suit}</strong> انتخاب شد.</p>`;
                            const gameRef = doc(db, 'global_lobbies', currentLobbyId);
                            // TODO: Add full 13-card deal logic
                            await updateDoc(gameRef, {
                                'gameState.trumpSuit': suit,
                                'gameState.status': 'playing' // Or 'dealing_rest'
                            });
                        }
                    });

                } else {
                    const hakemName = gameState.playerSetup.find(p => p.uid === gameState.hakem)?.displayName || 'حاکم';
                    gameOverlayTitle.textContent = "در انتظار حاکم...";
                    gameOverlayContent.innerHTML = `<p><strong>${hakemName}</strong> در حال انتخاب حکم است.</p>`;
                    gameOverlayMessage.classList.remove('hidden');
                }
            }
        }
        
        // ** SIMULATED SERVER LOGIC **
        // Called by the host's client to initialize the game state.
        async function initializeNewGame(lobbyData, lobbyId) {
            const playerUIDs = Object.keys(lobbyData.players);
            
            // 1. Create and shuffle the deck
            const suits = ['S', 'H', 'D', 'C'];
            const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14'];
            let deck = [];
            for (const suit of suits) {
                for (const value of values) {
                    deck.push(`${suit}${value}`);
                }
            }
            // Fisher-Yates shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }

            // 2. Set up players, teams, and positions
            const playerSetup = playerUIDs.map((uid, index) => ({
                uid,
                displayName: lobbyData.players[uid],
                team: (index % 2) + 1, // team 1 or 2
                positionIndex: index // 0=bottom, 1=left, 2=top, 3=right
            }));

            // 3. Deal first 5 cards
            const hands = {};
            playerUIDs.forEach(uid => { hands[uid] = []; });
            for (let i = 0; i < 5; i++) {
                for (const uid of playerUIDs) {
                    hands[uid].push(deck.pop());
                }
            }

            // 4. Create the initial gameState object
            const initialGameState = {
                playerSetup,
                hakem: lobbyData.hostId, // First hakem is the host
                turn: lobbyData.hostId, // First turn is hakem
                trumpSuit: null,
                hands,
                remainingDeck: deck, // Store the rest of the deck
                currentTrick: [],
                scores: {
                    team1: { roundsWon: 0, totalScore: 0 },
                    team2: { roundsWon: 0, totalScore: 0 }
                },
                lastEvent: null
            };

            // 5. Update the Firestore document
            const gameRef = doc(db, 'global_lobbies', lobbyId);
            try {
                await updateDoc(gameRef, {
                    status: 'choosing_trump',
                    gameState: initialGameState
                });
                console.log('[GAME] Game state initialized and written to Firestore.');
            } catch (error) {
                console.error("[GAME] Failed to initialize game state:", error);
                // Optionally, reset status back to 'waiting'
                await updateDoc(gameRef, { status: 'waiting' });
            }
        }
        
        // Helper to parse card codes e.g., "S14" -> { suit: 'spades', value: 'A' }
        function parseCard(cardCode) {
            const suitMap = { S: 'spades', H: 'hearts', D: 'diamonds', C: 'clubs' };
            const valueMap = { '14': 'A', '13': 'K', '12': 'Q', '11': 'J' };
            const suit = suitMap[cardCode.charAt(0)];
            const value = valueMap[cardCode.substring(1)] || cardCode.substring(1);
            return { suit, value };
        }
        
        // --- Lobby Functions (Modified for Game Integration) ---
        function setupLobbyDetailListener(lobbyId) {
            console.log(`[LOBBY] Attaching lobby listener for ID: ${lobbyId}`);
            if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
            if (unsubscribeGame) unsubscribeGame(); // Clean up any old game listener

            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            unsubscribeLobbyDetail = onSnapshot(lobbyRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showMessageBox("لابی بسته شد.", "info");
                    setActiveScreen(lobbyScreen);
                    return;
                }
                const lobbyData = docSnap.data();

                // ** INTEGRATION POINT **
                // If status is no longer 'waiting', we hand over to the game listener.
                if (lobbyData.status !== 'waiting') {
                    currentLobbyId = lobbyId;
                    if (unsubscribeLobbyDetail) unsubscribeLobbyDetail(); // Stop listening to lobby details
                    setupGameListener(lobbyId); // Start listening to the game state
                    return;
                }

                // --- Standard Lobby UI Rendering ---
                const playersMap = lobbyData.players || {};
                const playerCount = Object.keys(playersMap).length;
                detailLobbyName.textContent = lobbyData.name;
                detailHostName.textContent = `سازنده: ${playersMap[lobbyData.hostId] || 'ناشناس'}`;
                detailPlayerCount.textContent = `بازیکنان: ${playerCount}/4`;

                playerListContainer.innerHTML = '';
                Object.entries(playersMap).forEach(([uid, displayName]) => {
                    const isHost = uid === lobbyData.hostId;
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-list-item' + (isHost ? ' is-host' : '');
                    playerItem.innerHTML = `<span class="player-name">${displayName}${isHost ? ' (سازنده)' : ''}</span>`;
                    playerListContainer.appendChild(playerItem);
                });
                
                const isCurrentUserHost = auth.currentUser && lobbyData.hostId === auth.currentUser.uid;
                hostActionsContainer.style.display = isCurrentUserHost ? 'flex' : 'none';
                if(isCurrentUserHost) {
                    startGameBtn.disabled = playerCount !== 4;
                    startGameBtn.textContent = `شروع بازی (${playerCount}/4)`;
                }
                toggleChatLockBtn.textContent = lobbyData.isChatLocked ? 'باز کردن چت' : 'قفل کردن چت';
            });
        }
        
        async function joinLobby(lobbyId, password = null) {
            try {
                const lobbyRef = doc(db, 'global_lobbies', lobbyId);
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) throw new Error("لابی یافت نشد.");
                
                const lobbyData = lobbySnap.data();
                if(lobbyData.type === 'private' && lobbyData.password !== password) throw new Error("رمز عبور اشتباه است.");
                if (Object.keys(lobbyData.players || {}).length >= 4) throw new Error("لابی پر است.");

                await updateDoc(lobbyRef, { [`players.${auth.currentUser.uid}`]: currentUserData.displayName });
                
                currentLobbyId = lobbyId;
                setActiveScreen(lobbyDetailScreen);
                setupLobbyDetailListener(lobbyId); // Attach the listener after joining
                if(enterPasswordModal.classList.contains('profile-modal-enter-active')) closeEnterPasswordModal();

            } catch (e) {
                console.error("Error joining lobby:", e);
                // Decide where to show the error message
                const msgBox = enterPasswordModal.classList.contains('profile-modal-enter-active') ? passwordPromptMessageBox : messageBox;
                msgBox.textContent = e.message;
                msgBox.classList.remove('hidden');
            }
        }
        
        // EVENT LISTENERS
        document.addEventListener('click', e => {
            const target = e.target;
            // Auth
            if(target.id === 'login-toggle-btn') { authMode='login'; submitAuthBtn.textContent='ورود'; displayNameField.classList.add('hidden'); submitAuthBtn.classList.remove('hidden'); loginToggleBtn.classList.add('hidden'); registerToggleBtn.classList.remove('hidden');}
            if(target.id === 'register-toggle-btn') { authMode='register'; submitAuthBtn.textContent='ثبت نام'; displayNameField.classList.remove('hidden'); submitAuthBtn.classList.remove('hidden'); registerToggleBtn.classList.add('hidden'); loginToggleBtn.classList.remove('hidden');}
            if(target.id === 'profile-logout-btn') signOut(auth);
            
            // Navigation & Modals
            if(target.id === 'friendly-game-btn') { setActiveScreen(lobbyScreen); if(!unsubscribeLobbies) unsubscribeLobbies = setupLobbyListener(); }
            if(target.id === 'back-to-main-btn') setActiveScreen(mainScreen);
            if(target.closest('#profile-summary') || target.id === 'menu-btn') profileModal.classList.remove('hidden');
            if(target.id === 'close-profile-modal-btn' || target.id === 'profile-modal') profileModal.classList.add('hidden');
            if(target.id === 'add-icon-btn') createLobbyModal.classList.remove('hidden');
            if(target.id === 'close-create-lobby-modal-btn' || target.id === 'create-lobby-modal') createLobbyModal.classList.add('hidden');
            if(target.id === 'cancel-join-password-btn' || target.id === 'enter-password-modal') closeEnterPasswordModal();
            
            // Lobby List actions
            const joinBtn = target.closest('.join-lobby-btn');
            if(joinBtn) {
                 if(joinBtn.dataset.lobbyType === 'private') openEnterPasswordModal(joinBtn.dataset.lobbyId, joinBtn.dataset.lobbyName);
                 else joinLobby(joinBtn.dataset.lobbyId);
            }
            if(target.closest('.view-my-lobby-btn')) { currentLobbyId = target.closest('[data-lobby-id]').dataset.lobbyId; setActiveScreen(lobbyDetailScreen); setupLobbyDetailListener(currentLobbyId); }

            // Lobby Detail actions
            if (target.id === 'leave-lobby-btn') leaveLobby();
            if (target.id === 'start-game-btn') {
                startGameBtn.disabled = true;
                startGameBtn.textContent = "در حال شروع...";
                updateDoc(doc(db, 'global_lobbies', currentLobbyId), { status: "starting" });
            }
        });

        // Form submissions
        authForm.addEventListener('submit', async e => {
            e.preventDefault();
            try {
                if(authMode === 'login') await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                else await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) { showMessageBox(error.message, 'error'); }
        });

        createLobbyForm.addEventListener('submit', async e => {
            e.preventDefault();
            try {
                const lobbyName = document.getElementById('new-lobby-name-input').value.trim();
                const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
                const password = document.getElementById('new-lobby-password-input').value;
                if (!lobbyName) throw new Error("نام لابی الزامی است.");
                if (lobbyType === 'private' && password.length < 4) throw new Error("رمز عبور باید حداقل 4 کاراکتر باشد.");

                const newLobbyData = { name: lobbyName, hostId: auth.currentUser.uid, status: "waiting", type: lobbyType, players: { [auth.currentUser.uid]: currentUserData.displayName }, createdAt: serverTimestamp(), isChatLocked: false };
                if (lobbyType === 'private') newLobbyData.password = password;
                
                const newLobbyRef = await addDoc(collection(db, 'global_lobbies'), newLobbyData);
                
                currentLobbyId = newLobbyRef.id;
                createLobbyModal.classList.add('hidden');
                setActiveScreen(lobbyDetailScreen);
                setupLobbyDetailListener(currentLobbyId);

            } catch(error) { showMessageBox(error.message, 'error'); }
        });
        
        enterPasswordForm.addEventListener('submit', e => {
            e.preventDefault();
            joinLobby(lobbyToJoin.id, joinLobbyPasswordInput.value);
        });
        
        // Simplified functions for listeners and modals
        function setupLobbyListener() {
            if (unsubscribeLobbies) unsubscribeLobbies();
            const q = query(collection(db, 'global_lobbies'), where("status", "==", "waiting"));
            return onSnapshot(q, snapshot => {
                lobbiesList.innerHTML = '';
                if (snapshot.empty) {
                    lobbiesList.innerHTML = '<p class="text-gray-400">هیچ لابی فعالی یافت نشد.</p>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const lobby = { id: doc.id, ...doc.data() };
                    const playerCount = Object.keys(lobby.players || {}).length;
                    const isMyLobby = lobby.hostId === auth.currentUser?.uid;
                    const canJoin = playerCount < 4;
                    const lobbyItem = document.createElement('div');
                    lobbyItem.className = 'lobby-item';
                    lobbyItem.dataset.lobbyId = lobby.id;
                    lobbyItem.innerHTML = `
                        <div class="text-right">
                            <h3 class="text-xl font-bold">${lobby.type === 'private' ? '🔒 ' : ''}${lobby.name}</h3>
                            <p class="text-sm">سازنده: ${Object.values(lobby.players)[0]} | بازیکنان: ${playerCount}/4</p>
                        </div>
                        <button class="${isMyLobby ? 'view-my-lobby-btn btn-blue-classic' : 'join-lobby-btn btn-green-classic'}" 
                                data-lobby-id="${lobby.id}" data-lobby-type="${lobby.type}" data-lobby-name="${lobby.name}" 
                                ${!canJoin && !isMyLobby ? 'disabled' : ''}>
                                ${isMyLobby ? 'ورود به لابی من' : (canJoin ? 'ورود' : 'پر است')}
                        </button>
                    `;
                    lobbiesList.appendChild(lobbyItem);
                });
            });
        }
        function openEnterPasswordModal(id, name) {
            lobbyToJoin = { id, name };
            passwordPromptLobbyName.textContent = name;
            enterPasswordModal.classList.remove('hidden');
        }
        function closeEnterPasswordModal() { enterPasswordModal.classList.add('hidden'); }
        
        async function leaveLobby() {
            if(!currentLobbyId || !auth.currentUser) return;
            const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
            const lobbySnap = await getDoc(lobbyRef);
            if(!lobbySnap.exists()) return;

            if(lobbySnap.data().hostId === auth.currentUser.uid) {
                // Host leaves, delete lobby
                await deleteDoc(lobbyRef);
            } else {
                // Player leaves, remove from players map
                await updateDoc(lobbyRef, { [`players.${auth.currentUser.uid}`]: deleteField() });
            }
            setActiveScreen(lobbyScreen);
        }

    </script>
</body>
</html>
