<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی هوش مصنوعی کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts (Unchanged) */
        html, body, #app { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Merriweather', serif; background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); color: #E0E0E0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        h1, h2 { font-family: 'Playfair Display', serif; color: #FFD700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #DAA520; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-refresh { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .is-refreshing { animation: spin-refresh 0.8s ease-in-out; }
        .page-transition-active { transition: opacity 0.6s ease-in-out; }
        .page-transition-hidden { opacity: 0; }
        .page-transition-visible { opacity: 1; }

        /* Classic Card/Modal Styling (Unchanged) */
        .classic-card { background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); border: 4px solid #DAA520; border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); position: relative; max-height: 90vh; overflow-y: hidden; overflow-x: hidden; }
        .classic-card::before { content: ''; position: absolute; top: -10px; left: -10px; width: 30px; height: 30px; border-top: 5px solid #FFD700; border-left: 5px solid #FFD700; border-radius: 5px 0 0 0; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .classic-card::after { content: ''; position: absolute; bottom: -10px; right: -10px; width: 30px; height: 30px; border-bottom: 5px solid #FFD700; border-right: 5px solid #FFD700; border-radius: 0 0 5px 0; box-shadow: 0 0 10px rgba(255,215,0,0.5); }

        /* Button & Input Styles (Unchanged) */
        .classic-btn { border: 2px solid #DAA520; border-radius: 15px; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); color: #FFFFFF; padding: 0.875rem 1.5rem; font-size: 1.125rem; position: relative; overflow: hidden; }
        .classic-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255,255,255,0.1); transform: skewX(-30deg); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .classic-btn:hover::before { left: 100%; }
        .classic-btn:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); }
        .classic-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); }
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        input, select { background-color: #202020; border: 2px solid #5A5A5A; color: #E0E0E0; padding: 0.875rem; border-radius: 0.75rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        input::placeholder { color: #A0A0A0; }
        input:focus, select:focus { border-color: #DAA520 !important; box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important; outline: none; }
        
        /* Layout & Lobby Styles (Mostly Unchanged) */
        .app-header, .lobby-header { position: fixed; top: 0; left: 0; right: 0; z-index: 40; height: 70px; background: linear-gradient(to right, #4A2B00, #7A4C00, #4A2B00); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between; }
        .lobby-header { justify-content: center; }
        .app-footer, .lobby-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; height: 90px; background: linear-gradient(to left, #4A2B00, #7A4C00, #4A2B00); border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); padding: 1rem; display: flex; align-items: center; justify-content: space-around; }
        .main-content-area { padding-top: 70px; padding-bottom: 90px; flex-grow: 1; overflow-y: auto; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .lobby-detail-screen-full, .lobby-detail-content, .lobby-sidebar, .lobby-main-panel { /* ... existing styles ... */ }
        .player-list-item, .lobby-chat-container, .lobby-chat-messages, .chat-message { /* ... existing styles ... */ }

        /* === NEW: Game Screen & Countdown Styles === */
        #game-screen {
            background: radial-gradient(ellipse at bottom, #0a0a1a 0%, #000000 100%); /* Dark blue/black theme */
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 70px 1rem 1rem 1rem; /* Adjusted padding */
        }
        
        /* Countdown Overlay */
        #countdown-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease-out;
        }
        #countdown-timer {
            font-family: 'Playfair Display', serif;
            font-size: 15rem;
            color: #FFD700;
            text-shadow: 0 0 30px #FFD700, 0 0 60px #DAA520;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* Game Header (for timer and role) */
        .game-header {
            background: linear-gradient(to right, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            border-bottom: 3px solid #0f3460;
        }

        #game-timer-display, #my-role-display {
            color: #E0E0E0;
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #my-role-display span {
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
        }
        .role-human { background-color: #4682B4; color: white; }
        .role-ai { background-color: #B22222; color: white; }
        
        /* Main Game Content Area */
        .game-content-area {
            display: flex;
            flex-grow: 1;
            gap: 1.5rem;
            overflow: hidden;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Player list during the game */
        .game-player-list-container {
            flex-shrink: 0;
            width: 300px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 1rem;
            border: 1px solid #0f3460;
            overflow-y: auto;
        }
        .game-player-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .game-player-item.ejected {
            opacity: 0.4;
            background-color: #333;
            text-decoration: line-through;
        }
        .vote-btn {
            background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%);
            border: 1px solid #DAA520;
            color: white;
            border-radius: 5px;
            padding: 0.3rem 0.8rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .vote-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(218, 165, 32, 0.7);
        }
        .vote-btn:disabled {
            background: #555;
            border-color: #777;
            cursor: not-allowed;
        }

        /* Chat area during game (re-uses lobby chat styles) */
        .game-chat-panel {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
        }
        
        /* NEW: Game Over Modal */
        #game-over-modal {
            background-color: rgba(0,0,0,0.8);
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <!-- 2. Authentication Screen -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div><input type="email" id="email" placeholder="ایمیل شما" class="w-full focus:outline-none" required></div>
                    <div id="display-name-field" class="hidden"><input type="text" id="display-name" placeholder="نام نمایشی (در بازی)" class="w-full focus:outline-none"></div>
                    <div><input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="w-full focus:outline-none" required></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">ورود</button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">ثبت نام</button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl hidden">ادامه</button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="app-header">
                 <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></button>
            </header>
            <div class="main-content-area justify-center">
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی هوش مصنوعی خوش آمدید!</h1>
                <p class="text-lg text-gray-300">برای شروع، یک لابی بسازید یا به لابی دوستانتان بپیوندید.</p>
            </div>
            <footer class="app-footer">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4">ورود به لابی‌ها</button>
                <button id="rated-game-btn" class="classic-btn btn-gray-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4" disabled>بازی امتیازی (به زودی)</button>
            </footer>
        </div>

        <!-- 4. Lobby Screen -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Lobby Screen Header is defined in CSS and reuses .app-header -->
            <header class="lobby-header">
                <!-- ... header content with back button and search bar ... -->
            </header>
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full"><p class="text-gray-400">در حال بارگذاری لابی‌ها...</p></div>
                </div>
            </div>
            <!-- Lobby Screen Footer is defined in CSS and reuses .app-footer -->
            <footer class="lobby-footer">
                <!-- ... footer content with create, refresh, etc. buttons ... -->
            </footer>
        </div>

        <!-- 5. Profile Modal (Unchanged) -->
        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50">
            <!-- ... modal content ... -->
        </div>

        <!-- 6. Create Lobby Modal (MODIFIED) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <form id="create-lobby-form" class="space-y-5">
                    <div><input type="text" id="new-lobby-name-input" placeholder="نام لابی شما" class="w-full focus:outline-none" required></div>
                    
                    <!-- NEW: Game Duration Setting -->
                    <div>
                        <label for="game-duration-select" class="block text-white text-right mb-2">زمان بحث و گفتگو:</label>
                        <select id="game-duration-select" class="w-full focus:outline-none">
                            <option value="180">۳ دقیقه</option>
                            <option value="300" selected>۵ دقیقه</option>
                            <option value="420">۷ دقیقه</option>
                            <option value="600">۱۰ دقیقه</option>
                        </select>
                    </div>

                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                         <!-- ... public/private toggle ... -->
                    </div>
                    <div id="new-lobby-password-field" class="hidden relative">
                         <!-- ... password input ... -->
                    </div>
                    <button type="submit" id="submit-create-lobby-btn" class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">ساخت لابی</button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Lobby Detail Screen (Unchanged Structure) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden">
             <!-- ... lobby detail content ... -->
        </div>

        <!-- 8. Game Screen (COMPLETELY REDESIGNED) -->
        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <!-- Countdown Overlay -->
            <div id="countdown-overlay" class="hidden">
                <div id="countdown-timer">5</div>
            </div>

            <!-- Game Header -->
            <header class="game-header">
                <div id="my-role-display">
                    <!-- Role will be injected by JS -->
                </div>
                <div id="game-timer-display">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span>--:--</span>
                </div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی</button>
            </header>

            <!-- Main Game Content -->
            <div class="game-content-area">
                <!-- Player List Panel -->
                <div class="game-player-list-container">
                    <h3 class="text-xl font-bold text-yellow-200 mb-4">بازیکنان حاضر</h3>
                    <div id="game-player-list">
                        <!-- Player items will be injected by JS -->
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="game-chat-panel">
                    <div class="lobby-chat-container">
                        <div id="game-chat-messages" class="lobby-chat-messages">
                             <div class="chat-message"><p>بحث و گفتگو آغاز شد. هوش مصنوعی را شناسایی کنید.</p></div>
                        </div>
                        <form id="game-chat-form" class="lobby-chat-input-form">
                            <input type="text" id="game-chat-input" placeholder="پیام خود را به سبک ادبی وارد کنید..." autocomplete="off">
                            <button type="submit" id="game-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9. Game Over Modal (NEW) -->
        <div id="game-over-modal" class="hidden fixed inset-0 flex justify-center items-center z-50">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-lg text-center relative">
                <h2 id="game-over-title" class="text-3xl sm:text-4xl font-bold mb-4">بازی تمام شد!</h2>
                <p id="game-over-reason" class="text-xl mb-6 text-white">---</p>
                <p class="text-lg mb-8 text-yellow-300">هوش مصنوعی <span id="game-over-ai-name" class="font-bold"></span> بود.</p>
                <button id="return-to-lobby-btn" class="w-full classic-btn btn-blue-classic">بازگشت به لابی‌ها</button>
            </div>
        </div>
        
        <!-- Other modals like confirmation, kick player, etc. are unchanged -->
        <!-- These are omitted for brevity in this display, but are in the final code -->

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };
        // IMPORTANT: Replace with your own Gemini API key for production
        const geminiApiKey = "AIzaSyDfMZwyWNnRFUDLHKR1t_hZ5cWv2c_KvvE";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global Variables & DOM Elements ---
        const appId = 'default-app-id';
        const initialAuthToken = null;
        let currentActiveScreen = document.getElementById('loading-screen');
        let currentUserData = null;
        let unsubscribeLobbies = null;
        let unsubscribeLobbyDetail = null;
        let unsubscribeGame = null;
        let unsubscribeGameChat = null;
        let currentLobbyId = null;
        let gameTimerInterval = null;
        let isAuthResolved = false; // FIX: Flag to manage initial load

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        // ... (other common elements)
        const gameDurationSelect = document.getElementById('game-duration-select');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameScreen = document.getElementById('game-screen');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const myRoleDisplay = document.getElementById('my-role-display');
        const gameTimerDisplay = document.getElementById('game-timer-display');
        const gamePlayerList = document.getElementById('game-player-list');
        const gameChatMessages = document.getElementById('game-chat-messages');
        const gameChatForm = document.getElementById('game-chat-form');
        const gameChatInput = document.getElementById('game-chat-input');
        const gameChatSendBtn = document.getElementById('game-chat-send-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverTitle = document.getElementById('game-over-title');
        const gameOverReason = document.getElementById('game-over-reason');
        const gameOverAiName = document.getElementById('game-over-ai-name');
        const returnToLobbyBtn = document.getElementById('return-to-lobby-btn');

        // --- Utility Functions ---
        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            // Cleanup old listeners when changing major screens
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }
            if (unsubscribeGameChat) { unsubscribeGameChat(); unsubscribeGameChat = null; }
            if (gameTimerInterval) { clearInterval(gameTimerInterval); gameTimerInterval = null; }

            currentActiveScreen.classList.replace('page-transition-visible', 'page-transition-hidden');
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                newScreen.classList.remove('hidden');
                newScreen.classList.replace('page-transition-hidden', 'page-transition-visible');
                currentActiveScreen = newScreen;
            }, 600);
        }
        function showMessageBox(message, type = 'info') {
             const mb = document.getElementById('message-box');
             mb.textContent = message;
             mb.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
             if (type === 'error') mb.classList.add('bg-red-500', 'text-white');
             else mb.classList.add('bg-blue-500', 'text-white');
             mb.classList.remove('hidden');
             setTimeout(() => mb.classList.add('hidden'), 5000);
        }

        // --- Authentication ---
        // FIX: Restored robust initialization logic
        async function initializeAppAndAuth() {
            console.log("Initializing Firebase Auth...");
            if (initialAuthToken) {
                console.log("Initial auth token found. Signing in...");
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with initial token:", error);
                }
            } else {
                console.log("No initial auth token. Waiting for Firebase to resolve session.");
            }
            // onAuthStateChanged will handle the rest automatically.
        }

        onAuthStateChanged(auth, async (user) => {
            console.log("Auth state changed. User:", user ? user.uid : "none");
            if (user) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                const userDocSnap = await getDoc(userDocRef);
                currentUserData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: userDocSnap.exists() ? userDocSnap.data().displayName : 'کاربر'
                };
                if (currentActiveScreen === loadingScreen || currentActiveScreen === authScreen) {
                    setActiveScreen(mainScreen);
                }
            } else {
                currentUserData = null;
                // Only transition if coming from loading screen or not already on auth screen
                if (currentActiveScreen === loadingScreen) {
                    setActiveScreen(authScreen);
                }
            }
            isAuthResolved = true;
        });

        // --- Core Game Logic ---
        async function validateMessageStyleWithAI(messageText) {
            const prompt = `Analyze the following Persian sentence. Determine if its style is formal, literary, or similar to how an advanced AI would speak. Casual, slang, or very simple conversational styles are not acceptable. Your response MUST be a JSON object with two keys: {"isValid": boolean, "reason": string}. If the style is acceptable, set "isValid" to true and "reason" to an empty string. If not, set "isValid" to false and provide a very brief, helpful reason in Persian (e.g., "بیش از حد عامیانه است"). Sentence to analyze: "${messageText}"`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) return { isValid: false, reason: "خطا در ارتباط با سرور اعتبارسنجی." };
                const result = await response.json();
                const jsonString = result.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonString);
                return (typeof parsedJson.isValid === 'boolean') ? parsedJson : { isValid: false, reason: "پاسخ سرور نامعتبر بود." };
            } catch (error) {
                return { isValid: false, reason: `خطای شبکه: ${error.message}` };
            }
        }

        async function createLobby(lobbyName, userId, displayName, lobbyType, password, gameDuration) {
             // This function is mostly unchanged, but now includes gameDuration in gameSettings
             const newLobbyRef = await addDoc(collection(db, `global_lobbies`), {
                name: lobbyName, hostId: userId, status: "waiting", type: lobbyType,
                players: { [userId]: displayName }, kickedPlayers: [], createdAt: serverTimestamp(),
                gameSettings: { maxPlayers: 4, gameDurationSeconds: parseInt(gameDuration, 10) }
             });
             return newLobbyRef.id;
        }

        async function initializeGameInFirestore(lobbyId, lobbyData) {
            const playerUIDs = Object.keys(lobbyData.players);
            if (playerUIDs.length !== 4) throw new Error("برای شروع بازی به ۴ بازیکن نیاز است.");

            const aiIndex = Math.floor(Math.random() * playerUIDs.length);
            const roles = {};
            playerUIDs.forEach((uid, index) => { roles[uid] = (index === aiIndex) ? 'AI' : 'Human'; });

            const gameDuration = lobbyData.gameSettings.gameDurationSeconds;
            const endTime = new Date(Date.now() + gameDuration * 1000);

            const initialGameState = {
                phase: 'countdown', // countdown -> discussion -> voting -> ended
                roles: roles,
                players: lobbyData.players,
                alivePlayers: playerUIDs,
                timerEndTime: endTime,
                votes: {},
                winner: null,
            };

            const lobbyRef = doc(db, 'global_lobbies', lobbyId);
            await updateDoc(lobbyRef, { status: "playing", gameState: initialGameState });
            console.log(`Game state initialized for lobby ${lobbyId}`);
        }

        function setupGameListener(lobbyId) {
            console.log(`Listening to game state for lobby ID: ${lobbyId}`);
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }

            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            unsubscribeGame = onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().gameState) {
                    renderGameScreen(docSnap.data());
                } else {
                    if(gameTimerInterval) clearInterval(gameTimerInterval);
                    showMessageBox("بازی پایان یافت.", "info");
                    setActiveScreen(lobbyScreen);
                }
            });
            
            // Separate listener for game chat
            const messagesRef = collection(db, `global_lobbies/${lobbyId}/game_messages`);
            const q = query(messagesRef, orderBy("timestamp", "asc"));
            unsubscribeGameChat = onSnapshot(q, (snapshot) => {
                gameChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msgData = doc.data();
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'chat-message';
                    msgDiv.innerHTML = `<span class="sender-name">${msgData.senderName}</span><p>${msgData.text}</p>`;
                    gameChatMessages.appendChild(msgDiv);
                });
                gameChatMessages.scrollTop = gameChatMessages.scrollHeight;
            });
        }

        function renderGameScreen(lobbyData) {
            const gameState = lobbyData.gameState;
            const myUid = auth.currentUser.uid;
            const myRole = gameState.roles[myUid];
            const currentPhase = gameState.phase;

            if (currentPhase === 'countdown' && !document.getElementById('countdown-overlay').dataset.running) {
                countdownOverlay.classList.remove('hidden');
                countdownOverlay.dataset.running = 'true';
                let count = 5;
                countdownTimerEl.textContent = count;
                const cdInterval = setInterval(() => {
                    count--;
                    countdownTimerEl.textContent = count > 0 ? count : 'شروع!';
                    if (count < 0) {
                        clearInterval(cdInterval);
                        countdownOverlay.classList.add('hidden');
                        delete countdownOverlay.dataset.running;
                        if (lobbyData.hostId === myUid) {
                             updateDoc(doc(db, 'global_lobbies', currentLobbyId), { 'gameState.phase': 'discussion' });
                        }
                    }
                }, 1000);
            }

            myRoleDisplay.innerHTML = `نقش شما: <span class="role-${myRole.toLowerCase()}">${myRole === 'AI' ? 'هوش مصنوعی' : 'انسان'}</span>`;

            if (currentPhase === 'discussion' && !gameTimerInterval) {
                const endTime = gameState.timerEndTime.toDate();
                gameTimerInterval = setInterval(() => {
                    const remaining = Math.max(0, endTime - Date.now());
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    gameTimerDisplay.querySelector('span').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    if (remaining === 0) {
                        clearInterval(gameTimerInterval);
                        gameTimerInterval = null;
                        if (lobbyData.hostId === myUid) {
                             updateDoc(doc(db, 'global_lobbies', currentLobbyId), { 'gameState.phase': 'voting' });
                        }
                    }
                }, 1000);
            }
            
            gameChatInput.disabled = currentPhase !== 'discussion';
            gameChatSendBtn.disabled = currentPhase !== 'discussion';
            gameChatInput.placeholder = currentPhase === 'discussion' ? "پیام خود را به سبک ادبی وارد کنید..." : "زمان گفتگو تمام شده است.";
            
            gamePlayerList.innerHTML = '';
            Object.entries(gameState.players).forEach(([uid, name]) => {
                const isAlive = gameState.alivePlayers.includes(uid);
                const playerItem = document.createElement('div');
                playerItem.className = 'game-player-item' + (isAlive ? '' : ' ejected');
                
                const myVote = Object.values(gameState.votes || {}).flat().includes(myUid);
                let voteButton = (currentPhase === 'voting' && isAlive && uid !== myUid)
                    ? `<button class="vote-btn" data-vote-uid="${uid}" ${myVote ? 'disabled' : ''}>رأی</button>` : '';

                playerItem.innerHTML = `<span>${name} ${uid === myUid ? '(شما)' : ''}</span>${voteButton}`;
                gamePlayerList.appendChild(playerItem);
            });

            if (currentPhase === 'ended') {
                if(gameTimerInterval) clearInterval(gameTimerInterval);
                gameOverModal.classList.remove('hidden');
                const aiUid = Object.keys(gameState.roles).find(uid => gameState.roles[uid] === 'AI');
                gameOverAiName.textContent = gameState.players[aiUid];
                gameOverTitle.textContent = gameState.winner === 'Humans' ? "انسان‌ها پیروز شدند!" : "هوش مصنوعی پیروز شد!";
                gameOverReason.textContent = gameState.winner === 'Humans' ? "شما هوش مصنوعی را شناسایی کردید." : "هوش مصنوعی شما را فریب داد.";
            } else {
                gameOverModal.classList.add('hidden');
            }
        }
        
        async function sendGameChatMessage(text) {
            if (!text.trim() || !auth.currentUser || !currentLobbyId) return;
            gameChatSendBtn.disabled = true;
            gameChatInput.placeholder = "در حال اعتبارسنجی...";
            try {
                const validation = await validateMessageStyleWithAI(text);
                if (!validation.isValid) {
                    showMessageBox(`پیام ارسال نشد: ${validation.reason}`, 'error');
                    return;
                }
                await addDoc(collection(db, `global_lobbies/${currentLobbyId}/game_messages`), {
                    text: text.trim(), senderUid: auth.currentUser.uid,
                    senderName: currentUserData.displayName, timestamp: serverTimestamp()
                });
                gameChatInput.value = '';
            } finally {
                gameChatSendBtn.disabled = false;
                gameChatInput.placeholder = "پیام خود را به سبک ادبی وارد کنید...";
            }
        }

        async function castVote(votedForUid) {
            if (!currentLobbyId || !auth.currentUser) return;
            const myUid = auth.currentUser.uid;
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
            
            // This transaction is crucial for safely processing votes
            await runTransaction(db, async (transaction) => {
                const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
                const lobbySnap = await transaction.get(lobbyRef);
                if (!lobbySnap.exists()) throw "Lobby does not exist!";
                
                let gameState = lobbySnap.data().gameState;
                
                // Add vote
                let votes = gameState.votes || {};
                if (!votes[votedForUid]) votes[votedForUid] = [];
                votes[votedForUid].push(myUid);
                gameState.votes = votes;
                
                // Check if all alive players have voted
                const alivePlayersCount = gameState.alivePlayers.length;
                const totalVotes = Object.values(votes).flat().length;

                if (totalVotes >= alivePlayersCount) {
                    // All votes are in, process the result
                    let maxVotes = 0;
                    let ejectedPlayerUid = null;
                    for (const [player, voterList] of Object.entries(votes)) {
                        if (voterList.length > maxVotes) {
                            maxVotes = voterList.length;
                            ejectedPlayerUid = player;
                        } else if (voterList.length === maxVotes) {
                            ejectedPlayerUid = null; // Tie, no one is ejected
                        }
                    }

                    if (ejectedPlayerUid) {
                        gameState.alivePlayers = gameState.alivePlayers.filter(uid => uid !== ejectedPlayerUid);
                    }
                    
                    // Check for win conditions
                    const aiUid = Object.keys(gameState.roles).find(uid => gameState.roles[uid] === 'AI');
                    if (ejectedPlayerUid === aiUid) {
                        gameState.winner = 'Humans';
                        gameState.phase = 'ended';
                    } else if (gameState.alivePlayers.length <= 2) {
                        gameState.winner = 'AI';
                        gameState.phase = 'ended';
                    } else {
                        // Game continues, reset for next round (simplified)
                        gameState.phase = 'discussion';
                        gameState.votes = {};
                        // In a real game, you'd add a new timer
                    }
                }
                
                transaction.update(lobbyRef, { gameState: gameState });
            });
        }
        
        // --- Event Listeners ---
        // (Most auth and lobby list listeners are unchanged)
        
        // Modified Start Game button
        startGameBtn.addEventListener('click', async () => {
            if (currentLobbyId && auth.currentUser) {
                try {
                    const lobbyRef = doc(db, 'global_lobbies', currentLobbyId);
                    const lobbySnap = await getDoc(lobbyRef);
                    if (lobbySnap.exists()) {
                        await initializeGameInFirestore(currentLobbyId, lobbySnap.data());
                    }
                } catch (error) { showMessageBox(`خطا در شروع بازی: ${error.message}`, "error"); }
            }
        });
        
        // New Game Event Listeners
        gameChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendGameChatMessage(gameChatInput.value);
        });
        
        gamePlayerList.addEventListener('click', (e) => {
            if (e.target.matches('.vote-btn')) {
                castVote(e.target.dataset.voteUid);
            }
        });

        returnToLobbyBtn.addEventListener('click', () => {
             // Host should delete the lobby for cleanup
             if (currentLobbyId && currentUserData?.isHost) {
                 deleteDoc(doc(db, 'global_lobbies', currentLobbyId));
             }
             setActiveScreen(mainScreen); // Go to main screen first, then to lobby
             setTimeout(() => setActiveScreen(lobbyScreen), 600);
        });

        // Initialize the app
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>