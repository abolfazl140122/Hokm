<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حکم کلاسیک</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
        }
        body {
            font-family: 'Merriweather', serif; /* Default body font for readability */
            /* Deep, rich, slightly textured background for classic feel */
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); /* Darker, more intense background */
            color: #E0E0E0; /* Softer white text for elegance */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif; /* Elegant headings */
            color: #FFD700; /* Gold color for titles */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Subtle text shadow for depth */
        }

        /* Custom spinner for loading screen - Gold themed */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #DAA520; /* Gold spinner */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NEW: Animation for refresh button icon */
        @keyframes spin-refresh {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .is-refreshing {
            animation: spin-refresh 0.8s ease-in-out;
        }

        /* Page transition animation */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out; /* Slightly slower transition */
        }
        .page-transition-hidden {
            opacity: 0;
        }
        .page-transition-visible {
            opacity: 1;
        }

        /* Classic Card/Modal Styling - More detailed */
        .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%); /* Deeper ruby red velvet effect */
            border: 4px solid #DAA520; /* Goldenrod border */
            border-radius: 20px; /* Slightly larger radius */
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            backdrop-filter: blur(10px); /* Stronger blur for more prominent glass effect */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            position: relative; /* For pseudo-elements */
            max-height: 90vh; /* Ensure card doesn't overflow viewport */
            overflow-y: auto; /* Changed to auto for modals with more content */
            overflow-x: hidden; /* Ensure horizontal scrollbar is hidden for cards */
        }
        .classic-card::before { /* Top left ornamental corner */
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 30px;
            height: 30px;
            border-top: 5px solid #FFD700;
            border-left: 5px solid #FFD700;
            border-radius: 5px 0 0 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .classic-card::after { /* Bottom right ornamental corner */
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-bottom: 5px solid #FFD700;
            border-right: 5px solid #FFD700;
            border-radius: 0 0 5px 0;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        /* Button Base Styles - More polished Classic Look */
        .classic-btn {
            border: 2px solid #DAA520; /* Golden border for all buttons */
            border-radius: 15px; /* Slightly rounded corners */
            font-weight: 700; /* Bold text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Text shadow for elegance */
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother transition */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1); /* Deeper outer shadow, subtle inner light */
            color: #FFFFFF; /* White text on buttons */
            padding: 0.875rem 1.5rem; /* Equivalent to py-3.5 px-6 */
            font-size: 1.125rem; /* Equivalent to text-lg */
            position: relative; /* For pseudo-elements */
            overflow: hidden; /* To contain the hover overlay */
        }
        .classic-btn::before { /* Subtle light effect on hover */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-30deg);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .classic-btn:hover::before {
            left: 100%;
        }
        .classic-btn:hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift and scale */
            box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); /* Stronger shadow on hover */
        }
        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
        }

        /* Specific Button Colors - Classic Pallette */
        .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        .btn-gold-classic { background: linear-gradient(145deg, #FFD700 0%, #DAA520 100%); border: none; padding: 0.5rem; border-radius: 10px; }
        .btn-gold-classic:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3); }


        /* Input, Select, Textarea Field Styles - More refined Classic Look */
        input, select, textarea {
            background-color: #202020;
            border: 2px solid #5A5A5A;
            color: #E0E0E0;
            padding: 0.875rem;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            width: 100%;
        }
        input::placeholder, textarea::placeholder { color: #A0A0A0; }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #DAA520 !important;
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23DAA520' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 1rem; }
        textarea { resize: vertical; min-height: 80px; }
        .form-label { display: block; text-align: right; margin-bottom: 0.5rem; color: #FFD700; font-weight: bold; }


        /* Header specific styles - Richer Gold/Brown */
        .app-header { background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); height: 70px; position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
        .lobby-header { background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-bottom: 3px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.7); height: 70px; position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: center; }
        .lobby-header .search-container { display: flex; flex-grow: 1; max-width: 600px; margin: 0 auto; align-items: center; background-color: #303030; border-radius: 15px; border: 2px solid #5A5A5A; padding: 0.5rem 1rem; }
        .lobby-header .search-container input { flex-grow: 1; background-color: transparent; border: none; padding: 0.25rem 0.5rem; outline: none; text-align: right; }
        .lobby-header .search-container input::placeholder { color: #A0A0A0; }
        .lobby-header .search-container svg { color: #DAA520; min-width: 24px; min-height: 24px; }
        .lobby-header .search-container button { background: none; border: none; cursor: pointer; padding: 0 0.5rem; }


        .app-footer, .lobby-footer { background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%); border-top: 3px solid #FFD700; box-shadow: 0 -8px 20px rgba(0,0,0,0.7); height: 90px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding: 1rem; display: flex; justify-content: space-around; align-items: center; }
        .lobby-footer .icon-btn { display: flex; flex-direction: column; align-items: center; color: #FFD700; font-size: 0.8rem; text-align: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        .lobby-footer .icon-btn:hover { transform: translateY(-5px); }
        .lobby-footer .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .lobby-footer .icon-btn svg { width: 30px; height: 30px; margin-bottom: 5px; transition: transform 0.8s ease-in-out; }
        .lobby-footer .games-running-text { color: #E0E0E0; font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* Main content area padding */
        .main-content-area {
            padding-top: 70px; /* Header height */
            padding-bottom: 90px; /* Footer height */
            flex-grow: 1;
            overflow-y: auto; /* Changed to auto for scrollable lobby list */
            overflow-x: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%);
            position: relative;
        }
        
        /* Modal specific styles */
        .profile-modal-overlay { background-color: rgba(0,0,0,0.7); transition: opacity 0.3s ease-in-out; }
        .profile-modal-content { transform: translateY(-20px); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .profile-modal-enter-active .profile-modal-content { transform: translateY(0); }
        .profile-modal-leave-active .profile-modal-content { transform: translateY(-20px); opacity: 0; }

        /* Enhanced Lobby Item Styling */
        .lobby-item { background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%); border: 2px solid #DAA520; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; overflow: hidden; padding: 1.25rem 1.5rem; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; }
        .lobby-item:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 25px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,215,0,0.2); }
        .lobby-item h3 { font-size: 1.5rem; }
        .lobby-item p { color: #C0C0C0; font-size: 0.9rem; margin-top: 0.25rem; }
        .lobby-item .lobby-actions { margin-top: 1rem; display: flex; flex-direction: column; width: 100%; gap: 0.75rem; }
        .lobby-item .join-lobby-btn, .lobby-item .close-lobby-btn { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; }
        @media (min-width: 640px) {
            .lobby-item { flex-direction: row; text-align: right; }
            .lobby-item .lobby-actions { flex-direction: row; width: auto; margin-top: 0; gap: 0.5rem; }
            .lobby-item .close-lobby-btn { margin-right: 0.5rem; }
            .lobby-item .join-lobby-btn, .lobby-item .close-lobby-btn { width: auto; font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        }
        .lobby-lock-icon { width: 1.1rem; height: 1.1rem; margin-left: 0.5rem; color: #FFD700; display: inline-block; vertical-align: middle; }


        /* === Lobby Detail Screen Styles (Major Redesign) === */
        .lobby-detail-screen-full { padding-top: 0; padding-bottom: 0; display: flex; flex-direction: column; width: 100%; height: 100%; background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        .lobby-detail-content { background: linear-gradient(145deg, #1A1A1A 0%, #0D0D0D 100%); border: 3px solid #DAA520; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.7); padding: 1.5rem; width: 95%; max-width: 1200px; height: calc(100% - 100px); display: flex; flex-direction: row; gap: 1.5rem; margin: 50px auto; overflow: hidden; }
        .lobby-sidebar { display: flex; flex-direction: column; flex-shrink: 0; width: 300px; background-color: rgba(0,0,0,0.3); border-radius: 15px; padding: 1rem; border: 1px solid #444; overflow-y: auto; }
        .lobby-main-panel { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        
        /* NEW: Lobby Settings Display in Sidebar */
        #lobby-settings-display { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #DAA520; }
        #lobby-settings-display h3 { font-size: 1.25rem; margin-bottom: 0.75rem; }
        #lobby-settings-display p { font-size: 0.9rem; color: #E0E0E0; margin-bottom: 0.5rem; }
        #lobby-settings-display p strong { color: #FFD700; }
        
        #player-list-container { margin-top: 1rem; flex-grow: 1; overflow-y: auto; }
        .player-list-item { background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: all 0.2s ease-in-out; }
        .player-list-item.is-host { border-color: #FFD700; }
        .player-list-item .player-name { font-weight: bold; color: #E0E0E0; }
        .player-list-item .host-label { color: #FFD700; font-size: 0.8rem; margin-right: 0.5rem; }
        .kick-player-btn { background: none; border: 1px solid #B22222; color: #B22222; border-radius: 5px; padding: 0.2rem 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
        .kick-player-btn:hover { background: #B22222; color: white; }

        .lobby-chat-container { background-color: rgba(0,0,0,0.4); border: 2px solid #5A5A5A; border-radius: 10px; padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .lobby-chat-messages { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; display: flex; flex-direction: column; }
        .chat-message { background-color: #333; padding: 0.5rem 0.75rem; border-radius: 10px; margin-bottom: 0.5rem; max-width: 80%; word-wrap: break-word; align-self: flex-start; display: flex; align-items: center; gap: 0.5rem; }
        .chat-message.current-user { background-color: #4682B4; align-self: flex-end; flex-direction: row-reverse; }
        .chat-message-content { flex-grow: 1; }
        .chat-message .sender-name { font-weight: bold; color: #FFD700; display: block; font-size: 0.9em; margin-bottom: 0.2rem; }
        .chat-message .message-text-deleted { font-style: italic; color: #999; }
        .delete-message-btn { background: none; border: none; color: #aaa; cursor: pointer; padding: 0.25rem; opacity: 0.5; transition: all 0.2s ease; flex-shrink: 0; }
        .chat-message:hover .delete-message-btn { opacity: 1; }
        .delete-message-btn:hover { color: #ff6b6b; transform: scale(1.1); }
        .lobby-chat-input-form { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-shrink: 0; }
        .lobby-actions-footer { flex-shrink: 0; margin-top: 1rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
        .start-game-btn { background: linear-gradient(145deg, #228B22 0%, #006400 100%); border: 2px solid #DAA520; font-size: 1.1rem; padding: 0.6rem 1.2rem; }
        #host-actions-container { display: flex; flex-wrap: wrap; gap: 1rem; }

        /* Custom Scrollbars */
        .classic-card::-webkit-scrollbar, .lobby-sidebar::-webkit-scrollbar, #player-list-container::-webkit-scrollbar, .lobby-chat-messages::-webkit-scrollbar { width: 8px; }
        .classic-card::-webkit-scrollbar-track, .lobby-sidebar::-webkit-scrollbar-track, #player-list-container::-webkit-scrollbar-track, .lobby-chat-messages::-webkit-scrollbar-track { background: #202020; border-radius: 4px; }
        .classic-card::-webkit-scrollbar-thumb, .lobby-sidebar::-webkit-scrollbar-thumb, #player-list-container::-webkit-scrollbar-thumb, .lobby-chat-messages::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 4px; }
        .classic-card::-webkit-scrollbar-thumb:hover, .lobby-sidebar::-webkit-scrollbar-thumb:hover, #player-list-container::-webkit-scrollbar-thumb:hover, .lobby-chat-messages::-webkit-scrollbar-thumb:hover { background: #FFD700; }
        
        /* Responsive Styles */
        @media (max-width: 860px) {
            .lobby-detail-content { flex-direction: column; height: calc(100% - 80px); margin: 40px auto; padding: 1rem; overflow: hidden; }
            .lobby-sidebar { width: 100%; flex-shrink: 0; max-height: 250px; }
            .lobby-main-panel { flex-grow: 1; min-height: 0; }
        }
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header, .app-footer, .lobby-footer { padding: 0.5rem; }
            .app-header, .lobby-header { height: 60px; }
            .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; }
            .lobby-detail-content { margin: 20px auto; height: calc(100% - 40px); }
        }
        
        /* Lobby Type Toggle Styles */
        .lobby-type-btn { padding: 0.5rem 1.5rem; border: 2px solid #DAA520; border-radius: 10px; transition: all 0.2s ease-in-out; background-color: transparent; color: #DAA520; font-weight: bold; }
        .lobby-type-btn.active { background-color: #DAA520; color: #1A1A1A; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        
        /* Game Screen and Card Styles (unchanged) */
        #game-screen { background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%); transform-style: preserve-3d; perspective: 2000px; }
        #game-table { background: #6B4F35; background-image: radial-gradient(ellipse at center, rgba(160, 127, 92, 0.8) 0%, rgba(74, 51, 32, 0.9) 100%), repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px); border: 15px solid #4A3320; border-image-source: linear-gradient(145deg, #4A3320, #8C6F4F, #4A3320); border-image-slice: 1; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.85), inset 0 0 40px rgba(0,0,0,0.7); border-radius: 100px; transform-style: preserve-3d; position: relative; }
        .player-slot { transform-style: preserve-3d; }
        .player-area-container { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 12px; transition: all 0.3s ease-in-out; z-index: 10; }
        .player-avatar { width: 60px; height: 60px; background: linear-gradient(145deg, #333, #111); border: 3px solid #DAA520; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #FFD700; box-shadow: inset 0 3px 6px rgba(0,0,0,0.6), 0 2px 4px rgba(0,0,0,0.4); }
        .player-avatar svg { width: 32px; height: 32px; }
        .player-name-display { color: white; font-weight: bold; text-shadow: 2px 2px 3px #000; background: rgba(0,0,0,0.5); padding: 0.2rem 0.8rem; border-radius: 8px; }
        .player-slot.active-turn .player-area-container { transform: scale(1.1); background-color: rgba(255, 215, 0, 0.1); box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5); }
        .player-slot.active-turn .player-name-display { color: #FFD700; }
        .player-slot .player-hand { display: flex; perspective: 800px; }
        .card { width: 70px; height: 100px; background-color: white; border: 1px solid #333; border-radius: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; font-size: 24px; font-weight: bold; user-select: none; transition: all 0.2s ease-out; position: relative; }
        .card.back { background-image: linear-gradient(135deg, #4B0000, #800000); border: 2px solid #DAA520; }
        .card.red { color: #DC2626; } .card.black { color: #111827; } .card-rank { font-family: 'Playfair Display', serif; } .card-suit { font-size: 20px; } .card-suit.top { transform: rotate(0deg); } .card-suit.bottom { transform: rotate(180deg); }
        #player-slot-bottom .player-hand { gap: -35px; margin-top: -30px; } #player-slot-bottom .card:not(.back) { cursor: pointer; } #player-slot-bottom .card:not(.back):hover { transform: translateY(-20px) scale(1.05); z-index: 100; box-shadow: 0 12px 24px rgba(0,0,0,0.5); }
        #player-slot-left, #player-slot-right { display: flex; align-items: center; gap: 1.5rem; } #player-slot-right { flex-direction: row-reverse; } #player-slot-left .player-hand, #player-slot-right .player-hand { flex-direction: column; gap: -80px; }
        #player-slot-top .player-area-container { flex-direction: column-reverse; } #player-slot-top .player-hand { gap: -35px; margin-bottom: -30px; }
        #play-area { transform-style: preserve-3d; perspective: 1000px; } #play-area .card { position: absolute; transform: none; box-shadow: 0 8px 16px rgba(0,0,0,0.5); transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        #play-area .played-card-bottom { bottom: -50px; transform: translateY(0); } #play-area .played-card-left { left: -50px; transform: rotate(90deg) translateX(-50%) translateY(50%); transform-origin: center; } #play-area .played-card-top { top: -50px; transform: rotate(180deg); } #play-area .played-card-right { right: -50px; transform: rotate(-90deg) translateX(50%) translateY(50%); transform-origin: center; }
        #player-slot-bottom { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; } #player-slot-top { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center;} #player-slot-left { left: 40px; top: 50%; transform: translateY(-50%); } #player-slot-right { right: 40px; top: 50%; transform: translateY(-50%); }
        @media (max-width: 768px) { .card { width: 50px; height: 75px; font-size: 18px; border-radius: 4px; } .card-suit { font-size: 16px; } #player-slot-bottom .player-hand, #player-slot-top .player-hand { gap: -25px; } #player-slot-left .player-hand, #player-slot-right .player-hand { gap: -60px; } #player-slot-bottom { bottom: 10px; } #player-slot-top { top: 10px; } #player-slot-left { left: 10px; } #player-slot-right { right: 10px; } .player-avatar { width: 50px; height: 50px; } .player-avatar svg { width: 24px; height: 24px; } }
    </style>
</head>
<body>

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">
        <!-- All screens -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 page-transition-active page-transition-visible" tabindex="-1">
            <div class="spinner mb-4"></div>
            <p class="text-xl md:text-2xl font-semibold text-blue-400">در حال بارگذاری...</p>
        </div>

        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden" tabindex="-1">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div> <input type="email" id="email" placeholder="ایمیل شما" required> </div>
                    <div id="display-name-field" class="hidden"> <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"> </div>
                    <div> <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" required> </div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl"> ورود </button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl"> ثبت نام </button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl hidden"> ادامه </button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="app-header">
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg text-white">نام کاربری</span>
                        <span id="header-user-id" class="text-xs text-gray-300 break-all">ID: ---</span>
                    </div>
                </div>
                <button id="menu-btn" class="text-white text-3xl p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </header>
            <div class="main-content-area items-center justify-center">
                <h1 class="text-4xl text-yellow-300 font-bold mb-8">به بازی حکم خوش آمدید!</h1>
                <p class="text-lg text-gray-300">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>
            <footer class="app-footer">
                <button id="friendly-game-btn" class="classic-btn btn-purple-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4"> بازی دوستانه </button>
                <button id="rated-game-btn" class="classic-btn btn-brown-classic text-base sm:text-lg w-1/2 mx-2 py-3.5 px-4"> بازی امتیازی </button>
            </footer>
        </div>

        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden" tabindex="-1">
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده..." class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </button>
                </div>
            </header>
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-4xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg> <span>ایجاد</span> </button>
                <button id="refresh-lobbies-btn" class="icon-btn"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg> <span>بروزرسانی</span> </button>
                <button id="my-lobbies-btn" class="icon-btn"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> <span>لابی‌های من</span> </button>
                <div class="games-running-text"> <span id="active-games-count">0</span> <span>بازی در حال اجرا</span> </div>
            </footer>
        </div>

        <div id="profile-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                <button id="close-profile-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200"> <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg> </button>
                <div class="text-lg space-y-4 mb-8 text-white">
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm text-gray-400">---</span></p>
                </div>
                <button id="profile-logout-btn" class="w-full classic-btn btn-red-classic text-lg sm:text-xl"> خروج از حساب </button>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (WITH ADVANCED FEATURES) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-lg text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200"> <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg> </button>
                <form id="create-lobby-form" class="space-y-5 text-right">
                    <div>
                        <label for="new-lobby-name-input" class="form-label">نام لابی</label>
                        <input type="text" id="new-lobby-name-input" placeholder="نام لابی شما" required>
                    </div>
                    
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer"> <input type="radio" name="lobby-type" value="public" class="sr-only" checked> <span class="lobby-type-btn active">عمومی</span> </label>
                        <label class="cursor-pointer"> <input type="radio" name="lobby-type" value="private" class="sr-only"> <span class="lobby-type-btn">خصوصی</span> </label>
                    </div>
                    
                    <div id="new-lobby-password-field" class="hidden relative">
                        <label for="new-lobby-password-input" class="form-label">رمز عبور لابی</label>
                        <input type="password" id="new-lobby-password-input" placeholder="حداقل ۴ کاراکتر" class="pr-10">
                    </div>

                    <div class="w-full h-px bg-yellow-600 my-4 opacity-50"></div>
                    <h3 class="text-xl text-center text-yellow-300">تنظیمات پیشرفته</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-lobby-win-score" class="form-label">امتیاز پیروزی (دست)</label>
                            <select id="new-lobby-win-score">
                                <option value="5">5 دست</option>
                                <option value="7" selected>7 دست (استاندارد)</option>
                                <option value="10">10 دست</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-lobby-turn-timer" class="form-label">تایمر نوبت</label>
                            <select id="new-lobby-turn-timer">
                                <option value="0">بدون محدودیت</option>
                                <option value="15">15 ثانیه</option>
                                <option value="30" selected>30 ثانیه</option>
                                <option value="45">45 ثانیه</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="new-lobby-description" class="form-label">توضیحات لابی (اختیاری)</label>
                        <textarea id="new-lobby-description" placeholder="یک پیام خوشامدگویی یا قانون خاص بنویسید..."></textarea>
                    </div>
                    
                    <div class="flex items-center justify-start mt-2">
                        <input type="checkbox" id="new-lobby-shuffle-teams" class="w-auto h-5 accent-yellow-500 ml-3">
                        <label for="new-lobby-shuffle-teams" class="text-white cursor-pointer">بر زدن تیم‌ها قبل از شروع بازی</label>
                    </div>
        
                    <button type="submit" id="submit-create-lobby-btn" class="w-full mt-6 classic-btn btn-green-classic text-xl sm:text-2xl"> ساخت لابی </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8 text-white">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full" tabindex="-1">
            <div class="lobby-detail-content">
                <div class="lobby-sidebar">
                    <h2 id="detail-lobby-name" class="text-2xl sm:text-3xl font-bold text-yellow-300 truncate">نام لابی</h2>
                    <p id="detail-host-name" class="text-md text-gray-300 mt-2">سازنده: ---</p>
                    <p id="detail-player-count" class="text-sm font-semibold text-white mb-4">بازیکنان: 0/4</p>
                    
                    <!-- NEW: Display for Advanced Lobby Settings -->
                    <div id="lobby-settings-display">
                        <!-- Content generated by JS -->
                    </div>
                    
                    <div class="w-full h-px bg-yellow-600 my-4"></div>
                    <h3>لیست بازیکنان</h3>
                    <div id="player-list-container"></div>
                </div>

                <div class="lobby-main-panel">
                    <div class="lobby-chat-container">
                        <div id="lobby-chat-messages" class="lobby-chat-messages"></div>
                        <form id="lobby-chat-form" class="lobby-chat-input-form">
                            <input type="text" id="lobby-chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                            <button type="submit" id="lobby-chat-send-btn" class="classic-btn btn-blue-classic text-sm py-2 px-4">ارسال</button>
                        </form>
                    </div>
                    <div class="lobby-actions-footer">
                        <div id="host-actions-container" style="display: none;">
                            <button id="start-game-btn" class="classic-btn start-game-btn" disabled> شروع بازی </button>
                            <button id="toggle-chat-lock-btn" class="classic-btn btn-gray-classic text-sm py-2 px-4"> قفل کردن چت </button>
                            <button id="view-kicked-players-btn" class="classic-btn btn-brown-classic text-sm py-2 px-4"> لیست اخراجی‌ها </button>
                        </div>
                        <button id="leave-lobby-btn" class="classic-btn btn-red-classic text-sm py-2 px-4 hidden"> بستن لابی </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden flex flex-col items-center justify-center p-2" tabindex="-1">
            <div class="absolute top-0 left-0 right-0 h-20 bg-black bg-opacity-40 flex justify-between items-center px-4 z-20">
                <div id="game-team-scores" class="text-white text-lg font-bold">
                    <span>تیم ما: <span id="our-team-score" class="text-xl text-green-300">0</span></span> |
                    <span>تیم حریف: <span id="their-team-score" class="text-xl text-red-300">0</span></span>
                </div>
                <div id="game-hokm-indicator" class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-xl font-bold text-yellow-300">حکم:</span>
                    <span id="hokm-suit-icon" class="text-4xl">❓</span>
                </div>
                <button id="leave-game-btn" class="classic-btn btn-red-classic text-sm py-2 px-4">ترک بازی</button>
            </div>
            <div id="game-table" class="relative w-[98vw] h-[85vh] max-w-[1200px] max-h-[800px] flex items-center justify-center">
                <div id="play-area" class="absolute w-80 h-48 flex items-center justify-center"></div>
                <div id="player-slot-bottom" class="player-slot absolute"> <div class="player-area-container"> <div class="player-avatar"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg> </div> <span class="player-name-display">شما</span> </div> <div class="player-hand flex justify-center"></div> </div>
                <div id="player-slot-left" class="player-slot absolute"> <div class="player-hand flex justify-center"></div> <div class="player-area-container"> <div class="player-avatar"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg> </div> <span class="player-name-display">بازیکن ۲</span> </div> </div>
                <div id="player-slot-top" class="player-slot absolute"> <div class="player-area-container"> <div class="player-avatar"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg> </div> <span class="player-name-display">یار شما</span> </div> <div class="player-hand flex justify-center"></div> </div>
                <div id="player-slot-right" class="player-slot absolute"> <div class="player-hand flex justify-center"></div> <div class="player-area-container"> <div class="player-avatar"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg> </div> <span class="player-name-display">بازیکن ۴</span> </div> </div>
            </div>
        </div>

        <!-- Remaining Modals (Kick, Kicked, Password etc.) -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"> <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"> <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">اخراج بازیکن</h2> <button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200"> <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg> </button> <p class="text-lg mb-8 text-white">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p> <div class="flex justify-around space-x-4 space-x-reverse"> <button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button> <button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button> </div> </div> </div>
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"> <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"> <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-red-400">شما اخراج شدید!</h2> <p id="kicked-message-text" class="text-lg mb-8 text-white">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p> <button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button> </div> </div>
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"> <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"> <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-yellow-300">لیست بازیکنان اخراج شده</h2> <button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 text-white hover:text-gray-300 transition-colors duration-200"> <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg> </button> <div id="kicked-players-list-content" class="space-y-4 mb-8 text-white text-left max-h-60 overflow-y-auto custom-scrollbar"> <p class="text-gray-400 text-center">هیچ بازیکنی اخراج نشده است.</p> </div> <button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button> </div> </div>
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay"> <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative"> <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2> <p class="text-lg mb-6 text-white">لابی <span id="password-prompt-lobby-name" class="font-bold text-yellow-300"></span> نیاز به رمز عبور دارد.</p> <form id="enter-password-form" class="space-y-5"> <div> <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید" class="text-center" required> </div> <div class="flex justify-around space-x-4 space-x-reverse"> <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button> <button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button> </div> </form> <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div> </div> </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs, orderBy, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4",
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase context
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn');
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn');
        const activeGamesCount = document.getElementById('active-games-count');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const newLobbyNameInput = document.getElementById('new-lobby-name-input');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field');
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const playerListContainer = document.getElementById('player-list-container');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const hostActionsContainer = document.getElementById('host-actions-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const toggleChatLockBtn = document.getElementById('toggle-chat-lock-btn');
        const viewKickedPlayersBtn = document.getElementById('view-kicked-players-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const lobbyChatMessages = document.getElementById('lobby-chat-messages');
        const lobbyChatForm = document.getElementById('lobby-chat-form');
        const lobbyChatInput = document.getElementById('lobby-chat-input');
        const lobbyChatSendBtn = document.getElementById('lobby-chat-send-btn');
        const gameScreen = document.getElementById('game-screen');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedLobbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');
        
        // NEW DOM Elements for Advanced Lobby Creation
        const winScoreSelect = document.getElementById('new-lobby-win-score');
        const turnTimerSelect = document.getElementById('new-lobby-turn-timer');
        const descriptionTextarea = document.getElementById('new-lobby-description');
        const shuffleTeamsCheckbox = document.getElementById('new-lobby-shuffle-teams');
        const lobbySettingsDisplay = document.getElementById('lobby-settings-display');

        // State variables
        let currentActiveScreen = loadingScreen;
        let currentUserData = null;
        let unsubscribeLobbies = null;
        let unsubscribeLobbyDetail = null;
        let unsubscribeGame = null;
        let unsubscribeKickedPlayers = null;
        let unsubscribeLobbyChat = null;
        let userHasActiveLobby = false;
        let currentLobbyId = null;
        let lobbyToJoin = null;
        let isRefreshing = false;
        let resolveCustomConfirm;

        // --- Core Functions (UI, Auth, Navigation) ---
        
        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            element.classList.add(type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-500'), 'text-white');
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);

        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                resolveCustomConfirm = resolve;
                confirmYesBtn.onclick = () => { customConfirmModal.classList.add('hidden'); resolveCustomConfirm(true); };
                confirmNoBtn.onclick = () => { customConfirmModal.classList.add('hidden'); resolveCustomConfirm(false); };
            });
        }

        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }
            
            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');
                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth;
                newScreen.classList.add('page-transition-visible');
                currentActiveScreen = newScreen;
            }, 600);
        }

        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }

        function openCreateLobbyModal() {
            createLobbyForm.reset(); // Resets all form fields to default
            // Manually reset UI elements not covered by form.reset()
            newLobbyPasswordField.classList.add('hidden');
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('input[value="public"]').nextElementSibling.classList.add('active');
            createLobbyMessageBox.classList.add('hidden');
            openModal(createLobbyModal);
        }

        function closeCreateLobbyModal() {
            closeModal(createLobbyModal);
        }

        async function initializeFirebaseAndAuth() {
            if (initialAuthToken) {
                try { await signInWithCustomToken(auth, initialAuthToken); }
                catch (error) { console.error("Error signing in with initial custom token:", error); }
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`); 
                    const userDocSnap = await getDoc(userDocRef);
                    currentUserData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: (userDocSnap.exists() && userDocSnap.data().displayName) ? userDocSnap.data().displayName : (user.displayName || (user.email ? user.email.split('@')[0] : 'کاربر ناشناس'))
                    };
                    if (!userDocSnap.exists() && displayNameInput.value.trim()) {
                        await setDoc(userDocRef, { displayName: displayNameInput.value.trim(), email: user.email }, { merge: true });
                        currentUserData.displayName = displayNameInput.value.trim();
                    }
                    headerDisplayName.textContent = currentUserData.displayName;
                    headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                    
                    if (currentActiveScreen === loadingScreen || currentActiveScreen === authScreen) {
                        setActiveScreen(mainScreen);
                    }
                } catch (firestoreError) {
                    console.error("Firestore profile error:", firestoreError);
                    currentUserData = { uid: user.uid, email: user.email, displayName: user.displayName || 'کاربر ناشناس' };
                    headerDisplayName.textContent = currentUserData.displayName;
                    headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                    setActiveScreen(mainScreen);
                    showMessageBox("مشکل در بارگذاری پروفایل.", "error");
                }
            } else {
                setActiveScreen(authScreen);
                currentUserData = null;
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                if (unsubscribeKickedPlayers) unsubscribeKickedPlayers();
                if (unsubscribeLobbyChat) unsubscribeLobbyChat();
                if (unsubscribeGame) unsubscribeGame();
                unsubscribeLobbies = unsubscribeLobbyDetail = unsubscribeKickedPlayers = unsubscribeLobbyChat = unsubscribeGame = null;
                currentLobbyId = null;
            }
        });

        // --- Firebase Lobby & Game Functions ---

        // UPDATED: createLobby now accepts advanced game settings
        async function createLobby(lobbyName, userId, displayName, lobbyType, password, settings) {
            try {
                // Check if user already has an active lobby
                const userLobbiesQuery = query(collection(db, `global_lobbies`), where("hostId", "==", userId), where("status", "in", ["waiting", "playing"]));
                const userLobbiesSnapshot = await getDocs(userLobbiesQuery);
                if (!userLobbiesSnapshot.empty) {
                    throw new Error("شما از قبل یک لابی فعال ساخته‌اید.");
                }
        
                const newLobbyData = {
                    name: lobbyName,
                    description: settings.description, // NEW: Store description
                    hostId: userId,
                    status: "waiting",
                    type: lobbyType,
                    players: { [userId]: displayName },
                    kickedPlayers: [],
                    createdAt: serverTimestamp(),
                    isChatLocked: false,
                    gameSettings: { // NEW: Store all game settings
                        maxPlayers: 4,
                        roundsToWin: settings.roundsToWin,
                        turnTimer: settings.turnTimer,
                        shuffleTeamsOnStart: settings.shuffleTeamsOnStart
                    }
                };
        
                if (lobbyType === 'private') {
                    newLobbyData.password = password;
                }
        
                const newLobbyRef = await addDoc(collection(db, `global_lobbies`), newLobbyData);
                userHasActiveLobby = true;
                return newLobbyRef.id;
            } catch (e) {
                console.error("خطا در ساخت لابی: ", e);
                throw e;
            }
        }

        async function joinLobby(lobbyId, userId, displayName) {
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            try {
                const lobbySnap = await getDoc(lobbyRef);
                if (!lobbySnap.exists()) throw new Error("لابی یافت نشد.");
                
                const lobbyData = lobbySnap.data();
                const playersMap = lobbyData.players || {};
                
                if (lobbyData.kickedPlayers?.some(p => p.uid === userId)) throw new Error("شما از این لابی اخراج شده‌اید.");
                if (Object.keys(playersMap).length >= lobbyData.gameSettings?.maxPlayers) throw new Error("لابی پر است.");
                
                if (!playersMap[userId]) {
                    await updateDoc(lobbyRef, { [`players.${userId}`]: displayName });
                }
                
                currentLobbyId = lobbyId;
                userHasActiveLobby = true;
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);
            } catch (e) {
                console.error("خطا در ورود به لابی: ", e);
                throw e;
            }
        }
        
        // UPDATED: setupLobbyListener now displays more info
        function setupLobbyListener(searchTerm = '') {
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
        
            lobbiesList.innerHTML = '<p class="text-gray-400">در حال بارگذاری لابی‌ها...</p>';
            const q = query(collection(db, `global_lobbies`), where("status", "==", "waiting"));
        
            return onSnapshot(q, (snapshot) => {
                let lobbiesToDisplay = [];
                userHasActiveLobby = false;
        
                snapshot.forEach((doc) => {
                    const lobby = { id: doc.id, ...doc.data() };
                    if (auth.currentUser && lobby.players[auth.currentUser.uid]) {
                        userHasActiveLobby = true;
                    }
                    if (!searchTerm || (lobby.name || '').toLowerCase().includes(searchTerm) || (lobby.players[lobby.hostId] || '').toLowerCase().includes(searchTerm)) {
                        lobbiesToDisplay.push(lobby);
                    }
                });
                
                lobbiesToDisplay.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                if (lobbiesToDisplay.length === 0) {
                    lobbiesList.innerHTML = '<p class="text-gray-400">لابی با این مشخصات یافت نشد.</p>';
                } else {
                    lobbiesList.innerHTML = '';
                    lobbiesToDisplay.forEach((lobby) => {
                        const playerCount = Object.keys(lobby.players).length;
                        const maxPlayers = lobby.gameSettings?.maxPlayers || 4;
                        const isHost = auth.currentUser && lobby.hostId === auth.currentUser.uid;
                        const canJoin = auth.currentUser && !userHasActiveLobby && playerCount < maxPlayers && !lobby.kickedPlayers?.some(p => p.uid === auth.currentUser.uid);
                        
                        const lockIconHtml = lobby.type === 'private' ? `<svg xmlns="http://www.w3.org/2000/svg" class="lobby-lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` : '';
                        
                        let actionButtonsHtml;
                        if (isHost) {
                            actionButtonsHtml = `<button data-lobby-id="${lobby.id}" class="close-lobby-btn classic-btn btn-red-classic">بستن</button><button data-lobby-id="${lobby.id}" class="view-my-lobby-btn classic-btn btn-blue-classic">ورود</button>`;
                        } else if (canJoin) {
                            actionButtonsHtml = `<button data-lobby-id="${lobby.id}" data-lobby-type="${lobby.type || 'public'}" data-lobby-name="${lobby.name}" class="join-lobby-btn classic-btn btn-blue-classic">ورود</button>`;
                        } else {
                            actionButtonsHtml = `<button class="classic-btn btn-blue-classic opacity-50" disabled>ورود</button>`;
                        }

                        const lobbyItem = document.createElement('div');
                        lobbyItem.className = 'lobby-item mb-3 w-full';
                        lobbyItem.dataset.lobbyId = lobby.id;
                        // NEW: Added title attribute for lobby description tooltip and display win score
                        lobbyItem.title = lobby.description || 'بدون توضیحات';
                        lobbyItem.innerHTML = `
                            <div class="flex-grow mb-2 sm:mb-0 text-center sm:text-right">
                                <h3 class="text-xl font-bold">${lockIconHtml}${lobby.name}</h3>
                                <p class="text-sm">سازنده: ${lobby.players[lobby.hostId] || 'ناشناس'}</p>
                                <p class="text-sm text-yellow-200">امتیاز پیروزی: ${lobby.gameSettings?.roundsToWin || 7} دست</p>
                                <p class="text-sm">بازیکنان: ${playerCount}/${maxPlayers}</p>
                            </div>
                            <div class="lobby-actions">${actionButtonsHtml}</div>
                        `;
                        lobbiesList.appendChild(lobbyItem);
                    });
                }
                
                lobbiesList.querySelectorAll('.join-lobby-btn:not([disabled])').forEach(btn => btn.addEventListener('click', (e) => {
                    const { lobbyId, lobbyType, lobbyName } = e.currentTarget.dataset;
                    if (lobbyType === 'private') {
                        openModal(enterPasswordModal); lobbyToJoin = { id: lobbyId, name: lobbyName }; passwordPromptLobbyName.textContent = lobbyName;
                    } else {
                        joinLobby(lobbyId, auth.currentUser.uid, currentUserData.displayName).catch(err => showMessageBox(`خطا در ورود: ${err.message}`, 'error'));
                    }
                }));
                lobbiesList.querySelectorAll('.view-my-lobby-btn').forEach(btn => btn.addEventListener('click', e => {
                    currentLobbyId = e.target.dataset.lobbyId; setActiveScreen(lobbyDetailScreen); unsubscribeLobbyDetail = setupLobbyDetailListener(currentLobbyId);
                }));
                lobbiesList.querySelectorAll('.close-lobby-btn').forEach(btn => btn.addEventListener('click', async e => {
                    const lobbyId = e.target.dataset.lobbyId;
                    const confirmed = await showCustomConfirm("آیا از بستن این لابی مطمئن هستید؟");
                    if (confirmed) await deleteDoc(doc(db, 'global_lobbies', lobbyId));
                }));
            }, (error) => {
                console.error("Lobby listener error: ", error);
                lobbiesList.innerHTML = `<p class="text-red-400">خطا در بارگذاری لابی‌ها.</p>`;
            });
        }
        
        // UPDATED: setupLobbyDetailListener now displays the advanced settings
        function setupLobbyDetailListener(lobbyId) {
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            if (unsubscribeLobbyChat) { unsubscribeLobbyChat(); unsubscribeLobbyChat = null; }
            
            const lobbyRef = doc(db, `global_lobbies`, lobbyId);
            return onSnapshot(lobbyRef, (docSnap) => {
                if (docSnap.exists()) {
                    const lobbyData = docSnap.data();
                    const isHost = auth.currentUser?.uid === lobbyData.hostId;

                    if (lobbyData.status === 'playing') {
                        if (currentActiveScreen !== gameScreen) setActiveScreen(gameScreen);
                        if (!unsubscribeGame) unsubscribeGame = setupGameListener(lobbyId);
                        return;
                    }
                    if (lobbyData.kickedPlayers?.some(p => p.uid === auth.currentUser.uid)) {
                        openModal(kickedMessageModal); kickedLobbyName.textContent = lobbyData.name; return;
                    }

                    if (!unsubscribeLobbyChat) unsubscribeLobbyChat = setupLobbyChatListener(lobbyId, lobbyData.hostId);

                    detailLobbyName.textContent = lobbyData.name;
                    detailHostName.textContent = `سازنده: ${lobbyData.players[lobbyData.hostId] || 'ناشناس'}`;
                    const playerCount = Object.keys(lobbyData.players).length;
                    const maxPlayers = lobbyData.gameSettings.maxPlayers || 4;
                    detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                    // NEW: Render the advanced settings in the sidebar
                    const settings = lobbyData.gameSettings;
                    const timerText = settings.turnTimer > 0 ? `${settings.turnTimer} ثانیه` : 'بدون محدودیت';
                    const shuffleText = settings.shuffleTeamsOnStart ? 'فعال' : 'غیرفعال';
                    lobbySettingsDisplay.innerHTML = `
                        <h3>تنظیمات بازی</h3>
                        ${lobbyData.description ? `<p><strong>توضیحات:</strong> ${lobbyData.description}</p>` : ''}
                        <p><strong>امتیاز پیروزی:</strong> ${settings.roundsToWin} دست</p>
                        <p><strong>تایمر نوبت:</strong> ${timerText}</p>
                        <p><strong>بر زدن تیم‌ها:</strong> ${shuffleText}</p>
                    `;
                    
                    playerListContainer.innerHTML = '';
                    Object.entries(lobbyData.players).forEach(([uid, name]) => {
                        const isPlayerHost = uid === lobbyData.hostId;
                        const playerItem = document.createElement('div');
                        playerItem.className = `player-list-item ${isPlayerHost ? 'is-host' : ''}`;
                        playerItem.innerHTML = `
                            <div>${name} ${isPlayerHost ? '<span class="host-label">(سازنده)</span>' : ''}</div>
                            ${(isHost && !isPlayerHost) ? `<button class="kick-player-btn" data-player-uid="${uid}" data-player-name="${name}">اخراج</button>` : ''}
                        `;
                        playerListContainer.appendChild(playerItem);
                    });
                    
                    leaveLobbyBtn.classList.toggle('hidden', !isHost);
                    hostActionsContainer.style.display = isHost ? 'flex' : 'none';
                    if(isHost) {
                        startGameBtn.disabled = playerCount !== maxPlayers;
                        startGameBtn.textContent = `شروع بازی (${playerCount}/${maxPlayers})`;
                        toggleChatLockBtn.textContent = lobbyData.isChatLocked ? 'باز کردن چت' : 'قفل کردن چت';
                    }
                } else {
                    showMessageBox("لابی بسته شد.", "info");
                    setActiveScreen(lobbyScreen);
                    unsubscribeLobbies = setupLobbyListener('');
                }
            });
        }
        
        // This function remains largely the same as it correctly initializes the game
        async function initializeGameInFirestore(lobbyId, lobbyData) {
            // Game initialization logic (shuffle deck, deal cards, etc.) would go here.
            // For now, it just changes the status.
            await updateDoc(doc(db, 'global_lobbies', lobbyId), { status: "playing" });
        }
        
        // Placeholder for game listener
        function setupGameListener(lobbyId) {
            console.log(`Game listener started for ${lobbyId}`);
            setActiveScreen(gameScreen);
            // This would be populated with actual game state rendering logic
        }

        async function sendLobbyMessage(lobbyId, text) {
            if (!text.trim() || !auth.currentUser) return;
            await addDoc(collection(db, `global_lobbies/${lobbyId}/messages`), {
                text: text.trim(),
                senderUid: auth.currentUser.uid,
                senderName: currentUserData.displayName,
                timestamp: serverTimestamp(),
                isDeleted: false
            });
            lobbyChatInput.value = '';
        }

        function setupLobbyChatListener(lobbyId, hostId) {
            const q = query(collection(db, `global_lobbies/${lobbyId}/messages`), orderBy("timestamp", "asc"));
            return onSnapshot(q, (snapshot) => {
                lobbyChatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    // Chat rendering logic...
                });
                lobbyChatMessages.scrollTop = lobbyChatMessages.scrollHeight;
            });
        }


        // --- Event Listeners ---
        window.onload = initializeFirebaseAndAuth;
        
        // Auth
        loginToggleBtn.addEventListener('click', () => { submitAuthBtn.textContent = 'ورود'; displayNameField.classList.add('hidden'); });
        registerToggleBtn.addEventListener('click', () => { submitAuthBtn.textContent = 'ثبت نام'; displayNameField.classList.remove('hidden'); });
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            try {
                if (submitAuthBtn.textContent === 'ورود') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile/data`), { displayName: displayNameInput.value.trim(), email: email }, { merge: true });
                }
            } catch (error) { console.error(error); showMessageBox("خطا در ورود/ثبت‌نام.", 'error'); }
        });

        // Main Navigation
        profileSummary.addEventListener('click', () => openModal(profileModal));
        closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));
        profileLogoutBtn.addEventListener('click', async () => { await signOut(auth); closeModal(profileModal); });
        friendlyGameBtn.addEventListener('click', () => { setActiveScreen(lobbyScreen); unsubscribeLobbies = setupLobbyListener(); });
        backToMainBtn.addEventListener('click', () => { setActiveScreen(mainScreen); if(unsubscribeLobbies) unsubscribeLobbies(); });

        // Lobby List Actions
        addIconBtn.addEventListener('click', () => userHasActiveLobby ? showMessageBox("شما از قبل در یک لابی فعال هستید.", "info") : openCreateLobbyModal());
        refreshLobbiesBtn.addEventListener('click', () => {
             if (isRefreshing) return;
             isRefreshing = true;
             refreshLobbiesBtn.disabled = true;
             refreshLobbiesBtn.querySelector('svg').classList.add('is-refreshing');
             if(unsubscribeLobbies) unsubscribeLobbies();
             unsubscribeLobbies = setupLobbyListener();
             setTimeout(() => {
                isRefreshing = false;
                refreshLobbiesBtn.disabled = false;
                refreshLobbiesBtn.querySelector('svg').classList.remove('is-refreshing');
             }, 1000);
        });

        // Create Lobby Modal
        closeCreateLobbyModalBtn.addEventListener('click', closeCreateLobbyModal);
        lobbyTypeToggle.addEventListener('change', (e) => {
            document.querySelectorAll('.lobby-type-btn').forEach(btn => btn.classList.remove('active'));
            e.target.nextElementSibling.classList.add('active');
            newLobbyPasswordField.classList.toggle('hidden', e.target.value !== 'private');
        });
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lobbyName = newLobbyNameInput.value.trim();
            if (!lobbyName) { showCreateLobbyMessageBox("لطفاً نام لابی را وارد کنید.", "error"); return; }
            
            // Collect advanced settings
            const settings = {
                roundsToWin: parseInt(winScoreSelect.value, 10),
                turnTimer: parseInt(turnTimerSelect.value, 10),
                description: descriptionTextarea.value.trim(),
                shuffleTeamsOnStart: shuffleTeamsCheckbox.checked
            };

            const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;

            try {
                const newLobbyId = await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName, lobbyType, password, settings);
                showCreateLobbyMessageBox("لابی با موفقیت ساخته شد!", "success");
                setTimeout(() => {
                    closeCreateLobbyModal();
                    currentLobbyId = newLobbyId;
                    setActiveScreen(lobbyDetailScreen);
                    unsubscribeLobbyDetail = setupLobbyDetailListener(newLobbyId);
                }, 1500);
            } catch (error) {
                showCreateLobbyMessageBox(error.message, "error");
            }
        });
        
        // Lobby Detail Actions
        leaveLobbyBtn.addEventListener('click', async () => {
            const confirmed = await showCustomConfirm("خروج شما باعث بسته شدن لابی برای همه می‌شود. آیا مطمئن هستید؟", "بستن لابی");
            if (confirmed && currentLobbyId) { await deleteDoc(doc(db, 'global_lobbies', currentLobbyId)); }
        });
        startGameBtn.addEventListener('click', () => {
            if (currentLobbyId) initializeGameInFirestore(currentLobbyId, {}); // Simplified, real implementation needs lobbyData
        });
        
        // Chat
        lobbyChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentLobbyId) sendLobbyMessage(currentLobbyId, lobbyChatInput.value);
        });

    </script>
</body>
</html>
