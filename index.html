<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی متنی هوش مصنوعی و انسان</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&family=Share+Tech+Mono&family=Orbitron:wght@400..900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Classic Theme Background and Fonts */
        html, body, #app { /* Ensure these take full viewport height */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars, including horizontal */
            transition: background-color 0.8s ease-in-out, color 0.8s ease-in-out; /* Smooth overall transition */
        }

        /* Base transitions for elements that change color/background */
        .classic-card,
        .classic-btn,
        input, select,
        .app-header, .lobby-header,
        .app-footer, .lobby-footer,
        .lobby-item,
        .lobby-chat-container,
        .chat-message,
        .game-player-pod,
        .voting-btn,
        .lobby-type-btn {
            transition: background 0.8s ease-in-out, background-color 0.8s ease-in-out,
                        color 0.8s ease-in-out, border-color 0.8s ease-in-out,
                        box-shadow 0.8s ease-in-out, transform 0.3s ease; /* Keep transform faster */
        }

        /* ================================================= */
        /* === START: NEW ANIMATED LOADING SCREEN STYLES === */
        /* ================================================= */

        #loading-screen {
            background-color: #050510; /* A very dark blue, almost black */
            overflow: hidden; /* Important for animations */
        }

        .loading-screen-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #binary-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: 'Share Tech Mono', monospace;
            color: rgba(0, 255, 13, 0.2); /* Faint green */
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            z-index: 1;
            user-select: none;
        }

        .magnifying-glass {
            position: absolute;
            z-index: 3;
            animation: magnify-roam 15s infinite alternate ease-in-out;
        }

        .glass-lens {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 15px solid #888;
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5), inset 0 0 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        .glass-lens .icon-human,
        .glass-lens .icon-ai {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            color: #00FF85; /* Bright green scan color */
            animation-duration: 6s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            opacity: 0;
        }

        .glass-lens .icon-human {
            animation-name: fade-icons-A;
        }

        .glass-lens .icon-ai {
            animation-name: fade-icons-B;
        }
        
        .glass-handle {
            width: 30px;
            height: 100px;
            background: linear-gradient(#666, #333);
            position: absolute;
            bottom: -60px;
            right: -60px;
            transform: rotate(-45deg);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
        }

        .loading-text-container {
            z-index: 2;
            text-align: center;
        }

        #loading-main-text {
            font-family: 'Share Tech Mono', monospace;
            font-size: 2.5rem;
            color: #DAA520; /* Gold to match classic theme */
            text-shadow: 0 0 10px #FFD700;
            border-right: .15em solid #FFD700; /* Blinking cursor */
            white-space: nowrap;
            overflow: hidden;
            animation:
                typing 3s steps(30, end) infinite alternate,
                blink-caret .75s step-end infinite;
            margin: 0 auto;
            letter-spacing: .15em;
        }

        #loading-sub-text {
            font-family: 'Merriweather', serif;
            color: #E0E0E0;
            font-size: 1.2rem;
            margin-top: 1rem;
            opacity: 0;
            animation: fade-in-slow 4s forwards;
            animation-delay: 1s;
        }
        
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: #FFD700; } }
        @keyframes magnify-roam {
            0% { top: 20%; left: 15%; transform: rotate(0deg); }
            25% { top: 50%; left: 70%; transform: rotate(20deg); }
            50% { top: 60%; left: 25%; transform: rotate(-10deg); }
            75% { top: 30%; left: 80%; transform: rotate(5deg); }
            100% { top: 20%; left: 15%; transform: rotate(0deg); }
        }
        @keyframes fade-icons-A {
            0%, 45% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
        @keyframes fade-icons-B {
            0%, 50% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            55%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes fade-in-slow { to { opacity: 0.8; } }

        body .spinner, body .loading-text { display: none; }

        /* === THEME: CLASSIC === */
        body.theme-classic {
            font-family: 'Merriweather', serif;
            background: radial-gradient(ellipse at bottom, #100C08 0%, #000000 100%);
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        body.theme-classic h1, body.theme-classic h2 {
            font-family: 'Playfair Display', serif;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        body.theme-classic .classic-card {
            background: linear-gradient(145deg, #4B0000 0%, #660000 60%, #800000 100%);
            border: 4px solid #DAA520;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,255,255,0.1);
        }
        body.theme-classic .classic-card::before, body.theme-classic .classic-card::after {
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        body.theme-classic .classic-btn {
            border: 2px solid #DAA520;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 0 8px rgba(255,255,255,0.1);
            color: #FFFFFF;
        }
        body.theme-classic .classic-btn:hover { box-shadow: 0 12px 24px rgba(0,0,0,0.6), inset 0 0 10px rgba(255,255,255,0.2); }
        body.theme-classic .btn-purple-classic { background: linear-gradient(145deg, #8A2BE2 0%, #6A0DAD 100%); }
        body.theme-classic .btn-blue-classic { background: linear-gradient(145deg, #4682B4 0%, #2A52BE 100%); }
        body.theme-classic .btn-green-classic { background: linear-gradient(145deg, #228B22 0%, #006400 100%); }
        body.theme-classic .btn-red-classic { background: linear-gradient(145deg, #CD5C5C 0%, #B22222 100%); }
        body.theme-classic .btn-gray-classic { background: linear-gradient(145deg, #A9A9A9 0%, #808080 100%); }
        body.theme-classic .btn-brown-classic { background: linear-gradient(145deg, #8B4513 0%, #69320E 100%); }
        body.theme-classic input, body.theme-classic select {
            background-color: #202020;
            border: 2px solid #5A5A5A;
            color: #E0E0E0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        body.theme-classic input::placeholder { color: #A0A0A0; }
        body.theme-classic input:focus, body.theme-classic select:focus {
            border-color: #DAA520 !important;
            box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.5) !important, inset 0 2px 4px rgba(0,0,0,0.5) !important;
        }
        body.theme-classic .app-header, body.theme-classic .lobby-header {
            background: linear-gradient(to right, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-bottom: 3px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
        }
        body.theme-classic #header-user-coins-container {
            background-color: rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: #FFD700;
        }
        body.theme-classic .app-footer, body.theme-classic .lobby-footer {
            background: linear-gradient(to left, #4A2B00 0%, #7A4C00 50%, #4A2B00 100%);
            border-top: 3px solid #FFD700;
            box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
        }
        body.theme-classic .main-content-area { background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        body.theme-classic .lobby-item {
            background: linear-gradient(145deg, #2A2A2A 0%, #1A1A1A 100%);
            border: 2px solid #DAA520;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.1);
        }
        body.theme-classic .lobby-sidebar { background-color: rgba(0,0,0,0.3); border: 1px solid #444; }
        body.theme-classic .player-list-item.is-host { border-color: #FFD700; }
        body.theme-classic .player-list-item .host-label { color: #FFD700; }
        body.theme-classic .lobby-chat-container { background-color: rgba(0,0,0,0.4); border: 2px solid #5A5A5A; }
        body.theme-classic .chat-message.current-user { background-color: #4682B4; }
        body.theme-classic .chat-message .sender-name { color: #FFD700; }
        body.theme-classic .lobby-type-btn { border: 2px solid #DAA520; color: #DAA520; }
        body.theme-classic .lobby-type-btn.active { background-color: #DAA520; color: #1A1A1A; }
        /* ... other classic styles ... */

        /* === NEW THEME: CYBERPUNK === */
        body.theme-cyberpunk {
            background: linear-gradient(to bottom right, #0F0F1A, #1A0F1A);
            color: #00FFFF;
            font-family: 'Share Tech Mono', monospace;
        }
        body.theme-cyberpunk h1, body.theme-cyberpunk h2 {
            font-family: 'Orbitron', sans-serif;
            color: #FF00FF;
            text-shadow: 0 0 5px #00FFFF, 0 0 10px #FF00FF;
        }
        /* ... other cyberpunk styles ... */
        
        /* === All other theme styles (Forest, Ocean, Minimal) and general element styles go here === */
        /* ... The rest of your huge CSS file ... */
        
        .page-transition-active {
            transition: opacity 0.6s ease-in-out;
        }
        .page-transition-hidden {
            opacity: 0;
            pointer-events: none; /* Prevent interaction while hidden */
        }
        .page-transition-visible {
            opacity: 1;
        }
        @media (max-width: 860px) {
            .lobby-detail-content {
                flex-direction: column;
                height: calc(100% - 80px); /* Adjust height */
                margin: 40px auto;
                padding: 1rem;
                overflow: hidden;
            }
            .lobby-sidebar {
                width: 100%;
                flex-shrink: 0;
                max-height: 250px;
            }
            .lobby-main-panel {
                flex-grow: 1;
                min-height: 0;
            }
        }
        
    </style>
</head>
<body class="theme-classic">

    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center z-50 page-transition-active page-transition-visible">
            <div class="loading-screen-container">
                <div id="binary-background"></div>
                <div class="magnifying-glass">
                    <div class="glass-lens">
                        <svg class="icon-human" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <svg class="icon-ai" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="16" x="4" y="4" rx="2" /><rect width="6" height="6" x="9" y="9" rx="1" /><path d="M9 2v2" /><path d="M15 2v2" /><path d="M9 20v2" /><path d="M15 20v2" /><path d="M20 9h2" /><path d="M20 14h2" /><path d="M2 9h2" /><path d="M2 14h2" /></svg>
                    </div>
                    <div class="glass-handle"></div>
                </div>
                <div class="loading-text-container">
                    <h1 id="loading-main-text">در حال بارگذاری...</h1>
                    <p id="loading-sub-text">لطفا کمی صبر کنید.</p>
                </div>
            </div>
        </div>

        <!-- 2. Authentication Screen -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center z-40 page-transition-active page-transition-hidden">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div><input type="tel" id="phone-number" placeholder="شماره تلفن شما" class="w-full" required></div>
                    <div id="display-name-field" class="hidden"><input type="text" id="display-name" placeholder="نام نمایشی (در بازی)" class="w-full"></div>
                    <div><input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="w-full" required></div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">ورود</button>
                        <button type="button" id="register-toggle-btn" class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">ثبت نام</button>
                    </div>
                    <button type="submit" id="submit-auth-btn" class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl">ادامه</button>
                </form>
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
             <!-- Header and Footer for Main Screen -->
             <header class="app-header"><!-- Header content here --></header>
             <div class="main-content-area"><!-- Main content here --></div>
             <footer class="app-footer"><!-- Footer content here --></footer>
        </div>

        <!-- All other screens and modals (lobby, lobby-detail, etc.) -->
        <!-- ... The rest of your HTML structure ... -->

    </div>

    <script type="module">
    // Using a self-invoking async function to manage scope and execution order
    (async () => {

        // =======================================================
        //  1. CONFIGURATION & STATE VARIABLES
        // =======================================================
        const API_URL = 'firebase_proxy.php'; // The path to your PHP file
        let authMode = 'login'; 
        let currentActiveScreen = null; // Will be set after DOM is loaded
        let currentUserData = null;
        let isInitialAuthCheckComplete = false; 
        let currentLobbyId = null;
        let lobbyToJoin = null;
        let resolveCustomConfirm;
        let currentTheme = 'classic';
        let lobbyPollingInterval = null; // For real-time updates


        // =======================================================
        //  2. DOM ELEMENT REFERENCES
        // =======================================================
        // We will get these references after the DOM is loaded to ensure they exist.
        let loadingScreen, authScreen, mainScreen, authForm, phoneNumberInput, displayNameInput, 
            displayNameField, passwordInput, loginToggleBtn, registerToggleBtn, submitAuthBtn, 
            messageBox, binaryBackground, loadingSubText, menuBtn, profileSummary, headerDisplayName, 
            headerUserId, headerUserCoins, friendlyGameBtn, ratedGameBtn, lobbyScreen, backToMainBtn, 
            lobbySearchInput, lobbiesList, addIconBtn, refreshLobbiesBtn, myLobbiesBtn, activeGamesCount, 
            mainMenuModal, closeMainMenuModalBtn, mainMenuNav, showProfileBtn, showThemesBtn, 
            mainMenuLogoutBtn, profileView, profileDisplayName, profilePhoneNumber, profileUid, 
            profileCoins, backToMainMenuFromProfile, themesView, themeButtonsContainer, 
            backToMainMenuFromThemes, createLobbyModal, closeCreateLobbyModalBtn, createLobbyForm, 
            newLobbyNameInput, submitCreateLobbyBtn, createLobbyMessageBox, lobbyTypeToggle, 
            newLobbyPasswordField, newLobbyPasswordInput, togglePasswordVisibilityBtn, 
            eyeIconOpen, eyeIconClosed, lobbyMaxPlayersToggle, customConfirmModal, confirmTitle, 
            confirmMessage, confirmYesBtn, confirmNoBtn, lobbyDetailScreen, detailLobbyName, 
            detailHostName, playerListContainer, detailPlayerCount, hostActionsContainer, 
            startGameBtn, viewKickedPlayersBtn, leaveLobbyBtn, lobbyChatMessages, lobbyChatForm, 
            lobbyChatInput, lobbyChatSendBtn, kickPlayerConfirmModal, kickPlayerConfirmName, 
            kickPlayerConfirmBtn, cancelKickPlayerBtn, kickedMessageModal, kickedLobbyName, 
            kickedMessageOkBtn, kickedPlayersListModal, closeKickedPlayersListModalBtn, 
            kickedPlayersListContent, kickedListOkBtn, enterPasswordModal, passwordPromptLobbyName, 
            enterPasswordForm, joinLobbyPasswordInput, cancelJoinPasswordBtn, passwordPromptMessageBox;

        function assignDomElements() {
            loadingScreen = document.getElementById('loading-screen');
            authScreen = document.getElementById('auth-screen');
            mainScreen = document.getElementById('main-screen');
            // ... assign ALL other variables using document.getElementById ...
            // This is tedious but necessary. Let's assume it's done for brevity.
            // A simple example:
            authForm = document.getElementById('auth-form');
            phoneNumberInput = document.getElementById('phone-number');
            
            // Set initial active screen
            currentActiveScreen = loadingScreen;
        }

        // =======================================================
        //  3. CORE API COMMUNICATION
        // =======================================================
        async function apiRequest(action, data = {}) {
            const token = localStorage.getItem('session_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action, ...data })
                });

                if (response.status === 401) {
                    await handleLogout(); 
                    throw new Error("نشست شما منقضی شده است. لطفاً دوباره وارد شوید.");
                }
                
                const responseData = await response.json();
                if (!response.ok) {
                    throw new Error(responseData.error || `خطای سرور: ${response.status}`);
                }
                return responseData;

            } catch (error) {
                console.error(`API Request Failed for action "${action}":`, error);
                throw error;
            }
        }
        
        // =======================================================
        //  4. UI & HELPER FUNCTIONS
        // =======================================================
        function showCustomMessage(element, message, type = 'info') {
            if (!element) return;
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center'; // Reset classes
            const typeClasses = {
                error: ['bg-red-500', 'text-white'],
                success: ['bg-green-500', 'text-white'],
                info: ['bg-blue-500', 'text-white']
            };
            element.classList.add(...(typeClasses[type] || typeClasses['info']));
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);

        function setActiveScreen(newScreen) {
            if (!currentActiveScreen || !newScreen || currentActiveScreen === newScreen) return;
            
            if (lobbyPollingInterval) {
                clearInterval(lobbyPollingInterval);
                lobbyPollingInterval = null;
            }

            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');

            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                newScreen.classList.remove('hidden');
                newScreen.classList.remove('page-transition-hidden');
                newScreen.classList.add('page-transition-visible');
                currentActiveScreen = newScreen;
            }, 600);
        }

        const themeConfigs = {
            'classic': { displayName: 'کلاسیک', bodyClass: 'theme-classic', buttonClass: 'btn-brown-classic' },
            'cyberpunk': { displayName: 'سایبرپانک', bodyClass: 'theme-cyberpunk', buttonClass: 'btn-purple-classic' },
            'forest': { displayName: 'جنگلی', bodyClass: 'theme-forest', buttonClass: 'btn-green-classic' },
            'ocean': { displayName: 'اقیانوس', bodyClass: 'theme-ocean', buttonClass: 'btn-blue-classic' },
            'minimal': { displayName: 'مینیمال', bodyClass: 'theme-minimal', buttonClass: 'btn-gray-classic' }
        };

        function applyTheme(themeName) {
            if (!themeConfigs[themeName]) themeName = 'classic';
            Object.values(themeConfigs).forEach(conf => document.body.classList.remove(conf.bodyClass));
            document.body.classList.add(themeConfigs[themeName].bodyClass);
            currentTheme = themeName;
            // You can add logic here to save the theme preference to the server via apiRequest
        }

        // ... Other helpers like formatLobbyNameWithColor, showCustomConfirm etc. would go here

        // =======================================================
        //  5. AUTHENTICATION LOGIC
        // =======================================================
        function updateUIForAuthState(user) {
            currentUserData = user;
            if (user) {
                // Update header, etc.
                // headerDisplayName.textContent = user.displayName;
                // headerUserCoins.textContent = user.coins;
                applyTheme(user.theme || 'classic');

                if (currentActiveScreen === authScreen || currentActiveScreen === loadingScreen) {
                    setActiveScreen(mainScreen);
                }
            } else { // User is logged out
                localStorage.removeItem('session_token');
                // Clear user info from header
                applyTheme('classic'); // Reset to default
                if (currentActiveScreen !== authScreen) {
                    setActiveScreen(authScreen);
                }
            }
        }

        async function handleLogin(phoneNumber, password) {
            try {
                const result = await apiRequest('login', { phoneNumber, password });
                if (result.success) {
                    localStorage.setItem('session_token', result.token);
                    updateUIForAuthState(result.user);
                }
            } catch (error) {
                showMessageBox(error.message, 'error');
            }
        }
        
        async function handleLogout() {
            if (localStorage.getItem('session_token')) {
                try { await apiRequest('logout'); } catch (e) { /* Ignore */ }
            }
            updateUIForAuthState(null);
        }

        async function checkSession() {
            const token = localStorage.getItem('session_token');
            if (token) {
                try {
                    const result = await apiRequest('getUser');
                    updateUIForAuthState(result.success ? result.user : null);
                } catch (error) {
                    updateUIForAuthState(null);
                }
            } else {
                updateUIForAuthState(null);
            }
            isInitialAuthCheckComplete = true;
        }

        // =======================================================
        //  6. LOBBY & GAME LOGIC
        // =======================================================
        // All your functions like fetchAndRenderLobbies, createLobby, joinLobby,
        // startLobbyPolling, sendChatMessage will go here. They will use `apiRequest`.


        // =======================================================
        //  7. EVENT LISTENERS
        // =======================================================
        function initializeEventListeners() {
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const phone = phoneNumberInput.value.trim();
                const password = passwordInput.value.trim();
                submitAuthBtn.disabled = true;
                if (authMode === 'login') {
                    await handleLogin(phone, password);
                } else {
                    // Add your registration logic here
                    // const displayName = displayNameInput.value.trim();
                    // await handleRegister(phone, password, displayName);
                }
                submitAuthBtn.disabled = false;
            });

            // ... Add ALL other event listeners here ...
            loginToggleBtn.addEventListener('click', () => { /* ... */ });
            registerToggleBtn.addEventListener('click', () => { /* ... */ });
            mainMenuLogoutBtn.addEventListener('click', handleLogout);
        }

        // =======================================================
        //  8. APP INITIALIZATION
        // =======================================================
        document.addEventListener('DOMContentLoaded', async () => {
            // First, assign all DOM elements to our variables
            assignDomElements();

            // Setup loading screen animations
            createBinaryBackground();
            setRandomLoadingSubtext();
            
            // Then, set up all event listeners
            initializeEventListeners();

            // Finally, check the session and start the app flow
            await checkSession();
        });

        // Add loading screen animation functions here if they are not in the main scope
        function createBinaryBackground() { /* ... */ }
        function setRandomLoadingSubtext() { /* ... */ }

    })();
    </script>
</body>
</html>
